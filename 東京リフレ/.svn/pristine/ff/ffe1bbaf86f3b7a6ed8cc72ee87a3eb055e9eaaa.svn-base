<?php

//set_time_limit(5000);

if( isset($_POST["send_csv"]) == true ){

	header("Content-Type: application/octet-stream");
	header("Content-Disposition: attachment; filename="."sale_therapist_one.csv");

}

include("include/common.php");
include("include/auth.php");

$time1 = time();

$timestamp_now = get_timestamp_now_common();

if( (isset($_POST["send_csv"])==true) ){
	
	$year = $_POST["year"];
	$month = $_POST["month"];
	$day = $_POST["day"];
	$therapist_id = $_POST["therapist_id"];
	$area = $_POST["area"];
	
	$csv_file = get_csv_file_sale_therapist_one($year,$month,$therapist_id);
	
	// データの出力
	echo($csv_file);exit();
	
}else if( (isset($_GET["year"])==true) && (isset($_GET["month"])==true) && (isset($_GET["day"])==true) && (isset($_GET["id"])==true) && (isset($_GET["area"])==true) ){
	
	$year = $_GET["year"];
	$month = $_GET["month"];
	$day = $_GET["day"];
	$therapist_id = $_GET["id"];
	$area = $_GET["area"];
	
}else{
	
	header("Location: error.php");
	exit();
	
}

$area_name = get_area_name_by_area_common($area);

$last_day = get_month_last_day($year,$month);

$name = get_therapist_name_by_therapist_id_honmyou_common($therapist_id);

//$insurance = get_therapist_insurance_by_id_common($therapist_id);

?>

<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title><?php echo $name;?> | セラピスト | 管理</title>
<script type="text/javascript" src="../js/jquery-1.7.2.js"></script>
<script type="text/javascript" src="js/sale_therapist_one.js"></script>
<link href="style.css" rel="stylesheet" type="text/css" />

<style>

*{
	font-size:12px;
}

table tr th{
	background-color:#c9caca;
	padding:5px 5px 5px 5px;
}

table tr td{
	padding:5px 5px 5px 5px;
}

body{

	

}

.th_top{

	background:#eee;
	border-top:solid 1px #000;
	border-left:solid 1px #000;
	border-right:solid 1px #000;
	border-bottom:solid 1px #000;
	width:95px;
	height:25px;
	padding:5px 0px 0px 5px;

}

.th{
	
	border-left:solid 1px #000;
	border-right:solid 1px #000;
	border-bottom:solid 1px #000;
	width:95px;
	height:25px;
	padding:5px 0px 0px 5px;

}


.td_top{

	background:#eee;
	text-align:center;
	border-top:solid 1px #000;
	border-right:solid 1px #000;
	border-bottom:solid 1px #000;
	width:100px;
	height:25px;
	padding:5px 0px 0px 0px;
	

}

.td{

	text-align:center;
	border-right:solid 1px #000;
	border-bottom:solid 1px #000;
	width:100px;
	height:25px;
	padding:5px 0px 0px 0px;
	

}

.td_hidden{
	/*display:none;*/

}

.form_txt{

	width:60px;
	
}

.bg_gray{

	background:#ddd;
	
}

</style>

</head>

<body>

<div style="margin:0px 0px 0px 0px;" id="wrapper">
	<div>
<a href="index.php">管理トップ</a> &gt; 
<a href="sale.php">売上・ポイント</a> &gt; 
<a href="sale_therapist.php?area=<?php echo $area;?>&year=<?php echo $year;?>&month=<?php echo $month;?>&day=<?php echo $day;?>">
セラピスト(<?php echo $area_name;?>)
</a> &gt; 
<?php echo $name;?>
	</div>
	
	<div style="padding:10px 0px 0px 500px;">
	<form action="" method="post">
	<input type="hidden" name="year" value="<?php echo $year;?>" />
	<input type="hidden" name="month" value="<?php echo $month;?>" />
	<input type="hidden" name="day" value="<?php echo $day;?>" />
	<input type="hidden" name="therapist_id" value="<?php echo $therapist_id;?>" />
	<input type="hidden" name="area" value="<?php echo $area;?>" />
	<input type="submit" name="send_csv" value="CSV出力" style="padding:5px 10px 5px 10px;" />
	</form>
	</div>
	
	<div style="padding:0px 0px 100px 30px;">
	
	<div style="padding:10px 0px 0px 0px;">
	
		<div style="float:left;">
			<div class="th_top"><?php echo $name;?></div>
			<div class="th">売上</div>
			<div class="th">施術売上</div>
			<div class="th">報酬</div>
			<div class="th">保険料</div>
			<div class="th">支払額</div>
			<div class="th">自走手当</div>
			<div class="th">手当</div>
			<div class="th">立替金</div>
			<div class="th">清算済み</div>
			<div class="th">日払い</div>
			<div class="th">シェア率</div>
			<div class="th">累計pt</div>
			<div class="th">獲得pt</div>
			<div class="th">施術pt</div>
			<div class="th">指名pt</div>
			<div class="th">リピートpt</div>
			<div class="th">リピーター</div>
		</div>
		
		<div style="float:left;width:1100px;overflow:scroll;">
		
		<div style="width:3200px;padding:0px 0px 30px 0px;">
		
<?php

$therapist_data = get_therapist_data_by_id($therapist_id);

$jisou_flg = $therapist_data["jisou_flg"];
$transport_cost = $therapist_data["transport_cost"];

$kakutoku_point = 0;

for($i=1;$i<=$last_day;$i++){
	
	$pre_day_flg = false;
	
	$day = $i;
	
	$sale_not_edit_flg = check_sale_not_edit_day_common($year,$month,$day);
	
	$timestamp = get_timestamp_by_year_month_day_common($year,$month,$day);
	
	$point_past_flg = get_point_past_flg($year,$month,$day);
	
	if( $timestamp < $timestamp_now ){
		
		$pre_day_flg = true;
		
	}
	
	$data = get_attendance_data_work_common($therapist_id,$year,$month,$day);
	$attendance_id = $data["id"];
	$pay_another = $data["pay_another"];
	$pay_finish = $data["pay_finish"];
	$pay_day = $data["pay_day"];
	$allowance = $data["allowance"];
	$allowance_jisou = 0;
	if( $attendance_id != "" ){
		
		$insurance = get_insurance_common($therapist_id,$year,$month,$day);
		
		$insurance_price = 0;
		$insurance_price_disp = 0;
		if( $insurance == "2" ){
			$board_num = get_reservation_for_board_num_by_attendance_id_common($attendance_id);
			$insurance_price = 50 * $board_num;
			$insurance_price_disp = $insurance_price * (-1);
		}
		
		//remuneration_therapistから取得
		$data_tmp = get_remuneration_therapist_by_day_common($therapist_id,$year,$month,$day);
		
		if( $data_tmp["id"] != "" ){
			
			$pay_another = $data_tmp["pay_another"];
			$total_point = $data_tmp["total_point"];
			$allowance_jisou = $data_tmp["allowance_jisou"];
			$sale_price = $data_tmp["sale_price"];
			$sale_price_shijutsu = $data_tmp["sale_price_shijutsu"];
			$pt_repeat = $data_tmp["pt_repeat"];
			$pt_operation = $data_tmp["pt_operation"];
			$pt_shimei = $data_tmp["pt_shimei"];
			$kakutoku_point = $data_tmp["kakutoku_point"];
			$share_rate = $data_tmp["share_rate"];
			$remuneration = $data_tmp["remuneration"];
			
		}else{
			
			if( ( $pay_another == "0" ) && ( $transport_cost != "0" ) ){
				$pay_another = $transport_cost;
				//pay_anotherの更新
				update_pay_another_by_attendance_id($pay_another,$attendance_id);
			}
			$total_point = get_total_point_by_therapist_id_common($therapist_id,$year,$month,$day);
			if( $jisou_flg == "1" ){
				$allowance_jisou = get_allowance_therapist_common($year,$month,$day,$attendance_id);
			}
			$sale_price = get_sokuhou_price_area_by_therapist_id($year,$month,$day,$area,$therapist_id);
			$sale_price_shijutsu = get_sale_price_shijutsu($year,$month,$day,$area,$attendance_id,$sale_price);
			$data = get_therapist_point_by_attendance_id_common($attendance_id);
			$pt_repeat = $data["pt_repeat"];
			$pt_operation = $data["pt_operation"];
			$pt_shimei = $data["pt_shimei"];
			$kakutoku_point = $pt_repeat + $pt_operation + $pt_shimei;
			if($therapist_data["area"]=="tokyo_reraku"){
				$share_rate = $therapist_data["share_rate"] * 100;
			}
			else{
				$share_rate = get_share_rate_by_attendance_id_common($attendance_id);
			}
			
			$remuneration_data = get_therapist_remuneration_by_attendance_id_common($attendance_id);
			$remuneration = $remuneration_data["remuneration"];
		
		}
		
		$repeat_point_data = get_repeat_point_data_by_attendance_id($attendance_id);
		$repeater_num = $repeat_point_data["num"];
		
		if( $share_rate == "-1" ){
		
			$share_rate = "---";
		
		}
		
		$remuneration_shiharai = $remuneration - $insurance_price;
	
	}
	
if( $attendance_id != "" ){
	
	$day_disp = $month.'月'.$i.'日';
	
?>
	
<div style="float:left;">

<div class="td_top"><?php echo $day_disp;?></div>
<div class="td"><?php echo $sale_price;?></div>
<div class="td"><?php echo $sale_price_shijutsu;?></div>

<?php
if( ($sale_price == "0") && ($pre_day_flg == true) && ($sale_not_edit_flg != false) ){
	
	echo '<div class="td" id="lowest_guarantee_'.$attendance_id.'">';
	echo '<form id="lowest_guarantee_frm_'.$attendance_id.'">';
	echo '<input type="hidden" name="therapist_id" value="'.$therapist_id.'" />';
	echo '<input type="text" name="frm_val" value="'.$remuneration.'" class="form_txt" />';
	echo '</form>';
	echo '</div>';
	
}else{
	echo '<div class="td">';
	echo $remuneration;
	echo '</div>';
}
?>

<div class="td"><?php echo $insurance_price_disp;?></div>

<div class="td"><?php echo $remuneration_shiharai;?></div>

<div class="td"><?php echo $allowance_jisou;?></div>

<div class="td" id="allowance_<?php echo $attendance_id;?>">
<?php
if($sale_not_edit_flg==false){
	echo "<div>";
	echo $allowance;
	echo "</div>";
}else{
?>
<form id="allowance_frm_<?php echo $attendance_id;?>">
<input type="hidden" name="therapist_id" value="<?php echo $therapist_id;?>" />
<input type="text" name="frm_val" value="<?php echo $allowance;?>" class="form_txt" />
</form>
<?php
}
?>
</div>

<div class="td td_pay_another" id="pay_another_<?php echo $attendance_id;?>">
<?php
if($sale_not_edit_flg==false){
	echo "<div>";
	echo $pay_another;
	echo "</div>";
}else{
?>
<div class="td_hidden" id="pay_another_hidden_<?php echo $attendance_id;?>">
<form id="pay_another_frm_<?php echo $attendance_id;?>">
<input type="hidden" name="therapist_id" value="<?php echo $therapist_id;?>" />
<input type="text" name="frm_val" value="<?php echo $pay_another;?>" class="form_txt" id="pay_another_txt_<?php echo $attendance_id;?>" />
</form>
</div>
<?php
}
?>
</div>

<div class="td td_pay_finish" id="pay_finish_<?php echo $attendance_id;?>">
<?php
if($sale_not_edit_flg==false){
	echo "<div>";
	echo $pay_finish;
	echo "</div>";
}else{
?>
<div class="td_hidden" id="pay_finish_hidden_<?php echo $attendance_id;?>">
<form id="pay_finish_frm_<?php echo $attendance_id;?>">
<input type="hidden" name="therapist_id" value="<?php echo $therapist_id;?>" />
<input type="text" name="frm_val" value="<?php echo $pay_finish;?>" class="form_txt" id="pay_finish_txt_<?php echo $attendance_id;?>" />
</form>
</div>
<?php
}
?>
</div>

<div class="td td_pay_day" id="pay_day_<?php echo $attendance_id;?>">
<?php
if($sale_not_edit_flg==false){
	echo "<div>";
	echo $pay_day;
	echo "</div>";
}else{
?>
<div class="td_hidden" id="pay_day_hidden_<?php echo $attendance_id;?>">
<form id="pay_day_frm_<?php echo $attendance_id;?>">
<input type="hidden" name="therapist_id" value="<?php echo $therapist_id;?>" />
<input type="text" name="frm_val" value="<?php echo $pay_day;?>" class="form_txt" id="pay_day_txt_<?php echo $attendance_id;?>" />
</form>
</div>
<?php
}
?>
</div>

<?php
if( $share_rate=="50" ){
	
echo '<div class="td bg_gray">'.$share_rate.'</div>';


echo '<div class="td">-</div>';

echo '<div class="td">-</div>';

echo '<div class="td">-</div>';

echo '<div class="td">-</div>';

echo '<div class="td">-</div>';

}else{

echo '<div class="td">'.$share_rate.'</div>';

echo '<div class="td">'.$total_point.'</div>';

echo '<div class="td" id="kakutoku_point_'.$attendance_id.'">';
echo '<form id="kakutoku_point_frm_'.$attendance_id.'">';
echo '<input type="hidden" name="year" value="'.$year.'" />';
echo '<input type="hidden" name="month" value="'.$month.'" />';
echo '<input type="hidden" name="day" value="'.$day.'" />';
echo '<input type="hidden" name="area" value="'.$area.'" />';
echo $kakutoku_point;
echo '</form>';
echo '</div>';

echo '<div class="td" id="pt_operation_'.$attendance_id.'">';

if( ($point_past_flg == true) || ($sale_not_edit_flg == false) ){
	
	echo $pt_operation;
	
}else{
	
	echo '<form id="pt_operation_frm_'.$attendance_id.'">';
	echo '<input type="hidden" name="therapist_id" value="'.$therapist_id.'" />';
	echo '<input type="text" name="frm_val" value="'.$pt_operation.'" class="form_txt" />';
	echo '</form>';

}

echo '</div>';

echo '<div class="td" id="pt_shimei_'.$attendance_id.'">';

if( ($point_past_flg == true) || ($sale_not_edit_flg == false) ){

	echo $pt_shimei;

}else{
	
	echo '<form id="pt_shimei_frm_'.$attendance_id.'">';
	echo '<input type="hidden" name="therapist_id" value="'.$therapist_id.'" />';
	echo '<input type="text" name="frm_val" value="'.$pt_shimei.'" class="form_txt" />';
	echo '</form>';

}

echo '</div>';

echo '<div class="td" id="pt_repeat_'.$attendance_id.'">';

if( ($point_past_flg == true) || ($sale_not_edit_flg == false) ){

	echo $pt_repeat;

}else{
	
	echo '<form id="pt_repeat_frm_'.$attendance_id.'">';
	echo '<input type="hidden" name="therapist_id" value="'.$therapist_id.'" />';
	echo '<input type="text" name="frm_val" value="'.$pt_repeat.'" class="form_txt" />';
	echo '</form>';

}

echo '</div>';

}

?>

<div class="td"><?php echo $repeater_num;?>件</div>

</div>

<?php

}

}
?>
		<br class="clear" />
		
		</div>
		
		</div>
		
		<br class="clear" />
		
	</div>
	
	</div>
	
	
<div style="margin-top:0px;">
<?php
$time2 = time();
$action_time = $time2 - $time1;
echo "action_time:".$action_time;
?>
</div>
	
</div>

</body>
</html>