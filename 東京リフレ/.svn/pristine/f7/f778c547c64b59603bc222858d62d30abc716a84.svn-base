<?php
header("Content-type: text/html; charset=UTF-8");
include("include/common.php");
include("include/auth.php");
include("include/AWSSDKforPHP/aws.phar");

use Aws\S3\S3Client;
use Aws\Common\Enum\Region;
use Aws\S3\Exception\S3Exception;
use Guzzle\Http\EntityBody;

$page_type_name = "";
$furikomi_commission = 0;
$error = "";

if( isset($_POST["send"]) == true ){

	$type = $_POST["type"];
	$area = $_POST["area"];
	$namae = $_POST["namae"];
	$mail = $_POST["mail"];
	$tel = $_POST["tel"];
	$kenmu = $_POST["kenmu"];
	$not_num_flg = $_POST["not_num_flg"];
	$boss_flg = $_POST["boss_flg"];
	$rank = $_POST["rank"];
	$for_kobetsu_url = $_POST["for_kobetsu_url"];
	$shayousha_flg = $_POST["shayousha_flg"];

	if( $boss_flg == "" ){
		$boss_flg = 0;
	}

	$car_type = $_POST["car_type"];
	$car_color = $_POST["car_color"];
	$car_number = $_POST["car_number"];
	$pay_hour = $_POST["pay_hour"];
	$pay_fix = $_POST["pay_fix"];
	$fuel = $_POST["fuel"];
	$address = $_POST["address"];
	$bank_info = $_POST["bank_info"];
	$name_furi = $_POST["name_furi"];
	$furikomi_type = $_POST["furikomi_type"];
	$name_man = $_POST["name_man"];
	$password_man = $_POST["password_man"];
	$login_auth_type = $_POST["login_auth_type"];
	$board_disp_flg = $_POST["board_disp_flg"];
	$calendar_disp_flg = $_POST["calendar_disp_flg"];

	$file_name = $_FILES["pic"]["name"];
	$tmp_pic_url = $_FILES["pic"]["tmp_name"];
	$tmp_pic_type = $_FILES['pic']["type"];

	if( $file_name != "" ){
		$result = check_upload_file_name_common($file_name);
		if( $result == false ){
			$error = "ファイル名は半角英数字のみです";
		}
	}

	if( $pay_fix != "" ){
		if (!preg_match("/^[0-9]+$/", $pay_fix)) {
			$error = "固定日給は半角のみです";
		}
	}

	if( ( $namae == "" ) && ( $mail == "" ) && ( $tel == "" ) ){

		$error = "未入力です";

	}else{

		if( $boss_flg == "1" ){
			$result = check_boss_exist($area);
			if( $result == true ){
				$error = "店長は登録済みです";
			}
		}

	}

	if( $error == "" ){

//スタッフデータ登録
/*
regist_staff_data_new(
$namae,$mail,$tel,$type,$area,$kenmu,$not_num_flg,$car_type,$car_color,$car_number,$tmp_pic_url,$file_name,
$boss_flg,$pay_hour,$pay_fix,$fuel,$address,$bank_info,$name_furi,$furikomi_type,$shayousha_flg);
*/



		include(MAN_INC."db_connect.php");

		if( $pay_hour == "-1" ){
			$pay_hour = 0;
		}
		if( $fuel == "-1" ){
			$fuel = 0;
		}
		$kenmu_string = get_kenmu_string($kenmu);

		//トランザクションをはじめる準備
		$sql = "set autocommit = 0";
		mysql_query( $sql, $con );

		//トランザクション開始
		$sql = "begin";
		mysql_query( $sql, $con );

$sql = sprintf("
insert into staff_new_new(type,name,mail,tel,area,kenmu,not_num_flg,car_type,car_color,car_number,
boss_flg,pay_hour,pay_fix,fuel,address,bank_info,name_furi,furikomi_type,shayousha_flg,rank,for_kobetsu_url,name_man,password_man,login_auth_type,board_disp_flg,calendar_disp_flg)
values('%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s')",
$type,$namae,$mail,$tel,$area,$kenmu_string,$not_num_flg,$car_type,$car_color,$car_number,
$boss_flg,$pay_hour,$pay_fix,$fuel,$address,$bank_info,$name_furi,$furikomi_type,$shayousha_flg,$rank,$for_kobetsu_url,$name_man,$password_man,$login_auth_type,$board_disp_flg,$calendar_disp_flg);

		$res = mysql_query($sql, $con);

		if($res == false){

			//ロールバック
			$sql = "rollback";
			mysql_query( $sql, $con );
			echo "error!(staff_regist_input_new:1)";
			exit();

		}

		$staff_id = mysql_insert_id();

		if ( is_uploaded_file($tmp_pic_url) == TRUE ) {

			if( $file_name != "" ){

				$upload_file_name = time().$file_name;
				$img_url = "img/driver/".$staff_id."/".$upload_file_name;



				//S3へ、アップ
				$client = S3Client::factory(array(
					"key" => AWS_KEY,
					"secret" => AWS_SECRET,
					"region" => Region::AP_NORTHEAST_1 // AP_NORTHEAST_1はtokyo region
				));

				$tmpfile = $tmp_pic_url;
				$tempFileType = $tmp_pic_type;

				// バケット名
				$bucket = "s3-refle";
				// アップロードファイル名
				$key = $img_url;

				try {
					$result = $client->putObject(array(
							'Bucket' => $bucket,
							'Key' => $key,
							'Body' => EntityBody::factory(fopen($tmpfile, 'r')),
							'ContentType' => $tempFileType
					));

				} catch (S3Exception $exc) {
					//ロールバック
					$sql = "rollback";
					mysql_query( $sql, $con );
					echo "error!(staff_regist_input_new:2)";
					exit();
				}



$sql = sprintf("
update staff_new_new set car_image_url='%s' where id='%s'",
$img_url,$staff_id);

				//echo $sql;exit();

				$res = mysql_query($sql, $con);

				if($res == false){

					//ロールバック
					$sql = "rollback";
					mysql_query( $sql, $con );
					echo "error!(staff_regist_input_new:3)";
					exit();

				}

			}

		}

		//コミット
		$sql = "commit";
		mysql_query( $sql, $con );

		//MySQL切断
		mysql_close( $con );



		$url = sprintf("Location: staff_regist_complete_new.php?type=%s&area=%s",$type,$area);
		header($url);
		exit();

	}

}else if( (isset($_GET["type"]) == true) && (isset($_GET["area"]) == true) ){

	$type = $_GET["type"];
	$area = $_GET["area"];

}else{

	echo "パラメーターが不足しています。";
	exit();

}

$type_name = get_type_name_by_type($type);
$area_name = get_area_name_by_area($area);

$page_type_name = $type_name;

$pay_hour_select_frm = get_staff_pay_hour_select_frm($pay_hour);
$remuneration_type = get_remuneration_type_common($staff_id,$year,$month,$day);
$remuneration_type_disp = get_remuneration_type_disp($remuneration_type);
$login_type_select = get_login_type_select_2($type,$login_auth_type);
$board_disp_flg_select = get_board_disp_flg_select($board_disp_flg);
$calendar_disp_flg_select = get_calendar_disp_flg_select($calendar_disp_flg);

?>

<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<title>管理ページ・スタッフ登録(<?php echo $area_name;?>)</title>
	<script type="text/javascript" src="../js/jquery-1.7.2.js"></script>
	<script type="text/javascript" src="main.js"></script>
	<link href="style.css" rel="stylesheet" type="text/css" />

	<style>

	.td_title{

		padding:10px;
		width:80px;
		font-size:12px;
	}

	</style>

	</head>
	<body>
		<div style="width:1024px;margin:0px auto 0px auto;">
			<div>
				<div style="float:left;">
					<a href="index.php">トップ</a> &gt;
					<a href="staff_list_new.php?area=<?php echo $area;?>&type=<?php echo $type;?>">スタッフ一覧(<?php echo $area_name;?>)</a> &gt;
					<?php echo $page_type_name;?>登録(<?php echo $area_name;?>)
				</div>
				<div style="float:right;"><a href="logout.php">ログアウト</a></div>
				<br style="clear:both" />
			</div>
			<div style="padding:30px 0px 100px 300px;">
				<form action="" method="post" enctype="multipart/form-data">
					<input type="hidden" name="type" value="<?php echo $type;?>" />
					<input type="hidden" name="area" value="<?php echo $area;?>" />
					<div style="padding:20px 0px 20px 0px;font-weight:bold;"><?php echo $page_type_name;?>登録(<?php echo $area_name;?>)</div>
					<div style="color:red;"><?php echo $error;?></div>
					<table BORDER="1" CELLSPACING="0" CELLPADDING="0" bordercolor="#ccc">
						<tr>
							<td>
								<div class="td_title">
									名前
								</div>
							</td>
							<td>
								<div style="padding:10px;">
									<input type="text" name="namae" value="<?php echo $namae;?>" style="width:300px;" required>
								</div>
							</td>
						</tr>
						<tr>
							<td>
								<div class="td_title">
									名前(フリガナ)
								</div>
							</td>
							<td>
								<div style="padding:10px;">
									<input type="text" name="name_furi" value="<?php echo $name_furi;?>" style="width:300px;" required>
								</div>
							</td>
						</tr>
						<tr>
							<td>
								<div class="td_title">
									メールアドレス
								</div>
							</td>
							<td>
								<div style="padding:10px;">
									<input type="email" name="mail" value="<?php echo $mail;?>" style="width:300px;" required>
								</div>
							</td>
						</tr>
					<?php if($type=="driver"){
						if($area=="tokyo"){//現在は東京だけ?>
						<tr>
							<td><div class="td_title">ランク</div></td>
							<td>
								<div style="padding:10px;">
									<!--<input type="radio" name="rank" value="0" <?php $rankCk[0];?>>未選択-->
									<input type="radio" name="rank" value="4" <?php $rankCk[4];?> checked>新人
									<input type="radio" name="rank" value="1" <?php $rankCk[1];?>>A
									<input type="radio" name="rank" value="2" <?php $rankCk[2];?>>B
									<input type="radio" name="rank" value="3" <?php $rankCk[3];?>>C
									<input type="radio" name="rank" value="5" <?php $rankCk[5];?>>D
									<input type="radio" name="rank" value="19" <?php $rankCk[6];?>>対象外
								</div>
							</td>
						</tr>
					<?php }else{?>
					<?php
					/*使ってない？
					echo '<tr>';
					echo '<td>';
					echo '<div class="td_title">兼務</div>';
					echo '</td>';
					echo '<td>';
					echo '<div style="padding:10px;">';

					$check_area = "yokohama";
					$result = therapist_regist_input_kenmu_check($kenmu,$check_area);
					if( $result == "true" ){
						echo '<input type="checkbox" name="kenmu[]" value="yokohama" checked>横浜　';
					}else{
						echo '<input type="checkbox" name="kenmu[]" value="yokohama">横浜　';
					}

					echo '</div>';
					echo '</td>';
					echo '</tr>';
					echo '<tr>';
					echo '<td>&nbsp;</td>';
					echo '<td>';
					echo '<div style="padding:10px;">';

					if( $not_num_flg == "1" ){

						echo '<input type="checkbox" name="not_num_flg" value="1" checked>東京ドライバーの人数に加えない';

					}else{

						echo '<input type="checkbox" name="not_num_flg" value="1">東京ドライバーの人数に加えない';

					}
					echo '</div>';
					echo '</td>';
					echo '</tr>';
					*/?>
						<tr>
							<td><div class="td_title">店長</div></td>
							<td>
								<div style="padding:10px;">
								<?php if( $boss_flg == "1" ){?>
									<input type="radio" name="boss_flg" value="0">NO
									<input type="radio" name="boss_flg" value="1" checked>YES
								<?php }else{?>
									<input type="radio" name="boss_flg" value="0" checked>NO
									<input type="radio" name="boss_flg" value="1">YES
								<?php }?>
								</div>
							</td>
						</tr>
					<?php }?>
					<?php
						/*
						<tr>
							<td><div class="td_title">社用車</div></td>
							<td>
								<div style="padding:10px;">
								<?php if( $shayousha_flg == "1" ){?>
									<input type="radio" name="shayousha_flg" value="0">NO
									<input type="radio" name="shayousha_flg" value="1" checked>YES
								<?php }else{?>
									<input type="radio" name="shayousha_flg" value="0" checked>NO
									<input type="radio" name="shayousha_flg" value="1">YES
								<?php }?>
								</div>
							</td>
						</tr>
						*/
						?>
						<tr>
							<td><div class="td_title">個別URL用文字</div></td>
							<td>
								<div style="padding:10px;">
									<input type="text" name="for_kobetsu_url" value="<?php $for_kobetsu_url;?>" style="width:300px;" required>
								</div>
							</td>
						</tr>
					</table>
					<?php }?>
					<table style="margin:20px 0 0 0;" BORDER="1" CELLSPACING="0" CELLPADDING="0" bordercolor="#ccc">
						<tr>
							<td><div class="td_title">報酬タイプ</div></td>
							<td><div style="padding:10px;"><?php echo $remuneration_type_disp;?></div></td>
						</tr>
						<tr>
							<td><div class="td_title">時給</div></td>
							<td><div style="padding:10px;"><?php echo $pay_hour_select_frm;?></div></td>
						</tr>
						<tr>
							<td><div class="td_title">固定日給</div></td>
							<td>
								<div style="padding:10px;width:304px;">
									<input type="number" name="pay_fix" value="<?php echo $pay_fix;?>" style="width:80px;" />&nbsp;円
								</div>
							</td>
						</tr>
						<?php if( $type == "driver" ){ ?>
						<tr>
							<td><div class="td_title">燃費</div></td>
							<td>
								<div style="padding:10px;">
									<select name="fuel">
										<?php if( $fuel == "15" ){?>
										<option value="10">10km</option>
										<option value="15" selected>15km</option>
										<?php }else{?>
										<option value="10" selected>10km</option>
										<option value="15">15km</option>
										<?php }?>
									</select>
								</div>
							</td>
						</tr>
						<?php }?>
					</table>
					<?php if( $type == "driver" ){ ?>

					<table style="margin:20px 0 0 0;" BORDER="1" CELLSPACING="0" CELLPADDING="0" bordercolor="#ccc">
						<tr>
							<td><div class="td_title">車種</div></td>
							<td><div style="padding:10px;"><input type="text" name="car_type" value="<?php echo $car_type;?>" style="width:300px;" /></div></td>
						</tr>
						<tr>
							<td><div class="td_title">車の色</div></td>
							<td><div style="padding:10px;"><input type="text" name="car_color" value="<?php echo $car_color;?>" style="width:300px;" /></div></td>
						</tr>
						<tr>
							<td><div class="td_title">車のナンバー</div></td>
							<td><div style="padding:10px;"><input type="text" name="car_number" value="<?php echo $car_number;?>" style="width:300px;" /></div></td>
						</tr>
						<tr>
							<td><div class="td_title">車の画像</div></td>
							<td><div style="padding:10px;"><input type="file" name="pic" /></div></td>
						</tr>
					</table>
					<?php } ?>

					<table style="margin:20px 0 0 0;" BORDER="1" CELLSPACING="0" CELLPADDING="0" bordercolor="#ccc">
						<tr>
							<td><div class="td_title">住所</div></td>
							<td><div style="padding:10px;"><input type="text" name="address" value="<?php echo $address;?>" style="width:300px;" required></div></td>
						</tr>
						<tr>
							<td><div class="td_title">電話番号</div></td>
							<td><div style="padding:10px;"><input type="tel" name="tel" value="<?php echo $tel;?>" style="width:300px;" required></div></td>
						</tr>
						<tr>
							<td><div class="td_title">振込口座</div></td>
							<td><div style="padding:10px;"><textarea name="bank_info" style="width:300px;height:60px;"><?php echo $bank_info;?></textarea></div></td>
						</tr>
						<tr>
							<td><div class="td_title">振込手数料タイプ</div></td>
							<td>
								<div style="padding:10px;">
									<select name="furikomi_type">
										<option value="-1">未選択</option>';
									<?php if( $furikomi_type == "1" ){?>
										<option value="1" selected>JP→JP</option>
										<option value="2">JP→他行</option>
										<option value="3">ゆうちょ→ゆうちょ</option>
										<option value="4">ゆうちょ→他行</option>
									<?php }else if( $furikomi_type == "2" ){?>
										<option value="1">JP→JP</option>
										<option value="2" selected>JP→他行</option>
										<option value="3">ゆうちょ→ゆうちょ</option>
										<option value="4">ゆうちょ→他行</option>
									<?php }else if( $furikomi_type == "3" ){?>
										<option value="1">JP→JP</option>
										<option value="2">JP→他行</option>
										<option value="3" selected>ゆうちょ→ゆうちょ</option>
										<option value="4">ゆうちょ→他行</option>
									<?php }else if( $furikomi_type == "4" ){?>
										<option value="1">JP→JP</option>
										<option value="2">JP→他行</option>
										<option value="3">ゆうちょ→ゆうちょ</option>
										<option value="4" selected>ゆうちょ→他行</option>
									<?php }else{?>
										<option value="1">JP→JP</option>
										<option value="2">JP→他行</option>
										<option value="3">ゆうちょ→ゆうちょ</option>
										<option value="4">ゆうちょ→他行</option>
									<?php }?>
									</select>
								</div>
							</td>
						</tr>
					</table>
					<div style="margin:20px 0px 0px 0px;">
						<table style="margin:20px 0 0 0;" BORDER="1" CELLSPACING="0" CELLPADDING="0" bordercolor="#ccc">
							<tr>
								<td><div class="td_title">ログインID</div></td>
								<td>
									<div style="padding:10px;">
										<input type="text" name="name_man" value="<?php echo $name_man;?>" style="width:300px;" required>
									</div>
								</td>
							</tr>
							<tr>
								<td><div class="td_title">ログインPW</div></td>
								<td>
									<div style="padding:10px;">
										<input type="password" name="password_man" value="<?php echo $password_man;?>" style="width:300px;" required>
									</div>
								</td>
							</tr>
							<tr>
								<td><div class="td_title">ログインタイプ</div></td>
								<td>
									<div style="padding:10px;">
										<?php echo $login_type_select;?>
									</div>
								</td>
							</tr>
							<tr>
								<td><div class="td_title">スタッフ伝言板</div></td>
								<td>
									<div style="padding:10px;">
										<?php echo $board_disp_flg_select;?>
									</div>
								</td>
							</tr>
							<tr>
								<td><div class="td_title">スタッフカレンダー</div></td>
								<td>
									<div style="padding:10px;">
										<?php echo $calendar_disp_flg_select;?>
									</div>
								</td>
							</tr>
						</table>
					</div>
					<div style="padding:20px 0px 0px 0px;">
						<input type="submit" name="send" value="登録" style="padding:5px 10px 5px 10px;" />
					</div>
				</form>
			</div>
		</div>
	</body>
</html>
