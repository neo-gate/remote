<?php
/* =================================================================================
		Script Name	functions.php( man用のファンクション集 )
		Update Date	2018/02/09	管理者権限以外のメニューの為に変更 by aida
================================================================================= */

function update_vip_order_key($area,$therapist_id,$vip_order_key){
	$sql = sprintf("update therapist_new set vip_order_key='%s' where id='%s'",$vip_order_key,$therapist_id);
	//echo $sql;exit();
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(update_vip_order_key)";
		return false;
		exit();
	}else{
		return true;
		exit();
	}
}

//最新CSVからcustomerテーブルを更新
function update_by_csv(){

	if(PHP_OS=="WINNT"){

		$csv_path = "C:/svn/neogate/sites/csv/customer.csv";

	}else{

		$csv_path = "/home/neogate/sites/csv/customer.csv";

	}

	$fp = fopen($csv_path, "r");

	if (flock($fp, LOCK_EX)) {
		// 排他的ロックを行う

		$first_flag = false;

		//while (($data = fgetcsv($fp, 1024))!==FALSE) {
		while (($data = fgetcsv_reg($fp)) !== false) {

			if($first_flag == true){

				//管理IDがマッチしないデータはインサート

				$kanri_id = $data[52];

				$sql = sprintf("select id from customer where kanri_id='%s'",$kanri_id);

				//echo $sql;exit();

				$res = mysql_query($sql, DbCon);

				if($res === false){

					echo "error!(update_by_csv:1)";
					exit();

				}

				$num = mysql_num_rows($res);

				if( $num == 0 ){

					/* SJISからUTF-8に変換 */

					$shop_name = mb_convert_encoding($data[26], "UTF-8", "SJIS");
					$tel = mb_convert_encoding($data[6], "UTF-8", "SJIS");
					$customer_name = mb_convert_encoding($data[0], "UTF-8", "SJIS");
					$customer_name_kana = mb_convert_encoding($data[1], "UTF-8", "SJIS");

					$skip_flag = false;

					$shop_id = -1;

					if( $shop_name=="東京リフレ" ){

						$shop_id = 1;

					}else if( $shop_name=="東京アロマ" ){

						$shop_id = 2;

					}else if( $shop_name=="東京ガールズリフレ" ){

						$shop_id = 3;

					}else if( $shop_name=="リンパマッサージ東京" ){

						$shop_id = 4;

					}else if( $shop_name=="幕張リフレ" ){

						$shop_id = 5;

					}else if( $shop_name=="札幌リフレ" ){

						$shop_id = 6;

					}else if( $shop_name=="横浜リフレ" ){

						$shop_id = 7;

					}else if( $shop_name=="仙台リフレ" ){

						$shop_id = 8;

					}else if( $shop_name=="福岡リフレ" ){

						$shop_id = 9;

					}else{

						$skip_flag = true;

					}

					$tel = str_replace("-","",$tel);

					if( $tel=="" ){
						$skip_flag = true;
					}

					if( ($customer_name=="") && ($customer_name_kana=="") ){
						$skip_flag = true;
					}

					if( $skip_flag==false ){

						$sql = sprintf("insert into customer(shop_id,name,name_kana,tel,kanri_id) values('%s','%s','%s','%s','%s')",
						$shop_id,$customer_name,$customer_name_kana,$tel,$kanri_id);

						$res = mysql_query($sql, DbCon);

						if($res === false){

							echo "error!(update_by_csv:2)";
							exit();

						}

					}

				}


			}else{

				$first_flag = true;

			}

		}

		flock($fp, LOCK_UN); // ロックを解放する

	} else {

		echo "排他的ロックに失敗しました。";

	}

	fclose($fp);

}

function update_by_csv_2($csv_path){

	$fp = fopen($csv_path, "r");

	while (($data = fgetcsv_reg($fp)) !== false) {
		/*
		echo "<pre>";
		print_r($data);
		echo "</pre>";
		exit;
		*/
		//更新されていないものはスルー↓
		$customer_id = mb_convert_encoding($data[4], "UTF-8", "SJIS");
		$upd_time = mb_convert_encoding($data[52], "UTF-8", "SJIS");

		if(( $customer_id == "" )||( $upd_time == "" )){

			$result = 1;

		}else{

			$result = customer_upd_check($customer_id, $upd_time);

		}
		//更新されていないものはスルー↑
		if( $result != 1 ){

			$skip_flag = 0;
			/* SJISからUTF-8に変換 */
			$customer_name = mb_convert_encoding($data[0], "UTF-8", "SJIS");
			$customer_name_kana = mb_convert_encoding($data[1], "UTF-8", "SJIS");
			$tel = mb_convert_encoding($data[6], "UTF-8", "SJIS");
			$tel_2 = mb_convert_encoding($data[7], "UTF-8", "SJIS");
			$tel_3 = mb_convert_encoding($data[8], "UTF-8", "SJIS");
			$tel_4 = mb_convert_encoding($data[9], "UTF-8", "SJIS");
			$tel_5 = mb_convert_encoding($data[10], "UTF-8", "SJIS");
			$address_1 = mb_convert_encoding($data[13], "UTF-8", "SJIS");
			$address_2 = mb_convert_encoding($data[14], "UTF-8", "SJIS");
			$email_1 = mb_convert_encoding($data[15], "UTF-8", "SJIS");
			$email_2 = mb_convert_encoding($data[16], "UTF-8", "SJIS");
			$email_3 = mb_convert_encoding($data[17], "UTF-8", "SJIS");
			$email_4 = mb_convert_encoding($data[18], "UTF-8", "SJIS");
			$email_5 = mb_convert_encoding($data[19], "UTF-8", "SJIS");
			$shop_name = mb_convert_encoding($data[26], "UTF-8", "SJIS");
			$kanri_id = mb_convert_encoding($data[53], "UTF-8", "SJIS");

			$shop_id = get_shop_id_by_shop_name_common($shop_name);
			$tel = str_replace("-","",$tel);
			$tel_2 = str_replace("-","",$tel_2);
			$tel_3 = str_replace("-","",$tel_3);
			$tel_4 = str_replace("-","",$tel_4);
			$tel_5 = str_replace("-","",$tel_5);

			if( ($customer_name == "") && ($customer_name_kana == "") ){$skip_flag = 1;}
			if( ( $tel == "" )&&( $email_1 == "" ) ){$skip_flag = 1;}
			if( $shop_id == "" ){$skip_flag = 1;}

			if( $skip_flag != 1 ){
				//電話番号が一致した場合は、顧客IDと管理IDを上書き。
				$result = check_customer_by_id($customer_id);
				if( $result == true ){
					update_customer($customer_name,$customer_name_kana,$customer_id,$tel,$tel_2,$tel_3,$tel_4,$tel_5,$address_1,$address_2,$email_1,$email_2,$email_3,$email_4,$email_5,$shop_id,$kanri_id,$upd_time);
				}else{
					insert_customer($customer_name,$customer_name_kana,$customer_id,$tel,$tel_2,$tel_3,$tel_4,$tel_5,$address_1,$address_2,$email_1,$email_2,$email_3,$email_4,$email_5,$shop_id,$kanri_id,$upd_time);
					//update_rsv_board($customer_id,$tel,$tel_2,$tel_3,$tel_4,$tel_5);
				}
			}
		}

	}

	fclose($fp);

	return true;
	exit();

}


/**
* ファイルポインタから行を取得し、CSVフィールドを処理する
* @param resource handle
* @param int length
* @param string delimiter
* @param string enclosure
* @return ファイルの終端に達した場合を含み、エラー時にFALSEを返します。
*/
function fgetcsv_reg (&$handle, $length = null, $d = ',', $e = '"') {
	$eof = false;
	$d = preg_quote($d);
	$e = preg_quote($e);
	$_line = "";
	while (($eof != true)and(!feof($handle))) {
		$_line .= (empty($length) ? fgets($handle) : fgets($handle, $length));
		$itemcnt = preg_match_all('/'.$e.'/', $_line, $dummy);
		if ($itemcnt % 2 == 0) $eof = true;
	}
	$_csv_line = preg_replace('/(?:\\r\\n|[\\r\\n])?$/', $d, trim($_line));
	$_csv_pattern = '/('.$e.'[^'.$e.']*(?:'.$e.$e.'[^'.$e.']*)*'.$e.'|[^'.$d.']*)'.$d.'/';
	preg_match_all($_csv_pattern, $_csv_line, $_csv_matches);
	$_csv_data = $_csv_matches[1];
	for($_csv_i=0;$_csv_i<count($_csv_data);$_csv_i++){
		$_csv_data[$_csv_i]=preg_replace('/^'.$e.'(.*)'.$e.'$/s','$1',$_csv_data[$_csv_i]);
		$_csv_data[$_csv_i]=str_replace($e.$e, $e, $_csv_data[$_csv_i]);
	}
	return empty($_line) ? false : $_csv_data;
}

function get_voice_list_man($paging_num,$display_num){

	$start_num = $display_num*($paging_num-1);

	$sql = sprintf("select * from voice where delete_flg=0 order by created desc limit %s,%s",$start_num,$display_num);
	$res = mysql_query($sql, DbCon);
	if($res == false){

		echo "クエリー実行で失敗しました(get_voice_list_man)";
		exit();

	}
	$i=0;
	$list_data = array();
	while($row = mysql_fetch_assoc($res)){
		$list_data[$i++] = $row;
	}

	return $list_data;
	exit();

}

//ページングの最大値を取得
function get_paging_max_num_voice_man($display_num,$shop_type){

	$sql = sprintf("select id from voice where shop_type='%s' and delete_flg='0'",$shop_type);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリー実行で失敗しました(get_paging_max_num_voice_man)";
		exit();

	}

	$num_rows = mysql_num_rows($res);

	$max_num = ceil($num_rows/$display_num);

	return $max_num;
	exit();

}

function man_voice_list_delete($voice_id){

	$sql = sprintf("update voice set delete_flg='1' where id='%s'",$voice_id);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリー実行で失敗しました(man_voice_list_delete)";
		exit();

	}

	return true;
	exit();

}

function voice_list_publish_action($voice_id){

	$sql = sprintf("update voice set publish_flg='1' where id='%s'",$voice_id);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリー実行で失敗しました(voice_list_publish_action)";
		exit();

	}

	return true;
	exit();

}

function voice_list_not_publish_action($voice_id){

	$sql = sprintf("update voice set publish_flg='0' where id='%s'",$voice_id);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリー実行で失敗しました(voice_list_not_publish_action)";
		exit();

	}

	return true;
	exit();

}

function get_voice_one_data_man($id){

	$sql = sprintf("select * from voice where id='%s'",$id);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリー実行で失敗しました(get_voice_one_data_man)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();

}

//お客様の声、編集
function update_one_voice_man($id,$name,$age,$gender,$satisfaction,$content){

	$sql = sprintf("update voice set name='%s',age='%s',gender='%s',satisfaction='%s',content='%s' where id='%s'",
					$name,$age,$gender,$satisfaction,$content,$id);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリー実行で失敗しました(update_one_voice_man)";
		exit();

	}

	return true;
	exit();


}

//セラピスト情報更新
function update_therapist_edit_man($therapist_id,$mail,$name_real,$name_refle,$name_aroma,$name_tgr,$name_lymph,$kenmu,$rank){

	$kenmu_string = "";

	$kenmu_num = count($kenmu);

	if( $kenmu_num > 0 ){

		for($i=0;$i<$kenmu_num;$i++){

			$kenmu_string .= $kenmu[$i];

			if( $i != ($kenmu_num-1) ){

				$kenmu_string .= $kenmu_string.",";

			}

		}

	}

	// 会員情報を更新するSQL文
	$sql = sprintf("update therapist set name='%s',mail='%s',name_refle='%s',name_aroma='%s',name_tgr='%s',name_lymph='%s',kenmu='%s',rank='%s' where id='%s'",
					$name_real,$mail,$name_refle,$name_aroma,$name_tgr,$name_lymph,$kenmu_string,$rank,$therapist_id);

	//echo $sql;
	//exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリ実行に失敗しました";
		exit();

	}

	return true;
	exit();

}

//セラピスト情報更新(札幌)
function update_therapist_edit_man_sapporo($therapist_id,$mail,$name_real,$name_sapporo,$rank){

	$sql = sprintf("
update therapist_sapporo set name='%s',mail='%s',name_sapporo='%s',rank='%s' where id='%s'",
$name_real,$mail,$name_sapporo,$rank,$therapist_id);

	//echo $sql;
	//exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリ実行に失敗しました";
		exit();

	}

	return true;
	exit();

}

//セラピストIDからセラピストデータを取得
function get_therapist_info_by_therapist_id($therapist_id){

	$sql = "select * from therapist where id=".$therapist_id;
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリ実行に失敗しました";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();

}

//セラピストIDからセラピストデータを取得(札幌)
function get_therapist_info_by_therapist_id_sapporo($therapist_id){

	$sql = "select * from therapist_sapporo where id=".$therapist_id;
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリ実行に失敗しました";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();

}

//横浜ホテルのidとnameを取得
function get_yokohama_hotel_id_name(){

	$sql = "select id,name from hotel_yokohama where delete_flg=0";
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリ実行に失敗しました(get_yokohama_hotel_id_name)";
		exit();
	}

	$i=0;
	$list_data = array();
	while($row = mysql_fetch_assoc($res)){
		$list_data[$i++] = $row;
	}

	return $list_data;
	exit();

}

//idから横浜ホテルデータを取得
function get_yokohama_hotel_data_by_id($hotel_id){

	$sql = sprintf("select * from hotel_yokohama where id='%s'",$hotel_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリ実行に失敗しました(get_yokohama_hotel_data_by_id)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();

}

//横浜ホテルのdetailを更新
function update_yokohama_hotel_detail($hotel_id,$hotel_detail){

	$sql = sprintf("update hotel_yokohama set detail='%s' where id='%s'",$hotel_detail,$hotel_id);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリー実行で失敗しました(update_yokohama_hotel_detail)";
		exit();

	}

	return true;
	exit();

}

function get_area1_name($area1_id) {

	$area1_name = "不明";

	if( $area1_id == "1" ){
		$area1_name = "東京都";
	}else if( $area1_id == "2" ){
		$area1_name = "横浜・川崎";
	}else if( $area1_id == "3" ){
		$area1_name = "札幌";
	}else if( $area1_id == "4" ){
		$area1_name = "千葉市";
	}else if( $area1_id == "5" ){
		$area1_name = "仙台市";
	}else if( $area1_id == "6" ){
		$area1_name = "福岡市";
	}else if( $area1_id == "7" ){
		$area1_name = "大阪";
	}

	return $area1_name;
	exit();
}

//man/include/functions.phpより転載
function get_area_by_area1_id($area1_id){

	$area = "";

	if( $area1_id == "1" ){
		//$area1_name = "東京都";
		$area = "tokyo";
	}else if( $area1_id == "2" ){
		//$area1_name = "横浜・川崎";
		$area = "yokohama";
	}else if( $area1_id == "3" ){
		//$area1_name = "札幌";
		$area = "sapporo";
	}else if( $area1_id == "4" ){
		//$area1_name = "千葉市";
		$area = "chiba";
	}else if( $area1_id == "5" ){
		//$area1_name = "仙台市";
		$area = "sendai";
	}else if( $area1_id == "6" ){
		//$area1_name = "福岡市";
		$area = "fukuoka";
	}else if( $area1_id == "7" ){
		//$area1_name = "大阪";
		$area = "osaka";
	}

	return $area;
	exit();
}

function get_area2_data($area1_id){

	$sql = sprintf("select id,name from area2_deri where delete_flg=0 and area1_id='%s'",$area1_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリ実行に失敗しました(get_area2_data)";
		exit();
	}

	$i=0;
	$list_data = array();
	while($row = mysql_fetch_assoc($res)){

		$area2_id = $row["id"];

		//ホテルの数を取得
		$hotel_num = get_hotel_num_by_area2_id($area2_id);

		$list_data[$i] = $row;
		$list_data[$i]["hotel_num"] = $hotel_num;

		$i++;

	}

	return $list_data;
	exit();

}

//ホテルの数を取得
function get_hotel_num_by_area2_id($area2_id){

	$sql = sprintf("select id from hotel_deri where delete_flg=0 and area2_id='%s'",$area2_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){

		echo "クエリ実行に失敗しました(get_hotel_num_by_area2_id)";
		exit();

	}
	$num = mysql_num_rows($res);

	return $num;
	exit();

}

function get_area2_name($area2_id){

	$sql = sprintf("select name from area2_deri where id='%s'",$area2_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリ実行に失敗しました(get_area2_name)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row["name"];
	exit();

}

function get_area1_id_by_area2_id($area2_id){

	$sql = sprintf("select area1_id from area2_deri where id='%s'",$area2_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリ実行に失敗しました(get_area1_id_by_area2_id)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row["area1_id"];
	exit();

}

function get_hotel_data_by_area2_id($area2_id){

	$sql = sprintf("select * from hotel_deri where delete_flg=0 and area2_id='%s'",$area2_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリ実行に失敗しました(get_hotel_data_by_area2_id)";
		exit();
	}

	$i=0;
	$list_data = array();
	while($row = mysql_fetch_assoc($res)){

		$list_data[$i++] = $row;

	}

	return $list_data;
	exit();

}

function get_hotel_data_by_hotel_id($hotel_id){

	$sql = sprintf("select * from hotel_deri where id='%s'",$hotel_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリ実行に失敗しました(get_hotel_data_by_hotel_id)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();

}

function get_comment_by_area1_id_and_hotel_id($area1_id,$hotel_id){

	$sql = sprintf("select * from comment_deri where delete_flg=0 and area1_id='%s' and hotel_id='%s' order by time_ts_refle desc,time_ts desc",$area1_id,$hotel_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリ実行に失敗しました(get_comment_by_area1_id_and_hotel_id)";
		exit();
	}

	$i=0;
	$list_data = array();
	while($row = mysql_fetch_assoc($res)){

		$list_data[$i++] = $row;

	}

	return $list_data;
	exit();

}

//コメントの投稿と呼べる呼べないのカウントアップ
function insert_comment_data_hotel_search_detail($hotel_id,$area1_id,$nickname,$hyouka,$hyouka_content){

	//トランザクションをはじめる準備
	$sql = "set autocommit = 0";
	mysql_query( $sql, DbCon );

	//トランザクション開始
	$sql = "begin";
	mysql_query( $sql, DbCon );

	$hyouka_name = "";

	$yoberu_flg = false;
	$yobenai_flg = false;

	if( $hyouka == "1" ){

		$hyouka_name = "呼べる";

		$yoberu_flg = true;

	}else if( $hyouka == "2" ){

		$hyouka_name = "呼べない";

		$yobenai_flg = true;

	}else if( $hyouka == "3" ){

		$hyouka_name = "雑談";

	}else{

		//ロールバック
		$sql = "rollback";
		mysql_query( $sql, DbCon );

		echo "クエリー実行で失敗しました(insert_comment_data_hotel_search_detail)";
		exit();

	}

	if( ($yoberu_flg == true) or ($yobenai_flg == true) ){

		//呼べると呼べないの数を取得
		$data_tmp = get_yoberu_and_yobenai_num($hotel_id,$area1_id);

		/*
		echo "<pre>";
		print_r($data_tmp);
		echo "</pre>";
		exit();
		*/

		if( $data_tmp == false ){

			//ロールバック
			$sql = "rollback";
			mysql_query( $sql, DbCon );

			echo "クエリー実行で失敗しました(insert_comment_data_hotel_search_detail)";
			exit();

		}

		$yoberu_num = $data_tmp["yoberu"];
		$yobenai_num = $data_tmp["yobenai"];

		if( $yoberu_flg == true ){

			$yoberu_num++;

			$sql = sprintf("update hotel_deri set yoberu='%s' where hotel_id='%s' and area1_id='%s'",
			$yoberu_num,$hotel_id,$area1_id);

		}else if( $yobenai_flg == true ){

			$yobenai_num++;

			$sql = sprintf("update hotel_deri set yobenai='%s' where hotel_id='%s' and area1_id='%s'",
			$yobenai_num,$hotel_id,$area1_id);

		}else{

			//ロールバック
			$sql = "rollback";
			mysql_query( $sql, DbCon );

			echo "クエリー実行で失敗しました(insert_comment_data_hotel_search_detail)";
			exit();

		}

		$res = mysql_query($sql, DbCon);

		if($res == false){

			//ロールバック
			$sql = "rollback";
			mysql_query( $sql, DbCon );

			echo "クエリー実行で失敗しました(insert_comment_data_hotel_search_detail)";
			exit();

		}

	}

	$now = time();

	$sql = sprintf("insert into comment_deri(time_ts_refle,area1_id,hotel_id,nickname,type,content) values('%s','%s','%s','%s','%s','%s')",
					$now,$area1_id,$hotel_id,$nickname,$hyouka_name,$hyouka_content);
	$res = mysql_query($sql, DbCon);
	if($res == false){

		//ロールバック
		$sql = "rollback";
		mysql_query( $sql, DbCon );

		echo "クエリー実行で失敗しました(insert_comment_data_hotel_search_detail)";
		exit();

	}

	//コミット
	$sql = "commit";
	mysql_query( $sql, DbCon );

	return true;
	exit();
}

//呼べると呼べないの数を取得
function get_yoberu_and_yobenai_num($hotel_id,$area1_id){

	$sql = sprintf("select yoberu,yobenai from hotel_deri where hotel_id='%s' and area1_id='%s'",$hotel_id,$area1_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){

		return false;
		exit();

	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();

}

//呼べると呼べないの数を取得(hotel_deri_idから)
function get_yoberu_and_yobenai_num_by_hotel_deri_id($hotel_deri_id){

	$sql = sprintf("select yoberu,yobenai from hotel_deri where id='%s'",$hotel_deri_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){

		return false;
		exit();

	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();

}

//area1_idとwordでホテルデータを検索
function get_hotel_data_by_area1_id_and_word($area1_id,$word){

	$word = "%".$word."%";

	$sql = sprintf("select * from hotel_deri where delete_flg=0 and area1_id='%s' and name like '%s'",$area1_id,$word);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリ実行に失敗しました(get_hotel_data_by_area1_id_and_word)";
		exit();
	}

	$i=0;
	$list_data = array();
	while($row = mysql_fetch_assoc($res)){

		$list_data[$i++] = $row;

	}

	return $list_data;
	exit();

}

//セラピストデータ一覧(未登録のセラピストのみ)
function get_therapist_data_by_area($area){

	$sql = sprintf("select id,name_site from therapist_new where leave_flg=0 and test_flg=0 and delete_flg='0' and area='%s'",$area);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリ実行に失敗しました(get_therapist_data_by_area)";
		exit();
	}

	$i=0;
	$list_data = array();
	while($row = mysql_fetch_assoc($res)){

		$therapist_id = $row["id"];

		//セラピストページが存在しているかどうか
		$result = check_therapist_page_exist($therapist_id,$area);

		if( $result == false ){

			$list_data[$i] = $row;
			$i++;

		}

	}

	return $list_data;
	exit();

}

//セラピストページが存在しているかどうか
function check_therapist_page_exist($therapist_id,$area){

	$sql = sprintf("select id from therapist_page where delete_flg=0 and therapist_id='%s' and area='%s'",$therapist_id,$area);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(check_therapist_page_exist)";
		exit();
	}
	$num = mysql_num_rows($res);

	if( $num > 0 ){

		return true;
		exit();

	}else{

		return false;
		exit();

	}

}

//セラピスト情報の取得
function get_therapist_data_for_attendance($area,$day_year,$day_month,$day_day){

	if($area=="tokyo"){

		$sql = "select * from therapist where delete_flag='0' and leave_flg=0";

	}else if($area=="sapporo"){

		$sql = "select * from therapist_sapporo where delete_flg='0' and leave_flg=0";
	}

	$res = mysql_query($sql, DbCon);
	if($res == false){

		echo "クエリ実行に失敗しました(get_therapist_data_for_attendance)";
		exit();

	}

	$i=0;
	$list_data = array();
	while($row = mysql_fetch_assoc($res)){

		$therapist_id = $row["id"];

		if( $area == "tokyo" ){

			//出席データが登録済みであるかどうか(登録済み：true,未登録:false)
			$result = check_therapist_attendance_exist($therapist_id,$day_year,$day_month,$day_day);

		}else if( $area == "sapporo" ){

			//出席データが登録済みであるかどうか(登録済み：true,未登録:false)(札幌)
			$result = check_therapist_attendance_exist_sapporo($therapist_id,$day_year,$day_month,$day_day);

		}

		if($result==false){

			$list_data[$i] = $row;

			if( $area == "tokyo" ){

				$list_data[$i]["area"] = $area;

			}

			$i++;

		}

	}

	if($area=="tokyo"){

		$therapist_area = "yokohama";
		$therapist_kenmu = "tokyo";

		$where_kenmu = "kenmu like '%".$therapist_kenmu."%'";

		$sql = sprintf("select * from therapist_new where delete_flg='0' and leave_flg=0 and area='%s' and (%s)",
$therapist_area,$where_kenmu);

		$res = mysql_query($sql, DbCon);

		if($res == false){

			echo "クエリ実行に失敗しました(get_therapist_data_for_attendance)";
			exit();

		}

		while($row = mysql_fetch_assoc($res)){

			$therapist_id = $row["id"];

			//出席データが登録済みであるかどうか(登録済み：true,未登録:false)
			$result = check_therapist_attendance_exist($therapist_id,$day_year,$day_month,$day_day,$therapist_area);

			if($result==false){

				$list_data[$i] = $row;
				$i++;

			}

		}

	}

	return $list_data;
	exit();

}

//セラピスト情報の取得(チェックなし)
function get_therapist_data_for_attendance_no_check($area,$day_year,$day_month,$day_day){

	if($area=="tokyo"){

		$sql = "select * from therapist where delete_flag='0'";

	}else if($area=="sapporo"){

		$sql = "select * from therapist_sapporo where delete_flg='0'";
	}

	$res = mysql_query($sql, DbCon);
	if($res == false){

		echo "クエリ実行に失敗しました(get_therapist_data_for_attendance_no_check)";
		exit();

	}

	$i=0;
	$list_data = array();
	while($row = mysql_fetch_assoc($res)){

		$list_data[$i++] = $row;

	}

	return $list_data;
	exit();

}

//出席データが登録済みであるかどうか(登録済み：true,未登録:false)
function check_therapist_attendance_exist($therapist_id,$day_year,$day_month,$day_day,$therapist_area){

	if( $therapist_area == "yokohama" ){

		$sql = sprintf("
select id from attendance_new where therapist_id='%s' and year='%s' and month='%s' and day='%s' and area='%s'",
$therapist_id,$day_year,$day_month,$day_day,$therapist_area);

	}else{

		$sql = sprintf("select id from attendance where therapist_id='%s' and year='%s' and month='%s' and day='%s'",
$therapist_id,$day_year,$day_month,$day_day);

	}

	//echo $sql;
	//exit();

	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(check_therapist_attendance_exist)";
		exit();
	}
	$num = mysql_num_rows($res);

	if( $num > 0 ){

		return true;
		exit();

	}else{

		return false;
		exit();

	}

}

//出席データが登録済みであるかどうか(登録済み：true,未登録:false)(札幌)
function check_therapist_attendance_exist_sapporo($therapist_id,$day_year,$day_month,$day_day){

	$sql = sprintf("select id from attendance_sapporo where therapist_id='%s' and year='%s' and month='%s' and day='%s'",
	$therapist_id,$day_year,$day_month,$day_day);

	//echo $sql;
	//exit();

	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(check_therapist_attendance_exist_sapporo)";
		exit();
	}
	$num = mysql_num_rows($res);

	if( $num > 0 ){

		return true;
		exit();

	}else{

		return false;
		exit();

	}

}

// NULLのデータを仮セラピストページ画像テーブルにインサート
function insert_into_null_data_to_therapist_page_img_tmp(){

	$sql = sprintf("insert into therapist_page_img_tmp(img_url) values('%s')",null);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリ実行に失敗しました(insert_into_null_data_to_therapist_page_img_tmp)";
		exit();
	}

	$id = mysql_insert_id();

	return $id;
	exit();

}

// 画像データURLを仮セラピストページ画像テーブルにインサート
function insert_into_img_data_to_therapist_page_img_tmp($img_url){

	$sql = sprintf("insert into therapist_page_img_tmp(img_url) values('%s')",$img_url);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリ実行に失敗しました(insert_into_img_data_to_therapist_page_img_tmp)";
		exit();
	}

	$id = mysql_insert_id();

	return $id;
	exit();

}

//セラピストページ画像の仮アップロード
function upload_therapist_img_tmp($tmp_pic_url,$file_name_hiki,$img_tmp_id){

	if (is_uploaded_file($tmp_pic_url) == TRUE) {

		$pic_url = ROOT_PATH."img/therapist_page/tmp/".$file_name_hiki;
		$img_url = "img/therapist_page/tmp/".$file_name_hiki;

		/*
		echo "tmp_pic_url:";echo $tmp_pic_url;echo "<br />";
		echo "pic_url:";echo $pic_url;echo "<br />";
		exit();
		*/

		if(move_uploaded_file($tmp_pic_url,$pic_url) == TRUE){

			chmod($pic_url,0777);

			// サニタイズ処理
			$pic_url = mysql_real_escape_string($pic_url);

			$sql = sprintf("update therapist_page_img_tmp set img_url='%s' where id='%s'",$img_url,$img_tmp_id);

			//echo $sql;exit();

			$res = mysql_query($sql, DbCon);

			if($res == false){

				echo "クエリ実行に失敗しました(upload_therapist_img_tmp:1)";
				exit();

			}

			return true;
			exit();

		}else{

			echo "クエリ実行に失敗しました(upload_therapist_img_tmp:2)";
			exit();

		}
	}else{

		echo "クエリ実行に失敗しました(upload_therapist_img_tmp:3)";
		exit();

	}

}

//仮画像のurlを取得
function get_therapist_page_img_url_tmp($img_tmp_id){

	$sql = sprintf("select img_url from therapist_page_img_tmp where id='%s'",$img_tmp_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリ実行に失敗しました(get_therapist_page_img_url_tmp)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row["img_url"];
	exit();

}

//セラピストページの仮画像を削除
function delete_therapist_page_tmp_img($img_tmp_id){

	$img_url = get_therapist_page_img_url_tmp($img_tmp_id);
	$pic_url = ROOT_PATH.$img_url;

	// imageを削除する処理
	$sql = sprintf("update therapist_page_img_tmp set img_url='%s' where id='%s'",null,$img_tmp_id);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリ実行に失敗しました(delete_therapist_page_tmp_img)";
		exit();

	}

	unlink($pic_url);

	return true;
	exit();

}

//セラピスト名取得
function get_therapist_name_by_therapist_id($therapist_id,$area){

	$sql = sprintf("select name_site from therapist_new where id='%s'",$therapist_id);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリ実行に失敗しました(get_therapist_name_by_therapist_id)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	$name = $row["name_site"];

	return $name;
	exit();

}

function check_skill_exist($value,$skill){

	$skill_num = count($skill);

	for($i=0;$i<$skill_num;$i++){

		if($value==$skill[$i]){

			return true;
			exit();

		}

	}

	return false;
	exit();

}

function check_exp_exist($value,$exp){

	$exp_num = count($exp);

	for($i=0;$i<$exp_num;$i++){

		if($value==$exp[$i]){

			return true;
			exit();

		}

	}

	return false;
	exit();

}

function check_lng_exist($value,$lng){

	$lng_num = count($lng);

	for($i=0;$i<$lng_num;$i++){

		if($value==$lng[$i]){

			return true;
			exit();

		}

	}

	return false;
	exit();

}

//セラピストページデータの登録
function regist_therapist_page_data($img_tmp_id,$area,$therapist_id,$age,$skill,$from,$history,$shikaku,$pr_refle,$pr_yokohama,$pr_makuhari,$pr_sapporo,$pr_new){

	//トランザクションをはじめる準備
	$sql = "set autocommit = 0";
	mysql_query( $sql, DbCon );

	//トランザクション開始
	$sql = "begin";
	mysql_query( $sql, DbCon );

	$img_url = "";
	$img_url_m = "";

	// 仮画像のデータを呼び出す
	$sql = "select img_url from therapist_page_img_tmp where id=".$img_tmp_id;
	$res = mysql_query($sql, DbCon);
	if($res == false){

		//ロールバック
		$sql = "rollback";
		mysql_query( $sql, DbCon );

		echo "クエリ実行に失敗しました(regist_therapist_page_data:1)";
		exit();

	}
	$row = mysql_fetch_array($res);
	$tmp_img_url = $row["img_url"];

	if( $tmp_img_url != "" ){

		$file_name = basename($tmp_img_url);

		$tmp_img_url_full = ROOT_PATH.$tmp_img_url;

		$tmp_img_path_m = ROOT_PATH."img/therapist_page/tmp/m/";
		$tmp_img_url_full_m = $tmp_img_path_m.$file_name;

		//echo $tmp_img_url_full_m;exit();

		//携帯用の画像(テンプ)
		$result = copy($tmp_img_url_full, $tmp_img_url_full_m);
		if( $result == false ){
			$sql = "rollback";
			mysql_query( $sql, DbCon );
			echo "クエリ実行に失敗しました(regist_therapist_page_data:1_1)";
			exit();
		}

		//携帯用の画像(テンプ)のリサイズ
		$result = writer_image_upload_resize($tmp_img_url_full_m);
		if( $result == false ){
			$sql = "rollback";
			mysql_query( $sql, DbCon );
			echo "クエリ実行に失敗しました(regist_therapist_page_data:1_2)";
			exit();
		}

		//画像を入れるフォルダを作成する

		$folder_name = ROOT_PATH."img/therapist_page/".$area;
		$folder_name_m = ROOT_PATH."img/therapist_page/".$area."/m";

		$img_url = "img/therapist_page/".$area."/".$file_name;
		$img_url_m = "img/therapist_page/".$area."/m/".$file_name;

		$path = $folder_name;
		$path_m = $folder_name_m;

		if(!(is_dir( $folder_name ))){

			umask(0);
			mkdir( $path, 0777 );

		}

		if(!(is_dir( $folder_name_m ))){

			umask(0);
			mkdir( $path_m, 0777 );

		}

		$img_url_full = $path."/".$file_name;
		$img_url_m_full = $path_m."/".$file_name;

		$result = rename($tmp_img_url_full,$img_url_full);

		if( $result == false ){

			//ロールバック
			$sql = "rollback";
			mysql_query( $sql, DbCon );

			echo "クエリ実行に失敗しました(regist_therapist_page_data:3)";
			exit();

		}

		//携帯用の画像
		//$result = copy($img_url_full, $img_url_m_full);
		$result = rename($tmp_img_url_full_m,$img_url_m_full);

		if( $result == false ){

			//ロールバック
			$sql = "rollback";
			mysql_query( $sql, DbCon );

			echo "クエリ実行に失敗しました(regist_therapist_page_data:4)";
			exit();

		}

		/*
		$result = writer_image_upload_resize($img_url_m_full);
		if( $result == false ){
			$sql = "rollback";
			mysql_query( $sql, DbCon );
			echo "クエリ実行に失敗しました(regist_therapist_page_data:5)";
			exit();
		}
		*/

	}

	$skill_string = implode(",",$skill);

	$sql = sprintf("insert into therapist_page(
area,therapist_id,age,img_url,img_url_m,skill,hometown,history,shikaku,pr_refle,pr_yokohama,pr_makuhari,pr_sapporo,pr_new)
values('%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s')",
$area,$therapist_id,$age,$img_url,$img_url_m,$skill_string,$from,$history,$shikaku,$pr_refle,$pr_yokohama,$pr_makuhari,$pr_sapporo,$pr_new);

	$res = mysql_query($sql, DbCon);
	if($res == false){

		//ロールバック
		$sql = "rollback";
		mysql_query( $sql, DbCon );

		echo "クエリ実行に失敗しました(regist_therapist_page_data:6)";
		exit();

	}

	//コミット
	$sql = "commit";
	mysql_query( $sql, DbCon );

	return true;
	exit();
}

//セラピストデータのアップデート
function update_therapist_page_data($therapist_page_id,$img_tmp_id,$area,$therapist_id,$age,$skill,$from,$history,$shikaku,$pr_refle,$pr_yokohama,$pr_makuhari,$pr_sapporo,$pr_new){

	//トランザクションをはじめる準備
	$sql = "set autocommit = 0";
	mysql_query( $sql, DbCon );

	//トランザクション開始
	$sql = "begin";
	mysql_query( $sql, DbCon );

	$img_url = "";
	$img_url_m = "";

	// 仮画像のデータを呼び出す
	$sql = "select img_url from therapist_page_img_tmp where id=".$img_tmp_id;
	$res = mysql_query($sql, DbCon);
	if($res == false){

		//ロールバック
		$sql = "rollback";
		mysql_query( $sql, DbCon );

		echo "クエリ実行に失敗しました(update_therapist_page_data:1)";
		exit();

	}
	$row = mysql_fetch_array($res);
	$tmp_img_url = $row["img_url"];

	if( $tmp_img_url != "" ){

		$file_name = basename($tmp_img_url);

		$tmp_img_url_full = ROOT_PATH.$tmp_img_url;

		$tmp_img_path_m = ROOT_PATH."img/therapist_page/tmp/m/";
		$tmp_img_url_full_m = $tmp_img_path_m.$file_name;

		//携帯用の画像(テンプ)
		$result = copy($tmp_img_url_full, $tmp_img_url_full_m);
		if( $result == false ){
			$sql = "rollback";
			mysql_query( $sql, DbCon );
			echo "クエリ実行に失敗しました(update_therapist_page_data:1_1)";
			exit();
		}

		//携帯用の画像(テンプ)のリサイズ
		$result = writer_image_upload_resize($tmp_img_url_full_m);
		if( $result == false ){
			$sql = "rollback";
			mysql_query( $sql, DbCon );
			echo "クエリ実行に失敗しました(update_therapist_page_data:1_2)";
			exit();
		}

		//画像を入れるフォルダを作成する

		if( $area == "tokyo" ){

			$folder_name = ROOT_PATH."img/therapist_page/tokyo";
			$folder_name_m = ROOT_PATH."img/therapist_page/tokyo/m";

			$img_url = "img/therapist_page/tokyo/".$file_name;
			$img_url_m = "img/therapist_page/tokyo/m/".$file_name;

		}else if( $area == "sapporo" ){

			$folder_name = ROOT_PATH."img/therapist_page/sapporo";
			$folder_name_m = ROOT_PATH."img/therapist_page/sapporo/m";

			$img_url = "img/therapist_page/sapporo/".$file_name;
			$img_url_m = "img/therapist_page/sapporo/m/".$file_name;

		}else{

			$folder_name = ROOT_PATH."img/therapist_page/".$area;
			$folder_name_m = ROOT_PATH."img/therapist_page/".$area."/m";

			$img_url = "img/therapist_page/".$area."/".$file_name;
			$img_url_m = "img/therapist_page/".$area."/m/".$file_name;

		}

		$path = $folder_name;
		$path_m = $folder_name_m;

		if(!(is_dir( $folder_name ))){

			umask(0);
			mkdir( $path, 0777 );

		}

		if(!(is_dir( $folder_name_m ))){

			umask(0);
			mkdir( $path_m, 0777 );

		}

		$img_url_full = $path."/".$file_name;
		$img_url_m_full = $path_m."/".$file_name;

		$result = rename($tmp_img_url_full,$img_url_full);

		if( $result == false ){

			//ロールバック
			$sql = "rollback";
			mysql_query( $sql, DbCon );

			echo "クエリ実行に失敗しました(update_therapist_page_data:3)";
			exit();

		}

		//携帯用の画像
		//$result = copy($img_url_full, $img_url_m_full);
		$result = rename($tmp_img_url_full_m,$img_url_m_full);

		if( $result == false ){

			//ロールバック
			$sql = "rollback";
			mysql_query( $sql, DbCon );

			echo "クエリ実行に失敗しました(update_therapist_page_data:4)";
			exit();

		}

		/*
		$result = writer_image_upload_resize($img_url_m_full);
		if( $result == false ){
			$sql = "rollback";
			mysql_query( $sql, DbCon );
			echo "クエリ実行に失敗しました(update_therapist_page_data:5)";
			exit();
		}
		*/

	}

	$skill_string = implode(",",$skill);

	$sql = sprintf("update therapist_page
set area='%s',therapist_id='%s',age='%s',img_url='%s',img_url_m='%s',skill='%s',hometown='%s',
history='%s',shikaku='%s',pr_refle='%s',pr_yokohama='%s',pr_makuhari='%s',pr_sapporo='%s',pr_new='%s'
where id='%s'",
$area,$therapist_id,$age,$img_url,$img_url_m,$skill_string,$from,$history,$shikaku,$pr_refle,$pr_yokohama,$pr_makuhari,$pr_sapporo,$pr_new,$therapist_page_id);

	//echo $sql;
	//exit();

	$res = mysql_query($sql, DbCon);
	if($res == false){

		//ロールバック
		$sql = "rollback";
		mysql_query( $sql, DbCon );

		echo "クエリ実行に失敗しました(update_therapist_page_data:6)";
		exit();

	}

	//コミット
	$sql = "commit";
	mysql_query( $sql, DbCon );

	return true;
	exit();
}

//画像のリサイズ
function writer_image_upload_resize($image_path){

	// 画像の情報を取得

	$size = getimagesize($image_path);

	/*
	echo "<pre>";
	print_r($size);
	echo "</pre>";
	exit();
	*/

	// ファイルから画像の作成。画像のタイプによって関数を使い分ける

	switch($size[2]) {

		case IMAGETYPE_GIF:
			$image = imagecreatefromgif($image_path);
			break;
		case IMAGETYPE_JPEG:
			$image = imagecreatefromjpeg($image_path);
			break;
		case IMAGETYPE_PNG:
			$image = imagecreatefrompng($image_path);
			break;
		default:
			return false;
			exit();

	}

	// 指定したサイズ以上のものを縮小

	$width = $size[0];
	$height = $size[1];

	if( $width > $height ){

		$hiritsu = $width / 100;

	}else{

		$hiritsu = $height / 100;

	}

	$new_width = floor($width / $hiritsu);
	$new_height = floor($height / $hiritsu);

	/*
	 echo $new_width;
	echo "<br />";
	echo $new_height;
	echo "<br />";
	exit();
	*/

	// 新規画像の作成

	$new_image = imagecreatetruecolor($new_width, $new_height);

	if( $new_image == false ){

		return false;
		exit();

	}

	if($size[2]==IMAGETYPE_PNG){

		//--背景が黒くなるので追加
		ImageAlphaBlending($new_image, false);
		ImageSaveAlpha($new_image, true);
		$fillcolor = imagecolorallocatealpha($new_image, 0, 0, 0, 127);
		imagefill($new_image, 0, 0, $fillcolor);
		//背景が黒くなるので追加--

	}

	// リサンプル
	$result = imagecopyresampled($new_image, $image, 0, 0, 0, 0, $new_width, $new_height, $size[0], $size[1]);

	if( $result == false ){

		return false;
		exit();

	}

	/*
	 header('Content-Type: image/png');
	ImagePNG($new_image);
	exit();
	*/

	$new_fname = $image_path;

	switch($size[2]) {

		case IMAGETYPE_GIF:

			$result = imagegif($new_image, $new_fname);
			break;

		case IMAGETYPE_JPEG:

			//画質、最低：0、最高：100、デフォルト:75
			$quality = 75;

			$result = imagejpeg($new_image, $new_fname, $quality);
			break;

		case IMAGETYPE_PNG:

			//圧縮レベル。0 (圧縮しない) から 9 までの値です。
			$quality = 1;

			$result = imagepng($new_image, $new_fname, $quality);
			break;

		default:
			return false;
			exit();

	}

	if( $result == false ){

		return false;
		exit();

	}

	return true;
	exit();

}

function get_therapist_page_data_1($area){

	$sql = sprintf("
select
therapist_page.id,
therapist_page.therapist_id,
therapist_page.area,
therapist_page.skill,
therapist_page.order_value,
therapist_page.exp,
therapist_page.lng
from therapist_page
left join therapist_new on therapist_new.id=therapist_page.therapist_id
where
therapist_page.delete_flg=0 and
therapist_new.leave_flg=0 and
therapist_new.delete_flg=0 and
therapist_page.area='%s'
order by therapist_page.order_value desc",
$area);

	$res = mysql_query($sql, DbCon);
	if($res == false){

		echo "クエリー実行で失敗しました(get_therapist_page_data)";
		exit();

	}
	$i=0;
	$list_data = array();
	while($row = mysql_fetch_assoc($res)){

		$list_data[$i] = $row;
		$i++;

	}

	if($area=="yokohama"){

		$kenmu = $area;
		$staff_area = "tokyo";

		$where_kenmu = "kenmu like '%".$kenmu."%'";

		$sql = sprintf("
select therapist_page.id,therapist_page.therapist_id,therapist_page.order_value from therapist_page
left join therapist_new on therapist_new.id=therapist_page.therapist_id
where
therapist_page.delete_flg=0 and
therapist_new.leave_flg=0 and
therapist_new.delete_flg=0 and (%s) and
therapist_page.area='%s'
order by therapist_page.order_value desc",
$where_kenmu,$staff_area);

		$res = mysql_query($sql, DbCon);

		if($res == false){

			echo "クエリー実行で失敗しました(get_therapist_page_data)";
			exit();

		}
		while($row = mysql_fetch_assoc($res)){

			$list_data[$i] = $row;

			$list_data[$i]["area"] = $staff_area;

			$i++;
		}

		//order_value並べ替えの処理
		$list_data = order_value_sort($list_data);

	}

	return $list_data;
	exit();

}

function get_therapist_page_data_2($area){

	$sql = sprintf("
select
therapist_page.id,
therapist_page.therapist_id,
therapist_page.area,
therapist_page.skill,
therapist_page.order_value,
therapist_page.exp,
therapist_page.lng
from therapist_page
left join therapist_new on therapist_new.id=therapist_page.therapist_id
where
therapist_page.delete_flg=0 and
therapist_new.leave_flg=0 and
therapist_new.delete_flg=0 and
therapist_page.area='%s'
order by therapist_page.area,wait_select desc,rank=4 desc,rank,order_num desc,therapist_new.id desc",

$area);
//echo $sql;
	$res = mysql_query($sql, DbCon);
	if($res == false){

		echo "クエリー実行で失敗しました(get_therapist_page_data)";
		exit();

	}
	$i=0;
	$list_data = array();
	while($row = mysql_fetch_assoc($res)){

		$list_data[$i] = $row;
		$i++;

	}
/*
	if($area=="yokohama"){

		$kenmu = $area;
		$staff_area = "tokyo";

		$where_kenmu = "kenmu like '%".$kenmu."%'";

		$sql = sprintf("
select therapist_page.id,therapist_page.therapist_id,therapist_page.order_value from therapist_page
left join therapist_new on therapist_new.id=therapist_page.therapist_id
where
therapist_page.delete_flg=0 and
therapist_new.leave_flg=0 and
therapist_new.delete_flg=0 and (%s) and
therapist_page.area='%s'
order by therapist_page.area,wait_select desc,rank=4 desc,rank,order_num desc",
$where_kenmu,$staff_area);

		$res = mysql_query($sql, DbCon);

		if($res == false){

			echo "クエリー実行で失敗しました(get_therapist_page_data)";
			exit();

		}
		while($row = mysql_fetch_assoc($res)){

			$list_data[$i] = $row;

			$list_data[$i]["area"] = $staff_area;

			$i++;
		}

		//order_value並べ替えの処理
		//$list_data = order_value_sort($list_data);

	}
*/
	return $list_data;
	exit();

}

//セラピストページの削除
function delete_therapist_page($therapist_page_id){

	$sql = sprintf("update therapist_page set delete_flg='1' where id='%s'",$therapist_page_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(delete_therapist_page)";
		exit();
	}

	return true;
	exit();

}

//表示優先度の更新
function update_therapist_page_order_value($therapist_page_id,$order_value){

	$sql = sprintf("update therapist_page set order_value='%s' where id='%s'",$order_value,$therapist_page_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(update_therapist_page_order_value)";
		exit();
	}

	return true;
	exit();
}

function get_therapist_page_detail_data($therapist_page_id){

	$sql = sprintf("select * from therapist_page where id='%s'",$therapist_page_id);

	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(get_therapist_page_detail_data)";
		exit();
	}
	$row = mysql_fetch_assoc($res);

	return $row;
	exit();
}

//オートログインをセット
function set_auto_login($manager_id){

	$cookie_value = md5(time()."-".$manager_id);

	$sql = sprintf("update manager set cookie_value='%s' where id='%s'",$cookie_value,$manager_id);
	$res = mysql_query($sql, DbCon);

	if($res == false){
		echo "クエリー実行で失敗しました(set_auto_login)";
		exit();
	}else{

		setcookie ("RefleAutoLogin", $cookie_value, time()+(60*60*24*30)); // 有効期限30日

		return true;
		exit();

	}
}

//オートログインをチェック
function check_auto_login(){

	if(isset($_COOKIE["RefleAutoLogin"])==true){

		$auto_login_key = $_COOKIE["RefleAutoLogin"];

		$sql = "select * from manager where cookie_value='".$auto_login_key."'";

		$res = mysql_query($sql, DbCon);

		if($res == false){

			echo "クエリー実行で失敗しました(check_auto_login)";
			exit();

		}

		$data_num = mysql_num_rows($res);

		if($data_num > 0){

			$row = mysql_fetch_array($res);

			$login_staff_type = $row["type"];
			$staff_name_man = $row["name"];
			$manager_id = $row["id"];

			$_SESSION["staff_name_man"] = $staff_name_man;
			$_SESSION["login_staff_type"] = $login_staff_type;
			$_SESSION["ticket_man"] = md5(TICKET_WORD.$staff_name_man);

			set_auto_login($manager_id);

			return true;
			exit();

		}else{

			return false;
			exit();

		}

	}else{

		return false;
		exit();

	}

}

//コメント削除
function delete_hotel_search_detail_comment($comment_id,$hotel_deri_id,$type){

	//トランザクションをはじめる準備
	$sql = "set autocommit = 0";
	mysql_query( $sql, DbCon );

	//トランザクション開始
	$sql = "begin";
	mysql_query( $sql, DbCon );

	$sql = sprintf("update comment_deri set delete_flg='1' where id='%s'",$comment_id);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		//ロールバック
		$sql = "rollback";
		mysql_query( $sql, DbCon );

		echo "クエリー実行で失敗しました(delete_hotel_search_detail_comment)";
		exit();

	}

	$yoberu_flg = false;
	$yobenai_flg = false;

	if( $type == "呼べる" ){

		$yoberu_flg = true;

	}else if( $type == "呼べない" ){

		$yobenai_flg = true;

	}

	//カウントダウン処理

	//呼べると呼べないの数を取得(hotel_deri_idから)
	$data_tmp = get_yoberu_and_yobenai_num_by_hotel_deri_id($hotel_deri_id);

	if( $data_tmp == false ){

		//ロールバック
		$sql = "rollback";
		mysql_query( $sql, DbCon );

		echo "クエリー実行で失敗しました(delete_hotel_search_detail_comment)";
		exit();

	}

	$yoberu_num = $data_tmp["yoberu"];
	$yobenai_num = $data_tmp["yobenai"];

	if( ( $yoberu_flg == true ) || ( $yobenai_flg == true ) ){

		if( $yoberu_flg == true ){

			$yoberu_num--;

			$sql = sprintf("update hotel_deri set yoberu='%s' where id='%s'",$yoberu_num,$hotel_deri_id);

		}else if( $yobenai_flg == true ){

			$yobenai_num--;

			$sql = sprintf("update hotel_deri set yobenai='%s' where id='%s'",$yobenai_num,$hotel_deri_id);

		}else{

			//ロールバック
			$sql = "rollback";
			mysql_query( $sql, DbCon );

			echo "クエリー実行で失敗しました(delete_hotel_search_detail_comment)";
			exit();

		}

		$res = mysql_query($sql, DbCon);

		if($res == false){

			//ロールバック
			$sql = "rollback";
			mysql_query( $sql, DbCon );

			echo "クエリー実行で失敗しました(delete_hotel_search_detail_comment)";
			exit();

		}

	}

	//コミット
	$sql = "commit";
	mysql_query( $sql, DbCon );

	return true;
	exit();
}

function get_hote_name_by_hotel_deri_id($hotel_deri_id){

	$sql = sprintf("select name from hotel_deri where id='%s'",$hotel_deri_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(get_hote_name_by_hotel_deri_id)";
		exit();
	}
	$row = mysql_fetch_assoc($res);

	return $row["name"];
	exit();

}

function get_comment_data_by_comment_id($comment_id){

	$sql = sprintf("select * from comment_deri where id='%s'",$comment_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(get_comment_data_by_comment_id)";
		exit();
	}
	$row = mysql_fetch_assoc($res);

	return $row;
	exit();
}

//コメントのアップデート
function update_hotel_search_comment_data($comment_id,$nickname,$hyouka,$hyouka_content,$hyouka_start,$hotel_deri_id){

	//トランザクションをはじめる準備
	$sql = "set autocommit = 0";
	mysql_query( $sql, DbCon );

	//トランザクション開始
	$sql = "begin";
	mysql_query( $sql, DbCon );

	//評価に変更があった場合
	if($hyouka != $hyouka_start){

		$yoberu_up_flg = false;
		$yoberu_down_flg = false;
		$yobenai_up_flg = false;
		$yobenai_down_flg = false;

		if( $hyouka_start == "1" ){

			if( $hyouka == "2" ){

				//「呼べる」から「呼べない」
				$yoberu_down_flg = true;
				$yobenai_up_flg = true;

			}else if( $hyouka == "3" ){

				//「呼べる」から「雑談」
				$yoberu_down_flg = true;

			}else{

				//ロールバック
				$sql = "rollback";
				mysql_query( $sql, DbCon );

				echo "クエリー実行で失敗しました(update_hotel_search_comment_data:1)";
				exit();

			}

		}else if( $hyouka_start == "2" ){

			if( $hyouka == "1" ){

				//「呼べない」から「呼べる」
				$yoberu_up_flg = true;
				$yobenai_down_flg = true;

			}else if( $hyouka == "3" ){

				//「呼べない」から「雑談」
				$yobenai_down_flg = true;

			}else{

				//ロールバック
				$sql = "rollback";
				mysql_query( $sql, DbCon );

				echo "クエリー実行で失敗しました(update_hotel_search_comment_data:2)";
				exit();

			}

		}else if( $hyouka_start == "3" ){

			if( $hyouka == "1" ){

				//「雑談」から「呼べる」
				$yoberu_up_flg = true;

			}else if( $hyouka == "2" ){

				//「雑談」から「呼べない」
				$yobenai_up_flg = true;

			}else{

				//ロールバック
				$sql = "rollback";
				mysql_query( $sql, DbCon );

				echo "クエリー実行で失敗しました(update_hotel_search_comment_data:3)";
				exit();

			}

		}else{

			//ロールバック
			$sql = "rollback";
			mysql_query( $sql, DbCon );

			echo "クエリー実行で失敗しました(update_hotel_search_comment_data:4)";
			exit();

		}

		//呼べると呼べないの数を取得(hotel_deri_idから)
		$data_tmp = get_yoberu_and_yobenai_num_by_hotel_deri_id($hotel_deri_id);

		if( $data_tmp == false ){

			//ロールバック
			$sql = "rollback";
			mysql_query( $sql, DbCon );

			echo "クエリー実行で失敗しました(update_hotel_search_comment_data:5)";
			exit();

		}

		$yoberu_num = $data_tmp["yoberu"];
		$yobenai_num = $data_tmp["yobenai"];

		$yoberu_num_new = $yoberu_num;
		$yobenai_num_new = $yobenai_num;

		if( $yoberu_up_flg == true ){

			$yoberu_num_new = $yoberu_num + 1;

		}

		if( $yoberu_down_flg == true ){

			$yoberu_num_new = $yoberu_num - 1;

		}

		if( $yobenai_up_flg == true ){

			$yobenai_num_new = $yobenai_num + 1;

		}

		if( $yobenai_down_flg == true ){

			$yobenai_num_new = $yobenai_num - 1;

		}

		$sql = sprintf("update hotel_deri set yoberu='%s',yobenai='%s' where id='%s'",$yoberu_num_new,$yobenai_num_new,$hotel_deri_id);

		//echo $sql;
		//exit();

		$res = mysql_query($sql, DbCon);

		if($res == false){

			//ロールバック
			$sql = "rollback";
			mysql_query( $sql, DbCon );

			echo "クエリー実行で失敗しました(update_hotel_search_comment_data:6)";
			exit();

		}

	}

	$type = "";

	if($hyouka=="1"){

		$type = "呼べる";

	}else if($hyouka=="2"){

		$type = "呼べない";

	}else if($hyouka=="3"){

		$type = "雑談";

	}else{

		//ロールバック
		$sql = "rollback";
		mysql_query( $sql, DbCon );

		echo "クエリー実行で失敗しました(update_hotel_search_comment_data:7)";
		exit();

	}

	$sql = sprintf("update comment_deri set type='%s',nickname='%s',content='%s' where id='%s'",
					$type,$nickname,$hyouka_content,$comment_id);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		//ロールバック
		$sql = "rollback";
		mysql_query( $sql, DbCon );

		echo "クエリー実行で失敗しました(update_hotel_search_comment_data:8)";
		exit();

	}

	//コミット
	$sql = "commit";
	mysql_query( $sql, DbCon );

	return true;
	exit();
}

//ホテルの登録
function regist_hotel_search_hotel_data($area1_id,$area2_id,$hotel_type,$hotel_name,$hotel_address,$hotel_tel,$hotel_price,$hotel_hp){

	//hotel_deriのhotel_idのmax値を取得
	$max_hotel_id = get_hotel_deri_max_hotel_id();

	$hotel_id = $max_hotel_id + 1;

	$sql = sprintf("insert into hotel_deri(area1_id,area2_id,hotel_id,category,name,address,tel,price,hp)
values('%s','%s','%s','%s','%s','%s','%s','%s','%s')",
$area1_id,$area2_id,$hotel_id,$hotel_type,$hotel_name,$hotel_address,$hotel_tel,$hotel_price,$hotel_hp);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(regist_hotel_search_hotel_data)";
		exit();
	}

	return true;
	exit();

}

//hotel_deriのhotel_idのmax値を取得
function get_hotel_deri_max_hotel_id(){

	$sql = "select max(hotel_id) as max_hotel_id from hotel_deri";
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(get_hotel_deri_max_hotel_id)";
		exit();
	}
	$row = mysql_fetch_assoc($res);

	return $row["max_hotel_id"];
	exit();
}

//ホテルデータ削除
function delete_hotel_search_list_hotel_data($hotel_deri_id){

	$sql = sprintf("update hotel_deri set delete_flg='1' where id='%s'",$hotel_deri_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(delete_hotel_search_list_hotel_data)";
		exit();
	}

	return true;
	exit();
}

//ホテルの編集
function update_hotel_search_hotel_data($hotel_deri_id,$hotel_type,$hotel_name,$hotel_address,$hotel_tel,$hotel_price,$hotel_hp){

	$sql = sprintf("update hotel_deri set category='%s',name='%s',address='%s',tel='%s',price='%s',hp='%s' where id='%s'",
	$hotel_type,$hotel_name,$hotel_address,$hotel_tel,$hotel_price,$hotel_hp,$hotel_deri_id);

	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(update_hotel_search_hotel_data)";
		exit();
	}

	return true;
	exit();
}

//スタッフデータ登録(page_typeは1:本部メンバー,2:ドライバー)
function regist_staff_data_refle($name,$mail,$tel,$page_type,$kenmu,$not_num_flg){

	$kenmu_string = get_kenmu_string($kenmu);

	$sql = sprintf("insert into staff_new(type,name,mail,tel,kenmu,not_num_flg) values('%s','%s','%s','%s','%s','%s')",
					$page_type,$name,$mail,$tel,$kenmu_string,$not_num_flg);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリー実行で失敗しました(regist_staff_data_refle)";
		exit();

	}else{

		return true;
		exit();

	}
}

//スタッフデータ登録(page_typeは1:本部メンバー,2:ドライバー)(札幌)
function regist_staff_data_sapporo($name,$mail,$tel,$page_type){

	$sql = sprintf("insert into staff_new_sapporo(type,name,mail,tel) values('%s','%s','%s','%s')",
	$page_type,$name,$mail,$tel);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリー実行で失敗しました(regist_staff_data_sapporo)";
		exit();

	}else{

		return true;
		exit();

	}

}

//スタッフIDからスタッフデータを取得
function get_staff_info_by_staff_id($staff_id,$type){

	$sql = sprintf("select * from staff_new where id='%s' and type='%s'",$staff_id,$type);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリ実行に失敗しました(get_staff_info_by_staff_id)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();

}

//スタッフIDからスタッフデータを取得(札幌)
function get_staff_info_by_staff_id_sapporo($staff_id,$type){

	$sql = sprintf("select * from staff_new_sapporo where id='%s' and type='%s'",$staff_id,$type);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリ実行に失敗しました(get_staff_info_by_staff_id_sapporo)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();

}

//スタッフ情報更新
function update_staff_data_refle($staff_id,$name,$mail,$tel,$kenmu,$not_num_flg){

	$kenmu_string = get_kenmu_string($kenmu);

	// 会員情報を更新するSQL文
	$sql = sprintf("update staff_new set name='%s',mail='%s',tel='%s',kenmu='%s',not_num_flg='%s' where id='%s'",
	$name,$mail,$tel,$kenmu_string,$not_num_flg,$staff_id);

	//echo $sql;
	//exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリ実行に失敗しました(update_staff_data_refle)";
		exit();

	}

	return true;
	exit();

}

//スタッフ情報更新(札幌)
function update_staff_data_sapporo($staff_id,$name,$mail,$tel){

	// 会員情報を更新するSQL文
	$sql = sprintf("update staff_new_sapporo set name='%s',mail='%s',tel='%s' where id='%s'",
	$name,$mail,$tel,$staff_id);

	//echo $sql;
	//exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリ実行に失敗しました(update_staff_data_sapporo)";
		exit();

	}

	return true;
	exit();

}

function get_time_ja_hour($time){

	//include(MAN_INC."time_array.php");
	global $time_array;

	$hour = $time_array[$time]["hour"];

	return $hour;
	exit();

}

function get_time_ja_minute($time){

	//include(MAN_INC."time_array.php");
	global $time_array;

	$minute = $time_array[$time]["minute"];

	if( $minute == "0" ){

		$minute = "0".$minute;

	}

	return $minute;
	exit();

}

//出勤情報を登録
function regist_attendance_data_therapist($therapist_id,$day_year,$day_month,$day_day,$day_week,$start_time,$end_time,$charge_area,$therapist_area,$comment){

	$area = "tokyo";
	$therapist_name = get_therapist_name_by_therapist_id_honmyou($therapist_id, $area);

	$week_name = get_week_name($day_week);

	$start_time_hour = get_time_ja_hour($start_time);
	$start_time_minute = get_time_ja_minute($start_time);

	$end_time_hour = get_time_ja_hour($end_time);
	$end_time_minute = get_time_ja_minute($end_time);

	//トランザクションをはじめる準備
	$sql = "set autocommit = 0";
	mysql_query( $sql, DbCon );

	//トランザクション開始
	$sql = "begin";
	mysql_query( $sql, DbCon );

	if( $therapist_area == "yokohama" ){

		// 出勤情報を登録するSQL文
		$sql = sprintf("
insert into attendance_new(therapist_id,year,month,day,week,start_time,end_time,area)
values('%s','%s','%s','%s','%s','%s','%s','%s')",
$therapist_id,$day_year,$day_month,$day_day,$day_week,$start_time,$end_time,$therapist_area);

	}else{

		$syounin_state = "1";

		// 出勤情報を登録するSQL文
		$sql = sprintf("
insert into attendance(therapist_id,year,month,day,week,start_time,end_time,charge_area,comment,syounin_state)
values('%s','%s','%s','%s','%s','%s','%s','%s','%s','%s')",
$therapist_id,$day_year,$day_month,$day_day,$day_week,$start_time,$end_time,$charge_area,$comment,$syounin_state);

	}
	$res = mysql_query($sql, DbCon);
	if($res == false){

		//ロールバック
		$sql = "rollback";
		mysql_query( $sql, DbCon );

		echo "クエリ実行に失敗しました(regist_attendance_data_therapist:1)";
		exit();
	}

	$insert_id = mysql_insert_id();

	mb_language("ja");
	mb_internal_encoding("UTF-8");
	$mailto = "minamikawa@neo-gate.jp";
	$title = "出勤日のお知らせ";
	$content =<<<EOT
{$therapist_name}さん

以下の出勤日を登録しました。
{$day_month}月{$day_day}日({$week_name})　{$start_time_hour}:{$start_time_minute}～{$end_time_hour}:{$end_time_minute}
その他出勤日は以下のＵＲＬからご確認ください。

(該当者のシフトチェック画面URL)
EOT;

	$header = "From: minamikawa@neo-gate.jp\n";
	//$header .= "Bcc: minamikawa@neo-gate.jp";

	$result = mb_send_mail($mailto,$title,$content,$header,MAIL_PARAMETER);

	if($result==false){

		//ロールバック
		$sql = "rollback";
		mysql_query( $sql, DbCon );

		echo "クエリ実行に失敗しました(regist_attendance_data_therapist:2)";
		exit();

	}

	//コミット
	$sql = "commit";
	mysql_query( $sql, DbCon );

	return $insert_id;
	exit();
}

//出勤情報を登録(札幌)
function regist_attendance_data_therapist_sapporo($therapist_id,$day_year,$day_month,$day_day,$day_week,$start_time,$end_time){

	// 出勤情報を登録するSQL文
	$sql = sprintf("insert into attendance_sapporo(therapist_id,year,month,day,week,start_time,end_time)
			values('%s','%s','%s','%s','%s','%s','%s')",
			$therapist_id,$day_year,$day_month,$day_day,$day_week,$start_time,$end_time);

	//echo $sql;
	//exit();

	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリ実行に失敗しました(regist_attendance_data_therapist_sapporo)";
		exit();
	}

	$insert_id = mysql_insert_id();

	return $insert_id;
	exit();

}

//出勤情報を登録(スタッフ)
function regist_attendance_data_staff($staff_id,$staff_type,$day_year,$day_month,$day_day,$day_week,$start_time,$end_time,$charge_area){

	if( $charge_area == "" ){

		$charge_area = "-1";

	}

	// 出勤情報を登録するSQL文
	$sql = sprintf("
insert into attendance_staff(staff_id,staff_type,year,month,day,week,start_time,end_time,charge_area)
values('%s','%s','%s','%s','%s','%s','%s','%s','%s')",
$staff_id,$staff_type,$day_year,$day_month,$day_day,$day_week,$start_time,$end_time,$charge_area);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリ実行に失敗しました(regist_attendance_data_staff)";
		exit();
	}

	$insert_id = mysql_insert_id();

	return $insert_id;
	exit();

}

//出勤情報を登録(スタッフ)(札幌)
function regist_attendance_data_staff_sapporo($staff_id,$staff_type,$day_year,$day_month,$day_day,$day_week,$start_time,$end_time,$charge_area){

	if( $charge_area == "" ){

		$charge_area = "-1";

	}

	// 出勤情報を登録するSQL文
	$sql = sprintf("
insert into attendance_staff_sapporo(staff_id,staff_type,year,month,day,week,start_time,end_time,charge_area)
values('%s','%s','%s','%s','%s','%s','%s','%s','%s')",
	$staff_id,$staff_type,$day_year,$day_month,$day_day,$day_week,$start_time,$end_time,$charge_area);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリ実行に失敗しました(regist_attendance_data_staff_sapporo)";
		exit();
	}

	$insert_id = mysql_insert_id();

	return $insert_id;
	exit();

}


//出席データの取得
function get_attendance_data_by_attendance_id($attendance_id,$therapist_area){

	if( $therapist_area == "yokohama" ){

		$sql = sprintf("
select
therapist_new.id as therapist_id,therapist_new.name_site,attendance_new.start_time,
attendance_new.end_time,attendance_new.year,
attendance_new.month,attendance_new.day,attendance_new.week,
attendance_new.today_absence,attendance_new.attendance_adjustment
from attendance_new
left join therapist_new on therapist_new.id=attendance_new.therapist_id
where attendance_new.id='%s'",
$attendance_id);

	}else{

		$sql = sprintf("
select
therapist.id as therapist_id,therapist.name_refle,attendance.start_time,attendance.end_time,attendance.year,
attendance.month,attendance.day,attendance.week,attendance.charge_area,
attendance.today_absence,attendance.attendance_adjustment
from attendance
left join therapist on therapist.id=attendance.therapist_id
where attendance.id='%s'",
$attendance_id);

	}

	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリ実行に失敗しました(get_attendance_data_by_attendance_id)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();

}

//出席データの取得(スタッフ)
function get_attendance_data_by_attendance_id_staff($attendance_id){

	$sql = sprintf("
select staff_new.id as staff_id,staff_new.name,attendance_staff.start_time,attendance_staff.end_time,attendance_staff.year,
attendance_staff.month,attendance_staff.day,attendance_staff.week,attendance_staff.charge_area,
attendance_staff.today_absence,attendance_staff.attendance_adjustment,attendance_staff.staff_type
from attendance_staff
left join staff_new on staff_new.id=attendance_staff.staff_id
where attendance_staff.id='%s'",
	$attendance_id);

	//echo $sql;
	//exit();

	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリ実行に失敗しました(get_attendance_data_by_attendance_id_staff)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();

}

//出席データの取得(スタッフ)(札幌)
function get_attendance_data_by_attendance_id_staff_sapporo($attendance_id){

	$sql = sprintf("
select staff_new_sapporo.id as staff_id,staff_new_sapporo.name,attendance_staff_sapporo.start_time,attendance_staff_sapporo.end_time,attendance_staff_sapporo.year,
attendance_staff_sapporo.month,attendance_staff_sapporo.day,attendance_staff_sapporo.week,attendance_staff_sapporo.charge_area,
attendance_staff_sapporo.today_absence,attendance_staff_sapporo.attendance_adjustment,attendance_staff_sapporo.staff_type
from attendance_staff_sapporo
left join staff_new_sapporo on staff_new_sapporo.id=attendance_staff_sapporo.staff_id
where attendance_staff_sapporo.id='%s'",
$attendance_id);

	//echo $sql;
	//exit();

	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリ実行に失敗しました(get_attendance_data_by_attendance_id_staff_sapporo)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();

}

function get_week_name($week){
	return get_week_name_common($week);		//曜日取得
}

function get_charge_area_name($charge_area){

	$data = "";

	if($charge_area=="1"){

		$data = "東京";

	}else if($charge_area=="2"){

		$data = "横浜";

	}else if($charge_area=="3"){

		$data = "幕張";

	}else{

		$data = "不明";

	}

	return $data;
	exit();

}

//今月の日にちデータ取得
function get_this_month_data($day_array,$month,$day){

	$this_month = $day_array[0]["month"];

	$day_array_num = count($day_array);

	$data = array();
	$j=0;

	for($i=0;$i<$day_array_num;$i++){

		if( ($this_month == $day_array[$i]["month"]) && !( ($month == $day_array[$i]["month"]) && ($day == $day_array[$i]["day"]) ) ){

			$data[$j] = $day_array[$i];
			$j++;

		}

	}

	return $data;
	exit();

}

//出勤データのコピー
function copy_attendance_data_therapist($attendance_id,$year,$month,$day,$week,$area){

	//出勤データIDからセラピストIDを取得
	$therapist_id = get_therapist_id_by_attendance_id($attendance_id,$area);

	//出勤データが登録済みかどうか(登録済み:attendance_id,未登録:false)
	$check_result = check_therapist_attendance_exist_2($therapist_id, $year, $month, $day,$area);

	if( $check_result == "-1" ){

		return false;
		exit();

	}

	//出席データの取得
	$data = get_attendance_data_by_attendance_id_2($attendance_id,$area);

	if( $data == false ){

		return false;
		exit();

	}

	/*
	echo "<pre>";
	print_r($data);
	echo "</pre>";
	exit();
	*/

	$therapist_id = $data["therapist_id"];
	$start_time = $data["start_time"];
	$end_time = $data["end_time"];
	$charge_area = $data["charge_area"];

	if( $check_result == false ){

		//インサートのsql
		$sql = sprintf("
insert into attendance(therapist_id,year,month,day,week,start_time,end_time,charge_area)
values('%s','%s','%s','%s','%s','%s','%s','%s')",
$therapist_id,$year,$month,$day,$week,$start_time,$end_time,$charge_area);

		//echo $sql;
		//exit();

	}else{

		$attendance_id = $check_result;

		//更新のsql
		$sql = sprintf("
update attendance set year='%s',month='%s',day='%s',week='%s',start_time='%s',end_time='%s',charge_area='%s' where id='%s'",
$year,$month,$day,$week,$start_time,$end_time,$charge_area,$attendance_id);

		//echo $sql;
		//exit();

	}

	$res = mysql_query($sql, DbCon);
	if($res == false){

		return false;
		exit();

	}

	return true;
	exit();

}

//出勤データIDからセラピストIDを取得
function get_therapist_id_by_attendance_id($attendance_id){

	$sql = sprintf("select therapist_id from attendance where attendance.id='%s'",$attendance_id);

	$res = mysql_query($sql, DbCon);
	if($res == false){
		return false;
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row["therapist_id"];
	exit();

}

//出席データが登録済みであるかどうか(登録済み：attendance_id,未登録:false)
function check_therapist_attendance_exist_2($therapist_id,$day_year,$day_month,$day_day){

	$sql = sprintf("select id from attendance where therapist_id='%s' and year='%s' and month='%s' and day='%s'",
	$therapist_id,$day_year,$day_month,$day_day);

	//echo $sql;
	//exit();

	$res = mysql_query($sql, DbCon);
	if($res == false){

		return "-1";
		exit();

	}
	$num = mysql_num_rows($res);

	if( $num > 1 ){

		return "-1";
		exit();

	}else if( $num == 1 ){

		$row = mysql_fetch_assoc($res);
		return $row["id"];
		exit();

	}else{

		return false;
		exit();

	}

}

//出席データの取得
function get_attendance_data_by_attendance_id_2($attendance_id){

	$sql = sprintf("select * from attendance where attendance.id='%s'",$attendance_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		return false;
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();

}

//スタッフ情報の取得
function get_staff_data_for_attendance($staff_type,$day_year,$day_month,$day_day){

	$sql = sprintf("select * from staff_new where delete_flg='0' and type='%s'",$staff_type);

	$res = mysql_query($sql, DbCon);
	if($res == false){

		echo "クエリ実行に失敗しました(get_staff_data_for_attendance)";
		exit();

	}

	$i=0;
	$list_data = array();
	while($row = mysql_fetch_assoc($res)){

		$staff_id = $row["id"];

		//出席データが登録済みであるかどうか(登録済み：true,未登録:false)
		$result = check_staff_attendance_exist($staff_id,$day_year,$day_month,$day_day);

		if($result==false){

			$list_data[$i] = $row;
			$list_data[$i]["area"] = "tokyo";
			$i++;

		}

	}

	if( $staff_type == "2" ){

		$kenmu = "tokyo";

		$where_kenmu = "kenmu like '%".$kenmu."%'";

		$type = "driver";
		$area = "yokohama";

		$sql = sprintf("select * from staff_new_new where delete_flg='0' and type='%s' and area='%s' and (%s)",
		$type,$area,$where_kenmu);

		$res = mysql_query($sql, DbCon);
		if($res == false){

			echo "error!(get_staff_data_for_attendance)";
			exit();

		}

		while($row = mysql_fetch_assoc($res)){

			$staff_id = $row["id"];

			//出席データが登録済みであるかどうか(登録済み：true,未登録:false)
			$result = check_staff_attendance_exist_new($staff_id,$day_year,$day_month,$day_day,$area);

			if($result==false){

				$list_data[$i] = $row;
				$i++;

			}

		}

	}

	return $list_data;
	exit();

}

//スタッフ情報の取得(札幌)
function get_staff_data_for_attendance_sapporo($staff_type,$day_year,$day_month,$day_day){

	$sql = sprintf("select * from staff_new_sapporo where delete_flg='0' and type='%s'",$staff_type);

	$res = mysql_query($sql, DbCon);
	if($res == false){

		echo "クエリ実行に失敗しました(get_staff_data_for_attendance_sapporo)";
		exit();

	}

	$i=0;
	$list_data = array();
	while($row = mysql_fetch_assoc($res)){

		$staff_id = $row["id"];

		//出席データが登録済みであるかどうか(登録済み：true,未登録:false)
		$result = check_staff_attendance_exist_sapporo($staff_id,$day_year,$day_month,$day_day);

		if($result==false){

			$list_data[$i] = $row;
			$i++;

		}

	}

	return $list_data;
	exit();

}

//スタッフデータの取得
function get_staff_data_all($staff_type){

	$sql = sprintf("select * from staff_new where delete_flg='0' and type='%s' order by order_num desc",$staff_type);

	$res = mysql_query($sql, DbCon);
	if($res == false){

		echo "クエリ実行に失敗しました(get_staff_data_all)";
		exit();

	}

	$i=0;
	$list_data = array();
	while($row = mysql_fetch_assoc($res)){

		$list_data[$i] = $row;
		$list_data[$i]["area"] = "tokyo";
		$i++;

	}

	if( $staff_type == "2" ){

		$kenmu = "tokyo";
		$area = "yokohama";

		$where_kenmu = "kenmu like '%".$kenmu."%'";

		$sql = sprintf("select * from staff_new_new where delete_flg='0' and area='%s' and (%s) order by order_num desc",$area,$where_kenmu);
		$res = mysql_query($sql, DbCon);
		if($res == false){
			echo "クエリ実行に失敗しました(get_staff_data_all)";
			exit();
		}

		while($row = mysql_fetch_assoc($res)){

			$list_data[$i++] = $row;

		}

	}

	return $list_data;
	exit();

}

//スタッフデータの取得(札幌)
function get_staff_data_all_sapporo($staff_type){

	$sql = sprintf("select * from staff_new_sapporo where delete_flg='0' and type='%s' order by order_num desc",$staff_type);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリ実行に失敗しました(get_staff_data_all_sapporo)";
		exit();
	}

	$i=0;
	$list_data = array();
	while($row = mysql_fetch_assoc($res)){

		$list_data[$i++] = $row;

	}

	return $list_data;
	exit();
}

//出席データが登録済みであるかどうか(登録済み：true,未登録:false)
function check_staff_attendance_exist($staff_id,$day_year,$day_month,$day_day){

	$sql = sprintf("select id from attendance_staff where staff_id='%s' and year='%s' and month='%s' and day='%s'",
	$staff_id,$day_year,$day_month,$day_day);

	//echo $sql;
	//exit();

	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(check_staff_attendance_exist)";
		exit();
	}
	$num = mysql_num_rows($res);

	if( $num > 0 ){

		return true;
		exit();

	}else{

		return false;
		exit();

	}

}

//出席データが登録済みであるかどうか(登録済み：true,未登録:false)(札幌)
function check_staff_attendance_exist_sapporo($staff_id,$day_year,$day_month,$day_day){

	$sql = sprintf("select id from attendance_staff_sapporo where staff_id='%s' and year='%s' and month='%s' and day='%s'",
	$staff_id,$day_year,$day_month,$day_day);

	//echo $sql;
	//exit();

	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(check_staff_attendance_exist_sapporo)";
		exit();
	}
	$num = mysql_num_rows($res);

	if( $num > 0 ){

		return true;
		exit();

	}else{

		return false;
		exit();

	}

}

//出勤データのコピー(スタッフ)
function copy_attendance_data_staff($attendance_id,$year,$month,$day,$week,$staff_type){

	//出勤データIDからスタッフIDを取得
	$staff_id = get_staff_id_by_attendance_id($attendance_id);

	//出席データが登録済みであるかどうか(登録済み：attendance_id,未登録:false)(スタッフ)
	$check_result = check_staff_attendance_exist_2($staff_id, $year, $month, $day);

	if( $check_result == "-1" ){

		return false;
		exit();

	}

	//出席データの取得(スタッフ)
	$data = get_attendance_data_by_attendance_id_2_staff($attendance_id);

	if( $data == false ){

		return false;
		exit();

	}

	/*
	 echo "<pre>";
	print_r($data);
	echo "</pre>";
	exit();
	*/

	$staff_id = $data["staff_id"];
	$start_time = $data["start_time"];
	$end_time = $data["end_time"];
	$charge_area = $data["charge_area"];

	if( $check_result == false ){

		//インサートのsql
		$sql = sprintf("
insert into attendance_staff(staff_id,staff_type,year,month,day,week,start_time,end_time,charge_area)
values('%s','%s','%s','%s','%s','%s','%s','%s','%s')",
		$staff_id,$staff_type,$year,$month,$day,$week,$start_time,$end_time,$charge_area);

		//echo $sql;
		//exit();

	}else{

		$attendance_id = $check_result;

		//更新のsql
		$sql = sprintf("
update attendance_staff set year='%s',month='%s',day='%s',week='%s',start_time='%s',end_time='%s',charge_area='%s' where id='%s'",
		$year,$month,$day,$week,$start_time,$end_time,$charge_area,$attendance_id);

		//echo $sql;
		//exit();

	}

	$res = mysql_query($sql, DbCon);
	if($res == false){

		return false;
		exit();

	}

	return true;
	exit();

}

//出勤データIDからスタッフIDを取得
function get_staff_id_by_attendance_id($attendance_id){

	$sql = sprintf("select staff_id from attendance_staff where id='%s'",$attendance_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		return false;
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row["staff_id"];
	exit();

}

//出席データが登録済みであるかどうか(登録済み：attendance_id,未登録:false)(スタッフ)
function check_staff_attendance_exist_2($staff_id,$day_year,$day_month,$day_day){

	$sql = sprintf("select id from attendance_staff where staff_id='%s' and year='%s' and month='%s' and day='%s'",
	$staff_id,$day_year,$day_month,$day_day);

	//echo $sql;
	//exit();

	$res = mysql_query($sql, DbCon);
	if($res == false){

		return "-1";
		exit();

	}
	$num = mysql_num_rows($res);

	if( $num > 1 ){

		return "-1";
		exit();

	}else if( $num == 1 ){

		$row = mysql_fetch_assoc($res);
		return $row["id"];
		exit();

	}else{

		return false;
		exit();

	}

}

//出席データの取得(スタッフ)
function get_attendance_data_by_attendance_id_2_staff($attendance_id){

	$sql = sprintf("select * from attendance_staff where id='%s'",$attendance_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		return false;
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();

}

//スタッフの出勤データを取得
function get_staff_attendance_data($staff_type,$now_month,$next_month,$two_month){

	// 出勤データを取得するためのSQL文
	$sql = sprintf("
select * from attendance_staff where (month='%s' or month='%s' or month='%s') and staff_type='%s'",
$now_month,$next_month,$two_month,$staff_type);

	//echo $sql;
	//exit();

	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリ実行に失敗しました(get_staff_attendance_data)";
		exit();
	}
	$data = array();
	// 一覧に表示される顧客データを変数に格納する処理
	$i=0;
	while($row = mysql_fetch_assoc($res)){
		$data[$i] = $row;
		$data[$i]["area"] = "tokyo";
		$i++;
	}

	if( $staff_type == "2" ){

		$kenmu = "tokyo";
		$area = "yokohama";

		$where_kenmu = "kenmu like '%".$kenmu."%'";

		$sql = sprintf("
select
attendance_staff_new.id,staff_id,year,month,day,week,start_time,end_time,
today_absence,attendance_adjustment,kenmu
from attendance_staff_new
left join staff_new_new on staff_new_new.id=attendance_staff_new.staff_id
where (month='%s' or month='%s' or month='%s') and (%s) and staff_new_new.area='%s'",
$now_month,$next_month,$two_month,$where_kenmu,$area);

		$res = mysql_query($sql, DbCon);

		if($res == false){

			echo "error!(get_staff_attendance_data)";
			exit();

		}

		while($row = mysql_fetch_assoc($res)){

			$data[$i] = $row;
			$data[$i]["area"] = "yokohama";

			$i++;

		}

	}

	return $data;
	exit();

}

//スタッフの出勤データを取得(札幌)
function get_staff_attendance_data_sapporo($staff_type,$now_month,$next_month,$two_month){

	// 出勤データを取得するためのSQL文
	$sql = sprintf("select * from attendance_staff_sapporo where (month='%s' or month='%s' or month='%s') and staff_type='%s'",
$now_month,$next_month,$two_month,$staff_type);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリ実行に失敗しました(get_staff_attendance_data_sapporo)";
		exit();
	}
	$data = array();
	// 一覧に表示される顧客データを変数に格納する処理
	$i=0;
	while($row = mysql_fetch_assoc($res)){
		$data[$i++] = $row;
	}

	return $data;
	exit();

}

function get_attendance_disp_time($start_time,$end_time){

	include(INC_PATH."/define.php");

	$data = "";

	//print_r($time_array);
	//echo $start_time;
	//exit();

	if($end_time=="23"){

		$hour = $time_array[$start_time]["hour"];
		$minute = $time_array[$start_time]["minute"];

		if($minute=="0"){

			$data = $hour.'時';

		}else{

			$data = $hour.'.5'.'時';

		}

	}else{

		$hour_start = $time_array[$start_time]["hour"];
		$minute_start = $time_array[$start_time]["minute"];
		$hour_end = $time_array[$end_time]["hour"];
		$minute_end = $time_array[$end_time]["minute"];

		if($minute_start != "0"){

			$hour_start = $hour_start.".5";

		}

		if($minute_end != "0"){

			$hour_end = $hour_end.".5";

		}

		$data = $hour_start."-".$hour_end;

	}

	return $data;
	exit();

}

function get_attendance_disp_time_therapist($start_time,$end_time,$syounin_state){

	include(INC_PATH."/define.php");

	$data = "";

	//print_r($time_array);
	//echo $start_time;
	//exit();

	if($end_time=="23"){

		$hour = $time_array[$start_time]["hour"];
		$minute = $time_array[$start_time]["minute"];

		if($minute=="0"){

			$data = $hour.'時';

		}else{

			$data = $hour.'.5'.'時';

		}

	}else{

		$hour_start = $time_array[$start_time]["hour"];
		$minute_start = $time_array[$start_time]["minute"];
		$hour_end = $time_array[$end_time]["hour"];
		$minute_end = $time_array[$end_time]["minute"];

		if($minute_start != "0"){

			$hour_start = $hour_start.".5";

		}

		if($minute_end != "0"){

			$hour_end = $hour_end.".5";

		}

		$data = $hour_start."-".$hour_end;

	}

	if( $syounin_state == "1" ){
		$data = '<span style="font-weight:bold;font-size:12px;">'.$data.'</span>';
	}

	return $data;
	exit();

}

function get_attendance_disp_time_therapist_kensyuu($start_time,$end_time,$work_flg){

	include(INC_PATH."/define.php");

	$data = "";

	if($end_time=="23"){

		$hour = $time_array[$start_time]["hour"];
		$minute = $time_array[$start_time]["minute"];

		if($minute=="0"){

			$data = $hour.'時';

		}else{

			$data = $hour.'.5'.'時';

		}

	}else{

		$hour_start = $time_array[$start_time]["hour"];
		$minute_start = $time_array[$start_time]["minute"];
		$hour_end = $time_array[$end_time]["hour"];
		$minute_end = $time_array[$end_time]["minute"];

		if($minute_start != "0"){

			$hour_start = $hour_start.".5";

		}

		if($minute_end != "0"){

			$hour_end = $hour_end.".5";

		}

		$data = $hour_start."-".$hour_end;

	}

	if( $work_flg == "1" ){

		$data .= "<br />出勤";

	}

	return $data;
	exit();

}

function get_attendance_disp_time_honbu($start_time,$end_time){

	include(INC_PATH."/define.php");

	$data = "";

	//print_r($time_array);
	//echo $start_time;
	//exit();

	/*
	if($end_time=="35"){
		$hour = $time_array_honbu[$start_time]["hour"];
		$minute = $time_array_honbu[$start_time]["minute"];
		if($minute=="0"){
			$data = $hour.'時';
		}else{
			$data = $hour.'.5'.'時';
		}
	}else{
		$hour_start = $time_array_honbu[$start_time]["hour"];
		$minute_start = $time_array_honbu[$start_time]["minute"];
		$hour_end = $time_array_honbu[$end_time]["hour"];
		$minute_end = $time_array_honbu[$end_time]["minute"];
		if($minute_start != "0"){
			$hour_start = $hour_start.".5";
		}
		if($minute_end != "0"){
			$hour_end = $hour_end.".5";
		}
		$data = $hour_start."-".$hour_end;
	}
	*/

	$hour_start = $time_array_honbu[$start_time]["hour"];
	$minute_start = $time_array_honbu[$start_time]["minute"];
	$hour_end = $time_array_honbu[$end_time]["hour"];
	$minute_end = $time_array_honbu[$end_time]["minute"];

	if($minute_start != "0"){

		$hour_start = $hour_start.".5";

	}

	if($minute_end != "0"){

		$hour_end = $hour_end.".5";

	}

	$data = $hour_start."-".$hour_end;

	return $data;
	exit();

}

//出勤スタッフの数を取得
function get_staff_attendance_num($staff_type,$year,$month,$day){

	$sql = sprintf("
select attendance_staff.id from attendance_staff
left join staff_new on staff_new.id=attendance_staff.staff_id
where staff_new.delete_flg='0' and attendance_staff.today_absence='0' and attendance_staff.staff_type='%s' and attendance_staff.year='%s'
and attendance_staff.month='%s' and attendance_staff.day='%s' and not_num_flg=0",
$staff_type,$year,$month,$day);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリー実行で失敗しました(get_staff_attendance_num)";
		exit();

	}

	$num = mysql_num_rows($res);

	return $num;
	exit();

}

//出勤スタッフの数を取得(札幌)
function get_staff_attendance_num_sapporo($staff_type,$year,$month,$day){

	$sql = sprintf("
select attendance_staff_sapporo.id from attendance_staff_sapporo
left join staff_new_sapporo on staff_new_sapporo.id=attendance_staff_sapporo.staff_id
where staff_new_sapporo.delete_flg='0' and attendance_staff_sapporo.today_absence='0' and attendance_staff_sapporo.staff_type='%s'
and attendance_staff_sapporo.year='%s' and attendance_staff_sapporo.month='%s'
and attendance_staff_sapporo.day='%s'",
$staff_type,$year,$month,$day);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリー実行で失敗しました(get_staff_attendance_num)";
		exit();

	}

	$num = mysql_num_rows($res);

	return $num;
	exit();

}

//出勤セラピストの数を取得(東京)
function get_tokyo_therapist_attendance_num($charge_area,$year,$month,$day){

	if($charge_area=="-1"){

		$sql = sprintf("
select attendance.id from attendance
left join therapist on therapist.id=attendance.therapist_id
where therapist.delete_flag='0' and attendance.today_absence='0' and attendance.year='%s'
and attendance.month='%s' and attendance.day='%s'",
$year,$month,$day);

		//echo $sql;
		//exit();

	}else{

		$sql = sprintf("
select attendance.id from attendance
left join therapist on therapist.id=attendance.therapist_id
where therapist.delete_flag='0' and attendance.today_absence='0' and attendance.charge_area='%s'
and attendance.year='%s' and attendance.month='%s' and attendance.day='%s'",
$charge_area,$year,$month,$day);

		//echo $sql;
		//exit();

	}

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリー実行で失敗しました(get_tokyo_therapist_attendance_num)";
		exit();

	}

	$num = mysql_num_rows($res);

	return $num;
	exit();

}

//出勤セラピストの数を取得(札幌)
function get_sapporo_therapist_attendance_num($year,$month,$day){

	$sql = sprintf("
select attendance_sapporo.id from attendance_sapporo
left join therapist_sapporo on therapist_sapporo.id=attendance_sapporo.therapist_id
where therapist_sapporo.delete_flg='0' and attendance_sapporo.today_absence='0' and attendance_sapporo.year='%s'
and attendance_sapporo.month='%s' and attendance_sapporo.day='%s'",
$year,$month,$day);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリー実行で失敗しました(get_sapporo_therapist_attendance_num)";
		exit();

	}

	$num = mysql_num_rows($res);

	return $num;
	exit();

}

function get_day_array($year_hiki,$month_hiki,$day_hiki,$week_hiki){

	$year_now = intval(date('Y'));
	$month_now = intval(date('m'));
	$day_now = intval(date('d'));
	$week_now = intval(date('w'));

	$year = $year_now;
	$month = $month_now;
	$day = 1;
	$hour = 0;
	$minute = 0;
	$second = 0;
	$timestamp_now = mktime($hour, $minute, $second, $month, $day, $year);

	$year = $year_hiki;
	$month = $month_hiki;
	$day = 1;
	$hour = 0;
	$minute = 0;
	$second = 0;
	$timestamp_hiki = mktime($hour, $minute, $second, $month, $day, $year);

	//echo $timestamp_hiki;
	//exit();

	if( $timestamp_now < $timestamp_hiki ){

		$year = $year_hiki;
		$month = $month_hiki;
		$day = 1;

		$year_tmp = $year;
		$month_tmp = $month;
		$day_tmp = $day;
		$hour_tmp = 0;
		$minute_tmp = 0;
		$second_tmp = 0;
		$timestamp_tmp = mktime($hour_tmp, $minute_tmp, $second_tmp, $month_tmp, $day_tmp, $year_tmp);

		$week = date('w', $timestamp_tmp);

	}else{

		$year = $year_now;
		$month = $month_now;
		$day = $day_now;
		$week = $week_now;

	}

	$day_array = array();
	$uru_flag = false;

	for($i=0;$i<31;$i++){
		$day_array[$i]["year"] = $year;
		$day_array[$i]["month"] = $month;
		$day_array[$i]["day"] = $day;
		$day_array[$i]["week"] = $week;
		//うるう年判定
		if(($year%4)==0){
			if(($year%100)==0){
				if(($year%400)==0){
					$uru_flag = true;
				}else{
					$uru_flag = false;
				}
			}else{
				$uru_flag = true;
			}
		}else{
			$uru_flag = false;
		}
		if($month==2){
			if($day==28){
				if($uru_flag==true){
					$day = 29;
				}else{
					$day = 1;
					$month++;
				}
			}else if($day==29){
				$day = 1;
				$month++;
			}else{
				$day++;
			}
		}else{
			if(($month==4)||($month==6)||($month==9)||($month==11)){
				if($day==30){
					$day = 1;
					$month++;
				}else{
					$day++;
				}
			}else{
				if($day==31){
					$day = 1;
					if($month==12){
						$month = 1;
						$year++;
					}else{
						$month++;
					}
				}else{
					$day++;
				}
			}
		}
		if($week==6){
			$week = 0;
		}else{
			$week++;
		}
	}

	return $day_array;
	exit();

}

function get_day_id($day_array,$year,$month,$day){

	$day_array_num = count($day_array);

	for($i=0;$i<$day_array_num;$i++){

		$year_tmp = $day_array[$i]["year"];
		$month_tmp = $day_array[$i]["month"];
		$day_tmp = $day_array[$i]["day"];

		if( ($year==$year_tmp) && ($month==$month_tmp) && ($day==$day_tmp) ){

			return $i;
			exit();

		}

	}

	return false;
	exit();

}

//出勤情報を更新
function update_attendance_data_therapist($attendance_id,$year,$month,$day,$week,$start_time,$end_time,$charge_area,
$today_absence,$attendance_adjustment,$staff_area,$syounin_check,$syounin_state,$comment){

	$area = "tokyo";
	$therapist_id = get_therapist_id_by_attendance_id_new($attendance_id, $area);
	$week_name = get_week_name_new($year, $month, $day);

	$therapist_name = get_therapist_name_by_therapist_id_honmyou($therapist_id, $area);

	//トランザクションをはじめる準備
	$sql = "set autocommit = 0";
	mysql_query( $sql, DbCon );

	//トランザクション開始
	$sql = "begin";
	mysql_query( $sql, DbCon );

	if($syounin_check == "1"){

		$syounin_state = "1";

	}

	if($staff_area=="yokohama"){

		//出勤情報を登録するSQL文
		//更新のsql
		$sql = sprintf("
update attendance_new set year='%s',month='%s',day='%s',week='%s',start_time='%s',end_time='%s',area='%s',today_absence='%s',attendance_adjustment='%s' where id='%s'",
$year,$month,$day,$week,$start_time,$end_time,$staff_area,$today_absence,$attendance_adjustment,$attendance_id);

	}else{

	// 出勤情報を登録するSQL文
	//更新のsql
	$sql = sprintf("
update attendance set year='%s',month='%s',day='%s',week='%s',start_time='%s',end_time='%s',charge_area='%s',
today_absence='%s',attendance_adjustment='%s',syounin_state='%s',comment='%s' where id='%s'",
$year,$month,$day,$week,$start_time,$end_time,$charge_area,$today_absence,$attendance_adjustment,
$syounin_state,$comment,$attendance_id);

	}

	$res = mysql_query($sql, DbCon);
	if($res == false){

		//ロールバック
		$sql = "rollback";
		mysql_query( $sql, DbCon );

		echo "クエリ実行に失敗しました(update_attendance_data_therapist):1";
		exit();

	}

	if( ($syounin_check == "1") && ($staff_area != "yokohama") ){

		$now = time();
		$staff_type = "1";

		$site_name = "東京リフレ";

		$message = sprintf("%s/%s(%s)のシフトを承認しました！",$month,$day,$week_name);

		$sql = sprintf("
insert into shift_history(created,area,therapist_id,staff_type,message)
values('%s','%s','%s','%s','%s')",
$now,$area,$therapist_id,$staff_type,$message);

		$res = mysql_query($sql, DbCon);

		if($res == false){

			//ロールバック
			$sql = "rollback";
			mysql_query( $sql, DbCon );

			echo "クエリ実行に失敗しました(update_attendance_data_therapist):2";
			exit();

		}

		mb_language("ja");
		mb_internal_encoding("UTF-8");
		$mailto = "minamikawa@neo-gate.jp";
		$title = "シフト承認".$month."月".$day."日【".$site_name."】";
		$content =<<<EOT
{$therapist_name}さん

{$month}月{$day}日({$week_name})のシフトを承認しました。

(該当者のシフトチェック画面URL)
EOT;

		$header = "From: minamikawa@neo-gate.jp\n";
		//$header .= "Bcc: minamikawa@neo-gate.jp";

		$result = mb_send_mail($mailto,$title,$content,$header,MAIL_PARAMETER);

		if($result==false){

			//ロールバック
			$sql = "rollback";
			mysql_query( $sql, DbCon );

			echo "クエリ実行に失敗しました(update_attendance_data_therapist):3";
			exit();

		}

	}

	//コミット
	$sql = "commit";
	mysql_query( $sql, DbCon );

	return true;
	exit();
}

//出勤情報を更新(スタッフ)
function update_attendance_data_staff($attendance_id,$year,$month,$day,$week,$start_time,$end_time,$charge_area,$today_absence,$attendance_adjustment){

	// 出勤情報を登録するSQL文
	//更新のsql
	$sql = sprintf("
update attendance_staff set year='%s',month='%s',day='%s',week='%s',start_time='%s',end_time='%s',charge_area='%s',today_absence='%s',attendance_adjustment='%s' where id='%s'",
	$year,$month,$day,$week,$start_time,$end_time,$charge_area,$today_absence,$attendance_adjustment,$attendance_id);

	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリ実行に失敗しました(update_attendance_data_staff)";
		exit();
	}

	return true;
	exit();

}

//出勤情報を更新(スタッフ)(札幌)
function update_attendance_data_staff_sapporo($attendance_id,$year,$month,$day,$week,$start_time,$end_time,$charge_area,$today_absence,$attendance_adjustment){

	// 出勤情報を登録するSQL文
	//更新のsql
	$sql = sprintf("
update attendance_staff_sapporo set year='%s',month='%s',day='%s',week='%s',start_time='%s',end_time='%s',charge_area='%s',today_absence='%s',attendance_adjustment='%s' where id='%s'",
	$year,$month,$day,$week,$start_time,$end_time,$charge_area,$today_absence,$attendance_adjustment,$attendance_id);

	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリ実行に失敗しました(update_attendance_data_staff_sapporo)";
		exit();
	}

	return true;
	exit();

}

function delete_therapist_attendance_data($attendance_id){

	$sql = "delete from attendance where id=".$attendance_id;

	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリ実行に失敗しました(delete_therapist_attendance_data)";
		exit();
	}

	return true;
	exit();

}

function delete_therapist_attendance_data_sapporo($attendance_id){

	$sql = "delete from attendance_sapporo where id=".$attendance_id;

	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリ実行に失敗しました(delete_therapist_attendance_data_sapporo)";
		exit();
	}

	return true;
	exit();

}

function delete_staff_attendance_data($attendance_id){

	$sql = "delete from attendance_staff where id=".$attendance_id;

	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリ実行に失敗しました(delete_staff_attendance_data)";
		exit();
	}

	return true;
	exit();

}

function delete_staff_attendance_data_sapporo($attendance_id){

	$sql = "delete from attendance_staff_sapporo where id=".$attendance_id;

	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリ実行に失敗しました(delete_staff_attendance_data_sapporo)";
		exit();
	}

	return true;
	exit();

}

//スタッフ名取得
function get_staff_name_by_staff_id($staff_id,$shop_area,$driver_area){

	$sql = sprintf("select name from staff_new_new where id='%s'",$staff_id);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリ実行に失敗しました(get_staff_name_by_staff_id)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	return $row["name"];
	exit();

}

//スタッフ名取得(札幌)
function get_staff_name_by_staff_id_sapporo($staff_id){

	$sql = sprintf("select name from staff_new_sapporo where id='%s'",$staff_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリ実行に失敗しました(get_staff_name_by_staff_id_sapporo)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row["name"];
	exit();

}

//出勤データのコピー(札幌)
function copy_attendance_data_therapist_sapporo($attendance_id,$year,$month,$day,$week){

	//出勤データIDからセラピストIDを取得(札幌)
	$therapist_id = get_therapist_id_by_attendance_id_sapporo($attendance_id);

	//出勤データが登録済みかどうか(登録済み:attendance_id,未登録:false)(札幌)
	$check_result = check_therapist_attendance_exist_2_sapporo($therapist_id, $year, $month, $day);

	if( $check_result == "-1" ){

		return false;
		exit();

	}

	//出席データの取得(札幌)
	$data = get_attendance_data_by_attendance_id_2_sapporo($attendance_id);

	if( $data == false ){

		return false;
		exit();

	}

	/*
	 echo "<pre>";
	print_r($data);
	echo "</pre>";
	exit();
	*/

	$therapist_id = $data["therapist_id"];
	$start_time = $data["start_time"];
	$end_time = $data["end_time"];

	if( $check_result == false ){

		//インサートのsql
		$sql = sprintf("
insert into attendance_sapporo(therapist_id,year,month,day,week,start_time,end_time)
values('%s','%s','%s','%s','%s','%s','%s')",
		$therapist_id,$year,$month,$day,$week,$start_time,$end_time);

		//echo $sql;
		//exit();

	}else{

		$attendance_id = $check_result;

		//更新のsql
		$sql = sprintf("
update attendance_sapporo set year='%s',month='%s',day='%s',week='%s',start_time='%s',end_time='%s' where id='%s'",
		$year,$month,$day,$week,$start_time,$end_time,$attendance_id);

		//echo $sql;
		//exit();

	}

	$res = mysql_query($sql, DbCon);
	if($res == false){

		return false;
		exit();

	}

	return true;
	exit();

}

//出勤データIDからセラピストIDを取得(札幌)
function get_therapist_id_by_attendance_id_sapporo($attendance_id){

	$sql = sprintf("select therapist_id from attendance_sapporo where id='%s'",$attendance_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){

		return false;
		exit();

	}

	$row = mysql_fetch_assoc($res);

	return $row["therapist_id"];
	exit();

}

//出席データが登録済みであるかどうか(登録済み：attendance_id,未登録:false)(札幌)
function check_therapist_attendance_exist_2_sapporo($therapist_id,$day_year,$day_month,$day_day){

	$sql = sprintf("select id from attendance_sapporo where therapist_id='%s' and year='%s' and month='%s' and day='%s'",
	$therapist_id,$day_year,$day_month,$day_day);

	//echo $sql;
	//exit();

	$res = mysql_query($sql, DbCon);
	if($res == false){

		return "-1";
		exit();

	}
	$num = mysql_num_rows($res);

	if( $num > 1 ){

		return "-1";
		exit();

	}else if( $num == 1 ){

		$row = mysql_fetch_assoc($res);
		return $row["id"];
		exit();

	}else{

		return false;
		exit();

	}

}

//出席データの取得(札幌)
function get_attendance_data_by_attendance_id_2_sapporo($attendance_id){

	$sql = sprintf("select * from attendance_sapporo where id='%s'",$attendance_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){

		return false;
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();

}

function man_error_log($messe){

	$now = date("Y-m-d H:i:s",time());

	$fp = fopen(MAN_ROOT_PATH."error.txt", "a");
	fwrite($fp, "\n".$messe."(".$now.")");
	fclose($fp);

}

//出勤データのコピー(スタッフ)(札幌)
function copy_attendance_data_staff_sapporo($attendance_id,$year,$month,$day,$week,$staff_type){

	//出勤データIDからスタッフIDを取得(札幌)
	$staff_id = get_staff_id_by_attendance_id_sapporo($attendance_id);

	//出席データが登録済みであるかどうか(登録済み：attendance_id,未登録:false)(スタッフ)(札幌)
	$check_result = check_staff_attendance_exist_2_sapporo($staff_id, $year, $month, $day);

	if( $check_result == "-1" ){

		return false;
		exit();

	}

	//出席データの取得(スタッフ)(札幌)
	$data = get_attendance_data_by_attendance_id_2_staff_sapporo($attendance_id);

	if( $data == false ){

		return false;
		exit();

	}

	/*
	 echo "<pre>";
	print_r($data);
	echo "</pre>";
	exit();
	*/

	$staff_id = $data["staff_id"];
	$start_time = $data["start_time"];
	$end_time = $data["end_time"];
	$charge_area = $data["charge_area"];

	if( $check_result == false ){

		//インサートのsql
		$sql = sprintf("
insert into attendance_staff_sapporo(staff_id,staff_type,year,month,day,week,start_time,end_time,charge_area)
values('%s','%s','%s','%s','%s','%s','%s','%s','%s')",
		$staff_id,$staff_type,$year,$month,$day,$week,$start_time,$end_time,$charge_area);

		//echo $sql;
		//exit();

	}else{

		$attendance_id = $check_result;

		//更新のsql
		$sql = sprintf("
update attendance_staff_sapporo set year='%s',month='%s',day='%s',week='%s',start_time='%s',end_time='%s',charge_area='%s' where id='%s'",
		$year,$month,$day,$week,$start_time,$end_time,$charge_area,$attendance_id);

		//echo $sql;
		//exit();

	}

	$res = mysql_query($sql, DbCon);
	if($res == false){

		return false;
		exit();

	}

	return true;
	exit();

}

//出勤データIDからスタッフIDを取得(札幌)
function get_staff_id_by_attendance_id_sapporo($attendance_id){

	$sql = sprintf("select staff_id from attendance_staff_sapporo where id='%s'",$attendance_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		return false;
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row["staff_id"];
	exit();

}

//出席データが登録済みであるかどうか(登録済み：attendance_id,未登録:false)(スタッフ)(札幌)
function check_staff_attendance_exist_2_sapporo($staff_id,$day_year,$day_month,$day_day){

	$sql = sprintf("select id from attendance_staff_sapporo where staff_id='%s' and year='%s' and month='%s' and day='%s'",
	$staff_id,$day_year,$day_month,$day_day);

	//echo $sql;
	//exit();

	$res = mysql_query($sql, DbCon);
	if($res == false){

		return "-1";
		exit();

	}
	$num = mysql_num_rows($res);

	if( $num > 1 ){

		return "-1";
		exit();

	}else if( $num == 1 ){

		$row = mysql_fetch_assoc($res);
		return $row["id"];
		exit();

	}else{

		return false;
		exit();

	}

}

//出席データの取得(スタッフ)(札幌)
function get_attendance_data_by_attendance_id_2_staff_sapporo($attendance_id){

	$sql = sprintf("select * from attendance_staff_sapporo where id='%s'",$attendance_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		return false;
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();

}

//駅データの取得
function get_station_data_for_page_html(){

	$sql = "select id,name from station where delete_flg=0";
	$res = mysql_query($sql, DbCon);
	if($res == false){

		echo "クエリー実行で失敗しました(get_station_data_for_page_html)";
		exit();

	}
	$i=0;
	$list_data = array();
	while($row = mysql_fetch_assoc($res)){
		$list_data[$i++] = $row;
	}

	return $list_data;
	exit();

}

//駅データの取得(NEW)
function get_station_data_for_page_html_new($shop_area){

	$sql = sprintf("select id,name from station_new where shop_area='%s' and delete_flg=0",$shop_area);
	$res = mysql_query($sql, DbCon);
	if($res == false){

		echo "クエリー実行で失敗しました(get_station_data_for_page_html_new)";
		exit();

	}
	$i=0;
	$list_data = array();
	while($row = mysql_fetch_assoc($res)){
		$list_data[$i++] = $row;
	}

	return $list_data;
	exit();

}

function get_sapporo_area_data_for_page_html(){

	$sql = "select id,name from area_sapporo where delete_flg=0";
	$res = mysql_query($sql, DbCon);
	if($res == false){

		echo "クエリー実行で失敗しました(get_sapporo_area_data_for_page_html)";
		exit();

	}
	$i=0;
	$list_data = array();
	while($row = mysql_fetch_assoc($res)){
		$list_data[$i++] = $row;
	}

	return $list_data;
	exit();

}

function get_area_data_for_page_html($area){

	$sql = sprintf("select id,name from area_new where delete_flg=0 and type='%s'",$area);
	$res = mysql_query($sql, DbCon);
	if($res == false){

		echo "クエリー実行で失敗しました(get_area_data_for_page_html)";
		exit();

	}
	$i=0;
	$list_data = array();
	while($row = mysql_fetch_assoc($res)){
		$list_data[$i++] = $row;
	}

	return $list_data;
	exit();

}

function get_yokohama_hotel_data_for_page_html(){

	$sql = "select id,name from hotel_yokohama where delete_flg=0";
	$res = mysql_query($sql, DbCon);
	if($res == false){

		echo "クエリー実行で失敗しました(get_yokohama_hotel_data_for_page_html)";
		exit();

	}
	$i=0;
	$list_data = array();
	while($row = mysql_fetch_assoc($res)){
		$list_data[$i++] = $row;
	}

	return $list_data;
	exit();

}

function ku_data_for_page_html(){

	$sql = "select id,name from ku";
	$res = mysql_query($sql, DbCon);
	if($res == false){

		echo "クエリー実行で失敗しました(ku_data_for_page_html)";
		exit();

	}
	$i=0;
	$list_data = array();
	while($row = mysql_fetch_assoc($res)){
		$list_data[$i++] = $row;
	}

	return $list_data;
	exit();

}

function tokyo_hotel_data_for_page_html(){

	$sql = "select id,name from hotel where delete_flg=0";
	$res = mysql_query($sql, DbCon);
	if($res == false){

		echo "クエリー実行で失敗しました(tokyo_hotel_data_for_page_html)";
		exit();

	}
	$i=0;
	$list_data = array();
	while($row = mysql_fetch_assoc($res)){
		$list_data[$i++] = $row;
	}

	return $list_data;
	exit();

}

//ページHTMLの登録
function regist_page_html($page_type,$site_type,$data_id,$naiyou){

	//登録チェック(有り：true、無し：false)
	$result = check_page_html_exist($page_type,$site_type,$data_id);

	$naiyou = mysql_real_escape_string($naiyou);

	if($result==true){

		//update文
		$sql = sprintf("
update page_html set content='%s' where page_type='%s' and site_type='%s' and data_id='%s'",
$naiyou,$page_type,$site_type,$data_id);

		//echo $sql;
		//exit();

	}else{

		//insert文
		$sql = sprintf("
insert into page_html(site_type,page_type,data_id,content) values('%s','%s','%s','%s')",
$site_type,$page_type,$data_id,$naiyou);

	}

	$res = mysql_query($sql, DbCon);

	if($res == false){

		//echo $sql;
		//exit();

		return false;
		exit();

	}

	return true;
	exit();

}

//登録チェック(有り：true、無し：false)
function check_page_html_exist($page_type,$site_type,$data_id){

	$sql = sprintf("
select id from page_html where page_type='%s' and site_type='%s' and data_id='%s'",
$page_type,$site_type,$data_id);
	$res = mysql_query($sql, DbCon);
	if($res === false){
		echo "クエリー実行で失敗しました(check_page_html_exist)";
		exit();
	}
	$num = mysql_num_rows($res);

	if( $num > 0 ){

		return true;
		exit();

	}else{

		return false;
		exit();

	}

}

function get_page_name_page_html($page_type,$site_type,$data_id){

	if( ( ($site_type=="tokyo-refle") || ($site_type=="tokyo-lymph") || ($site_type=="tokyo-aroma") ) && (($page_type=="station") || ($page_type=="station_add")) ){

		$station_name = get_station_name_by_id($data_id);

		return $station_name;
		exit();

	}else if( ($page_type=="area_en") && ($site_type=="tokyo-refle") ){

		$area_name = get_ku_name_by_id($data_id);

		return $area_name;
		exit();

	}else if( ($page_type=="station_en") && ($site_type=="tokyo-refle") ){

		$station_name = get_station_name_by_id($data_id);

		return $station_name;
		exit();

	}else if( ($page_type=="area_add") && ($site_type=="sapporo-refle") ){

		$area_name = get_sapporo_area_name_by_id($data_id,$site_type);

		return $area_name;
		exit();

	}else if( ($page_type=="station_add") && ($site_type=="sapporo-refle") ){

		$area_name = get_sapporo_area_name_by_id_new($data_id,$site_type,$page_type);

		return $area_name;
		exit();

	}else if( ($page_type=="area_add") && ($site_type=="yokohama-refle") ){

		$area_name = get_area_name_new($data_id);

		return $area_name;
		exit();

	}else if( ($page_type=="station_add") && ($site_type=="yokohama-refle") ){

		$station_name = get_station_name_by_id_new($data_id);

		return $station_name;
		exit();

	}else if( ($page_type=="ku_add") && ( ($site_type=="tokyo-refle") || ($site_type=="tokyo-aroma") || ($site_type=="tokyo-lymph") ) ){

		$area_name = get_ku_name_by_id($data_id);

		return $area_name;
		exit();

	}else if( ($page_type=="area_add") && ($site_type=="sendai-refle") ){

		$area_name = get_area_name_new($data_id);

		return $area_name;
		exit();

	}else if( ($page_type=="station_add") && ($site_type=="sendai-refle") ){

		$station_name = get_station_name_by_id_new($data_id);

		return $station_name;
		exit();

	}else if( ($page_type=="area_add") && ($site_type=="fukuoka-refle") ){

		$area_name = get_area_name_new($data_id);

		return $area_name;
		exit();

	}else if( ($page_type=="station_add") && ($site_type=="fukuoka-refle") ){

		$station_name = get_station_name_by_id_new($data_id);

		return $station_name;
		exit();

	}else if( ($page_type=="area_add") && ($site_type=="osaka-refle") ){

		$area_name = get_area_name_new($data_id);

		return $area_name;
		exit();

	}else if( ($page_type=="station_add") && ($site_type=="osaka-refle") ){

		$station_name = get_station_name_by_id_new($data_id);

		return $station_name;
		exit();

	}else{

		return "不明";
		exit();

	}

}

function get_station_name_by_id($data_id){

	$sql = sprintf("select name from station where id='%s'",$data_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_station_name_by_id)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row["name"];
	exit();

}

function get_station_name_by_id_new($data_id){

	$sql = sprintf("select name from station_new where id='%s'",$data_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_station_name_by_id_new)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row["name"];
	exit();

}

function get_sapporo_area_name_by_id($data_id,$site_type){

	$tbl_name = "";

	if($site_type=="sapporo-refle"){

		$tbl_name = "area_sapporo";

	}else{

		echo "error!(get_sapporo_area_name_by_id):1";
		exit();

	}

	$sql = sprintf("select name from %s where id='%s'",$tbl_name,$data_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_sapporo_area_name_by_id):2";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row["name"];
	exit();

}

function get_sapporo_area_name_by_id_new($data_id,$site_type,$page_type){

	$tbl_name = "";

	if($site_type=="sapporo-refle"){

		if($page_type=="station_add"){

			$tbl_name = "station_sapporo";

		}else if($page_type=="hotel_add"){

			$tbl_name = "hotel_sapporo";

		}

	}else{

		echo "error!(get_sapporo_area_name_by_id_new):1";
		exit();

	}

	$sql = sprintf("select name from %s where id='%s'",$tbl_name,$data_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_sapporo_area_name_by_id_new):2";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row["name"];
	exit();

}

function get_page_content_page_html($page_type,$site_type,$data_id){

	$sql = sprintf("
select content from page_html where page_type='%s' and site_type='%s' and data_id='%s'",
$page_type,$site_type,$data_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_page_content_page_html)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row["content"];
	exit();

}

function get_sapporo_station_data_for_page_html(){

	$sql = "select id,name from station_sapporo where delete_flg=0";
	$res = mysql_query($sql, DbCon);
	if($res == false){

		echo "クエリー実行で失敗しました(get_sapporo_station_data_for_page_html)";
		exit();

	}
	$i=0;
	$list_data = array();
	while($row = mysql_fetch_assoc($res)){
		$list_data[$i++] = $row;
	}

	return $list_data;
	exit();

}

function get_sapporo_hotel_data_for_page_html(){

	$sql = "select id,name from hotel_sapporo where delete_flg=0";
	$res = mysql_query($sql, DbCon);
	if($res == false){

		//echo $sql;
		echo "クエリー実行で失敗しました(get_sapporo_hotel_data_for_page_html)";
		exit();

	}
	$i=0;
	$list_data = array();
	while($row = mysql_fetch_assoc($res)){
		$list_data[$i++] = $row;
	}

	return $list_data;
	exit();

}

function get_area_name_new($data_id){

	$sql = sprintf("select name from area_new where id='%s'",$data_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_area_name_new)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row["name"];
	exit();

}

function get_yokohama_hotel_name_by_id($data_id){

	$sql = sprintf("select name from hotel_yokohama where id='%s'",$data_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_yokohama_hotel_name_by_id)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row["name"];
	exit();

}

function get_ku_name_by_id($data_id){

	$sql = sprintf("select name from ku where id='%s'",$data_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_ku_name_by_id)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row["name"];
	exit();

}

function get_tokyo_htel_name_by_id($data_id){

	$sql = sprintf("select name from hotel where id='%s'",$data_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_tokyo_htel_name_by_id)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row["name"];
	exit();

}

//セラピストIDからセラピストデータを取得(NEW)
function get_therapist_info_by_therapist_id_new($therapist_id){

	$sql = sprintf("select * from therapist_new where id='%s'",$therapist_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリ実行に失敗しました(get_therapist_info_by_therapist_id_new)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();

}

//セラピスト情報更新(NEW)
function update_therapist_edit_man_new(
$therapist_id,$mail,$name_real,$name_site,$kenmu,$rank,$name_aroma,$name_tgr,$name_lymph,$jitaku_taiki_flg,
$for_kobetsu_url,$kensyuu_flg,$jisou_flg,$driver_kenmu_flg,$point_ref,$guarantee_rule,$point_fix,$address,$tel,
$bank_info,$total_point,$name_furi,$furikomi_type,$chief_allowance,$transport_cost){

	$rank_order_num = get_rank_order_num($rank);

	if( $jitaku_taiki_flg != "1" ){
		$jitaku_taiki_flg = 0;
	}

	if( $jisou_flg != "1" ){
		$jisou_flg = 0;
	}

	if( $driver_kenmu_flg != "1" ){
		$driver_kenmu_flg = 0;
	}

	$kenmu_string = "";

	$kenmu_num = count($kenmu);

	if( $kenmu_num > 0 ){

		for($i=0;$i<$kenmu_num;$i++){

			$kenmu_string .= $kenmu[$i];

			if( $i != ($kenmu_num-1) ){

				$kenmu_string .= $kenmu_string.",";

			}

		}

	}

	$name_real = trim($name_real);
	$name_site = trim($name_site);
	$name_aroma = trim($name_aroma);

	$sql = sprintf("
update therapist_new set
name='%s',mail='%s',name_site='%s',name_aroma='%s',name_tgr='%s',name_lymph='%s',kenmu='%s'
,rank='%s',jitaku_taiki_flg='%s',for_kobetsu_url='%s',kensyuu_flg='%s',
jisou_flg='%s',driver_kenmu_flg='%s',rank_order_num='%s',point_ref='%s',guarantee_rule='%s',
point_fix='%s',address='%s',tel='%s',bank_info='%s',total_point='%s',name_furi='%s',
furikomi_type='%s',chief_allowance='%s',transport_cost='%s'
where id='%s'",
$name_real,$mail,$name_site,$name_aroma,$name_tgr,$name_lymph,$kenmu_string,$rank,$jitaku_taiki_flg,
$for_kobetsu_url,$kensyuu_flg,$jisou_flg,$driver_kenmu_flg,$rank_order_num,$point_ref,$guarantee_rule,
$point_fix,$address,$tel,$bank_info,$total_point,$name_furi,$furikomi_type,$chief_allowance,
$transport_cost,$therapist_id);

	//echo $sql;
	//exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリ実行に失敗しました(update_therapist_edit_man_new)";
		exit();

	}

	return true;
	exit();

}

function get_area_name_by_area($area){

	if($area=="sendai"){

		$area_name = "仙台";

	}else if($area=="yokohama"){

		$area_name = "横浜";

	}else if($area=="tokyo"){

		$area_name = "東京";

	}else if($area=="sapporo"){

		$area_name = "札幌";

	}else if($area=="fukuoka"){

		$area_name = "福岡";

	}else if($area=="osaka"){

		$area_name = "大阪";

	}else if($area=="tokyo_reraku"){

		$area_name = "東京リラク";

	}else if($area=="tokyo_bigao"){

		$area_name = "BIGAO";

	}else{

		echo "error!(get_area_name_by_area)";
		//echo $area;
		exit();

	}

	return $area_name;
	exit();

}

function get_type_name_by_type($type){

	if($type=="driver"){

		$type_name = "ドライバー";

	}else if($type=="honbu"){

		$type_name = "本部メンバー";

	}else{

		echo "error!(get_type_name_by_type)";
		exit();

	}

	return $type_name;
	exit();

}

function get_staff_data_at_staff_list_new($area,$type){

	$sql = sprintf("
select * from staff_new_new where delete_flg=0 and leave_flg=0 and type='%s' and area='%s' order by order_num desc",
$type,$area);

	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_staff_data_at_staff_list_new)";
		exit();
	}

	$staff_data = array();

	// 一覧に表示されるスタッフデータを変数に格納する処理
	$i=0;
	while($row = mysql_fetch_assoc($res)){
		$staff_data[$i++] = $row;
	}

	return $staff_data;
	exit();

}

function regist_staff_data_new(
$name,$mail,$tel,$type,$area,$kenmu,$not_num_flg,$car_type,$car_color,$car_number,$tmp_pic_url,$file_name,
$boss_flg,$pay_hour,$pay_fix,$fuel,$address,$bank_info,$name_furi,$furikomi_type,$shayousha_flg){

	if( $pay_hour == "-1" ){

		$pay_hour = 0;

	}

	if( $fuel == "-1" ){

		$fuel = 0;

	}

	$kenmu_string = get_kenmu_string($kenmu);

	//トランザクションをはじめる準備
	$sql = "set autocommit = 0";
	mysql_query( $sql, DbCon );

	//トランザクション開始
	$sql = "begin";
	mysql_query( $sql, DbCon );

	$sql = sprintf("
insert into staff_new_new(type,name,mail,tel,area,kenmu,not_num_flg,car_type,car_color,car_number,
boss_flg,pay_hour,pay_fix,fuel,address,bank_info,name_furi,furikomi_type,shayousha_flg)
values('%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s')",
$type,$name,$mail,$tel,$area,$kenmu_string,$not_num_flg,$car_type,$car_color,$car_number,
$boss_flg,$pay_hour,$pay_fix,$fuel,$address,$bank_info,$name_furi,$furikomi_type,$shayousha_flg);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		//ロールバック
		$sql = "rollback";
		mysql_query( $sql, DbCon );

		echo "error!(regist_staff_data_new:1)";
		exit();

	}

	$staff_id = mysql_insert_id();

	if ( is_uploaded_file($tmp_pic_url) == TRUE ) {

		if( $file_name != "" ){

			$folder_name = ROOT_PATH."img/driver/".$staff_id;

			if(!(is_dir( $folder_name ))){

				umask(0);
				mkdir( $folder_name, 0777 );

			}

			$pic_url = $folder_name."/".$file_name;
			$img_url = "img/driver/".$staff_id."/".$file_name;

			if(move_uploaded_file($tmp_pic_url,$pic_url)){

				$sql = sprintf("
update staff_new_new set car_image_url='%s' where id='%s'",
$img_url,$staff_id);

				//echo $sql;exit();

				$res = mysql_query($sql, DbCon);

				if($res == false){

					//ロールバック
					$sql = "rollback";
					mysql_query( $sql, DbCon );

					echo "error!(regist_staff_data_new:2)";
					exit();

				}

			}else{

				//ロールバック
				$sql = "rollback";
				mysql_query( $sql, DbCon );

				echo "error!(regist_staff_data_new:3)";
				exit();

			}

		}

	}

	//コミット
	$sql = "commit";
	mysql_query( $sql, DbCon );

	return true;
	exit();
}

//スタッフIDからスタッフデータを取得
function get_staff_info_by_staff_id_new($staff_id){

	$sql = sprintf("select * from staff_new_new where id='%s'",$staff_id);

	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_staff_info_by_staff_id_new)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();

}

//スタッフ情報更新
function update_staff_data_new(
$staff_id,$name,$mail,$tel,$kenmu,$not_num_flg,$car_type,$car_color,$car_number,$tmp_pic_url,$file_name,
$car_image_url,$boss_flg,$pay_hour,$pay_fix,$fuel,$address,$bank_info,$name_furi,$furikomi_type,
$shayousha_flg,$name_man,$type_man,$password_man){

	if( $pay_hour == "-1" ){

		$pay_hour = 0;

	}

	if( $fuel == "-1" ){

		$fuel = 0;

	}

	$kenmu_string = get_kenmu_string($kenmu);

	if ( is_uploaded_file($tmp_pic_url) == TRUE ) {

		if( $file_name != "" ){

			$folder_name = ROOT_PATH."img/driver/".$staff_id;

			if(!(is_dir( $folder_name ))){

				umask(0);
				mkdir( $folder_name, 0777 );

			}

			$pic_url = $folder_name."/".$file_name;
			$img_url = "img/driver/".$staff_id."/".$file_name;

			//同名のファイルはあらかじめ削除
			unlink($pic_url);

			if(move_uploaded_file($tmp_pic_url,$pic_url)){

				$car_image_url = $img_url;

			}else{

				echo "error!(update_staff_data_new:1)";
				exit();

			}

		}

	}

	// 会員情報を更新するSQL文
	$sql = sprintf("
update staff_new_new
set
name='%s',
mail='%s',
tel='%s',
kenmu='%s',
not_num_flg='%s',
boss_flg='%s',
car_type='%s',
car_color='%s',
car_number='%s',
car_image_url='%s',
pay_hour='%s',
pay_fix='%s',
fuel='%s',
address='%s',
bank_info='%s',
name_furi='%s',
furikomi_type='%s',
shayousha_flg='%s',
name_man='%s',
type_man='%s',
password_man='%s'
where id='%s'",
$name,$mail,$tel,$kenmu_string,$not_num_flg,$boss_flg,$car_type,$car_color,$car_number,
$car_image_url,$pay_hour,$pay_fix,$fuel,$address,$bank_info,$name_furi,$furikomi_type,
$shayousha_flg,$name_man,$type_man,$password_man,$staff_id);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(update_staff_data_new:2)";
		exit();

	}

	return true;
	exit();

}

function get_staff_data_for_staff_calendar($type,$area){

	$sql = sprintf("
select * from staff_new_new where
delete_flg='0' and
leave_flg='0' and
calendar_disp_flg='1' and
type='%s' and
area='%s'
order by order_num desc",
$type,$area);

	$res = mysql_query($sql, DbCon);
	if($res == false){

		echo "error!(get_staff_data_for_staff_calendar)";
		exit();

	}

	$i=0;
	$list_data = array();
	while($row = mysql_fetch_assoc($res)){

		$list_data[$i] = $row;
		$i++;

	}

	if( ( $type == "driver" ) && ( $area != "tokyo" ) ){

		$where_kenmu = "kenmu like '%".$area."%'";

		$area_tokyo = "tokyo";

		$sql = sprintf("
select * from staff_new_new where delete_flg='0' and leave_flg='0' and area='%s' and type='%s' and %s",$area_tokyo,$type,$where_kenmu);

		$res = mysql_query($sql, DbCon);

		if($res == false){

			echo "error!(get_staff_data_for_staff_calendar)";
			exit();

		}

		while($row = mysql_fetch_assoc($res)){

			$list_data[$i] = $row;
			$i++;

		}

	}

	$hairetsu_name = "order_num";

	$list_data = order_value_sort_hanyou($list_data,$hairetsu_name);

	return $list_data;
	exit();

}

function get_therapist_data_for_therapist_calendar($area,$past_flg){

	$where_kenmu = "kenmu like '%".$area."%'";

	if( $area == "tokyo" ){

		$where_add_tokyo = "area='yokohama' and kensyuu_flg=1";

		$sql = sprintf("
select * from therapist_new where delete_flg=0 and leave_flg=0 and ((area='%s') or (%s) or (%s)) order by order_num desc",
$area,$where_kenmu,$where_add_tokyo);

	}else{

		$sql = sprintf("
select * from therapist_new where delete_flg=0 and leave_flg=0 and ((area='%s') or (%s)) order by order_num desc",
$area,$where_kenmu);

	}

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(get_therapist_data_for_therapist_calendar)";
		exit();

	}

	$therapist_data = array();

	// 一覧に表示される顧客データを変数に格納する処理

	$i=0;

	while($row = mysql_fetch_assoc($res)){

		$therapist_data[$i] = $row;

		$i++;

	}

	$therapist_data = order_value_sort_free($therapist_data);

	return $therapist_data;
	exit();

}

function get_therapist_data_for_therapist_calendar_kensyuu(){

	$sql = sprintf("select * from therapist_new where delete_flg=0 and leave_flg=0 and kensyuu_flg='1' order by order_num desc",$area);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_therapist_data_for_therapist_calendar_kensyuu)";
		exit();
	}

	$therapist_data = array();

	// 一覧に表示される顧客データを変数に格納する処理

	$i=0;

	while($row = mysql_fetch_assoc($res)){

		$therapist_data[$i] = $row;

		$i++;

	}

	return $therapist_data;
	exit();

}

function get_attendance_data_for_staff_calendar($now_month,$next_month,$two_month,$area){

	$sql = sprintf("
select * from attendance_new where (month='%s' or month='%s' or month='%s') and area='%s'",
$now_month,$next_month,$two_month,$area);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(get_attendance_data_for_staff_calendar)";
		exit();

	}

	$attendance_data = array();

	// 一覧に表示される顧客データを変数に格納する処理

	$i=0;

	while($row = mysql_fetch_assoc($res)){

		$attendance_data[$i++] = $row;

	}

	return $attendance_data;
	exit();

}

function get_attendance_data_for_staff_calendar_kensyuu($now_month,$next_month,$two_month){

	$sql = sprintf("
select * from attendance_kensyuu where month='%s' or month='%s' or month='%s'",
$now_month,$next_month,$two_month);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(get_attendance_data_for_staff_calendar_kensyuu)";
		exit();

	}

	$attendance_data = array();

	$i=0;

	while($row = mysql_fetch_assoc($res)){

		$attendance_data[$i++] = $row;

	}

	return $attendance_data;
	exit();

}

//スタッフの出勤データを取得
function get_staff_attendance_data_new($type,$now_month,$next_month,$two_month,$area){

	$now_month = intval($now_month);
	$next_month = intval($next_month);
	$two_month = intval($two_month);

	// 出勤データを取得するためのSQL文
	$sql = sprintf("
select * from attendance_staff_new where (month='%s' or month='%s' or month='%s') and type='%s' and area='%s'",
$now_month,$next_month,$two_month,$type,$area);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(get_staff_attendance_data_new)";
		exit();

	}

	$data = array();

	$i=0;

	while($row = mysql_fetch_assoc($res)){

		$data[$i++] = $row;

	}

	if( ( $type=="driver" ) && ( $area != "tokyo" ) ){

		$where_kenmu = "staff_new_new.kenmu like '%".$area."%'";

		$area_tokyo = "tokyo";

		// 出勤データを取得するためのSQL文(東京の兼務)
		$sql = sprintf("
select
attendance_staff_new.id,
attendance_staff_new.area,
attendance_staff_new.staff_id,
attendance_staff_new.year,
attendance_staff_new.month,
attendance_staff_new.day,
attendance_staff_new.week,
attendance_staff_new.start_time,
attendance_staff_new.end_time,
attendance_staff_new.today_absence,
attendance_staff_new.attendance_adjustment,
staff_new_new.type,
staff_new_new.kenmu
from attendance_staff_new
left join staff_new_new on staff_new_new.id=attendance_staff_new.staff_id
where
attendance_staff_new.area='%s' and
(attendance_staff_new.month='%s' or attendance_staff_new.month='%s' or attendance_staff_new.month='%s') and
(%s)",
$area_tokyo,$now_month,$next_month,$two_month,$where_kenmu);

		//echo $sql;exit();

		$res = mysql_query($sql, DbCon);

		if($res == false){

			echo "error!(get_staff_attendance_data_new)";
			exit();

		}

		while($row = mysql_fetch_assoc($res)){

			$data[$i] = $row;
			$i++;

		}

	}

	return $data;
	exit();

}

//出勤スタッフの数を取得
function get_staff_attendance_num_new($type,$year,$month,$day,$area){

	$sql = sprintf("
select attendance_staff_new.id from attendance_staff_new
left join staff_new_new on staff_new_new.id=attendance_staff_new.staff_id
where staff_new_new.delete_flg='0' and attendance_staff_new.today_absence='0'
and attendance_staff_new.type='%s'
and attendance_staff_new.year='%s'
and attendance_staff_new.month='%s'
and attendance_staff_new.day='%s'
and attendance_staff_new.area='%s'",
$type,$year,$month,$day,$area);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(get_staff_attendance_num_new)";
		exit();

	}

	$num = mysql_num_rows($res);

	//echo $type;
	//exit();

	if( ($type == "driver") && ($area == "yokohama") ){

		$where_kenmu = "staff_new_new.kenmu like '%".$area."%'";

		$area_tokyo = "tokyo";

		$sql = sprintf("
select attendance_staff_new.id from attendance_staff_new
left join staff_new_new on staff_new_new.id=attendance_staff_new.staff_id
where staff_new_new.delete_flg='0' and attendance_staff_new.today_absence='0'
and attendance_staff_new.type='driver'
and attendance_staff_new.year='%s'
and attendance_staff_new.month='%s'
and attendance_staff_new.day='%s'
and attendance_staff_new.area='%s'
and (%s)",
$year,$month,$day,$area_tokyo,$where_kenmu);

		//echo $sql;
		//exit();

		$res = mysql_query($sql, DbCon);

		if($res == false){

			echo "error!(get_staff_attendance_num_new)";
			exit();

		}

		$num2 = mysql_num_rows($res);

		$num = $num + $num2;

	}

	return $num;
	exit();

}

//出勤セラピストの数を取得
function get_therapist_attendance_num_new($year,$month,$day,$area){

/*
$sql = sprintf("
select DISTINCT attendance_new.therapist_id from attendance_new
left join therapist_new on therapist_new.id=attendance_new.therapist_id
where
therapist_new.delete_flg='0' and
therapist_new.leave_flg='0' and
therapist_new.test_flg='0' and
attendance_new.kekkin_flg='0' and
attendance_new.today_absence='0' and
attendance_new.syounin_state='1' and
attendance_new.year='%s' and
attendance_new.month='%s' and
attendance_new.day='%s' and
attendance_new.area='%s' and
therapist_new.rank<>'19'",
$year,$month,$day,$area);
*/

$sql = sprintf("
select DISTINCT attendance_new.therapist_id from attendance_new
left join therapist_new on therapist_new.id=attendance_new.therapist_id
where
therapist_new.delete_flg='0' and
therapist_new.leave_flg='0' and
therapist_new.test_flg='0' and
attendance_new.kekkin_flg='0' and
attendance_new.today_absence='0' and
attendance_new.year='%s' and
attendance_new.month='%s' and
attendance_new.day='%s' and
attendance_new.area='%s' and
therapist_new.rank<>'19'",
$year,$month,$day,$area);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(get_therapist_attendance_num_new)";
		exit();

	}

	$num = mysql_num_rows($res);

	if( $area == "yokohama" ){

		$where_kenmu = "therapist_new.kenmu like '%".$area."%'";

		$area_tokyo = "tokyo";

		$sql = sprintf("
select
DISTINCT attendance_new.therapist_id
from attendance_new
left join therapist_new on therapist_new.id=attendance_new.therapist_id
where
therapist_new.delete_flg='0' and
therapist_new.leave_flg='0' and
therapist_new.test_flg='0' and
attendance_new.today_absence='0' and
attendance_new.year='%s' and
attendance_new.month='%s' and
attendance_new.day='%s' and
(%s) and
attendance_new.charge_area=2 and
attendance_new.area='%s' and
therapist_new.rank<>'19'",
$year,$month,$day,$where_kenmu,$area_tokyo);

		/*
		if(($year=="2014")&&($month=="7")&&($day=="3")&&($area=="yokohama")){
			echo $sql;exit();
		}
		*/

		$res = mysql_query($sql, DbCon);

		if($res == false){

			echo "error!(get_therapist_attendance_num_new)";
			exit();

		}

		$num2 = mysql_num_rows($res);

		$num = $num + $num2;

	}

	return $num;
	exit();

}

//出勤セラピストの数を取得(研修)
function get_therapist_attendance_num_kensyuu($year,$month,$day){

	$sql = sprintf("
select DISTINCT attendance_kensyuu.therapist_id from attendance_kensyuu
left join therapist_new on therapist_new.id=attendance_kensyuu.therapist_id
where
therapist_new.delete_flg='0' and
therapist_new.leave_flg='0' and
therapist_new.test_flg='0' and
attendance_kensyuu.year='%s' and
attendance_kensyuu.month='%s' and
attendance_kensyuu.day='%s'",
$year,$month,$day);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(get_therapist_attendance_num_kensyuu)";
		exit();

	}

	$num = mysql_num_rows($res);

	return $num;
	exit();

}

//出勤情報を登録
function regist_attendance_data_therapist_new(
$therapist_id,$year,$month,$day,$week,$start_time,$end_time,$comment,$publish_flg,$att_area){

	//まず削除をする(出勤データ二重登録の防止)
	delete_attendance_data_by_therapist_id($therapist_id,$year,$month,$day);

	//トランザクションをはじめる準備
	$sql = "set autocommit = 0";
	mysql_query( $sql, DbCon );

	//トランザクション開始
	$sql = "begin";
	mysql_query( $sql, DbCon );

	$syounin_state = "1";

	$now = time();

	$syori_basyo = "calendar_regist";

	$sql = sprintf("
insert into attendance_new(
therapist_id,year,month,day,week,start_time,end_time,area,comment,syounin_state,
created,updated,syori_basyo,publish_flg)
values('%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s')",
$therapist_id,$year,$month,$day,$week,
$start_time,$end_time,$att_area,$comment,$syounin_state,$now,$now,$syori_basyo,$publish_flg);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		//ロールバック
		$sql = "rollback";
		mysql_query( $sql, DbCon );
		echo "クエリ実行に失敗しました(regist_attendance_data_therapist_new)";
		exit();
	}

	$insert_id = mysql_insert_id();

	$sql = sprintf("
insert into attendance_new_small(
therapist_id,year,month,day,week,start_time,end_time,area,comment,syounin_state,
created,updated,syori_basyo,publish_flg)
values('%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s')",
$therapist_id,$year,$month,$day,$week,
$start_time,$end_time,$att_area,$comment,$syounin_state,$now,$now,$syori_basyo,$publish_flg);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		//ロールバック
		$sql = "rollback";
		mysql_query( $sql, DbCon );
		echo "クエリ実行に失敗しました(regist_attendance_data_therapist_new)";
		exit();
	}

	//コミット
	$sql = "commit";
	mysql_query( $sql, DbCon );

	return $insert_id;
	exit();
}

//出勤情報を登録
function regist_attendance_data_therapist_kensyuu(
$therapist_id,$day_year,$day_month,$day_day,$start_time,$end_time,$work_flg,$start_time_work,$end_time_work){

	//セラピストIDからエリアを取得
	$area = get_area_from_therapist_new_by_therapist_id($therapist_id);

	$day_week = get_week_value($day_year,$day_month,$day_day);

	//トランザクションをはじめる準備
	$sql = "set autocommit = 0";
	mysql_query( $sql, DbCon );

	//トランザクション開始
	$sql = "begin";
	mysql_query( $sql, DbCon );

	$now = time();

	if( ($start_time_work != "-1") && ($end_time_work != "-1") && ($work_flg == "1") ){

		$result = attendance_data_exist_check($therapist_id,$day_year,$day_month,$day_day);

		$syounin_state = "1";

		if( $result == false ){

			$syori_basyo = "kensyuu_regist_insert";

			// 出勤情報を登録するSQL文
			$sql = sprintf("
insert into attendance_new(
therapist_id,year,month,day,week,start_time,end_time,area,syounin_state,created,updated,syori_basyo)
values('%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s')",
$therapist_id,
$day_year,
$day_month,
$day_day,
$day_week,
$start_time_work,
$end_time_work,
$area,
$syounin_state,
$now,$now,
$syori_basyo);

		}else{

			$syori_basyo = "kensyuu_regist_update";

			$sql = sprintf("
update attendance_new set
start_time='%s',
end_time='%s',
area='%s',
syounin_state='%s',
updated='%s',
syori_basyo='%s'
where
therapist_id='%s' and
year='%s' and
month='%s' and
day='%s'",
$start_time_work,$end_time_work,$area,$syounin_state,
$now,$syori_basyo,$therapist_id,$day_year,$day_month,$day_day);

		}

		$res = mysql_query($sql, DbCon);
		if($res == false){
			//ロールバック
			$sql = "rollback";
			mysql_query( $sql, DbCon );

			echo "クエリ実行に失敗しました(regist_attendance_data_therapist_kensyuu:1)";
			exit();

		}

	}

	// 出勤情報を登録するSQL文
	$sql = sprintf("
insert into attendance_kensyuu(
therapist_id,year,month,day,start_time,end_time,area,work_flg)
values('%s','%s','%s','%s','%s','%s','%s','%s')",
$therapist_id,$day_year,$day_month,$day_day,$start_time,$end_time,$area,$work_flg);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);
	if($res == false){

		//ロールバック
		$sql = "rollback";
		mysql_query( $sql, DbCon );

		echo "クエリ実行に失敗しました(regist_attendance_data_therapist_kensyuu:2)";
		exit();

	}

	$insert_id = mysql_insert_id();

	//コミット
	$sql = "commit";
	mysql_query( $sql, DbCon );

	return $insert_id;
	exit();
}

//出勤情報を登録
function regist_attendance_data_therapist_kensyuu_all($year,$month,$day,$start_time,$end_time){

	//データ存在のチェック
	$return_id = check_attendance_kensyuu_all_data_exist_return_id($year,$month,$day);

	if( $return_id == false ){

		// 出勤情報を登録するSQL文
		$sql = sprintf("
insert into attendance_kensyuu_all(
year,month,day,start_time,end_time)
values('%s','%s','%s','%s','%s')",
$year,$month,$day,$start_time,$end_time);

		//echo $sql;exit();

		$res = mysql_query($sql, DbCon);
		if($res == false){
			echo "クエリ実行に失敗しました(regist_attendance_data_therapist_kensyuu_all)";
			exit();
		}

		$insert_id = mysql_insert_id();

		return $insert_id;
		exit();

	}else{

		$sql = sprintf("
update attendance_kensyuu_all set start_time='%s',end_time='%s' where year='%s' and month='%s' and day='%s'",
$start_time,$end_time,$year,$month,$day);

		$res = mysql_query($sql, DbCon);

		if($res == false){
			echo "クエリ実行に失敗しました(regist_attendance_data_therapist_kensyuu_all)";
			exit();
		}

		return $return_id;
		exit();

	}

}

//セラピスト情報の取得
function get_therapist_data_for_attendance_new($area,$day_year,$day_month,$day_day){

	$sql = sprintf("select * from therapist_new where delete_flg='0' and leave_flg=0 and area='%s'",$area);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_therapist_data_for_attendance_new)";
		exit();
	}

	$i=0;

	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$therapist_id = $row["id"];

		//出席データが登録済みであるかどうか(登録済み：true,未登録:false)
		$result = check_therapist_attendance_exist_new($therapist_id,$day_year,$day_month,$day_day,$area);

		if($result==false){

			$list_data[$i] = $row;
			$i++;

		}

	}

	if( $area == "yokohama" ){

		$where_kenmu = "kenmu like '%".$area."%'";

		$area_tokyo = "tokyo";

		$sql = sprintf("
select * from therapist_new where delete_flg='0' and leave_flg=0 and (%s) and area='%s'",
$where_kenmu,$area_tokyo);

		$res = mysql_query($sql, DbCon);

		if($res == false){

			echo "error!(get_therapist_data_for_attendance_new)";
			exit();

		}

		while($row = mysql_fetch_assoc($res)){

			$therapist_id = $row["id"];

			$area = "tokyo";

			//出席データが登録済みであるかどうか(登録済み：true,未登録:false)
			$result = check_therapist_attendance_exist_new($therapist_id,$day_year,$day_month,$day_day,$area);

			if($result==false){

				$list_data[$i] = $row;
				$list_data[$i]["area"] = $area;
				$i++;

			}

		}

	}

	return $list_data;
	exit();

}

//セラピスト情報の取得
function get_therapist_data_for_attendance_kensyuu($day_year,$day_month,$day_day){

	$sql = "select * from therapist_new where delete_flg='0' and leave_flg=0 and kensyuu_flg='1'";
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_therapist_data_for_attendance_kensyuu)";
		exit();
	}

	$i=0;

	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$therapist_id = $row["id"];

		//出席データが登録済みであるかどうか(研修)(登録済み：true,未登録:false)
		$result = check_therapist_attendance_exist_kensyuu($therapist_id,$day_year,$day_month,$day_day);

		if($result==false){

			$list_data[$i] = $row;
			$i++;

		}

	}

	return $list_data;
	exit();

}

//出席データが登録済みであるかどうか(登録済み：true,未登録:false)
function check_therapist_attendance_exist_new($therapist_id,$day_year,$day_month,$day_day,$area){

	$sql = sprintf("
select id from attendance_new where therapist_id='%s' and year='%s' and month='%s' and day='%s'",
$therapist_id,$day_year,$day_month,$day_day);

	//echo $sql;
	//exit();

	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(check_therapist_attendance_exist_new)";
		exit();
	}
	$num = mysql_num_rows($res);

	if( $num > 0 ){

		return true;
		exit();

	}else{

		return false;
		exit();

	}

}

//出席データが登録済みであるかどうか(研修)(登録済み：true,未登録:false)
function check_therapist_attendance_exist_kensyuu($therapist_id,$day_year,$day_month,$day_day){

	$sql = sprintf("
select id from attendance_kensyuu where therapist_id='%s' and year='%s' and month='%s' and day='%s'",
$therapist_id,$day_year,$day_month,$day_day);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(check_therapist_attendance_exist_kensyuu)";
		exit();
	}
	$num = mysql_num_rows($res);

	if( $num > 0 ){

		return true;
		exit();

	}else{

		return false;
		exit();

	}

}

//出席データの取得
function get_attendance_data_by_attendance_id_new($attendance_id,$area){

	$sql = sprintf("
select
therapist_new.id as therapist_id,
therapist_new.name_site,
attendance_new.start_time,
attendance_new.end_time,
attendance_new.year,
attendance_new.month,
attendance_new.day,
attendance_new.week,
attendance_new.today_absence,
attendance_new.attendance_adjustment,
attendance_new.charge_area,
attendance_new.syounin_state,
attendance_new.publish_flg,
attendance_new.comment
from attendance_new
left join therapist_new on therapist_new.id=attendance_new.therapist_id
where attendance_new.id='%s'",
$attendance_id);

	//echo $sql;
	//exit();

	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリ実行に失敗しました(get_attendance_data_by_attendance_id_new)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();

}

//出席データの取得
function get_attendance_data_by_attendance_id_kensyuu($attendance_id){

	$sql = sprintf("
select
therapist_new.id as therapist_id,
therapist_new.name_site,
attendance_kensyuu.start_time,
attendance_kensyuu.end_time,
attendance_kensyuu.year,
attendance_kensyuu.month,
attendance_kensyuu.day,
attendance_kensyuu.work_flg
from attendance_kensyuu
left join therapist_new on therapist_new.id=attendance_kensyuu.therapist_id
where attendance_kensyuu.id='%s'",
$attendance_id);

	//echo $sql;
	//exit();

	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリ実行に失敗しました(get_attendance_data_by_attendance_id_kensyuu)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();

}

//出席データの取得
function get_attendance_data_by_attendance_id_kensyuu_all($attendance_id){

	$sql = sprintf("
select
start_time,
end_time,
year,
month,
day
from attendance_kensyuu_all
where id='%s'",
$attendance_id);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリ実行に失敗しました(get_attendance_data_by_attendance_id_kensyuu_all)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();

}

//出勤データのコピー(NEW)
function copy_attendance_data_therapist_new($attendance_id,$year,$month,$day,$week,$area){

	//出勤データIDからセラピストIDを取得(NEW)
	$therapist_id = get_therapist_id_by_attendance_id_new($attendance_id,$area);

	//出勤データが登録済みかどうか(登録済み:attendance_id,未登録:false)(NEW)
	$check_result = check_therapist_attendance_exist_2_new($therapist_id, $year, $month, $day,$area);

	if( $check_result == "-1" ){

		return false;
		exit();

	}

	//出席データの取得(NEW)
	$data = get_attendance_data_by_attendance_id_2_new($attendance_id,$area);

	if( $data == false ){

		return false;
		exit();

	}

	$therapist_id = $data["therapist_id"];
	$start_time = $data["start_time"];
	$end_time = $data["end_time"];
	$publish_flg = $data["publish_flg"];


	//トランザクションをはじめる準備
	$sql = "set autocommit = 0";
	mysql_query( $sql, DbCon );

	//トランザクション開始
	$sql = "begin";
	mysql_query( $sql, DbCon );

	$syounin_state = "1";

	$now = time();

	$syori_basyo = "calendar_copy";

	if( $check_result == false ){

		//インサートのsql
		$sql = sprintf("
insert into attendance_new(
therapist_id,year,month,day,week,start_time,end_time,area,syounin_state,created,updated,syori_basyo,publish_flg)
values('%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s')",
$therapist_id,$year,$month,$day,$week,$start_time,$end_time,$area,$syounin_state,$now,$now,$syori_basyo,$publish_flg);
		$res = mysql_query($sql, DbCon);
		if($res == false){
			//ロールバック
			$sql = "rollback";
			mysql_query( $sql, DbCon );
			return false;
			exit();
		}

		//インサートのsql
		$sql = sprintf("
insert into attendance_new_small(
therapist_id,year,month,day,week,start_time,end_time,area,syounin_state,created,updated,syori_basyo,publish_flg)
values('%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s')",
$therapist_id,$year,$month,$day,$week,$start_time,$end_time,$area,$syounin_state,$now,$now,$syori_basyo,$publish_flg);
		$res = mysql_query($sql, DbCon);
		if($res == false){
			//ロールバック
			$sql = "rollback";
			mysql_query( $sql, DbCon );
			return false;
			exit();
		}

	}else{

		//$attendance_id = $check_result;

		//更新のsql
		$sql = sprintf("
update
attendance_new
set
area='%s',
start_time='%s',
end_time='%s',
syounin_state='%s',
syori_basyo='%s'
where
therapist_id='%s' and
year='%s' and
month='%s' and
day='%s'",
$area,$start_time,$end_time,$syounin_state,$syori_basyo,$therapist_id,$year,$month,$day);
		$res = mysql_query($sql, DbCon);
		if($res == false){
			//ロールバック
			$sql = "rollback";
			mysql_query( $sql, DbCon );
			return false;
			exit();
		}

		//更新のsql
		$sql = sprintf("
update
attendance_new_small
set
area='%s',
start_time='%s',
end_time='%s',
syounin_state='%s',
syori_basyo='%s'
where
therapist_id='%s' and
year='%s' and
month='%s' and
day='%s'",
$area,$start_time,$end_time,$syounin_state,$syori_basyo,$therapist_id,$year,$month,$day);
		$res = mysql_query($sql, DbCon);
		if($res == false){
			//ロールバック
			$sql = "rollback";
			mysql_query( $sql, DbCon );
			return false;
			exit();
		}

	}

	//コミット
	$sql = "commit";
	mysql_query( $sql, DbCon );

	return true;
	exit();
}

//出勤データのコピー(研修)
function copy_attendance_data_therapist_kensyuu($attendance_id,$year,$month,$day){

	//出勤データIDからセラピストIDを取得(研修)
	$therapist_id = get_therapist_id_by_attendance_id_kensyuu($attendance_id);

	//出勤データが登録済みかどうか(登録済み:attendance_id,未登録:false)(研修)
	$check_result = check_therapist_attendance_exist_2_kensyuu($therapist_id, $year, $month, $day);

	//セラピストIDからエリアを取得
	$area = get_area_from_therapist_new_by_therapist_id($therapist_id);

	if( $check_result == "-1" ){

		return false;
		exit();

	}

	//出席データの取得(研修)
	$data = get_attendance_data_by_attendance_id_2_kensyuu($attendance_id);

	if( $data == false ){

		return false;
		exit();

	}

	$therapist_id = $data["therapist_id"];
	$start_time = $data["start_time"];
	$end_time = $data["end_time"];

	$charge_area = $data["charge_area"];

	$syounin_state = "1";

	$now = time();

	$syori_basyo = "calendar_copy";

	if( $check_result == false ){

		//インサートのsql
		$sql = sprintf("
insert into attendance_kensyuu(
therapist_id,year,month,day,start_time,end_time,area)
values('%s','%s','%s','%s','%s','%s','%s')",
$therapist_id,$year,$month,$day,$start_time,$end_time,$area);

		//echo $sql;exit();

	}else{

		$attendance_id = $check_result;

		//更新のsql
		$sql = sprintf("
update
attendance_kensyuu
set
start_time='%s',
end_time='%s'
where
therapist_id='%s' and
year='%s' and
month='%s' and
day='%s'",
$start_time,$end_time,$therapist_id,$year,$month,$day);

		//echo $sql;exit();

	}

	$res = mysql_query($sql, DbCon);
	if($res == false){

		return false;
		exit();

	}

	return true;
	exit();

}

//出勤データのコピー(研修)
function copy_attendance_data_therapist_kensyuu_all($attendance_id,$year,$month,$day){

	//出勤データが登録済みかどうか(登録済み:attendance_id,未登録:false)(研修)
	$check_result = check_therapist_attendance_exist_2_kensyuu_all($year, $month, $day);

	if( $check_result == "-1" ){
		return false;
		exit();
	}

	//出席データの取得(研修)
	$data = get_attendance_data_by_attendance_id_2_kensyuu_all($attendance_id);

	if( $data == false ){
		return false;
		exit();
	}

	$start_time = $data["start_time"];
	$end_time = $data["end_time"];

	$now = time();

	if( $check_result == false ){

		//インサートのsql
		$sql = sprintf("
insert into attendance_kensyuu_all(
year,month,day,start_time,end_time)
values('%s','%s','%s','%s','%s')",
$year,$month,$day,$start_time,$end_time);

		//echo $sql;exit();

	}else{

		$attendance_id = $check_result;

		//更新のsql
		$sql = sprintf("
update
attendance_kensyuu_all
set
start_time='%s',
end_time='%s'
where
year='%s' and
month='%s' and
day='%s'",
$start_time,$end_time,$year,$month,$day);

		//echo $sql;exit();

	}

	$res = mysql_query($sql, DbCon);
	if($res == false){

		return false;
		exit();

	}

	return true;
	exit();

}

//出勤データIDからセラピストIDを取得(NEW)
function get_therapist_id_by_attendance_id_new($attendance_id,$area){

	$sql = sprintf("select therapist_id from attendance_new where id='%s'",$attendance_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		return false;
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row["therapist_id"];
	exit();

}

//出勤データIDからセラピストIDを取得(研修)
function get_therapist_id_by_attendance_id_kensyuu($attendance_id){

	$sql = sprintf("select therapist_id from attendance_kensyuu where id='%s'",$attendance_id);
	$res = mysql_query($sql, DbCon);
	if( $res == false ){
		return false;
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row["therapist_id"];
	exit();

}

//出勤データIDからセラピストIDを取得(NEW)(NEW)
function get_therapist_id_by_attendance_id_new_new($attendance_id,$area){

	$sql = sprintf("select therapist_id from attendance_new where id='%s'",$attendance_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		return false;
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row["therapist_id"];
	exit();

}

//出席データが登録済みであるかどうか(登録済み：attendance_id,未登録:false)(NEW)
function check_therapist_attendance_exist_2_new($therapist_id,$day_year,$day_month,$day_day,$area){

	$sql = sprintf("
select id from attendance_new where therapist_id='%s' and year='%s' and month='%s' and day='%s'",
$therapist_id,$day_year,$day_month,$day_day);

	//echo $sql;
	//exit();

	$res = mysql_query($sql, DbCon);
	if($res == false){

		return "-1";
		exit();

	}
	$num = mysql_num_rows($res);

	if( $num > 1 ){

		return "-1";
		exit();

	}else if( $num == 1 ){

		$row = mysql_fetch_assoc($res);
		return $row["id"];
		exit();

	}else{

		return false;
		exit();

	}

}

//出席データが登録済みであるかどうか(登録済み：attendance_id,未登録:false)(研修)
function check_therapist_attendance_exist_2_kensyuu($therapist_id,$day_year,$day_month,$day_day){

	$sql = sprintf("
select id from attendance_kensyuu where therapist_id='%s' and year='%s' and month='%s' and day='%s'",
$therapist_id,$day_year,$day_month,$day_day);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);
	if($res == false){

		return "-1";
		exit();

	}
	$num = mysql_num_rows($res);

	if( $num > 1 ){

		return "-1";
		exit();

	}else if( $num == 1 ){

		$row = mysql_fetch_assoc($res);
		return $row["id"];
		exit();

	}else{

		return false;
		exit();

	}

}

//出席データが登録済みであるかどうか(登録済み：attendance_id,未登録:false)(研修)
function check_therapist_attendance_exist_2_kensyuu_all($day_year,$day_month,$day_day){

	$sql = sprintf("
select id from attendance_kensyuu_all where year='%s' and month='%s' and day='%s'",
$day_year,$day_month,$day_day);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);
	if($res == false){

		return "-1";
		exit();

	}
	$num = mysql_num_rows($res);

	if( $num > 1 ){

		return "-1";
		exit();

	}else if( $num == 1 ){

		$row = mysql_fetch_assoc($res);
		return $row["id"];
		exit();

	}else{

		return false;
		exit();

	}

}

//研修データが登録済みであるかどうか
function check_kensyuu_data_exist($year,$month,$day){

	$sql = sprintf("
select id from attendance_kensyuu_all where delete_flg=0 and year='%s' and month='%s' and day='%s'",
$year,$month,$day);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(check_kensyuu_data_exist)";
		exit();

	}

	$num = mysql_num_rows($res);

	if( $num > 0 ){

		return true;

	}else{

		return false;
		exit();

	}

}

//出席データの取得(NEW)
function get_attendance_data_by_attendance_id_2_new($attendance_id,$area){

	$sql = sprintf("select * from attendance_new where id='%s'",$attendance_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		return false;
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();
}

//出席データの取得(Ver.3)
function get_attendance_data_by_attendance_id_3($attendance_id){

	$sql = sprintf("select * from attendance_new where id='%s'",$attendance_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_attendance_data_by_attendance_id_3)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();
}

//出席データの取得(研修)
function get_attendance_data_by_attendance_id_2_kensyuu($attendance_id){

	$sql = sprintf("select * from attendance_kensyuu where id='%s'",$attendance_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		return false;
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();
}

//出席データの取得(研修)
function get_attendance_data_by_attendance_id_2_kensyuu_all($attendance_id){

	$sql = sprintf("select * from attendance_kensyuu_all where id='%s'",$attendance_id);

	$res = mysql_query($sql, DbCon);
	if($res == false){
		return false;
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();
}

//出勤情報を登録(スタッフ)(NEW)
function regist_attendance_data_staff_new($staff_id,$type,$day_year,$day_month,$day_day,$day_week,$start_time,$end_time,$area,$charge_area){

	if( ($charge_area=="") || ($charge_area=="0") ){

		$charge_area = "-1";

	}

	$staff_id_array = explode("_", $staff_id);

	$staff_id = $staff_id_array[0];
	$staff_area = $staff_id_array[1];

	// 出勤情報を登録するSQL文
	$sql = sprintf("
insert into attendance_staff_new(staff_id,type,year,month,day,week,start_time,end_time,area,charge_area)
values('%s','%s','%s','%s','%s','%s','%s','%s','%s','%s')",
$staff_id,$type,$day_year,$day_month,$day_day,$day_week,$start_time,$end_time,$area,$charge_area);

	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(regist_attendance_data_staff_new)";
		exit();
	}

	$insert_id = mysql_insert_id();

	return $insert_id;
	exit();

}

//スタッフ情報の取得(NEW)
function get_staff_data_for_attendance_new($type,$day_year,$day_month,$day_day,$area){

	$sql = sprintf("select * from staff_new_new where delete_flg='0' and leave_flg='0' and type='%s' and area='%s'",$type,$area);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_staff_data_for_attendance_new)";
		exit();
	}

	$i=0;
	$list_data = array();
	while($row = mysql_fetch_assoc($res)){

		$staff_id = $row["id"];

		//出席データが登録済みであるかどうか(登録済み：true,未登録:false)
		$result = check_staff_attendance_exist_new($staff_id,$day_year,$day_month,$day_day,$area);

		if($result==false){

			$list_data[$i] = $row;
			$i++;

		}

	}

	if( ($area == "yokohama") && ($type == "driver") ){

		$where_kenmu = "kenmu like '%".$area."%'";

		$area_tokyo = "tokyo";

		$sql = sprintf("
select * from staff_new_new where delete_flg='0' and leave_flg='0' and type='driver' and (%s) and area='%s'",
$where_kenmu,$area_tokyo);

		$res = mysql_query($sql, DbCon);
		if($res == false){

			echo "error!(get_staff_data_for_attendance_new)";
			exit();

		}

		while($row = mysql_fetch_assoc($res)){

			$staff_id = $row["id"];

			//出席データが登録済みであるかどうか(登録済み：true,未登録:false)
			$result = check_staff_attendance_exist_new($staff_id,$day_year,$day_month,$day_day,$area);

			if($result==false){

				$list_data[$i] = $row;
				$i++;

			}

		}

	}

	return $list_data;
	exit();

}

//出席データが登録済みであるかどうか(登録済み：true,未登録:false)(NEW)
function check_staff_attendance_exist_new($staff_id,$day_year,$day_month,$day_day,$area){

	$sql = sprintf("select id from attendance_staff_new where staff_id='%s' and year='%s' and month='%s' and day='%s' and area='%s'",$staff_id,$day_year,$day_month,$day_day,$area);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(check_staff_attendance_exist_new)";
		exit();
	}
	$num = mysql_num_rows($res);

	if( $num > 0 ){

		return true;
		exit();

	}else{

		return false;
		exit();

	}
}

//出席データの取得(スタッフ)(NEW)
function get_attendance_data_by_attendance_id_staff_new($attendance_id,$staff_area){

	$sql = sprintf("
select
staff_new_new.id as staff_id,
staff_new_new.name,
attendance_staff_new.start_time,
attendance_staff_new.end_time,
attendance_staff_new.year,
attendance_staff_new.month,
attendance_staff_new.day,
attendance_staff_new.week,
attendance_staff_new.today_absence,
attendance_staff_new.attendance_adjustment,
attendance_staff_new.type,
attendance_staff_new.charge_area,
attendance_staff_new.not_board_display_flg
from attendance_staff_new
left join staff_new_new on staff_new_new.id=attendance_staff_new.staff_id
where
attendance_staff_new.id='%s'",
$attendance_id);

	//echo $sql;
	//exit();

	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_attendance_data_by_attendance_id_staff_new)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();

}

//出勤データのコピー(スタッフ)(NEW)
function copy_attendance_data_staff_new($attendance_id,$year,$month,$day,$week,$type,$area){

	//出勤データIDからスタッフIDを取得(NEW)
	$staff_id = get_staff_id_by_attendance_id_new($attendance_id,$area);

	//出席データが登録済みであるかどうか(登録済み：attendance_id,未登録:false)(スタッフ)(NEW)
	$check_result = check_staff_attendance_exist_2_new($staff_id, $year, $month, $day,$area);

	if( $check_result == "-1" ){

		$messe = "error!(copy_attendance_data_staff_new:1)";
		man_error_log($messe);

		return false;
		exit();

	}

	//出席データの取得(スタッフ)(NEW)
	$data = get_attendance_data_by_attendance_id_2_staff_new($attendance_id,$area);

	if( $data == false ){

		$messe = "error!(copy_attendance_data_staff_new:2)";
		man_error_log($messe);

		return false;
		exit();

	}

	/*
	 echo "<pre>";
	print_r($data);
	echo "</pre>";
	exit();
	*/

	$staff_id = $data["staff_id"];
	$start_time = $data["start_time"];
	$end_time = $data["end_time"];
	$charge_area = $data["charge_area"];

	if( $check_result == false ){

		//インサートのsql
		$sql = sprintf("
insert into attendance_staff_new(staff_id,type,year,month,day,week,start_time,end_time,area)
values('%s','%s','%s','%s','%s','%s','%s','%s','%s')",
$staff_id,$type,$year,$month,$day,$week,$start_time,$end_time,$area);

		//echo $sql;
		//exit();

	}else{

		$attendance_id = $check_result;

		//更新のsql
		$sql = sprintf("
update attendance_staff_new set year='%s',month='%s',day='%s',week='%s',start_time='%s',end_time='%s',area='%s'
where id='%s'",
$year,$month,$day,$week,$start_time,$end_time,$area,$attendance_id);

		//echo $sql;
		//exit();

	}

	$res = mysql_query($sql, DbCon);
	if($res == false){

		$messe = "error!(copy_attendance_data_staff_new:3)";
		man_error_log($messe);

		return false;
		exit();

	}

	return true;
	exit();

}

//出勤データIDからスタッフIDを取得(NEW)
function get_staff_id_by_attendance_id_new($attendance_id,$area){

	$sql = sprintf("select staff_id from attendance_staff_new where id='%s'",$attendance_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		return false;
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row["staff_id"];
	exit();

}

//出席データが登録済みであるかどうか(登録済み：attendance_id,未登録:false)(スタッフ)(NEW)
function check_staff_attendance_exist_2_new($staff_id,$day_year,$day_month,$day_day,$area){

	$sql = sprintf("
select id from attendance_staff_new where staff_id='%s' and year='%s' and month='%s' and day='%s' and area='%s'",
$staff_id,$day_year,$day_month,$day_day,$area);

	//echo $sql;
	//exit();

	$res = mysql_query($sql, DbCon);
	if($res == false){

		return "-1";
		exit();

	}
	$num = mysql_num_rows($res);

	if( $num > 1 ){

		return "-1";
		exit();

	}else if( $num == 1 ){

		$row = mysql_fetch_assoc($res);
		return $row["id"];
		exit();

	}else{

		return false;
		exit();

	}

}

//出席データの取得(スタッフ)(NEW)
function get_attendance_data_by_attendance_id_2_staff_new($attendance_id,$area){

	$sql = sprintf("select * from attendance_staff_new where id='%s'",$attendance_id);

	$res = mysql_query($sql, DbCon);
	if($res == false){
		return false;
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();

}

//出勤情報を更新(NEW)
function update_attendance_data_therapist_new($attendance_id,$year,$month,$day,$week,$start_time,$end_time,
$area,$today_absence,$attendance_adjustment,$charge_area,$syounin_check,$syounin_state,
$comment,$publish_flg,$att_area){

	if( ($charge_area=="") || ($charge_area=="0") ){

		$charge_area = "-1";

	}

	$therapist_id = get_therapist_id_by_attendance_id_common($attendance_id);
	$week_name = get_week_name_new($year, $month, $day);

	$area_name = get_area_name_by_area_common($area);

	if($syounin_check == "1"){

		$syounin_state = "1";

	}

	//トランザクションをはじめる準備
	$sql = "set autocommit = 0";
	mysql_query( $sql, DbCon );

	//トランザクション開始
	$sql = "begin";
	mysql_query( $sql, DbCon );

	//出勤情報を登録するSQL文
	//更新のsql
	$sql = sprintf("
update attendance_new set
area='%s',
start_time='%s',
end_time='%s',
today_absence='%s',
attendance_adjustment='%s',
charge_area='%s',
syounin_state='%s',
publish_flg='%s',
comment='%s'
where
therapist_id='%s' and
year='%s' and
month='%s' and
day='%s'",
$att_area,$start_time,$end_time,$today_absence,$attendance_adjustment,
$charge_area,$syounin_state,$publish_flg,$comment,$therapist_id,$year,$month,$day);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		//ロールバック
		$sql = "rollback";
		mysql_query( $sql, DbCon );
		echo "error!(update_attendance_data_therapist_new)";
		exit();
	}

	$sql = sprintf("
update attendance_new_small set
area='%s',
start_time='%s',
end_time='%s',
today_absence='%s',
attendance_adjustment='%s',
charge_area='%s',
syounin_state='%s',
publish_flg='%s',
comment='%s'
where
therapist_id='%s' and
year='%s' and
month='%s' and
day='%s'",
$att_area,$start_time,$end_time,$today_absence,$attendance_adjustment,
$charge_area,$syounin_state,$publish_flg,$comment,$therapist_id,$year,$month,$day);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		//ロールバック
		$sql = "rollback";
		mysql_query( $sql, DbCon );
		echo "error!(update_attendance_data_therapist_new)";
		exit();
	}

	if( $syounin_check == "1" ){

		$therapist_name = get_therapist_name_by_therapist_id_honmyou_common($therapist_id);

		$therapist_mail = get_therapist_mail_by_therapist_id($therapist_id);

		$check_url = get_check_url_shift_front($area,$therapist_id);

		$now = time();
		$staff_type = "1";

		$site_name = $area_name."リフレ";

		$message = sprintf("%s/%s(%s)のシフトを承認しました！",$month,$day,$week_name);

		$sql = sprintf("
insert into shift_history(created,area,therapist_id,staff_type,message)
values('%s','%s','%s','%s','%s')",
$now,$area,$therapist_id,$staff_type,$message);

		$res = mysql_query($sql, DbCon);

		if($res == false){

			//ロールバック
			$sql = "rollback";
			mysql_query( $sql, DbCon );

			echo "error!(update_attendance_data_therapist_new)";
			exit();

		}

		mb_language("ja");
		mb_internal_encoding("UTF-8");
		$mailto = $therapist_mail;
		//$mailto = "minamikawa@neo-gate.jp";

		//$title = "シフト承認".$month."月".$day."日【".$site_name."】";
		$title = sprintf("【シフト登録】%s月%s日シフト承認[%s]",$month,$day,$therapist_name);

		$content =<<<EOT
{$therapist_name}さん

{$month}月{$day}日({$week_name})のシフトを確認し了承いたしました。

{$check_url}
EOT;

		$header = "From: info@neo-gate.jp\n";
		$header .= "Bcc: info@neo-gate.jp";
		//$header .= ",";
		//$header .= "minamikawa@neo-gate.jp";

		$result = mb_send_mail($mailto,$title,$content,$header,MAIL_PARAMETER);

		if($result==false){

			//ロールバック
			$sql = "rollback";
			mysql_query( $sql, DbCon );

			echo "error!(update_attendance_data_therapist_new)";
			exit();

		}

	}

	//コミット
	$sql = "commit";
	mysql_query( $sql, DbCon );

	return true;
	exit();
}

//出勤情報を更新(研修)
function update_attendance_data_therapist_kensyuu(
$attendance_id,$year,$month,$day,$start_time,$end_time,$work_flg,$start_time_work,$end_time_work){

	$therapist_id = get_therapist_id_by_attendance_id_kensyuu($attendance_id);
	$week_name = get_week_name_new($year, $month, $day);
	$week = get_week_value($year,$month,$day);

	//セラピストIDからエリアを取得
	$area = get_area_from_therapist_new_by_therapist_id($therapist_id);

	//トランザクションをはじめる準備
	$sql = "set autocommit = 0";
	mysql_query( $sql, DbCon );

	//トランザクション開始
	$sql = "begin";
	mysql_query( $sql, DbCon );

	$now = time();

	if( ($start_time_work != "-1") && ($end_time_work != "-1") && ($work_flg == "1") ){

		$result = attendance_data_exist_check($therapist_id,$year,$month,$day);

		$syounin_state = "1";

		if( $result == false ){

			$syori_basyo = "kensyuu_update_insert";

			// 出勤情報を登録するSQL文
			$sql = sprintf("
insert into attendance_new(
therapist_id,year,month,day,week,start_time,end_time,area,syounin_state,created,updated,syori_basyo)
values('%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s')",
$therapist_id,
$year,
$month,
$day,
$week,
$start_time_work,
$end_time_work,
$area,
$syounin_state,
$now,$now,
$syori_basyo);

		}else{

			$syori_basyo = "kensyuu_update_update";

			$sql = sprintf("
update attendance_new set
start_time='%s',
end_time='%s',
area='%s',
syounin_state='%s',
updated='%s',
syori_basyo='%s'
where
therapist_id='%s' and
year='%s' and
month='%s' and
day='%s'",
$start_time_work,$end_time_work,$area,$syounin_state,
$now,$syori_basyo,$therapist_id,$year,$month,$day);

		}

		$res = mysql_query($sql, DbCon);
		if($res == false){
			//ロールバック
			$sql = "rollback";
			mysql_query( $sql, DbCon );

			echo "error!(update_attendance_data_therapist_kensyuu:1)";
			exit();

		}

	}

	//出勤情報を登録するSQL文
	//更新のsql
	$sql = sprintf("
update attendance_kensyuu set
start_time='%s',
end_time='%s',
work_flg='%s'
where
therapist_id='%s' and
year='%s' and
month='%s' and
day='%s'",
$start_time,$end_time,$work_flg,$therapist_id,$year,$month,$day);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		//ロールバック
		$sql = "rollback";
		mysql_query( $sql, DbCon );

		echo "error!(update_attendance_data_therapist_kensyuu:2)";
		exit();

	}

	//コミット
	$sql = "commit";
	mysql_query( $sql, DbCon );

	return true;
	exit();
}

function delete_therapist_attendance_data_new($attendance_id,$area,$year,$month,$day){

	$therapist_id = get_therapist_id_by_attendance_id_new($attendance_id, $area);

	$sql = sprintf("
delete from attendance_new
where
therapist_id='%s' and
year='%s' and
month='%s' and
day='%s'",
$therapist_id,$year,$month,$day);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(delete_therapist_attendance_data_new)";
		exit();
	}

	return true;
	exit();

}

function delete_therapist_attendance_data_kensyuu($attendance_id,$year,$month,$day){

	$therapist_id = get_therapist_id_by_attendance_id_kensyuu($attendance_id);

	$sql = sprintf("
delete from attendance_kensyuu
where
therapist_id='%s' and
year='%s' and
month='%s' and
day='%s'",
$therapist_id,$year,$month,$day);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(delete_therapist_attendance_data_kensyuu)";
		exit();
	}

	return true;
	exit();

}

//スタッフ名取得(NEW)
function get_staff_name_by_staff_id_new($staff_id,$staff_area){

	$sql = sprintf("select name from staff_new_new where id='%s'",$staff_id);

	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_staff_name_by_staff_id_new)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row["name"];
	exit();

}

//出勤情報を更新(スタッフ)
function update_attendance_data_staff_new(
$attendance_id,$year,$month,$day,$week,$start_time,$end_time,$area,$today_absence,
$attendance_adjustment,$charge_area,$not_board_display_flg){

	if( $charge_area == "" ){

		$charge_area = "-1";

	}

	if( $not_board_display_flg == "" ){

		$not_board_display_flg = "0";

	}

	// 出勤情報を登録するSQL文
	//更新のsql
	$sql = sprintf("
update attendance_staff_new set
year='%s',month='%s',day='%s',week='%s',start_time='%s',end_time='%s',area='%s',today_absence='%s',
attendance_adjustment='%s',charge_area='%s',not_board_display_flg='%s'
where id='%s'",
$year,$month,$day,$week,$start_time,$end_time,$area,$today_absence,
$attendance_adjustment,$charge_area,$not_board_display_flg,$attendance_id);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(update_attendance_data_staff_new)";
		exit();

	}

	return true;
	exit();

}

function delete_staff_attendance_data_new($attendance_id,$staff_area){

	$sql = "delete from attendance_staff_new where id=".$attendance_id;
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(delete_staff_attendance_data_new)";
		exit();
	}

	return true;
	exit();

}

function therapist_regist_input_kenmu_check($kenmu,$check_area){

	$num = count($kenmu);

	for($i=0;$i<$num;$i++){

		if( $kenmu[$i] == $check_area ){

			return true;
			exit();

		}

	}

	return false;
	exit();

}

function get_kenmu_for_disp($kenmu_string){

	if( $kenmu_string == "" ){

		return "---";
		exit();

	}

	$kenmu = explode(",",$kenmu_string);

	$kenmu_string_ja = "";

	$kenmu_num = count($kenmu);

	if( $kenmu_num > 0 ){

		for($i=0;$i<$kenmu_num;$i++){

			$kenmu_string_ja .= get_area_name_by_area($kenmu[$i]);

			if( $i != ($kenmu_num-1) ){

				$kenmu_string_ja .= $kenmu_string_ja.",";

			}

		}

	}

	if( $kenmu_string_ja == "" ){

		$kenmu_string_ja = "---";

	}

	return $kenmu_string_ja;
	exit();

}

function get_kenmu_string($kenmu){

	$kenmu_string = "";

	$kenmu_num = count($kenmu);

	if( $kenmu_num > 0 ){

		for($i=0;$i<$kenmu_num;$i++){

			$kenmu_string .= $kenmu[$i];

			if( $i != ($kenmu_num-1) ){

				$kenmu_string .= $kenmu_string.",";

			}

		}

	}

	return $kenmu_string;
	exit();

}

function get_therapist_data_for_staff_calendar(){

	$sql = "select * from therapist where delete_flag=0 and leave_flg=0 order by rank asc,order_num desc";
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリ実行に失敗しました";
		exit();
	}

	$data = array();

	// 一覧に表示される顧客データを変数に格納する処理
	$i=0;
	while($row = mysql_fetch_assoc($res)){
		$data[$i] = $row;
		$data[$i]["area"] = "tokyo";
		$i++;
	}

	$kenmu = "tokyo";
	$area = "yokohama";

	$where_kenmu = "kenmu like '%".$kenmu."%'";

	$sql = sprintf("select * from therapist_new where delete_flg=0 and leave_flg=0 and area='%s' and (%s) order by order_num desc",
$area,$where_kenmu);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリ実行に失敗しました";
		exit();
	}

	while($row = mysql_fetch_assoc($res)){
		$data[$i++] = $row;
	}

	return $data;
	exit();

}

function get_attendance_data_for_staff_calendar_2($now_month,$next_month,$two_month){

	// 出勤データを取得するためのSQL文
	$sql = sprintf("select * from attendance where month='%s' or month='%s' or month='%s'",$now_month,$next_month,$two_month);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_attendance_data_for_staff_calendar_2)";
		exit();
	}

	$attendance_data = array();

	// 一覧に表示される顧客データを変数に格納する処理
	$i=0;
	while($row = mysql_fetch_assoc($res)){

		$attendance_data[$i] = $row;
		$attendance_data[$i]["area"] = "tokyo";
		$i++;

	}

	$kenmu = "tokyo";

	$where_kenmu = "kenmu like '%".$kenmu."%'";

	$area = "yokohama";

	$sql = sprintf("
select
attendance_new.id,therapist_id,year,month,day,week,start_time,end_time,charge_area,today_absence,attendance_adjustment
from attendance_new
left join therapist_new on therapist_new.id=attendance_new.therapist_id
where (month='%s' or month='%s' or month='%s') and (%s) and therapist_new.area='%s'",
$now_month,$next_month,$two_month,$where_kenmu,$area);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(get_attendance_data_for_staff_calendar_2)";
		//echo $sql;
		exit();

	}

	while($row = mysql_fetch_assoc($res)){

		$attendance_data[$i] = $row;
		$attendance_data[$i]["area"] = "yokohama";
		$i++;

	}

	return $attendance_data;
	exit();

}

//order_value並べ替えの処理
function order_value_sort($data){

	foreach ($data as $key => $val){

		$order_value[$key] = $val['order_value'];

	}
	array_multisort($order_value, SORT_DESC, $data);

	return $data;
	exit();

}

//order_value並べ替えの処理(汎用)
function order_value_sort_hanyou($data,$hairetsu_name){

	foreach ($data as $key => $val){

		$order_value[$key] = $val[$hairetsu_name];

	}
	array_multisort($order_value, SORT_DESC, $data);

	return $data;
	exit();

}

//order_value並べ替えの処理(汎用)(NEW)(SORT_ASC)
function order_value_sort_hanyou_new_asc($data,$hairetsu_name){

	foreach ($data as $key => $val){

		$order_value[$key] = $val[$hairetsu_name];

	}
	array_multisort($order_value, SORT_ASC, $data);

	return $data;
	exit();

}

//order_value並べ替えの処理(FREE)
function order_value_sort_free($data){

	foreach ($data as $key => $val){

		//$rank = $val["rank"];
		$rank_order_num = $val["rank_order_num"];

		$order_num = $val["order_num"];

		//$tmp = 100 - $rank;
		$tmp = 1000 - $rank_order_num;

		$order_value[$key] = ($tmp*1000000)+$order_num;

	}

/*
echo "<pre>";
print_r($order_value);
echo "</pre>";
exit();
*/

	array_multisort($order_value, SORT_DESC, $data);

	return $data;
	exit();

}

//order_value並べ替えの処理(汎用)(NEW)(SORT_DESC)
function order_value_sort_hanyou_new_desc($data,$hairetsu_name){

	foreach ($data as $key => $val){

		$order_value[$key] = $val[$hairetsu_name];

	}
	array_multisort($order_value, SORT_DESC, $data);

	return $data;
	exit();

}

function get_therapist_sapporo_data(){

	$sql = "select * from therapist_sapporo where delete_flg=0 and leave_flg=0 order by rank asc,order_num desc";
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリ実行に失敗しました";
		exit();
	}

	$therapist_data = array();

	// 一覧に表示される顧客データを変数に格納する処理
	$i=0;
	while($row = mysql_fetch_assoc($res)){
		$therapist_data[$i++] = $row;
	}

	return $therapist_data;
	exit();

}

//2ヶ月間、マッチしたcharge_areaの出勤データが存在しているかどうか
function check_charge_area_by_therapist_id($therapist_id,$charge_area,$past_flg){

	$now_hour = intval(date('H'));

	if($past_flg==true){

		if($now_hour <= 6){

			$start_year = intval(date('Y', strtotime('-32 day')));
			$start_month = intval(date('m', strtotime('-32 day')));

		}else{

			$start_year = intval(date('Y', strtotime('-31 day')));
			$start_month = intval(date('m', strtotime('-31 day')));

		}

	}else{

		if($now_hour <= 6){

			$start_year = intval(date('Y', strtotime('-1 day')));
			$start_month = intval(date('m', strtotime('-1 day')));



		}else{

			$start_year = intval(date('Y'));
			$start_month = intval(date('m'));

		}

	}

	$one_later_month = get_next_month($start_month);
	$two_later_month = get_next_month($one_later_month);

	$sql = sprintf("
select attendance.id from attendance
left join therapist on therapist.id=attendance.therapist_id
where year>='%s' and (month='%s' or month='%s' or month='%s') and charge_area='%s' and therapist_id='%s'",
$start_year,$start_month,$one_later_month,$two_later_month,$charge_area,$therapist_id);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(check_charge_area_by_therapist_id)";
		exit();

	}

	$num = mysql_num_rows($res);

	//echo $num;
	//exit();

	if( $num > 0 ){

		return true;
		exit();

	}else{

		return false;
		exit();

	}

}

function get_next_month($month){

	$month = $month + 1;

	if( $month == 13 ){

		$month = 1;

	}

	return $month;
	exit();

}

function get_url_name_by_station_id($id){

	$sql = sprintf("select url_name from station where id='%s'",$id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_url_name_by_station_id)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row["url_name"];
	exit();
}

function get_url_name_by_station_id_new($id){

	$sql = sprintf("select url_name from station_new where id='%s'",$id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_url_name_by_station_id_new)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row["url_name"];
	exit();
}

function get_attendance_therapist_data($year,$month,$day){

	// 出勤しているセラピスト情報を取得するためのSQL文
	$sql = sprintf("
select *,attendance.id as attendance_id from attendance
left join therapist on attendance.therapist_id=therapist.id
where therapist.delete_flag=0 and year='%s' and month='%s' and day='%s' and attendance.today_absence='0'",
$year,$month,$day);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリ実行に失敗しました";
		exit();
	}

	$attendance_data = array();

	// 一覧に表示される顧客データを変数に格納する処理
	$i=0;
	while($row = mysql_fetch_assoc($res)){
		$attendance_data[$i] = $row;

		$attendance_id = $attendance_data[$i]["attendance_id"];
		$sql = sprintf("select time from reservation where attendance_id='%s'",$attendance_id);
		$res2 = mysql_query($sql, DbCon);
		if($res == false){
			echo "クエリ実行に失敗しました";
			exit();
		}
		$j=0;
		while($row2 = mysql_fetch_assoc($res2)){
			$attendance_data[$i]["time"][$j] = $row2["time"];
			$time_num = count($attendance_data[$i]["time"]);
			$attendance_data[$i]["time_num"] = $time_num;
			$j++;
		}
		if($j==0){
			$attendance_data[$i]["time_num"]=0;
		}

		$i++;
	}

	return $attendance_data;
	exit();

}

function get_therapist_data_for_reservation_status_board($year,$month,$day,$area){

	// 出勤しているセラピスト情報を取得するためのSQL文

/*
$sql = sprintf("
select *,attendance_new.id as attendance_id from attendance_new
left join therapist_new on attendance_new.therapist_id=therapist_new.id
where
therapist_new.delete_flg=0 and
therapist_new.leave_flg=0 and
therapist_new.test_flg=0 and
year='%s' and
month='%s' and
day='%s' and
attendance_new.today_absence='0' and
attendance_new.kekkin_flg='0' and
attendance_new.syounin_state='1' and
attendance_new.area='%s'
order by therapist_new.rank_order_num asc,therapist_new.order_num desc",
$year,$month,$day,$area);
*/

$sql = sprintf("
select *,attendance_new.id as attendance_id from attendance_new
left join therapist_new on attendance_new.therapist_id=therapist_new.id
where
therapist_new.delete_flg=0 and
therapist_new.leave_flg=0 and
therapist_new.test_flg=0 and
year='%s' and
month='%s' and
day='%s' and
attendance_new.today_absence='0' and
attendance_new.kekkin_flg='0' and
attendance_new.area='%s'
order by therapist_new.rank_order_num asc,therapist_new.order_num desc",
$year,$month,$day,$area);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_therapist_data_for_reservation_status_board:1)";
		exit();
	}

	$data = array();

	$i=0;
	while($row = mysql_fetch_assoc($res)){

		$therapist_id = $row["therapist_id"];

		//therapist_id重複チェック
		$result = check_duplication_therapist_id_in_attendance_new($data,$therapist_id);

		if( $result == false ){

			$data[$i] = $row;

			$attendance_id = $data[$i]["attendance_id"];

			$data[$i]["area"] = $area;

			$sql = sprintf("select time from reservation_new where attendance_id='%s'",$attendance_id);

			$res2 = mysql_query($sql, DbCon);
			if($res == false){
				echo "error!(get_therapist_data_for_reservation_status_board:2)";
				exit();
			}

			$j=0;
			while($row2 = mysql_fetch_assoc($res2)){
				$data[$i]["time"][$j] = $row2["time"];
				$time_num = count($data[$i]["time"]);
				$data[$i]["time_num"] = $time_num;
				$j++;
			}
			if($j==0){
				$data[$i]["time_num"]=0;
			}

			$i++;

		}


	}

	return $data;
	exit();

}

function check_disp_states_for_board($start_time,$end_time,$j){

	$j++;
	//$j++;

	if( ( $start_time <= $j ) && ( $end_time >= $j ) ){

		return true;
		exit();

	}else{

		return false;
		exit();

	}

}

function get_reservation_for_board_data_by_attendance_id($attendance_id,$area){

	/*
	if( ($area=="tokyo") || ($area="yokohama") ){

$sql = sprintf("
select * from reservation_for_board where delete_flg=0 and attendance_id='%s'",
$attendance_id);

	}else{

$sql = sprintf("
select * from reservation_for_board where delete_flg=0 and attendance_id='%s' and shop_area='%s'",
$attendance_id,$area);

	}
	*/

$sql = sprintf("
select * from reservation_for_board where delete_flg=0 and attendance_id='%s' and shop_area='%s'",
$attendance_id,$area);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(get_reservation_for_board_data_by_attendance_id)";
		exit();

	}
	$i=0;
	$list_data = array();
	while($row = mysql_fetch_assoc($res)){
		$list_data[$i++] = $row;
	}

	return $list_data;
	exit();

}

function get_reservation_for_board_data_therapist_mitei($shop_area,$year,$month,$day){

	$year_yokujitsu = intval(date("Y", mktime(0, 0, 0, $month, $day+1, $year)));
	$month_yokujitsu = intval(date("m", mktime(0, 0, 0, $month, $day+1, $year)));
	$day_yokujitsu = intval(date("d", mktime(0, 0, 0, $month, $day+1, $year)));

$sql = sprintf("
select * from reservation_for_board where
delete_flg=0 and
attendance_id='-1' and
(shop_area='%s' or shop_area='%s' or shop_area='%s') and
(
(year='%s' and month='%s' and day='%s' and start_hour>17) or
(year='%s' and month='%s' and day='%s' and start_hour<17)
)
order by year,month,day,start_hour
",
$shop_area,$shop_area.'_reraku',$shop_area.'_bigao',$year,$month,$day,$year_yokujitsu,$month_yokujitsu,$day_yokujitsu);

	$res = mysql_query($sql, DbCon);
	if($res == false){

		echo "error!(get_reservation_for_board_data_therapist_mitei)";
		exit();

	}
	$i=0;
	$list_data = array();
	while($row = mysql_fetch_assoc($res)){
		$list_data[$i++] = $row;
	}

	return $list_data;
	exit();

}

function get_reservation_data_for_board_disp($reservation_data,$j){

	$j++;

	$reservation_data_num = count($reservation_data);

	$data = array();

	for($i=0;$i<$reservation_data_num;$i++){

		//30分の場合は後でmargin-leftをずらす処理をするため、ここは時間だけの取得でよい
		//30分単位のマッチに修正したいので分もとる

		$start_hour = $reservation_data[$i]["start_hour"];
		$start_minute = intval($reservation_data[$i]["start_minute"]);

		if( $start_hour < 6 ){

			$start_hour = $start_hour + 24;

		}

		$start_hour_value = ($start_hour - 18)*2;

		if( $start_minute >= 30 ){

			$start_hour_value++;

		}

		$start_hour_value++;

		if( $start_hour_value == $j ){

			$data = $reservation_data[$i];

			return $data;
			exit();

		}

	}

	return false;
	exit();

}

function get_board_disp_data_html($board_disp_data,$shop_area,$attendance_id){

	$start_hour = $board_disp_data["start_hour"];
	$start_minute = $board_disp_data["start_minute"];
	$end_hour = $board_disp_data["end_hour"];
	$end_minute = $board_disp_data["end_minute"];
	$shop_name = $board_disp_data["shop_name"];
	$time_len = $board_disp_data["time_len"];
	$reservation_for_board_id = $board_disp_data["id"];
	$card_flg = $board_disp_data["card_flg"];
	$card_confirm_flg = $board_disp_data["card_confirm_flg"];
	$complete_flg = $board_disp_data["complete_flg"];
	$start_flg = $board_disp_data["start_flg"];
	$okuri_driver_id = $board_disp_data["okuri_driver_id"];
	$mukae_driver_id = $board_disp_data["mukae_driver_id"];
	$okuri_driver_area = $board_disp_data["okuri_driver_area"];
	$mukae_driver_area = $board_disp_data["mukae_driver_area"];
	$new_flg = $board_disp_data["new_flg"];
	$shimei_flg = $board_disp_data["shimei_flg"];
	$orders_route = $board_disp_data["orders_route"];

	$attendance_tmp_flg = $board_disp_data["attendance_tmp_flg"];

	$attendance_start_time = get_attendance_start_time_common($attendance_id);
	$attendance_end_time = get_attendance_end_time_common($attendance_id);

	$start_time_value = get_time_array_value_common($start_hour,$start_minute);

	$out_time_flg = false;

	/*
	if($attendance_id==13777){
		echo "start_hour:".$start_hour;echo "<br />";
		echo "start_minute:".$start_minute;echo "<br />";
		echo "start_time_value:".$start_time_value;echo "<br />";
		echo "attendance_start_time:".$attendance_start_time;echo "<br />";
		echo "attendance_end_time:".$attendance_end_time;echo "<br />";
	}
	*/

	if( ($start_time_value < $attendance_start_time) || ($start_time_value >= $attendance_end_time) ){
		$out_time_flg = true;
	}

	$okuri_driver_html = "";
	$mukae_driver_html = "";

	if( $okuri_driver_id != "-1" ){

		if( $okuri_driver_id == "-2" ){

			$okuri_driver_html = '<div class="board_driver_box_2" id="okuri_reservation_'.$reservation_for_board_id.'">TAXI</div>';

		}else if( $okuri_driver_id == "-3" ){

			$okuri_driver_html = '<div class="board_driver_box_2" id="okuri_reservation_'.$reservation_for_board_id.'">本部</div>';

		}else{

			$okuri_driver_name = get_staff_name_by_staff_id($okuri_driver_id,$shop_area,$okuri_driver_area);
			$okuri_driver_name = mb_substr($okuri_driver_name, 0, 3, 'UTF-8');
			$okuri_driver_html = '<div class="board_driver_box_xyz board_driver_box_2" id="okuri_reservation_'.$reservation_for_board_id.'">'.$okuri_driver_name.'</div>';

		}

	}

	if( $mukae_driver_id != "-1" ){

		if( $mukae_driver_id == "-2" ){

			$mukae_driver_html = '<div class="board_driver_box_3" id="mukae_reservation_'.$reservation_for_board_id.'">TAXI</div>';

		}else if( $mukae_driver_id == "-3" ){

			$mukae_driver_html = '<div class="board_driver_box_3" id="mukae_reservation_'.$reservation_for_board_id.'">本部</div>';

		}else{

			$mukae_driver_name = get_staff_name_by_staff_id($mukae_driver_id,$shop_area,$mukae_driver_area);
			$mukae_driver_name = mb_substr($mukae_driver_name, 0, 3, 'UTF-8');
			$mukae_driver_html = '<div class="board_driver_box_xyz board_driver_box_3" id="mukae_reservation_'.$reservation_for_board_id.'">'.$mukae_driver_name.'</div>';

		}

	}

	$box_haba = $time_len * 7;

	$box_margin_left = ( intval( $start_minute / 5 ) ) * 7;

	if( $start_minute >= 30 ){

		//30分ぶん、左へずらす(5分単位が7pxのよう)
		$mainasu = 7 * 6;
		$box_margin_left = $box_margin_left - $mainasu;

	}

	if( $start_hour < 12 ){

		$start_hour = $start_hour + 24;

	}

	if( $end_hour < 12 ){

		$end_hour = $end_hour + 24;

	}

	if( $start_minute < 10 ){

		$start_minute = "0".$start_minute;

	}

	if( $end_minute < 10 ){

		$end_minute = "0".$end_minute;

	}

	$time = $start_hour."：".$start_minute."&nbsp;―&nbsp;".$end_hour."：".$end_minute;

	$shop_type_class = " sonota";

	if( $attendance_tmp_flg == "1" ){

		$shop_type_class = " attendance_id_tmp";

	}else{
		$shop_type_class = PHP_getShopTypeClass_maninc($shop_name);		//in common/include/shop_area_list.php
	}


	if( $shop_name == "東京リラク" ){
		$shop_area .= "_reraku";
	}

	if( $shop_name == "BIGAO" ){
		$shop_area .= "_bigao";
	}

	if($orders_route == "WEB"){
	    $blink = " blinking";
	}

	if( $complete_flg == "1" ){
		if( $card_confirm_flg == "1" ){
			$html .= '<a class="box board_complete_flg_on board_card_confirm_flg_on" style="width:'.$box_haba.'px;margin-left:'.$box_margin_left.'px;" href="reservation_status_board_edit.php?area='.$shop_area.'&id='.$reservation_for_board_id.'">';
		}else if( $card_flg == "1" ){
			$html .= '<a class="box board_complete_flg_on board_card_flg_on" style="width:'.$box_haba.'px;margin-left:'.$box_margin_left.'px;" href="reservation_status_board_edit.php?area='.$shop_area.'&id='.$reservation_for_board_id.'">';
		}else{
			$html .= '<a class="box board_complete_flg_on" style="width:'.$box_haba.'px;margin-left:'.$box_margin_left.'px;" href="reservation_status_board_edit.php?area='.$shop_area.'&id='.$reservation_for_board_id.'">';
		}
	}else if( $card_confirm_flg == "1" ){
		$html .= '<a class="box'.$shop_type_class.$blink.' board_card_confirm_flg_on" style="width:'.$box_haba.'px;margin-left:'.$box_margin_left.'px;" href="reservation_status_board_edit.php?area='.$shop_area.'&id='.$reservation_for_board_id.'">';
	}else if( $card_flg == "1" ){
		$html .= '<a class="box'.$shop_type_class.$blink.' board_card_flg_on" style="width:'.$box_haba.'px;margin-left:'.$box_margin_left.'px;" href="reservation_status_board_edit.php?area='.$shop_area.'&id='.$reservation_for_board_id.'">';
	}else{
		$html .= '<a class="box'.$shop_type_class.$blink.'" style="width:'.$box_haba.'px;margin-left:'.$box_margin_left.'px;" href="reservation_status_board_edit.php?area='.$shop_area.'&id='.$reservation_for_board_id.'">';
	}


	if( $start_flg == "1" ){

		$class_naiyou_left = "resev_box_driver f_left resev_box_start_on";
		$class_naiyou_right = "resev_box_driver f_right resev_box_start_on";

	}else{

		$class_naiyou_left = "resev_box_driver f_left";
		$class_naiyou_right = "resev_box_driver f_right";

	}

	if( $new_flg == "1" ){

		$resev_box_time_class = "resev_box_time resev_box_new";
		$resev_box_customer_class = "resev_box_customer resev_box_new";

	}else{

		$resev_box_time_class = "resev_box_time";
		$resev_box_customer_class = "resev_box_customer";

	}

	$customer_name = $board_disp_data["customer_name"];

	$customer_name = preg_replace("/[\(（].*/u","",$customer_name);

	if( $shimei_flg == "1" ){

		$customer_name = "【指】".$customer_name;

	}

	$html .= '<div class="'.$resev_box_time_class.'">'.$time.'</div>';
	$html .= '<div class="'.$resev_box_customer_class.'">'.$customer_name.'（'.$board_disp_data["area_name"].'）</div>';
	$html .=<<<EOT
<div>
<div class="{$class_naiyou_left}" id="okuri_driver_{$reservation_for_board_id}">
{$okuri_driver_html}
</div>
<div class="{$class_naiyou_right}" id="mukae_driver_{$reservation_for_board_id}">
{$mukae_driver_html}
</div>
<br class="clear" />
</div>
EOT;
	$html .= '</a>';

	return $html;
	exit();

}

function get_board_disp_data_html_mitei($board_disp_data,$shop_area){

	$start_hour = $board_disp_data["start_hour"];
	$start_minute = $board_disp_data["start_minute"];
	$end_hour = $board_disp_data["end_hour"];
	$end_minute = $board_disp_data["end_minute"];
	$time_len = $board_disp_data["time_len"];

	$start_time_value = get_time_value_for_board($start_hour,$start_minute);

	$width_value = $time_len * 7;

	$left_value = ($start_time_value-1)*7;

	//echo $start_time_value;exit();

	$shop_name = $board_disp_data["shop_name"];

	$time_len = $board_disp_data["time_len"];

	$reservation_for_board_id = $board_disp_data["id"];

	if( $start_hour < 18 ){

		$start_hour = $start_hour + 24;

	}

	if( $end_hour < 18 ){

		$end_hour = $end_hour + 24;

	}

	if( $start_minute < 10 ){

		$start_minute = "0".$start_minute;

	}

	if( $end_minute < 10 ){

		$end_minute = "0".$end_minute;

	}

	$time = $start_hour."：".$start_minute."&nbsp;―&nbsp;".$end_hour."：".$end_minute;

	$customer_name = preg_replace("/[\(（].*/u","",$board_disp_data["customer_name"]);

	if( $shop_name == "東京リフレ" ){

		$html .= '<a style="left:'.$left_value.'px;width:'.$width_value.'px;" class="mitei_box refle_mitei_box" href="reservation_status_board_edit.php?area='.$shop_area.'&id='.$reservation_for_board_id.'">';

	}else if( $shop_name == "東京アロマ" ){

		$html .= '<a style="left:'.$left_value.'px;width:'.$width_value.'px;" class="mitei_box aroma_mitei_box" href="reservation_status_board_edit.php?area='.$shop_area.'&id='.$reservation_for_board_id.'">';

	}else if( $shop_name == "リンパマッサージ東京" ){

		$html .= '<a style="left:'.$left_value.'px;width:'.$width_value.'px;" class="mitei_box lymph_mitei_box" href="reservation_status_board_edit.php?area='.$shop_area.'&id='.$reservation_for_board_id.'">';

	}else{

		$html .= '<a style="left:'.$left_value.'px;width:'.$width_value.'px;" class="mitei_box sonota_mitei_box" href="reservation_status_board_edit.php?area='.$shop_area.'&id='.$reservation_for_board_id.'">';

	}

	$html .= '<div class="mitei_box_time">'.$time.'</div>';
	$html .= '<div class="mitei_box_name">'.$customer_name.'（'.$board_disp_data["area_name"].'）</div>';
	$html .=<<<EOT
<div>
<br class="clear" />
</div>
EOT;
	$html .= '</a>';

	return $html;
	exit();

}

function get_driver_data_for_board($year,$month,$day,$area){

	$type = "driver";

	$sql = sprintf("select * from staff_new_new where delete_flg='0' and shayousha_flg='0' and type='%s' and area='%s'",$type,$area);

	$res = mysql_query($sql, DbCon);
	if($res == false){

		echo "error!(get_driver_data_for_board:1)";
		exit();

	}

	$i=0;
	$list_data = array();
	while($row = mysql_fetch_assoc($res)){

		$staff_id = $row["id"];

		$result = check_staff_attendance_exist_board($staff_id, $year, $month, $day,$area);

		if( $result == true ){

			$list_data[$i] = $row;
			$list_data[$i]["area"] = $area;
			$i++;

		}

	}

	if( $area == "yokohama" ){

		$area_tokyo = "tokyo";

		$where_kenmu = "kenmu like '%".$area."%'";

		$sql = sprintf("
select * from staff_new_new where delete_flg='0' and type='%s' and (%s) and area='%s'",
$type,$where_kenmu,$area_tokyo);

		$res = mysql_query($sql, DbCon);
		if($res == false){

			echo "error!(get_driver_data_for_board:2)";
			exit();

		}

		while($row = mysql_fetch_assoc($res)){

			$staff_id = $row["id"];

			$result = check_staff_attendance_exist_board($staff_id, $year, $month, $day,$area_tokyo);

			if( $result == true ){

				$list_data[$i] = $row;
				$list_data[$i]["area"] = $area_tokyo;
				$i++;

			}

		}

	}

	return $list_data;
	exit();

}

function get_driver_data_for_board_2($year,$month,$day,$area){

	$type = "driver";

	$sql = sprintf("select * from staff_new_new where delete_flg='0' and type='%s' and area='%s'",$type,$area);

	$res = mysql_query($sql, DbCon);
	if($res == false){

		echo "error!(get_driver_data_for_board_2:1)";
		exit();

	}

	$i=0;
	$list_data = array();
	while($row = mysql_fetch_assoc($res)){

		$staff_id = $row["id"];

		$result = check_staff_attendance_exist_board_2($staff_id, $year, $month, $day,$area);

		if( $result == true ){

			$list_data[$i] = $row;
			$list_data[$i]["area"] = $area;
			$i++;

		}

	}

	if( $area == "yokohama" ){

		$area_tokyo = "tokyo";

		$where_kenmu = "kenmu like '%".$area."%'";

		$sql = sprintf("
select * from staff_new_new where delete_flg='0' and type='%s' and (%s) and area='%s'",
		$type,$where_kenmu,$area_tokyo);

		$res = mysql_query($sql, DbCon);
		if($res == false){

			echo "error!(get_driver_data_for_board_2:2)";
			exit();

		}

		while($row = mysql_fetch_assoc($res)){

			$staff_id = $row["id"];

			$result = check_staff_attendance_exist_board_2($staff_id, $year, $month, $day,$area_tokyo);

			if( $result == true ){

				$list_data[$i] = $row;
				$list_data[$i]["area"] = $area_tokyo;
				$i++;

			}

		}

	}

	return $list_data;
	exit();

}

function get_driver_data_for_board_3($year,$month,$day,$area){

	$page_area = $area;

	$type = "driver";

	$sql = sprintf("select * from staff_new_new where delete_flg='0' and type='%s' and area='%s' and shayousha_flg='0'",$type,$page_area);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(get_driver_data_for_board_3:1)";
		exit();

	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$staff_id = $row["id"];

		$result = check_staff_attendance_exist_board_3($staff_id, $year, $month, $day,$page_area);

		if( $result == true ){

			$list_data[$i] = $row;
			$list_data[$i]["area"] = $page_area;
			$i++;

		}

	}

	if( $page_area == "yokohama" ){

		$area_tokyo = "tokyo";

		$where_kenmu = "kenmu like '%".$page_area."%'";

		$sql = sprintf("select * from staff_new_new where delete_flg='0' and type='%s' and (%s) and area='%s' and shayousha_flg='0'",$type,$where_kenmu,$area_tokyo);

		$res = mysql_query($sql, DbCon);
		if($res == false){

			echo "error!(get_driver_data_for_board_3:2)";
			exit();

		}

		while($row = mysql_fetch_assoc($res)){

			$staff_id = $row["id"];

			$result = check_staff_attendance_exist_board_3($staff_id, $year, $month, $day,$page_area);

			if( $result == true ){

				$list_data[$i] = $row;
				$list_data[$i]["area"] = $area_tokyo;
				$i++;

			}

		}

	}

	return $list_data;
	exit();

}

//出席データが登録済みであるかどうか(登録済み：true,未登録:false)
function check_staff_attendance_exist_board($staff_id,$day_year,$day_month,$day_day,$area){

		$sql = sprintf("
select id from attendance_staff_new where
staff_id='%s' and
year='%s' and
month='%s' and
day='%s' and
today_absence=0 and
attendance_adjustment=0",
$staff_id,$day_year,$day_month,$day_day);

	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(check_staff_attendance_exist_board)";
		exit();
	}
	$num = mysql_num_rows($res);

	if( $num > 0 ){

		return true;
		exit();

	}else{

		return false;
		exit();

	}

}

//出席データが登録済みであるかどうか(登録済み：true,未登録:false)
function check_staff_attendance_exist_board_2($staff_id,$day_year,$day_month,$day_day,$area){

	$sql = sprintf("
select id from attendance_staff_new where
staff_id='%s' and
year='%s' and
month='%s' and
day='%s' and
not_board_display_flg=0 and
today_absence=0 and
attendance_adjustment=0",
$staff_id,$day_year,$day_month,$day_day);

	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(check_staff_attendance_exist_board_2)";
		exit();
	}
	$num = mysql_num_rows($res);

	if( $num > 0 ){

		return true;
		exit();

	}else{

		return false;
		exit();

	}

}

//出席データが登録済みであるかどうか(登録済み：true,未登録:false)
function check_staff_attendance_exist_board_3($staff_id,$year,$month,$day,$page_area){

	$sql = sprintf("
select id from attendance_staff_new where
area='%s' and
staff_id='%s' and
year='%s' and
month='%s' and
day='%s' and
not_board_display_flg=0 and
syounin_state=1 and
today_absence=0 and
attendance_adjustment=0",
$page_area,$staff_id,$year,$month,$day);

	//echo $sql;echo "<br />";

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(check_staff_attendance_exist_board_3)";
		exit();

	}

	$num = mysql_num_rows($res);

	if( $num > 0 ){

		return true;
		exit();

	}else{

		return false;
		exit();

	}

}

function okuri_mukae_driver_set($reservation_id,$driver_id,$type,$driver_area){

	$cti_id = get_cti_id_by_reservation_for_board_id($reservation_id);
	$cti_mail_data = get_cti_mail_data_by_cti_id($cti_id);
	$driver_data = get_driver_data_by_id($driver_id);

	$mail_subject = $cti_mail_data["subject"];
	$mail_body = $cti_mail_data["body"];

	$driver_name = $driver_data["name"];
	$driver_mail = $driver_data["mail"];

	//トランザクションをはじめる準備
	$sql = "set autocommit = 0";
	mysql_query( $sql, DbCon );

	//トランザクション開始
	$sql = "begin";
	mysql_query( $sql, DbCon );

	$action_type = "";

	if( $type == "okuri" ){

		$sql = sprintf("
update reservation_for_board set okuri_driver_id='%s',okuri_driver_area='%s' where id='%s'",
$driver_id,$driver_area,$reservation_id);

		$action_type = "送り";

	}else if( $type == "mukae" ){

		$sql = sprintf("
update reservation_for_board set mukae_driver_id='%s',mukae_driver_area='%s',complete_flg='1' where id='%s'",
$driver_id,$driver_area,$reservation_id);

		$action_type = "迎え";

	}else{

		//ロールバック
		$sql = "rollback";
		mysql_query( $sql, DbCon );

		return false;
		exit();

	}

	//echo $sql;
	//exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		//ロールバック
		$sql = "rollback";
		mysql_query( $sql, DbCon );

		return false;
		exit();

	}

	//$driver_mail = "";

	if( $driver_mail != "" ){

		$data = get_reservation_for_board_data_by_id_common($reservation_id);

		$year = $data["year"];
		$month = add_zero_when_under_ten_common($data["month"]);
		$day = add_zero_when_under_ten_common($data["day"]);
		$start_hour = add_zero_when_under_ten_common($data["start_hour"]);
		$start_minute = add_zero_when_under_ten_common($data["start_minute"]);
		$end_hour = add_zero_when_under_ten_common($data["end_hour"]);
		$end_minute = add_zero_when_under_ten_common($data["end_minute"]);

		$mail_add_pre = sprintf("【予約情報】\r\n■日時 ： %s/%s/%s %s:%s-%s:%s",
$year,$month,$day,$start_hour,$start_minute,$end_hour,$end_minute);

		$mail_body = edit_mail_body_for_driver($mail_body);

		$mail_body = $mail_add_pre."\r\n".$mail_body;

		//メール送信

		$mail_title = sprintf("[%sさん][%s]%s",$driver_name,$action_type,$mail_subject);

		mb_language("ja");
		mb_internal_encoding("UTF-8");
		$mailto = $driver_mail;
		$title = $mail_title;
		$content = $mail_body;

		$header = "From: info@neo-gate.jp\n";
		$header .= "Bcc: info@neo-gate.jp";

		$parameter="-f info@neo-gate.jp";

		$result = mb_send_mail($mailto,$title,$content,$header,$parameter);

		if($result==false){

			//ロールバック
			$sql = "rollback";
			mysql_query( $sql, DbCon );

			return false;
			exit();

		}

	}

	//コミット
	$sql = "commit";
	mysql_query( $sql, DbCon );

	return true;
	exit();
}

function okuri_mukae_driver_delete($reservation_id,$type){

	if( $type == "okuri" ){

		$sql = sprintf("update reservation_for_board set okuri_driver_id='-1',okuri_driver_area='' where id='%s'",$reservation_id);

	}else if( $type == "mukae" ){

		$sql = sprintf("update reservation_for_board set mukae_driver_id='-1',mukae_driver_area='',complete_flg='0' where id='%s'",$reservation_id);

	}else{

		return false;
		exit();

	}

	//echo $sql;
	//exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		return false;
		exit();

	}

	return true;
	exit();

}

//予約データの取得
function get_reservation_data_by_id($id){

	$sql = sprintf("select * from reservation_for_board where id='%s'",$id);

	$res = mysql_query($sql, DbCon);
	if($res == false){

		echo "error!(get_reservation_data_by_id)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();

}

function get_therapist_name_by_attendance_id($attendance_id,$shop_area){

	$sql = sprintf("
select * from attendance_new
left join therapist_new on therapist_new.id=attendance_new.therapist_id
where attendance_new.id='%s'",$attendance_id);

	$res = mysql_query($sql, DbCon);
	if($res == false){

		echo "error!(get_reservation_data_by_id)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	return $row["name"];
	exit();

}

function update_reservation_data(
$reservation_id,$start_hour,$start_minute,$end_hour,$end_minute,$attendance_id,
$start_hour_old,$start_minute_old,$end_hour_old,$end_minute_old,$shop_area,$place_name,$therapist_id,
$year,$month,$day,$card_flg,$card_confirm_flg,$course,$complete_flg,$start_flg,$extension,
$shop_name,$course_old,$course_new,$extension_old,$extension_new,$course_change_flg,$extension_change_flg,$course_var){

	$attendance_start_time = get_attendance_start_time($attendance_id,$shop_area);

	$yoyaku_start_time = start_hour_and_minute_to_time($start_hour,$start_minute);

	//echo "attendance_start_time:".$attendance_start_time;echo "<br />";
	//echo "yoyaku_start_time:".$yoyaku_start_time;
	//exit();

	if( $attendance_start_time > $yoyaku_start_time ){

		//出勤開始時間よりも前です、のエラー表示は不要
		//return false;
		//exit();

	}

	$start_real_time_flg = false;
	$mail_flg = false;
	$mail_type = "";
	$customer_name = "";
	$check_url = "";
	$reservation_for_board_id = $reservation_id;
	$area_name = $place_name;

	update_reservation_data_transaction_common(
$start_hour,$start_minute,$end_hour,$end_minute,$reservation_for_board_id,$therapist_id,$attendance_id,
$shop_area,$area_name,$course,$extension,$card_flg,$card_confirm_flg,$complete_flg,$start_flg,
$start_real_time_flg,$mail_flg,$mail_type,$customer_name,$check_url,
$shop_name,$course_old,$course_new,$extension_old,$extension_new,$course_change_flg,$extension_change_flg,
$course_var);

	return true;
	exit();

}

function hour_change_over_24($hour){
	return PHP_hour_change_over_24_common($hour, 18);	//n時前は24時を加算
}

function get_reservation_data_by_attendance_id_board($attendance_id,$shop_area){

	if( $shop_area == "tokyo" ){

		$sql = sprintf("select * from reservation where attendance_id='%s'",$attendance_id);

	}else if( $shop_area == "sapporo" ){

		$sql = sprintf("select * from reservation_sapporo where attendance_id='%s'",$attendance_id);

	}else{

		$sql = sprintf("select * from reservation_new where attendance_id='%s' and area='%s'",$attendance_id,$shop_area);

	}

	$res = mysql_query($sql, DbCon);

	if($res == false){

		return false;
		exit();

	}

	$i=0;
	$list_data = array();
	while($row = mysql_fetch_assoc($res)){
		$list_data[$i++] = $row;
	}

	return $list_data;
	exit();

}

function change_to_reservation_time($start_hour,$start_minute,$end_hour,$end_minute){

	include(INC_PATH."/define.php");

	/*
	echo "<pre>";
	print_r($time_array);
	echo "</pre>";
	exit();
	*/

	$start_hour = hour_change_over_24($start_hour);
	$end_hour = hour_change_over_24($end_hour);

	$time_array_num = count($time_array);

	if( $start_minute >= 30 ){

		$start_minute = 30;

	}else{

		$start_minute = 0;

	}

	if( $end_minute == 0 ){

		$end_hour = $end_hour - 1;
		$end_minute = 30;

	}else if( $end_minute <= 30 ){

		$end_minute = 0;

	}else{

		$end_minute = 30;

	}

	$start_hour = hour_change_not_over_24($start_hour);
	$end_hour = hour_change_not_over_24($end_hour);

	$data = array();

	for( $i=1;$i<=$time_array_num;$i++ ){

		$tmp_hour = $time_array[$i]["hour"];
		$tmp_minute = $time_array[$i]["minute"];

		if( ($tmp_hour==$start_hour) && ($tmp_minute==$start_minute) ){

			$data["start_time"] = $i;

		}

		if( ($tmp_hour==$end_hour) && ($tmp_minute==$end_minute) ){

			$data["end_time"] = $i;

		}

	}

	//echo $data["end_time"];
	//exit();

	return $data;
	exit();

}

function hour_change_not_over_24($hour){
	return hour_change_not_over_24_common($hour);	//24時以降は24時を減算
}

//更新すべきデータの取得
function get_must_update_data($reservation_time_data_old,$attendance_id){

	$start_time = $reservation_time_data_old["start_time"];
	$end_time = $reservation_time_data_old["end_time"];

	$exist_reservation_num = "";

	$finish_flg = false;

	for( $i=$start_time;$i<=$end_time;$i++ ){

		if( $finish_flg == false ){

			$result = exist_check_reservation_data($i,$attendance_id);

			if( $result == true ){

				$exist_reservation_num = $i;
				$finish_flg = true;

			}

		}

	}

	$delete_start_num = "";

	$finish_flg = false;

	//一番最初の数値を取得

	for( $i=$exist_reservation_num;$i>0;$i-- ){

		if( $finish_flg == false ){

			$result = exist_check_reservation_data($i,$attendance_id);

			if($result==true){

				$delete_start_num = $i;

			}else{

				$finish_flg = true;

			}

		}

	}

	$delete_end_num = "";

	$finish_flg = false;

	//一番最後の数値を取得

	for( $i=$exist_reservation_num;$i<=25;$i++ ){

		if( $finish_flg == false ){

			$result = exist_check_reservation_data($i,$attendance_id);

			if($result==true){

				$delete_end_num = $i;

			}else{

				$finish_flg = true;

			}

		}

	}

	$data["start_time"] = $delete_start_num;
	$data["end_time"] = $delete_end_num;

	return $data;
	exit();

}

function exist_check_reservation_data($i,$attendance_id){

	$sql = sprintf("select id from reservation where time='%s' and attendance_id='%s'",$i,$attendance_id);
	$res = mysql_query($sql, DbCon);
	if($res === false){

		echo "error!(exist_check_reservation_data)";
		exit();

	}

	$num = mysql_num_rows($res);

	if( $num > 0 ){

		return true;
		exit();

	}else{

		return false;
		exit();

	}

}

function get_before_latest_end_time($attendance_id,$time,$shop_area){

	//出勤のスタート時間

	$sql = sprintf("select start_time from attendance_new where id='%s' and area='%s'",$attendance_id,$shop_area);

	echo $sql;echo "<br />";

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(get_before_latest_end_time:1)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	$att_start_time = $row["start_time"];

	if( $att_start_time == 1 ){

		$att_start_time = 0;

	}


	//直近の予約タイム

	$sql = sprintf("select time from reservation_new where area='%s' and attendance_id='%s' and (time < %s) order by time desc",$shop_area,$attendance_id,$time);
	$res = mysql_query($sql, DbCon);
	if($res == false){

		echo "error!(get_before_latest_end_time:2)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	$latest_to_time = $row["time"];

	if($latest_to_time==""){

		$latest_to_time = 0;

	}

	$latest_end_time = "";

	if($att_start_time <= $latest_to_time){

		$latest_end_time = $latest_to_time;

	}else{

		$latest_end_time = $att_start_time;

	}

	return $latest_end_time;
	exit();

}

function get_after_first_start_time($attendance_id,$time,$shop_area){

	//直後の予約スタートタイム

	$sql = sprintf("select time from reservation_new where area='%s' and attendance_id='%s' and (time > %s) order by time asc",$shop_area,$attendance_id,$time);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(get_after_first_start_time)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	$after_start_time = $row["time"];

	if($after_start_time==""){

		$after_start_time = -1;

	}

	return $after_start_time;
	exit();

}

function delete_reservation_data_board(
$reservation_for_board_id,$attendance_id,$start_hour_old,$start_minute_old,$end_hour_old,$end_minute_old,$shop_area,
$therapist_id,$year,$month,$day){

	$data = get_reservation_data_by_id($reservation_for_board_id);

	$reservation_no = $data["reservation_no"];

	//トランザクションをはじめる準備
	$sql = "set autocommit = 0";
	mysql_query( $sql, DbCon );

	//トランザクション開始
	$sql = "begin";
	mysql_query( $sql, DbCon );

	$sql = sprintf("delete from reservation_new where reservation_for_board_id='%s' and area='%s'",$reservation_for_board_id,$shop_area);

	//echo $sql;echo "<br />";

	$res = mysql_query($sql, DbCon);
	if($res == false){
		//ロールバック
		$sql = "rollback";
		mysql_query( $sql, DbCon );
		echo "error!(delete_reservation_data_board:1)";
		exit();
	}

	$sql = sprintf("update reservation_for_board set delete_flg='1' where id='%s'",$reservation_for_board_id);

	//echo $sql;echo "<br />";

	$res = mysql_query($sql, DbCon);

	if($res == false){

		//ロールバック
		$sql = "rollback";
		mysql_query( $sql, DbCon );

		echo "error!(delete_reservation_data_board:2)";
		exit();

	}

	$now = time();

	//sale_historyのデータを削除
	$sql = sprintf("update sale_history set delete_flg='1',updated='%s' where reservation_no='%s'",$now,$reservation_no);

	//echo $sql;echo "<br />";

	$res = mysql_query($sql, DbCon);

	if($res == false){

		//ロールバック
		$sql = "rollback";
		mysql_query( $sql, DbCon );

		echo "error!(delete_reservation_data_board:3)";
		exit();

	}

	//exit();

	//コミット
	$sql = "commit";
	mysql_query( $sql, DbCon );

	return true;
	exit();
}

function update_therapist_order_num($therapist_id,$order_num,$area){

	$sql = sprintf("update therapist_new set order_num='%s' where id='%s'",$order_num,$therapist_id);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		return false;
		exit();

	}

	return true;
	exit();

}

function update_staff_order_num($staff_id,$order_num,$area){

	$sql = sprintf("update staff_new_new set order_num='%s' where id='%s'",$order_num,$staff_id);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		return false;
		exit();

	}

	return true;
	exit();

}

function get_time_len_new($start_hour,$start_minute,$end_hour,$end_minute){

	$start_hour = hour_plus_24($start_hour);
	$end_hour = hour_plus_24($end_hour);

	$start_hour++;

	$hour_sa = $end_hour - $start_hour;

	$start_minute_sa = 60 - $start_minute;

	$minute_goukei = $start_minute_sa + $end_minute;

	$minute_num = intval( $minute_goukei / 5 );

	$hour_sa_num = $hour_sa * 12;

	$total_num = $hour_sa_num + $minute_num;

	return $total_num;
	exit();

}

function hour_plus_24($hour){
	return PHP_hour_change_over_24_common($hour, 18);	//n時前は24時を加算
}

//attendance_id取得
function get_attendance_id_by_therapist_id($therapist_id,$year,$month,$day,$area){

	$sql = sprintf("select id from attendance_new where therapist_id='%s' and year='%s' and month='%s' and day='%s' and area='%s'",$therapist_id,$year,$month,$day,$area);

	//echo $sql;
	//echo "<br />";

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(get_attendance_id_by_therapist_id)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	return $row["id"];
	exit();

}

//attendance_id取得
function get_attendance_id_by_therapist_id_new($therapist_id,$year,$month,$day){

	$sql = sprintf("select id from attendance_new where therapist_id='%s' and year='%s' and month='%s' and day='%s'",$therapist_id,$year,$month,$day);

	//echo $sql;
	//echo "<br />";

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(get_attendance_id_by_therapist_id_new)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	return $row["id"];
	exit();

}

function get_attendance_start_time($attendance_id,$area){

	//出勤のスタート時間

	$sql = sprintf("select start_time from attendance_new where id='%s'",$attendance_id);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error(get_attendance_start_time)";
		exit();

	}

	$row = mysql_fetch_assoc($res);
	return $row["start_time"];
	exit();

}

function get_board_end_time($start_hour,$start_minute,$course,$course_add,$extension){

	$start = ( $start_hour * 60 ) + $start_minute;

	$end = $start + $course + $extension + $course_add;

	$end_hour = intval( $end / 60 );
	$end_minute = $end % 60;

	$data["hour"] = $end_hour;
	$data["minute"] = $end_minute;

	return $data;
	exit();

}

function get_board_end_time_2($start_hour,$start_minute,$course_new,$course_add,$extension){

	$start = ( $start_hour * 60 ) + $start_minute;

	$course_int = trim(str_replace("分+リフレ","",$course_new));
    $course_int = trim(str_replace("分","",$course_int));
    $course_int = trim(str_replace("スタンダード","",$course_int));
    $course_int = trim(str_replace("リラクヘッド","",$course_int));
    $course_int = trim(str_replace("スカルプヘッド","",$course_int));
    $course_int = trim(str_replace("美髪","",$course_int));
	$course_int = trim(str_replace("美首","",$course_int));
	//＋で区切られている場合
	if (preg_match("/＋/",$course_int)) {
	    $tmp_array = explode("＋",$course_int);
	    foreach($tmp_array as $value){
	        $tmp_data += intval(trim($value));
	    }
	    $course_int = $tmp_data;
	}
	else{
	    $course_int = intval($course_int);
	}

	$end = $start + $course_int + $extension + $course_add;

	$end_hour = intval( $end / 60 );
	$end_minute = $end % 60;

	$data["hour"] = $end_hour;
	$data["minute"] = $end_minute;

	return $data;
	exit();

}

function get_hotel_deri_data_for_page_html($shop_area){

	if($shop_area=="sendai"){

		$area1_id = 5;

	}else{

		echo "not-exist-shop_area(get_hotel_deri_data_for_page_html)";
		exit();

	}

	$sql = sprintf("select id,name from hotel_deri where delete_flg=0 and area1_id='%s'",$area1_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){

		echo "クエリー実行で失敗しました(get_hotel_deri_data_for_page_html)";
		exit();

	}
	$i=0;
	$list_data = array();
	while($row = mysql_fetch_assoc($res)){
		$list_data[$i++] = $row;
	}

	return $list_data;
	exit();

}

function get_hotel_deri_name_by_id($data_id){

	$sql = sprintf("select name from hotel_deri where id='%s'",$data_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){

		echo "クエリー実行で失敗しました(get_hotel_deri_name_by_id)";
		exit();

	}
	$row = mysql_fetch_assoc($res);

	return $row["name"];
	exit();

}

function get_week_value($year,$month,$day){

	$hour = 12;
	$minute = 0;
	$second = 0;
	$timestamp = mktime($hour, $minute, $second, $month, $day, $year);

	$week = date('w', $timestamp);

	return $week;
	exit();

}

function get_week_name_new($year, $month, $day){
	return get_week_name_by_time_common($year, $month, $day);	//日付より曜日取得
}

//セラピストのメールアドレス
function get_therapist_mail_by_therapist_id($therapist_id){

	$sql = sprintf("select mail from therapist_new where id='%s'",$therapist_id);

	$res = mysql_query($sql, DbCon);
	if($res == false){

		header("Location: ".WWW_URL."error.php");
		exit();

	}

	$row = mysql_fetch_assoc($res);

	return $row["mail"];
	exit();

}

//セラピスト名取得(本名)
function get_therapist_name_by_therapist_id_honmyou($therapist_id,$area){

	$sql = sprintf("select name from therapist_new where id='%s'",$therapist_id);

	$res = mysql_query($sql, DbCon);
	if($res == false){

		header("Location: ".WWW_URL."error.php");
		exit();

	}

	$row = mysql_fetch_assoc($res);

	$name = $row["name"];

	return $name;
	exit();

}

function regist_shift_common_comment_data($area,$page_year,$page_month,$page_day,$naiyou){

	$sql = sprintf("
select id from shift_common_comment where delete_flg=0 and area='%s' and year='%s' and month='%s' and day='%s'",
$area,$page_year,$page_month,$page_day);

	//echo $sql;exit();

	$result = data_exist_check_hanyou($sql);

	if($result==true){

		$sql = sprintf("
update shift_common_comment set content='%s' where delete_flg=0 and area='%s' and year='%s' and month='%s' and day='%s'",
$naiyou,$area,$page_year,$page_month,$page_day);

	}else{

		$sql = sprintf("
insert into shift_common_comment(area,year,month,day,content) values('%s','%s','%s','%s','%s')",
$area,$page_year,$page_month,$page_day,$naiyou);

	}

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリー実行で失敗しました(regist_shift_common_comment_data)";
		exit();

	}

	return true;
	exit();

}

//登録済みであるかどうかのチェック(汎用)
function data_exist_check_hanyou($sql){

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリー実行で失敗しました(data_exist_check_hanyou)";
		exit();

	}

	$num = mysql_num_rows($res);

	if( $num > 0 ){

		return true;
		exit();

	}else{

		return false;
		exit();

	}

}

function get_shift_common_comment_data($year,$month,$day,$area){

	$sql = sprintf("select content from shift_common_comment where delete_flg=0 and area='%s' and year='%s' and month='%s' and day='%s'",$area,$year,$month,$day);
	$res = mysql_query($sql, DbCon);
	if($res == false){

		echo "クエリ実行に失敗しました(get_shift_common_comment_data_new)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	return $row["content"];
	exit();

}

//セラピストデータ一覧
function get_therapist_data_by_area_new($area){

	if(($area == 'yokohama')||($area == 'yokohama2')){

		$sql = sprintf("select * from therapist_new where leave_flg=0 and delete_flg=0 and area like '%s'",'%yokohama%');

	}else{

		$sql = sprintf("select * from therapist_new where leave_flg=0 and delete_flg='0' and area='%s'",$area);

	}

	$res = mysql_query($sql, DbCon);
	if($res == false){

		echo "クエリ実行に失敗しました(get_therapist_data_by_area_new)";
		exit();

	}

	$i = 0;
	$list_data = array();
	while($row = mysql_fetch_assoc($res)){

		$list_data[$i++] = $row;

	}

	return $list_data;
	exit();

}

function get_check_url_shift_front($area,$therapist_id){

	$ch = get_therapist_for_kobetsu_url($therapist_id);

	$check_url = sprintf("%sshift/index.php?area=%s&id=%s&ch=%s",URL_ROOT,$area,$therapist_id,$ch);

	return $check_url;
	exit();

}

function get_reservation_state_list_new_day_list($area,$day_array,$week_array){

	//$day_array_num = count($day_array);

	$html = "";

	for($i=0;$i<29;$i++){

		if($i != 0 ){
			$html .= "<span style='padding-left:10px;'>＞</span>";
		}

		if(($i%15)==0){
			$html .= "<br />";
		}

		$html .= '<span style="padding-left:10px;"><a href="reservation_state_list_new.php?area='.$area.'&year='.$day_array[$i]["year"].'&month='.$day_array[$i]["month"].'&day='.$day_array[$i]["day"].'">'.$day_array[$i]["month"]."/".$day_array[$i]["day"]."(".$week_array[$day_array[$i]["week"]].")</a></span>";

	}

	return $html;
	exit();

}

function get_therapist_for_kobetsu_url($therapist_id){

	$sql = sprintf("select for_kobetsu_url from therapist_new where id='%s'",$therapist_id);

	$res = mysql_query($sql, DbCon);
	if($res == false){

		echo "クエリー実行で失敗しました(get_therapist_for_kobetsu_url)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	return $row["for_kobetsu_url"];
	exit();

}

function get_staff_type_name($type,$area){

	$type_name = get_type_name_for_mail($type);

	$area_name = get_area_name_by_area($area);

	$data = $area_name.$type_name;

	return $data;
	exit();

}

function get_type_name_for_mail($type){

	$type_name = "";

	if( $type == "1" ){

		$type_name = "セラピスト";

	}else if( $type == "2" ){

		$type_name = "ドライバー";

	}else{

		echo "error!(get_type_name)";
		exit();

	}

	return $type_name;
	exit();

}

function send_man_staff_mail($type,$area,$title,$naiyou){

	$bcc_mail = get_staff_mail_address_for_bcc($type,$area);

	//echo $bcc_mail;exit();

	mb_language("ja");
	mb_internal_encoding("UTF-8");
	$mailto = "info@neo-gate.jp";
	$title = $title;
	$content = $naiyou;

	$header = "From: info@neo-gate.jp\n";
	//$header .= "Bcc: minamikawa@neo-gate.jp";
	$header .= "Bcc: ".$bcc_mail;
	//$header .= ",";
	//$header .= "minamikawa@neo-gate.jp";

	$result = mb_send_mail($mailto,$title,$content,$header,MAIL_PARAMETER);

	if($result==false){

		echo "error!(send_man_staff_mail)";
		exit();

	}

	return true;
	exit();

}

function get_staff_mail_address_for_bcc($type,$area){

	if( $type == "all" ){
		$bcc_mail = get_staff_mail_address_for_bcc_all();
		return $bcc_mail;
		exit();
	}

	if( $type == "1" ){

		$sql = sprintf("
select mail from therapist_new
where
delete_flg=0 and
leave_flg=0 and
test_flg=0 and
area='%s'",
$area);

	}else if( $type == "2" ){

		$staff_type = "driver";

		$sql = sprintf("
select mail from staff_new_new
where
delete_flg=0 and
type='%s' and
area='%s'",
$staff_type,$area);

	}else{

		echo "クエリー実行で失敗しました(get_staff_mail_address_for_bcc)";
		exit();

	}

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリー実行で失敗しました(get_staff_mail_address_for_bcc)";
		exit();

	}

	$bcc_mail = "";

	$i=0;

	while($row = mysql_fetch_assoc($res)){

		$mail = $row["mail"];

		if( $i > 0 ){

			$bcc_mail .= ',';

		}

		$bcc_mail .= $mail;

		$i++;

	}

	return $bcc_mail;
	exit();

}

function get_staff_mail_address_for_bcc_all(){

	$bcc_mail = "";
	$i=0;

	$sql = "
select mail from therapist_new
where
delete_flg=0 and
leave_flg=0 and
test_flg=0";

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリー実行で失敗しました(get_staff_mail_address_for_bcc_all)";
		exit();

	}

	while($row = mysql_fetch_assoc($res)){

		$mail = $row["mail"];

		if( $i > 0 ){

			$bcc_mail .= ',';

		}

		$bcc_mail .= $mail;

		$i++;

	}

	$staff_type = "driver";

	$sql = sprintf("
select mail from staff_new_new
where
delete_flg=0 and
type='%s'",
$staff_type);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリー実行で失敗しました(get_staff_mail_address_for_bcc_all)";
		exit();

	}

	while($row = mysql_fetch_assoc($res)){

		$mail = $row["mail"];

		if( $i > 0 ){

			$bcc_mail .= ',';

		}

		$bcc_mail .= $mail;

		$i++;

	}

	return $bcc_mail;
	exit();

}

function send_attendance_request_mail_new($year,$month,$day,$area,$therapist_id_array){

	$therapist_data = get_attendance_request_therapist($year,$month,$day,$area);

	if( $therapist_data == false ){

		return false;
		exit();

	}

	//チェックされたセラピストは除く
	$therapist_data = remove_therapist_at_attendance_request($therapist_data,$therapist_id_array);

	$result = insert_attendance_request_data($year,$month,$day,$area);

	if( $result == false ){

		return false;
		exit();

	}

	$therapist_data_num = count($therapist_data);

	$week_value = get_week_value($year,$month,$day);
	$week_name = get_week_name($week_value);

	mb_language("ja");
	mb_internal_encoding("UTF-8");

	$header = "From: info@neo-gate.jp\n";
	$header .= "Bcc: info@neo-gate.jp";
	//$header .= "Bcc: minamikawa@neo-gate.jp";

	$title = sprintf("【シフト登録】%s月%s日（%s）出勤要請メール",$month,$day,$week_name);

	for( $i=0; $i<$therapist_data_num; $i++ ){

		$therapist_id = $therapist_data[$i]["id"];
		$area = $therapist_data[$i]["area"];
		$mail = $therapist_data[$i]["mail"];

		$therapist_name = $therapist_data[$i]["name"];

		$check_url = get_check_url_shift_front($area,$therapist_id);

		//$mailto = "minamikawa@neo-gate.jp";
		$mailto = $mail;

		$content =<<<EOT
{$therapist_name}さん

お疲れ様です。
いつも出勤ありがとうございます。
日程調整をしてのシフトを組んでいただいておりますが
{$month}月{$day}日({$week_name})は出勤セラピストが少ないので
出勤をお願いできませんか？

出勤できましたらよろしくお願いします。
〇シフトの追加・編集はこちらから
{$check_url}

EOT;

		$result = mb_send_mail($mailto,$title,$content,$header,MAIL_PARAMETER);

		if( $result == false ){

			return false;
			exit();

		}

	}

	return true;
	exit();

}

function send_attendance_request_mail($year,$month,$day,$area){

	$therapist_data = get_attendance_request_therapist($year,$month,$day,$area);

	if( $therapist_data == false ){

		return false;
		exit();

	}

	$result = insert_attendance_request_data($year,$month,$day,$area);

	if( $result == false ){

		return false;
		exit();

	}

	$therapist_data_num = count($therapist_data);

	$week_value = get_week_value($year,$month,$day);
	$week_name = get_week_name($week_value);

	mb_language("ja");
	mb_internal_encoding("UTF-8");

	$header = "From: info@neo-gate.jp\n";
	$header .= "Bcc: info@neo-gate.jp";
	//$header .= "Bcc: minamikawa@neo-gate.jp";

	$title = sprintf("%s月%s日（%s）出勤要請メール",$month,$day,$week_name);

	for( $i=0; $i<$therapist_data_num; $i++ ){

		$therapist_id = $therapist_data[$i]["id"];
		$area = $therapist_data[$i]["area"];
		$mail = $therapist_data[$i]["mail"];

		$check_url = get_check_url_shift_front($area,$therapist_id);

		//$mailto = "minamikawa@neo-gate.jp";
		$mailto = $mail;

		$content =<<<EOT
お疲れ様です。
{$month}月{$day}日({$week_name})は出勤セラピストが少ないので、
出勤可能な方は出勤をお願いします。

○シフトの追加・編集はこちらから
{$check_url}
EOT;

		$result = mb_send_mail($mailto,$title,$content,$header,MAIL_PARAMETER);

		if( $result == false ){

			return false;
			exit();

		}

	}

	return true;
	exit();

}

function get_attendance_request_therapist($year,$month,$day,$area){

	$sql = sprintf("
select * from therapist_new
where
delete_flg=0 and
leave_flg=0 and
test_flg=0 and
area='%s'",
$area);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		return false;
		exit();

	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$therapist_id = $row["id"];

		//echo $therapist_id;exit();

		//出席データが登録済みであるかどうか(登録済み：true,未登録:false)
		$result = check_therapist_attendance_exist_new_for_ajax($therapist_id,$year,$month,$day,$area);

		if( $result == false ){

			$list_data[$i++] = $row;

		}

	}

	return $list_data;
	exit();

}

//出席データが登録済みであるかどうか(登録済み：true,未登録:false)
function check_therapist_attendance_exist_new_for_ajax($therapist_id,$day_year,$day_month,$day_day,$area){

	$sql = sprintf("
select id from attendance_new
where
today_absence=0 and
attendance_adjustment=0 and
kekkin_flg=0 and
therapist_id='%s' and
year='%s' and
month='%s' and
day='%s' and
area='%s'",
$therapist_id,$day_year,$day_month,$day_day,$area);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		$messe =  "error(check_therapist_attendance_exist_new_for_ajax)";
		man_error_log($messe);
		exit();

	}

	$num = mysql_num_rows($res);

	if( $num > 0 ){

		return true;
		exit();

	}else{

		return false;
		exit();

	}

}

function insert_attendance_request_data($year,$month,$day,$area){

	$sql = sprintf("
insert into attendance_request(area,year,month,day) values('%s','%s','%s','%s')",
$area,$year,$month,$day);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		return false;
		exit();

	}

	return true;
	exit();

}

//チェックされたセラピストは除く
function remove_therapist_at_attendance_request($therapist_data,$therapist_id_array){

	$therapist_data_num = count($therapist_data);
	$therapist_id_array_num = count($therapist_id_array);
	$data = array();

	$z = 0;

	for( $i=0; $i<$therapist_data_num; $i++ ){

		$therapist_id = $therapist_data[$i]["id"];

		$match_flg = false;

		for( $x=0; $x<$therapist_id_array_num; $x++ ){

			$remove_therapist_id = $therapist_id_array[$x];

			if( $therapist_id == $remove_therapist_id ){

				$match_flg = true;

			}

		}

		if( $match_flg == false ){

			$data[$z] = $therapist_data[$i];

			$z++;

		}

	}

	return $data;
	exit();

}

function allow_url_check($login_staff_type,$file_name,$shop_area){		//※使用されていないかもしれない

	$allow_flg = false;

	if( $login_staff_type == "11" ){

		$allow_url = array(
			0 => "staff_calendar_new.php",
			1 => "reservation_status_board.php",
			2 => "therapist_attendance_edit_input_new.php",
			3 => "therapist_attendance_edit_complete_new.php",
			4 => "reservation_status_board_edit.php",
			5 => "reservation_status_board_edit_complete.php",
			6 => "sale_shop.php",
			7 => "sale_operation.php",
			8 => "sale_move_cost.php",
			9 => "sale_move_cost_one.php",
			10 => "sale_move_cost_edit.php",
			11 => "sale_move_cost_edit_complete.php"
		);

		$allow_area = "sapporo";

	}else if( $login_staff_type == "12" ){

		$allow_url = array(
			0 => "staff_calendar_new.php"
		);

		$allow_area = "sapporo";

	}else if( $login_staff_type == "13" ){

		$allow_url = array(
			0 => "staff_calendar_new.php",
			1 => "reservation_status_board.php",
			2 => "therapist_attendance_edit_input_new.php",
			3 => "therapist_attendance_edit_complete_new.php",
			4 => "reservation_status_board_edit.php",
			5 => "reservation_status_board_edit_complete.php"
		);

		$allow_area = "sapporo";

	}else if( $login_staff_type == "14" ){

		$allow_url = array(
			0 => "staff_calendar_new.php",
			1 => "therapist_attendance_edit_input_new.php",
			2 => "staff_attendance_edit_input_new.php"
		);

		$allow_area = "sapporo";

	}else if( $login_staff_type == "15" ){

		$allow_url = array(
			0 => "reservation_status_board.php",
			1 => "reservation_status_board_edit.php"
		);

		$allow_area = "sapporo";

	}else if( $login_staff_type == "2" ){

		$allow_url = array(
			0 => "staff_calendar_new.php",
			1 => "reservation_status_board.php"
		);

		$allow_area = "tokyo";

	}else if( $login_staff_type == "21" ){

		$allow_url = array(
			0 => "staff_calendar_new.php",
			1 => "reservation_status_board.php",
			2 => "reservation_status_board_edit.php",
			3 => "reservation_status_board_edit_complete.php",
			4 => "sale_shop.php",
			5 => "sale_operation.php",
			6 => "sale_move_cost.php",
			7 => "sale_move_cost_one.php",
			8 => "sale_move_cost_edit.php",
			9 => "sale_move_cost_edit_complete.php"
		);

		$allow_area = "yokohama";

	}else if( $login_staff_type == "22" ){

		$allow_url = array(
			0 => "reservation_status_board.php",
			1 => "reservation_status_board_edit.php",
			2 => "reservation_status_board_edit_complete.php"
		);

		$allow_area = "yokohama";

	}else if( $login_staff_type == "23" ){

		$allow_url = array(
			0 => "staff_calendar_new.php",
			1 => "therapist_attendance_edit_input_new.php",
			2 => "staff_attendance_edit_input_new.php"
		);

		$allow_area = "yokohama";

	}else if( $login_staff_type == "24" ){

		$allow_url = array(
			0 => "reservation_status_board.php",
			1 => "reservation_status_board_edit.php"
		);

		$allow_area = "yokohama";

	}else if( $login_staff_type == "41" ){

$allow_url = array(
	0 => "staff_calendar_new.php",
	1 => "reservation_status_board.php",
	2 => "therapist_attendance_regist_input_new.php",
	3 => "therapist_attendance_regist_complete_new.php",
	4 => "staff_attendance_regist_input_new.php",
	5 => "staff_attendance_regist_complete_new.php",
	6 => "therapist_attendance_edit_input_new.php",
	7 => "therapist_attendance_edit_complete_new.php",
	8 => "staff_attendance_edit_input_new.php",
	9 => "staff_attendance_edit_complete_new.php",
	10 => "therapist_attendance_delete_complete_new.php",
	11 => "staff_attendance_delete_complete_new.php",
	12 => "reservation_status_board_edit.php",
	13 => "reservation_status_board_edit_complete.php",
	14 => "sale_shop.php",
	15 => "sale_operation.php",
	16 => "sale_move_cost.php",
	17 => "sale_move_cost_one.php",
	18 => "sale_move_cost_edit.php",
	19 => "sale_move_cost_edit_complete.php"
);

		$allow_area = "osaka";

	}else if( $login_staff_type == "42" ){

		$allow_url = array(
			0 => "staff_calendar_new.php",
			1 => "therapist_attendance_edit_input_new.php",
			2 => "staff_attendance_edit_input_new.php"
		);

		$allow_area = "osaka";

	}else if( $login_staff_type == "43" ){

		$allow_url = array(
			0 => "reservation_status_board.php",
			1 => "reservation_status_board_edit.php"
		);

		$allow_area = "osaka";

	}else if( $login_staff_type == "51" ){

		$allow_url = array(
			0 => "staff_calendar_new.php",
			1 => "reservation_status_board.php",
			2 => "therapist_attendance_edit_input_new.php",
			3 => "therapist_attendance_edit_complete_new.php",
			4 => "sale_shop.php",
			5 => "sale_operation.php",
			6 => "sale_move_cost.php",
			7 => "sale_move_cost_one.php",
			8 => "sale_move_cost_edit.php",
			9 => "sale_move_cost_edit_complete.php"
		);

		$allow_area = "sendai";

	}else if( $login_staff_type == "52" ){

		$allow_url = array(
			0 => "staff_calendar_new.php",
			1 => "therapist_attendance_edit_input_new.php",
			2 => "staff_attendance_edit_input_new.php"
		);

		$allow_area = "sendai";

	}else if( $login_staff_type == "53" ){

		$allow_url = array(
			0 => "reservation_status_board.php",
			1 => "reservation_status_board_edit.php"
		);

		$allow_area = "sendai";

	}else if( $login_staff_type == "54" ){

		$allow_url = array(
			0 => "staff_calendar_new.php",
			1 => "reservation_status_board.php",
			2 => "therapist_attendance_edit_input_new.php",
			3 => "therapist_attendance_edit_complete_new.php",
			4 => "reservation_status_board_edit.php",
			5 => "reservation_status_board_edit_complete.php"
		);

		$allow_area = "sendai";

	}else if( $login_staff_type == "31" ){

		$allow_url = array(
		0 => "staff_calendar_kensyuu.php"
		);

		$allow_area = "kensyuu";

	}else{

		return $allow_flg;
		exit();

	}

	$allow_url_num = count($allow_url);

	for( $i=0; $i<$allow_url_num; $i++ ){

		$allow_url_tmp = $allow_url[$i];

		if( ( $allow_url_tmp == $file_name ) && ( $allow_area == $shop_area ) ){

			$allow_flg = true;

		}

	}

	return $allow_flg;
	exit();

}

function get_attendance_request_state($year,$month,$day,$area){

	$sql = sprintf("
select id from attendance_request
where
delete_flg=0 and
year='%s' and
month='%s' and
day='%s' and
area='%s'",
	$year,$month,$day,$area);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(get_attendance_request_state)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	$id = $row["id"];

	if( $id == "" ){

		return false;
		exit();

	}else{

		return true;
		exit();

	}

}

function delete_attendance_request($year,$month,$day,$area){

	$sql = sprintf("
delete from attendance_request where year='%s' and month='%s' and day='%s' and area='%s'",
$year,$month,$day,$area);

	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(delete_attendance_request)";
		exit();
	}

	return true;
	exit();

}

//therapist_id重複チェック
function check_duplication_therapist_id_in_attendance_new($data,$therapist_id){

	$data_num = count($data);

	for($i=0;$i<$data_num;$i++){

		$therapist_id_tmp = $data[$i]["therapist_id"];

		if( $therapist_id_tmp == $therapist_id ){

			return true;
			exit();
		}

	}

	return false;
	exit();

}

function get_value_by_tbl_name_and_get_column_name_where_column_name($where_value,$tbl_name,$get_column_name,$where_column_name){

	$sql = sprintf("
select %s from %s where %s='%s'",
$get_column_name,$tbl_name,$where_column_name,$where_value);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(get_value_by_tbl_name_and_get_column_name_where_column_name)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	return $row[$get_column_name];
	exit();

}

//セラピストIDからエリアを取得
function get_area_from_therapist_new_by_therapist_id($therapist_id){

	$sql = sprintf("select area from therapist_new where id='%s'",$therapist_id);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(get_area_from_therapist_new_by_therapist_id)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	return $row["area"];
	exit();

}

function get_sokuhou_price_area($year,$month,$day,$area){

	$sql = sprintf("
select price from sale_history where
delete_flg=0 and
eigyou_year='%s' and
eigyou_month='%s' and
eigyou_day='%s' and
area='%s'",
$year,$month,$day,$area);

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_sokuhou_price_area)";
		exit();

	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$list_data[$i++] = $row;

	}

	$list_data_num = count($list_data);

	$total = 0;

	for($i=0;$i<$list_data_num;$i++){

		$price = $list_data[$i]["price"];

		$total = $total + $price;

	}

	return $total;
	exit();

}

function get_sokuhou_price_area_by_therapist_id($year,$month,$day,$area,$therapist_id){

	//$sql = sprintf("select price from sale_history where delete_flg=0 and eigyou_year='%s' and eigyou_month='%s' and eigyou_day='%s' and area='%s' and therapist_id='%s'", $year,$month,$day,$area,$therapist_id);
	$sql = sprintf("select price from sale_history where delete_flg=0 and eigyou_year='%s' and eigyou_month='%s' and eigyou_day='%s' and therapist_id='%s'", $year,$month,$day,$therapist_id);	//update by aida at 20180409
	$res = mysql_query($sql, DbCon);
	if( $res == false ){
		echo "error!(get_sokuhou_price_area_by_therapist_id)";
		exit();
	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$list_data[$i++] = $row;

	}

	$list_data_num = count($list_data);

	$total = 0;

	for($i=0;$i<$list_data_num;$i++){

		$price = $list_data[$i]["price"];

		$total = $total + $price;

	}

	return $total;
	exit();

}

function get_sokuhou_honsuu_area($year,$month,$day,$area){

	$sql = sprintf("
select id from sale_history where
delete_flg=0 and
eigyou_year='%s' and
eigyou_month='%s' and
eigyou_day='%s' and
area='%s'",
$year,$month,$day,$area);

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_sokuhou_honsuu_area)";
		exit();

	}

	$num = mysql_num_rows($res);

	return $num;
	exit();

}

function get_attendance_kensyuu_all_data_one($year,$month,$day){

	$sql = sprintf("select * from attendance_kensyuu_all where delete_flg=0 and year='%s' and month='%s' and day='%s'",$year,$month,$day);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_attendance_kensyuu_all_data_one)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();
}

function check_attendance_kensyuu_all_data_exist($year,$month,$day){

	$sql = sprintf("select id from attendance_kensyuu_all where delete_flg=0 and year='%s' and month='%s' and day='%s'",$year,$month,$day);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(check_attendance_kensyuu_all_data_exist)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	if( $row["id"] == "" ){

		return false;
		exit();

	}else{

		return true;
		exit();

	}

}

function check_attendance_kensyuu_all_data_exist_return_id($year,$month,$day){

	$sql = sprintf("select id from attendance_kensyuu_all where delete_flg=0 and year='%s' and month='%s' and day='%s'",$year,$month,$day);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(check_attendance_kensyuu_all_data_exist_return_id)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	if( $row["id"] == "" ){

		return false;
		exit();

	}else{

		return $row["id"];
		exit();

	}
}

function delete_attendance_kensyuu_all_data_one($year,$month,$day){

	$sql = sprintf("delete from attendance_kensyuu_all where year='%s' and month='%s' and day='%s'",$year,$month,$day);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(delete_attendance_kensyuu_all_data_one)";
		exit();
	}

	return true;
	exit();
}

function update_attendance_kensyuu_all_data_one($year,$month,$day,$start_time,$end_time){

	$sql = sprintf("update attendance_kensyuu_all set start_time='%s',end_time='%s' where year='%s' and month='%s' and day='%s'",$start_time,$end_time,$year,$month,$day);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(update_attendance_kensyuu_all_data_one)";
		exit();
	}

	return true;
	exit();
}

function get_attendance_disp_time_therapist_kensyuu_new($start_time,$end_time,$work_flg){

	include(MAN_INC."define.php");

	$data = "";

	if($end_time=="23"){

		$hour = $time_array[$start_time]["hour"];
		$minute = $time_array[$start_time]["minute"];

		if($minute=="0"){

			$data = $hour.'時';

		}else{

			$data = $hour.'.5'.'時';

		}

	}else{

		$hour_start = $time_array_kensyuu[$start_time]["hour"];
		$minute_start = $time_array_kensyuu[$start_time]["minute"];
		$hour_end = $time_array_kensyuu[$end_time]["hour"];
		$minute_end = $time_array_kensyuu[$end_time]["minute"];

		if($minute_start != "0"){

			$hour_start = $hour_start.".5";

		}

		if($minute_end != "0"){

			$hour_end = $hour_end.".5";

		}

		$data = $hour_start."-".$hour_end;

	}

	if( $work_flg == "1" ){

		$data .= "<br />出勤";

	}

	return $data;
	exit();

}

//車の画像を削除
function delete_staff_car_image($car_image_url,$staff_id){

	$pic_url = ROOT_PATH.$car_image_url;

	/*
	$res = unlink($pic_url);
	if($res==false){
		echo "error!";
	}else{
		echo "ok!";
	}
	exit();
	*/

	// imageを削除する処理
	$sql = sprintf("update staff_new_new set car_image_url='%s' where id='%s'",null,$staff_id);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリ実行に失敗しました(delete_staff_car_image)";
		exit();

	}

	unlink($pic_url);

	return true;
	exit();

}

function sale_history_disp_for_confirm($year,$month,$day,$area){

	$sql = sprintf("
select
sale_history.reservation_no,
sale_history.price,
therapist_new.name,
reservation_for_board.shop_name,
reservation_for_board.area_name,
reservation_for_board.customer_name
from sale_history
left join therapist_new on therapist_new.id=sale_history.therapist_id
left join reservation_for_board on reservation_for_board.reservation_no=sale_history.reservation_no
where
sale_history.delete_flg=0 and
reservation_for_board.delete_flg=0 and
sale_history.eigyou_year='%s' and
sale_history.eigyou_month='%s' and
sale_history.eigyou_day='%s' and
sale_history.area='%s'",
$year,$month,$day,$area);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);
	if($res == false){

		echo "クエリー実行で失敗しました(sale_history_disp_for_confirm)";
		exit();

	}
	$i=0;
	$list_data = array();
	while($row = mysql_fetch_assoc($res)){
		$list_data[$i++] = $row;
	}

	$html = "";

	$list_data_num = count($list_data);

	$price_all = 0;

	for( $i=0; $i<$list_data_num; $i++ ){

		$reservation_no = $list_data[$i]["reservation_no"];
		$price = $list_data[$i]["price"];
		$name = $list_data[$i]["name"];
		$shop_name = $list_data[$i]["shop_name"];
		$area_name = $list_data[$i]["area_name"];
		$customer_name = $list_data[$i]["customer_name"];
		$no = $i+1;

		$price_all = $price_all + $price;

$html .=<<<EOT

番号：{$no}
予約No：{$reservation_no}
料金：{$price}円
セラピスト名：{$name}
店名：{$shop_name}
エリア名：{$area_name}
客名：{$customer_name}
-------------------------------------------

EOT;

	}

$html .=<<<EOT

本数：{$no}本
合計金額：{$price_all}円

EOT;

	echo nl2br($html);
	exit();

}

//出席データの取得(日にちから)
function get_attendance_id_by_time($therapist_id,$year,$month,$day){

	$sql = sprintf("
select * from attendance_new where
therapist_id='%s' and
year='%s' and
month='%s' and
day='%s'",
$therapist_id,$year,$month,$day);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリー実行で失敗しました(get_attendance_id_by_time)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();
}

function attendance_data_exist_check($therapist_id,$year,$month,$day){

	$sql = sprintf("
select id from attendance_new where
therapist_id='%s' and
year='%s' and
month='%s' and
day='%s'",
$therapist_id,$year,$month,$day);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリー実行で失敗しました(attendance_data_exist_check)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	$id = $row["id"];

	if( $id == "" ){

		return false;
		exit();

	}else{

		return true;
		exit();

	}

}

function add_help_page($help_title,$help_content){

	$sql = sprintf("insert into help_page(title,content) values('%s','%s')",$help_title,$help_content);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(add_help_page)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return true;
	exit();
}

function get_help_page(){

	$sql = "select * from help_page where delete_flg=0 order by order_value desc";
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(get_help_page)";
		exit();
	}
	$i=0;
	$list_data = array();
	while($row = mysql_fetch_assoc($res)){
		$list_data[$i++] = $row;
	}

	return $list_data;
	exit();

}

function get_message_board(){

	$sql = "select * from message_board where delete_flg=0 order by created desc";
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(get_message_board)";
		exit();
	}
	$i=0;
	$list_data = array();
	while($row = mysql_fetch_assoc($res)){
		$list_data[$i++] = $row;
	}

	return $list_data;
	exit();
}

function get_message_board_driver(){

	$sql = "select * from message_board_driver where delete_flg=0 order by created desc";
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(get_message_board_driver)";
		exit();
	}
	$i=0;
	$list_data = array();
	while($row = mysql_fetch_assoc($res)){
		$list_data[$i++] = $row;
	}

	return $list_data;
	exit();

}

function delete_help($help_id){

	$sql = sprintf("update help_page set delete_flg='1' where id='%s'",$help_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(delete_help)";
		exit();
	}

	return true;
	exit();
}

function update_help($help_id,$help_title,$help_content,$order_value){

	$sql = sprintf("
update help_page set
title='%s',
content='%s',
order_value='%s'
where id='%s'",
$help_title,$help_content,$order_value,$help_id);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリー実行で失敗しました(update_help)";
		exit();

	}

	return true;
	exit();
}

function get_publish_flg_by_attendance_id($attendance_id){

	$sql = sprintf("select publish_flg from attendance_new where id='%s'",$attendance_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(get_publish_flg_by_attendance_id)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row["publish_flg"];
	exit();
}

function get_cti_id_by_reservation_for_board_id($reservation_for_board_id){

	$sql = sprintf("select cti_id from reservation_for_board where id='%s'",$reservation_for_board_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(get_cti_id_by_reservation_for_board_id)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row["cti_id"];
	exit();
}

function get_driver_data_by_id($driver_id){

	$sql = sprintf("select * from staff_new_new where id='%s'",$driver_id);

	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(get_driver_data_by_id)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();
}

function get_therapist_data_by_id($id){

	$sql = sprintf("select * from therapist_new where id='%s'",$id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_therapist_data_by_id)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();
}

function get_cti_mail_data_by_cti_id($cti_id){

	$sql = sprintf("select * from cti where id='%s'",$cti_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(get_cti_mail_data_by_cti_id)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();
}

function edit_mail_body_for_driver($body){

	$return_data = array();

	$body = trim($body);

	$body = preg_replace('/【予約情報】.*?■店舗/s','■店舗',$body);
	$body = preg_replace('/【着信情報】.*【顧客情報】/s','【顧客情報】',$body);

	// 改行コードをカンマに変換
	$str = str_replace(array("\r\n","\r","\n"), ",", $body);

	// カンマ区切りに配列に格納
	$hairetsu = spliti( ',', $str );

	$hairetsu_num = count($hairetsu);

	$x = 0;

	for($i=0;$i<$hairetsu_num;$i++){

		$skip_flg = false;

		$tmp_data = $hairetsu[$i];

		if (preg_match("/^■その他料金 ： /",$tmp_data)) {

			$skip_flg = true;

		}else if (preg_match("/^■名前 ： /",$tmp_data)) {

			$skip_flg = true;

		}else if (preg_match("/^■フリガナ ： /",$tmp_data)) {

			$skip_flg = true;

		}else if (preg_match("/^■会員ID ： /",$tmp_data)) {

			$skip_flg = true;

		}else if (preg_match("/^■分類 ： /",$tmp_data)) {

			$skip_flg = true;

		}else if (preg_match("/^■電話番号 ： /",$tmp_data)) {

			$skip_flg = true;

		}else if (preg_match("/^■予約回数 ： /",$tmp_data)) {

			$skip_flg = true;

		}else if (preg_match("/^■年代 ： /",$tmp_data)) {

			$skip_flg = true;

		}else if (preg_match("/^■付加情報 ： /",$tmp_data)) {

			$skip_flg = true;

		}

		if( $skip_flg != true ){

			$return_data[$x] = $tmp_data;
			$x++;

		}

	}

	$return_data_num = count($return_data);

	$return_data_str = "";

	for( $i=0; $i<$return_data_num; $i++ ){

		$return_data_str .= $return_data[$i]."\r\n";

	}

	return $return_data_str;
	exit();

}

function get_time_value_for_board($hour,$minute){

	$hour = intval($hour);
	$minute = intval($minute);

	$time_array_board = get_time_array_board();

	$time_array_board_num = count($time_array_board);

	for( $i=1; $i<=$time_array_board_num; $i++ ){

		$hour_tmp = $time_array_board[$i]["hour"];
		$minute_tmp = $time_array_board[$i]["minute"];

		if( ($hour == $hour_tmp) && ($minute == $minute_tmp) ){

			return $i;
			exit();

		}

	}

	return "-1";
	exit();

}

function get_therapist_kenmu_value($therapist_id){

	$sql = sprintf("select kenmu from therapist_new where id='%s'",$therapist_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(get_therapist_kenmu_value)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row["kenmu"];
	exit();
}

function get_kensyuu_flg_by_id($therapist_id){

	$sql = sprintf("select kensyuu_flg from therapist_new where id='%s'",$therapist_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(get_kensyuu_flg_by_id)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row["kensyuu_flg"];
	exit();
}

function get_therapist_area_by_id($therapist_id){

	$sql = sprintf("select area from therapist_new where id='%s'",$therapist_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(get_therapist_area_by_id)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row["area"];
	exit();
}

function delete_attendance_data_by_therapist_id($therapist_id,$year,$month,$day){

	$sql = sprintf("
delete from attendance_new
where
therapist_id='%s' and
year='%s' and
month='%s' and
day='%s'",
$therapist_id,$year,$month,$day);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){
		echo "error!(delete_attendance_data_by_therapist_id)";
		exit();
	}

	return true;
	exit();

}

function check_boss_exist($area){

	$sql = sprintf("select id from staff_new_new where delete_flg=0 and boss_flg=1 and area='%s'",$area);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(check_boss_exist)";
		exit();
	}

	$num = mysql_num_rows($res);

	if( $num > 0 ){

		return true;
		exit();

	}else{

		return false;
		exit();

	}
}

function get_driver_name_for_board($driver_id){

	$name = "";

	if( ($driver_id == "-1") || ($driver_id == "") ){

		$name = "なし";

	}else if( $driver_id == "-2" ){

		$name = "TAXI";

	}else if( $driver_id == "-3" ){

		$name = "本部";

	}else{

		$name = get_staff_name_by_staff_id_common($driver_id);

	}

	return $name;
	exit();

}

function insert_therapist_data(
$name_real,$mail,$name_site,$name_aroma,$name_tgr,$name_lymph,$area,$kenmu_string,$rank,$jitaku_taiki_flg,
$for_kobetsu_url,$kensyuu_flg,$jisou_flg,$point_ref,$guarantee_rule,$address,$tel,
$bank_info,$name_furi,$furikomi_type){

	$rank_order_num = get_rank_order_num($rank);

	if( $jitaku_taiki_flg != "1" ){
		$jitaku_taiki_flg = 0;
	}

	if( $jisou_flg != "1" ){
		$jisou_flg = 0;
	}

	$name_real = trim($name_real);
	$name_site = trim($name_site);
	$name_aroma = trim($name_aroma);

	// 会員情報を登録するSQL文
	$sql = sprintf("
insert into therapist_new(
name,mail,name_site,name_aroma,name_tgr,name_lymph,area,kenmu,rank,jitaku_taiki_flg,for_kobetsu_url,
kensyuu_flg,jisou_flg,rank_order_num,point_ref,guarantee_rule,address,tel,
bank_info,name_furi,furikomi_type)
values('%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s')"
,$name_real,$mail,$name_site,$name_aroma,$name_tgr,$name_lymph,$area,$kenmu_string,$rank,$jitaku_taiki_flg,
$for_kobetsu_url,$kensyuu_flg,$jisou_flg,$rank_order_num,$point_ref,$guarantee_rule,
$address,$tel,$bank_info,$name_furi,$furikomi_type);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリ実行に失敗しました(insert_therapist_data)";
		exit();
	}

	return true;
	exit();

}

function insert_therapist_data_relax(
$name_real,$mail,$name_site,$name_aroma,$name_tgr,$name_lymph,$area,$kenmu_string,$rank,$jitaku_taiki_flg,
$for_kobetsu_url,$kensyuu_flg,$jisou_flg,$point_ref,$guarantee_rule,$address,$tel,
$bank_info,$name_furi,$furikomi_type,$wait_txt,$share_rate,$furikomi_fee){

	$rank_order_num = get_rank_order_num($rank);

	if( $jitaku_taiki_flg != "1" ){
		$jitaku_taiki_flg = 0;
	}

	if( $jisou_flg != "1" ){
		$jisou_flg = 0;
	}
    $area = $area . "_reraku";
	$name_real = trim($name_real);
	$name_site = trim($name_site);
	$name_aroma = trim($name_aroma);

	// 会員情報を登録するSQL文
	$sql = sprintf("
insert into therapist_new(
name,mail,name_site,name_aroma,name_tgr,name_lymph,area,kenmu,rank,jitaku_taiki_flg,for_kobetsu_url,
kensyuu_flg,jisou_flg,rank_order_num,point_ref,guarantee_rule,address,tel,
bank_info,name_furi,furikomi_type,wait_txt,share_rate,furikomi_fee,payment_span,tax_flg)
values('%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s')"
,$name_real,$mail,$name_site,$name_aroma,$name_tgr,$name_lymph,$area,$kenmu_string,$rank,$jitaku_taiki_flg,
$for_kobetsu_url,$kensyuu_flg,$jisou_flg,$rank_order_num,$point_ref,$guarantee_rule,
$address,$tel,$bank_info,$name_furi,$furikomi_type,$wait_txt,$share_rate,$furikomi_fee);



	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリ実行に失敗しました(insert_therapist_data_relax)";
		exit();
	}

	return true;
	exit();

}


function get_rank_order_num($rank){

	$data = 1000;

	if( $rank == "1" ){

		//A
		$data = 10;

	}else if( $rank == "4" ){

		//新人
		$data = 9;

	}else if( $rank == "2" ){

		//B
		$data = 30;

	}else if( $rank == "3" ){

		//C
		$data = 40;

	}else if( $rank == "5" ){

		//D
		$data = 50;

	}else{

		//対象外
		$data = 60;

	}

	return $data;
	exit();

}

function get_point_ref_select($point_ref,$area){

	if( $area == "tokyo" ){

		$menu = array(
			0 => array("value"=>"1","word"=>"東京1")
		);

	}else if(( $area == "yokohama" ) || ( $area == "yokohama2" )){

		$menu = array(
			0 => array("value"=>"1","word"=>"横浜1")
		);

	}else if( $area == "sapporo" ){

		$menu = array(
			0 => array("value"=>"1","word"=>"札幌1")
		);

	}else if( $area == "sendai" ){

		$menu = array(
			0 => array("value"=>"1","word"=>"仙台1")
		);
//2018/11/14 murase update from
	}else if( $area == "fukuoka" ){

		$menu = array(
			0 => array("value"=>"1","word"=>"福岡1")
		);

	}
//2018/11/14 murase update to
	$menu_num = count($menu);

	$option = "";

	for( $i=0; $i<$menu_num; $i++ ){

		$value = $menu[$i]["value"];
		$word = $menu[$i]["word"];

		if( $point_ref == $value ){

			$option .= sprintf('<option value="%s" selected>%s</option>',$value,$word);

		}else{

			$option .= sprintf('<option value="%s">%s</option>',$value,$word);

		}
	}

$html =<<<EOT
<select name="point_ref">
<option value="-1">未選択</option>
{$option}
</select>

EOT;

	return $html;
	exit();

}

function get_guarantee_rule_select($guarantee_rule,$area){

	if( $area == "tokyo" ){

		$menu = array(
			0 => array("value"=>"1","word"=>"東京1"),
			1 => array("value"=>"21","word"=>"適用なし")
		);

	}else if(( $area == "yokohama" )||( $area == "yokohama2" )||( $area == "yokohama2_refres" )){

		$menu = array(
			0 => array("value"=>"1","word"=>"横浜1"),
			1 => array("value"=>"21","word"=>"適用なし")
		);

	}else if( $area == "sapporo" ){

		$menu = array(
			0 => array("value"=>"1","word"=>"札幌1"),
			1 => array("value"=>"21","word"=>"適用なし")
		);

	}else if( $area == "sendai" ){

		$menu = array(
			0 => array("value"=>"1","word"=>"仙台1"),
			1 => array("value"=>"21","word"=>"適用なし")
		);
	//21018/11/14 murase update from
	}else if( $area == "fukuoka" ){

		$menu = array(
			0 => array("value"=>"1","word"=>"福岡1"),
			1 => array("value"=>"21","word"=>"適用なし")
		);
	//21018/11/14 murase update from
	}else if( $area == "tokyo_reraku" ){

		$menu = array(
			0 => array("value"=>"1","word"=>"東京1"),
			1 => array("value"=>"21","word"=>"適用なし")
		);

	}else if( $area == "tokyo_bigao" ){

		$menu = array(
			0 => array("value"=>"1","word"=>"東京1"),
			1 => array("value"=>"21","word"=>"適用なし")
		);

	}

	$menu_num = count($menu);

	$option = "";

	for( $i=0; $i<$menu_num; $i++ ){

		$value = $menu[$i]["value"];
		$word = $menu[$i]["word"];

		if( $guarantee_rule == $value ){

			$option .= sprintf('<option value="%s" selected>%s</option>',$value,$word);

		}else{

			$option .= sprintf('<option value="%s">%s</option>',$value,$word);

		}
	}

$html =<<<EOT
<select name="guarantee_rule">
<option value="-1">未選択</option>
{$option}
</select>

EOT;

	return $html;
	exit();

}

function get_point_ref_disp($point_ref,$area){

	if( $area == "tokyo" ){

		$menu = array(
			0 => array("value"=>"1","word"=>"東京1")
		);

	}else if( $area == "yokohama" ){

		$menu = array(
			0 => array("value"=>"1","word"=>"横浜1")
		);

	}else if( $area == "sapporo" ){

		$menu = array(
			0 => array("value"=>"1","word"=>"札幌1")
		);

	}else if( $area == "sendai" ){

		$menu = array(
			0 => array("value"=>"1","word"=>"仙台1")
		);
	//2018/11/14 murase update from
	}else if( $area == "fukuoka" ){

		$menu = array(
			0 => array("value"=>"1","word"=>"福岡1")
		);
	//2018/11/14 murase update to
	}

	if( $point_ref == "-1" ){

		$return_data = "未選択";

	}else{

		$return_data = "不明";

		$menu_num = count($menu);

		for( $i=0; $i<$menu_num; $i++ ){

			$value = $menu[$i]["value"];
			$word = $menu[$i]["word"];

			if( $point_ref == $value ){

				$return_data = $word;

			}

		}

	}

	return $return_data;
	exit();

}

function get_guarantee_rule_disp($guarantee_rule,$area){

	if( $area == "tokyo" ){

		$menu = array(
			0 => array("value"=>"1","word"=>"東京1"),
			1 => array("value"=>"21","word"=>"適用なし")
		);

	}else if( $area == "yokohama" ){

		$menu = array(
			0 => array("value"=>"1","word"=>"横浜1"),
			1 => array("value"=>"21","word"=>"適用なし")
		);

	}else if( $area == "sapporo" ){

		$menu = array(
			0 => array("value"=>"1","word"=>"札幌1"),
			1 => array("value"=>"21","word"=>"適用なし")
		);

	}else if( $area == "sendai" ){

		$menu = array(
			0 => array("value"=>"1","word"=>"仙台1"),
			1 => array("value"=>"21","word"=>"適用なし")
		);
	//2018/11/14 murase update from
	}else if( $area == "fukuoka" ){

		$menu = array(
			0 => array("value"=>"1","word"=>"福岡1"),
			1 => array("value"=>"21","word"=>"適用なし")
		);
	//2018/11/14 murase update to
	}

	if( $guarantee_rule == "-1" ){

		$return_data = "未選択";

	}else{

		$return_data = "不明";

		$menu_num = count($menu);

		for( $i=0; $i<$menu_num; $i++ ){

			$value = $menu[$i]["value"];
			$word = $menu[$i]["word"];

			if( $guarantee_rule == $value ){

				$return_data = $word;

			}

		}

	}

	return $return_data;
	exit();

}

function get_staff_attendance_data_by_time($staff_id,$year,$month,$day){

	$sql = sprintf("
select * from attendance_staff_new where
staff_id='%s' and
year='%s' and
month='%s' and
day='%s' and
today_absence=0 and
attendance_adjustment=0",
$staff_id,$year,$month,$day);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリー実行で失敗しました(get_staff_attendance_data_by_time)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();

}

function get_attendance_staff_new_by_id($id){

	$sql = sprintf("select * from attendance_staff_new where id='%s'",$id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(get_attendance_staff_new_by_id)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();
}

function get_time_disp($time_array,$value){

	$hour = $time_array[$value]["hour"];
	$minute = $time_array[$value]["minute"];

	if( $minute == "0" ){

		$minute = "0".$minute;

	}

	$disp_data = $hour.":".$minute;

	return $disp_data;
	exit();

}

function get_work_time($start_time,$end_time){

	$work_time = round( (($end_time-$start_time)/2) , 1 );

	return $work_time;
	exit();

}

function get_gasoline_value_from_settings($area){

	$sql = sprintf("select value from settings where name='gasoline' and area='%s'",$area);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(get_gasoline_value_from_settings)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row["value"];
	exit();
}

function update_gasoline_value_at_settings($gasoline_value,$area){

	$sql = sprintf("update settings set value='%s' where name='gasoline' and area='%s'",$gasoline_value,$area);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(update_gasoline_value_at_settings)";
		exit();
	}

	return true;
	exit();
}

function get_month_last_day($year,$month){

	$last_day = date('t', mktime(0, 0, 0, $month, 1, $year));

	return $last_day;
	exit();

}

function update_sale_driver_one($attendance_id,$frm_val,$action_type){

	$data = get_attendance_staff_new_by_id($attendance_id);

	$staff_id = $data["staff_id"];
	$area = $data["area"];

	$column_name = "";

	$time_update_flg = false;

	if( $action_type == "car_distance" ){

		$column_name = "car_distance";

	}else if( $action_type == "pay_finish" ){

		$column_name = "pay_finish";

	}else if( $action_type == "allowance" ){

		$column_name = "allowance";

	}else if( $action_type == "highway" ){

		$column_name = "highway";

	}else if( $action_type == "parking" ){

		$column_name = "parking";

	}else if( $action_type == "gasoline" ){

		$column_name = "gasoline";

	}else if( $action_type == "repair" ){

		$column_name = "repair";

	}else if( $action_type == "insurance" ){

		$column_name = "insurance";

	}else if( $action_type == "sonota" ){

		$column_name = "sonota";

	}else if( $action_type == "pay_day" ){

		$column_name = "pay_day";

	}else if( ($action_type == "start_time") || ($action_type == "end_time") ){

		$time_update_flg = true;

	}else{

		return false;
		exit();

	}

	$value_new = $frm_val;

	if( $time_update_flg == true ){

		$value_old = get_value_old_from_attendance_staff_new_time($action_type,$attendance_id);

	}else{

		$value_old = get_value_old_from_attendance_staff_new($column_name,$attendance_id);

	}

	//トランザクションをはじめる準備
	$sql = "set autocommit = 0";
	mysql_query( $sql, DbCon );

	//トランザクション開始
	$sql = "begin";
	mysql_query( $sql, DbCon );

	if( $time_update_flg == true ){

		$pieces = explode("_",$frm_val);

		$hour = $pieces[0];
		$minute = $pieces[1];

		if( $action_type == "start_time" ){

$sql = sprintf("
update attendance_staff_new set start_hour='%s',start_minute='%s' where id='%s'",
$hour,$minute,$attendance_id);

		}else if( $action_type == "end_time" ){

$sql = sprintf("
update attendance_staff_new set end_hour='%s',end_minute='%s' where id='%s'",
$hour,$minute,$attendance_id);

		}else{

			return false;
			exit();

		}

	}else{

$sql = sprintf("
update attendance_staff_new set %s='%s' where id='%s'",
$column_name,$frm_val,$attendance_id);

	}

	$res = mysql_query($sql, DbCon);

	if($res == false){

		//ロールバック
		$sql = "rollback";
		mysql_query( $sql, DbCon );

		return false;
		exit();

	}

	//payment_change_historyに記録
	$now = time();

	$type = "driver";

	$sql = sprintf("
insert into payment_change_history(created,name,value_old,value_new,staff_id,area,attendance_id,type)
values('%s','%s','%s','%s','%s','%s','%s','%s')",
$now,$action_type,$value_old,$value_new,$staff_id,$area,$attendance_id,$type);

	$res = mysql_query($sql, DbCon);

	if($res === false){

		//ロールバック
		$sql = "rollback";
		mysql_query( $sql, DbCon );

		return false;
		exit();

	}


	//コミット
	$sql = "commit";
	mysql_query( $sql, DbCon );

	return true;
	exit();
}

function update_sale_therapist_one($attendance_id,$frm_val,$action_type){

	$data = get_attendance_data_one_by_attendance_id_common($attendance_id);

	$therapist_id = $data["therapist_id"];
	$area = $data["area"];

	$column_name = "";

	if( $action_type == "pay_another" ){

		$column_name = "pay_another";

	}else if( $action_type == "pay_finish" ){

		$column_name = "pay_finish";

	}else if( $action_type == "pay_day" ){

		$column_name = "pay_day";

	}else if( $action_type == "total_point" ){

		$column_name = "total_point";

	}else if( $action_type == "pt_repeat" ){

		$column_name = "pt_repeat";

	}else if( $action_type == "lowest_guarantee" ){

		$column_name = "lowest_guarantee";

	}else if( $action_type == "pt_operation" ){

		$column_name = "pt_operation";

	}else if( $action_type == "pt_shimei" ){

		$column_name = "pt_shimei";

	}else if( $action_type == "pt_repeat" ){

		$column_name = "pt_repeat";

	}else if( $action_type == "allowance" ){

		$column_name = "allowance";

	}else{

		return false;
		exit();

	}

	$value_new = $frm_val;
	$value_old = get_value_old_at_sale_therapist_one($column_name,$attendance_id,$therapist_id);

	//トランザクションをはじめる準備
	$sql = "set autocommit = 0";
	mysql_query( $sql, DbCon );

	//トランザクション開始
	$sql = "begin";
	mysql_query( $sql, DbCon );

	if( $column_name == "total_point" ){

$sql = sprintf("
update therapist_new set %s='%s' where id='%s'",
$column_name,$frm_val,$therapist_id);

	}else{

$sql = sprintf("
update attendance_new set %s='%s' where id='%s'",
$column_name,$frm_val,$attendance_id);

	}

	$res = mysql_query($sql, DbCon);

	if($res == false){

		//ロールバック
		$sql = "rollback";
		mysql_query( $sql, DbCon );

		return false;
		exit();

	}

	//payment_change_historyに記録
	$now = time();

	$type = "therapist";

	$sql = sprintf("
insert into payment_change_history(created,name,value_old,value_new,therapist_id,area,attendance_id,type)
values('%s','%s','%s','%s','%s','%s','%s','%s')",
$now,$action_type,$value_old,$value_new,$therapist_id,$area,$attendance_id,$type);

	$res = mysql_query($sql, DbCon);

	if($res === false){

		//ロールバック
		$sql = "rollback";
		mysql_query( $sql, DbCon );

		return false;
		exit();

	}


	//コミット
	$sql = "commit";
	mysql_query( $sql, DbCon );

	return true;
	exit();
}

function get_value_old_at_sale_therapist_one($column_name,$attendance_id,$therapist_id){

	if( $column_name == "total_point" ){
		$sql = sprintf("select %s from therapist_new where id='%s'",$column_name,$therapist_id);
	}else{
		$sql = sprintf("select %s from attendance_new where id='%s'",$column_name,$attendance_id);
	}
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(get_value_old_at_sale_therapist_one)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row[$column_name];
	exit();
}

function get_value_old_from_attendance_staff_new($column_name,$attendance_id){

	$sql = sprintf("select %s from attendance_staff_new where id='%s'",$column_name,$attendance_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(get_value_old_from_attendance_staff_new)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row[$column_name];
	exit();
}

function get_value_old_from_attendance_staff_new_time($action_type,$attendance_id){

	$sql = sprintf("select * from attendance_staff_new where id='%s'",$attendance_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(get_value_old_from_attendance_staff_new_time)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	$start_hour = $row["start_hour"];
	$start_minute = $row["start_minute"];
	$end_hour = $row["end_hour"];
	$end_minute = $row["end_minute"];

	$data = "-1";

	if( $action_type == "start_time" ){

		$data = sprintf("%s_%s",$start_hour,$start_minute);

	}else if( $action_type == "end_time" ){

		$data = sprintf("%s_%s",$end_hour,$end_minute);

	}

	return $data;
	exit();
}

function get_sale_driver_month_select_frm($area,$year_hiki,$month_hiki){

	$data = get_most_small_year_and_month($area);

	$most_small_year = $data["year"];
	$most_small_month = $data["month"];

	//今日の年と月
	$year_today = intval(date("Y"));
	$month_today = intval(date("m"));

	$first_flg = true;

	$data = array();
	$z = 0;

	$now_month_flg = false;

	for($i=$most_small_year;$i<=$year_today;$i++){

		if( $first_flg == true ){

			$start_month = $most_small_month;

			$first_flg = false;

		}else{

			$start_month = 1;

		}

		for($x=$start_month;$x<=12;$x++){

			$year = $i;
			$month = $x;

			//データがあるかどうかチェック(ある：true,ない：false)
			$result = check_attendance_staff_new_exist($area,$year,$month);

			if( $result == true ){

				$data[$z]["year"] = $year;
				$data[$z]["month"] = $month;

				$z++;

			}

		}

	}

	/*
	echo "<pre>";
	print_r($data);
	echo "</pre>";
	exit();
	*/

	$data_num = count($data);

	$html = '<select name="month" id="sale_driver_month_select">';
	$html .= '<option value="-1" selected>月選択</option>';

	for($i=($data_num-1);$i>=0;$i--){

		$year = $data[$i]["year"];
		$month = $data[$i]["month"];

		$value_disp = $year."_".$month;
		$word_disp = $year."年".$month."月";

		if( ($year==$year_hiki) && ($month==$month_hiki) ){

$html .= sprintf('<option value="%s" selected>%s</option>',$value_disp,$word_disp);

		}else{

$html .= sprintf('<option value="%s">%s</option>',$value_disp,$word_disp);

		}

	}

	$html .= '</select>';

	return $html;
	exit();

}

function get_sale_therapist_month_select_frm($area,$year_hiki,$month_hiki){

	$data = get_most_small_year_and_month_therapist($area);

	$most_small_year = $data["year"];
	$most_small_month = $data["month"];

	//今日の年と月
	$year_today = intval(date("Y"));
	$month_today = intval(date("m"));

	$first_flg = true;

	$data = array();
	$z = 0;

	$now_month_flg = false;

	for($i=$most_small_year;$i<=$year_today;$i++){

		if( $first_flg == true ){

			$start_month = $most_small_month;

			$first_flg = false;

		}else{

			$start_month = 1;

		}

		for($x=$start_month;$x<=12;$x++){

			$year = $i;
			$month = $x;

			//データがあるかどうかチェック(ある：true,ない：false)
			$result = check_attendance_new_exist($area,$year,$month);

			if( $result == true ){

				$data[$z]["year"] = $year;
				$data[$z]["month"] = $month;

				$z++;

			}

		}

	}

	/*
	echo "<pre>";
	print_r($data);
	echo "</pre>";
	exit();
	*/

	$data_num = count($data);

	$html = '<select name="month" id="sale_driver_month_select">';
	$html .= '<option value="-1" selected>月選択</option>';

	for($i=($data_num-1);$i>=0;$i--){

		$year = $data[$i]["year"];
		$month = $data[$i]["month"];

		$value_disp = $year."_".$month;
		$word_disp = $year."年".$month."月";

		if( ($year==$year_hiki) && ($month==$month_hiki) ){

			$html .= sprintf('<option value="%s" selected>%s</option>',$value_disp,$word_disp);

		}else{

			$html .= sprintf('<option value="%s">%s</option>',$value_disp,$word_disp);

		}

	}

	$html .= '</select>';

	return $html;
	exit();

}

function get_most_small_year_and_month($area){

	$sql = sprintf("select year from attendance_staff_new where area='%s' order by year asc",$area);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(get_most_small_year_and_month)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	$year = $row["year"];

	$sql = sprintf("select month from attendance_staff_new where area='%s' and year='%s' order by month asc",$area,$year);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(get_most_small_year_and_month)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	$month = $row["month"];

	$data["year"] = $year;
	$data["month"] = $month;

	return $data;
	exit();
}

function get_most_small_year_and_month_therapist($area){

	$sql = sprintf("
select year from attendance_new
where
area='%s' and
today_absence='0' and
kekkin_flg='0' and
syounin_state='1'
order by year asc",
$area);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリー実行で失敗しました(get_most_small_year_and_month_therapist)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	$year = $row["year"];

	$sql = sprintf("
select month from attendance_new
where area='%s' and
year='%s' and
today_absence='0' and
kekkin_flg='0' and
syounin_state='1'
order by month asc",
$area,$year);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリー実行で失敗しました(get_most_small_year_and_month_therapist)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	$month = $row["month"];

	$data["year"] = $year;
	$data["month"] = $month;

	return $data;
	exit();

}

//データがあるかどうかチェック(ある：true,ない：false)
function check_attendance_staff_new_exist($area,$year,$month){

	$sql = sprintf("select id from attendance_staff_new where area='%s' and year='%s' and month='%s'",$area,$year,$month);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(check_attendance_staff_new_exist)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	if( $row["id"] == "" ){

		return false;
		exit();

	}else{

		return true;
		exit();

	}
}

//データがあるかどうかチェック(ある：true,ない：false)
function check_attendance_new_exist($area,$year,$month){

	$sql = sprintf("
select id from attendance_new
where
area='%s' and
year='%s' and
month='%s' and
today_absence='0' and
kekkin_flg='0' and
syounin_state='1'",
$area,$year,$month);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリー実行で失敗しました(check_attendance_new_exist)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	if( $row["id"] == "" ){

		return false;
		exit();

	}else{

		return true;
		exit();

	}


}

function get_sale_driver_day_select_frm($area,$year,$month,$day_hiki){

	$most_small_day = get_most_small_day($area,$year,$month);

	$data = array();
	$x=0;

	for( $i=$most_small_day; $i<32; $i++ ){

		$day = $i;

		//データがあるかどうかチェック(ある：true,ない：false)
		$result = check_attendance_staff_new_exist_plus_day($area,$year,$month,$day);

		if( $result == true ){

			$data[$x] = $day;
			$x++;

		}

	}

	/*
	echo "<pre>";
	print_r($data);
	echo "</pre>";
	exit();
	*/

	$data_num = count($data);

	$html .= '<select name="day" id="sale_driver_day_select">';
	$html .= '<option value="-1">日選択</option>';

	for($i=0;$i<$data_num;$i++){

		$day_tmp = $data[$i];

		if( $day_hiki == $day_tmp ){

			$html .= '<option value="'.$day_tmp.'" selected>'.$day_tmp.'日</option>';

		}else{

			$html .= '<option value="'.$day_tmp.'">'.$day_tmp.'日</option>';

		}

	}

	$html .= '</select>';



	return $html;
	exit();

}

function get_sale_therapist_day_select_frm($area,$year,$month,$day_hiki){

	$most_small_day = get_most_small_day_therapist($area,$year,$month);

	$data = array();
	$x=0;

	for( $i=$most_small_day; $i<32; $i++ ){

		$day = $i;

		//データがあるかどうかチェック(ある：true,ない：false)
		$result = check_attendance_new_exist_plus_day($area,$year,$month,$day);

		if( $result == true ){

			$data[$x] = $day;
			$x++;

		}

	}

	/*
	 echo "<pre>";
	print_r($data);
	echo "</pre>";
	exit();
	*/

	$data_num = count($data);

	$html .= '<select name="day" id="sale_driver_day_select">';
	$html .= '<option value="-1">日選択</option>';

	for($i=0;$i<$data_num;$i++){

		$day_tmp = $data[$i];

		if( $day_hiki == $day_tmp ){

			$html .= '<option value="'.$day_tmp.'" selected>'.$day_tmp.'日</option>';

		}else{

			$html .= '<option value="'.$day_tmp.'">'.$day_tmp.'日</option>';

		}

	}

	$html .= '</select>';



	return $html;
	exit();

}

function get_most_small_day($area,$year,$month){

	$type = "driver";

	$sql = sprintf("select day from attendance_staff_new where type='%s' and area='%s' and year='%s' and month='%s' order by day asc",$type,$area,$year,$month);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(get_most_small_day)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row["day"];
	exit();
}

function get_most_small_day_honbu($area,$year,$month){

	$type = "honbu";

	$sql = sprintf("select day from attendance_staff_new where type='%s' and area='%s' and year='%s' and month='%s' order by day asc",$type,$area,$year,$month);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(get_most_small_day_honbu)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row["day"];
	exit();
}

function get_most_small_day_therapist($area,$year,$month){

	$sql = sprintf("
select day from attendance_new
where
area='%s' and
year='%s' and
month='%s' and
today_absence='0' and
kekkin_flg='0' and
syounin_state='1'
order by day asc",
$area,$year,$month);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリー実行で失敗しました(get_most_small_day)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	return $row["day"];
	exit();

}

//データがあるかどうかチェック(ある：true,ない：false)
function check_attendance_staff_new_exist_plus_day($area,$year,$month,$day){

	$type = "driver";

	$sql = sprintf("select id from attendance_staff_new where type='%s' and area='%s' and year='%s' and month='%s' and day='%s'",$type,$area,$year,$month,$day);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(check_attendance_staff_new_exist_plus_day)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	if( $row["id"] == "" ){

		return false;
		exit();

	}else{

		return true;
		exit();

	}
}

//データがあるかどうかチェック(ある：true,ない：false)
function check_attendance_staff_new_exist_plus_day_honbu($area,$year,$month,$day){

	$type = "honbu";

	$sql = sprintf("select id from attendance_staff_new where type='%s' and area='%s' and year='%s' and month='%s' and day='%s'",$type,$area,$year,$month,$day);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(check_attendance_staff_new_exist_plus_day_honbu)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	if( $row["id"] == "" ){

		return false;
		exit();

	}else{

		return true;
		exit();

	}
}

//データがあるかどうかチェック(ある：true,ない：false)
function check_attendance_new_exist_plus_day($area,$year,$month,$day){

	$sql = sprintf("select id from attendance_new where area='%s' and year='%s' and month='%s' and day='%s'",$area,$year,$month,$day);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(check_attendance_new_exist_plus_day)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	if( $row["id"] == "" ){

		return false;
		exit();

	}else{

		return true;
		exit();

	}
}

//出勤データIDからスタッフIDを取得
function get_staff_id_by_attendance_id_man($attendance_id){

	$sql = sprintf("select staff_id from attendance_staff_new where id='%s'",$attendance_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_staff_id_by_attendance_id_man)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row["staff_id"];
	exit();

}

function get_payment_change_history_driver($area,$type){

	if( $area == "all" ){

$sql = sprintf("
select * from payment_change_history where
delete_flg=0 and
type='%s'
order by created desc limit 0,1000",
$type);

	}else{

$sql = sprintf("
select * from payment_change_history where
delete_flg=0 and
area='%s' and
type='%s'
order by created desc limit 0,1000",
$area,$type);

	}

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(get_payment_change_history_driver)";
		exit();

	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$created = $row["created"];
		$staff_id = $row["staff_id"];
		$name = $row["name"];
		$attendance_id = $row["attendance_id"];

		$action_name = get_change_action_name($name);

		$staff_name = get_staff_name_by_id_man($staff_id);

		$attendance_data = get_attendance_staff_new_by_id($attendance_id);
		$attendance_month = add_zero_when_under_ten_common(intval($attendance_data["month"]));
		$attendance_day = add_zero_when_under_ten_common(intval($attendance_data["day"]));

		$action_month = add_zero_when_under_ten_common(intval(date('m', $created)));
		$action_day = add_zero_when_under_ten_common(intval(date('d', $created)));

		$disp = sprintf("
%s/%s　%sの「%s/%s%s」を修正",
$action_month,$action_day,$staff_name,$attendance_month,$attendance_day,$action_name);

		$list_data[$i] = $row;
		$list_data[$i]["disp"] = $disp;

		$i++;

	}

	/*
	echo "<pre>";
	print_r($list_data);
	echo "</pre>";
	exit();
	*/

	return $list_data;
	exit();
}

//スタッフ名取得
function get_staff_name_by_id_man($id){

	$sql = sprintf("select name from staff_new_new where id='%s'",$id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_staff_name_by_id_man)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	$name = $row["name"];

	return $name;
	exit();
}

function get_change_action_name($name){

	$action_name = "不明";

	if( $name == "allowance" ){

		$action_name = "手当";

	}else if( $name == "car_distance" ){

		$action_name = "走行距離";

	}else if( $name == "highway" ){

		$action_name = "高速代";

	}else if( $name == "parking" ){

		$action_name = "駐車場代";

	}else if( $name == "pay_finish" ){

		$action_name = "清算済み";

	}else if( $name == "start_time" ){

		$action_name = "出勤時間";

	}else if( $name == "end_time" ){

		$action_name = "退勤時間";

	}else if( $name == "gasoline" ){

		$action_name = "ガソリン代";

	}else if( $name == "repair" ){

		$action_name = "修理代";

	}else if( $name == "insurance" ){

		$action_name = "保険料";

	}else if( $name == "sonota" ){

		$action_name = "その他";

	}else if( $name == "pay_day" ){

		$action_name = "日払い";

	}

	return $action_name;
	exit();

}

function get_change_action_name_therapist($name){

	$action_name = "不明";

	if( $name == "pay_another" ){

		$action_name = "立替金";

	}else if( $name == "pay_finish" ){

		$action_name = "清算済み";

	}else if( $name == "pay_day" ){

		$action_name = "日払い";

	}else if( $name == "pt_repeat" ){

		$action_name = "リピートpt";

	}else if( $name == "total_point" ){

		$action_name = "累計pt";

	}else if( $name == "repeater" ){

		$action_name = "リピーター";

	}else if( $name == "lowest_guarantee" ){

		$action_name = "最低保証金額";

	}else if( $name == "allowance" ){

		$action_name = "手当";

	}

	return $action_name;
	exit();

}

function get_sale_price_shijutsu($year,$month,$day,$area,$attendance_id,$sale_price){

	//$sql = sprintf("select shimei_flg,transportation from reservation_for_board where delete_flg=0 and year='%s' and month='%s' and day='%s' and shop_area='%s' and attendance_id='%s'",$year,$month,$day,$area,$attendance_id);
	$sql = sprintf("select shimei_flg,transportation from reservation_for_board where delete_flg=0 and year='%s' and month='%s' and day='%s' and attendance_id='%s'",$year,$month,$day,$attendance_id);	//update by aida at 20180404
	$res = mysql_query($sql, DbCon);
	//echo $res . "/" . $sql . "<br />";
	if( $res == false ){

		echo "error!(get_sale_price_shijutsu)";
		exit();

	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$list_data[$i++] = $row;

	}

	$list_data_num = count($list_data);

	$sale_price_shijutsu = $sale_price;

	for($i=0;$i<$list_data_num;$i++){

		$shimei_flg = $list_data[$i]["shimei_flg"];
		$transportation = $list_data[$i]["transportation"];

		if( $shimei_flg == "1" ){
			$shimei_value = 1000;
		}else{
			$shimei_value = 0;
		}

		//echo $sale_price_shijutsu . " = " . $sale_price_shijutsu . " - " . $shimei_value . " - " . $transportation . "<br />";
		$sale_price_shijutsu = $sale_price_shijutsu - $shimei_value - $transportation;

	}

	return $sale_price_shijutsu;
	exit();

}

function get_sale_point_at_sale_therapist($year,$month,$day,$area,$attendance_id){

	$sql = sprintf("
select shimei_flg from reservation_for_board
where
delete_flg=0 and
year='%s' and
month='%s' and
day='%s' and
shop_area='%s' and
attendance_id='%s'",
$year,$month,$day,$area,$attendance_id);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_sale_point_at_sale_therapist)";
		exit();

	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$list_data[$i++] = $row;

	}

	$list_data_num = count($list_data);

	$shijutsu_point = 0;
	$shimei_point = 0;

	for($i=0;$i<$list_data_num;$i++){

		$shimei_flg = $list_data[$i]["shimei_flg"];

		if( $shimei_flg == "1" ){
			$shimei_point = $shimei_point + 3;
		}

		$shijutsu_point++;

	}

	$data["shimei_point"] = $shimei_point;
	$data["shijutsu_point"] = $shijutsu_point;

	return $data;
	exit();

}

function get_allowance_therapist($year,$month,$day,$area,$attendance_id){

	$sql = sprintf("
select transportation from reservation_for_board
where
delete_flg=0 and
year='%s' and
month='%s' and
day='%s' and
shop_area='%s' and
attendance_id='%s'",
$year,$month,$day,$area,$attendance_id);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_allowance_therapist)";
		exit();

	}

	$allowance = 0;

	while($row = mysql_fetch_assoc($res)){

		$transportation = $row["transportation"];

		if( $transportation == "0" ){

			$allowance = $allowance + 500;

		}else{

			$allowance = $allowance + $transportation;

		}

	}

	return $allowance;
	exit();

}

function get_repeater_num($year,$month,$day,$area){

	$sql = sprintf("
select id from reservation_for_board where
delete_flg=0 and
year='%s' and
month='%s' and
day='%s' and
shop_area='%s' and
repeat_flg='1'",
$year,$month,$day,$area);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res === false){

		echo "error!(get_repeater_num)";
		exit();

	}

	$num = mysql_num_rows($res);

	return $num;
	exit();

}

function get_repeater_num_all($year,$month,$day){

	$sql = sprintf("
select id from reservation_for_board where
delete_flg=0 and
year='%s' and
month='%s' and
day='%s' and
repeat_flg='1'",
$year,$month,$day);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res === false){

		echo "error!(get_repeater_num_all)";
		exit();

	}

	$num = mysql_num_rows($res);

	return $num;
	exit();

}

function get_repeater_num_mishori($year,$month,$day){

	$sql = sprintf("
select id from reservation_for_board where
delete_flg=0 and
year='%s' and
month='%s' and
day='%s' and
repeater_delete_flg='0' and
repeater_regist_flg='0' and
repeat_flg='1'",
	$year,$month,$day);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res === false){

		echo "error!(get_repeater_num_mishori)";
		exit();

	}

	$num = mysql_num_rows($res);

	return $num;
	exit();

}

function get_repeater_num_by_time_and_therapist_id($year,$month,$day,$therapist_id){

	$sql = sprintf("
select id from repeater where
delete_flg=0 and
first_time_year='%s' and
first_time_month='%s' and
first_time_day='%s' and
therapist_id='%s'",
$year,$month,$day,$therapist_id);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res === false){

		echo "error!(get_repeater_num_by_time_and_therapist_id)";
		exit();

	}

	$num = mysql_num_rows($res);

	return $num;
	exit();

}

function get_repeater_list($year,$month,$day,$area){

	$sql = sprintf("
select * from reservation_for_board
where
delete_flg=0 and
year='%s' and
month='%s' and
day='%s' and
shop_area='%s' and
repeat_flg='1'",
$year,$month,$day,$area);

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_repeater_list)";
		exit();

	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$list_data[$i++] = $row;

	}

	return $list_data;
	exit();

}

function get_repeater_list_all($year,$month,$day){

	$sql = sprintf("
select * from reservation_for_board
where
delete_flg=0 and
year='%s' and
month='%s' and
day='%s' and
repeat_flg='1'",
$year,$month,$day);

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_repeater_list_all)";
		exit();

	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$list_data[$i++] = $row;

	}

	return $list_data;
	exit();

}

function get_area_by_shop_name($shop_name){

	$sql = sprintf("select area from shop where name='%s'",$shop_name);
	$res = mysql_query($sql, DbCon);
	if( $res == false ){
		echo "error!(get_area_by_shop_name)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row["area"];
	exit();
}

function get_shop_id_by_shop_name($shop_name){

	$sql = sprintf("select id from shop where name='%s'",$shop_name);
	$res = mysql_query($sql, DbCon);
	if( $res == false ){
		echo "error!(get_shop_id_by_shop_name)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row["id"];
	exit();
}

function get_therapist_select_form($therapist_data,$therapist_id){

	$therapist_data_num = count($therapist_data);

	$html = '<select name="therapist_id" id="therapist_select_frm">';

	$html .= '<option value="-1">セラピスト選択</option>';

	for( $i=0; $i<$therapist_data_num; $i++ ){

		$id = $therapist_data[$i]["id"];
		$name = $therapist_data[$i]["name"];

		if( $therapist_id == $id ){

$html .= '<option value="'.$id.'" selected>'.$name.'</option>';

		}else{

$html .= '<option value="'.$id.'">'.$name.'</option>';

		}


	}

	$html .= '</select>';

	return $html;
	exit();

}

function get_year_select_form_for_sale_repeater_regist($year){

	$year_now = intval(date("Y"));

	$year_old = $year_now - 2;

	$html = '<select name="year">';

	$html .= '<option value="-1">年選択</option>';

	for( $i=$year_now; $i>=$year_old; $i-- ){

		if( $i == $year ){

			$html .= '<option value="'.$i.'" selected>'.$i.'年</option>';

		}else{

			$html .= '<option value="'.$i.'">'.$i.'年</option>';

		}


	}

	$html .= '</select>';

	return $html;
	exit();

}

function get_month_select_form($month){

	$html = '<select name="month">';

	$html .= '<option value="-1">月選択</option>';

	for( $i=1; $i<=12; $i++ ){

		if( $i == $month ){

			$html .= '<option value="'.$i.'" selected>'.$i.'月</option>';

		}else{

			$html .= '<option value="'.$i.'">'.$i.'月</option>';

		}


	}

	$html .= '</select>';

	return $html;
	exit();

}

function get_day_select_form($day){

	$html = '<select name="day">';

	$html .= '<option value="-1">日選択</option>';

	for( $i=1; $i<=31; $i++ ){

		if( $i == $day ){

			$html .= '<option value="'.$i.'" selected>'.$i.'日</option>';

		}else{

			$html .= '<option value="'.$i.'">'.$i.'日</option>';

		}


	}

	$html .= '</select>';

	return $html;
	exit();

}

function get_shop_select_form_for_sale_repeater_regist($shop_id,$area){

	if(($area == 'yokohama')||($area == 'yokohama2')){
		$sql = sprintf("select * from shop where area like '%s'",'%yokohama%');
	}else{
		$sql = sprintf("select * from shop where area='%s'",$area);
	}
	$res = mysql_query($sql, DbCon);
	if( $res == false ){
		echo "error!(get_shop_select_form_for_sale_repeater_regist)";
		exit();
	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$list_data[$i++] = $row;

	}

	$list_data_num = count($list_data);

	$html = '<select name="shop_id" id="shop_select_frm">';

	$html .= '<option value="-1">店舗選択</option>';

	for( $i=0; $i<$list_data_num; $i++ ){

		$id = $list_data[$i]["id"];
		$name = $list_data[$i]["name"];

		if( ( $id != "3" ) && ( $id != "5" ) ){

			if( $id == $shop_id ){

				$html .= '<option value="'.$id.'">'.$name.'</option>';

			}else{

				$html .= '<option value="'.$id.'">'.$name.'</option>';

			}

		}

	}

	$html .= '</select>';

	return $html;
	exit();

}

function insert_repeater($area,$year,$month,$day,$customer_name,$area_name,$shop_id,$therapist_id,$customer_tel,$attendance_id,$reservation_for_board_id){

	$attendance_id = get_pre_day_attendance_id_by_therapist_id_common($therapist_id);

	$first_time_ts = get_timestamp_by_year_month_day($year,$month,$day);
	$first_time_year = $year;
	$first_time_month = $month;
	$first_time_day = $day;
	$shop_area = $area;

	$now = time();

	//トランザクションをはじめる準備
	$sql = "set autocommit = 0";
	mysql_query( $sql, DbCon );

	//トランザクション開始
	$sql = "begin";
	mysql_query( $sql, DbCon );

	if( $attendance_id == "-1" ){

$sql = sprintf("
insert into repeater_tmp(
created,therapist_id,first_time_ts,first_time_year,first_time_month,first_time_day,customer_name,area_name,shop_area,shop_id,customer_tel)
values('%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s')",
$now,$therapist_id,$first_time_ts,$first_time_year,$first_time_month,$first_time_day,$customer_name,$area_name,$shop_area,$shop_id,$customer_tel);

	}else{

$sql = sprintf("
insert into repeater(
created,updated,therapist_id,first_time_ts,first_time_year,first_time_month,first_time_day,customer_name,area_name,shop_area,shop_id,customer_tel,attendance_id)
values('%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s')",
$now,$now,$therapist_id,$first_time_ts,$first_time_year,$first_time_month,$first_time_day,$customer_name,$area_name,$shop_area,$shop_id,$customer_tel,$attendance_id);

	}

	$res = mysql_query($sql, DbCon);

	if($res == false){

		//ロールバック
		$sql = "rollback";
		mysql_query( $sql, DbCon );

		echo "error!(insert_repeater)";
		exit();

	}

	$repeater_id = mysql_insert_id();

	//payment_change_historyに記録
	$now = time();

	$type = "therapist";
	$action_type = "repeater";

	$sql = sprintf("
insert into payment_change_history(created,name,area,type,attendance_id,repeater_id,therapist_id)
values('%s','%s','%s','%s','%s','%s','%s')",
$now,$action_type,$shop_area,$type,$attendance_id,$repeater_id,$therapist_id);

	$res = mysql_query($sql, DbCon);

	if($res === false){

		//ロールバック
		$sql = "rollback";
		mysql_query( $sql, DbCon );

		echo "error!(insert_repeater)";
		exit();

	}

	$sql = sprintf("
update reservation_for_board set repeater_regist_flg='1'
where
id='%s'",
$reservation_for_board_id);

	$res = mysql_query($sql, DbCon);

	if($res === false){

		//ロールバック
		$sql = "rollback";
		mysql_query( $sql, DbCon );

		echo "error!(insert_repeater)";
		exit();

	}

	//コミット
	$sql = "commit";
	mysql_query( $sql, DbCon );

	return true;
	exit();
}

function update_repeater($area,$year,$month,$day,$customer_name,$area_name,$shop_id,$therapist_id,$customer_tel,$id,$attendance_id){

	$first_time_ts = get_timestamp_by_year_month_day($year,$month,$day);
	$first_time_year = $year;
	$first_time_month = $month;
	$first_time_day = $day;
	$shop_area = $area;

	$now = time();

	$sql = sprintf("
update repeater set
updated='%s',
therapist_id='%s',
first_time_ts='%s',
first_time_year='%s',
first_time_month='%s',
first_time_day='%s',
customer_name='%s',
area_name='%s',
shop_area='%s',
shop_id='%s',
customer_tel='%s',
attendance_id='%s'
where id='%s'",
$now,$therapist_id,$first_time_ts,$year,$month,$day,$customer_name,$area_name,$shop_area,$shop_id,$customer_tel,$attendance_id,$id);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(update_repeater)";
		exit();

	}

	return true;
	exit();

}

function get_timestamp_by_year_month_day($year,$month,$day){

	$hour = 12;
	$minute = 0;
	$second = 0;
	$timestamp = mktime($hour, $minute, $second, $month, $day, $year);

	return $timestamp;
	exit();

}

//重複チェック(顧客名、顧客電話番号、セラピストID)
function check_repeater_regist_exist($customer_name,$customer_tel,$therapist_id){

	$sql = sprintf("
select id from repeater where
delete_flg=0 and
customer_name='%s' and
customer_tel='%s' and
therapist_id='%s'",
$customer_name,$customer_tel,$therapist_id);

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(check_repeater_regist_exist)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	if( $row["id"] == "" ){

		return false;
		exit();

	}else{

		return true;
		exit();

	}

}

function get_repeater(){

	$sql = "select * from repeater where delete_flg=0 order by created desc";
	$res = mysql_query($sql, DbCon);
	if( $res == false ){
		echo "error!(get_repeater)";
		exit();
	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$list_data[$i++] = $row;

	}

	return $list_data;
	exit();
}

function get_repeater_by_id($id){

	$sql = sprintf("select * from repeater where delete_flg=0 and id='%s'",$id);
	$res = mysql_query($sql, DbCon);
	if( $res == false ){
		echo "error!(get_repeater_by_id)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();
}

function get_shop_name_by_shop_id($shop_id){

	$sql = sprintf("select name from shop where id='%s'",$shop_id);
	$res = mysql_query($sql, DbCon);
	if( $res == false ){
		echo "error!(get_shop_name_by_shop_id)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row["name"];
	exit();
}

function get_payment_change_history_therapist($area,$type){

	$sql = sprintf("
select * from payment_change_history where
delete_flg=0 and
area='%s' and
type='%s'
order by created desc limit 0,1000",
$area,$type);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(get_payment_change_history_therapist)";
		exit();

	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$created = $row["created"];
		$therapist_id = $row["therapist_id"];
		$name = $row["name"];
		$attendance_id = $row["attendance_id"];

		$action_name = get_change_action_name_therapist($name);

		$therapist_name = get_therapist_name_by_therapist_id_honmyou_common($therapist_id);

		$attendance_data = get_attendance_data_one_by_attendance_id_common($attendance_id);
		$attendance_month = add_zero_when_under_ten_common(intval($attendance_data["month"]));
		$attendance_day = add_zero_when_under_ten_common(intval($attendance_data["day"]));

		$action_month = add_zero_when_under_ten_common(intval(date('m', $created)));
		$action_day = add_zero_when_under_ten_common(intval(date('d', $created)));

		$matsubi = "";

		if( $name == "repeater" ){

			$matsubi = "追加";

		}else{

			$matsubi = "修正";

		}

		$disp = sprintf("
%s/%s　%sの「%s/%s%s」を%s",
$action_month,$action_day,$therapist_name,$attendance_month,$attendance_day,$action_name,$matsubi);

		$list_data[$i] = $row;
		$list_data[$i]["disp"] = $disp;

		$i++;

	}

	/*
	 echo "<pre>";
	print_r($list_data);
	echo "</pre>";
	exit();
	*/

	return $list_data;
	exit();

}

function get_shop_data($area){

	if( $area == "all" ){
		$sql = "select * from shop where delete_flg=0";
	}else{
		$sql = sprintf("select * from shop where delete_flg=0 and area='%s'",$area);
	}

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_shop_data)";
		exit();

	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$list_data[$i++] = $row;

	}

	return $list_data;
	exit();
}

function get_last_day($year,$month){
	return get_month_last_day_common($year,$month);		//指定年月の末日取得
}

function get_sale_price_by_shop_name($year,$month,$day,$shop_name,$card_flg){

	$sql = sprintf("
select sale_history.price from reservation_for_board
left join sale_history on sale_history.reservation_no=reservation_for_board.reservation_no
where
reservation_for_board.shop_name='%s' and
reservation_for_board.card_flg='%s' and
reservation_for_board.year='%s' and
reservation_for_board.month='%s' and
reservation_for_board.day='%s' and
reservation_for_board.delete_flg=0 and
sale_history.delete_flg=0 and
sale_history.eigyou_year='%s' and
sale_history.eigyou_month='%s' and
sale_history.eigyou_day='%s'",
$shop_name,$card_flg,$year,$month,$day,$year,$month,$day);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_sale_price_by_shop_name)";
		exit();

	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$list_data[$i++] = $row;

	}

	/*
	echo "<pre>";
	print_r($list_data);
	echo "</pre>";
	exit();
	*/

	$list_data_num = count($list_data);

	$total = 0;

	for($i=0;$i<$list_data_num;$i++){

		$price = $list_data[$i]["price"];

		$total = $total + $price;

	}

	return $total;
	exit();

}

function get_most_small_day_shop($area,$year,$month){

	if( $area == "all" ){

$sql = sprintf("
select day from reservation_for_board
where
year='%s' and
month='%s' and
delete_flg='0'
order by day asc",
$year,$month);

	}else{

$sql = sprintf("
select day from reservation_for_board
where
shop_area='%s' and
year='%s' and
month='%s' and
delete_flg='0'
order by day asc",
$area,$year,$month);

	}

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリー実行で失敗しました(get_most_small_day_shop)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	return $row["day"];
	exit();

}

//データがあるかどうかチェック(ある：true,ない：false)
function check_reservation_for_board_exist_plus_day($area,$year,$month,$day){

	if( $area == "all" ){
		$sql = sprintf("select id from reservation_for_board where delete_flg='0' and year='%s' and month='%s' and day='%s'",$year,$month,$day);
	}else{
		$sql = sprintf("select id from reservation_for_board where delete_flg='0' and shop_area='%s' and year='%s' and month='%s' and day='%s'",$area,$year,$month,$day);
	}

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリー実行で失敗しました(check_reservation_for_board_exist_plus_day)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	if( $row["id"] == "" ){

		return false;
		exit();

	}else{

		return true;
		exit();

	}

}

function get_sale_shop_day_select_frm($area,$year,$month,$day_hiki){

	$most_small_day = get_most_small_day_shop($area,$year,$month);

	$data = array();
	$x=0;

	for( $i=$most_small_day; $i<32; $i++ ){

		$day = $i;

		//データがあるかどうかチェック(ある：true,ない：false)
		$result = check_reservation_for_board_exist_plus_day($area,$year,$month,$day);

		if( $result == true ){

			$data[$x] = $day;
			$x++;

		}

	}

	$data_num = count($data);

	$html .= '<select name="day" id="sale_driver_day_select">';
	$html .= '<option value="-1">日選択</option>';

	for($i=0;$i<$data_num;$i++){

		$day_tmp = $data[$i];

		if( $day_hiki == $day_tmp ){

			$html .= '<option value="'.$day_tmp.'" selected>'.$day_tmp.'日</option>';

		}else{

			$html .= '<option value="'.$day_tmp.'">'.$day_tmp.'日</option>';

		}

	}

	$html .= '</select>';

	return $html;
	exit();

}

function get_most_small_year_and_month_shop($area){

	$min_year = "2014";

	if( $area == "all" ){

$sql = sprintf("
select year from reservation_for_board
where
year>%s and
delete_flg='0'
order by year asc",
$min_year);

	}else{

$sql = sprintf("
select year from reservation_for_board
where
year>%s and
shop_area='%s' and
delete_flg='0'
order by year asc",
$min_year,$area);

	}

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリー実行で失敗しました(get_most_small_year_and_month_shop)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	$year = $row["year"];

	if( $area == "all" ){

$sql = sprintf("
select month from reservation_for_board
where
year='%s' and
delete_flg='0'
order by month asc",
$year);

	}else{

$sql = sprintf("
select month from reservation_for_board
where
shop_area='%s' and
year='%s' and
delete_flg='0'
order by month asc",
$area,$year);

	}

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリー実行で失敗しました(get_most_small_year_and_month_shop)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	$month = $row["month"];

	$data["year"] = $year;
	$data["month"] = $month;

	return $data;
	exit();

}

//データがあるかどうかチェック(ある：true,ない：false)
function check_reservation_for_board_exist($area,$year,$month){

	if( $area == "all" ){

$sql = sprintf("
select id from reservation_for_board
where
year='%s' and
month='%s' and
delete_flg='0'",
$year,$month);

	}else{

$sql = sprintf("
select id from reservation_for_board
where
shop_area='%s' and
year='%s' and
month='%s' and
delete_flg='0'",
$area,$year,$month);

	}

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリー実行で失敗しました(check_reservation_for_board_exist)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	if( $row["id"] == "" ){

		return false;
		exit();

	}else{

		return true;
		exit();

	}

}

function get_sale_shop_month_select_frm($area,$year_hiki,$month_hiki){

	$data = get_most_small_year_and_month_shop($area);

	$most_small_year = $data["year"];
	$most_small_month = $data["month"];

	if( $most_small_year == "" ){

		$most_small_year = 9999;

	}

	//今日の年と月
	$year_today = intval(date("Y"));
	$month_today = intval(date("m"));

	$first_flg = true;

	$data = array();
	$z = 0;

	$now_month_flg = false;

	for($i=$most_small_year;$i<=$year_today;$i++){

		if( $first_flg == true ){

			$start_month = $most_small_month;

			$first_flg = false;

		}else{

			$start_month = 1;

		}

		for($x=$start_month;$x<=12;$x++){

			$year = $i;
			$month = $x;

			//データがあるかどうかチェック(ある：true,ない：false)
			$result = check_reservation_for_board_exist($area,$year,$month);

			if( $result == true ){

				$data[$z]["year"] = $year;
				$data[$z]["month"] = $month;

				$z++;

			}

		}

	}

	/*
	 echo "<pre>";
	print_r($data);
	echo "</pre>";
	exit();
	*/

	$data_num = count($data);

	$html = '<select name="month" id="sale_driver_month_select">';
	$html .= '<option value="-1" selected>月選択</option>';

	for($i=($data_num-1);$i>=0;$i--){

		$year = $data[$i]["year"];
		$month = $data[$i]["month"];

		$value_disp = $year."_".$month;
		$word_disp = $year."年".$month."月";

		if( ($year==$year_hiki) && ($month==$month_hiki) ){

			$html .= sprintf('<option value="%s" selected>%s</option>',$value_disp,$word_disp);

		}else{

			$html .= sprintf('<option value="%s">%s</option>',$value_disp,$word_disp);

		}

	}

	$html .= '</select>';

	return $html;
	exit();

}

function get_remuneration_at_sale_shop($year,$month,$day,$shop_name){

$sql = sprintf("
select
sale_history.price,
sale_history.therapist_id,
reservation_for_board.shimei_flg,
reservation_for_board.transportation
from reservation_for_board
left join sale_history on sale_history.reservation_no=reservation_for_board.reservation_no
where
reservation_for_board.shop_name='%s' and
reservation_for_board.year='%s' and
reservation_for_board.month='%s' and
reservation_for_board.day='%s' and
reservation_for_board.delete_flg=0 and
sale_history.delete_flg=0 and
sale_history.eigyou_year='%s' and
sale_history.eigyou_month='%s' and
sale_history.eigyou_day='%s'",
$shop_name,$year,$month,$day,$year,$month,$day);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_remuneration_at_sale_shop)";
		exit();

	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$list_data[$i++] = $row;

	}

	/*
	echo "<pre>";
	print_r($list_data);
	echo "</pre>";
	exit();
	*/

	$list_data_num = count($list_data);

	$remuneration = 0;

	$share_rate_null_flg = false;

	for($i=0;$i<$list_data_num;$i++){

		$price = $list_data[$i]["price"];
		$therapist_id = $list_data[$i]["therapist_id"];
		$shimei_flg = $list_data[$i]["shimei_flg"];
		$transportation = $list_data[$i]["transportation"];

		if( $shimei_flg == "1" ){
			$shimei_value = 1000;
		}else{
			$shimei_value = 0;
		}

		$price_shijutsu = $price;

		$price_shijutsu = $price_shijutsu - $shimei_value - $transportation;

		$therapist_data = get_therapist_data_by_id($therapist_id);

		$point_ref = $therapist_data["point_ref"];
		$point_fix = $therapist_data["point_fix"];
		$total_point = $therapist_data["total_point"];
		$area = $therapist_data["area"];

		$share_rate = get_share_rate($point_ref,$point_fix,$total_point,$area);

		if( $share_rate == "-1" ){

			$share_rate_null_flg = true;

		}else{

			$remuneration = $remuneration + ($price_shijutsu * ($share_rate / 100));

		}


	}

	if( $share_rate_null_flg == true ){

		$remuneration = "---";

	}

	return $remuneration;
	exit();

}

function get_driver_payment_for_sale_shop($year,$month,$day,$area){

	$gasoline_value = get_gasoline_value_from_settings($area);

	$driver_data = get_driver_data_for_board($year,$month,$day,$area);

	$driver_data_num = count($driver_data);

	$remuneration_all = 0;
	$gasoline_value_disp_all = 0;
	$parking_all = 0;

	$allowance_all = 0;
	$highway_all = 0;
	$pay_finish_all = 0;

	for($i=0;$i<$driver_data_num;$i++){

		$driver_id = $driver_data[$i]["id"];
		$pay_hour = $driver_data[$i]["pay_hour"];
		$pay_fix = $driver_data[$i]["pay_fix"];
		$fuel = $driver_data[$i]["fuel"];

		if( $pay_hour == "-1" ){

			$pay_hour = 0;

		}

		$data = get_staff_attendance_data_by_time($driver_id,$year,$month,$day);
		$start_time = $data["start_time"];
		$end_time = $data["end_time"];
		$parking = $data["parking"];
		$car_distance = $data["car_distance"];

		$allowance = $data["allowance"];
		$highway = $data["highway"];
		$pay_finish = $data["pay_finish"];

		$start_hour = $data["start_hour"];
		$start_minute = $data["start_minute"];
		$end_hour = $data["end_hour"];
		$end_minute = $data["end_minute"];

		if( ($fuel != "0") && ($fuel != "-1") ){

			$gasoline_value_disp = intval(($car_distance*$gasoline_value)/$fuel);

		}else{

			$gasoline_value_disp = 0;

		}

		if( ( $start_hour == "-1" ) || ( $start_minute == "-1" ) || ( $end_hour == "-1" ) || ( $end_minute == "-1" ) ){

			$work_time = get_work_time($start_time,$end_time);

		}else{

			$work_time = get_work_time_driver_common($start_hour,$start_minute,$end_hour,$end_minute);

		}

		$remuneration = get_remuneration_driver_common($pay_hour,$pay_fix,$work_time);

		$remuneration_all = $remuneration_all + $remuneration;
		$gasoline_value_disp_all = $gasoline_value_disp_all + $gasoline_value_disp;
		$parking_all = $parking_all + $parking;

		$allowance_all = $allowance_all + $allowance;
		$highway_all = $highway_all + $highway;
		$pay_finish_all = $pay_finish_all + $pay_finish;

	}

	$result = check_last_day_for_remuneration_common($year,$month,$day);

	if( $result == false ){

		$remuneration_all = 0;

	}

	$data["remuneration"] = $remuneration_all;
	$data["gasoline"] = $gasoline_value_disp_all;
	$data["parking"] = $parking_all;

	$data["allowance"] = $allowance_all;
	$data["highway"] = $highway_all;
	$data["pay_finish"] = $pay_finish_all;

	return $data;
	exit();

}

function get_reservation_for_board_for_sale_operation($year,$month,$day,$area){

	if( $area == "all" ){

$sql = sprintf("
select * from reservation_for_board where
delete_flg=0 and
year='%s' and
month='%s' and
day='%s' order by start_hour asc,start_minute asc",
$year,$month,$day);

	}else{

$sql = sprintf("
select * from reservation_for_board where
delete_flg=0 and
shop_area='%s' and
year='%s' and
month='%s' and
day='%s' order by start_hour asc,start_minute asc",
$area,$year,$month,$day);

	}

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_reservation_for_board_for_sale_operation)";
		exit();

	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$list_data[$i++] = $row;

	}

	return $list_data;
	exit();

}

function get_sale_history_by_reservation_no($reservation_no){

$sql = sprintf("
select * from sale_history where
reservation_no='%s' and
delete_flg='0'",
$reservation_no);

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "クエリー実行で失敗しました(get_sale_history_by_reservation_no)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();

}

function get_price_shijutsu($shimei_flg,$transportation,$price){

	if( $shimei_flg == "1" ){
		$shimei_value = 1000;
	}else{
		$shimei_value = 0;
	}

	$price_shijutsu = $price - $shimei_value - $transportation;

	return $price_shijutsu;
	exit();

}

function get_reservation_for_board_for_sale_operation_one($attendance_id){

$sql = sprintf("
select * from reservation_for_board where
delete_flg=0 and
attendance_id='%s' order by start_hour asc,start_minute asc",
$attendance_id);

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_reservation_for_board_for_sale_operation_one)";
		exit();

	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$list_data[$i++] = $row;

	}

	return $list_data;
	exit();

}

function get_transportation_select_frm_for_sale_operation_edit($transportation){

	$html = '<select name="transportation" id="transportation">';

	if( $transportation == "0" ){

$html .=<<<EOT
<option value="0" selected>0円</option>
<option value="1000">1000円</option>
<option value="2000">2000円</option>
<option value="3000">3000円</option>
<option value="4000">4000円</option>
<option value="5000">5000円</option>
EOT;

	}else if( $transportation == "1000" ){

$html .=<<<EOT
<option value="0">0円</option>
<option value="1000" selected>1000円</option>
<option value="2000">2000円</option>
<option value="3000">3000円</option>
<option value="4000">4000円</option>
<option value="5000">5000円</option>
EOT;

	}else if( $transportation == "2000" ){

$html .=<<<EOT
<option value="0">0円</option>
<option value="1000">1000円</option>
<option value="2000" selected>2000円</option>
<option value="3000">3000円</option>
<option value="4000">4000円</option>
<option value="5000">5000円</option>
EOT;

	}else if( $transportation == "3000" ){

$html .=<<<EOT
<option value="0">0円</option>
<option value="1000">1000円</option>
<option value="2000">2000円</option>
<option value="3000" selected>3000円</option>
<option value="4000">4000円</option>
<option value="5000">5000円</option>
EOT;

	}else if( $transportation == "4000" ){

$html .=<<<EOT
<option value="0">0円</option>
<option value="1000">1000円</option>
<option value="2000">2000円</option>
<option value="3000">3000円</option>
<option value="4000" selected>4000円</option>
<option value="5000">5000円</option>
EOT;

	}else if( $transportation == "5000" ){

$html .=<<<EOT
<option value="0">0円</option>
<option value="1000">1000円</option>
<option value="2000">2000円</option>
<option value="3000">3000円</option>
<option value="4000">4000円</option>
<option value="5000" selected>5000円</option>
EOT;

	}else{

$html .=<<<EOT
<option value="0">0円</option>
<option value="1000">1000円</option>
<option value="2000">2000円</option>
<option value="3000">3000円</option>
<option value="4000">4000円</option>
<option value="5000">5000円</option>
EOT;

	}

	$html .= '</select>';

	return $html;
	exit();

}

function update_reservation_for_board_for_sale_operation_edit(
$reservation_for_board_id,$course_int,$course_var,$extension,$shimei_flg,$card_flg,$transportation,
$lost_cost,$shop_name){

	$shop_area = get_area_by_shop_name($shop_name);

	$change_data = get_change_data_for_sale_operation_edit($course_var,$extension,$shimei_flg,$card_flg,$transportation,$lost_cost,$reservation_for_board_id);

	/*
	echo "<pre>";
	print_r($change_data);
	echo "</pre>";
	exit();
	*/

	$price_recalculation = get_price_recalculation_common(
$reservation_for_board_id,$shop_name,$lost_cost,$course_var,$extension,$shimei_flg,$transportation);

	$reservation_no = get_reservation_no_by_reservation_for_board_id_common($reservation_for_board_id);

	//トランザクションをはじめる準備
	$sql = "set autocommit = 0";
	mysql_query( $sql, DbCon );

	//トランザクション開始
	$sql = "begin";
	mysql_query( $sql, DbCon );

$sql = sprintf("
update reservation_for_board set
course='%s',
course_var='%s',
extension='%s',
shimei_flg='%s',
card_flg='%s',
transportation='%s',
lost_cost='%s'
where id='%s'",
$course_int,$course_var,$extension,$shimei_flg,$card_flg,$transportation,$lost_cost,$reservation_for_board_id);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		//ロールバック
		$sql = "rollback";
		mysql_query( $sql, DbCon );

		echo "error!(update_reservation_for_board_for_sale_operation_edit)";
		exit();

	}

	//売上金額の更新
	$sql = sprintf("
update sale_history set price='%s' where reservation_no='%s'",
$price_recalculation,$reservation_no);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		//ロールバック
		$sql = "rollback";
		mysql_query( $sql, DbCon );

		echo "error!(update_reservation_for_board_for_sale_operation_edit)";
		exit();

	}

	//payment_change_historyに記録
	$now = time();

	$type = "operation";

	$change_data_num = count($change_data);

	for($i=0;$i<$change_data_num;$i++){

		$action_type = $change_data[$i]["name"];
		$value_new = $change_data[$i]["new"];
		$value_old = $change_data[$i]["old"];

		$sql = sprintf("
insert into payment_change_history(created,name,value_old,value_new,area,type,reservation_for_board_id)
values('%s','%s','%s','%s','%s','%s','%s')",
$now,$action_type,$value_old,$value_new,$shop_area,$type,$reservation_for_board_id);

		$res = mysql_query($sql, DbCon);

		if($res === false){

			//ロールバック
			$sql = "rollback";
			mysql_query( $sql, DbCon );

			echo "error!(update_reservation_for_board_for_sale_operation_edit)";
			exit();

		}

	}

	//コミット
	$sql = "commit";
	mysql_query( $sql, DbCon );

	return true;
	exit();
}

function get_time_disp_for_sale_driver_one($time_array,$value,$hour_db,$minute_db){

	if( $hour_db == "-1" ){

		$hour = $time_array[$value]["hour"];
		$minute = $time_array[$value]["minute"];

	}else{

		$hour = $hour_db;
		$minute = $minute_db;

	}

	//if( $hour < 12 ){
	if( $hour < CONST_limitTime ){
		$hour = $hour + 24;

	}

	if( $minute == "0" ){

		$minute = "0".$minute;

	}

	$disp_data = $hour.":".$minute;

	return $disp_data;
	exit();

}

function get_time_disp_for_sale_driver_one_ajax($hour,$minute){

	//if( $hour < 12 ){
	if( $hour < CONST_limitTime ){
		$hour = $hour + 24;

	}

	if( $minute == "0" ){

		$minute = "0".$minute;

	}

	$disp_data = $hour.":".$minute;

	return $disp_data;
	exit();

}

function get_time_value_for_sale_driver_one($time_array,$start_time,$end_time){

	$start_hour = hour_plus_24_common($time_array[$start_time]["hour"]);
	$start_minute = $time_array[$start_time]["minute"];

	$end_hour = hour_plus_24_common($time_array[$end_time]["hour"]);
	$end_minute = $time_array[$end_time]["minute"];

	$data["start_hour"] = $start_hour;
	$data["start_minute"] = $start_minute;
	$data["end_hour"] = $end_hour;
	$data["end_minute"] = $end_minute;

	return $data;
	exit();

}

function get_time_select_option_for_sale_driver_one($hour,$minute){

	$time_array = get_time_array_10_common();

	$time_array_num = count($time_array);

	$html = "";

	for($i=1;$i<=$time_array_num;$i++){

		$hour_tmp = $time_array[$i]["hour"];
		$minute_tmp = $time_array[$i]["minute"];

		if( $minute_tmp == "0" ){

			$minute_disp = "00";

		}else{

			$minute_disp = $minute_tmp;

		}

		if( ($hour_tmp==$hour) && ($minute_tmp==$minute) ){

			$html .= sprintf('<option value="%s_%s" selected>%s時%s分</option>',$hour_tmp,$minute_tmp,$hour_tmp,$minute_disp);

		}else{

			$html .= sprintf('<option value="%s_%s">%s時%s分</option>',$hour_tmp,$minute_tmp,$hour_tmp,$minute_disp);

		}

	}

	return $html;
	exit();

}

//一番最初のアクセスで、データのアップデート
function update_time_of_attendance_staff_new($attendance_id,$start_hour,$start_minute,$end_hour,$end_minute){

	//売上金額の更新
	$sql = sprintf("
update attendance_staff_new set start_hour='%s',start_minute='%s',end_hour='%s',end_minute='%s' where id='%s'",
$start_hour,$start_minute,$end_hour,$end_minute,$attendance_id);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(update_time_of_attendance_staff_new)";
		exit();

	}

	return true;
	exit();

}

function get_work_time_driver($start_hour,$start_minute,$end_hour,$end_minute){
	return get_work_time_driver_common($start_hour,$start_minute,$end_hour,$end_minute);	//時間集計
}

function get_attendance_select_frm_for_sale_repeater_regist($therapist_id,$attendance_id){

	$year = intval(date("Y"));
	$month = intval(date("m"));
	$day = intval(date("d"));

	$year_tmp = $year;
	$month_tmp = $month;
	$day_tmp = $day;

	$x = 0;

	$html = "";

	for( $i=0; $i<30; $i++ ){

		if( $x < 10 ){

			$attendance_data = get_attendance_data_work_common($therapist_id,$year_tmp,$month_tmp,$day_tmp);

			if( $attendance_data["id"] != "" ){

				$attendance_id_tmp = $attendance_data["id"];
				$attendance_month = $attendance_data["month"];
				$attendance_day = $attendance_data["day"];

if( $attendance_id_tmp == $attendance_id ){

$html .= sprintf('<option value="%s" selected>%s月%s日</option>',$attendance_id_tmp,$attendance_month,$attendance_day);

}else{

$html .= sprintf('<option value="%s">%s月%s日</option>',$attendance_id_tmp,$attendance_month,$attendance_day);

}

				$x++;

			}

			$data = get_pre_day_common($year_tmp,$month_tmp,$day_tmp);

			$year_tmp = $data["year"];
			$month_tmp = $data["month"];
			$day_tmp = $data["day"];

		}

	}

	$html_all = "";

	if( $html != "" ){

		$html_all .= '<select name="attendance_id">';
		$html_all .= '<option value="-1">未選択</option>';
		$html_all .= $html;
		$html_all .= '</select>';
	}

	return $html_all;
	exit();

}

function get_repeat_point_data_by_attendance_id($attendance_id){

	$sql = sprintf("
select * from repeater where
delete_flg=0 and
attendance_id='%s'",
$attendance_id);

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_repeat_point_data_by_attendance_id)";
		exit();

	}

	$num = mysql_num_rows($res);

	$data["value"] = $num * 5;
	$data["num"] = $num;

	return $data;
	exit();

}

function get_total_point_for_sale_therapist_one($therapist_id,$year,$month){

	//施術と指名のポイント獲得のため
	$sql = sprintf("
select
reservation_for_board.shimei_flg
from reservation_for_board
left join attendance_new on attendance_new.id=reservation_for_board.attendance_id
where
((reservation_for_board.year<%s) or ((reservation_for_board.year=%s) and (reservation_for_board.month<%s))) and
attendance_new.therapist_id='%s' and
reservation_for_board.delete_flg=0",
$year,$year,$month,$therapist_id);

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_total_point_for_sale_therapist_one)";
		exit();

	}

	$total_point = 0;

	while($row = mysql_fetch_assoc($res)){

		$shimei_flg = $row["shimei_flg"];

		//指名
		if( $shimei_flg == "1" ){
			$total_point = $total_point + 3;
		}

		//施術
		$total_point = $total_point + 1;

	}

	//リピートポイントの獲得のため(2014年から)
	$sql = sprintf("
select id from attendance_new
where
((year<%s) or ((year=%s) and (month<%s))) and
(year>2013) and
therapist_id='%s'",
$year,$year,$month,$therapist_id);

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_total_point_for_sale_therapist_one)";
		exit();

	}

	while($row = mysql_fetch_assoc($res)){

		$attendance_id = $row["id"];

		$repeat_point_data = get_repeat_point_data_by_attendance_id($attendance_id);
		$repeater_point = $repeat_point_data["value"];

		//リピーターポイント
		$total_point = $total_point + $repeater_point;

	}

	return $total_point;
	exit();

}

//売上損金の取得
function get_lost_cost_by_attendance_id($attendance_id){

	//施術と指名のポイント獲得のため
	$sql = sprintf("select lost_cost from reservation_for_board where delete_flg=0 and attendance_id='%s'",$attendance_id);
	$res = mysql_query($sql, DbCon);
	if( $res == false ){
		echo "error!(get_lost_cost_by_attendance_id)";
		exit();
	}

	$data = 0;

	while($row = mysql_fetch_assoc($res)){

		$lost_cost = $row["lost_cost"];

		$data = $data + $lost_cost;

	}

	return $data;
	exit();
}

function get_gross_profit_for_sale_shop(
$genkin_price,$card_price,$therapist_remuneration_sum,$driver_remuneration_sum,$movement_cost,$driver_gasoline,
$driver_parking,$driver_highway,$card_commission,$shop_boss_remuneration,$driver_sonota,$driver_pay_finish){

//「売上」-「報酬合計(セラピスト)」-「報酬合計(ドライバー)」-「移動実費」-「ガソリン代」-「駐車場代」-「高速代」-
//「カード手数料」-「店長報酬」-「その他(ドライバー)」+「清算済み(ドライバー)」
//=(粗利益)

	$sale_price = $genkin_price + $card_price;

	$gross_profit = $sale_price - $therapist_remuneration_sum - $driver_remuneration_sum - $movement_cost -
$driver_gasoline - $driver_parking - $driver_highway - $card_commission - $shop_boss_remuneration - $driver_sonota +
$driver_pay_finish;

	return $gross_profit;
	exit();

}

function get_shop_boss_remuneration_for_sale_shop(
$genkin_price,$card_price,$therapist_remuneration,
$driver_remuneration,$movement_cost,$driver_gasoline,$driver_parking,$card_commission,
$shop_area,$lowest_guarantee,$driver_highway){

	//セラピスト報酬に最低保証分も足す
	$therapist_remuneration = $therapist_remuneration + $lowest_guarantee;

	if( $shop_area == "tokyo" ){

		$shop_boss_remuneration = 0;

		return $shop_boss_remuneration;
		exit();

	}

	//□各エリアの店長報酬の計算式
	//【札幌】
	//売上-セラピスト報酬合計-ドライバー報酬合計-移動費(移動実費+ガソリン代+駐車場代+高速代）-カード手数料×20％

	//【大阪】
	//売上-セラピスト報酬合計-ドライバー報酬合計-移動費(移動実費+ガソリン代+駐車場代+高速代）-カード手数料×10％

	//【横浜】【仙台】
	//売上-セラピスト報酬合計-ドライバー報酬合計-移動費(移動実費+ガソリン代+駐車場代+高速代）-カード手数料×10％

	//超過手当もマイナス(超過手当はガソリン代に含まれている)

	$shop_boss_remuneration = 0;

	$sale_price = $genkin_price + $card_price;

	$movement_cost_all = $movement_cost + $driver_gasoline + $driver_parking + $driver_highway;

	if( ($shop_area=="sapporo")){

		$shop_boss_remuneration = intval(($sale_price-$therapist_remuneration-$driver_remuneration-$movement_cost_all-$card_commission)/5);

	}else if( $shop_area == "osaka" ){

		$shop_boss_remuneration = intval(($sale_price-$therapist_remuneration-$driver_remuneration-$movement_cost_all-$card_commission)/10);

	}else if( ($shop_area == "yokohama") || ($shop_area=="sendai") || ($shop_area=="yokohama2")){

		$shop_boss_remuneration = intval(($sale_price-$therapist_remuneration-$driver_remuneration-$movement_cost_all-$card_commission)/10);

	}

	return $shop_boss_remuneration;
	exit();

}

function update_sale_shop($shop_id,$shop_area,$frm_val,$year,$month,$day,$action_type){

	if( $action_type != "movement_cost" ){

		return false;
		exit();

	}

	$value_old = get_value_from_sale_cost($shop_area,$year,$month,$day,$action_type);
	$value_new = $frm_val;

	//トランザクションをはじめる準備
	$sql = "set autocommit = 0";
	mysql_query( $sql, DbCon );

	//トランザクション開始
	$sql = "begin";
	mysql_query( $sql, DbCon );

	if( $value_old != "-1" ){

		//アップデート
		$sql = sprintf("
update sale_cost set
value='%s'
where
delete_flg=0 and
area='%s' and
year='%s' and
month='%s' and
day='%s' and
name='%s'",
$frm_val,$shop_area,$year,$month,$day,$action_type);

	}else{

		//インサート
		$sql = sprintf("
insert into sale_cost(value,area,year,month,day,name)
values('%s','%s','%s','%s','%s','%s')",
$frm_val,$shop_area,$year,$month,$day,$action_type);

	}

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		//ロールバック
		$sql = "rollback";
		mysql_query( $sql, DbCon );

		echo "error!(update_sale_shop)";
		exit();

	}

	//payment_change_historyに記録
	$now = time();

	$type = "shop";

	$sql = sprintf("
insert into payment_change_history(created,name,value_old,value_new,area,type,year,month,day,shop_id)
values('%s','%s','%s','%s','%s','%s','%s','%s','%s','%s')",
$now,$action_type,$value_old,$value_new,$shop_area,$type,$year,$month,$day,$shop_id);

	$res = mysql_query($sql, DbCon);

	if($res === false){

		//ロールバック
		$sql = "rollback";
		mysql_query( $sql, DbCon );

		echo "error!(update_sale_shop)";
		exit();

	}

	//コミット
	$sql = "commit";
	mysql_query( $sql, DbCon );

	return true;
	exit();
}

function check_exist_sale_cost($area,$year,$month,$day,$action_type){

	$sql = sprintf("
select id from sale_cost where
delete_flg=0 and
name='%s' and
year='%s' and
month='%s' and
day='%s' and
area='%s'",
$action_type,$year,$month,$day,$area);

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(check_exist_sale_cost)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	if( $row["id"] == "" ){

		return false;
		exit();

	}else{

		return true;
		exit();

	}

}

function get_value_from_sale_cost($area,$year,$month,$day,$action_type){

	$sql = sprintf("
select value from sale_cost where
delete_flg=0 and
name='%s' and
year='%s' and
month='%s' and
day='%s' and
area='%s'",
$action_type,$year,$month,$day,$area);

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_value_old_from_sale_cost)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	if( $row["value"] == "" ){

		return "-1";
		exit();

	}else{

		return $row["value"];
		exit();

	}

}

function get_movement_cost_value_for_sale_shop_2($area,$year,$month,$day){

	$movement_cost_value = get_movement_cost_value_for_sale_shop($area,$year,$month,$day);

	if( $movement_cost_value > 0 ){

		return $movement_cost_value;
		exit();

	}

$sql = sprintf("
select value from sale_cost where
delete_flg=0 and
name='movement_cost' and
year='%s' and
month='%s' and
day='%s' and
area='%s'",
$year,$month,$day,$area);

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_movement_cost_value_for_sale_shop_2)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	if( $row["value"] == "" ){

		return "0";
		exit();

	}else{

		return $row["value"];
		exit();

	}

}

function get_movement_cost_for_sale_shop($area,$year,$month,$day){

	$movement_cost = get_movement_cost_value_for_sale_shop_2($area,$year,$month,$day);

	return $movement_cost;
	exit();

}

function osaka_hanbun($value,$shop_name){

	$half = intval( $value / 2 );
	$amari = $value - ( $half * 2 );

	$data = 0;

	if( $shop_name == "大阪アロマスタイル" ){

		$data = $half;

	}else{

		$data = $half+$amari;

	}

	return $data;
	exit();

}

function get_change_data_for_sale_operation_edit(
$course_var,$extension,$shimei_flg,$card_flg,$transportation,$lost_cost,$reservation_for_board_id){

	$board_data = get_reservation_for_board_data_by_id_common($reservation_for_board_id);

	$course_var_old = $board_data["course_var"];
	$extension_old = $board_data["extension"];
	$shimei_flg_old = $board_data["shimei_flg"];
	$card_flg_old = $board_data["card_flg"];
	$transportation_old = $board_data["transportation"];
	$lost_cost_old = $board_data["lost_cost"];

	$course_var_new = $course_var;
	$extension_new = $extension;
	$shimei_flg_new = $shimei_flg;
	$card_flg_new = $card_flg;
	$transportation_new = $transportation;
	$lost_cost_new = $lost_cost;

	$data = array();
	$i=0;

	if( $course_var_old != $course_var_new ){
		$data[$i]["name"] = "course_var";
		$data[$i]["old"] = $course_var_old;
		$data[$i]["new"] = $course_var_new;
		$i++;
	}
	if( $extension_old != $extension_new ){
		$data[$i]["name"] = "extension";
		$data[$i]["old"] = $extension_old;
		$data[$i]["new"] = $extension_new;
		$i++;
	}
	if( $shimei_flg_old != $shimei_flg_new ){
		$data[$i]["name"] = "shimei_flg";
		$data[$i]["old"] = $shimei_flg_old;
		$data[$i]["new"] = $shimei_flg_new;
		$i++;
	}
	if( $card_flg_old != $card_flg_new ){
		$data[$i]["name"] = "card_flg";
		$data[$i]["old"] = $card_flg_old;
		$data[$i]["new"] = $card_flg_new;
		$i++;
	}
	if( $transportation_old != $transportation_new ){
		$data[$i]["name"] = "transportation";
		$data[$i]["old"] = $transportation_old;
		$data[$i]["new"] = $transportation_new;
		$i++;
	}
	if( $lost_cost_old != $lost_cost_new ){
		$data[$i]["name"] = "lost_cost";
		$data[$i]["old"] = $lost_cost_old;
		$data[$i]["new"] = $lost_cost_new;
		$i++;
	}

	return $data;
	exit();

}

function get_payment_change_history_shop($area,$type){

	if( $area == "all" ){

		$sql = sprintf("
select * from payment_change_history where
delete_flg=0 and
type='%s'
order by created desc limit 0,1000",
$type);

	}else{

		$sql = sprintf("
select * from payment_change_history where
delete_flg=0 and
area='%s' and
type='%s'
order by created desc limit 0,1000",
$area,$type);

	}

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(get_payment_change_history_shop)";
		exit();

	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$created = $row["created"];
		$shop_id = $row["shop_id"];
		$name = $row["name"];
		$eigyou_month = $row["month"];
		$eigyou_day = $row["day"];

		$action_name = get_change_action_name_shop($name);

		$shop_name = get_shop_name_by_shop_id($shop_id);

		$action_month = add_zero_when_under_ten_common(intval(date('m', $created)));
		$action_day = add_zero_when_under_ten_common(intval(date('d', $created)));

		$disp = sprintf("
%s/%s　%sの「%s/%s%s」を修正",
$action_month,$action_day,$shop_name,$eigyou_month,$eigyou_day,$action_name);

		$list_data[$i] = $row;
		$list_data[$i]["disp"] = $disp;

		$i++;

	}

	/*
	echo "<pre>";
	print_r($list_data);
	echo "</pre>";
	exit();
	*/

	return $list_data;
	exit();

}

function get_change_action_name_shop($name){

	$action_name = "不明";

	if( $name == "movement_cost" ){

		$action_name = "移動実費";

	}

	return $action_name;
	exit();

}

function get_payment_change_history_operation($area,$type){

	if( $area == "all" ){

		$sql = sprintf("
select * from payment_change_history where
delete_flg=0 and
type='%s'
order by created desc limit 0,1000",
$type);

	}else{

		$sql = sprintf("
select * from payment_change_history where
delete_flg=0 and
area='%s' and
type='%s'
order by created desc limit 0,1000",
$area,$type);

	}

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(get_payment_change_history_operation)";
		exit();

	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$created = $row["created"];
		$reservation_for_board_id = $row["reservation_for_board_id"];
		$name = $row["name"];

		$action_name = get_change_action_name_operation($name);

		$board_data = get_reservation_for_board_data_by_id_common($reservation_for_board_id);

		$attendance_id = $board_data["attendance_id"];
		$shop_name = $board_data["shop_name"];
		$customer_name = $board_data["customer_name"];

		$eigyou_month = add_zero_when_under_ten_common($board_data["month"]);
		$eigyou_day = add_zero_when_under_ten_common($board_data["day"]);

		$therapist_name = get_therapist_name_by_attendance_id_common($attendance_id);

		$action_month = add_zero_when_under_ten_common(intval(date('m', $created)));
		$action_day = add_zero_when_under_ten_common(intval(date('d', $created)));

		$disp = sprintf("
%s/%s　%s「店：%s」「顧客名：%s」の「%s/%s　%s」を修正",
$action_month,$action_day,$therapist_name,$shop_name,$customer_name,$eigyou_month,$eigyou_day,$action_name);

		$list_data[$i] = $row;
		$list_data[$i]["disp"] = $disp;

		$i++;

	}

	/*
	 echo "<pre>";
	print_r($list_data);
	echo "</pre>";
	exit();
	*/

	return $list_data;
	exit();

}

function get_change_action_name_operation($name){

	$action_name = "不明";

	if( $name == "course_var" ){

		$action_name = "コース";

	}else if( $name == "extension" ){

		$action_name = "延長時間";

	}else if( $name == "shimei_flg" ){

		$action_name = "指名";

	}else if( $name == "card_flg" ){

		$action_name = "区分";

	}else if( $name == "transportation" ){

		$action_name = "交通費";

	}else if( $name == "lost_cost" ){

		$action_name = "売上損金";

	}

	return $action_name;
	exit();

}



function get_remuneration_at_sale_shop_new($year,$month,$day,$shop_name){

	$remuneration_all = 0;

	$result = check_last_day_for_remuneration_common($year,$month,$day);

	if( $result == false ){

		return $remuneration_all;
		exit();

	}

	$sql = sprintf("
select
sale_history.price,
sale_history.therapist_id,
reservation_for_board.attendance_id,
reservation_for_board.shop_area,
reservation_for_board.shimei_flg,
reservation_for_board.transportation
from reservation_for_board
left join sale_history on sale_history.reservation_no=reservation_for_board.reservation_no
where
reservation_for_board.shop_name='%s' and
reservation_for_board.year='%s' and
reservation_for_board.month='%s' and
reservation_for_board.day='%s' and
reservation_for_board.delete_flg=0 and
sale_history.delete_flg=0 and
sale_history.eigyou_year='%s' and
sale_history.eigyou_month='%s' and
sale_history.eigyou_day='%s'",
$shop_name,$year,$month,$day,$year,$month,$day);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_remuneration_at_sale_shop)";
		exit();

	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$list_data[$i++] = $row;

	}

	$list_data_num = count($list_data);

	for($i=0;$i<$list_data_num;$i++){

		$price = $list_data[$i]["price"];
		$shimei_flg = $list_data[$i]["shimei_flg"];
		$transportation = $list_data[$i]["transportation"];
		$attendance_id = $list_data[$i]["attendance_id"];

		$share_rate = get_share_rate_by_attendance_id_common($attendance_id);

		if($list_data[$i]["shop_area"]!="tokyo_reraku"){
			$remuneration = get_remuneration_one_common($price,$shimei_flg,$transportation,$share_rate);
		}
		else{
			$remuneration = get_remuneration_one_reraku_common($price,$shimei_flg,$transportation,$share_rate);
		}

		$remuneration_all = $remuneration_all + $remuneration;

	}

	return $remuneration_all;
	exit();

}

function get_lowest_guarantee($shop_area,$shop_name,$year,$month,$day){

	$value = 0;

	if( $shop_area == "tokyo" ){

		if( $shop_name == "東京リフレ" ){

			$value = get_lowest_guarantee_by_area($shop_area,$year,$month,$day);

		}

	}else if( $shop_area == "osaka" ){

		$value = get_lowest_guarantee_by_area($shop_area,$year,$month,$day);

		//$value = osaka_hanbun($value,$shop_name);

	}else{

		$value = get_lowest_guarantee_by_area($shop_area,$year,$month,$day);

	}

	return $value;
	exit();

}

function get_lowest_guarantee_by_area($area,$year,$month,$day){

	$attendance_data = get_attendance_data_work_by_area_common($area,$year,$month,$day);

	/*
	echo "<pre>";
	print_r($attendance_data);
	echo "</pre>";
	exit();
	*/

	$attendance_data_num = count($attendance_data);

	$lowest_guarantee_all = 0;

	for($i=0;$i<$attendance_data_num;$i++){

		$attendance_id = $attendance_data[$i]["id"];

		$remuneration_data = get_therapist_remuneration_by_attendance_id_common($attendance_id);
		$lowest_guarantee = $remuneration_data["lowest_guarantee"];

		$lowest_guarantee_all = $lowest_guarantee_all + $lowest_guarantee;

	}

	return $lowest_guarantee_all;
	exit();

}

function get_month_data($year,$month){

	$data = array();

	$last_day = get_month_last_day($year,$month);

	for($i=0;$i<$last_day;$i++){

		$day = ( $i + 1 );

		$week = get_week_name_by_time_common($year, $month, $day);

		$data[$i]["year"] = $year;
		$data[$i]["month"] = $month;
		$data[$i]["day"] = $day;
		$data[$i]["week"] = $week;

	}

	return $data;
	exit();

}

//売上データの取得
function get_sale_data_for_shop_report($month_data,$shop_area_data){
//print_r($month_data);

	$shop_area_data_num = count($shop_area_data);

	$area = "all";
	$shop_data = get_shop_data($area);

	$shop_data_num = count($shop_data);

	/*
	echo "<pre>";
	print_r($shop_data);
	echo "</pre>";
	exit();
	*/

	$month_data_num = count($month_data);

	$data = array();

	for($i=0;$i<$month_data_num;$i++){

		$year = $month_data[$i]["year"];
		$month = $month_data[$i]["month"];
		$day = $month_data[$i]["day"];

		$data[$i]["year"] = $year;
		$data[$i]["month"] = $month;
		$data[$i]["day"] = $day;

		$shop_data_tmp = array();

		$total_price = 0;

		for($x=0;$x<$shop_data_num;$x++){

			$shop_id = $shop_data[$x]["id"];
			$shop_name = $shop_data[$x]["name"];

			$result = check_past_day_for_remuneration_common($year,$month,$day);	//前日チェック(報酬計算用)(過去であればTRUE)

			if( $result == true ){

				//$price = get_sale_price_day_by_shop_name($year,$month,$day,$shop_name);

				$data_tmp = get_sale_data_day_common($year,$month,$day,$shop_name);		//料金集計

				$price = $data_tmp["price"];
				$operation_num = $data_tmp["operation_num"];
				$operation_num_new = $data_tmp["operation_num_new"];

			}else{

				//$price = 0;

				$price = 0;
				$operation_num = 0;
				$operation_num_new = 0;

			}

			$shop_data_tmp[$x]["name"] = $shop_name;
			$shop_data_tmp[$x]["price"] = $price;

			//$operation_num = get_reservation_for_board_num_by_shop_name_common($year,$month,$day,$shop_name);

			//$type = "new";
			//$operation_num_new = get_reservation_for_board_num_by_shop_name_and_type_common($year,$month,$day,$shop_name,$type);

			$operation_num_repeat = $operation_num - $operation_num_new;

			$shop_data_tmp[$x]["operation_num"] = $operation_num;
			$shop_data_tmp[$x]["operation_num_new"] = $operation_num_new;
			$shop_data_tmp[$x]["operation_num_repeat"] = $operation_num_repeat;

			$operation_rate_new = get_int_per_common($operation_num_new,$operation_num);		//割合計算

			$operation_rate_repeat = get_int_per_common($operation_num_repeat,$operation_num);	//割合計算

			$shop_data_tmp[$x]["operation_rate_new"] = $operation_rate_new;
			$shop_data_tmp[$x]["operation_rate_repeat"] = $operation_rate_repeat;

			//機会ロス
			$type = "shop_id";
			$area = "-1";
			$loss_data = get_shop_report_loss_data_day_for_shop_report($shop_id,$area,$year,$month,$day,$type);	//機会ロス

			$loss = $loss_data["loss"];

			//受電数の取得
			//$call_num = get_call_num_day_for_shop_report($shop_id,$year,$month,$day);
			$call_num = $operation_num + $loss;

			//成約率
			$agreement_num_rate = get_int_per_common($operation_num,$call_num);		//割合計算

			$shop_data_tmp[$x]["call_num"] = $call_num;
			$shop_data_tmp[$x]["agreement_num_rate"] = $agreement_num_rate;

			$shop_data_tmp[$x]["loss_data"] = $loss_data;

			$total_price = $total_price + $price;

		}

		for( $z=0; $z<$shop_area_data_num; $z++ ){

			$area = $shop_area_data[$z];

			//機会ロス
			$type = "area";
			$shop_id = "-1";
			$loss_data = get_shop_report_loss_data_day_for_shop_report($shop_id,$area,$year,$month,$day,$type);	//機会ロス

			$data[$i]["loss_data"][$area] = $loss_data;

		}

		$data[$i]["total_price"] = $total_price;

		$data[$i]["shop_data"] = $shop_data_tmp;

		$data[$i]["attendance_num"]["tokyo"] = get_attendance_num_by_day_and_area_common($year,$month,$day,"tokyo");
		$data[$i]["attendance_num"]["yokohama"] = get_attendance_num_by_day_and_area_common($year,$month,$day,"yokohama");
		$data[$i]["attendance_num"]["sapporo"] = get_attendance_num_by_day_and_area_common($year,$month,$day,"sapporo");
		$data[$i]["attendance_num"]["sendai"] = get_attendance_num_by_day_and_area_common($year,$month,$day,"sendai");
		$data[$i]["attendance_num"]["osaka"] = get_attendance_num_by_day_and_area_common($year,$month,$day,"osaka");
		$data[$i]["attendance_num"]["tokyo_reraku"] = get_attendance_num_by_day_and_area_common($year,$month,$day,"tokyo_reraku");
		$data[$i]["attendance_num"]["tokyo_bigao"] = get_attendance_num_by_day_and_area_common($year,$month,$day,"tokyo_bigao");

		$data[$i]["operation_num"]["tokyo"] = get_reservation_for_board_num_by_shop_area_common($year,$month,$day,"tokyo");
		$data[$i]["operation_num"]["yokohama"] = get_reservation_for_board_num_by_shop_area_common($year,$month,$day,"yokohama");
		$data[$i]["operation_num"]["sapporo"] = get_reservation_for_board_num_by_shop_area_common($year,$month,$day,"sapporo");
		$data[$i]["operation_num"]["sendai"] = get_reservation_for_board_num_by_shop_area_common($year,$month,$day,"sendai");
		$data[$i]["operation_num"]["osaka"] = get_reservation_for_board_num_by_shop_area_common($year,$month,$day,"osaka");
		$data[$i]["operation_num"]["tokyo_reraku"] = get_reservation_for_board_num_by_shop_area_common($year,$month,$day,"tokyo_reraku");
		$data[$i]["operation_num"]["tokyo_bigao"] = get_reservation_for_board_num_by_shop_area_common($year,$month,$day,"tokyo_bigao");

		$data[$i]["attendance_num_all"] = get_attendance_num_by_day_common($year,$month,$day);
		$data[$i]["operation_num_all"] = get_reservation_for_board_num_by_day_common($year,$month,$day);

	}

	/*
	echo "<pre>";
	print_r($data);
	echo "</pre>";
	exit();
	*/

	return $data;
	exit();

}

function get_sale_price_day_by_shop_name($year,$month,$day,$shop_name){

	$sql = sprintf("
select sale_history.price from reservation_for_board
left join sale_history on sale_history.reservation_no=reservation_for_board.reservation_no
where
reservation_for_board.shop_name='%s' and
reservation_for_board.year='%s' and
reservation_for_board.month='%s' and
reservation_for_board.day='%s' and
reservation_for_board.delete_flg=0 and
reservation_for_board.complete_flg='1' and
sale_history.delete_flg=0 and
sale_history.eigyou_year='%s' and
sale_history.eigyou_month='%s' and
sale_history.eigyou_day='%s'",
$shop_name,$year,$month,$day,$year,$month,$day);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_sale_price_day_by_shop_name)";
		exit();

	}

	$total = 0;

	while($row = mysql_fetch_assoc($res)){

		$price = $row["price"];

		$total = $total + $price;

	}

	return $total;
	exit();

}

//一日の平均売上取得
function get_average_data_for_shop_report($sale_data,$work_num){

	$sale_data_num = count($sale_data);

	for( $i=0; $i<$sale_data_num; $i++ ){

		$price = $sale_data[$i]["price"];
		$shop_name = $sale_data[$i]["shop_name"];

		if( $shop_name == "東京リフレ" ){

			$tokyo_refle_price = $tokyo_refle_price + $price;

		}else if( $shop_name == "東京アロマ" ){

			$tokyo_aroma_price = $tokyo_aroma_price + $price;

		}else if( $shop_name == "リンパマッサージ東京" ){

			$lymph_tokyo_price = $lymph_tokyo_price + $price;

		}else if( $shop_name == "横浜リフレ" ){

			$yokohama_refle_price = $yokohama_refle_price + $price;

		}else if( $shop_name == "札幌リフレ" ){

			$sapporo_refle_price = $sapporo_refle_price + $price;

		}else if( $shop_name == "仙台リフレ" ){

			$sendai_refle_price = $sendai_refle_price + $price;

		}else if( $shop_name == "大阪リフレ" ){

			$osaka_refle_price = $osaka_refle_price + $price;

		}else if( $shop_name == "大阪アロマスタイル" ){

			$osaka_aroma_price = $osaka_aroma_price + $price;

		}

	}

	$data["tokyo_refle"] = intval($tokyo_refle_price/$work_num);
	$data["tokyo_aroma"] = intval($tokyo_aroma_price/$work_num);
	$data["lymph_tokyo"] = intval($lymph_tokyo_price/$work_num);
	$data["yokohama_refle"] = intval($yokohama_refle_price/$work_num);
	$data["sapporo_refle"] = intval($sapporo_refle_price/$work_num);
	$data["sendai_refle"] = intval($sendai_refle_price/$work_num);
	$data["osaka_refle"] = intval($osaka_refle_price/$work_num);
	$data["osaka_aroma"] = intval($osaka_aroma_price/$work_num);

	return $data;
	exit();

}

function get_shop_holiday_data($type){

	$sql = sprintf("select * from shop_holiday where name='%s'",$type);
	$res = mysql_query($sql, DbCon);
	if( $res == false ){
		echo "error!(get_shop_holiday_data)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();
}

function update_shop_holiday_data($type,$content,$display_flg){

	$content = mysql_real_escape_string($content);

	if( $display_flg == "" ){

		$display_flg = 0;

	}

	$sql = sprintf("update shop_holiday set content='%s',display_flg='%s' where name='%s'",$content,$display_flg,$type);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(update_shop_holiday_data)";
		exit();
	}

	return true;
	exit();

}

//一ヶ月の売上データ(店舗別レポート)
function get_month_sale_data_for_shop_report($year,$month){

	$sql = sprintf("
select sale_history.*,reservation_for_board.shop_name from sale_history
left join reservation_for_board on reservation_for_board.reservation_no=sale_history.reservation_no
where
reservation_for_board.year=%s and
sale_history.eigyou_year=%s and
reservation_for_board.month=%s and
sale_history.eigyou_month=%s and
(reservation_for_board.day>=1) and
(reservation_for_board.day<=31) and
(sale_history.eigyou_day>=1) and
(sale_history.eigyou_day<=31) and
sale_history.delete_flg=0 and
reservation_for_board.delete_flg=0",
$year,$year,$month,$month);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_month_sale_data_for_shop_report)";
		exit();

	}

	$i=0;
	$data = array();

	while($row = mysql_fetch_assoc($res)){

		$data[$i++] = $row;

	}

	return $data;
	exit();

}

//稼働日数を取得
function get_work_num_for_shop_report($year,$month){

	$last_day = get_month_last_day($year,$month);

	$work_num = 0;

	for( $i=1; $i<=$last_day; $i++ ){

		$day = $i;

		$result = check_past_day_for_remuneration_common($year,$month,$day);

		if( $result == true ){

			$result = check_attendance_new_exist_by_day_common($year,$month,$day);

			if( $result == true ){

				$work_num++;

			}

		}

	}

	return $work_num;
	exit();

}

//稼働日数を取得(未来も入れるバージョン)
function get_work_num_for_shop_report_mirai($year,$month){

	$last_day = get_month_last_day($year,$month);

	$work_num = 0;

	for( $i=1; $i<=$last_day; $i++ ){

		$day = $i;

		$result = check_attendance_new_exist_by_day_common($year,$month,$day);

		if( $result == true ){

			$work_num++;

		}

	}

	return $work_num;
	exit();

}

//売上の合計金額
function get_sum_data_for_shop_report($sale_data){

	$sale_data_num = count($sale_data);

	for( $i=0; $i<$sale_data_num; $i++ ){

		$price = $sale_data[$i]["price"];
		$shop_name = $sale_data[$i]["shop_name"];

		if( $shop_name == "東京リフレ" ){

			$tokyo_refle_price = $tokyo_refle_price + $price;

		}else if( $shop_name == "東京アロマ" ){

			$tokyo_aroma_price = $tokyo_aroma_price + $price;

		}else if( $shop_name == "リンパマッサージ東京" ){

			$lymph_tokyo_price = $lymph_tokyo_price + $price;

		}else if( $shop_name == "横浜リフレ" ){

			$yokohama_refle_price = $yokohama_refle_price + $price;

		}else if( $shop_name == "札幌リフレ" ){

			$sapporo_refle_price = $sapporo_refle_price + $price;

		}else if( $shop_name == "仙台リフレ" ){

			$sendai_refle_price = $sendai_refle_price + $price;

		}else if( $shop_name == "大阪リフレ" ){

			$osaka_refle_price = $osaka_refle_price + $price;

		}else if( $shop_name == "大阪アロマスタイル" ){

			$osaka_aroma_price = $osaka_aroma_price + $price;

		}

	}

	$data["tokyo_refle"] = $tokyo_refle_price;
	$data["tokyo_aroma"] = $tokyo_aroma_price;
	$data["lymph_tokyo"] = $lymph_tokyo_price;
	$data["yokohama_refle"] = $yokohama_refle_price;
	$data["sapporo_refle"] = $sapporo_refle_price;
	$data["sendai_refle"] = $sendai_refle_price;
	$data["osaka_refle"] = $osaka_refle_price;
	$data["osaka_aroma"] = $osaka_aroma_price;

	return $data;
	exit();

}

function get_pre_month_average_data_for_shop_report($year,$month,$shop_id_data,$shop_area_data){

	$day = 10;

	$data = get_pre_month_common($year,$month,$day);

	$year = $data["year"];
	$month = $data["month"];

	//最初のアクセスで、必要なデータのインサート
	insert_first_time_data_for_shop_report($year,$month,$shop_id_data,$shop_area_data);

	$month_data = get_month_data($year,$month);

	//売上データの取得
	$sale_data = get_sale_data_for_shop_report($month_data,$shop_area_data);

	/*
	echo "<pre>";
	print_r($sale_data);
	echo "</pre>";
	exit();
	*/

	//稼働日数を取得
	$work_num = get_work_num_for_shop_report($year,$month);

	//合計と一日の平均
	$sum_average_data = get_sum_average_data_for_shop_report($sale_data,$work_num,$year,$month);

	return $sum_average_data;
	exit();

}

function get_sum_value_for_shop_report($data){

	$sum_value = $data["tokyo_refle"] + $data["tokyo_aroma"] + $data["lymph_tokyo"] + $data["yokohama_refle"] + $data["sapporo_refle"] + $data["sendai_refle"] + $data["osaka_refle"] + $data["osaka_aroma"] + $data["tokyo_reraku"] + $data["tokyo_bigao"];

	return $sum_value;
	exit();

}

function get_sum_value_2_for_shop_report($data){

	$sum_value = $data["tokyo"] + $data["yokohama"] + $data["sapporo"] + $data["sendai"] + $data["osaka"] + $data["tokyo_reraku"] + $data["tokyo_bigao"];

	return $sum_value;
	exit();

}

function get_hikaku_value_for_shop_report($data_new,$data_old){

	$hikaku_value = 0;

	if( ($data_new=="0") || ($data_new=="") || ($data_old=="0") || ($data_old=="") ){

		return $hikaku_value;
		exit();

	}

	$hikaku_value = intval(($data_new/$data_old)*100);

	return $hikaku_value;
	exit();

}

function kirisute($value,$num){

	$data = 0;

	if( ($value=="0") || ($value=="") || ($num=="0") || ($num=="") ){

		//返り値は「0」

	}else{

		$data = $value/$num;

		$data = sprintf("%.2f", $data);

		$data = intval($data*10);

		$data = $data/10;

	}

	return $data;
	exit();

}

function get_hikaku_data_all_for_shop_report($data,$data_pre){

	$price_now = $data["price"];
	$price_pre = $data_pre["price"];
	$average_now = $data["average"];
	$average_pre = $data_pre["average"];
	$attendance_num_now = $data["attendance_num"]["average"];
	$attendance_num_pre = $data_pre["attendance_num"]["average"];
	$operation_num_now = $data["operation_num"]["average"];
	$operation_num_pre = $data_pre["operation_num"]["average"];

	$return_data["sale"] = get_hikaku_value_for_shop_report($average_now,$average_pre);
	$return_data["attendance_num"] = get_hikaku_value_for_shop_report($attendance_num_now,$attendance_num_pre);
	$return_data["operation_num"] = get_hikaku_value_for_shop_report($operation_num_now,$operation_num_pre);

	return $return_data;
	exit();

}

function get_furikomi_day_select_frm_for_furikomi_list($year,$month,$day){

	$year_now = intval(date("Y"));
	$year_old = $year_now - 1;
	$year_next = $year_now + 1;

	$html = "";

$html .= '<div>';
$html .= '<div id="select_menu_year_furikomi_list">';
$html .= '<select name="year">';
for($i=$year_old;$i<=$year_next;$i++){
	if( $i == $year ){
		$html .= '<option value="'.$i.'" selected>'.$i.'年</option>';
	}else{
		$html .= '<option value="'.$i.'">'.$i.'年</option>';
	}
}
$html .= '</select>';
$html .= '</div>';
$html .= '<div id="select_menu_month_furikomi_list">';
$html .= '<select name="month">';
for($i=1;$i<=12;$i++){
	if( $i == $month ){
		$html .= '<option value="'.$i.'" selected>'.$i.'月</option>';
	}else{
		$html .= '<option value="'.$i.'">'.$i.'月</option>';
	}
}
$html .= '</select>';
$html .= '</div>';
$html .= '<div id="select_menu_day_furikomi_list">';
$html .= '<select name="day">';
for($i=1;$i<=31;$i++){
	if( $i == $day ){
		$html .= '<option value="'.$i.'" selected>'.$i.'日</option>';
	}else{
		$html .= '<option value="'.$i.'">'.$i.'日</option>';
	}
}
$html .= '</select>';
$html .= '</div>';
$html .= '<br class="clear" />';
$html .= '</div>';

	return $html;
	exit;

}

function get_staff_type_name_for_furikomi_list($value){

	$menu = get_staff_type_menu_for_furikomi_list();

	$menu_num = count($menu);

	$return_data = "不明";

	for($i=0;$i<$menu_num;$i++){

		$value_tmp = $menu[$i]["value"];
		$ja_tmp = $menu[$i]["ja"];

		if( $value == $value_tmp ){

			$return_data = $ja_tmp;

		}

	}

	return $return_data;
	exit();

}

function get_select_frm_area_staff_type_for_furikomi_list($area,$staff_type){

	$area_staff_type = $area."_".$staff_type;

	$menu = get_staff_type_menu_for_furikomi_list();

	$menu_num = count($menu);

	$html = "";

	for($i=0;$i<$menu_num;$i++){

		$value = $menu[$i]["value"];
		$ja = $menu[$i]["ja"];

		if( $area_staff_type == $value ){

			$html .= '<option value="'.$value.'" selected>'.$ja.'</option>';

		}else{

			$html .= '<option value="'.$value.'">'.$ja.'</option>';

		}

	}

	return $html;
	exit;

}

function get_kikan_data_for_furikomi_day($year,$month,$day){
	return get_kikan_data_for_furikomi_day_common($year,$month,$day);	//振込日数取得
}

function get_week_data_for_furikae_list($year_from,$month_from,$day_from,$day_num){

	$year = $year_from;
	$month = $month_from;
	$day = $day_from;

	$data = array();

	if( $day_num == false ){

		return $data;
		exit();

	}

	for($i=0;$i<$day_num;$i++){

		$data[$i]["year"] = $year;
		$data[$i]["month"] = $month;
		$data[$i]["day"] = $day;

		$mirai_day = get_mirai_day_common($year,$month,$day,1);

		$year = $mirai_day["year"];
		$month = $mirai_day["month"];
		$day = $mirai_day["day"];

	}

	return $data;
	exit();

}

function get_furikomi_data_for_furikomi_list($week_data,$area,$staff_type){

	//return true;exit();

    $staff_data = get_staff_data_by_week_date_for_furikomi_list($week_data,$area,$staff_type);
	$staff_data_num = count($staff_data);

	/*
	echo "<pre>";
	print_r($staff_data);
	echo "</pre>";
	exit();
	*/

	$return_data = array();
	$x = 0;

	for( $i=0; $i<$staff_data_num; $i++ ){

		$staff_id = $staff_data[$i]["id"];
		$furikomi_type = $staff_data[$i]["furikomi_type"];
		$shayousha_flg = $staff_data[$i]["shayousha_flg"];
		$payment_span = $staff_data[$i]["payment_span"];

		if( $shayousha_flg == "1" ){

			$furikomi_price = 0;

		}
		else if($payment_span != "1"){

			if( $staff_type == "therapist" ){

				//$furikomi_price = get_furikomi_price_by_week_data_common($week_data,$staff_id);
				$data = get_furikomi_price_by_week_data_2_common($week_data,$staff_id);

			}else if( ($staff_type == "driver") || ($staff_type == "honbu") ){
				//$furikomi_price = get_furikomi_price_driver_by_week_data_common($week_data,$staff_id);
				$data = get_furikomi_price_driver_by_week_data_2_common($week_data,$staff_id);

			}else{

				echo "error!(get_furikomi_data_for_furikomi_list)";
				exit();

			}
			$furikomi_price = $data["furikomi_price"];
			$remuneration = $data["remuneration"];
			$other_price = $data["other_price"];

			$transfer_commission_price = $data["transfer_commission_price"];
			$transfer_commission_price_disp = $data["transfer_commission_price_disp"];

			$furikomi_commission = get_furikomi_commission_by_furikomi_type_common($furikomi_type,$furikomi_price);

			$staff_data[$i]["furikomi_price"] = $furikomi_price;
			$staff_data[$i]["furikomi_commission"] = $furikomi_commission;

			$staff_data[$i]["remuneration"] = $remuneration;
			$staff_data[$i]["other_price"] = $other_price;

			$staff_data[$i]["transfer_commission_price"] = $transfer_commission_price;
			$staff_data[$i]["transfer_commission_price_disp"] = $transfer_commission_price_disp;

		}
		else{
			$furikomi_price = 0;
		}

		if( $furikomi_price > 0 ){

			$return_data[$x] = $staff_data[$i];
			$x++;

		}

	}

	return $return_data;
	exit();

}

/****************************/
/* 振込リスト軽減、暫定対応 */
/****************************/
function get_furikomi_data_for_furikomi_list_tmp($week_data,$area,$staff_type,$show_index){

    $staff_data = get_staff_data_by_week_date_for_furikomi_list($week_data,$area,$staff_type);
	$staff_data_num = count($staff_data);

	/*
	echo "<pre>";
	print_r($staff_data);
	echo "</pre>";
	exit();
	*/

	$return_data = array();
	$x = 0;

	for( $i=0; $i<$staff_data_num; $i++ ){
        $continue_check = $i % 2;
		if($show_index == 1){
		    if($continue_check == 0){
		        continue;
		    }
		}
		else if($show_index == 2){
		    if($continue_check == 1){
		        continue;
		    }
		}

		$staff_id = $staff_data[$i]["id"];
		$furikomi_type = $staff_data[$i]["furikomi_type"];
		$shayousha_flg = $staff_data[$i]["shayousha_flg"];
		$payment_span = $staff_data[$i]["payment_span"];

		if( $shayousha_flg == "1" ){

			$furikomi_price = 0;

		}
		else if($payment_span != "1"){

			if( $staff_type == "therapist" ){

				$data = get_furikomi_price_by_week_data_2_common($week_data,$staff_id);

			}else if( ($staff_type == "driver") || ($staff_type == "honbu") ){

				$data = get_furikomi_price_driver_by_week_data_2_common($week_data,$staff_id);

			}else{

				echo "error!(get_furikomi_data_for_furikomi_list)";
				exit();

			}

			$furikomi_price = $data["furikomi_price"];
			$remuneration = $data["remuneration"];
			$other_price = $data["other_price"];

			$transfer_commission_price = $data["transfer_commission_price"];
			$transfer_commission_price_disp = $data["transfer_commission_price_disp"];

			$furikomi_commission = get_furikomi_commission_by_furikomi_type_common($furikomi_type,$furikomi_price);

			$staff_data[$i]["furikomi_price"] = $furikomi_price;
			$staff_data[$i]["furikomi_commission"] = $furikomi_commission;

			$staff_data[$i]["remuneration"] = $remuneration;
			$staff_data[$i]["other_price"] = $other_price;

			$staff_data[$i]["transfer_commission_price"] = $transfer_commission_price;
			$staff_data[$i]["transfer_commission_price_disp"] = $transfer_commission_price_disp;

		}
		else{
			$furikomi_price = 0;
		}

		if( $furikomi_price > 0 ){
			$return_data[$x] = $staff_data[$i];
			$x++;
		}
	}

	return $return_data;
	exit();

}

function get_furikomi_data_for_furikomi_list_monthly($week_data,$area,$staff_type){

	//return true;exit();

	$staff_data = get_staff_data_by_week_date_for_furikomi_list($week_data,$area,$staff_type);

	$staff_data_num = count($staff_data);

	/*
	echo "<pre>";
	print_r($staff_data);
	echo "</pre>";
	exit();
	*/

	$return_data = array();
	$x = 0;

	for( $i=0; $i<$staff_data_num; $i++ ){

		$staff_id = $staff_data[$i]["id"];
		$furikomi_type = $staff_data[$i]["furikomi_type"];
		$shayousha_flg = $staff_data[$i]["shayousha_flg"];
		$payment_span = $staff_data[$i]["payment_span"];

		if( $shayousha_flg == "1" ){

			$furikomi_price = 0;

		}
		else if($payment_span == "1"){

			if( $staff_type == "therapist" ){

				//$furikomi_price = get_furikomi_price_by_week_data_common($week_data,$staff_id);
				$data = get_furikomi_price_by_week_data_2_common($week_data,$staff_id);

			}else if( ($staff_type == "driver") || ($staff_type == "honbu") ){

				//$furikomi_price = get_furikomi_price_driver_by_week_data_common($week_data,$staff_id);
				$data = get_furikomi_price_driver_by_week_data_2_common($week_data,$staff_id);

			}else{

				echo "error!(get_furikomi_data_for_furikomi_list)";
				exit();

			}

			$furikomi_price = $data["furikomi_price"];
			$remuneration = $data["remuneration"];
			$other_price = $data["other_price"];

			$transfer_commission_price = $data["transfer_commission_price"];
			$transfer_commission_price_disp = $data["transfer_commission_price_disp"];

			$furikomi_commission = get_furikomi_commission_by_furikomi_type_common($furikomi_type,$furikomi_price);

			$staff_data[$i]["furikomi_price"] = $furikomi_price;
			$staff_data[$i]["furikomi_commission"] = $furikomi_commission;

			$staff_data[$i]["remuneration"] = $remuneration;
			$staff_data[$i]["other_price"] = $other_price;

			$staff_data[$i]["transfer_commission_price"] = $transfer_commission_price;
			$staff_data[$i]["transfer_commission_price_disp"] = $transfer_commission_price_disp;

		}
		else{
			$furikomi_price = 0;
		}

		if( $furikomi_price > 0 ){

			$return_data[$x] = $staff_data[$i];
			$x++;

		}

	}

	return $return_data;
	exit();

}

function get_staff_data_by_week_date_for_furikomi_list($week_data,$area,$staff_type){

	if( $staff_type == "therapist" ){

		$staff_data = get_therapist_data_by_area_new($area);

	}else if( $staff_type == "driver" ){

		$staff_data = get_driver_data_by_area_common($area);

	}else if( $staff_type == "honbu" ){

		$staff_data = get_honbu_data_by_area_common($area);

	}else{

		echo "error!(get_staff_data_by_week_date_for_furikomi_list)";
		exit();

	}

	$staff_data_num = count($staff_data);

	$data = array();
	$x = 0;

	for( $i=0; $i<$staff_data_num; $i++ ){

		$staff_id = $staff_data[$i]["id"];

		$result = check_week_attendance_exist_by_staff_id($week_data,$staff_id,$staff_type);

		if( $result == true ){

			$data[$x++] = $staff_data[$i];

		}

	}

	$data = order_value_sort_kana_common($data,"name_furi");

	return $data;
	exit();

}
/****************************************/
/*  振込依頼書報酬計算修正（恒久対応用）*/
/****************************************/
function get_staff_data_by_week_date_for_furikomi_list_for_therapist($week_data,$area,$staff_type){

    $arr_tmp = array();
    foreach($week_data as $val){
        $arr_tmp[] = "(atn.year='{$val['year']}' and atn.month='{$val['month']}' and atn.day='{$val['day']}' and atn.today_absence='0' and atn.kekkin_flg='0' and atn.syounin_state='1')";
    }
    $where_day = implode(' OR ',$arr_tmp);

    $sql = "select tpn.*, rfb.*, atn.id as attendance_id,SUM(atn.pay_day) as pay_day, SUM(CASE WHEN atn.pay_another <> 0 THEN atn.pay_another ELSE tpn.transport_cost END) as pay_another, SUM(atn.pay_finish) as pay_finish, SUM(atn.allowance) as allowance, SUM(CASE WHEN tpn.jisou_flg = 1 THEN rfb.transportation ELSE 0 END) as allowance_jisou from attendance_new as atn
            inner join therapist_new as tpn on atn.therapist_id = tpn.id
            left join reservation_for_board as rfb on atn.id = rfb.attendance_id
            where {$where_day} and tpn.leave_flg=0 and tpn.delete_flg='0' and tpn.area='{$area}' group by tpn.id order by name_furi desc";


    $sql = "select tpn.*,
            SUM(atn.pay_day) as sum_pay_day,
            SUM(CASE WHEN atn.pay_another <> 0 THEN atn.pay_another ELSE tpn.transport_cost END) as sum_pay_another,
            SUM(atn.pay_finish) as sum_pay_finish,
            SUM(atn.allowance) as sum_allowance,
            SUM(CASE WHEN tpn.jisou_flg = 1 THEN rfb.transportation ELSE 0 END) as sum_allowance_jisou,
            SUM(CASE WHEN tpn.chief_allowance_start_time <= STR_TO_DATE(concat(atn.year,atn.month,atn.day),'%Y%m%d') THEN chief_allowance ELSE 0 END) as sum_chief_allowance,
            SUM(rfb.transportation) as sum_transportation,
            SUM(CASE WHEN sh.delete_flg = 0 THEN sh.price ELSE 0 END) as sum_price,
            SUM(CASE WHEN rfb.shimei_flg = 1 THEN 1000 ELSE 0 END) as sum_shimei_value,
            SUM(CASE WHEN rfb.shimei_flg = 1 THEN (sh.price - 1000 - rfb.transportation)/10 ELSE 0 END) as sum_shimei_add_value

            from attendance_new as atn
            inner join therapist_new as tpn on atn.therapist_id = tpn.id
            left join reservation_for_board as rfb on atn.id = rfb.attendance_id
            left join sale_history as sh on rfb.reservation_no = sh.reservation_no
            where {$where_day} and tpn.leave_flg=0 and tpn.delete_flg='0' and tpn.area='{$area}' group by tpn.id order by name_furi desc";
    $res = mysql_query($sql, DbCon);

print_r($sql);

	if($res == false){
		echo "クエリ実行に失敗しました(get_therapist_data_by_area_new)";
		exit();
	}
	$data = array();
	while($row = mysql_fetch_assoc($res)){
		$data[] = $row;
	}


	echo "<pre>";
	print_r($data);
	echo "</pre>";
	exit();


	return $data;
	exit();
}


function check_week_attendance_exist_by_staff_id($week_data,$staff_id,$staff_type){

	$week_data_num = count($week_data);

	$where_day = "";

	$first_flg = true;

	for($i=0;$i<$week_data_num;$i++){

		$year = $week_data[$i]["year"];
		$month = $week_data[$i]["month"];
		$day = $week_data[$i]["day"];

		if( $first_flg == true ){

			$where_day .= sprintf("(year='%s' and month='%s' and day='%s')",$year,$month,$day);

			$first_flg = false;

		}else{

			$where_day .= sprintf(" or (year='%s' and month='%s' and day='%s')",$year,$month,$day);

		}

	}

	if( $staff_type == "therapist" ){

$sql = sprintf("
select id from attendance_new where
(%s) and
today_absence='0' and
kekkin_flg='0' and
syounin_state='1' and
therapist_id='%s'",
$where_day,$staff_id);

	}else if( ($staff_type == "driver") || ($staff_type == "honbu") ){

$sql = sprintf("
select id from attendance_staff_new where
(%s) and
today_absence='0' and
attendance_adjustment='0' and
staff_id='%s'",
$where_day,$staff_id);

	}else{

		echo "error!(check_week_attendance_exist_by_staff_id)";
		exit();

	}

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(check_week_attendance_exist_by_staff_id)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	if( $row["id"] == "" ){

		return false;
		exit();

	}else{

		return true;
		exit();

	}

}

function get_sum_data_for_furikomi_list($data){

	$data_num = count($data);

	$furikomi_price_all = 0;
	$furikomi_commission_all = 0;

	$remuneration_all = 0;
	$other_price_all = 0;

	$transfer_commission_price_all = 0;

	for( $i=0; $i<$data_num; $i++ ){

		$furikomi_price = $data[$i]["furikomi_price"];
		$furikomi_commission = $data[$i]["furikomi_commission"];

		$remuneration = $data[$i]["remuneration"];
		$other_price = $data[$i]["other_price"];

		$transfer_commission_price = $data[$i]["transfer_commission_price"];

		if( $furikomi_commission == "-1" ){

			$furikomi_commission = 0;

		}

		$furikomi_price_all = $furikomi_price_all + $furikomi_price;
		$furikomi_commission_all = $furikomi_commission_all + $furikomi_commission;

		$remuneration_all = $remuneration_all + $remuneration;
		$other_price_all = $other_price_all + $other_price;

		$transfer_commission_price_all = $transfer_commission_price_all + $transfer_commission_price;

	}

	$transfer_commission_price_all_disp = $transfer_commission_price_all * (-1);

	$data["furikomi_price"] = $furikomi_price_all;
	$data["furikomi_commission"] = $furikomi_commission_all;

	$data["remuneration"] = $remuneration_all;
	$data["other_price"] = $other_price_all;

	$data["transfer_commission_price_all_disp"] = $transfer_commission_price_all_disp;

	return $data;
	exit();

}

//最初のアクセスで、必要なデータのインサート
function insert_first_time_data_for_shop_report($year,$month,$shop_id_data,$shop_area_data){

	$last_day = get_last_day_common($year,$month);

	//目的データの有無を確認
	$tbl_name = "shop_report_target";
	$result = check_data_exist_for_shop_report($year,$month,$tbl_name);

	if( $result == false ){

		//目的データインポート
		insert_first_data_to_shop_report_target_for_shop_report($year,$month,$shop_id_data);

	}

	//機会ロスデータの有無を確認
	$tbl_name = "shop_report_loss";
	$result = check_data_exist_for_shop_report($year,$month,$tbl_name);

	if( $result == false ){

		//機会ロスデータインポート
		insert_first_data_to_shop_report_loss_for_shop_report($year,$month,$last_day,$shop_id_data,$shop_area_data);

	}

	//受電数データの有無を確認
	$tbl_name = "shop_report_call";
	$result = check_data_exist_for_shop_report($year,$month,$tbl_name);

	if( $result == false ){

		//受電数データインポート
		insert_first_data_to_shop_report_call_for_shop_report($year,$month,$last_day,$shop_id_data);

	}

	return true;
	exit();

}

//データの有無を確認
function check_data_exist_for_shop_report($year,$month,$tbl_name){

$sql = sprintf("
select id from %s where
delete_flg=0 and
year='%s' and
month='%s'",
$tbl_name,$year,$month);

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(check_data_exist_for_shop_report)";
		exit();

	}

	$num = mysql_num_rows($res);

	if( $num > 0 ){

		return true;
		exit();

	}else{

		return false;
		exit();

	}

}

//目的データインポート
function insert_first_data_to_shop_report_target_for_shop_report($year,$month,$shop_id_data){

	//トランザクションをはじめる準備
	$sql = "set autocommit = 0";
	mysql_query( $sql, DbCon );

	//トランザクション開始
	$sql = "begin";
	mysql_query( $sql, DbCon );

	$shop_id_data_num = count($shop_id_data);

	for( $i=0; $i<$shop_id_data_num; $i++ ){

		$shop_id = $shop_id_data[$i];

$sql = sprintf("insert into shop_report_target(shop_id,year,month) values('%s','%s','%s')",
$shop_id,$year,$month);

		$res = mysql_query($sql, DbCon);

		if($res == false){

			//ロールバック
			$sql = "rollback";
			mysql_query( $sql, DbCon );

			echo "error!(insert_first_data_to_shop_report_target_for_shop_report)";
			exit();

		}

	}

	//コミット
	$sql = "commit";
	mysql_query( $sql, DbCon );

	return true;
	exit();

}

//機会ロスデータインポート
function insert_first_data_to_shop_report_loss_for_shop_report($year,$month,$last_day,$shop_id_data,$shop_area_data){

	//トランザクションをはじめる準備
	$sql = "set autocommit = 0";
	mysql_query( $sql, DbCon );

	//トランザクション開始
	$sql = "begin";
	mysql_query( $sql, DbCon );

	for( $i=1; $i<=$last_day; $i++ ){

		$day = $i;

		$shop_area_data_num = count($shop_area_data);

		for( $x=0; $x<$shop_area_data_num; $x++ ){

			$area = $shop_area_data[$x];

$sql = sprintf("insert into shop_report_loss(year,month,day,area) values('%s','%s','%s','%s')",
$year,$month,$day,$area);
			//echo $sql;echo "<br />";
			$res = mysql_query($sql, DbCon);
			if($res == false){
				//ロールバック
				$sql = "rollback";
				mysql_query( $sql, DbCon );
				echo "error!(insert_first_data_to_shop_report_loss_for_shop_report)";
				exit();
			}

		}

		$shop_id_data_num = count($shop_id_data);

		for( $x=0; $x<$shop_id_data_num; $x++ ){

			$shop_id = $shop_id_data[$x];

$sql = sprintf("insert into shop_report_loss(year,month,day,shop_id) values('%s','%s','%s','%s')",
$year,$month,$day,$shop_id);
			//echo $sql;echo "<br />";
			$res = mysql_query($sql, DbCon);
			if($res == false){
				//ロールバック
				$sql = "rollback";
				mysql_query( $sql, DbCon );
				echo "error!(insert_first_data_to_shop_report_loss_for_shop_report)";
				exit();
			}

		}

	}

	//exit();

	//コミット
	$sql = "commit";
	mysql_query( $sql, DbCon );

	return true;
	exit();

}

//受電数データインポート
function insert_first_data_to_shop_report_call_for_shop_report($year,$month,$last_day,$shop_id_data){

	//トランザクションをはじめる準備
	$sql = "set autocommit = 0";
	mysql_query( $sql, DbCon );

	//トランザクション開始
	$sql = "begin";
	mysql_query( $sql, DbCon );

	for( $i=1; $i<=$last_day; $i++ ){

		$day = $i;

		$shop_id_data_num = count($shop_id_data);

		for( $x=0; $x<$shop_id_data_num; $x++ ){

			$shop_id = $shop_id_data[$x];

$sql = sprintf("insert into shop_report_call(shop_id,year,month,day) values('%s','%s','%s','%s')",
$shop_id,$year,$month,$day);

			//echo $sql;echo "<br />";

			$res = mysql_query($sql, DbCon);

			if($res == false){

				//ロールバック
				$sql = "rollback";
				mysql_query( $sql, DbCon );

				echo "error!(insert_first_data_to_shop_report_call_for_shop_report)";
				exit();

			}

		}

	}

	//コミット
	$sql = "commit";
	mysql_query( $sql, DbCon );

	return true;
	exit();
}

//売上目標値
function get_target_data_by_month_for_shop_report($shop_id,$year,$month){

	$sql = sprintf("
select * from shop_report_target
where
delete_flg='0' and
shop_id='%s' and
year='%s' and
month='%s'",
$shop_id,$year,$month);

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_target_data_by_month_for_shop_report)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();

}

//受電数の取得
function get_call_num_day_for_shop_report($shop_id,$year,$month,$day){

	$sql = sprintf("select call_num from shop_report_call where delete_flg='0' and shop_id='%s' and year='%s' and month='%s' and day='%s'",$shop_id,$year,$month,$day);
	$res = mysql_query($sql, DbCon);
	if( $res == false ){

		echo "error!(get_call_num_day_for_shop_report)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	return $row["call_num"];
	exit();

}

//機会ロス
function get_shop_report_loss_data_day_for_shop_report($shop_id,$area,$year,$month,$day,$type){

	if( $type == "shop_id" ){

$sql = sprintf("
select * from shop_report_loss
where
delete_flg='0' and
shop_id='%s' and
year='%s' and
month='%s' and
day='%s'",
$shop_id,$year,$month,$day);

	}else if( $type == "area" ){

$sql = sprintf("
select * from shop_report_loss
where
delete_flg='0' and
area='%s' and
year='%s' and
month='%s' and
day='%s'",
$area,$year,$month,$day);

	}else{

		echo "error!(get_shop_report_loss_data_day_for_shop_report)";
		exit();

	}

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_shop_report_loss_data_day_for_shop_report)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();

}

function loss_data_add_for_shop_report($loss_data_all,$loss_data){

	if( $loss_data_all["loss"] == "" ){
		$loss_data_all["loss"] = 0;
	}
	if( $loss_data_all["loss_fusoku"] == "" ){
		$loss_data_all["loss_fusoku"] = 0;
	}
	if( $loss_data_all["loss_fuzai"] == "" ){
		$loss_data_all["loss_fuzai"] = 0;
	}
	if( $loss_data_all["loss_mae"] == "" ){
		$loss_data_all["loss_mae"] = 0;
	}

	if( $loss_data["loss"] == "" ){
		$loss_data["loss"] = 0;
	}
	if( $loss_data["loss_fusoku"] == "" ){
		$loss_data["loss_fusoku"] = 0;
	}
	if( $loss_data["loss_fuzai"] == "" ){
		$loss_data["loss_fuzai"] = 0;
	}
	if( $loss_data["loss_mae"] == "" ){
		$loss_data["loss_mae"] = 0;
	}

	$loss_data_all["loss"] = $loss_data_all["loss"] + $loss_data["loss"];
	$loss_data_all["loss_fusoku"] = $loss_data_all["loss_fusoku"] + $loss_data["loss_fusoku"];
	$loss_data_all["loss_fuzai"] = $loss_data_all["loss_fuzai"] + $loss_data["loss_fuzai"];
	$loss_data_all["loss_mae"] = $loss_data_all["loss_mae"] + $loss_data["loss_mae"];

	return $loss_data_all;
	exit();

}

function get_loss_data_average_for_shop_report($loss_data,$work_num){

	$data["loss"] = kirisute($loss_data["loss"],$work_num);
	$data["loss_fusoku"] = kirisute($loss_data["loss_fusoku"],$work_num);
	$data["loss_fuzai"] = kirisute($loss_data["loss_fuzai"],$work_num);
	$data["loss_mae"] = kirisute($loss_data["loss_mae"],$work_num);

	return $data;
	exit();

}

function get_loss_data_hikaku_for_shop_report($data_new,$data_old){

	$data = array();

	$data["loss"] = get_hikaku_value_for_shop_report($data_new["average"]["loss"],$data_old["average"]["loss"]);
	$data["loss_fusoku"] = get_hikaku_value_for_shop_report($data_new["average"]["loss_fusoku"],$data_old["average"]["loss_fusoku"]);
	$data["loss_fuzai"] = get_hikaku_value_for_shop_report($data_new["average"]["loss_fuzai"],$data_old["average"]["loss_fuzai"]);
	$data["loss_mae"] = get_hikaku_value_for_shop_report($data_new["average"]["loss_mae"],$data_old["average"]["loss_mae"]);

	return $data;
	exit();

}

function update_shop_report_target_sale_price($shop_name,$frm_val,$year,$month){

	$shop_id = get_shop_id_by_shop_name_en($shop_name);

	if($shop_id < 1) return false;

	$sql = sprintf("select count(*) as nums from shop_report_target where year='%s' and month='%s' and shop_id='%s'",$year,$month,$shop_id);
	$res = mysql_query($sql, DbCon);
	if($res) {
		if($row = mysql_fetch_assoc($res)) {
			if($row["nums"] == 0) {
				$sql = sprintf("insert into shop_report_target(shop_id,year,month,sale_price) values(%s,%s,%s,%s)", $shop_id,$year,$month,$frm_val);
			} else {
				$sql = sprintf("update shop_report_target set sale_price='%s' where year='%s' and month='%s' and shop_id='%s'", $frm_val,$year,$month,$shop_id);
			}
			$res = mysql_query($sql, DbCon);
			if($res == false){
				echo "error!(update_shop_report_target_sale_price) " . $sql;
				exit();
			}
			return $res;
		} else {
			return false;
		}
	}
	return true;
}

//目標値の合計金額を取得
function get_target_price_sum($year,$month){

	$sql = sprintf("
select sale_price from shop_report_target where
delete_flg=0 and
year='%s' and
month='%s'",
$year,$month);

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_target_price_sum)";
		exit();

	}

	$sale_price_all = 0;

	while($row = mysql_fetch_assoc($res)){

		$sale_price = $row["sale_price"];

		$sale_price_all = $sale_price_all + $sale_price;

	}

	return $sale_price_all;
	exit();

}

//登録済みでないかチェック
function check_attendance_staff_new_data_exist($staff_id,$year,$month,$day){

	$sql = sprintf("
select id from attendance_staff_new where
staff_id='%s' and
year='%s' and
month='%s' and
day='%s'",
$staff_id,$year,$month,$day);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(check_attendance_staff_new_data_exist)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	if( $row["id"] == "" ){

		return false;
		exit();

	}else{

		return true;
		exit();

	}

}

function update_shop_report_loss($type,$area,$shop_id,$frm_val,$year,$month,$day){

	$sql = sprintf("
update shop_report_loss set %s='%s'
where
delete_flg='0' and
year='%s' and
month='%s' and
day='%s' and
area='%s' and
shop_id='%s'",
$type,$frm_val,$year,$month,$day,$area,$shop_id);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(update_shop_report_loss)";
		exit();

	}

	return true;
	exit();

}

//合計の取得
function get_sum_value_from_shop_report_loss($type,$area,$shop_id,$year,$month){

	$sql = sprintf("
select %s from shop_report_loss where
delete_flg=0 and
area='%s' and
shop_id='%s' and
year='%s' and
month='%s'",
$type,$area,$shop_id,$year,$month);

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_sum_value_from_shop_report_loss)";
		exit();

	}

	$value_all = 0;

	while($row = mysql_fetch_assoc($res)){

		$value = $row[$type];

		$value_all = $value_all + $value;

	}

	return $value_all;
	exit();

}
/*
function get_pre_value_for_update_shop_report_loss(
$type,$area,$shop_id,
$pre_tokyo_refle_loss,$pre_tokyo_refle_loss_fusoku,$pre_tokyo_refle_loss_fuzai,$pre_tokyo_refle_loss_mae,
$pre_tokyo_aroma_loss,$pre_lymph_tokyo_loss,
$pre_sapporo_refle_loss,$pre_yokohama_refle_loss,$pre_sendai_refle_loss,$pre_osaka_refle_loss,$pre_osaka_aroma_loss,$pre_tokyo_reraku_loss,$pre_tokyo_bigao_loss){

	$data = 0;

	if( $area == "tokyo" || $area == "yokohama" || $area == "yokohama2" || $area == "sapporo" || $area == "sendai" || $area == "osaka"){

		//ここにはこないはず
		echo "error!(get_pre_value_for_update_shop_report_loss)" . $area;
		exit();

	}else if( $shop_id == "1" ){

		if( $type == "loss" ){

			$data = $pre_tokyo_refle_loss;

		}else if( $type == "loss_fusoku" ){

			$data = $pre_tokyo_refle_loss_fusoku;

		}else if( $type == "loss_fuzai" ){

			$data = $pre_tokyo_refle_loss_fuzai;

		}else if( $type == "loss_mae" ){

			$data = $pre_tokyo_refle_loss_mae;

		}else{

			echo "error!(get_pre_value_for_update_shop_report_loss) shop_id=1 " . $type;
			exit();

		}

	}else if( $shop_id == "2" ){

		if( $type == "loss" ){

			$data = $pre_tokyo_aroma_loss;

		}else{

			echo "error!(get_pre_value_for_update_shop_report_loss) shop_id=2 ";
			exit();

		}

	}else if( $shop_id == "4" ){

		if( $type == "loss" ){

			$data = $pre_lymph_tokyo_loss;

		}else{

			echo "error!(get_pre_value_for_update_shop_report_loss) shop_id=4 ";
			exit();

		}

	}else if( $shop_id == "6" ){

		if( $type == "loss" ){

			$data = $pre_sapporo_refle_loss;

		}else{

			echo "error!(get_pre_value_for_update_shop_report_loss) shop_id=6 ";
			exit();

		}

	}else if( $shop_id == "7" ){

		if( $type == "loss" ){

			$data = $pre_yokohama_refle_loss;

		}else{

			echo "error!(get_pre_value_for_update_shop_report_loss)  shop_id=7 ";
			exit();

		}

	}else if( $shop_id == "8" ){

		if( $type == "loss" ){

			$data = $pre_sendai_refle_loss;

		}else{

			echo "error!(get_pre_value_for_update_shop_report_loss) shop_id=8 ";
			exit();

		}

	}else if( $shop_id == "10" ){

		if( $type == "loss" ){

			$data = $pre_osaka_refle_loss;

		}else{

			echo "error!(get_pre_value_for_update_shop_report_loss) shop_id=10 ";
			exit();

		}

	}else if( $shop_id == "11" ){

		if( $type == "loss" ){

			$data = $pre_osaka_aroma_loss;

		}else{

			echo "error!(get_pre_value_for_update_shop_report_loss)  shop_id=11 ";
			exit();

		}

	}else if( $shop_id == "12" ){

		if( $type == "loss" ){

			$data = $pre_tokyo_reraku_loss;

		}else{

			echo "error!(get_pre_value_for_update_shop_report_loss) shop_id=12 ";
			exit();

		}

	}else if( $shop_id == "13" ){

		if( $type == "loss" ){

			$data = $pre_tokyo_bigao_loss;

		}else{

			echo "error!(get_pre_value_for_update_shop_report_loss) shop_id=13 ";
			exit();

		}

	}else{

		echo "error!(get_pre_value_for_update_shop_report_loss) shop_id=" . $shop_id;
		exit();

	}

	return $data;
	exit();

}
*/
function PHP_get_pre_value_for_update_shop_report_loss($u_val) {
global $shop_list;

	$data = 0;

	if( $u_val["area"] == "tokyo" || $u_val["area"] == "yokohama" || $u_val["area"] == "yokohama2" || $u_val["area"] == "sapporo" || $u_val["area"] == "sendai" || $u_val["area"] == "osaka"){
		//ここにはこないはず
		echo "error!(get_pre_value_for_update_shop_report_loss)" . $u_val["area"];
		exit();

	}else if($u_val["shop_id"] == "1" ){

		if( $u_val["type"] == "loss" ){
			$data = $u_val["pre_tokyo_refle_loss"];
		}else if( $u_val["type"] == "loss_fusoku" ){
			$data = $u_val["pre_tokyo_refle_loss_fusoku"];
		}else if( $u_val["type"] == "loss_fuzai" ){
			$data = $u_val["pre_tokyo_refle_loss_fuzai"];
		}else if( $u_val["type"] == "loss_mae" ){
			$data = $u_val["pre_tokyo_refle_loss_mae"];
		}else{
			echo "error!(PHP_get_pre_value_for_update_shop_report_loss) shop_id=1 " . $u_val["shop_id"];
			exit();
		}
	} else {
		if($u_val["type"] == "loss") {
			for($n=0; $n<count($shop_list); $n++) {
				$ws_flg = false;
				if($shop_list[$n]["id"] == $u_val["shop_id"]) {
					$ws_cellName = "pre_" . $shop_list[$n].name . "_loss";
					$data = $u_val[$ws_cellName];
					$ws_flg = true;
					break;
				}
			}
			if(!$ws_flg) {
				echo "error!(PHP_get_pre_value_for_update_shop_report_loss) shop_id=" . $u_val["shop_id"];
				exit();
			}
		}else{
			echo "error!(PHP_get_pre_value_for_update_shop_report_loss) shop_id=" . $u_val["shop_id"];
			exit();
		}
	}

	return $data;
}

function update_shop_report_call($shop_id,$frm_val,$year,$month,$day){

	$sql = sprintf("
update shop_report_call set call_num='%s'
where
delete_flg='0' and
year='%s' and
month='%s' and
day='%s' and
shop_id='%s'",
$frm_val,$year,$month,$day,$shop_id);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(update_shop_report_call)";
		exit();

	}

	return true;
	exit();

}

//合計の取得
function get_sum_value_from_shop_report_call($shop_id,$year,$month){

	$sql = sprintf("
select call_num from shop_report_call where
delete_flg=0 and
shop_id='%s' and
year='%s' and
month='%s'",
$shop_id,$year,$month);

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_sum_value_from_shop_report_call)";
		exit();

	}

	$value_all = 0;

	while($row = mysql_fetch_assoc($res)){

		$value = $row["call_num"];

		$value_all = $value_all + $value;

	}

	return $value_all;
	exit();

}

function update_shop_report_target($shop_id,$frm_val,$year,$month,$type){

	if( $type == "" ){
		return false;
		exit();
	}

	if($shop_id < 1) return false;

	$sql = sprintf("select count(*) as nums from shop_report_target where year='%s' and month='%s' and shop_id='%s'",$year,$month,$shop_id);
	$res = mysql_query($sql, DbCon);
	if($res) {
		if($row = mysql_fetch_assoc($res)) {
			if($row["nums"] == 0) {
				$sql = sprintf("insert into shop_report_target(shop_id,year,month,%s) values(%s,%s,%s,%s)", $type, $shop_id,$year,$month,$frm_val);
			} else {
				$sql = sprintf("update shop_report_target set %s='%s' where year='%s' and month='%s' and shop_id='%s'",$type,$frm_val,$year,$month,$shop_id);
			}
			$res = mysql_query($sql, DbCon);
			if($res == false){
				echo "error!(update_shop_report_target_sale_price) " . $sql;
				exit();
			}
			return $res;
		} else {
			return false;
		}
	}

	return true;
}

function get_course_or_discount($shop_id,$type){

	if( $type == "course" ){

$sql = sprintf("
select * from shop_course where
delete_flg=0 and
shop_id='%s'
order by order_num asc",
$shop_id);

	}else if( $type == "discount" ){

$sql = sprintf("
select * from shop_discount where
delete_flg=0 and
shop_id='%s'
order by order_num asc",
$shop_id);

	}else{

		echo "error!(get_course_or_discount)";
		exit();

	}

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_course_or_discount)";
		exit();

	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$list_data[$i++] = $row;

	}

	return $list_data;
	exit();

}

function update_course_and_discount($data_id,$type,$name,$order_num,$discount_value,$course_int,$kihon_price,$discount_course_int,$discount_type){

	if( $type == "course" ){

$sql = sprintf("
update shop_course set name='%s',order_num='%s',course_int='%s',kihon_price='%s'
where
id='%s'",
$name,$order_num,$course_int,$kihon_price,$data_id);

	}else if( $type == "discount" ){

$sql = sprintf("
update shop_discount set name='%s',discount_value='%s',course_int='%s',type='%s'
where
id='%s'",
$name,$discount_value,$discount_course_int,$discount_type,$data_id);

	}else{

		echo "error!(update_course_and_discount)";
		exit();

	}

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(update_course_and_discount)";
		exit();

	}

	return true;
	exit();

}

function insert_course_and_discount($shop_id,$type,$name,$order_num,$discount_value,$course_int,$kihon_price,$discount_course_int,$discount_type){

	if( $type == "course" ){

$sql = sprintf("
insert into shop_course(shop_id,name,order_num,course_int,kihon_price)
values('%s','%s','%s','%s','%s')",
$shop_id,$name,$order_num,$course_int,$kihon_price);

	}else if( $type == "discount" ){

$sql = sprintf("
insert into shop_discount(shop_id,name,discount_value,course_int,type)
values('%s','%s','%s','%s','%s')",
$shop_id,$name,$discount_value,$discount_course_int,$discount_type);

	}else{

		echo "error!(insert_course_and_discount)";
		exit();

	}

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(insert_course_and_discount)";
		exit();

	}

	return true;
	exit();

}

function check_taisyou_day_for_get_work_num_for_shop_report($year,$month,$day){
	/*
	$now_hour = intval(date('H'));

	if($now_hour <= 6){

		//昨日の日付
		$year_now = intval(date('Y', strtotime('-1 day')));
		$month_now = intval(date('m', strtotime('-1 day')));
		$day_now = intval(date('d', strtotime('-1 day')));

	}else{

		$year_now = intval(date('Y'));
		$month_now = intval(date('m'));
		$day_now = intval(date('d'));

	}
	*/
	$ws_date = PHP_get_today_ymd_common($u_limit);		//本日の年月日取得
	$year_now	= $ws_date["year"];
	$month_now	= $ws_date["month"];
	$day_now	= $ws_date["day"];

	$data = get_pre_day_common($year_now,$month_now,$day_now);	//指定日前日の年月日取得
	$year_pre = $data["year"];
	$month_pre = $data["month"];
	$day_pre = $data["day"];

	$ts = get_timestamp_by_year_month_day_common($year,$month,$day);	//指定年月日をタイムスタンプ形式に変換
	$ts_pre = get_timestamp_by_year_month_day_common($year_pre,$month_pre,$day_pre);	//指定年月日をタイムスタンプ形式に変換

	if( $ts_pre < $ts ){
		return false;
		exit();
	}

	return true;
	exit();
}

function delete_course_and_discount($data_id,$type){

	if( $type == "course" ){
		$sql = sprintf("update shop_course set delete_flg='1' where id='%s'",$data_id);
	}else if( $type == "discount" ){
		$sql = sprintf("update shop_discount set delete_flg='1' where id='%s'",$data_id);
	}else{
		echo "error!(delete_course_and_discount)";
		exit();
	}

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(delete_course_and_discount)";
		exit();

	}

	return true;
	exit();
}

function delete_sale_repeater_list($reservation_for_board_id){

		$sql = sprintf("
update reservation_for_board set repeater_delete_flg='1'
where
id='%s'",
$reservation_for_board_id);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(delete_sale_repeater_list)";
		exit();

	}

	return true;
	exit();

}

function get_tantou_therapist_name_by_repeater_info($customer_name,$customer_tel){

	$therapist_name = "不明";

	$therapist_id = get_tantou_therapist_id_by_repeater_info($customer_name,$customer_tel);

	if( $therapist_id != "" ){

		$therapist_name = get_therapist_name_by_therapist_id_honmyou_common($therapist_id);

	}else{

		$therapist_id = get_tantou_therapist_id_tmp_by_repeater_info($customer_name,$customer_tel);

		$therapist_name = get_therapist_name_by_therapist_id_honmyou_common($therapist_id);

		$therapist_name = $therapist_name."(仮)";

	}

	return $therapist_name;
	exit();

}

function get_tantou_therapist_id_by_repeater_info($customer_name,$customer_tel){

	$sql = sprintf("
select therapist_id from repeater where
delete_flg=0 and
customer_name='%s' and
customer_tel='%s'",
$customer_name,$customer_tel);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_tantou_therapist_id_by_repeater_info)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	return $row["therapist_id"];
	exit();

}

function get_tantou_therapist_id_tmp_by_repeater_info($customer_name,$customer_tel){

	$sql = sprintf("
select therapist_id from repeater_tmp where
delete_flg=0 and
customer_name='%s' and
customer_tel='%s'",
$customer_name,$customer_tel);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_tantou_therapist_id_tmp_by_repeater_info)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	return $row["therapist_id"];
	exit();

}

function update_not_board_display_flg($driver_id,$year,$month,$day){

	$sql = sprintf("
update attendance_staff_new set not_board_display_flg='1'
where
staff_id='%s' and year='%s' and month='%s' and day='%s'",
$driver_id,$year,$month,$day);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(update_not_board_display_flg)";
		exit();

	}

	return true;
	exit();

}

function get_kikan_string($year,$month,$day){

	$data = get_kikan_data_for_furikomi_day($year,$month,$day);

	$kako_day = $data["kako_day"];
	$mirai_day = $data["mirai_day"];

	$kikan_string = sprintf("%s年%s月%s日～%s年%s月%s日",
	$kako_day["year"],$kako_day["month"],$kako_day["day"],$mirai_day["year"],$mirai_day["month"],$mirai_day["day"]);

	return $kikan_string;
	exit();

}

function get_kikan_string_frm($year_h,$month_h,$day_h){

	//$year_now = intval(date("Y"));
	//$month_now = intval(date("m"));
	//$day_now = intval(date("d"));
	$data = get_today_year_month_day_common();
	$year_now = $data["year"];
	$month_now = $data["month"];
	$day_now = $data["day"];

	$num = "7";

	$data = array();

	for( $i=0; $i<5; $i++ ){

		$old_num = $i * $num;

		$data[$i] = get_old_day_common($year_now,$month_now,$day_now,$old_num);

	}

	/*
	echo "<pre>";
	print_r($data);
	echo "</pre>";
	exit();
	*/

	$data_num = count($data);

	$html = '<select name="kikan_string">';

	for( $i=0; $i<$data_num; $i++ ){

		$year = $data[$i]["year"];
		$month = $data[$i]["month"];
		$day = $data[$i]["day"];

		if( $year != "2014" ){

			$kikan_string = get_kikan_string($year,$month,$day);

			if( ($year==$year_h) && ($month==$month_h) && ($day==$day_h) ){
				$html .= sprintf('<option value="%s_%s_%s" selected>',$year,$month,$day);
			}else{
				$html .= sprintf('<option value="%s_%s_%s">',$year,$month,$day);
			}

			$html .= $kikan_string;
			$html .= '</option>';

		}

	}

	$html .= '</select>';

	return $html;
	exit();

}

function get_honbu_data_for_sale($year,$month,$day,$area){

	$type = "honbu";

	$sql = sprintf("
select * from staff_new_new
where
delete_flg='0' and
type='%s' and
area='%s'",
$type,$area);

	$res = mysql_query($sql, DbCon);
	if($res == false){

		echo "error!(get_honbu_data_for_sale)";
		exit();

	}

	$i=0;
	$list_data = array();
	while($row = mysql_fetch_assoc($res)){

		$staff_id = $row["id"];

		$pay_hour = $row["pay_hour"];
		$pay_fix = $row["pay_fix"];

		if( !((($pay_hour=="0") || ($pay_hour=="-1")) && ($pay_fix=="0")) ){

			$result = check_staff_attendance_exist_board($staff_id, $year, $month, $day,$area);

			if( $result == true ){

				$list_data[$i] = $row;
				$list_data[$i]["area"] = $area;
				$i++;

			}

		}

	}

	return $list_data;
	exit();

}

function get_sale_honbu_day_select_frm($area,$year,$month,$day_hiki){

	$most_small_day = get_most_small_day_honbu($area,$year,$month);

	$data = array();
	$x=0;

	for( $i=$most_small_day; $i<32; $i++ ){

		$day = $i;

		//データがあるかどうかチェック(ある：true,ない：false)
		$result = check_attendance_staff_new_exist_plus_day_honbu($area,$year,$month,$day);

		if( $result == true ){

			$data[$x] = $day;
			$x++;

		}

	}

	/*
	echo "<pre>";
	print_r($data);
	echo "</pre>";
	exit();
	*/

	$data_num = count($data);

	$html .= '<select name="day" id="sale_driver_day_select">';
	$html .= '<option value="-1">日選択</option>';

	for($i=0;$i<$data_num;$i++){

		$day_tmp = $data[$i];

		if( $day_hiki == $day_tmp ){

			$html .= '<option value="'.$day_tmp.'" selected>'.$day_tmp.'日</option>';

		}else{

			$html .= '<option value="'.$day_tmp.'">'.$day_tmp.'日</option>';

		}

	}

	$html .= '</select>';



	return $html;
	exit();

}

function get_time_select_option_for_sale_office($hour,$minute){

	$time_array = get_time_array_sale_honbu_common();

	$time_array_num = count($time_array);

	$html = "";

	for($i=1;$i<=$time_array_num;$i++){

		$hour_tmp = $time_array[$i]["hour"];
		$minute_tmp = $time_array[$i]["minute"];

		if( $minute_tmp == "0" ){

			$minute_disp = "00";

		}else{

			$minute_disp = $minute_tmp;

		}

		if( ($hour_tmp==$hour) && ($minute_tmp==$minute) ){

			$html .= sprintf('<option value="%s_%s" selected>%s時%s分</option>',$hour_tmp,$minute_tmp,$hour_tmp,$minute_disp);

		}else{

			$html .= sprintf('<option value="%s_%s">%s時%s分</option>',$hour_tmp,$minute_tmp,$hour_tmp,$minute_disp);

		}

	}

	return $html;
	exit();

}

function get_chief_allowance_select($chief_allowance,$area){

	$menu = array(
		0 => array("value"=>"1000","word"=>"1,000円/日")
	);

	$menu_num = count($menu);

	$option = "";

	for( $i=0; $i<$menu_num; $i++ ){

		$value = $menu[$i]["value"];
		$word = $menu[$i]["word"];

		if( $chief_allowance == $value ){

			$option .= sprintf('<option value="%s" selected>%s</option>',$value,$word);

		}else{

			$option .= sprintf('<option value="%s">%s</option>',$value,$word);

		}
	}

	$html =<<<EOT
<select name="chief_allowance">
<option value="-1">なし</option>
{$option}
</select>
EOT;

	return $html;
	exit();

}

function get_chief_allowance_disp($chief_allowance){

	if(!$chief_allowance) $chief_allowance = 0;		//insert by aida at 20180405

	$data = "";

	if( $chief_allowance == "1000" ){

		$data = "1,000円/日";

	}else if( $chief_allowance == "-1" ){

		$data = "なし";

	}else if( $chief_allowance == "0" ){

		$data = "なし";

	}else{

		echo "error!(get_chief_allowance_disp)";
		exit();

	}

	return $data;
	exit();
}

function get_call_num_from_shop_report_target($shop_id,$year,$month){

	$sql = sprintf("
select call_num from shop_report_target where
delete_flg=0 and
shop_id='%s' and
year='%s' and
month='%s'",
$shop_id,$year,$month);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_call_num_from_shop_report_target)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	$call_num = $row["call_num"];

	if( $call_num == "" ){

		$call_num = 0;

	}

	return $call_num;
	exit();

}

function get_call_num_day_2($shop_id,$year,$month,$day){

	$operation_num = get_operation_num_day($shop_id,$year,$month,$day);

	//機会ロス
	$type = "shop_id";
	$area = "-1";
	$loss_data = get_shop_report_loss_data_day_for_shop_report($shop_id,$area,$year,$month,$day,$type);
	$loss = $loss_data["loss"];

	//受電数の取得
	$call_num = $operation_num + $loss;

	return $call_num;
	exit();

}

function get_operation_num_day($shop_id,$year,$month,$day){

	$shop_name = get_shop_name_by_shop_id($shop_id);

	$operation_num = get_reservation_for_board_num_by_shop_name_common($year,$month,$day,$shop_name);

	return $operation_num;
	exit();

}

function get_operation_num_average($shop_id,$year,$month){

	$operation_num_average = 0;

	$shop_name = get_shop_name_by_shop_id($shop_id);

	$board_num = get_reservation_for_board_num_month_by_shop_name_common($year,$month,$shop_name);

	$work_num = get_work_num_for_shop_report($year,$month);

	$operation_num_average = kirisute($board_num,$work_num);

	return $operation_num_average;
	exit();

}

function get_call_num_month($shop_id,$year,$month){

	$sum_value = 0;

	$shop_name = get_shop_name_by_shop_id($shop_id);

	$board_num = get_reservation_for_board_num_month_by_shop_name_common($year,$month,$shop_name);

	$loss_num = get_loss_num_month($shop_id,$year,$month);

	$sum_value = $board_num + $loss_num;

	return $sum_value;
	exit();

}

function get_call_num_average($shop_id,$year,$month){

	$call_num_average = 0;

	$sum_value = get_call_num_month($shop_id,$year,$month);

	//稼働日数を取得
	$work_num = get_work_num_for_shop_report($year,$month);

	//1日平均値
	$call_num_average = kirisute($sum_value,$work_num);

	return $call_num_average;
	exit();

}

function get_loss_num_month($shop_id,$year,$month){

$sql = sprintf("
select loss from shop_report_loss where
delete_flg=0 and
shop_id='%s' and
year='%s' and
month='%s'",
$shop_id,$year,$month);

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_loss_num_month)";
		exit();

	}

	$loss_num = 0;

	while($row = mysql_fetch_assoc($res)){

		$loss = $row["loss"];

		$loss_num = $loss_num + $loss;

	}

	return $loss_num;
	exit();

}

function add_message_board($help_title,$help_content,$area){

	$now = time();

	$sql = sprintf("
insert into message_board(created,updated,title,content,area) values('%s','%s','%s','%s','%s')",
$now,$now,$help_title,$help_content,$area);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリー実行で失敗しました(add_message_board)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	return true;
	exit();

}

function add_message_board_driver($help_title,$help_content,$area){

	$now = time();

	$sql = sprintf("
			insert into message_board_driver(created,updated,title,content,area) values('%s','%s','%s','%s','%s')",
			$now,$now,$help_title,$help_content,$area);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリー実行で失敗しました(add_message_board_driver)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	return true;
	exit();

}

function update_message_board($help_id,$help_title,$help_content,$area){

	$now = time();

	$sql = sprintf("
update message_board set
title='%s',
content='%s',
updated='%s',
area='%s'
where id='%s'",
$help_title,$help_content,$now,$area,$help_id);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリー実行で失敗しました(update_message_board)";
		exit();

	}

	return true;
	exit();

}

function update_message_board_driver($help_id,$help_title,$help_content,$area){

	$now = time();

	$sql = sprintf("
update message_board_driver set
title='%s',
content='%s',
updated='%s',
area='%s'
where id='%s'",
$help_title,$help_content,$now,$area,$help_id);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリー実行で失敗しました(update_message_board_driver)";
		exit();

	}

	return true;
	exit();

}

function delete_message_board($help_id){

	$sql = sprintf("update message_board set delete_flg='1' where id='%s'",$help_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(delete_message_board)";
		exit();
	}

	return true;
	exit();
}

function delete_message_board_driver($help_id){

	$sql = sprintf("update message_board_driver set delete_flg='1' where id='%s'",$help_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(delete_message_board_driver)";
		exit();
	}

	return true;
	exit();
}

function get_therapist_data_for_sale_therapist($year,$month,$day,$area){

	// 出勤しているセラピスト情報を取得するためのSQL文

	$sql = sprintf("
select *,attendance_new.id as attendance_id from attendance_new
left join therapist_new on attendance_new.therapist_id=therapist_new.id
where
therapist_new.delete_flg=0 and
therapist_new.test_flg=0 and
year='%s' and
month='%s' and
day='%s' and
attendance_new.today_absence='0' and
attendance_new.kekkin_flg='0' and
attendance_new.area='%s'
order by therapist_new.rank_order_num asc,therapist_new.order_num desc",
$year,$month,$day,$area);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_therapist_data_for_sale_therapist:1)";
		exit();
	}

	$data = array();

	$i=0;
	while($row = mysql_fetch_assoc($res)){

		$therapist_id = $row["therapist_id"];

		//therapist_id重複チェック
		$result = check_duplication_therapist_id_in_attendance_new($data,$therapist_id);

		if( $result == false ){

			$data[$i] = $row;

			$attendance_id = $data[$i]["attendance_id"];

			$data[$i]["area"] = $area;

			$sql = sprintf("select time from reservation_new where attendance_id='%s'",$attendance_id);

			$res2 = mysql_query($sql, DbCon);
			if($res == false){
				echo "error!(get_therapist_data_for_sale_therapist:2)";
				exit();
			}

			$j=0;
			while($row2 = mysql_fetch_assoc($res2)){
				$data[$i]["time"][$j] = $row2["time"];
				$time_num = count($data[$i]["time"]);
				$data[$i]["time_num"] = $time_num;
				$j++;
			}
			if($j==0){
				$data[$i]["time_num"]=0;
			}

			$i++;

		}


	}

	return $data;
	exit();

}

function get_operation_num_month($year,$month,$area){

	$sql = sprintf("
select id from reservation_for_board where
year='%s' and
month='%s' and
shop_area='%s' and
complete_flg='1' and
delete_flg='0'",
$year,$month,$area);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(get_operation_num_month)";
		exit();

	}

	$num = mysql_num_rows($res);

	return $num;
	exit();

}

function get_driver_data_shayousha($year,$month,$day){

	$type = "driver";

	$sql = sprintf("select * from staff_new_new where delete_flg='0' and shayousha_flg='1' and type='%s'",$type);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_driver_data_shayousha)";
		exit();
	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$staff_id = $row["id"];

		$result = check_staff_attendance_exist_shayousha($staff_id, $year, $month, $day);

		if( $result == true ){

			$list_data[$i] = $row;
			$i++;

		}

	}

	return $list_data;
	exit();
}

//出席データが登録済みであるかどうか(登録済み：true,未登録:false)
function check_staff_attendance_exist_shayousha($staff_id,$year,$month,$day){

$sql = sprintf("
select id from attendance_staff_new where
staff_id='%s' and
year='%s' and
month='%s' and
day='%s' and
today_absence=0 and
attendance_adjustment=0",
$staff_id,$year,$month,$day);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(check_staff_attendance_exist_shayousha)";
		exit();

	}

	$num = mysql_num_rows($res);

	if( $num > 0 ){

		return true;
		exit();

	}else{

		return false;
		exit();

	}

}

function get_driver_sonota_day($year,$month,$day,$shop_area){

$sql = sprintf("
select * from attendance_staff_new where
area='%s' and
year='%s' and
month='%s' and
day='%s' and
today_absence=0 and
attendance_adjustment=0",
$shop_area,$year,$month,$day);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(get_driver_sonota_day)";
		exit();

	}

	$sonota_all = 0;

	while($row = mysql_fetch_assoc($res)){

		$repair = $row["repair"];
		$insurance = $row["insurance"];
		$sonota = $row["sonota"];

		$sonota_all = $sonota_all + ( $repair + $insurance + $sonota );

	}

	return $sonota_all;
	exit();

}

function get_driver_payment_for_sale_shop_2($year,$month,$day,$area){

	$driver_data = get_driver_data_for_sale_shop($year,$month,$day,$area);

	/*
	echo "<pre>";
	print_r($driver_data);
	echo "</pre>";
	exit();
	*/

	$driver_data_num = count($driver_data);

	$remuneration_all = 0;
	$gasoline_value_disp_all = 0;
	$allowance_all = 0;

	$car_distance_over_allowance_all = 0;

	for($i=0;$i<$driver_data_num;$i++){

		$driver_id = $driver_data[$i]["id"];
		$pay_hour = $driver_data[$i]["pay_hour"];
		$pay_fix = $driver_data[$i]["pay_fix"];
		$fuel = $driver_data[$i]["fuel"];

		$staff_type = $driver_data[$i]["type"];

		if( $pay_hour == "-1" ){

			$pay_hour = 0;

		}

		$data = get_staff_attendance_data_by_time($driver_id,$year,$month,$day);

		$start_time = $data["start_time"];
		$end_time = $data["end_time"];

		$car_distance = $data["car_distance"];
		$allowance = $data["allowance"];

		$start_hour = $data["start_hour"];
		$start_minute = $data["start_minute"];
		$end_hour = $data["end_hour"];
		$end_minute = $data["end_minute"];

		$driver_area = get_staff_area_by_id_common($driver_id);
		$gasoline_value = get_gasoline_value_from_settings_2_common($driver_area,$year,$month,$day);

		if( ($fuel != "0") && ($fuel != "-1") ){

			$gasoline_value_disp = intval(($car_distance*$gasoline_value)/$fuel);

		}else{

			$gasoline_value_disp = 0;

		}

		if( ( $start_hour == "-1" ) || ( $start_minute == "-1" ) || ( $end_hour == "-1" ) || ( $end_minute == "-1" ) ){

			$work_time = get_work_time($start_time,$end_time);

		}else{

			$work_time = get_work_time_driver_common($start_hour,$start_minute,$end_hour,$end_minute);

		}

		$remuneration = get_remuneration_driver_common($pay_hour,$pay_fix,$work_time);

		$remuneration_all = $remuneration_all + $remuneration;
		$gasoline_value_disp_all = $gasoline_value_disp_all + $gasoline_value_disp;

		$allowance_all = $allowance_all + $allowance;

		//走行距離/時間,超過距離/時間,超過距離/日,超過手当
		$data = get_car_distance_allowance_data_common($car_distance,$work_time,$staff_type,$year,$month,$day);
		$car_distance_over_allowance = $data["car_distance_over_allowance"];

		$car_distance_over_allowance_all = $car_distance_over_allowance_all + $car_distance_over_allowance;

	}

	$result = check_last_day_for_remuneration_common($year,$month,$day);

	if( $result == false ){

		$remuneration_all = 0;

	}

	$cost_data = get_cost_data_day_from_attendance_staff_new($year,$month,$day,$area);

	$gasoline = $cost_data["gasoline"];
	$highway = $cost_data["highway"];
	$parking = $cost_data["parking"];
	$pay_finish = $cost_data["pay_finish"];

	$gasoline_value_disp_all = $gasoline_value_disp_all + $gasoline;
	$highway_all = $highway;
	$parking_all = $parking;
	$pay_finish_all = $pay_finish;

	//超過手当をガソリン代に含ませる
	$gasoline_value_disp_all = $gasoline_value_disp_all + $car_distance_over_allowance_all;

	$data["remuneration"] = $remuneration_all;
	$data["gasoline"] = $gasoline_value_disp_all;
	$data["parking"] = $parking_all;
	$data["allowance"] = $allowance_all;
	$data["highway"] = $highway_all;
	$data["pay_finish"] = $pay_finish_all;

	return $data;
	exit();

}

function get_cost_data_day_from_attendance_staff_new($year,$month,$day,$area){

$sql = sprintf("
select * from attendance_staff_new where
area='%s' and
year='%s' and
month='%s' and
day='%s' and
today_absence=0 and
attendance_adjustment=0",
$area,$year,$month,$day);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(get_cost_day_from_attendance_staff_new)";
		exit();

	}

	$gasoline_all = 0;
	$highway_all = 0;
	$parking_all = 0;
	$pay_finish_all = 0;

	while($row = mysql_fetch_assoc($res)){

		$gasoline = $row["gasoline"];
		$highway = $row["highway"];
		$parking = $row["parking"];
		$pay_finish = $row["pay_finish"];

		$gasoline_all = $gasoline_all + $gasoline;
		$highway_all = $highway_all + $highway;
		$parking_all = $parking_all + $parking;
		$pay_finish_all = $pay_finish_all + $pay_finish;

	}

	$data["gasoline"] = $gasoline_all;
	$data["highway"] = $highway_all;
	$data["parking"] = $parking_all;
	$data["pay_finish"] = $pay_finish_all;

	return $data;
	exit();

}

//日払い報酬取得
function get_pay_day_therapist($year,$month,$day,$shop_name,$shop_area){

	$pay_day_all = 0;

	if( ($shop_area == "tokyo") && ($shop_name != "東京リフレ") ){

		return $pay_day_all;
		exit();

	}

	$sql = sprintf("
select pay_day from attendance_new where
today_absence='0' and
kekkin_flg='0' and
syounin_state='1' and
area='%s' and
year='%s' and
month='%s' and
day='%s'",
$shop_area,$year,$month,$day);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(get_pay_day_therapist)";
		exit();

	}

	while($row = mysql_fetch_assoc($res)){

		$pay_day = $row["pay_day"];

		$pay_day_all = $pay_day_all + $pay_day;

	}

	return $pay_day_all;
	exit();

}

function get_allowance_jisou_therapist_day($year,$month,$day,$shop_name,$shop_area){

	$allowance = 0;

	if( ($shop_area == "tokyo") && ($shop_name != "東京リフレ") ){

		return $allowance;
		exit();

	}

	$sql = sprintf("
select transportation,attendance_id from reservation_for_board
where
delete_flg=0 and
year='%s' and
month='%s' and
day='%s' and
shop_area='%s'",
$year,$month,$day,$shop_area);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_allowance_jisou_therapist_day)";
		exit();

	}

	while($row = mysql_fetch_assoc($res)){

		$attendance_id = $row["attendance_id"];
		$transportation = $row["transportation"];

		$therapist_id = get_therapist_id_by_attendance_id_common($attendance_id);
		$therapist_data = get_therapist_data_by_id_common($therapist_id);
		$jisou_flg = $therapist_data["jisou_flg"];

		if( $jisou_flg == "1" ){

			if( $transportation == "0" ){

				$allowance = $allowance + 500;

			}else{

				$allowance = $allowance + $transportation;

			}

		}

	}

	return $allowance;
	exit();

}

function get_allowance_therapist_day($year,$month,$day,$shop_name,$shop_area){

	$allowance_all = 0;

	if( ($shop_area == "tokyo") && ($shop_name != "東京リフレ") ){

		return $allowance_all;
		exit();

	}

	$sql = sprintf("
select allowance from attendance_new where
today_absence='0' and
kekkin_flg='0' and
syounin_state='1' and
area='%s' and
year='%s' and
month='%s' and
day='%s'",
$shop_area,$year,$month,$day);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(get_allowance_therapist_day)";
		exit();

	}

	while($row = mysql_fetch_assoc($res)){

		$allowance = $row["allowance"];

		$allowance_all = $allowance_all + $allowance;

	}

	return $allowance_all;
	exit();

}

function get_pay_day_driver($year,$month,$day,$shop_name,$shop_area){

	$pay_day_all = 0;

	if( ($shop_area == "tokyo") && ($shop_name != "東京リフレ") ){

		return $pay_day_all;
		exit();

	}

	$sql = sprintf("
select pay_day from attendance_staff_new where
area='%s' and
year='%s' and
month='%s' and
day='%s' and
type='driver' and
today_absence=0 and
attendance_adjustment=0",
$shop_area,$year,$month,$day);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(get_pay_day_driver)";
		exit();

	}

	while($row = mysql_fetch_assoc($res)){

		$pay_day = $row["pay_day"];

		$pay_day_all = $pay_day_all + $pay_day;

	}

	return $pay_day_all;
	exit();

}

function insert_settings_gasoline($gasoline_value,$area,$year_start,$month_start,$day_start,$year_end,$month_end,$day_end){

	$timestamp_start = get_timestamp_by_year_month_day_2_common($year_start,$month_start,$day_start);
	$timestamp_end = get_timestamp_by_year_month_day_3_common($year_end,$month_end,$day_end);

	$sql = sprintf("insert into settings_gasoline(value,area,period_start,period_end) values('%s','%s','%s','%s')",$gasoline_value,$area,$timestamp_start,$timestamp_end);
	$res = mysql_query($sql, DbCon);
	if($res === false){
		echo "error!(insert_settings_gasoline)";
		exit();
	}

	return true;
	exit();
}

//期間が、かぶっていないか、チェック
function check_period_for_sale_gasoline($year_start,$month_start,$day_start,$year_end,$month_end,$day_end,$area){

	$timestamp_start = get_timestamp_by_year_month_day_2_common($year_start,$month_start,$day_start);
	$timestamp_end = get_timestamp_by_year_month_day_3_common($year_end,$month_end,$day_end);

	$sql = sprintf("
select id from settings_gasoline where
( ((period_start>='%s') and (period_start<='%s')) or ((period_end>='%s') and (period_end<='%s')) ) and
area='%s' and
delete_flg=0",
$timestamp_start,$timestamp_end,$timestamp_start,$timestamp_end,$area);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(check_period_for_sale_gasoline)";
		exit();

	}

	$num = mysql_num_rows($res);

	if( $num > 0 ){

		return true;
		exit();

	}else{

		return false;
		exit();

	}

}

//期間が、かぶっていないか、チェック
function check_period_for_sale_gasoline_2($year_start,$month_start,$day_start,$year_end,$month_end,$day_end,$area,$id){

	$timestamp_start = get_timestamp_by_year_month_day_2_common($year_start,$month_start,$day_start);
	$timestamp_end = get_timestamp_by_year_month_day_3_common($year_end,$month_end,$day_end);

	$sql = sprintf("
select id from settings_gasoline where
( ((period_start>='%s') and (period_start<='%s')) or ((period_end>='%s') and (period_end<='%s')) ) and
area='%s' and
id<>'%s' and
delete_flg=0",
$timestamp_start,$timestamp_end,$timestamp_start,$timestamp_end,$area,$id);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(check_period_for_sale_gasoline_2)";
		exit();

	}

	$num = mysql_num_rows($res);

	if( $num > 0 ){

		return true;
		exit();

	}else{

		return false;
		exit();

	}

}

function get_settings_gasoline_data($area){

	$sql = sprintf("select * from settings_gasoline where delete_flg='0' and area='%s' order by period_start desc",$area);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_settings_gasoline_data)";
		exit();
	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$period_start = $row["period_start"];
		$period_end = $row["period_end"];

		$time_data = get_year_month_day_from_timestamp_common($period_start);

		$year_start = $time_data["year"];
		$month_start = $time_data["month"];
		$day_start = $time_data["day"];

		$time_data = get_year_month_day_from_timestamp_common($period_end);

		$year_end = $time_data["year"];
		$month_end = $time_data["month"];
		$day_end = $time_data["day"];

		$list_data[$i] = $row;

		$list_data[$i]["year_start"] = $year_start;
		$list_data[$i]["month_start"] = $month_start;
		$list_data[$i]["day_start"] = $day_start;
		$list_data[$i]["year_end"] = $year_end;
		$list_data[$i]["month_end"] = $month_end;
		$list_data[$i]["day_end"] = $day_end;

		$i++;

	}

	return $list_data;
	exit();

}

function delete_settings_gasoline($id){

	$sql = sprintf("update settings_gasoline set delete_flg='1' where id='%s'",$id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(delete_settings_gasoline)";
		exit();
	}

	return true;
	exit();
}

function delete_settings_gasoline_control($id){

	$sql = sprintf("update settings_gasoline_control set delete_flg='1' where id='%s'",$id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(delete_settings_gasoline_control)";
		exit();
	}

	return true;
	exit();
}

function delete_unit_price_setting($id){

	$sql = sprintf("update unit_price_setting set delete_flg='1' where id='%s'",$id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(delete_settings_gasoline_control)";
		exit();
	}

	return true;
	exit();
}

function update_settings_gasoline($gasoline_value,$year_start,$month_start,$day_start,$year_end,$month_end,$day_end,$id){

	$timestamp_start = get_timestamp_by_year_month_day_2_common($year_start,$month_start,$day_start);
	$timestamp_end = get_timestamp_by_year_month_day_3_common($year_end,$month_end,$day_end);

	$sql = sprintf("update settings_gasoline set value='%s',period_start='%s',period_end='%s' where id='%s'",$gasoline_value,$timestamp_start,$timestamp_end,$id);
	$res = mysql_query($sql, DbCon);
	if($res === false){
		echo "error!(update_settings_gasoline)";
		exit();
	}

	return true;
	exit();
}

function update_reservation_data_2(
$reservation_id,$start_hour,$start_minute,$end_hour,$end_minute,$attendance_id,
$start_hour_old,$start_minute_old,$end_hour_old,$end_minute_old,$shop_area,$place_name,$therapist_id,
$year,$month,$day,$card_flg,$card_confirm_flg,$course,$complete_flg,$start_flg,$extension,
$shop_name,$course_old,$course_new,$extension_old,$extension_new,$course_change_flg,$extension_change_flg,$course_var,
$card_state_extension){

	$attendance_start_time = get_attendance_start_time($attendance_id,$shop_area);

	$yoyaku_start_time = start_hour_and_minute_to_time($start_hour,$start_minute);

	if( $attendance_start_time > $yoyaku_start_time ){

		//出勤開始時間よりも前です、のエラー表示は不要
		//return false;
		//exit();

	}

	$start_real_time_flg = false;
	$mail_flg = false;
	$mail_type = "";
	$customer_name = "";
	$check_url = "";
	$reservation_for_board_id = $reservation_id;
	$area_name = $place_name;

	$result = update_reservation_data_transaction_common(
$start_hour,$start_minute,$end_hour,$end_minute,$reservation_for_board_id,$therapist_id,$attendance_id,
$shop_area,$area_name,$course,$extension,$card_flg,$card_confirm_flg,$complete_flg,$start_flg,
$start_real_time_flg,$mail_flg,$mail_type,$customer_name,$check_url,
$shop_name,$course_old,$course_new,$extension_old,$extension_new,$course_change_flg,$extension_change_flg,
$course_var);

	if( $result == true ){

		//延長時支払い方法の登録
		update_card_state_extension_by_reservation_for_board_id($reservation_for_board_id,$card_state_extension);

	}

	return true;
	exit();

}

function update_card_state_extension_by_reservation_for_board_id($reservation_for_board_id,$card_state_extension){

	$sql = sprintf("update reservation_for_board set card_state_extension='%s' where id='%s'",$card_state_extension,$reservation_for_board_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(update_card_state_extension_by_reservation_for_board_id)";
		exit();
	}

	return true;
	exit();
}

function get_sale_price_by_shop_name_2($year,$month,$day,$shop_name,$card_flg){

	$sql = sprintf("
select
sale_history.price,
reservation_for_board.extension,
reservation_for_board.card_state_extension
from reservation_for_board
left join sale_history on sale_history.reservation_no=reservation_for_board.reservation_no
where
reservation_for_board.shop_name='%s' and
reservation_for_board.card_flg='%s' and
reservation_for_board.year='%s' and
reservation_for_board.month='%s' and
reservation_for_board.day='%s' and
reservation_for_board.delete_flg=0 and
sale_history.delete_flg=0 and
sale_history.eigyou_year='%s' and
sale_history.eigyou_month='%s' and
sale_history.eigyou_day='%s'",
$shop_name,$card_flg,$year,$month,$day,$year,$month,$day);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_sale_price_by_shop_name_2)";
		exit();

	}

	$total = 0;

	while($row = mysql_fetch_assoc($res)){

		$price = $row["price"];
		$extension = $row["extension"];
		$card_state_extension = $row["card_state_extension"];

		$extension_price = 0;

		if( $extension != "0" ){

			$extension_price = get_extension_price_common($extension,$shop_name);

			if( $card_flg == "0" ){

				//延長支払い、カードの場合
				if( $card_state_extension == "1" ){

					$price = $price - $extension_price;

				}

			}else if( $card_flg == "1" ){

				//延長支払い、現金の場合
				if( $card_state_extension == "0" ){

					$price = $price - $extension_price;

				}

			}

		}

		$total = $total + $price;

	}

	if( $card_flg == "0" ){

		$card_flg_2 = "1";

	}else{

		$card_flg_2 = "0";

	}

	$extension_price = get_extension_price_for_shop_name($year,$month,$day,$shop_name,$card_flg_2);

	$total = $total + $extension_price;

	return $total;
	exit();

}

function get_extension_price_for_shop_name($year,$month,$day,$shop_name,$card_flg){

	$sql = sprintf("
select
extension,
card_state_extension
from reservation_for_board
where
shop_name='%s' and
card_flg='%s' and
year='%s' and
month='%s' and
day='%s' and
delete_flg=0",
$shop_name,$card_flg,$year,$month,$day);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_extension_price_for_shop_name)";
		exit();

	}

	$extension_price_all = 0;

	while($row = mysql_fetch_assoc($res)){

		$extension = $row["extension"];
		$card_state_extension = $row["card_state_extension"];

		$extension_price = 0;

		if( $extension != "0" ){

			$extension_price = get_extension_price_common($extension,$shop_name);

			if( $card_flg == "0" ){

				//延長支払い、カードの場合
				if( $card_state_extension == "1" ){

					$extension_price_all = $extension_price_all + $extension_price;

				}

			}else if( $card_flg == "1" ){

				//延長支払い、現金の場合
				if( $card_state_extension == "0" ){

					$extension_price_all = $extension_price_all + $extension_price;

				}

			}

		}

	}

	return $extension_price_all;
	exit();

}

function therapist_leave_action($therapist_id){

	$sql = sprintf("update therapist_new set leave_flg=1 where id='%s'",$therapist_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(therapist_leave_action)";
		exit();
	}

	return true;
	exit();
}

function delete_attendance_new_future_by_therapist_id($therapist_id){

	$year = intval(date('Y'));
	$month = intval(date('m'));
	$day = intval(date('d'));

	$sql = sprintf("
delete from attendance_new
where
therapist_id='%s' and
(
(year>'%s') or
((year='%s') and (month>'%s')) or
((year='%s') and (month='%s') and (day>='%s'))
)",
$therapist_id,$year,$year,$month,$year,$month,$day);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(delete_attendance_new_future_by_therapist_id)";
		exit();

	}

	return true;
	exit();

}

function get_customer_num($shop_id,$search){

	$where_search = "";

	if( $search != "" ){

		$search = "%".$search."%";

		$where_search_1 = sprintf("(customer.name like '%s')",$search);

		$where_search_2 = sprintf("(customer.tel like '%s')",$search);

		$where_search = sprintf("(%s or %s)",$where_search_1,$where_search_2);

	}

	$where_sql = "";

	if( $shop_id == "" ){

		$where_sql = "customer.delete_flag=0";

	}else{

		$where_sql = sprintf("customer.delete_flag=0 and shop.id='%s'",$shop_id);

	}

	if( $where_search != "" ){

		$where_sql .= " and ".$where_search;

	}

	$sql = sprintf("
select customer.id from customer
left join shop on customer.shop_id=shop.id
where %s",
$where_sql);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリ実行に失敗しました(get_customer_num)";
		exit();

	}

	$num = mysql_num_rows($res);

	return $num;
	exit();

}

function get_customer_data($shop_id,$paging_selected_num,$search){

	$disp_num = 100;

	$limit_start_num = ($paging_selected_num-1)*$disp_num;

	$where_search = "";

	if( $search != "" ){

		$search = "%".$search."%";

		$where_search_1 = sprintf("(customer.name like '%s')",$search);

		$where_search_2 = sprintf("(customer.tel like '%s')",$search);

		$where_search = sprintf("(%s or %s)",$where_search_1,$where_search_2);

	}

	if( $shop_id == "" ){

		$where_sql = "customer.delete_flag=0";

	}else{

		$where_sql = sprintf("customer.delete_flag=0 and shop.id='%s'",$shop_id);

	}

	if( $where_search != "" ){

		$where_sql .= " and ".$where_search;

	}

$sql = sprintf("
select
customer.shop_id,
customer.id as customer_id,
customer.name as customer_name,
customer.name_kana as customer_name_kana,
customer.mail as customer_mail,
customer.tel,
customer.tel_2,
customer.tel_3,
customer.tel_4,
customer.tel_5,
customer.tel_6,
customer.tel_7,
customer.tel_8,
customer.tel_9,
customer.tel_10,
customer.password,
customer.type,
shop.name as shop_name
from customer
left join shop on customer.shop_id=shop.id
where %s
limit %s,%s",$where_sql,$limit_start_num,$disp_num);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリ実行に失敗しました(get_customer_data)";
		exit();

	}

	$data = array();

	$i=0;

	while($row = mysql_fetch_assoc($res)){

		$tel_data = array();

		$tel_data["0"] = $row["tel"];
		$tel_data["1"] = $row["tel_2"];
		$tel_data["2"] = $row["tel_3"];
		$tel_data["3"] = $row["tel_4"];
		$tel_data["4"] = $row["tel_5"];
		$tel_data["5"] = $row["tel_6"];
		$tel_data["6"] = $row["tel_7"];
		$tel_data["7"] = $row["tel_8"];
		$tel_data["8"] = $row["tel_9"];
		$tel_data["9"] = $row["tel_10"];

		$tel_data = get_tel_data_not_null($tel_data);

		$data[$i] = $row;
		$data[$i]["tel_data"] = $tel_data;

		$i++;

	}

	return $data;
	exit();

}

function get_tel_data_not_null($tel_data){

	$tel_data_num = count($tel_data);

	$data = array();
	$x = 0;

	for( $i=0; $i<$tel_data_num; $i++ ){

		$tel_tmp = $tel_data[$i];

		if( $tel_tmp != "" ){

			$data[$x++] = $tel_tmp;

		}

	}

	return $data;
	exit();

}

function get_customer_data_one($customer_id){

	$sql = sprintf("select * from customer where id='%s'",$customer_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_customer_data_one)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();
}

function check_tel_duplicate_for_customer_edit($tel,$customer_id,$shop_id){

	$tel = str_replace("-","",$tel);

	//電話番号重複チェック
	$sql = sprintf("
select tel from customer where
delete_flag=0 and
id<>'%s' and
shop_id='%s' and
(tel='%s' or
tel_2='%s' or
tel_3='%s' or
tel_4='%s' or
tel_5='%s' or
tel_6='%s' or
tel_7='%s' or
tel_8='%s' or
tel_9='%s' or
tel_10='%s')",
$customer_id,$shop_id,$tel,$tel,$tel,$tel,$tel,$tel,$tel,$tel,$tel,$tel);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリ実行に失敗しました(check_tel_duplicate_for_customer_edit)";
		exit();

	}

	$num = mysql_num_rows($res);

	if( $num > 0 ){

		return false;
		exit();

	}else{

		return true;
		exit();

	}

}

function check_tel_keishiki($tel){

	if (preg_match("/^[0-9]{2,4}[-]*[0-9]{2,4}[-]*[0-9]{3,4}$/", $tel)) {

		return true;
		exit();

	}else{

		return false;
		exit();

	}

}

function check_mail_keishiki($mail){

	if(preg_match("/^([a-zA-Z0-9])+([a-zA-Z0-9\._-])*@([a-zA-Z0-9_-])+([a-zA-Z0-9\._-]+)+$/", $mail)){

		return true;
		exit();

	}else{

		return false;
		exit();

	}

}

function check_mail_duplicate_for_customer_edit($mail,$customer_id,$shop_id){

	//メールアドレス重複チェック
	$sql = sprintf("
select id from customer where
delete_flag=0 and
id<>'%s' and
shop_id='%s' and
mail='%s'",
$customer_id,$shop_id,$mail);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリ実行に失敗しました(check_mail_duplicate_for_customer_edit)";
		exit();

	}

	$num = mysql_num_rows($res);

	if( $num > 0 ){

		return false;
		exit();

	}else{

		return true;
		exit();

	}

}

function update_customer_data_one($shop_id,$onamae,$mail,$tel,$customer_id,$name_kana,$tel_2,$tel_3,$tel_4,$tel_5,$tel_6,$tel_7,$tel_8,$tel_9,$tel_10,$type){

	//電話番号はハイフンを外してDBに格納する
	$tel = str_replace("-","",$tel);
	$tel_2 = str_replace("-","",$tel_2);
	$tel_3 = str_replace("-","",$tel_3);
	$tel_4 = str_replace("-","",$tel_4);
	$tel_5 = str_replace("-","",$tel_5);
	$tel_6 = str_replace("-","",$tel_6);
	$tel_7 = str_replace("-","",$tel_7);
	$tel_8 = str_replace("-","",$tel_8);
	$tel_9 = str_replace("-","",$tel_9);
	$tel_10 = str_replace("-","",$tel_10);

	// 会員情報を更新するSQL文
	$sql = sprintf("
update customer set
shop_id='%s',
name='%s',
mail='%s',
tel='%s',
tel_2='%s',
tel_3='%s',
tel_4='%s',
tel_5='%s',
tel_6='%s',
tel_7='%s',
tel_8='%s',
tel_9='%s',
tel_10='%s',
type='%s',
name_kana='%s'
where id='%s'",
$shop_id,$onamae,$mail,$tel,$tel_2,$tel_3,$tel_4,$tel_5,$tel_6,$tel_7,$tel_8,$tel_9,$tel_10,$type,$name_kana,$customer_id);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリ実行に失敗しました(update_customer_data_one)";
		exit();

	}else{

		//include("include/csv_update.php");

	}

	return true;
	exit();

}

function check_tel_duplicate_all_for_customer_edit($tel,$tel_data){

	$data["0"] = str_replace("-","",$tel_data["0"]);
	$data["1"] = str_replace("-","",$tel_data["1"]);
	$data["2"] = str_replace("-","",$tel_data["2"]);
	$data["3"] = str_replace("-","",$tel_data["3"]);
	$data["4"] = str_replace("-","",$tel_data["4"]);
	$data["5"] = str_replace("-","",$tel_data["5"]);
	$data["6"] = str_replace("-","",$tel_data["6"]);
	$data["7"] = str_replace("-","",$tel_data["7"]);
	$data["8"] = str_replace("-","",$tel_data["8"]);
	$data["9"] = str_replace("-","",$tel);

	$data_num = count($data);

	$match_flg = false;

	for( $i=0; $i<$data_num; $i++ ){

		$tel_tmp = $data[$i];

		for( $x=0; $x<$data_num; $x++ ){

			if( $i != $x ){

				$tel_tmp_2 = $data[$x];

				if( ($tel_tmp == $tel_tmp_2) && ($tel_tmp_2 != "") ){

					$match_flg = true;

				}

			}

		}

	}

	if( $match_flg == true ){

		//echo "false";exit();

		return false;
		exit();

	}else{

		//echo "true";exit();

		return true;
		exit();

	}

}

function get_sale_shop_2_data($year,$month,$shop_name,$shop_area,$disp_type,$year_start,$month_start,$day_start,$year_end,$month_end,$day_end){

	if( $disp_type == "kikan" ){

		$timestamp_start = get_timestamp_by_year_month_day_common($year_start,$month_start,$day_start);
		$timestamp_end = get_timestamp_by_year_month_day_common($year_end,$month_end,$day_end);

		if( $timestamp_start > $timestamp_end ){

			return false;
			exit();

		}else{

			$day_num = get_day_num_from_two_timestamp($timestamp_start,$timestamp_end);

		}

		$for_start_num = "0";
		$for_end_num = $day_num;

	}else if( $disp_type == "month" ){

		$last_day = get_last_day_common($year,$month);

		$for_start_num = "1";
		$for_end_num = $last_day;

		$for_end_num++;

	}else{

		return false;
		exit();

	}

	$genkin_price_all = 0;
	$card_price_all = 0;
	$card_commission_all = 0;
	$therapist_remuneration_all = 0;
	$pay_day_therapist_all = 0;
	$therapist_remuneration_mibarai_all = 0;
	$allowance_jisou_all = 0;
	$allowance_therapist_all = 0;
	$driver_remuneration_all = 0;
	$driver_gasoline_all = 0;
	$driver_parking_all = 0;
	$driver_allowance_all = 0;
	$driver_highway_all = 0;
	$driver_pay_finish_all = 0;
	$lowest_guarantee_all = 0;
	$therapist_remuneration_sum_all = 0;
	$pay_day_driver_all = 0;
	$driver_remuneration_mibarai_all = 0;
	$driver_remuneration_sum_all = 0;
	$movement_cost_all = 0;
	$shop_boss_remuneration_all = 0;
	$driver_sonota_all = 0;
	$gross_profit_all = 0;

	$office_remuneration_mibarai_all = 0;
	$pay_day_office_all = 0;
	$office_allowance_all = 0;
	$office_remuneration_sum_all = 0;

	for( $i=$for_start_num; $i<$for_end_num; $i++ ){

		if( $disp_type == "kikan" ){

			$mirai_day = get_mirai_day_common($year_start,$month_start,$day_start,$i);

			$year = $mirai_day["year"];
			$month = $mirai_day["month"];
			$day = $mirai_day["day"];

		}else if( $disp_type == "month" ){

			$day = $i;

		}else{

			return false;
			exit();

		}

		//データがあるかどうかチェック(ある：true,ない：false)
		$result = check_reservation_for_board_exist_plus_day($shop_area,$year,$month,$day);

		if( $result == true ){

			//$data = get_sale_shop_2_data_day($year,$month,$day,$shop_name,$shop_area);
			$data = get_sale_shop_data_day_common($year,$month,$day,$shop_name,$shop_area);

			$genkin_price = $data["genkin_price"];
			$card_price = $data["card_price"];
			$card_commission = $data["card_commission"];
			$therapist_remuneration = $data["therapist_remuneration"];
			$pay_day_therapist = $data["pay_day_therapist"];
			$therapist_remuneration_mibarai = $data["therapist_remuneration_mibarai"];
			$allowance_jisou = $data["allowance_jisou"];
			$allowance_therapist = $data["allowance_therapist"];
			$driver_remuneration = $data["driver_remuneration"];
			$driver_gasoline = $data["driver_gasoline"];
			$driver_parking = $data["driver_parking"];
			$driver_allowance = $data["driver_allowance"];
			$driver_highway = $data["driver_highway"];
			$driver_pay_finish = $data["driver_pay_finish"];
			$lowest_guarantee = $data["lowest_guarantee"];
			$therapist_remuneration_sum = $data["therapist_remuneration_sum"];
			$pay_day_driver = $data["pay_day_driver"];
			$driver_remuneration_mibarai = $data["driver_remuneration_mibarai"];
			$driver_remuneration_sum = $data["driver_remuneration_sum"];
			$movement_cost = $data["movement_cost"];
			$shop_boss_remuneration = $data["shop_boss_remuneration"];
			$driver_sonota = $data["driver_sonota"];
			$gross_profit = $data["gross_profit"];
			$office_remuneration_mibarai = $data["office_remuneration_mibarai"];
			$pay_day_office = $data["pay_day_office"];
			$office_allowance = $data["office_allowance"];
			$office_remuneration_sum = $data["office_remuneration_sum"];

			$genkin_price_all = $genkin_price_all + $genkin_price;
			$card_price_all = $card_price_all + $card_price;
			$card_commission_all = $card_commission_all + $card_commission;
			$therapist_remuneration_all = $therapist_remuneration_all + $therapist_remuneration;
			$pay_day_therapist_all = $pay_day_therapist_all + $pay_day_therapist;
			$therapist_remuneration_mibarai_all = $therapist_remuneration_mibarai_all + $therapist_remuneration_mibarai;
			$allowance_jisou_all = $allowance_jisou_all + $allowance_jisou;
			$allowance_therapist_all = $allowance_therapist_all + $allowance_therapist;
			$driver_remuneration_all = $driver_remuneration_all + $driver_remuneration;
			$driver_gasoline_all = $driver_gasoline_all + $driver_gasoline;
			$driver_parking_all = $driver_parking_all + $driver_parking;
			$driver_allowance_all = $driver_allowance_all + $driver_allowance;
			$driver_highway_all = $driver_highway_all + $driver_highway;
			$driver_pay_finish_all = $driver_pay_finish_all + $driver_pay_finish;
			$lowest_guarantee_all = $lowest_guarantee_all + $lowest_guarantee;
			$therapist_remuneration_sum_all = $therapist_remuneration_sum_all + $therapist_remuneration_sum;
			$pay_day_driver_all = $pay_day_driver_all + $pay_day_driver;
			$driver_remuneration_mibarai_all = $driver_remuneration_mibarai_all + $driver_remuneration_mibarai;
			$driver_remuneration_sum_all = $driver_remuneration_sum_all + $driver_remuneration_sum;
			$movement_cost_all = $movement_cost_all + $movement_cost;
			$shop_boss_remuneration_all = $shop_boss_remuneration_all + $shop_boss_remuneration;
			$driver_sonota_all = $driver_sonota_all + $driver_sonota;
			$gross_profit_all = $gross_profit_all + $gross_profit;
			$office_remuneration_mibarai_all = $office_remuneration_mibarai_all + $office_remuneration_mibarai;
			$pay_day_office_all = $pay_day_office_all + $pay_day_office;
			$office_allowance_all = $office_allowance_all + $office_allowance;
			$office_remuneration_sum_all = $office_remuneration_sum_all + $office_remuneration_sum;

		}else{

			//最低保証のチェック

			$lowest_guarantee = get_lowest_guarantee_2_common($shop_area,$shop_name,$year,$month,$day);
			$lowest_guarantee_all = $lowest_guarantee_all + $lowest_guarantee;

			//ここは足す
			$therapist_remuneration_sum_all = $therapist_remuneration_sum_all + $lowest_guarantee;

			//ここは引く
			$gross_profit_all = $gross_profit_all - $lowest_guarantee;

		}

	}

	//店長報酬と、粗利益の計算(期間選択用)

$shop_boss_remuneration_all = get_shop_boss_remuneration_for_sale_shop(
$genkin_price_all,
$card_price_all,
$therapist_remuneration_all,
$driver_remuneration_all,
$movement_cost_all,
$driver_gasoline_all,
$driver_parking_all,
$card_commission_all,
$shop_area,
$lowest_guarantee_all,
$driver_highway_all);


$staff_remuneration_sum_all = $driver_remuneration_sum_all + $office_remuneration_sum_all;


$gross_profit_all = get_gross_profit_for_sale_shop(
$genkin_price_all,
$card_price_all,
$therapist_remuneration_sum_all,
$staff_remuneration_sum_all,
$movement_cost_all,
$driver_gasoline_all,
$driver_parking_all,
$driver_highway_all,
$card_commission_all,
$shop_boss_remuneration_all,
$driver_sonota_all,
$driver_pay_finish_all);


	$return_data["genkin_price"] = $genkin_price_all;
	$return_data["card_price"] = $card_price_all;
	$return_data["card_commission"] = $card_commission_all;
	$return_data["therapist_remuneration"] = $therapist_remuneration_all;
	$return_data["pay_day_therapist"] = $pay_day_therapist_all;
	$return_data["therapist_remuneration_mibarai"] = $therapist_remuneration_mibarai_all;
	$return_data["allowance_jisou"] = $allowance_jisou_all;
	$return_data["allowance_therapist"] = $allowance_therapist_all;
	$return_data["driver_remuneration"] = $driver_remuneration_all;
	$return_data["driver_gasoline"] = $driver_gasoline_all;
	$return_data["driver_parking"] = $driver_parking_all;
	$return_data["driver_allowance"] = $driver_allowance_all;
	$return_data["driver_highway"] = $driver_highway_all;
	$return_data["driver_pay_finish"] = $driver_pay_finish_all;
	$return_data["lowest_guarantee"] = $lowest_guarantee_all;
	$return_data["therapist_remuneration_sum"] = $therapist_remuneration_sum_all;
	$return_data["pay_day_driver"] = $pay_day_driver_all;
	$return_data["driver_remuneration_mibarai"] = $driver_remuneration_mibarai_all;
	$return_data["driver_remuneration_sum"] = $driver_remuneration_sum_all;
	$return_data["movement_cost"] = $movement_cost_all;
	$return_data["shop_boss_remuneration"] = $shop_boss_remuneration_all;
	$return_data["driver_sonota"] = $driver_sonota_all;
	$return_data["gross_profit"] = $gross_profit_all;

	$return_data["office_remuneration_mibarai"] = $office_remuneration_mibarai_all;
	$return_data["pay_day_office"] = $pay_day_office_all;
	$return_data["office_allowance"] = $office_allowance_all;
	$return_data["office_remuneration_sum"] = $office_remuneration_sum_all;

	return $return_data;
	exit();

}

function get_sale_shop_2_data_day($year,$month,$day,$shop_name,$shop_area){

	//$start_time = microtime(true);

	$result = check_last_day_for_remuneration_common($year,$month,$day);

	if( $result == false ){

		$genkin_price = 0;
		$card_price = 0;
		$card_commission = 0;
		$therapist_remuneration = 0;
		$pay_day_therapist = 0;
		$therapist_remuneration_mibarai = 0;
		$allowance_jisou = 0;
		$allowance_therapist = 0;
		$driver_remuneration = 0;
		$driver_gasoline = 0;
		$driver_parking = 0;
		$driver_allowance = 0;
		$driver_highway = 0;
		$driver_pay_finish = 0;
		$lowest_guarantee = 0;
		$therapist_remuneration_sum = 0;
		$pay_day_driver = 0;
		$driver_remuneration_mibarai = 0;
		$driver_remuneration_sum = 0;
		$movement_cost = 0;
		$shop_boss_remuneration = 0;
		$driver_sonota = 0;
		$gross_profit = 0;
		$office_remuneration_mibarai = 0;
		$pay_day_office = 0;
		$office_allowance = 0;
		$office_remuneration_sum = 0;

	}else{

		$result = check_kirikae_card_commission_calculation($year,$month,$day);

		if( $result == false ){

			$data = get_genkin_price_card_price_card_commission_old($year,$month,$day,$shop_name);

			$genkin_price = $data["genkin_price"];
			$card_price = $data["card_price"];
			$card_commission = $data["card_commission"];

		}else{

			$data = get_genkin_price_card_price_card_commission_new($year,$month,$day,$shop_name);

			$genkin_price = $data["genkin_price"];
			$card_price = $data["card_price"];
			$card_commission = $data["card_commission"];

		}

		$therapist_remuneration = get_remuneration_at_sale_shop_2($year,$month,$day,$shop_name);

		/*
		$data = get_data_for_sale_shop_2($year,$month,$day,$shop_name);
		$id_data = get_attendance_id_by_for_sale_shop_2_data($data);
		$data = get_therapist_remuneration_data_for_sale_shop_2($id_data);
		$therapist_remuneration = $data["remuneration"];
		$lowest_guarantee = $data["lowest_guarantee"];
		*/

		/*
		echo "<pre>";
		print_r($data);
		echo "</pre>";
		exit();
		*/

		//日払い報酬取得
		$pay_day_therapist = get_pay_day_therapist($year,$month,$day,$shop_name,$shop_area);

		$therapist_remuneration_mibarai = $therapist_remuneration - $pay_day_therapist;

		//セラピスト自走手当
		$allowance_jisou = get_allowance_jisou_therapist_day($year,$month,$day,$shop_name,$shop_area);

		//セラピスト手当
		$allowance_therapist = get_allowance_therapist_day($year,$month,$day,$shop_name,$shop_area);

		$allowance_therapist = $allowance_therapist + $allowance_jisou;

		$data = get_office_payment_for_sale_shop($year,$month,$day,$shop_area);

		$office_remuneration = $data["remuneration"];
		$office_gasoline = $data["gasoline"];
		$office_allowance = $data["allowance"];
		$pay_day_office = 0;
		$office_remuneration_mibarai = $office_remuneration - $pay_day_office;
		$office_remuneration_sum = $office_remuneration + $office_allowance;

		$data = get_driver_payment_for_sale_shop_2($year,$month,$day,$shop_area);

		$driver_remuneration = $data["remuneration"];
		$driver_gasoline = $data["gasoline"];
		$driver_parking = $data["parking"];
		$driver_allowance = $data["allowance"];
		$driver_highway = $data["highway"];
		$driver_pay_finish = $data["pay_finish"];

		//ドライバー日払い
		$pay_day_driver = get_pay_day_driver($year,$month,$day,$shop_name,$shop_area);

		//未払い報酬(ドライバー)
		$driver_remuneration_mibarai = $driver_remuneration - $pay_day_driver;

		//報酬合計(ドライバー)
		$driver_remuneration_sum = $driver_remuneration + $driver_allowance;

		//これが重い
		$lowest_guarantee = get_lowest_guarantee_2_common($shop_area,$shop_name,$year,$month,$day);

		//セラピスト報酬合計
		$therapist_remuneration_sum = $therapist_remuneration + $lowest_guarantee + $allowance_therapist;

		$movement_cost = get_movement_cost_for_sale_shop($shop_area,$year,$month,$day);

if(
(($shop_area == "tokyo") && ($shop_name != "東京リフレ")) ||
(($shop_area == "osaka") && ($shop_name != "大阪リフレ"))
){

			$driver_remuneration_sum = 0;
			$driver_remuneration_mibarai = 0;
			$driver_remuneration = 0;
			$movement_cost = 0;
			$driver_gasoline = 0;
			$driver_parking = 0;
			$driver_allowance = 0;
			$driver_highway = 0;
			$driver_pay_finish = 0;
			$office_remuneration_mibarai = 0;
			$pay_day_office = 0;
			$office_allowance = 0;
			$office_remuneration_sum = 0;
			$office_gasoline = 0;

}

		//ドライバー、社用車、内勤
		$driver_gasoline = $driver_gasoline + $office_gasoline;

		$staff_remuneration_sum = $driver_remuneration_sum + $office_remuneration_sum;

		$shop_boss_remuneration = get_shop_boss_remuneration_for_sale_shop(
$genkin_price,$card_price,$therapist_remuneration,
$driver_remuneration,$movement_cost,$driver_gasoline,$driver_parking,$card_commission,
$shop_area,$lowest_guarantee,$driver_highway);

		$driver_sonota = get_driver_sonota_day($year,$month,$day,$shop_area);

		$gross_profit = 0;

		$gross_profit = get_gross_profit_for_sale_shop($genkin_price,$card_price,$therapist_remuneration_sum,
$staff_remuneration_sum,$movement_cost,$driver_gasoline,$driver_parking,$driver_highway,$card_commission,
$shop_boss_remuneration,$driver_sonota,$driver_pay_finish);

	}

	$data["genkin_price"] = $genkin_price;
	$data["card_price"] = $card_price;
	$data["card_commission"] = $card_commission;
	$data["therapist_remuneration"] = $therapist_remuneration;
	$data["pay_day_therapist"] = $pay_day_therapist;
	$data["therapist_remuneration_mibarai"] = $therapist_remuneration_mibarai;
	$data["allowance_jisou"] = $allowance_jisou;
	$data["allowance_therapist"] = $allowance_therapist;
	$data["driver_remuneration"] = $driver_remuneration;
	$data["driver_gasoline"] = $driver_gasoline;
	$data["driver_parking"] = $driver_parking;
	$data["driver_allowance"] = $driver_allowance;
	$data["driver_highway"] = $driver_highway;
	$data["driver_pay_finish"] = $driver_pay_finish;
	$data["lowest_guarantee"] = $lowest_guarantee;
	$data["therapist_remuneration_sum"] = $therapist_remuneration_sum;
	$data["pay_day_driver"] = $pay_day_driver;
	$data["driver_remuneration_mibarai"] = $driver_remuneration_mibarai;
	$data["driver_remuneration_sum"] = $driver_remuneration_sum;
	$data["movement_cost"] = $movement_cost;
	$data["shop_boss_remuneration"] = $shop_boss_remuneration;
	$data["driver_sonota"] = $driver_sonota;
	$data["gross_profit"] = $gross_profit;
	$data["office_remuneration_mibarai"] = $office_remuneration_mibarai;
	$data["pay_day_office"] = $pay_day_office;
	$data["office_allowance"] = $office_allowance;
	$data["office_remuneration_sum"] = $office_remuneration_sum;

	/*
	$end_time = microtime(true);
	$sa = $end_time-$start_time;
	echo $sa;exit();
	*/

	return $data;
	exit();

}

function get_day_num_from_two_timestamp($timestamp_start,$timestamp_end){

	$day_num = 0;

	$sa = $timestamp_end - $timestamp_start;

	if( $sa == "0" ){

		$day_num = 1;

	}else{

		$day_ts = (60*60*24);

		$day_num = intval( $sa / $day_ts );

		$day_num++;

	}

	return $day_num;
	exit();

}

function check_kikan_for_sale_shop_2($year_start,$month_start,$day_start,$year_end,$month_end,$day_end){

	$error = "";

	if( ($year_start == "") || ($month_start == "") || ($day_start == "") || ($year_end == "") || ($month_end == "") || ($day_end == "") ){

		$error = "期間が未入力です";

	}else{

		$timestamp_start = get_timestamp_by_year_month_day_common($year_start,$month_start,$day_start);
		$timestamp_end = get_timestamp_by_year_month_day_common($year_end,$month_end,$day_end);

		if( $timestamp_start > $timestamp_end ){

			$error = "期間が不正です";

		}

	}

	return $error;
	exit();

}

function get_disp_type($year_start,$month_start,$day_start,$year_end,$month_end,$day_end,$year_month){

	$type = "not-set";

	if( $year_month != "" ){

		$type = "month";

	}else if( ($year_start != "") && ($month_start != "") && ($day_start != "") && ($year_end != "") && ($month_end != "") && ($day_end != "") ){

		$type = "kikan";

	}

	return $type;
	exit();

}

function get_remuneration_at_sale_shop_2($year,$month,$day,$shop_name){

	//$start_time = microtime(true);

	$shop_id = get_shop_id_by_shop_name_common($shop_name);

	$data = get_for_sale_shop_data_common($shop_id,$year,$month,$day);

	if( $data["id"] != "" ){

		$remuneration = $data["remuneration"];
		$chief_allowance = $data["chief_allowance"];

		$remuneration = $remuneration + $chief_allowance;

		return $remuneration;
		exit();

	}

	/*
	echo "<pre>";
	print_r($data);
	echo "</pre>";
	exit();
	*/

	$remuneration_all = 0;

	$result = check_last_day_for_remuneration_common($year,$month,$day);

	if( $result == false ){

		return $remuneration_all;
		exit();

	}

	$sql = sprintf("
select
sale_history.price,
sale_history.therapist_id,
reservation_for_board.attendance_id,
reservation_for_board.shop_area,
reservation_for_board.shimei_flg,
reservation_for_board.transportation
from reservation_for_board
left join sale_history on sale_history.reservation_no=reservation_for_board.reservation_no
where
reservation_for_board.shop_name='%s' and
reservation_for_board.year='%s' and
reservation_for_board.month='%s' and
reservation_for_board.day='%s' and
reservation_for_board.delete_flg=0 and
sale_history.delete_flg=0 and
sale_history.eigyou_year='%s' and
sale_history.eigyou_month='%s' and
sale_history.eigyou_day='%s'",
$shop_name,$year,$month,$day,$year,$month,$day);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_remuneration_at_sale_shop_2)";
		exit();

	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$list_data[$i++] = $row;

	}

	$list_data_num = count($list_data);

	for($i=0;$i<$list_data_num;$i++){

		$price = $list_data[$i]["price"];
		$shimei_flg = $list_data[$i]["shimei_flg"];
		$transportation = $list_data[$i]["transportation"];
		$attendance_id = $list_data[$i]["attendance_id"];

		$therapist_id = $list_data[$i]["therapist_id"];

		$result = check_effective_attendance_new_common($attendance_id);

		if( $result == false ){

			$remuneration = "0";

		}else{

			$share_rate = get_share_rate_by_attendance_id_common($attendance_id);

			if($list_data[$i]["shop_area"]!="tokyo_reraku"){
				$remuneration = get_remuneration_one_common($price,$shimei_flg,$transportation,$share_rate);
			}
			else{
				$remuneration = get_remuneration_one_reraku_common($price,$shimei_flg,$transportation,$share_rate);
			}

			//echo "price:".$price;echo "<br />";

		}

		$remuneration_all = $remuneration_all + $remuneration;

	}

	$chief_allowance = get_chief_allowance_by_shop_name_common($year,$month,$day,$shop_name);

	$remuneration_all = $remuneration_all + $chief_allowance;

	/*
	$end_time = microtime(true);
	$sa = $end_time-$start_time;
	echo $sa;exit();
	*/

	return $remuneration_all;
	exit();

}

function get_point_past_flg($year,$month,$day){

	$past_num = "8";

	$year_now = intval(date('Y'));
	$month_now = intval(date('m'));
	$day_now = intval(date('d'));

	$data = get_kako_day_common($year_now,$month_now,$day_now,$past_num);
	$year_past = $data["year"];
	$month_past = $data["month"];
	$day_past = $data["day"];

	$ts_past = get_timestamp_by_year_month_day_common($year_past,$month_past,$day_past);
	$ts_hiki = get_timestamp_by_year_month_day_common($year,$month,$day);

	if( $ts_past <= $ts_hiki ){

		return false;
		exit();

	}else{

		return true;
		exit();

	}

}

function null_is_zero($data){

	if( $data == "" ){

		$data = 0;

	}

	return $data;
	exit();

}

function get_office_payment_for_sale_shop($year,$month,$day,$area){

	//$gasoline_value = get_gasoline_value_from_settings_2_common($area,$year,$month,$day);

	$driver_data = get_honbu_data_for_sale($year,$month,$day,$area);

	$driver_data_num = count($driver_data);

	$remuneration_all = 0;
	$gasoline_value_disp_all = 0;
	$allowance_all = 0;

	for($i=0;$i<$driver_data_num;$i++){

		$driver_id = $driver_data[$i]["id"];
		$pay_hour = $driver_data[$i]["pay_hour"];
		$pay_fix = $driver_data[$i]["pay_fix"];
		$fuel = $driver_data[$i]["fuel"];

		if( $pay_hour == "-1" ){

			$pay_hour = 0;

		}

		$data = get_staff_attendance_data_by_time($driver_id,$year,$month,$day);

		$start_time = $data["start_time"];
		$end_time = $data["end_time"];

		$car_distance = $data["car_distance"];
		$allowance = $data["allowance"];

		$start_hour = $data["start_hour"];
		$start_minute = $data["start_minute"];
		$end_hour = $data["end_hour"];
		$end_minute = $data["end_minute"];

		$driver_area = get_staff_area_by_id_common($driver_id);
		$gasoline_value = get_gasoline_value_from_settings_2_common($driver_area,$year,$month,$day);

		if( ($fuel != "0") && ($fuel != "-1") ){

			$gasoline_value_disp = intval(($car_distance*$gasoline_value)/$fuel);

		}else{

			$gasoline_value_disp = 0;

		}

		if( ( $start_hour == "-1" ) || ( $start_minute == "-1" ) || ( $end_hour == "-1" ) || ( $end_minute == "-1" ) ){

			$work_time = get_work_time($start_time,$end_time);

		}else{

			$work_time = get_work_time_driver_common($start_hour,$start_minute,$end_hour,$end_minute);

		}

		$remuneration = get_remuneration_driver_common($pay_hour,$pay_fix,$work_time);

		$remuneration_all = $remuneration_all + $remuneration;
		$gasoline_value_disp_all = $gasoline_value_disp_all + $gasoline_value_disp;

		$allowance_all = $allowance_all + $allowance;

	}

	$result = check_last_day_for_remuneration_common($year,$month,$day);

	if( $result == false ){

		$remuneration_all = 0;

	}

	$data["remuneration"] = $remuneration_all;
	$data["gasoline"] = $gasoline_value_disp_all;
	$data["allowance"] = $allowance_all;

	return $data;
	exit();

}

function make_myyahoo(){

	$station_data = get_station_data_for_page_html_new("osaka");

	$station_data_num = count($station_data);

	$html .= "array(";
	$html .= "<br />";
	$x = 0;
	for($i=0;$i<50;$i++){
		$name = $station_data[$i]["name"];
		$html .= sprintf('%s=>"出張マッサージ　%s",',$x,$name);
		$html .= "<br />";
		$x++;
	}
	$html .= ");";
	$html .= "<br /><br />";

	$html .= "array(";
	$html .= "<br />";
	$x = 0;
	for($i=50;$i<100;$i++){
		$name = $station_data[$i]["name"];
		$html .= sprintf('%s=>"出張マッサージ　%s",',$x,$name);
		$html .= "<br />";
		$x++;
	}
	$html .= ");";
	$html .= "<br /><br />";

	$html .= "array(";
	$html .= "<br />";
	$x = 0;
	for($i=100;$i<150;$i++){
		$name = $station_data[$i]["name"];
		$html .= sprintf('%s=>"出張マッサージ　%s",',$x,$name);
		$html .= "<br />";
		$x++;


	}
	$html .= ");";
	$html .= "<br /><br />";

	$html .= "array(";
	$html .= "<br />";
	$x = 0;
	for($i=150;$i<200;$i++){
		$name = $station_data[$i]["name"];
		$html .= sprintf('%s=>"出張マッサージ　%s",',$x,$name);
		$html .= "<br />";
		$x++;


	}
	$html .= ");";
	$html .= "<br /><br />";

	$html .= "array(";
	$html .= "<br />";
	$x = 0;
	for($i=200;$i<250;$i++){
		$name = $station_data[$i]["name"];
		$html .= sprintf('%s=>"出張マッサージ　%s",',$x,$name);
		$html .= "<br />";
		$x++;


	}
	$html .= ");";
	$html .= "<br /><br />";

	$html .= "array(";
	$html .= "<br />";
	$x = 0;
	for($i=250;$i<300;$i++){
		$name = $station_data[$i]["name"];
		$html .= sprintf('%s=>"出張マッサージ　%s",',$x,$name);
		$html .= "<br />";
		$x++;


	}
	$html .= ");";
	$html .= "<br /><br />";

	$html .= "array(";
	$html .= "<br />";
	$x = 0;
	for($i=300;$i<327;$i++){
		$name = $station_data[$i]["name"];
		$html .= sprintf('%s=>"出張マッサージ　%s",',$x,$name);
		$html .= "<br />";
		$x++;


	}
	$html .= ");";
	$html .= "<br /><br />";

	echo $html;
	exit();

}

function get_staff_select_frm($staff_id){

	$staff_data = get_staff_data_honbu();

	$staff_data_num = count($staff_data);

	$html .= '<select name="staff_id">';

	$html .= '<option value="-1">未選択</option>';

	for($i=0;$i<$staff_data_num;$i++){

		$id = $staff_data[$i]["id"];
		$name = $staff_data[$i]["name"];

		if( $id == $staff_id ){

			$html .= sprintf('<option value="%s" selected>%s</option>',$id,$name);

		}else{

			$html .= sprintf('<option value="%s">%s</option>',$id,$name);

		}

	}

	$html .= '</select>';

	return $html;
	exit();

}

//スタッフデータの取得
function get_staff_data_honbu(){

	$sql = sprintf("select * from staff_new_new where delete_flg='0' and type='honbu' and area='tokyo'",$staff_type);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_staff_data_honbu)";
		exit();
	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$list_data[$i] = $row;
		$i++;

	}

	return $list_data;
	exit();
}

function update_staff_id_confirm($staff_id,$reservation_for_board_id){

	$sql = sprintf("update reservation_for_board set staff_id_confirm='%s' where id='%s'",$staff_id,$reservation_for_board_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(update_staff_id_confirm)";
		exit();
	}

	return true;
	exit();
}

function update_staff_id_approve($staff_id,$reservation_for_board_id){

	$sql = sprintf("update reservation_for_board set staff_id_approve='%s' where id='%s'",$staff_id,$reservation_for_board_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(update_staff_id_approve)";
		exit();
	}

	return true;
	exit();
}

function get_confirm_num_for_sale_operation($year,$month,$day,$area){

	$type = "all";
	$board_data = get_reservation_for_board_for_sale_operation_2($year,$month,$day,$area,$type);

	$board_data_num = count($board_data);

	$all_num = 0;
	$confirm_num = 0;
	$not_confirm_num = 0;

	for($i=0;$i<$board_data_num;$i++){

		$staff_id_confirm = $board_data[$i]["staff_id_confirm"];
		$staff_id_approve = $board_data[$i]["staff_id_approve"];

		if( $staff_id_confirm == "-1" ){

			$not_confirm_num++;

		}else{

			if( $staff_id_approve == "-1" ){

				$confirm_num++;

			}

		}

		$all_num++;

	}

	$data["all_num"] =$all_num;
	$data["confirm_num"] =$confirm_num;
	$data["not_confirm_num"] =$not_confirm_num;

	return $data;
	exit();

}

function get_reservation_for_board_for_sale_operation_2($year,$month,$day,$area,$type){

	if( $type == "confirm" ){

		$where_add = "staff_id_approve='-1' and staff_id_confirm<>'-1'";

	}else if( $type == "not_confirm" ){

		$where_add = "staff_id_confirm='-1'";

	}else{

		$where_add = "1=1";

	}

	if( $area == "all" ){

		$sql = sprintf("
select * from reservation_for_board where
delete_flg=0 and
year='%s' and
month='%s' and
day='%s' and
%s
order by start_hour asc,start_minute asc",
$year,$month,$day,$where_add);

	}else{

		$sql = sprintf("
select * from reservation_for_board where
delete_flg=0 and
shop_area='%s' and
year='%s' and
month='%s' and
day='%s' and
%s
order by start_hour asc,start_minute asc",
$area,$year,$month,$day,$where_add);

	}

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_reservation_for_board_for_sale_operation_2)";
		exit();

	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$list_data[$i++] = $row;

	}

	return $list_data;
	exit();

}

//pay_anotherの更新
function update_pay_another_by_attendance_id($pay_another,$attendance_id){

	$sql = sprintf("update attendance_new set pay_another='%s' where id='%s'",$pay_another,$attendance_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(update_pay_another_by_attendance_id)";
		exit();
	}

	return true;
	exit();
}

//出勤情報を登録(スタッフ)(2)
function regist_attendance_data_staff_2($staff_id,$type,$year,$month,$day,$start_time,$end_time,$att_area){

	$staff_id_array = explode("_", $staff_id);

	$staff_id = $staff_id_array[0];
	$staff_area = $staff_id_array[1];

	// 出勤情報を登録するSQL文
	$sql = sprintf("
insert into attendance_staff_new(staff_id,type,year,month,day,start_time,end_time,area)
values('%s','%s','%s','%s','%s','%s','%s','%s')",
$staff_id,$type,$year,$month,$day,$start_time,$end_time,$att_area);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(regist_attendance_data_staff_2)";
		exit();

	}

	$insert_id = mysql_insert_id();

	return $insert_id;
	exit();

}

//出勤情報を登録(スタッフ)(3)
function regist_attendance_data_staff_3($staff_id,$type,$year,$month,$day,$start_time,$end_time,$att_area){

	// 出勤情報を登録するSQL文
	$sql = sprintf("
insert into attendance_staff_new(staff_id,type,year,month,day,start_time,end_time,area)
values('%s','%s','%s','%s','%s','%s','%s','%s')",
$staff_id,$type,$year,$month,$day,$start_time,$end_time,$att_area);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(regist_attendance_data_staff_3)";
		exit();

	}

	$insert_id = mysql_insert_id();

	return $insert_id;
	exit();

}

//出勤データのコピー(スタッフ)(2)
function copy_attendance_data_staff_2($attendance_id,$year,$month,$day){

	//出席データの取得(スタッフ)
	$data = get_attendance_staff_data_one_by_attendance_id_common($attendance_id);

	$staff_id = $data["staff_id"];
	$start_time = $data["start_time"];
	$end_time = $data["end_time"];
	$att_area = $data["area"];
	$type = $data["type"];

	//出席データが登録済みであるかどうか(登録済み：attendance_id,未登録:false)(スタッフ)(NEW)
	$check_result = check_staff_attendance_exist_common($staff_id, $year, $month, $day);

	if( $check_result == false ){

		//インサートのsql
		$sql = sprintf("
insert into attendance_staff_new(staff_id,type,year,month,day,start_time,end_time,area)
values('%s','%s','%s','%s','%s','%s','%s','%s')",
$staff_id,$type,$year,$month,$day,$start_time,$end_time,$att_area);

	}else{

		$attendance_id = $check_result;

		//更新のsql
		$sql = sprintf("
update attendance_staff_new set year='%s',month='%s',day='%s',start_time='%s',end_time='%s',area='%s'
where id='%s'",
$year,$month,$day,$start_time,$end_time,$att_area,$attendance_id);

	}

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(copy_attendance_data_staff_2)";
		exit();

	}

	return true;
	exit();

}

//出勤スタッフの数を取得
function get_staff_attendance_num_2($type,$year,$month,$day,$area){

	$sql = sprintf("
select attendance_staff_new.id from attendance_staff_new
left join staff_new_new on staff_new_new.id=attendance_staff_new.staff_id
where
staff_new_new.delete_flg='0' and
attendance_staff_new.today_absence='0' and
attendance_staff_new.kekkin_flg='0' and
attendance_staff_new.type='%s' and
attendance_staff_new.year='%s' and
attendance_staff_new.month='%s' and
attendance_staff_new.day='%s' and
attendance_staff_new.area='%s'",
$type,$year,$month,$day,$area);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(get_staff_attendance_num_2)";
		exit();

	}

	$num = mysql_num_rows($res);

	return $num;
	exit();

}

//スタッフの出勤データを取得
function get_staff_attendance_data_2($type,$now_month,$next_month,$two_month,$area){

	$now_month = intval($now_month);
	$next_month = intval($next_month);
	$two_month = intval($two_month);

	// 出勤データを取得するためのSQL文
	$sql = sprintf("select * from attendance_staff_new where (month='%s' or month='%s' or month='%s') and type='%s' and area='%s'",$now_month,$next_month,$two_month,$type,$area);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_staff_attendance_data_2)";
		exit();
	}

	$data = array();

	$i=0;

	while($row = mysql_fetch_assoc($res)){

		$data[$i++] = $row;

	}

	if( ( $type=="driver" ) && ( ($area == "tokyo") || ($area == "yokohama") ) ){

		$area2 = "";

		if( $area == "tokyo" ){

			$area2 = "yokohama";

		}else if( $area == "yokohama" ){

			$area2 = "tokyo";

		}else{

			echo "error!(get_staff_attendance_data_2)";
			exit();

		}

$sql = sprintf("
select * from attendance_staff_new where (month='%s' or month='%s' or month='%s') and type='%s' and area='%s'",
$now_month,$next_month,$two_month,$type,$area2);

		$res = mysql_query($sql, DbCon);

		if($res == false){

			echo "error!(get_staff_attendance_data_2)";
			exit();

		}

		while($row = mysql_fetch_assoc($res)){

			$data[$i++] = $row;

		}

	}

	return $data;
	exit();

}

//出勤情報を更新(スタッフ)
function update_attendance_data_staff_2(
$attendance_id,$year,$month,$day,$start_time,$end_time,$today_absence,
$attendance_adjustment,$att_area,$not_board_display_flg){

	if( $not_board_display_flg == "" ){

		$not_board_display_flg = "0";

	}

	// 出勤情報を登録するSQL文
	//更新のsql
	$sql = sprintf("
update attendance_staff_new set
year='%s',month='%s',day='%s',start_time='%s',end_time='%s',area='%s',today_absence='%s',
attendance_adjustment='%s',not_board_display_flg='%s'
where id='%s'",
$year,$month,$day,$start_time,$end_time,$att_area,$today_absence,
$attendance_adjustment,$not_board_display_flg,$attendance_id);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(update_attendance_data_staff_2)";
		exit();

	}

	return true;
	exit();

}

function get_driver_data_2($year,$month,$day,$area){

	$type = "driver";

	$sql = sprintf("select * from staff_new_new where delete_flg='0' and shayousha_flg='0' and type='%s' and area='%s'",$type,$area);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_driver_2)";
		exit();
	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$staff_id = $row["id"];

		$result = check_staff_attendance_exist_common($staff_id,$year,$month,$day);

		if( $result == true ){

			$list_data[$i] = $row;
			$list_data[$i]["area"] = $area;
			$i++;

		}

	}

	return $list_data;
	exit();

}

function get_driver_data_for_sale_shop($year,$month,$day,$area){

	$page_area = $area;

	$type = "driver";

	$sql = sprintf("select * from staff_new_new where delete_flg='0' and shayousha_flg='0' and type='%s' and area='%s'",$type,$page_area);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_driver_data_for_sale_shop:1)";
		exit();
	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$staff_id = $row["id"];

		$result = check_staff_attendance_exist_2_common($staff_id, $year, $month, $day,$page_area);

		if( $result == true ){

			$list_data[$i] = $row;
			$list_data[$i]["area"] = $page_area;
			$i++;

		}

	}

	if( $area == "yokohama" ){

		$area_tokyo = "tokyo";

		$where_kenmu = "kenmu like '%".$page_area."%'";

		$sql = sprintf("
select * from staff_new_new where delete_flg='0' and type='%s' and (%s) and area='%s'",
$type,$where_kenmu,$area_tokyo);

		//echo $sql;exit();

		$res = mysql_query($sql, DbCon);

		if($res == false){

			echo "error!(get_driver_data_for_sale_shop:2)";
			exit();

		}

		while($row = mysql_fetch_assoc($res)){

			$staff_id = $row["id"];

			$result = check_staff_attendance_exist_2_common($staff_id, $year, $month, $day,$page_area);

			if( $result == true ){

				$list_data[$i] = $row;
				$list_data[$i]["area"] = $area_tokyo;
				$i++;

			}

		}

	}

	return $list_data;
	exit();

}

function get_time_for_frikomi_list($value){

	$data = array();

	$pieces = explode("/", $value);

	$data["year"] = intval($pieces[0]);
	$data["month"] = intval($pieces[1]);
	$data["day"] = intval($pieces[2]);

	return $data;
	exit();

}

function check_time_for_furikomi_list($year_from,$month_from,$day_from,$year_to,$month_to,$day_to){

	$ts_from = get_timestamp_by_year_month_day_common($year_from,$month_from,$day_from);
	$ts_to = get_timestamp_by_year_month_day_common($year_to,$month_to,$day_to);

	$ts_day = 60 * 60 * 24;

	$ts_big = 60 * $ts_day;

	if( $ts_from > $ts_to ){

		return false;
		exit();

	}else{

		$ts_sa = $ts_to - $ts_from;

		if( $ts_sa > $ts_big ){		//60日以内か？
			return false;
			exit();

		}

	}

	if( $ts_sa == 0 ){

		$num = 1;

	}else{

		$num = intval($ts_sa / $ts_day);

		$num++;

	}

	return $num;
	exit();

}

function update_reservation_data_3(
$reservation_id,$start_hour,$start_minute,$end_hour,$end_minute,$attendance_id,
$start_hour_old,$start_minute_old,$end_hour_old,$end_minute_old,$shop_area,$place_name,$therapist_id,
$year,$month,$day,$card_flg,$card_confirm_flg,$course,$complete_flg,$start_flg,$extension,
$shop_name,$course_old,$course_new,$extension_old,$extension_new,$course_change_flg,$extension_change_flg,$course_var,
$card_state_extension,$card_price_free,$card_commission_free,$card_commission_type){

	$attendance_start_time = get_attendance_start_time($attendance_id,$shop_area);

	$yoyaku_start_time = start_hour_and_minute_to_time($start_hour,$start_minute);

	if( $attendance_start_time > $yoyaku_start_time ){

		//出勤開始時間よりも前です、のエラー表示は不要
		//return false;
		//exit();

	}

	$start_real_time_flg = false;
	$mail_flg = false;
	$mail_type = "";
	$customer_name = "";
	$check_url = "";
	$reservation_for_board_id = $reservation_id;
	$area_name = $place_name;

	$other_data["card_price_free"] = $card_price_free;
	$other_data["card_commission_free"] = $card_commission_free;
	$other_data["card_commission_type"] = $card_commission_type;

	$result = update_reservation_data_transaction_2_common(
$start_hour,$start_minute,$end_hour,$end_minute,$reservation_for_board_id,$therapist_id,$attendance_id,
$shop_area,$area_name,$course,$extension,$card_flg,$card_confirm_flg,$complete_flg,$start_flg,
$start_real_time_flg,$mail_flg,$mail_type,$customer_name,$check_url,
$shop_name,$course_old,$course_new,$extension_old,$extension_new,$course_change_flg,$extension_change_flg,
$course_var,$other_data);

	if( $result == true ){

		//延長時支払い方法の登録
		update_card_state_extension_by_reservation_for_board_id($reservation_for_board_id,$card_state_extension);

	}

	return true;
	exit();

}

function update_reservation_data_4(
$reservation_id,$start_hour,$start_minute,$end_hour,$end_minute,$attendance_id,
$start_hour_old,$start_minute_old,$end_hour_old,$end_minute_old,$shop_area,$place_name,$therapist_id,
$year,$month,$day,$card_flg,$card_confirm_flg,$course,$complete_flg,$start_flg,$extension,
$shop_name,$course_old,$course_new,$extension_old,$extension_new,$course_change_flg,$extension_change_flg,$course_var,
$card_state_extension,$card_price_free,$card_commission_free,$card_commission_type,$attendance_id_tmp,$attendance_tmp_flg,$shimei_flg,$shimei_change_flg){

	if($attendance_tmp_flg=="1"){
	    //セラピスト指定なしからの変更
	    if($attendance_id_tmp==""){
	        $attendance_id = "-1";
	    }
	    else{
	        $attendance_id = $attendance_id_tmp;
	        $attendance_id_tmp = "";
	    }
	}
	else{
	    //指定有からの変更
	    if($attendance_id_tmp==""){
	        //指定無しへ
	        $attendance_id_tmp = $attendance_id;
	    }
	    else{
	        $attendance_id = $attendance_id_tmp;
	        $attendance_id_tmp = "";
	    }
	}

	$start_real_time_flg = false;
	$mail_flg = false;
	$mail_type = "";
	$customer_name = "";
	$check_url = "";
	$reservation_for_board_id = $reservation_id;
	$area_name = $place_name;

	if( $card_flg != "1" ){

		$card_commission_type = "1";
		$card_price_free = "0";
		$card_commission_free = "0";

	}

	$other_data["card_price_free"] = $card_price_free;
	$other_data["card_commission_free"] = $card_commission_free;
	$other_data["card_commission_type"] = $card_commission_type;

$result = update_reservation_data_transaction_2_common(
$start_hour,$start_minute,$end_hour,$end_minute,$reservation_for_board_id,$therapist_id,$attendance_id,
$shop_area,$area_name,$course,$extension,$card_flg,$card_confirm_flg,$complete_flg,$start_flg,
$start_real_time_flg,$mail_flg,$mail_type,$customer_name,$check_url,
$shop_name,$course_old,$course_new,$extension_old,$extension_new,$course_change_flg,$extension_change_flg,
$course_var,$other_data,$shimei_flg,$shimei_change_flg);

	if( $result == true ){

        //延長時支払い方法の登録
        update_card_state_extension_by_reservation_for_board_id($reservation_for_board_id,$card_state_extension);
        //仮登録フラグの更新
        update_reservation_for_board_attendance_tmp($attendance_id_tmp,$reservation_for_board_id);

	}

	return true;
	exit();

}

function get_sale_price_by_shop_name_3($year,$month,$day,$shop_name,$card_flg){

	$sql = sprintf("
select
sale_history.price,
reservation_for_board.card_price_free,
reservation_for_board.card_commission_free,
reservation_for_board.card_commission_type
from reservation_for_board
left join sale_history on sale_history.reservation_no=reservation_for_board.reservation_no
where
reservation_for_board.shop_name='%s' and
reservation_for_board.card_flg='%s' and
reservation_for_board.year='%s' and
reservation_for_board.month='%s' and
reservation_for_board.day='%s' and
reservation_for_board.delete_flg=0 and
sale_history.delete_flg=0 and
sale_history.eigyou_year='%s' and
sale_history.eigyou_month='%s' and
sale_history.eigyou_day='%s'",
$shop_name,$card_flg,$year,$month,$day,$year,$month,$day);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_sale_price_by_shop_name_3)";
		exit();

	}

	$price_all = 0;
	$card_commission_free_all = 0;

	while($row = mysql_fetch_assoc($res)){

		$price_tmp = $row["price"];

		$card_price_free = $row["card_price_free"];
		$card_commission_free_tmp = $row["card_commission_free"];
		$card_commission_type = $row["card_commission_type"];

		$price = get_price_genkin_or_card_common($card_flg,$price_tmp,$card_price_free);

		$card_commission_free = get_card_commission_free_for_sale_shop_common(
$card_commission_type,$card_price_free,$card_flg,$price_tmp,$card_commission_free_tmp);

		$price_all = $price_all + $price;

		$card_commission_free_all = $card_commission_free_all + $card_commission_free;

	}

	$data["price"] = $price_all;
	$data["card_commission_free"] = $card_commission_free_all;

	return $data;
	exit();

}

function get_movement_cost_value_for_sale_shop($area,$year,$month,$day){

	$sql = sprintf("
select cost_value from movement_cost where
delete_flg='0' and
area='%s' and
year='%s' and
month='%s' and
day='%s'",
$area,$year,$month,$day);

	$res = mysql_query($sql, DbCon);
	if($res == false){

		echo "error!(get_movement_cost_value_for_sale_shop)";
		exit();

	}

	$cost_value_all = 0;

	while($row = mysql_fetch_assoc($res)){

		$cost_value = $row["cost_value"];

		$cost_value_all = $cost_value_all + $cost_value;

	}

	return $cost_value_all;
	exit();

}

function check_kirikae_card_commission_calculation($year,$month,$day){

	$ts = get_timestamp_by_year_month_day_common($year,$month,$day);

	$year_kirikae = "2015";
	$month_kirikae = "4";
	$day_kirikae = "17";

	$ts_kirikae = get_timestamp_by_year_month_day_common($year_kirikae,$month_kirikae,$day_kirikae);

	if( $ts < $ts_kirikae ){

		return false;
		exit();

	}else{

		return true;
		exit();

	}

}

function get_genkin_price_card_price_card_commission_old($year,$month,$day,$shop_name){

	$card_flg=0;
	$genkin_price = get_sale_price_by_shop_name_2($year,$month,$day,$shop_name,$card_flg);

	$card_flg=1;
	$card_price = get_sale_price_by_shop_name_2($year,$month,$day,$shop_name,$card_flg);

	if( $card_price == "0" ){

		$card_commission = 0;

	}else{

		$card_commission = ( $card_price * 324 ) / 10000;

		//四捨五入
		$card_commission = round($card_commission);

	}

	$data["genkin_price"] = $genkin_price;
	$data["card_price"] = $card_price;
	$data["card_commission"] = $card_commission;

	return $data;
	exit();

}

function get_genkin_price_card_price_card_commission_new($year,$month,$day,$shop_name){

	/*
	$card_flg=0;
	$data = get_sale_price_by_shop_name_3($year,$month,$day,$shop_name,$card_flg);
	$price_genkin = $data["price"];
	$card_commission_free_genkin = $data["card_commission_free"];
	$card_flg=1;
	$data = get_sale_price_by_shop_name_3($year,$month,$day,$shop_name,$card_flg);
	$price_card = $data["price"];
	$card_commission_free_card = $data["card_commission_free"];
	*/

	$data = get_sale_price_by_shop_name_4($year,$month,$day,$shop_name);

	$price_genkin = $data["price_genkin"];
	$price_card = $data["price_card"];
	$card_commission_free = $data["card_commission_free"];

	$data["genkin_price"] = $price_genkin;
	$data["card_price"] = $price_card;
	$data["card_commission"] = $card_commission_free;

	return $data;
	exit();

}

function get_attendance_disp_time_driver($start_time,$end_time){

	include(INC_PATH."/define.php");

	$data = "";

	$hour_start = $time_array_driver[$start_time]["hour"];
	$minute_start = $time_array_driver[$start_time]["minute"];
	$hour_end = $time_array_driver[$end_time]["hour"];
	$minute_end = $time_array_driver[$end_time]["minute"];

	if( $hour_start >= 24 ){

		$hour_start = $hour_start - 24;

	}

	if( $hour_end >= 24 ){

		$hour_end = $hour_end - 24;

	}

	if($minute_start != "0"){

		$hour_start = $hour_start.".5";

	}

	if($minute_end != "0"){

		$hour_end = $hour_end.".5";

	}

	$data = $hour_start."-".$hour_end;

	return $data;
	exit();

}

function get_chief_allowance_start_time_for_therapist_edit($year,$month,$day){

	if( ($year == "-1") || ($month == "-1") || ($day == "-1") ){

		$timestamp = 0;

	}else{

		$timestamp = get_timestamp_by_year_month_day_common($year,$month,$day);

	}

	return $timestamp;
	exit();

}

//セラピスト情報更新(2)
function update_therapist_edit_man_2(
$therapist_id,$mail,$name_real,$name_site,$kenmu,$rank,$name_aroma,$name_tgr,$name_lymph,$jitaku_taiki_flg,
$for_kobetsu_url,$kensyuu_flg,$jisou_flg,$driver_kenmu_flg,$point_ref,$guarantee_rule,$point_fix,$address,$tel,
$bank_info,$total_point,$name_furi,$furikomi_type,$chief_allowance,$transport_cost,
$chief_allowance_start_time,$name_man,$type_man,$password_man){

	$rank_order_num = get_rank_order_num($rank);

	if( $jitaku_taiki_flg != "1" ){
		$jitaku_taiki_flg = 0;
	}

	if( $jisou_flg != "1" ){
		$jisou_flg = 0;
	}

	if( $driver_kenmu_flg != "1" ){
		$driver_kenmu_flg = 0;
	}

	$kenmu_string = "";

	$kenmu_num = count($kenmu);

	if( $kenmu_num > 0 ){

		for($i=0;$i<$kenmu_num;$i++){

			$kenmu_string .= $kenmu[$i];

			if( $i != ($kenmu_num-1) ){

				$kenmu_string .= $kenmu_string.",";

			}

		}

	}

	$name_real = trim($name_real);
	$name_site = trim($name_site);
	$name_aroma = trim($name_aroma);

$sql = sprintf("
update therapist_new set
name='%s',
mail='%s',
name_site='%s',
name_aroma='%s',
name_tgr='%s',
name_lymph='%s',
kenmu='%s',
rank='%s',
jitaku_taiki_flg='%s',
for_kobetsu_url='%s',
kensyuu_flg='%s',
jisou_flg='%s',
driver_kenmu_flg='%s',
rank_order_num='%s',
point_ref='%s',
guarantee_rule='%s',
point_fix='%s',
address='%s',
tel='%s',
bank_info='%s',
total_point='%s',
name_furi='%s',
furikomi_type='%s',
chief_allowance='%s',
transport_cost='%s',
chief_allowance_start_time='%s',
name_man='%s',
type_man='%s',
password_man='%s'
where id='%s'",
$name_real,$mail,$name_site,$name_aroma,$name_tgr,$name_lymph,$kenmu_string,$rank,$jitaku_taiki_flg,
$for_kobetsu_url,$kensyuu_flg,$jisou_flg,$driver_kenmu_flg,$rank_order_num,$point_ref,$guarantee_rule,
$point_fix,$address,$tel,$bank_info,$total_point,$name_furi,$furikomi_type,$chief_allowance,
$transport_cost,$chief_allowance_start_time,$name_man,$type_man,$password_man,
$therapist_id);

	//echo $sql;
	//exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリ実行に失敗しました(update_therapist_edit_man_2)";
		exit();

	}

	return true;
	exit();

}

function get_chief_allowance_start_time_string_for_therapist_list($chief_allowance_start_time){

	$chief_allowance_start_time_string = "";

	if( $chief_allowance_start_time == "0" ){

		$chief_allowance_start_time_string = "---";

	}else{

		$data = get_day_by_timestamp_common($chief_allowance_start_time);

		$year = $data["year"];
		$month = $data["month"];
		$day = $data["day"];

		$chief_allowance_start_time_string = $year."/".$month."/".$day;

	}

	return $chief_allowance_start_time_string;
	exit();

}

function get_movement_cost_data_for_sale_move_cost($year,$month,$day,$area,$type){

	if( $type == "confirm" ){

		$where_add = "staff_id_approve='-1' and staff_id_confirm<>'-1'";

	}else if( $type == "not_confirm" ){

		$where_add = "staff_id_confirm='-1'";

	}else{

		$where_add = "1=1";

	}

	if( $area == "all" ){

$sql = sprintf("
select * from movement_cost where
delete_flg='0' and
year='%s' and
month='%s' and
day='%s' and %s",
$year,$month,$day,$where_add);

	}else{

$sql = sprintf("
select * from movement_cost where
delete_flg='0' and
year='%s' and
month='%s' and
day='%s' and
area='%s' and %s",
$year,$month,$day,$area,$where_add);

	}

	$res = mysql_query($sql, DbCon);
	echo $res . "/" . $sql;
	if($res == false){

		echo "error!(get_movement_cost_data_for_sale_move_cost)";
		exit();

	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$therapist_id = $row["therapist_id"];
		$reservation_for_board_id = $row["reservation_for_board_id"];
		$area = $row["area"];
		$movement_method = $row["movement_method"];

		$therapist_name = get_therapist_name_by_therapist_id_honmyou_common($therapist_id);
		$shop_name = get_shop_name_by_reservation_for_board_id_common($reservation_for_board_id);
		$area_name = get_area_name_by_area_common($area);
		$movement_method_name = get_movement_method_name($movement_method);

		$list_data[$i] = $row;
		$list_data[$i]["therapist_name"] = $therapist_name;
		$list_data[$i]["shop_name"] = $shop_name;
		$list_data[$i]["shop_area_name"] = $area_name;
		$list_data[$i]["movement_method_name"] = $movement_method_name;
		$i++;

	}

	return $list_data;
	exit();

}

function get_movement_method_name($movement_method){

	$data = "不明";

	if( $movement_method == "1" ){

		$data = "タクシー";

	}else if( $movement_method == "2" ){

		$data = "電車";

	}

	return $data;
	exit();

}

function get_staff_select_frm_2($staff_id,$staff_type,$area){

	$selected_value = $staff_id."_".$staff_type;

	$boss_data = get_boss_data($area);

	/*
	echo "<pre>";
	print_r($boss_data);
	echo "</pre>";
	exit();
	*/

	$boss_data_num = count($boss_data);

	$chief_data = get_chief_therapist_data($area);

	/*
	echo "<pre>";
	print_r($chief_data);
	echo "</pre>";
	exit();
	*/

	$chief_data_num = count($chief_data);

	//echo $boss_data_num;exit();

	$html .= '<select name="staff_id">';

	$html .= '<option value="-1">未選択</option>';

	for($i=0;$i<$boss_data_num;$i++){

		$id = $boss_data[$i]["id"];
		$name = $boss_data[$i]["name"];

		$value = $id."_staff";

		if( $value == $selected_value ){

			$html .= sprintf('<option value="%s" selected>%s</option>',$value,$name);

		}else{

			$html .= sprintf('<option value="%s">%s</option>',$value,$name);

		}

	}

	for($i=0;$i<$chief_data_num;$i++){

		$id = $chief_data[$i]["id"];
		$name = $chief_data[$i]["name"];

		$value = $id."_therapist";

		if( $value == $selected_value ){

			$html .= sprintf('<option value="%s" selected>%s</option>',$value,$name);

		}else{

			$html .= sprintf('<option value="%s">%s</option>',$value,$name);

		}

	}

	$html .= '</select>';

	return $html;
	exit();

}

//店長取得
function get_boss_data($area){

	$sql = sprintf("
select * from staff_new_new where delete_flg='0' and boss_flg='1' and area='%s'",
$area);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(get_boss_data)";
		exit();

	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$list_data[$i++] = $row;

	}

	return $list_data;
	exit();

}

function get_confirm_num_for_movement_cost($year,$month,$day,$area){

	$board_data = get_movement_cost_data_for_sale_move_cost($year,$month,$day,$area);

	$board_data_num = count($board_data);

	$all_num = 0;
	$confirm_num = 0;
	$not_confirm_num = 0;

	for($i=0;$i<$board_data_num;$i++){

		$staff_id_confirm = $board_data[$i]["staff_id_confirm"];
		$staff_id_approve = $board_data[$i]["staff_id_approve"];

		if( $staff_id_confirm == "-1" ){

			$not_confirm_num++;

		}else{

			if( $staff_id_approve == "-1" ){

				$confirm_num++;

			}

		}

		$all_num++;

	}

	$data["all_num"] =$all_num;
	$data["confirm_num"] =$confirm_num;
	$data["not_confirm_num"] =$not_confirm_num;

	return $data;
	exit();

}

function delete_attendance_staff_new_future_by_staff_id($staff_id){

	$year = intval(date('Y'));
	$month = intval(date('m'));
	$day = intval(date('d'));

	$sql = sprintf("
delete from attendance_staff_new
where
staff_id='%s' and
(
(year>'%s') or
((year='%s') and (month>'%s')) or
((year='%s') and (month='%s') and (day>='%s'))
)",
$staff_id,$year,$year,$month,$year,$month,$day);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(delete_attendance_staff_new_future_by_staff_id)";
		exit();

	}

	return true;
	exit();

}

function staff_leave_action($staff_id){

	$sql = sprintf("update staff_new_new set leave_flg=1 where id='%s'",$staff_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(staff_leave_action)";
		exit();
	}

	return true;
	exit();
}

function get_staff_data_at_staff_list_leave($area,$type){

	$sql = sprintf("select * from staff_new_new where delete_flg=0 and leave_flg=1 and type='%s' and area='%s' order by order_num desc",$type,$area);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_staff_data_at_staff_list_new)";
		exit();
	}

	$staff_data = array();

	$i=0;
	while($row = mysql_fetch_assoc($res)){
		$staff_data[$i++] = $row;
	}

	return $staff_data;
	exit();

}

function staff_return_action($staff_id){

	$sql = sprintf("update staff_new_new set leave_flg=0 where id='%s'",$staff_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(staff_return_action)";
		exit();
	}

	return true;
	exit();
}

function get_chief_therapist_data($area){

	$sql = sprintf("select * from therapist_new where delete_flg='0' and chief_allowance<>'-1' and area='%s'",$area);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_chief_therapist_data)";
		exit();
	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$list_data[$i++] = $row;

	}

	return $list_data;
	exit();
}

function update_staff_confirm_movement_cost($staff_id_value,$movement_cost_id){

	$pieces = explode("_", $staff_id_value);

	$staff_id = $pieces[0];
	$staff_type = $pieces[1];

	$sql = sprintf("update movement_cost set staff_id_confirm='%s',staff_type_confirm='%s' where id='%s'",$staff_id,$staff_type,$movement_cost_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(update_staff_confirm_movement_cost)";
		exit();
	}

	return true;
	exit();
}

function update_staff_confirm_and_approve_movement_cost($staff_id_value,$movement_cost_id,$type){

	if( $type == "confirm" ){

$sql = sprintf("
update movement_cost set staff_id_confirm='%s' where id='%s'",
$staff_id_value,$movement_cost_id);

	}else if( $type == "approve" ){

$sql = sprintf("
update movement_cost set staff_id_approve='%s' where id='%s'",
$staff_id_value,$movement_cost_id);

	}else{

		echo "error!(update_staff_confirm_and_approve_movement_cost)";
		exit();

	}

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(update_staff_confirm_and_approve_movement_cost)";
		exit();

	}

	return true;
	exit();

}

function update_staff_approve_movement_cost($staff_id_value,$movement_cost_id){

	$pieces = explode("_", $staff_id_value);

	$staff_id = $pieces[0];
	$staff_type = $pieces[1];

$sql = sprintf("
update movement_cost set staff_id_approve='%s',staff_type_approve='%s' where id='%s'",
$staff_id,$staff_type,$movement_cost_id);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(update_staff_approve_movement_cost)";
		exit();

	}

	return true;
	exit();

}

function get_sale_price_by_shop_name_4($year,$month,$day,$shop_name){

	$sql = sprintf("
select
sale_history.price,
reservation_for_board.card_flg,
reservation_for_board.card_price_free,
reservation_for_board.card_commission_free,
reservation_for_board.card_commission_type
from reservation_for_board
left join sale_history on sale_history.reservation_no=reservation_for_board.reservation_no
where
reservation_for_board.shop_name='%s' and
reservation_for_board.year='%s' and
reservation_for_board.month='%s' and
reservation_for_board.day='%s' and
reservation_for_board.delete_flg=0 and
sale_history.delete_flg=0 and
sale_history.eigyou_year='%s' and
sale_history.eigyou_month='%s' and
sale_history.eigyou_day='%s'",
$shop_name,$year,$month,$day,$year,$month,$day);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_sale_price_by_shop_name_4)";
		exit();

	}

	$price_genkin_all = 0;
	$price_card_all = 0;
	$card_commission_free_all = 0;

	while($row = mysql_fetch_assoc($res)){

		$price_tmp = $row["price"];
		$card_price_free = $row["card_price_free"];
		$card_commission_free_tmp = $row["card_commission_free"];
		$card_commission_type = $row["card_commission_type"];
		$card_flg = $row["card_flg"];

		$type = "genkin";
		$price_genkin = get_price_genkin_or_card_2_common($price_tmp,$card_price_free,$type,$card_flg);

		$type = "card";
		$price_card = get_price_genkin_or_card_2_common($price_tmp,$card_price_free,$type,$card_flg);

		$card_commission_free = get_card_commission_free_for_sale_shop_2_common(
$card_commission_type,$price_card,$card_commission_free_tmp);

		$price_genkin_all = $price_genkin_all + $price_genkin;
		$price_card_all = $price_card_all + $price_card;

		$card_commission_free_all = $card_commission_free_all + $card_commission_free;

	}

	$data["price_genkin"] = $price_genkin_all;
	$data["price_card"] = $price_card_all;
	$data["card_commission_free"] = $card_commission_free_all;

	return $data;
	exit();

}

function get_movement_cost_data_for_sale_move_cost_by_therapist_id($year,$month,$day,$therapist_id){

$sql = sprintf("
select * from movement_cost where
delete_flg='0' and
year='%s' and
month='%s' and
day='%s' and
therapist_id='%s'",
$year,$month,$day,$therapist_id);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(get_movement_cost_data_for_sale_move_cost_by_therapist_id)";
		exit();

	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$therapist_id = $row["therapist_id"];
		$reservation_for_board_id = $row["reservation_for_board_id"];
		$area = $row["area"];
		$movement_method = $row["movement_method"];

		$therapist_name = get_therapist_name_by_therapist_id_honmyou_common($therapist_id);
		$shop_name = get_shop_name_by_reservation_for_board_id_common($reservation_for_board_id);
		$area_name = get_area_name_by_area_common($area);
		$movement_method_name = get_movement_method_name($movement_method);

		$list_data[$i] = $row;
		$list_data[$i]["therapist_name"] = $therapist_name;
		$list_data[$i]["shop_name"] = $shop_name;
		$list_data[$i]["shop_area_name"] = $area_name;
		$list_data[$i]["movement_method_name"] = $movement_method_name;
		$i++;

	}

	return $list_data;
	exit();

}

function get_login_type_select($type,$type_man,$area){

	$html = '<select name="type_man">';

	$html .= '<option value="">未選択</option>';

	if( $type == "honbu" ){

		if( $type_man == "1" ){

			$html .= '<option value="1" selected>すべてのページ</option>';
			$html .= '<option value="2">スタッフカレンダー、予約状況ボード</option>';

		}else if( $type_man == "2" ){

			$html .= '<option value="1">すべてのページ</option>';
			$html .= '<option value="2" selected>スタッフカレンダー、予約状況ボード</option>';

		}else{

			$html .= '<option value="1">すべてのページ</option>';
			$html .= '<option value="2">スタッフカレンダー、予約状況ボード</option>';

		}

	}else if( ($area=="tokyo") && ($type=="driver") ){

		if( $type_man == "2" ){

			$html .= '<option value="2" selected>スタッフカレンダー、予約状況ボード</option>';

		}else{

			$html .= '<option value="2">スタッフカレンダー、予約状況ボード</option>';

		}

	}else if( ($area=="yokohama") && ($type=="driver") ){

		if( $type_man == "21" ){

			$html .= '<option value="21" selected>エリア責任者</option>';
			$html .= '<option value="24">ドライバー権限</option>';

		}else if( $type_man == "24" ){

			$html .= '<option value="21">エリア責任者</option>';
			$html .= '<option value="24" selected>ドライバー権限</option>';

		}else{

			$html .= '<option value="21">エリア責任者</option>';
			$html .= '<option value="24">ドライバー権限</option>';

		}

	}else if( ($area=="sapporo") && ($type=="driver") ){

		if( $type_man == "11" ){

			$html .= '<option value="11" selected>エリア責任者</option>';
			$html .= '<option value="13">ドライバー責任者</option>';
			$html .= '<option value="15">ドライバー権限</option>';

		}else if( $type_man == "13" ){

			$html .= '<option value="11">エリア責任者</option>';
			$html .= '<option value="13" selected>ドライバー責任者</option>';
			$html .= '<option value="15">ドライバー権限</option>';

		}else if( $type_man == "15" ){

			$html .= '<option value="11">エリア責任者</option>';
			$html .= '<option value="13">ドライバー責任者</option>';
			$html .= '<option value="15" selected>ドライバー権限</option>';

		}else{

			$html .= '<option value="11">エリア責任者</option>';
			$html .= '<option value="13">ドライバー責任者</option>';
			$html .= '<option value="15">ドライバー権限</option>';

		}

	}else if( ($area=="sendai") && ($type=="driver") ){

		if( $type_man == "51" ){

			$html .= '<option value="51" selected>エリア責任者</option>';
			$html .= '<option value="53">ドライバー権限</option>';
			$html .= '<option value="54">ドライバー責任者</option>';

		}else if( $type_man == "53" ){

			$html .= '<option value="51">エリア責任者</option>';
			$html .= '<option value="53" selected>ドライバー権限</option>';
			$html .= '<option value="54">ドライバー責任者</option>';

		}else if( $type_man == "54" ){

			$html .= '<option value="51">エリア責任者</option>';
			$html .= '<option value="53">ドライバー権限</option>';
			$html .= '<option value="54" selected>ドライバー責任者</option>';

		}else{

			$html .= '<option value="51">エリア責任者</option>';
			$html .= '<option value="53">ドライバー権限</option>';
			$html .= '<option value="54">ドライバー責任者</option>';

		}

	}else if( ($area=="osaka") && ($type=="driver") ){

		if( $type_man == "41" ){

			$html .= '<option value="41" selected>エリア責任者</option>';
			$html .= '<option value="43">ドライバー権限</option>';

		}else if( $type_man == "43" ){

			$html .= '<option value="41">エリア責任者</option>';
			$html .= '<option value="43" selected>ドライバー権限</option>';

		}else{

			$html .= '<option value="41">エリア責任者</option>';
			$html .= '<option value="43">ドライバー権限</option>';

		}

	}else if( ($area=="tokyo") && ($type=="therapist") ){

		if( $type_man == "31" ){

			$html .= '<option value="31" selected>研修カレンダー</option>';

		}else{

			$html .= '<option value="31">研修カレンダー</option>';

		}

	}else if( ($area=="yokohama") && ($type=="therapist") ){

		if( $type_man == "21" ){

			$html .= '<option value="21" selected>エリア責任者</option>';
			$html .= '<option value="23">セラピスト権限</option>';

		}else if( $type_man == "23" ){

			$html .= '<option value="21">エリア責任者</option>';
			$html .= '<option value="23" selected>セラピスト権限</option>';

		}else{

			$html .= '<option value="21">エリア責任者</option>';
			$html .= '<option value="23">セラピスト権限</option>';

		}

	}else if( ($area=="sapporo") && ($type=="therapist") ){

		if( $type_man == "11" ){

			$html .= '<option value="11" selected>エリア責任者</option>';
			$html .= '<option value="14">セラピスト権限</option>';

		}else if( $type_man == "14" ){

			$html .= '<option value="11">エリア責任者</option>';
			$html .= '<option value="14" selected>セラピスト権限</option>';

		}else{

			$html .= '<option value="11">エリア責任者</option>';
			$html .= '<option value="14">セラピスト権限</option>';

		}

	}else if( ($area=="sendai") && ($type=="therapist") ){

		if( $type_man == "51" ){

			$html .= '<option value="51" selected>エリア責任者</option>';
			$html .= '<option value="52">セラピスト権限</option>';

		}else if( $type_man == "52" ){

			$html .= '<option value="51">エリア責任者</option>';
			$html .= '<option value="52" selected>セラピスト権限</option>';

		}else{

			$html .= '<option value="51">エリア責任者</option>';
			$html .= '<option value="52">セラピスト権限</option>';

		}

	}else if( ($area=="osaka") && ($type=="therapist") ){

		if( $type_man == "41" ){

			$html .= '<option value="41" selected>エリア責任者</option>';
			$html .= '<option value="42">セラピスト権限</option>';

		}else if( $type_man == "42" ){

			$html .= '<option value="41">エリア責任者</option>';
			$html .= '<option value="42" selected>セラピスト権限</option>';

		}else{

			$html .= '<option value="41">エリア責任者</option>';
			$html .= '<option value="42">セラピスト権限</option>';

		}

	}

	$html .= "</select>";

	return $html;
	exit();

}

function get_type_man_name($type_man,$area,$type){

	$data = "";

	if( $type == "honbu" ){

		if( $type_man == "1" ){

			$data = "すべてのページ";

		}else if( $type_man == "2" ){

			$data = "スタッフカレンダー、予約状況ボード";

		}

	}else if( ($area=="tokyo") && ($type=="driver") ){

		if( $type_man == "2" ){

			$data = "スタッフカレンダー、予約状況ボード";

		}

	}else if( ($area=="yokohama") && ($type=="driver") ){

		if( $type_man == "21" ){

			$data = "エリア責任者";

		}else if( $type_man == "24" ){

			$data = "ドライバー権限";

		}

	}else if( ($area=="sapporo") && ($type=="driver") ){

		if( $type_man == "11" ){

			$data = "エリア責任者";

		}else if( $type_man == "13" ){

			$data = "ドライバー責任者";

		}else if( $type_man == "15" ){

			$data = "ドライバー権限";

		}

	}else if( ($area=="sendai") && ($type=="driver") ){

		if( $type_man == "51" ){

			$data = "エリア責任者";

		}else if( $type_man == "53" ){

			$data = "ドライバー権限";

		}else if( $type_man == "54" ){

			$data = "ドライバー責任者";

		}

	}else if( ($area=="osaka") && ($type=="driver") ){

		if( $type_man == "41" ){

			$data = "エリア責任者";

		}else if( $type_man == "43" ){

			$data = "ドライバー権限";

		}

	}else if( ($area=="tokyo") && ($type=="therapist") ){

		if( $type_man == "31" ){

			$data = "研修カレンダー";

		}

	}else if( ($area=="yokohama") && ($type=="therapist") ){

		if( $type_man == "21" ){

			$data = "エリア責任者";

		}else if( $type_man == "23" ){

			$data = "セラピスト権限";

		}

	}else if( ($area=="sapporo") && ($type=="therapist") ){

		if( $type_man == "11" ){

			$data = "エリア責任者";

		}else if( $type_man == "14" ){

			$data = "セラピスト権限";

		}

	}else if( ($area=="sendai") && ($type=="therapist") ){

		if( $type_man == "51" ){

			$data = "エリア責任者";

		}else if( $type_man == "52" ){

			$data = "セラピスト権限";

		}

	}else if( ($area=="osaka") && ($type=="therapist") ){

		if( $type_man == "41" ){

			$data = "エリア責任者";

		}else if( $type_man == "42" ){

			$data = "セラピスト権限";

		}

	}

	return $data;
	exit();

}

function check_exist_name_man($name_man){

	$match_flg = false;

$sql = sprintf("
select id from staff_new_new where
delete_flg=0 and
name_man='%s'",
$name_man);

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(check_exist_name_man)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	if( $row["id"] != "" ){

		$match_flg = true;

	}

$sql = sprintf("
select id from therapist_new where
delete_flg=0 and
name_man='%s'",
$name_man);

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(check_exist_name_man)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	if( $row["id"] != "" ){

		$match_flg = true;

	}

	return $match_flg;
	exit();

}

function login_action_man($name,$password){

$sql = sprintf("
select * from staff_new_new where name_man='%s' and password_man='%s' and
(
type_man='1' or
type_man='2' or
type_man='11' or
type_man='12' or
type_man='13' or
type_man='21' or
type_man='22' or
type_man='31' or
type_man='41' or
type_man='51' or
type_man='14' or
type_man='15' or
type_man='23' or
type_man='24' or
type_man='42' or
type_man='43' or
type_man='52' or
type_man='53' or
type_man='54'
)",
$name,$password);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(login_action_man)";
		exit();

	}

	$num = mysql_num_rows($res);

	if( $num > 0 ){

		$row = mysql_fetch_array($res);

		return $row;
		exit();

	}

$sql = sprintf("
select * from therapist_new where name_man='%s' and password_man='%s' and
(
type_man='1' or
type_man='2' or
type_man='11' or
type_man='12' or
type_man='13' or
type_man='21' or
type_man='22' or
type_man='31' or
type_man='41' or
type_man='51' or
type_man='14' or
type_man='15' or
type_man='23' or
type_man='24' or
type_man='42' or
type_man='43' or
type_man='52' or
type_man='53' or
type_man='54'
)",
$name,$password);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(login_action_man)";
		exit();

	}

	$num = mysql_num_rows($res);

	if( $num > 0 ){

		$row = mysql_fetch_array($res);

		return $row;
		exit();

	}

	return false;
	exit();

}

//オートログインをセット
function set_auto_login_2($login_staff_type,$login_staff_id){

	$cookie_value = md5(time()."-".$login_staff_type."-".$login_staff_id);

	if( $login_staff_type == "therapist" ){

$sql = sprintf("
update therapist_new set cookie_value_man='%s' where id='%s'",
$cookie_value,$login_staff_id);

	}else{

$sql = sprintf("
update staff_new_new set cookie_value_man='%s' where id='%s'",
$cookie_value,$login_staff_id);

	}

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(set_auto_login_2)";
		return false;
		exit();

	}else{

		setcookie ("RefleAutoLogin", $cookie_value, time()+(60*60*24*30)); // 有効期限30日

		return true;
		exit();

	}

}

//オートログインをチェック
function check_auto_login_2(){

	if( isset($_COOKIE["RefleAutoLogin"]) == true ){

		$auto_login_key = $_COOKIE["RefleAutoLogin"];

		$sql = sprintf("select * from staff_new_new where delete_flg=0 and leave_flg=0 and cookie_value_man='%s'",$auto_login_key);

		$res = mysql_query($sql, DbCon);

		if($res == false){

			echo "error!(check_auto_login_2)";
			exit();

		}

		$num = mysql_num_rows($res);

		if($num > 0){

			$row = mysql_fetch_array($res);

			$login_staff_name_man = $row["name_man"];
			$login_staff_id = $row["id"];
			$login_staff_type_2 = $row["type"];

			$login_staff_login_auth_type = $row["login_auth_type"];
			$login_staff_area = $row["area"];

			if( $login_staff_type_2 == "" ){

				$login_staff_type_2 = "therapist";

			}

			$_SESSION["login_staff_name_man"] = $login_staff_name_man;
			$_SESSION["login_staff_id"] = $login_staff_id;
			$_SESSION["login_staff_type_2"] = $login_staff_type_2;
			$_SESSION["ticket_man"] = md5(TICKET_WORD.$login_staff_name_man);

			$_SESSION["login_staff_login_auth_type"] = $login_staff_login_auth_type;
			$_SESSION["login_staff_area"] = $login_staff_area;

			set_auto_login_2($login_staff_type_2,$login_staff_id);

			return true;
			exit();

		}

		$sql = sprintf("select * from therapist_new where delete_flg=0 and leave_flg=0 and cookie_value_man='%s'",$auto_login_key);

		$res = mysql_query($sql, DbCon);

		if($res == false){

			echo "error!(check_auto_login_2)";
			exit();

		}

		$num = mysql_num_rows($res);

		if($num > 0){

			$row = mysql_fetch_array($res);

			$login_staff_name_man = $row["name_man"];
			$login_staff_id = $row["id"];
			$login_staff_type_2 = $row["type"];

			$login_staff_login_auth_type = $row["login_auth_type"];
			$login_staff_area = $row["area"];

			if( $login_staff_type_2 == "" ){

				$login_staff_type_2 = "therapist";

			}

			$_SESSION["login_staff_name_man"] = $login_staff_name_man;
			$_SESSION["login_staff_id"] = $login_staff_id;
			$_SESSION["login_staff_type_2"] = $login_staff_type_2;
			$_SESSION["ticket_man"] = md5(TICKET_WORD.$login_staff_name_man);

			$_SESSION["login_staff_login_auth_type"] = $login_staff_login_auth_type;
			$_SESSION["login_staff_area"] = $login_staff_area;

			set_auto_login_2($login_staff_type_2,$login_staff_id);

			return true;
			exit();

		}

	}

	return false;
	exit();

}

function get_name_man_from_staff_new_new($id){

	$sql = sprintf("select name_man from staff_new_new where id='%s'",$id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_name_man_from_staff_new_new)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row["name_man"];
	exit();
}

function get_name_man_from_therapist_new($id){

	$sql = sprintf("select name_man from therapist_new where id='%s'",$id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_name_man_from_therapist_new)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row["name_man"];
	exit();
}

function get_staff_select_frm_for_sale_operation($staff_id,$login_staff_id,$login_staff_type_2,$type){

	$html = "";

	if( $login_staff_type_2 == "therapist" ){

		$login_staff_name = get_therapist_name_by_therapist_id_honmyou_common($login_staff_id);

		$login_staff_id = $login_staff_id."_therapist";

	}else{

		$login_staff_name = get_staff_name_by_id_common($login_staff_id);

	}

	if( ($staff_id != "-1") && ($staff_id != $login_staff_id) ){

		if (preg_match("/therapist/", $staff_id)) {

			//セラピストの場合

			$staff_id = str_replace("_therapist", "", $staff_id);

			$staff_name = get_therapist_name_by_therapist_id_honmyou_common($staff_id);

		} else {

			//スタッフの場合

			$staff_name = get_staff_name_by_id_common($staff_id);

		}

		$html .= $staff_name;

		return $html;
		exit();

	}

	$html .= '<div style="float:left;">';

	$html .= '<select name="staff_id">';

	$html .= '<option value="-1">未選択</option>';

	if( $staff_id == $login_staff_id ){

		$html .= sprintf('<option value="%s" selected>%s</option>',$login_staff_id,$login_staff_name);

	}else{

		$html .= sprintf('<option value="%s">%s</option>',$login_staff_id,$login_staff_name);

	}

	$html .= '</select>';

	$html .= '</div>';
	$html .= '<div style="float:left;padding-left:10px;">';

	if( $type == "confirm" ){

		$html .= '<input type="submit" name="send_staff_id_confirm" value="設定" style="padding:5px;" />';

	}else if( $type == "approve" ){

		$html .= '<input type="submit" name="send_staff_id_approve" value="設定" style="padding:5px;" />';

	}

	$html .= '</div>';
	$html .= '<br class="clear" />';

	return $html;
	exit();

}

function get_staff_select_frm_for_sale_move_cost(
$staff_id,$login_staff_login_auth_type,$login_staff_id,$login_staff_type_2,$type,$area){

	$html = "";

	if( $login_staff_type_2 == "therapist" ){

		$login_staff_name = get_therapist_name_by_therapist_id_honmyou_common($login_staff_id);

		$login_staff_id = $login_staff_id."_therapist";

	}else{

		$login_staff_name = get_staff_name_by_id_common($login_staff_id);

	}

	if( ($staff_id != "-1") && ($staff_id != $login_staff_id) ){

		if (preg_match("/therapist/", $staff_id)) {

			//セラピストの場合

			$staff_id = str_replace("_therapist", "", $staff_id);

			$staff_name = get_therapist_name_by_therapist_id_honmyou_common($staff_id);

		} else {

			//スタッフの場合

			$staff_name = get_staff_name_by_id_common($staff_id);

		}

		$html .= $staff_name;

		return $html;
		exit();

	}

	$result_check = check_sale_move_cost_2($login_staff_login_auth_type);

	$html .= '<div style="float:left;">';

	$html .= '<select name="staff_id">';

	$html .= '<option value="-1">未選択</option>';

	if( $result_check == true ){

		if( $staff_id == $login_staff_id ){

			$html .= sprintf('<option value="%s" selected>%s</option>',$login_staff_id,$login_staff_name);

		}else{

			$html .= sprintf('<option value="%s">%s</option>',$login_staff_id,$login_staff_name);

		}

	}

	$html .= '</select>';

	$html .= '</div>';
	$html .= '<div style="float:left;padding-left:10px;">';

	if( $type == "confirm" ){

		$html .= '<input type="submit" name="send_staff_id_confirm" value="設定" style="padding:5px;" />';

	}else if( $type == "approve" ){

		$html .= '<input type="submit" name="send_staff_id_approve" value="設定" style="padding:5px;" />';

	}

	$html .= '</div>';
	$html .= '<br class="clear" />';

	return $html;
	exit();

}

function check_sale_move_cost($login_staff_type_man,$area){

	$result = false;

	if( $area=="yokohama" ){

		if( $login_staff_type_man == "21" ){

			$result = true;

		}

	}else if( $area=="sapporo" ){

		if( $login_staff_type_man == "11" ){

			$result = true;

		}

	}else if( $area=="sendai" ){

		if( $login_staff_type_man == "51" ){

			$result = true;

		}

	}else if( $area=="osaka" ){

		if( $login_staff_type_man == "41" ){

			$result = true;

		}

	}else if( $area=="tokyo" ){

		if( $login_staff_type_man == "1" ){

			$result = true;

		}

	}

	return $result;
	exit();

}

//セラピストページの削除
function delete_therapist_page_2($therapist_page_id){

	$sql = sprintf("update therapist_page set delete_flg='1' where id='%s'",$therapist_page_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(delete_therapist_page_2)";
		exit();
	}

	return true;
	exit();
}

function get_day_link_for_therapist_page($year,$month,$day,$area,$rinpa,$tai,$stretch,$strong,$exp,$lng,$order_type){

	$html = sprintf('<a href="therapist_page.php?area=%s&year=%s&month=%s&day=%s&rinpa=%s&tai=%s&stretch=%s&strong=%s&exp=%s&lng=%s&order_type=%s">%s/%s</a>',
$area,$year,$month,$day,$rinpa,$tai,$stretch,$strong,$exp,$lng,$order_type,$month,$day);

	return $html;
	exit();

}

function page_day_disp_for_therapist_page($year,$month,$day){

	if( ($year=="") || ($month=="") || ($day=="") ){

		$html = "全件";

	}else{

		$html = $month."/".$day;

	}

	return $html;
	exit();

}

function get_day_link_disp_for_therapist_page($year,$month,$day,$area,$rinpa,$tai,$stretch,$strong,$exp,$lng,$order_type){

	$zenken_flg = false;

	if( ($year=="") || ($month=="") || ($day=="") ){

		$zenken_flg = true;

	}

	$data = get_today_year_month_day_common();

	$year_today = $data["year"];
	$month_today = $data["month"];
	$day_today = $data["day"];

	$num = 1;
	$data = get_next_day_common($year_today,$month_today,$day_today,$num);

	$year_next = $data["year"];
	$month_next = $data["month"];
	$day_next = $data["day"];

	$link_today = get_day_link_for_therapist_page($year_today,$month_today,$day_today,$area,$rinpa,$tai,$stretch,$strong,$exp,$lng,$order_type);

	$link_next_day = get_day_link_for_therapist_page($year_next,$month_next,$day_next,$area,$rinpa,$tai,$stretch,$strong,$exp,$lng,$order_type);

	$link_all = sprintf('<a href="therapist_page.php?area=%s&rinpa=%s&tai=%s&stretch=%s&strong=%s&exp=%s&lng=%s&order_type=%s">全件</a>',$area,$rinpa,$tai,$stretch,$strong,$exp,$lng,$order_type);

	$html = "";

$html .= '<div style="padding:10px 0px 0px 0px;">';

if( ($year==$year_today) && ($month==$month_today) && ($day==$day_today) ){
	$html .= sprintf('<div style="float:left;font-weight:bold;">%s/%s</div>',$month_today,$day_today);
}else{
	$html .= '<div style="float:left;">'.$link_today.'</div>';
}

if( ($year==$year_next) && ($month==$month_next) && ($day==$day_next) ){
	$html .= sprintf('<div style="float:left;padding-left:30px;font-weight:bold;">%s/%s</div>',$month_next,$day_next);
}else{
	$html .= '<div style="float:left;padding-left:30px;">'.$link_next_day.'</div>';
}

if( $zenken_flg == true ){
	$html .= '<div style="float:left;padding-left:30px;font-weight:bold;">全件</div>';
}else{
	$html .= '<div style="float:left;padding-left:30px;">'.$link_all.'</div>';
}

$html .= '<br class="clear" />';
$html .= '</div>';

	return $html;
	exit();

}

function select_therapist_page_data_for_therapist_page($therapist_page,$year,$month,$day){

	$data = array();
	$x = 0;

	$therapist_page_num = count($therapist_page);

	for($i=0;$i<$therapist_page_num;$i++){

		$therapist_id = $therapist_page[$i]["therapist_id"];

		$result = check_attendance_new_exist_by_therapist_id_common($year,$month,$day,$therapist_id);

		if( $result == true ){

			$data[$x] = $therapist_page[$i];
			$x++;

		}

	}

	return $data;
	exit();

}

function erase_img_url_at_therapist_page($therapist_page_id){

	$sql = sprintf("update therapist_page set img_url='',img_url_m='' where id='%s'",$therapist_page_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(erase_img_url_at_therapist_page)";
		exit();
	}

	return true;
	exit();
}

//駅データの取得
function get_station_data($shop_area){

	$sql = sprintf("select * from station_new where shop_area='%s' and delete_flg=0",$shop_area);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_station_data)";
		exit();
	}
	$i=0;
	$list_data = array();
	while($row = mysql_fetch_assoc($res)){
		$list_data[$i++] = $row;
	}

	return $list_data;
	exit();
}

//駅データの取得(札幌)
function get_station_data_sapporo(){

	$sql = "select * from station_sapporo where delete_flg=0";

	$res = mysql_query($sql, DbCon);
	if($res == false){

		echo "error!(get_station_data_sapporo)";
		exit();

	}
	$i=0;
	$list_data = array();
	while($row = mysql_fetch_assoc($res)){
		$list_data[$i++] = $row;
	}

	return $list_data;
	exit();
}

function get_search_data_array($shop_area){

	$station_data = get_station_data($shop_area);
	$station_data_num = count($station_data);

	$html .= "array(";
	$html .= "<br />";
	for($i=0;$i<$station_data_num;$i++){
		$name = $station_data[$i]["name"];
		$name = str_replace("駅", "", $name);
		$html .= sprintf('%s=>"出張マッサージ　%s",',$i,$name);
		$html .= "<br />";
	}
	$html .= ");";

	echo $html;
	exit();

}

function update_station_name_by_id($id,$name){

	$sql = sprintf("update station_new set name='%s' where id='%s'",$name,$id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(update_station_name_by_id)";
		exit();
	}

	return true;
	exit();
}

function get_repeater_num_all_2(){

	$sql = "select id from repeater where delete_flg=0";
	$res = mysql_query($sql, DbCon);
	if($res === false){
		echo "error!(get_repeater_num_all_2)";
		exit();
	}

	$num = mysql_num_rows($res);

	return $num;
	exit();
}

function get_repeater_2($paging_selected_num){

	$disp_num = 100;

	$limit_start_num = ($paging_selected_num-1)*$disp_num;

	$sql = sprintf("select * from repeater where delete_flg=0 order by created desc limit %s,%s",$limit_start_num,$disp_num);
	echo $sql;
	$res = mysql_query($sql, DbCon);
	if( $res == false ){
		echo "error!(get_repeater_2)";
		exit();
	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$list_data[$i++] = $row;

	}

	return $list_data;
	exit();

}

function update_station_name_by_id_sapporo($id,$name){

	$sql = sprintf("update station_sapporo set name='%s' where id='%s'",$name,$id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(update_station_name_by_id_sapporo)";
		exit();
	}

	return true;
	exit();
}

function get_login_auth(){

	$sql = "select * from login_auth where delete_flg=0";
	$res = mysql_query($sql, DbCon);
	if( $res == false ){
		echo "error!(get_login_auth)";
		exit();
	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$list_data[$i++] = $row;

	}

	return $list_data;
	exit();

}

function get_type_name_login_auth($type){
global $ARRAY_typeName;

	if($type >= 1 && $type <= count($ARRAY_typeName)) {
		$type_name = $ARRAY_typeName[($type - 1)];
	} else {
		$type_name = "不明";
	}

	return $type_name;
	exit();
}

function update_login_auth(
$type,$all_page,$shift_page,$shift_edit,$board_page,$board_car,$shop_sale,$operation_sale,$move_cost,
$shift_training,$shop_sale_2){

	$all_page = null_is_zero($all_page);
	$shift_page = null_is_zero($shift_page);
	$shift_edit = null_is_zero($shift_edit);
	$board_page = null_is_zero($board_page);
	$board_car = null_is_zero($board_car);
	$shop_sale = null_is_zero($shop_sale);
	$shop_sale_2 = null_is_zero($shop_sale_2);
	$operation_sale = null_is_zero($operation_sale);
	$move_cost = null_is_zero($move_cost);
	$shift_training = null_is_zero($shift_training);

	if( $type == "1" ){

		$all_page = 1;

	}else if( $type == "2" ){

		$shift_page = 1;

	}else if( $type == "3" ){

		$shift_page = 1;

	}else if( $type == "4" ){

		$shift_page = 1;

	}else if( $type == "5" ){

		$board_page = 1;

	}else if( $type == "6" ){

		$shift_training = 1;

	}

	if( $all_page == "1" ){

		$shift_page = 0;
		$shift_edit = 0;
		$board_page = 0;
		$board_car = 0;
		$shop_sale = 0;
		$shop_sale_2 = 0;
		$operation_sale = 0;
		$move_cost = 0;
		$shift_training = 0;

	}



$sql = sprintf("
update login_auth set
all_page='%s',
shift_page='%s',
shift_edit='%s',
board_page='%s',
board_car='%s',
shop_sale='%s',
shop_sale_2='%s',
operation_sale='%s',
move_cost='%s',
shift_training='%s'
where type='%s'",
$all_page,$shift_page,$shift_edit,$board_page,$board_car,$shop_sale,$shop_sale_2,$operation_sale,$move_cost,$shift_training,$type);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(update_login_auth)";
		exit();

	}

	return true;
	exit();




}

function get_login_type_select_2($type,$login_auth_type){

	$html = '<select name="login_auth_type">';

	$html .= '<option value="">未選択</option>';

	if( $type == "honbu" ){

		if( $login_auth_type == "1" ){

			$html .= '<option value="1" selected>本部</option>';

		}else{

			$html .= '<option value="1">本部</option>';

		}

	}else if( $type=="driver" ){

		if( $login_auth_type == "2" ){

			$html .= '<option value="2" selected>エリア責任者</option>';
			$html .= '<option value="4">ドライバー責任者</option>';
			$html .= '<option value="5">ドライバー</option>';

		}else if( $login_auth_type == "4" ){

			$html .= '<option value="2">エリア責任者</option>';
			$html .= '<option value="4" selected>ドライバー責任者</option>';
			$html .= '<option value="5">ドライバー</option>';

		}else if( $login_auth_type == "5" ){

			$html .= '<option value="2">エリア責任者</option>';
			$html .= '<option value="4">ドライバー責任者</option>';
			$html .= '<option value="5" selected>ドライバー</option>';

		}else{

			$html .= '<option value="2">エリア責任者</option>';
			$html .= '<option value="4">ドライバー責任者</option>';
			$html .= '<option value="5">ドライバー</option>';

		}

	}else if( $type=="therapist" ){

		if( $login_auth_type == "2" ){

			$html .= '<option value="2" selected>エリア責任者</option>';
			$html .= '<option value="3">セラピスト</option>';
			$html .= '<option value="6">マッサージ講師</option>';

		}else if( $login_auth_type == "3" ){

			$html .= '<option value="2">エリア責任者</option>';
			$html .= '<option value="3" selected>セラピスト</option>';
			$html .= '<option value="6">マッサージ講師</option>';

		}else if( $login_auth_type == "6" ){

			$html .= '<option value="2">エリア責任者</option>';
			$html .= '<option value="3">セラピスト</option>';
			$html .= '<option value="6" selected>マッサージ講師</option>';

		}else{

			$html .= '<option value="2">エリア責任者</option>';
			$html .= '<option value="3">セラピスト</option>';
			$html .= '<option value="6">マッサージ講師</option>';

		}

	}

	$html .= "</select>";

	return $html;
	exit();

}

function get_login_auth_type_name($login_auth_type){
global $ARRAY_typeName;

	if($type >= 1 && $type <= count($ARRAY_typeName)) {
		$type_name = $ARRAY_typeName[($type - 1)];
	} else {
		$type_name = "";
	}

	return $data;
}

//セラピスト情報更新(3)
function update_therapist_edit_man_3(
$therapist_id,$mail,$name_real,$name_site,$kenmu,$rank,$name_aroma,$name_tgr,$name_lymph,$jitaku_taiki_flg,
$for_kobetsu_url,$kensyuu_flg,$jisou_flg,$point_ref,$guarantee_rule,$point_fix,$address,$tel,
$bank_info,$total_point,$name_furi,$furikomi_type,$chief_allowance,$transport_cost,
$chief_allowance_start_time,$name_man,$password_man,$login_auth_type,$point_fix_start_time,
$team_id,$wait_select,$wait_txt){

	if( $wait_select == "" ){

		$wait_select = "-1";

	}

	$rank_order_num = get_rank_order_num($rank);

	if( $jitaku_taiki_flg != "1" ){
		$jitaku_taiki_flg = 0;
	}

	if( $jisou_flg != "1" ){
		$jisou_flg = 0;
	}

	$kenmu_string = "";

	$kenmu_num = count($kenmu);

	if( $kenmu_num > 0 ){

		for($i=0;$i<$kenmu_num;$i++){

			$kenmu_string .= $kenmu[$i];

			if( $i != ($kenmu_num-1) ){

				$kenmu_string .= $kenmu_string.",";

			}

		}

	}

	$name_real = trim($name_real);
	$name_site = trim($name_site);
	$name_aroma = trim($name_aroma);

	$sql = sprintf("
update therapist_new set
name='%s',
mail='%s',
name_site='%s',
name_aroma='%s',
name_tgr='%s',
name_lymph='%s',
kenmu='%s',
rank='%s',
jitaku_taiki_flg='%s',
for_kobetsu_url='%s',
kensyuu_flg='%s',
jisou_flg='%s',
rank_order_num='%s',
point_ref='%s',
guarantee_rule='%s',
point_fix='%s',
point_fix_start_time='%s',
address='%s',
tel='%s',
bank_info='%s',
total_point='%s',
name_furi='%s',
furikomi_type='%s',
chief_allowance='%s',
transport_cost='%s',
chief_allowance_start_time='%s',
name_man='%s',
login_auth_type='%s',
password_man='%s',
team_id='%s',
wait_select='%s',
wait_txt='%s'
where id='%s'",
$name_real,$mail,$name_site,$name_aroma,$name_tgr,$name_lymph,$kenmu_string,$rank,$jitaku_taiki_flg,
$for_kobetsu_url,$kensyuu_flg,$jisou_flg,$rank_order_num,$point_ref,$guarantee_rule,
$point_fix,$point_fix_start_time,$address,$tel,$bank_info,$total_point,$name_furi,$furikomi_type,$chief_allowance,
$transport_cost,$chief_allowance_start_time,$name_man,$login_auth_type,$password_man,
$team_id,$wait_select,$wait_txt,
$therapist_id);

	//echo $sql;
	//exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "クエリ実行に失敗しました(update_therapist_edit_man_3)";
		exit();

	}

	return true;
	exit();

}

//スタッフ情報更新
function update_staff_data_2(
$staff_id,$name,$mail,$tel,$kenmu,$not_num_flg,$car_type,$car_color,$car_number,$tmp_pic_url,$file_name,
$car_image_url,$boss_flg,$pay_hour,$pay_fix,$fuel,$address,$bank_info,$name_furi,$furikomi_type,
$shayousha_flg,$name_man,$login_auth_type,$password_man){

	if( $pay_hour == "-1" ){

		$pay_hour = 0;

	}

	if( $fuel == "-1" ){

		$fuel = 0;

	}

	$kenmu_string = get_kenmu_string($kenmu);

	if ( is_uploaded_file($tmp_pic_url) == TRUE ) {

		if( $file_name != "" ){

			$folder_name = ROOT_PATH."img/driver/".$staff_id;

			if(!(is_dir( $folder_name ))){

				umask(0);
				mkdir( $folder_name, 0777 );

			}

			$pic_url = $folder_name."/".$file_name;
			$img_url = "img/driver/".$staff_id."/".$file_name;

			//同名のファイルはあらかじめ削除
			unlink($pic_url);

			if(move_uploaded_file($tmp_pic_url,$pic_url)){

				$car_image_url = $img_url;

			}else{

				echo "error!(update_staff_data_2:1)";
				exit();

			}

		}

	}

	$sql = sprintf("
update staff_new_new
set
name='%s',
mail='%s',
tel='%s',
kenmu='%s',
not_num_flg='%s',
boss_flg='%s',
car_type='%s',
car_color='%s',
car_number='%s',
car_image_url='%s',
pay_hour='%s',
pay_fix='%s',
fuel='%s',
address='%s',
bank_info='%s',
name_furi='%s',
furikomi_type='%s',
shayousha_flg='%s',
name_man='%s',
login_auth_type='%s',
password_man='%s'
where id='%s'",
$name,$mail,$tel,$kenmu_string,$not_num_flg,$boss_flg,$car_type,$car_color,$car_number,
$car_image_url,$pay_hour,$pay_fix,$fuel,$address,$bank_info,$name_furi,$furikomi_type,
$shayousha_flg,$name_man,$login_auth_type,$password_man,$staff_id);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(update_staff_data_2:2)";
		exit();

	}

	return true;
	exit();

}

function login_action_man_2($name,$password){

	$sql = sprintf("
select * from staff_new_new where
delete_flg='0' and
leave_flg='0' and
name_man='%s' and
password_man='%s' and
(login_auth_type<>'0')",
$name,$password);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(login_action_man_2)";
		exit();

	}

	$num = mysql_num_rows($res);

	if( $num > 0 ){

		$row = mysql_fetch_array($res);

		return $row;
		exit();

	}

	$sql = sprintf("
select * from therapist_new where
delete_flg='0' and
leave_flg='0' and
name_man='%s' and
password_man='%s' and
(login_auth_type<>'0')",
$name,$password);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(login_action_man_2)";
		exit();

	}

	$num = mysql_num_rows($res);

	if( $num > 0 ){

		$row = mysql_fetch_array($res);

		return $row;
		exit();

	}

	return false;
	exit();

}

function allow_url_check_2($login_auth_type,$login_staff_area,$file_name,$shop_area){

	$allow_flg = false;

	$allow_area = $login_staff_area;

	//if(($shop_area == "yokohama2") || ($shop_area == "yokohama2_refres")){$shop_area = "yokohama";}

	$allow_url = get_allow_url($login_auth_type);

	if( $allow_url == "all" ){

		return true;
		exit();

	}

	$allow_url_num = count($allow_url);

	for( $i=0; $i<$allow_url_num; $i++ ){

		$allow_url_tmp = $allow_url[$i];

		//if( ( $allow_url_tmp == $file_name ) && ( $allow_area == $shop_area ) ){
		if( ( $allow_url_tmp == $file_name ) ){

			$allow_flg = true;

		}

	}

	return $allow_flg;
	exit();

}

function get_allow_url($login_auth_type){

	$page_data = get_page_data();

	$data = get_login_auth_by_type($login_auth_type);

	$all_page = $data["all_page"];
	$shift_page = $data["shift_page"];
	$shift_edit = $data["shift_edit"];
	$board_page = $data["board_page"];
	$board_car = $data["board_car"];
	$shop_sale = $data["shop_sale"];
	$shop_sale_2 = $data["shop_sale_2"];
	$operation_sale = $data["operation_sale"];
	$move_cost = $data["move_cost"];
	$shift_training = $data["shift_training"];

	$return_data = array();
	$x = 0;

	if( $all_page == "1" ){

		$return_data = "all";

	}else{

		if( $shift_page == "1" ){
			$tmp_data = $page_data["shift_page"];
			$tmp_data_num = count($tmp_data);
			for( $i=0; $i<$tmp_data_num; $i++ ){
				$url = $tmp_data[$i]["url"];
				$return_data[$x] = $url;
				$x++;
			}
		}

		if( $shift_edit == "1" ){
			$tmp_data = $page_data["shift_edit"];
			$tmp_data_num = count($tmp_data);
			for( $i=0; $i<$tmp_data_num; $i++ ){
				$url = $tmp_data[$i]["url"];
				$return_data[$x] = $url;
				$x++;
			}
		}

		if( $board_page == "1" ){
			$tmp_data = $page_data["board_page"];
			$tmp_data_num = count($tmp_data);
			for( $i=0; $i<$tmp_data_num; $i++ ){
				$url = $tmp_data[$i]["url"];
				$return_data[$x] = $url;
				$x++;
			}
		}

		if( $board_car == "1" ){
			$tmp_data = $page_data["board_car"];
			$tmp_data_num = count($tmp_data);
			for( $i=0; $i<$tmp_data_num; $i++ ){
				$url = $tmp_data[$i]["url"];
				$return_data[$x] = $url;
				$x++;
			}
		}

		if( $shop_sale == "1" ){
			$tmp_data = $page_data["shop_sale"];
			$tmp_data_num = count($tmp_data);
			for( $i=0; $i<$tmp_data_num; $i++ ){
				$url = $tmp_data[$i]["url"];
				$return_data[$x] = $url;
				$x++;
			}
		}

		if( $shop_sale_2 == "1" ){
			$tmp_data = $page_data["shop_sale_2"];
			$tmp_data_num = count($tmp_data);
			for( $i=0; $i<$tmp_data_num; $i++ ){
				$url = $tmp_data[$i]["url"];
				$return_data[$x] = $url;
				$x++;
			}
		}

		if( $operation_sale == "1" ){
			$tmp_data = $page_data["operation_sale"];
			$tmp_data_num = count($tmp_data);
			for( $i=0; $i<$tmp_data_num; $i++ ){
				$url = $tmp_data[$i]["url"];
				$return_data[$x] = $url;
				$x++;
			}
		}

		if( $move_cost == "1" ){
			$tmp_data = $page_data["move_cost"];
			$tmp_data_num = count($tmp_data);
			for( $i=0; $i<$tmp_data_num; $i++ ){
				$url = $tmp_data[$i]["url"];
				$return_data[$x] = $url;
				$x++;
			}
		}

		if( $shift_training == "1" ){
			$tmp_data = $page_data["shift_training"];
			$tmp_data_num = count($tmp_data);
			for( $i=0; $i<$tmp_data_num; $i++ ){
				$url = $tmp_data[$i]["url"];
				$return_data[$x] = $url;
				$x++;
			}
		}

	}

	return $return_data;
	exit();

}

function go_to_login_page_action(){

	reset_login_session();

	header("Location: ".WWW_URL_MAN."login.php");
	exit();

}

function reset_login_session(){

	setcookie(session_name(), "", 0);
	session_destroy();
	setcookie("RefleAutoLogin", '', time() - 60);

	return true;
	exit();

}

function get_login_auth_by_type($type){

	$sql = sprintf("select * from login_auth where delete_flg=0 and type='%s'",$type);
	$res = mysql_query($sql, DbCon);
	if( $res == false ){
		echo "error!(get_login_auth_by_type)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();
}

function get_menu($login_auth_type,$area){

	//update by aida at 20180209 from
	//$man_url = WWW_URL_MAN;
	if($_SERVER["HTTPS"]) $ws_http = "https://"; else $ws_http = "http://";
	$man_url = $ws_http . $_SERVER["SERVER_NAME"] . "/man/";
	//update by aida at 20180209 to

	$area_name = get_area_name_by_area_common($area);

	$page_data = get_page_data();

	$data = get_login_auth_by_type($login_auth_type);

	$all_page = $data["all_page"];
	$shift_page = $data["shift_page"];
	$shift_edit = $data["shift_edit"];
	$board_page = $data["board_page"];
	$board_car = $data["board_car"];
	$shop_sale = $data["shop_sale"];
	$shop_sale_2 = $data["shop_sale_2"];
	$operation_sale = $data["operation_sale"];
	$move_cost = $data["move_cost"];
	$shift_training = $data["shift_training"];

	$html = "";

	if( $all_page == "1" ){

		return "";
		exit();

	}else{

		if( $shift_page == "1" ){
			$tmp_data = $page_data["shift_page"];
			$tmp_data_num = count($tmp_data);
			for( $i=0; $i<$tmp_data_num; $i++ ){
$url = $tmp_data[$i]["url"];
$name = $tmp_data[$i]["name"];
$menu_flg = $tmp_data[$i]["menu_flg"];
if($menu_flg=="1"){
$html .=<<<EOT
<a href="{$man_url}{$url}?area={$area}">{$name}({$area_name})</a>　　
EOT;
}
			}
		}

		if( $shift_edit == "1" ){
			$tmp_data = $page_data["shift_edit"];
			$tmp_data_num = count($tmp_data);
			for( $i=0; $i<$tmp_data_num; $i++ ){
$url = $tmp_data[$i]["url"];
$name = $tmp_data[$i]["name"];
$menu_flg = $tmp_data[$i]["menu_flg"];
if($menu_flg=="1"){
$html .=<<<EOT
<a href="{$man_url}{$url}?area={$area}">{$name}({$area_name})</a>　　
EOT;
}
			}
		}

		if( $board_page == "1" ){
			$tmp_data = $page_data["board_page"];
			$tmp_data_num = count($tmp_data);
			for( $i=0; $i<$tmp_data_num; $i++ ){
$url = $tmp_data[$i]["url"];
$name = $tmp_data[$i]["name"];
$menu_flg = $tmp_data[$i]["menu_flg"];
if($menu_flg=="1"){
$html .=<<<EOT
<a href="{$man_url}{$url}?area={$area}">{$name}({$area_name})</a>　　
EOT;
}
			}
		}

		if( $board_car == "1" ){
			$tmp_data = $page_data["board_car"];
			$tmp_data_num = count($tmp_data);
			for( $i=0; $i<$tmp_data_num; $i++ ){
$url = $tmp_data[$i]["url"];
$name = $tmp_data[$i]["name"];
$menu_flg = $tmp_data[$i]["menu_flg"];
if($menu_flg=="1"){
$html .=<<<EOT
<a href="{$man_url}{$url}?area={$area}">{$name}({$area_name})</a>　　
EOT;
}
			}
		}

		if( $shop_sale == "1" ){
			$tmp_data = $page_data["shop_sale"];
			$tmp_data_num = count($tmp_data);
			for( $i=0; $i<$tmp_data_num; $i++ ){
$url = $tmp_data[$i]["url"];
$name = $tmp_data[$i]["name"];
$menu_flg = $tmp_data[$i]["menu_flg"];
if($menu_flg=="1"){
$html .=<<<EOT
<a href="{$man_url}{$url}?area={$area}">{$name}({$area_name})</a>　　
EOT;
}
			}
		}

		if( $shop_sale_2 == "1" ){
			$tmp_data = $page_data["shop_sale_2"];
			$tmp_data_num = count($tmp_data);
			for( $i=0; $i<$tmp_data_num; $i++ ){
$url = $tmp_data[$i]["url"];
$name = $tmp_data[$i]["name"];
$menu_flg = $tmp_data[$i]["menu_flg"];
if($menu_flg=="1"){
$html .=<<<EOT
<a href="{$man_url}{$url}?area={$area}">{$name}({$area_name})</a>　　
EOT;
				}
			}
		}

		if( $operation_sale == "1" ){
			$tmp_data = $page_data["operation_sale"];
			$tmp_data_num = count($tmp_data);
			for( $i=0; $i<$tmp_data_num; $i++ ){
$url = $tmp_data[$i]["url"];
$name = $tmp_data[$i]["name"];
$menu_flg = $tmp_data[$i]["menu_flg"];
if($menu_flg=="1"){
$html .=<<<EOT
<a href="{$man_url}{$url}?area={$area}">{$name}({$area_name})</a>　　
EOT;
}
			}
		}

		if( $move_cost == "1" ){
			$tmp_data = $page_data["move_cost"];
			$tmp_data_num = count($tmp_data);
			for( $i=0; $i<$tmp_data_num; $i++ ){
$url = $tmp_data[$i]["url"];
$name = $tmp_data[$i]["name"];
$menu_flg = $tmp_data[$i]["menu_flg"];
if($menu_flg=="1"){
$html .=<<<EOT
<a href="{$man_url}{$url}?area={$area}">{$name}({$area_name})</a>　　
EOT;
}
			}
		}

		if( $shift_training == "1" ){
			$tmp_data = $page_data["shift_training"];
			$tmp_data_num = count($tmp_data);
			for( $i=0; $i<$tmp_data_num; $i++ ){
$url = $tmp_data[$i]["url"];
$name = $tmp_data[$i]["name"];
$menu_flg = $tmp_data[$i]["menu_flg"];
if($menu_flg=="1"){
$html .=<<<EOT
<a href="{$man_url}{$url}?area={$area}">{$name}({$area_name})</a>　　
EOT;
}
			}
		}

if( $login_auth_type == "2" ){
$html .=<<<EOT
<a href="{$man_url}fixtures/index.php">備品状況</a>　　
EOT;
}

$html .=<<<EOT
<a href="{$man_url}logout.php">ログアウト</a>
EOT;

	}

$html =<<<EOT
<div id="staff_man_menu">{$html}</div>
EOT;

	return $html;
	exit();

}

function get_page_data(){

	$data = array(
		"shift_page" => array(
			0=>array(
				"url"=>"stf_calendar.php",		//"url"=>"staff_calendar_new.php", //update by aida at 20180209
				"name"=>"スタッフ出勤カレンダー",
				"menu_flg"=>"1"
			)
		),
		"shift_edit" => array(
			0=>array(
				"url"=>"stf_attend_edit.php",		//	"url"=>"therapist_attendance_edit_input_new.php",//update by aida at 20180209
				"name"=>"セラピスト出勤編集入力",
				"menu_flg"=>"0"
			//)				//delete by aida at 20180209
			//1=>array(
			//	"url"=>"therapist_attendance_edit_complete_new.php",
			//	"name"=>"セラピスト出勤編集完了",
			//	"menu_flg"=>"0"
			)
		),
		"board_page" => array(
			0=>array(
				"url"=>"rs_sts_board.php",		//"url"=>"reservation_status_board.php", //update by aida at 20180209
				"name"=>"予約状況ボード",
				"menu_flg"=>"1"
			)
		),
		"board_car" => array(
			0=>array(
				"url"=>"rs_sts_board_edit.php",		//"url"=>"reservation_status_board_edit.php",
				"name"=>"予約データの編集",
				"menu_flg"=>"0"
			//),
			//1=>array(
			//	"url"=>"reservation_status_board_edit_complete.php",
			//	"name"=>"予約データの編集完了",
			//	"menu_flg"=>"0"
			)
		),
		"shop_sale" => array(
			0=>array(
				"url"=>"sale_shop.php",
				"name"=>"店舗別売上",
				"menu_flg"=>"1"
			)
		),
		"shop_sale_2" => array(
			0=>array(
				"url"=>"sale_shop_2.php",
				"name"=>"店舗別売上(期間)",
				"menu_flg"=>"1"
			)
		),
		"operation_sale" => array(
			0=>array(
				"url"=>"sale_operation.php",
				"name"=>"施術別売上",
				"menu_flg"=>"1"
			)
		),
		"move_cost" => array(
			0=>array(
				"url"=>"sale_move_cost.php",
				"name"=>"移動実費一覧",
				"menu_flg"=>"1"
			),
			1=>array(
				"url"=>"sale_move_cost_one.php",
				"name"=>"移動実費一覧・個人",
				"menu_flg"=>"0"
			),
			2=>array(
				"url"=>"sale_move_cost_edit.php",
				"name"=>"移動実費編集",
				"menu_flg"=>"0"
			),
			3=>array(
				"url"=>"sale_move_cost_edit_complete.php",
				"name"=>"移動実費編集完了",
				"menu_flg"=>"0"
			)
		),
		"shift_training" => array(
			0=>array(
				"url"=>"stf_calendar.php?area=kensyuu",		//	"url"=>"staff_calendar_kensyuu.php", //update by aida at 20180209
				"name"=>"スタッフ出勤カレンダー・研修",
				"menu_flg"=>"1"
			)
		)
	);

	return $data;
	exit();

}

function get_all_page_flg($login_auth_type){

	$all_page_flg = false;

	if( $login_auth_type == "1" ){

		return true;
		exit();

	}

	$sql = sprintf("select all_page from login_auth where delete_flg=0 and type='%s'",$login_auth_type);
	$res = mysql_query($sql, DbCon);
	if( $res == false ){
		echo "error!(get_all_page_flg)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	if( $row["all_page"] == "1" ){

		$all_page_flg = true;

	}else{

		$all_page_flg = false;

	}

	return $all_page_flg;
	exit();

}

function check_sale_move_cost_2($login_auth_type){

	$data = get_login_auth_by_type($login_auth_type);

	$all_page = $data["all_page"];
	$move_cost = $data["move_cost"];

	if( ( $all_page == "1" ) || ( $move_cost == "1" ) ){

		$result = true;

	}else{

		$result = false;

	}

	return $result;
	exit();

}

function test20150615(){

	$sql = "
select
sale_history.price,therapist_new.name
from reservation_for_board
left join sale_history on sale_history.reservation_no=reservation_for_board.reservation_no
left join attendance_new on reservation_for_board.attendance_id=attendance_new.id
left join therapist_new on attendance_new.therapist_id=therapist_new.id
where
reservation_for_board.shop_area='tokyo' and
reservation_for_board.year='2015' and
reservation_for_board.month='6' and
reservation_for_board.day='10' and
reservation_for_board.delete_flg=0 and
sale_history.delete_flg=0 and
sale_history.eigyou_year='2015' and
sale_history.eigyou_month='6' and
sale_history.eigyou_day='10';";

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(test20150615)";
		exit();

	}

	$i=0;
	$list_data = array();

	$price_all=0;

	$name_data=array();
	$x=0;

	while($row = mysql_fetch_assoc($res)){

		$price_all = $price_all+$row["price"];

		$price = $row["price"];
		$name = $row["name"];

		$name_data_num = count($name_data);

		$match_flg=false;

		$match_z=0;

		for($z=0;$z<$name_data_num;$z++){

			$name_tmp = $name_data[$z]["name"];

			if($name_tmp==$name){

				$match_flg=true;
				$match_z=$z;

			}

		}

		if($match_flg==false){

			$name_data[$x]["name"]=$name;
			$name_data[$x]["price"]=$price;
			$x++;

		}else{

			$name_data[$match_z]["price"] = $name_data[$match_z]["price"]+$price;

		}

		$list_data[$i++] = $row;

	}

	return $name_data;
	exit();

}

function get_tantou_therapist_data_by_repeater_info($customer_name,$customer_tel){

	$therapist_name = "不明";

	$therapist_id = get_tantou_therapist_id_by_repeater_info($customer_name,$customer_tel);

	if( $therapist_id != "" ){

		$therapist_name = get_therapist_name_by_therapist_id_honmyou_common($therapist_id);

	}else{

		$therapist_id = get_tantou_therapist_id_tmp_by_repeater_info($customer_name,$customer_tel);

		$therapist_name = get_therapist_name_by_therapist_id_honmyou_common($therapist_id);

		$therapist_name = $therapist_name."(仮)";

	}

	$data["id"] = $therapist_id;
	$data["name"] = $therapist_name;

	return $data;
	exit();

}

function check_duplication_tantou_therapist_id($customer_tel,$therapist_id,$check_data){

	$check_data_num = count($check_data);

	for($i=0;$i<$check_data_num;$i++){

		$customer_tel_tmp = $check_data[$i]["customer_tel"];
		$therapist_id_tmp = $check_data[$i]["therapist_id"];

		if( ($customer_tel_tmp==$customer_tel) && ($therapist_id_tmp==$therapist_id) ){

			return false;
			exit();

		}

	}

	return true;
	exit();

}

function get_tantou_therapist_data_by_repeater_info_duplication($customer_tel,$check_data){

	$check_data_num = count($check_data);

	$therapist_id_data = array();
	$x = 0;

	for($i=0;$i<$check_data_num;$i++){

		$customer_tel_tmp = $check_data[$i]["customer_tel"];
		$therapist_id_tmp = $check_data[$i]["therapist_id"];

		if( $customer_tel_tmp == $customer_tel ){

			$therapist_id_data[$x++] = $therapist_id_tmp;

		}

	}

	$therapist_id_data_num = count($therapist_id_data);
	$first_flg = true;

	$sql_therapist_id = "";

	for($i=0;$i<$therapist_id_data_num;$i++){

		$therapist_id_tmp = $therapist_id_data[$i];

		if( $first_flg == true ){

			$sql_therapist_id .= sprintf("therapist_id<>'%s'",$therapist_id_tmp);

			$first_flg = false;

		}else{

			$sql_therapist_id .= sprintf(" and therapist_id<>'%s'",$therapist_id_tmp);

		}

	}

	$therapist_name = "不明";

	$therapist_id = get_tantou_therapist_id_by_repeater_info_duplication($customer_tel,$sql_therapist_id);

	if( $therapist_id != "" ){

		$therapist_name = get_therapist_name_by_therapist_id_honmyou_common($therapist_id);

	}else{

		$therapist_id = get_tantou_therapist_id_tmp_by_repeater_info_duplication($customer_tel,$sql_therapist_id);

		$therapist_name = get_therapist_name_by_therapist_id_honmyou_common($therapist_id);

		$therapist_name = $therapist_name."(仮)";

	}

	$data["id"] = $therapist_id;
	$data["name"] = $therapist_name;

	return $data;
	exit();

}

function get_tantou_therapist_id_by_repeater_info_duplication($customer_tel,$sql_therapist_id){

	$sql = sprintf("
select therapist_id from repeater where
delete_flg=0 and
customer_tel='%s' and (%s)",
$customer_tel,$sql_therapist_id);

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_tantou_therapist_id_by_repeater_info_duplication)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	return $row["therapist_id"];
	exit();

}

function get_tantou_therapist_id_tmp_by_repeater_info_duplication($customer_tel,$sql_therapist_id){

	$sql = sprintf("
select therapist_id from repeater_tmp where
delete_flg=0 and
customer_tel='%s' and (%s)",
$customer_tel,$sql_therapist_id);

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_tantou_therapist_id_tmp_by_repeater_info_duplication)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	return $row["therapist_id"];
	exit();

}

function check_repeater_regist_exist_2($customer_tel,$therapist_id){

	$sql = sprintf("
select id from repeater where
delete_flg=0 and
customer_tel='%s' and
therapist_id='%s'",
$customer_tel,$therapist_id);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(check_repeater_regist_exist_2)";
		exit();

	}

	$row = mysql_fetch_assoc($res);

	if( $row["id"] == "" ){

		return false;
		exit();

	}else{

		return true;
		exit();

	}

}

function copy_repeater($area,$year,$month,$day,$customer_name,$area_name,$shop_id,$therapist_id,$customer_tel,$id,$attendance_id){

	$first_time_ts = get_timestamp_by_year_month_day($year,$month,$day);
	$first_time_year = $year;
	$first_time_month = $month;
	$first_time_day = $day;
	$shop_area = $area;

	$now = time();

	$sql = sprintf("
insert into
repeater(
created,
updated,
therapist_id,
first_time_ts,
first_time_year,
first_time_month,
first_time_day,
customer_name,
area_name,
shop_area,
shop_id,
customer_tel,
attendance_id)
values('%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s')",
$now,
$now,
$therapist_id,
$first_time_ts,
$year,
$month,
$day,
$customer_name,
$area_name,
$shop_area,
$shop_id,
$customer_tel,
$attendance_id);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(copy_repeater)";
		exit();

	}

	return true;
	exit();

}

function check_file_extension($tmp_pic_type){

	if( ($tmp_pic_type=="image/jpeg") || ($tmp_pic_type=="image/png") || ($tmp_pic_type=="image/gif") ){

		return true;
		exit();

	}

	return false;
	exit();

}

function get_image_file_type($image_path){

	$size = getimagesize($image_path);

	// ファイルから画像の作成。画像のタイプによって関数を使い分ける

	$type = "";

	switch($size[2]) {

		case IMAGETYPE_GIF:
			$type = "image/gif";
			break;
		case IMAGETYPE_JPEG:
			$type = "image/jpeg";
			break;
		case IMAGETYPE_PNG:
			$type = "image/png";
			break;
		default:
			$type = false;
			break;

	}

	return $type;
	exit();

}

function get_therapist_select_frm_for_board_edit($attendance_id_tmp,$therapist_data){

	$therapist_data_num = count($therapist_data);

	$html .= '<select name="attendance_id_tmp">';

	$html .= '<option value="">セラピスト未定</option>';

	for($i=0;$i<$therapist_data_num;$i++){

		$attendance_id = $therapist_data[$i]["attendance_id"];
		$name = $therapist_data[$i]["name"];

		if( $attendance_id == $attendance_id_tmp ){

			$html .= sprintf('<option value="%s" selected>%s</option>',$attendance_id,$name);

		}else{

			$html .= sprintf('<option value="%s">%s</option>',$attendance_id,$name);

		}

	}

	$html .= '</select>';

	return $html;
	exit();

}

function update_reservation_for_board_attendance_tmp($attendance_id_tmp,$reservation_for_board_id){

    if( $attendance_id_tmp != "" ){
	    $sql = sprintf("
update reservation_for_board set
attendance_tmp_flg='1',
attendance_id='%s'
where id='%s'",
$attendance_id_tmp,$reservation_for_board_id);
    }
    else{
	    $sql = sprintf("
update reservation_for_board set
attendance_tmp_flg='0'
where id='%s'",$reservation_for_board_id);
    }

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(update_reservation_for_board_attendance_tmp)";
		exit();

	}

	return true;
	exit();

}

function get_data_by_sql($sql){

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_data_by_sql)";
		exit();

	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$list_data[$i++] = $row;

	}

	return $list_data;
	exit();

}

function test201507141429(){

	$sql = "select * from cti where body like '%2015/07/12%'";
	$data = get_data_by_sql($sql);
	$data_num = count($data);
	$data_new = array();
	$z=0;
	for( $i=0; $i<$data_num; $i++ ){
		$body = trim($data[$i]["body"]);
		// 改行コードをカンマに変換
		$str = str_replace(array("\r\n","\r","\n"), ",", $body);
		// カンマ区切りに配列に格納
		$hairetsu = spliti( ',', $str );
		$hairetsu_num = count($hairetsu);
		$reservation_no = $hairetsu[1];
		for($x=1;$x<10;$x++){
			$tmp_data = $hairetsu[$x];
			if (preg_match("/^■日時 ： /",$tmp_data)) {
				$nichiji = trim(str_replace("■日時 ： ","",$tmp_data));
			}
		}
		for($x=1;$x<10;$x++){
			$tmp_data = $hairetsu[$x];
			if (preg_match("/^■店舗 ： /",$tmp_data)) {
				$shop_name = trim(str_replace("■店舗 ： ","",$tmp_data));
			}
		}
		for($x=1;$x<10;$x++){
			$tmp_data = $hairetsu[$x];
			if ( (preg_match("/^■担当 ： /",$tmp_data)) || (preg_match("/^■女の子 ： /",$tmp_data)) ) {
				$tmp_data = trim(str_replace("■担当 ： ","",$tmp_data));
				$girl_name = trim(str_replace("■女の子 ： ","",$tmp_data));
			}
		}
		for($x=1;$x<$hairetsu_num;$x++){
			$tmp_data = $hairetsu[$x];
			if (preg_match("/^■名前 ： /",$tmp_data)) {
				$customer_name = trim(str_replace("■名前 ： ","",$tmp_data));
			}
		}
		$stop_num = 0;
		$stop_flg = 0;
		for($x=1;$x<$hairetsu_num;$x++){
			if( $stop_flg == "0" ){
				$tmp_data = $hairetsu[$x];
				if (preg_match("/^■媒体 ： /",$tmp_data)) {
					$baitai_content_1 = trim(str_replace("■媒体 ： ","",$tmp_data));
					$stop_flg = 1;
					$stop_num = $x;
				}
			}
		}
		$stop_num++;
		for($x=$stop_num;$x<$hairetsu_num;$x++){
			$tmp_data = $hairetsu[$x];
			if (preg_match("/^■媒体 ： /",$tmp_data)) {
				$baitai_content_2 = trim(str_replace("■媒体 ： ","",$tmp_data));
			}
		}
		$baitai_content_flg=false;
		if($baitai_content_1 != $baitai_content_2){
			$baitai_content_flg=true;
		}
		if($baitai_content_2==""){
			$baitai_content_flg=false;
		}
		if( preg_match("/^2015\/07\/12/",$nichiji) ){
			if( $baitai_content_flg == true ){
				$data_new[$z]["reservation_no"] = $reservation_no;
				$data_new[$z]["nichiji"] = $nichiji;
				$data_new[$z]["shop_name"] = $shop_name;
				$data_new[$z]["girl_name"] = $girl_name;
				$data_new[$z]["customer_name"] = $customer_name;
				$data_new[$z]["baitai_content_1"] = $baitai_content_1;
				$data_new[$z]["baitai_content_2"] = $baitai_content_2;
				$z++;
			}
		}
	}
	echo "<pre>";
	print_r($data_new);
	echo "</pre>";
	exit();

}

function test201507141432(){

	//ヤフー検索用の検索キーワード配列取得
	$shop_area = "osaka";
	get_search_data_array($shop_area);

}

function test201507141433(){

	//データの更新

	$data = get_station_data_sapporo();
	$data_num = count($data);
	for($i=0;$i<$data_num;$i++){
		$id = $data[$i]["id"];
		$name = $data[$i]["name"];
		$name = str_replace("駅", "", $name);
		update_station_name_by_id_sapporo($id,$name);
	}

	exit();

}

function get_month_data_2($year,$month){

	$data = get_today_year_month_day_2_common();

	$year_today = $data["year"];
	$month_today = $data["month"];
	$day_today = $data["day"];

	if( ($year==$year_today) && ($month==$month_today) ){

		$day_yesterday = $day_today - 1;

		$last_day = $day_yesterday;

	}else{

		$last_day = get_month_last_day($year,$month);

	}

	$data = array();

	for($i=0;$i<$last_day;$i++){

		$day = ( $i + 1 );

		$week = get_week_name_by_time_common($year, $month, $day);

		$data[$i]["year"] = $year;
		$data[$i]["month"] = $month;
		$data[$i]["day"] = $day;
		$data[$i]["week"] = $week;

	}

	return $data;
	exit();

}

function get_select_frm_staff_message_board_regist($staff_id){

	/*
	$data = array(
		0=>array("id"=>"9","name"=>"足立"),
		1=>array("id"=>"10","name"=>"小友"),
		2=>array("id"=>"26","name"=>"寺井"),
		3=>array("id"=>"90","name"=>"武廣"),
		4=>array("id"=>"84","name"=>"坂巻"),
		5=>array("id"=>"126","name"=>"田中"),
		6=>array("id"=>"143","name"=>"高味")
	);
	*/
	$data = get_staff_data_for_board_disp();

	$data_num = count($data);

	$html = "";

	$html .= '<select name="staff_id">';
	$html .= '<option value="-1">投稿者選択</option>';

	for($i=0;$i<$data_num;$i++){

		$id = $data[$i]["id"];
		$name = $data[$i]["name"];

		if( $staff_id == $id ){

			$html .= sprintf('<option value="%s" selected>%s</option>',$id,$name);

		}else{

			$html .= sprintf('<option value="%s">%s</option>',$id,$name);

		}

	}

	$html .= '</select>';

	return $html;
	exit();

}

function regist_staff_message_board($title,$content,$staff_id){

	$staff_name = get_staff_name_by_id_common($staff_id);

	//トランザクションをはじめる準備
	$sql = "set autocommit = 0";
	mysql_query( $sql, DbCon );

	//トランザクション開始
	$sql = "begin";
	mysql_query( $sql, DbCon );

	$parent_id = "-1";

	$now = time();

// 出勤情報を登録するSQL文
$sql = sprintf("
insert into staff_message_board(created,updated,parent_id,staff_id,title,content)
values('%s','%s','%s','%s','%s','%s')",
$now,$now,$parent_id,$staff_id,$title,$content);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		//ロールバック
		$sql = "rollback";
		mysql_query( $sql, DbCon );

		echo "error!(regist_staff_message_board)";
		exit();

	}

	$man_url = WWW_URL_MAN;
	$title_mail = $title;

	//メール送信
	mb_language("ja");
	mb_internal_encoding("UTF-8");

	//$mailto = "minamikawa@neo-gate.jp";
	$mailto = "info@neo-gate.jp";
	$title = $staff_name."さんからスタッフBBSに投稿がありました";
	$content =<<<EOT
件名：{$title_mail}

[本文]
{$content}

{$man_url}staff_message_board/index.php
EOT;

	$header = "From: info@neo-gate.jp\n";
	//$header .= "Bcc: minamikawa@neo-gate.jp";

	$res = mb_send_mail($mailto,$title,$content,$header,MAIL_PARAMETER);

	if( $res == false ){

		//ロールバック
		$sql = "rollback";
		mysql_query( $sql, DbCon );

		echo "error!(regist_staff_message_board)";
		exit();

	}

	//コミット
	$sql = "commit";
	mysql_query( $sql, DbCon );

	return true;
	exit();
}

function get_board_disp_data_html_mitei_2($board_disp_data,$shop_area){

	$start_hour = $board_disp_data["start_hour"];
	$start_minute = $board_disp_data["start_minute"];
	$end_hour = $board_disp_data["end_hour"];
	$end_minute = $board_disp_data["end_minute"];
	$time_len = $board_disp_data["time_len"];

	$width_value = $time_len * 7;

	$shop_name = $board_disp_data["shop_name"];

	$time_len = $board_disp_data["time_len"];

	$reservation_for_board_id = $board_disp_data["id"];

	if( $start_hour < 18 ){

		$start_hour = $start_hour + 24;

	}

	if( $end_hour < 18 ){

		$end_hour = $end_hour + 24;

	}

	if( $start_minute < 10 ){

		$start_minute = "0".$start_minute;

	}

	if( $end_minute < 10 ){

		$end_minute = "0".$end_minute;

	}

	$time = $start_hour."：".$start_minute."&nbsp;―&nbsp;".$end_hour."：".$end_minute;

	$customer_name = preg_replace("/[\(（].*/u","",$board_disp_data["customer_name"]);

	if( $shop_name == "東京リフレ" ){

		$html .= '<a style="width:'.$width_value.'px;" class="mitei_box refle_mitei_box" href="reservation_status_board_edit.php?area='.$shop_area.'&id='.$reservation_for_board_id.'">';

	}else if( $shop_name == "東京アロマ" ){

		$html .= '<a style="width:'.$width_value.'px;" class="mitei_box aroma_mitei_box" href="reservation_status_board_edit.php?area='.$shop_area.'&id='.$reservation_for_board_id.'">';

	}else if( $shop_name == "リンパマッサージ東京" ){

		$html .= '<a style="width:'.$width_value.'px;" class="mitei_box lymph_mitei_box" href="reservation_status_board_edit.php?area='.$shop_area.'&id='.$reservation_for_board_id.'">';

	}else if( $shop_name == "東京リラク" ){

		$html .= '<a style="width:'.$width_value.'px;" class="mitei_box reraku_mitei_box" href="reservation_status_board_edit.php?area='.$shop_area.'_reraku&id='.$reservation_for_board_id.'">';

	}else if( $shop_name == "BIGAO" ){

		$html .= '<a style="width:'.$width_value.'px;" class="mitei_box bigao_mitei_box" href="reservation_status_board_edit.php?area='.$shop_area.'_bigao&id='.$reservation_for_board_id.'">';

	}else{

		$html .= '<a style="width:'.$width_value.'px;" class="mitei_box sonota_mitei_box" href="reservation_status_board_edit.php?area='.$shop_area.'&id='.$reservation_for_board_id.'">';

	}

	$html .= '<div class="mitei_box_time">'.$time.'</div>';
	$html .= '<div class="mitei_box_name">'.$customer_name.'（'.$board_disp_data["area_name"].'）</div>';
	$html .=<<<EOT
<div>
<br class="clear" />
</div>
EOT;
	$html .= '</a>';

	return $html;
	exit();

}

function get_login_staff($type){

	if( $type == "staff" ){

		$tbl_name = "staff_new_new";

	}else if( $type == "therapist" ){

		$tbl_name = "therapist_new";

	}else{

		echo "error!(get_login_staff)";
		exit();

	}

	$sql = sprintf("
select * from %s where
delete_flg=0 and
leave_flg=0 and
name_man<>'' and
password_man<>'' and
login_auth_type<>'0'",
$tbl_name);

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_login_staff)";
		exit();

	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$list_data[$i++] = $row;

	}

	return $list_data;
	exit();

}

function test201507151506(){

	$type = "staff";
	$data = get_login_staff($type);
	$data_num = count($data);
	$html = "[名前][ログインID][ログインPW][権限][地域]";
	$html .= "<br /><br />";
	$html .= "【スタッフ】";
	$html .= "<br />";
	for($i=0;$i<$data_num;$i++){
		$name = $data[$i]["name"];
		$area = $data[$i]["area"];
		$name_man = $data[$i]["name_man"];
		$login_auth_type = $data[$i]["login_auth_type"];
		$password_man = $data[$i]["password_man"];
		$login_auth_type_name = get_login_auth_type_name($login_auth_type);
		$area_name = get_area_name_by_area_common($area);
		$html .= sprintf("[%s][%s][%s][%s][%s]",$name,$name_man,$password_man,$login_auth_type_name,$area_name);
		$html .= "<br />";
	}
	$html .= "<br />";
	$type = "therapist";
	$data = get_login_staff($type);
	$data_num = count($data);
	$html .= "【セラピスト】";
	$html .= "<br />";
	for($i=0;$i<$data_num;$i++){
		$name = $data[$i]["name"];
		$area = $data[$i]["area"];
		$name_man = $data[$i]["name_man"];
		$login_auth_type = $data[$i]["login_auth_type"];
		$password_man = $data[$i]["password_man"];
		$login_auth_type_name = get_login_auth_type_name($login_auth_type);
		$area_name = get_area_name_by_area_common($area);
		$html .= sprintf("[%s][%s][%s][%s][%s]",$name,$name_man,$password_man,$login_auth_type_name,$area_name);
		$html .= "<br />";
	}
	$html .= "<br />";
	echo $html;
	exit();

}

function get_staff_message_board_data($complete_flg){

	$sql = sprintf("select * from staff_message_board where delete_flg=0 and complete_flg='%s' and parent_id='-1' order by updated desc limit 0,30",$complete_flg);
	$res = mysql_query($sql, DbCon);
	if( $res == false ){
		echo "error!(get_staff_message_board_data)";
		exit();
	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$id = $row["id"];
		$created = $row["created"];
		$staff_id = $row["staff_id"];

		$staff_read = $row["staff_read"];

		$complete_flg = $row["complete_flg"];

		$staff_name = get_staff_name_by_id_common($staff_id);

		$year = date('Y', $created);
		$month = intval(date('m', $created));
		$day = intval(date('d', $created));
		$hour = add_zero_when_under_ten_common(intval(date('H', $created)));
		$minute = add_zero_when_under_ten_common(intval(date('i', $created)));

		$week_name = get_week_name_by_time_common($year, $month, $day);

		$created_string = sprintf("%s月%s日（%s）%s:%s",$month,$day,$week_name,$hour,$minute);

		//子データを取得
		$child_data = get_staff_message_board_data_child($id);

		$child_data_num = count($child_data);

		$staff_read_frm = get_staff_read_frm($id,$staff_read,$complete_flg);

		$list_data[$i] = $row;
		$list_data[$i]["created_string"] = $created_string;
		$list_data[$i]["staff_name"] = $staff_name;
		$list_data[$i]["child_data"] = $child_data;
		$list_data[$i]["child_data_num"] = $child_data_num;
		$list_data[$i]["staff_read_frm"] = $staff_read_frm;

		$i++;

	}

	return $list_data;
	exit();

}

function get_staff_message_board_data_one($parent_id){

	$sql = sprintf("select * from staff_message_board where id='%s'",$parent_id);
	$res = mysql_query($sql, DbCon);
	if( $res == false ){
		echo "error!(get_staff_message_board_data_one)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();
}

function regist_staff_message_board_reply($content,$staff_id,$parent_id){

	$staff_name = get_staff_name_by_id_common($staff_id);

	$data = get_staff_message_board_data_one($parent_id);
	$title_mail = $data["title"];

	//トランザクションをはじめる準備
	$sql = "set autocommit = 0";
	mysql_query( $sql, DbCon );

	//トランザクション開始
	$sql = "begin";
	mysql_query( $sql, DbCon );

	$now = time();

	$title = "";

	// 出勤情報を登録するSQL文
	$sql = sprintf("
insert into staff_message_board(created,updated,parent_id,staff_id,title,content)
values('%s','%s','%s','%s','%s','%s')",
$now,$now,$parent_id,$staff_id,$title,$content);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		//ロールバック
		$sql = "rollback";
		mysql_query( $sql, DbCon );

		echo "error!(regist_staff_message_board_reply)";
		exit();

	}

	//updatedの更新
	$sql = sprintf("
update staff_message_board set updated='%s' where id='%s'",
$now,$parent_id);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		//ロールバック
		$sql = "rollback";
		mysql_query( $sql, DbCon );

		echo "error!(regist_staff_message_board_reply)";
		exit();

	}

	$man_url = WWW_URL_MAN;

	//メール送信
	mb_language("ja");
	mb_internal_encoding("UTF-8");

	//$mailto = "minamikawa@neo-gate.jp";
	$mailto = "info@neo-gate.jp";
	$title = $staff_name."さんからスタッフBBSに返信がありました";
	$content =<<<EOT
[返信]{$title_mail}

[本文]
{$content}

{$man_url}staff_message_board/index.php
EOT;

	$header = "From: info@neo-gate.jp\n";
	//$header .= "Bcc: minamikawa@neo-gate.jp";

	$res = mb_send_mail($mailto,$title,$content,$header,MAIL_PARAMETER);

	if( $res == false ){

		//ロールバック
		$sql = "rollback";
		mysql_query( $sql, DbCon );

		echo "error!(regist_staff_message_board_reply)";
		exit();

	}

	//コミット
	$sql = "commit";
	mysql_query( $sql, DbCon );

	return true;
	exit();
}

function get_staff_message_board_data_child($parent_id){

	$sql = sprintf("
select * from staff_message_board
where
delete_flg=0 and
parent_id='%s'
order by created desc",
$parent_id);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_staff_message_board_data_child)";
		exit();

	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$id = $row["id"];
		$created = $row["created"];
		$staff_id = $row["staff_id"];

		$staff_name = get_staff_name_by_id_common($staff_id);

		$year = date('Y', $created);
		$month = intval(date('m', $created));
		$day = intval(date('d', $created));
		$hour = add_zero_when_under_ten_common(intval(date('H', $created)));
		$minute = add_zero_when_under_ten_common(intval(date('i', $created)));

		$week_name = get_week_name_by_time_common($year, $month, $day);

		$created_string = sprintf("%s月%s日（%s）%s:%s",$month,$day,$week_name,$hour,$minute);

		$list_data[$i] = $row;
		$list_data[$i]["created_string"] = $created_string;
		$list_data[$i]["staff_name"] = $staff_name;

		$i++;

	}

	return $list_data;
	exit();

}

//車の画像を削除
function delete_staff_car_image_2($staff_id){

	// imageを削除する処理
	$sql = sprintf("update staff_new_new set car_image_url='' where id='%s'",$staff_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(delete_staff_car_image_2)";
		exit();
	}

	return true;
	exit();
}

function get_skill_checkbox_therapist_page_edit($skill_data,$skill_data_num,$skill){

	$html = "";

	for($i=1;$i<=$skill_data_num;$i++){

		$result = check_skill_exist($i,$skill);

		if( $result == true ){

			$html .= '<input type="checkbox" name="skill[]" value="'.$i.'" checked>'.$skill_data[$i];

		}else{

			$html .= '<input type="checkbox" name="skill[]" value="'.$i.'">'.$skill_data[$i];

		}

	}

	return $html;
	exit();

}

function delete_therapist_page_img_url($therapist_page_id){

	$sql = sprintf("update therapist_page set img_url='' where id='%s'",$therapist_page_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(delete_therapist_page_img_url)";
		exit();
	}

	return true;
	exit();
}

function update_staff_read($id,$staff_read){

	$sql = sprintf("update staff_message_board set staff_read='%s' where id='%s'",$staff_read,$id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(update_staff_read)" . $sql;
		exit();
	}

	return true;
	exit();
}

function get_staff_read_frm($id,$staff_read,$complete_flg){
	/*
	$data = array(
		0=>array("id"=>"9","name"=>"足立"),
		1=>array("id"=>"10","name"=>"小友"),
		2=>array("id"=>"26","name"=>"寺井"),
		3=>array("id"=>"90","name"=>"武廣"),
		4=>array("id"=>"143","name"=>"高味"),
		5=>array("id"=>"84","name"=>"坂巻")
	);
	*/
	$data = get_staff_data_for_board_disp();

	$staff_read_data = explode(",",$staff_read);

	$data_num = count($data);
	$staff_read_data_num = count($staff_read_data);

	$html = "";

$html .=<<<EOT
<form id="staff_read_frm_{$id}">
EOT;

for($i=0;$i<$data_num;$i++){

	$staff_id = $data[$i]["id"];
	$name = $data[$i]["name"];

	$match_flg = false;

	for( $x=0; $x<$staff_read_data_num; $x++ ){

		$staff_id_tmp = $staff_read_data[$x];

		if( $staff_id == $staff_id_tmp ){

			$match_flg = true;

		}

	}

	if( $match_flg == true ){

$html .=<<<EOT
<div class="staff">
<label class="lavel_{$id}"><input type="checkbox" name="staff_read" value="{$staff_id}" checked></label><span style="font-size:12px;">{$name}</span>
</div>
EOT;

	}else{

$html .=<<<EOT
<div class="staff">
<label class="lavel_{$id}"><input type="checkbox" name="staff_read" value="{$staff_id}"></label><span style="font-size:12px;">{$name}</span>
</div>
EOT;

	}

}

$html .=<<<EOT
<div class="staff" id="staff_read_img_{$id}">&nbsp;</div>
</form>
EOT;

$checked = "";
if($complete_flg=="1"){

	$checked = " checked";

}

$html .=<<<EOT
<div style="margin:0px 0px 10px 0px;">
<form>
<input type="checkbox" name="complete_flg" value="1" class="complete_flg_checkbox" id="complete_flg_checkbox_{$id}"{$checked} />
<span style="font-size:12px;">解決チェック</span>
</form>
</div>
EOT;

	return $html;
	exit();

}

//合計と一日の平均
function get_sum_average_data_for_shop_report($sale_data,$work_num,$year,$month){

	//include(COMMON_INC."shop_area_list.php");
	global $shop_list, $area_list;
	$area_list_num = count($area_list);
	$shop_list_num = count($shop_list);

	//echo "man/functions.php line:" . __LINE__ . " time:" . date("H:i:s", time()) . "<br />";
	/*
	echo "<pre>";
	print_r($shop_list);
	echo "</pre>";
	exit();
	*/

	$work_num_mirai = get_work_num_for_shop_report_mirai($year,$month);

	$sale_data_num = count($sale_data);

	$shop_box = array();

	for($i=0;$i<$shop_list_num;$i++){

		$name = $shop_list[$i]["name"];
		$id = $shop_list[$i]["id"];
		$ja = $shop_list[$i]["ja"];

		$shop_box[$name]["price"] = 0;
		$shop_box[$name]["operation_num"] = 0;
		$shop_box[$name]["operation_num_new"] = 0;
		$shop_box[$name]["operation_num_repeat"] = 0;
		$shop_box[$name]["operation_rate_new"] = 0;
		$shop_box[$name]["operation_rate_repeat"] = 0;
		$shop_box[$name]["loss_data"] = array();
		$shop_box[$name]["call_num"] = 0;

	}
	echo "man/functions.php line:" . __LINE__ . " time:" . date("H:i:s", time()) . "<br />";

	/*
	echo "<pre>";
	print_r($shop_box);
	echo "</pre>";
	exit();
	*/

	$area_box = array();

	for($i=0;$i<$area_list_num;$i++){

		$name = $area_list[$i];

		$area_box[$name]["attendance_num"] = 0;
		$area_box[$name]["operation_num"] = 0;
		$area_box[$name]["loss_data"] = array();
	}

	/*
	echo "<pre>";
	print_r($area_box);
	echo "</pre>";
	exit();
	*/

	for( $i=0; $i<$sale_data_num; $i++ ){

		$attendance_num = $sale_data[$i]["attendance_num"];

		$shop_data = $sale_data[$i]["shop_data"];
		$shop_data_num = count($shop_data);

		$loss_data = $sale_data[$i]["loss_data"];

		for($x=0;$x<$area_list_num;$x++){

			$name = $area_list[$x];
			$area_box[$name]["loss_data"] = loss_data_add_for_shop_report($area_box[$name]["loss_data"],$loss_data[$name]);
			$area_box[$name]["attendance_num"] = $area_box[$name]["attendance_num"] + $attendance_num[$name];

		}

		for( $x=0; $x<$shop_data_num; $x++ ){

			$shop_name = $shop_data[$x]["name"];
			$price = $shop_data[$x]["price"];
			$operation_num = $shop_data[$x]["operation_num"];
			$operation_num_new = $shop_data[$x]["operation_num_new"];
			$operation_num_repeat = $shop_data[$x]["operation_num_repeat"];
			$loss_data = $shop_data[$x]["loss_data"];
			$call_num = $shop_data[$x]["call_num"];

			for($z=0;$z<$shop_list_num;$z++){

				$name = $shop_list[$z]["name"];
				$id = $shop_list[$z]["id"];
				$ja = $shop_list[$z]["ja"];
				$area = $shop_list[$z]["area"];

				if( $shop_name == $ja ){

					$shop_box[$name]["price"] = $shop_box[$name]["price"] + $price;
					$shop_box[$name]["operation_num"] = $shop_box[$name]["operation_num"] + $operation_num;
					$shop_box[$name]["operation_num_new"] = $shop_box[$name]["operation_num_new"] + $operation_num_new;
					$shop_box[$name]["operation_num_repeat"] = $shop_box[$name]["operation_num_repeat"] + $operation_num_repeat;
					$area_box[$area]["operation_num"] = $area_box[$area]["operation_num"] + $operation_num;
					$shop_box[$name]["loss_data"] = loss_data_add_for_shop_report($shop_box[$name]["loss_data"],$loss_data);
					$shop_box[$name]["call_num"] = $shop_box[$name]["call_num"] + $call_num;

				}

			}

		}

	}

	/*
	echo "<pre>";
	print_r($area_box);
	echo "</pre>";
	exit();
	*/

	for($i=0;$i<$shop_list_num;$i++){

		$name = $shop_list[$i]["name"];
		$id = $shop_list[$i]["id"];
		$ja = $shop_list[$i]["ja"];

		$shop_box[$name]["operation_rate_new"] = get_int_per_common($shop_box[$name]["operation_num_new"],$shop_box[$name]["operation_num"]);
		$shop_box[$name]["operation_rate_repeat"] = get_int_per_common($shop_box[$name]["operation_num_repeat"],$shop_box[$name]["operation_num"]);

		$data[$name]["price"] = $shop_box[$name]["price"];
		$data[$name]["average"] = intval($shop_box[$name]["price"]/$work_num);
		$data[$name]["operation_num"]["value"] = $shop_box[$name]["operation_num"];
		$data[$name]["operation_num"]["average"] = kirisute($shop_box[$name]["operation_num"],$work_num);
		$data[$name]["operation_num"]["rate"] = get_int_per_common($shop_box[$name]["operation_num"],$shop_box[$name]["call_num"]);
		$data[$name]["operation_num_new"]["value"] = $shop_box[$name]["operation_num_new"];
		$data[$name]["operation_num_new"]["average"] = kirisute($shop_box[$name]["operation_num_new"],$work_num);
		$data[$name]["operation_num_new"]["rate"] = $shop_box[$name]["operation_rate_new"];
		$data[$name]["operation_num_repeat"]["value"] = $shop_box[$name]["operation_num_repeat"];
		$data[$name]["operation_num_repeat"]["average"] = kirisute($shop_box[$name]["operation_num_repeat"],$work_num);
		$data[$name]["operation_num_repeat"]["rate"] = $shop_box[$name]["operation_rate_repeat"];
		$data[$name]["call_num"]["value"] = $shop_box[$name]["call_num"];
		$call_num_average = kirisute($shop_box[$name]["call_num"],$work_num);
		$data[$name]["call_num"]["average"] = $call_num_average;

		$shop_id = $id;
		$target_data = get_target_data_by_month_for_shop_report($shop_id,$year,$month);
		$sale_price = $target_data["sale_price"];
		$call_num = $target_data["call_num"];
		$agreement_num = $target_data["agreement_num"];
		$customer_new = $target_data["customer_new"];
		$repeater_num = $target_data["repeater_num"];
		$data[$name]["target"]["sale_price"]["value"] = $sale_price;
		$data[$name]["target"]["sale_price"]["rate"] = get_int_per_common($data[$name]["average"],$sale_price);
		$data[$name]["target"]["call_num"]["value"] = $call_num;
		$data[$name]["target"]["call_num"]["rate"] = get_int_per_common($call_num_average,$call_num);
		$data[$name]["target"]["agreement_num"]["value"] = $agreement_num;
		$data[$name]["target"]["agreement_num"]["rate"] = get_int_per_common($data[$name]["operation_num"]["average"],$agreement_num);
		$data[$name]["target"]["customer_new"]["value"] = $customer_new;
		$data[$name]["target"]["customer_new"]["rate"] = get_int_per_common($data[$name]["operation_num_new"]["average"],$customer_new);
		$data[$name]["target"]["repeater_num"]["value"] = $repeater_num;
		$data[$name]["target"]["repeater_num"]["rate"] = get_int_per_common($data[$name]["operation_num_repeat"]["average"],$repeater_num);

		$data[$name]["loss_data"]["value"] = $shop_box[$name]["loss_data"];
		$data[$name]["loss_data"]["average"] = get_loss_data_average_for_shop_report($shop_box[$name]["loss_data"],$work_num);

	}

	for($i=0;$i<$area_list_num;$i++){

        $name = $area_list[$i];
        if(($name != "tokyo_reraku")&&($name != "tokyo_bigao")){
            $data[$name]["loss_data"]["average"] = get_loss_data_average_for_shop_report($area_box[$name]["loss_data"],$work_num);
            $data[$name]["attendance_num"]["value"] = $area_box[$name]["attendance_num"];
            $data[$name]["attendance_num"]["average"] = kirisute($area_box[$name]["attendance_num"],$work_num);
            $data[$name]["operation_num"]["value"] = $area_box[$name]["operation_num"];
            $data[$name]["operation_num"]["average"] = kirisute($area_box[$name]["operation_num"],$work_num);
            $data[$name]["loss_data"]["value"] = $area_box[$name]["loss_data"];
        }
        else{
            $data[$name]["attendance_num"]["value"] = $area_box[$name]["attendance_num"];
            $data[$name]["attendance_num"]["average"] = kirisute($area_box[$name]["attendance_num"],$work_num);
        }
	}

	return $data;
	exit();

}

function get_sum_data_2_for_shop_report($data){

	//include(COMMON_INC."shop_area_list.php");
	global $shop_list, $area_list;
	$area_list_num = count($area_list);
	$shop_list_num = count($shop_list);

	$return_data = array();

	$data_tmp = array();
	for($i=0;$i<$shop_list_num;$i++){
		$name = $shop_list[$i]["name"];
		$data_tmp[$name] = $data[$name]["average"];
	}
	$return_data["average"] = get_sum_value_for_shop_report($data_tmp);

	$data_tmp = array();
	for($i=0;$i<$shop_list_num;$i++){
		$name = $shop_list[$i]["name"];
		$data_tmp[$name] = $data[$name]["price"];
	}
	$return_data["price"] = get_sum_value_for_shop_report($data_tmp);

	$data_tmp = array();
	for($i=0;$i<$shop_list_num;$i++){
		$name = $shop_list[$i]["name"];
		$data_tmp[$name] = $data[$name]["operation_num"]["value"];
	}
	$return_data["operation_num"]["value"] = get_sum_value_for_shop_report($data_tmp);

	$data_tmp = array();
	for($i=0;$i<$shop_list_num;$i++){
		$name = $shop_list[$i]["name"];
		$data_tmp[$name] = $data[$name]["target"]["sale_price"]["value"];
	}
	$return_data["target"]["sale"]["value"] = get_sum_value_for_shop_report($data_tmp);
	$return_data["target"]["sale"]["rate"] = get_int_per_common($return_data["average"],$return_data["target"]["sale"]["value"]);

	$data_tmp = array();
	for($i=0;$i<$area_list_num;$i++){
		$name = $area_list[$i];
		$data_tmp[$name] = $data[$name]["attendance_num"]["value"];
	}
	$return_data["attendance_num"]["value"] = get_sum_value_2_for_shop_report($data_tmp);

	$data_tmp = array();
	for($i=0;$i<$area_list_num;$i++){
		$name = $area_list[$i];
		$data_tmp[$name] = $data[$name]["attendance_num"]["average"];
	}
	$return_data["attendance_num"]["average"] = get_sum_value_2_for_shop_report($data_tmp);

	$data_tmp = array();
	for($i=0;$i<$area_list_num;$i++){
		$name = $area_list[$i];
		$data_tmp[$name] = $data[$name]["operation_num"]["average"];
	}
	$return_data["operation_num"]["average"] = get_sum_value_2_for_shop_report($data_tmp);

	return $return_data;
	exit();

}

function get_hikaku_data_for_shop_report($data,$data_pre,$type){

	//include(COMMON_INC."shop_area_list.php");
	global $shop_list, $area_list;
	$area_list_num = count($area_list);
	$shop_list_num = count($shop_list);

	$hikaku_data = array();

	for($i=0;$i<$shop_list_num;$i++){

		$name = $shop_list[$i]["name"];

		$hikaku_data["sale"][$name] = get_hikaku_value_for_shop_report($data[$name]["average"],$data_pre[$name]["average"]);
		$hikaku_data["operation_num"][$name] = get_hikaku_value_for_shop_report($data[$name]["operation_num"]["average"],$data_pre[$name]["operation_num"]["average"]);
		$hikaku_data["operation_num_new"]["average"][$name] = get_hikaku_value_for_shop_report($data[$name]["operation_num_new"]["average"],$data_pre[$name]["operation_num_new"]["average"]);
		$hikaku_data["operation_num_new"]["rate"][$name] = get_hikaku_value_for_shop_report($data[$name]["operation_num_new"]["rate"],$data_pre[$name]["operation_num_new"]["rate"]);
		$hikaku_data["operation_num_repeat"]["average"][$name] = get_hikaku_value_for_shop_report($data[$name]["operation_num_repeat"]["average"],$data_pre[$name]["operation_num_repeat"]["average"]);
		$hikaku_data["operation_num_repeat"]["rate"][$name] = get_hikaku_value_for_shop_report($data[$name]["operation_num_repeat"]["rate"],$data_pre[$name]["operation_num_repeat"]["rate"]);
		$hikaku_data["loss_data"][$name] = get_loss_data_hikaku_for_shop_report($data[$name]["loss_data"],$data_pre[$name]["loss_data"]);
		$hikaku_data["call_num"][$name]["call_num"] = get_hikaku_value_for_shop_report($data[$name]["call_num"]["average"],$data_pre[$name]["call_num"]["average"]);
		$hikaku_data["call_num"][$name]["agreement_num"] = get_hikaku_value_for_shop_report($data[$name]["operation_num"]["rate"],$data_pre[$name]["operation_num"]["rate"]);

	}

	for($i=0;$i<$area_list_num;$i++){

		$name = $area_list[$i];

		$hikaku_data["attendance_num"][$name] = get_hikaku_value_for_shop_report($data[$name]["attendance_num"]["average"],$data_pre[$name]["attendance_num"]["average"]);
		$hikaku_data["operation_num"][$name] = get_hikaku_value_for_shop_report($data[$name]["operation_num"]["average"],$data_pre[$name]["operation_num"]["average"]);
		$hikaku_data["loss_data"][$name] = get_loss_data_hikaku_for_shop_report($data[$name]["loss_data"],$data_pre[$name]["loss_data"]);

	}

	return $hikaku_data;
	exit();

}

function get_sale_data_2($month_data,$sale_data){

	$month_data_num = count($month_data);

	$data = array();

	for($i=0;$i<$month_data_num;$i++){

		$data[$i] = $sale_data[$i];

	}

	return $data;
	exit();

}

function get_staff_pay_hour_select_frm($pay_hour){

	$data = array(
		0=>array("value"=>"1000","ja"=>"1,000円"),
		1=>array("value"=>"1050","ja"=>"1,050円"),
		2=>array("value"=>"1100","ja"=>"1,100円"),
		3=>array("value"=>"1150","ja"=>"1,150円"),
		4=>array("value"=>"1200","ja"=>"1,200円"),
		5=>array("value"=>"1250","ja"=>"1,250円"),
		6=>array("value"=>"1300","ja"=>"1,300円"),
		7=>array("value"=>"1350","ja"=>"1,350円"),
		8=>array("value"=>"1400","ja"=>"1,400円"),
		9=>array("value"=>"1500","ja"=>"1,500円"),
		10=>array("value"=>"1600","ja"=>"1,600円"),
		11=>array("value"=>"1700","ja"=>"1,700円"),
		12=>array("value"=>"1800","ja"=>"1,800円"),
		13=>array("value"=>"1900","ja"=>"1,900円"),
		14=>array("value"=>"2000","ja"=>"2,000円"),
	);

	$data_num = count($data);

	$html = "";

	$html .= '<select name="pay_hour">';
	$html .= '<option value="-1">未選択</option>';

	for( $i=0; $i<$data_num; $i++ ){

		$value = $data[$i]["value"];
		$ja = $data[$i]["ja"];

		if( $value == $pay_hour ){
			$html .= sprintf('<option value="%s" selected>%s</option>',$value,$ja);
		}else{
			$html .= sprintf('<option value="%s">%s</option>',$value,$ja);
		}

	}

	$html .= '</select>';

	return $html;
	exit();

}

function get_data_for_sale_shop_2($year,$month,$day,$shop_name){

	$sql = sprintf("
select
sale_history.price,
sale_history.therapist_id,
reservation_for_board.attendance_id,
reservation_for_board.shimei_flg,
reservation_for_board.transportation
from reservation_for_board
left join sale_history on sale_history.reservation_no=reservation_for_board.reservation_no
where
reservation_for_board.shop_name='%s' and
reservation_for_board.year='%s' and
reservation_for_board.month='%s' and
reservation_for_board.day='%s' and
reservation_for_board.delete_flg=0 and
sale_history.delete_flg=0 and
sale_history.eigyou_year='%s' and
sale_history.eigyou_month='%s' and
sale_history.eigyou_day='%s'",
$shop_name,$year,$month,$day,$year,$month,$day);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_data_for_sale_shop_2)";
		exit();

	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$list_data[$i++] = $row;

	}

	return $list_data;
	exit();

}

function get_attendance_id_by_for_sale_shop_2_data($data){

	$id_data = array();

	$data_num = count($data);

	$x = 0;

	for($i=0;$i<$data_num;$i++){

		$attendance_id = $data[$i]["attendance_id"];

		$result = check_data_exist_array($id_data,$attendance_id);

		if( $result == false ){

			$id_data[$x] = $attendance_id;
			$x++;

		}

	}

	return $id_data;
	exit();

}

function check_data_exist_array($data,$value){

	$data_num = count($data);

	$match_flg = false;

	for($i=0;$i<$data_num;$i++){

		$tmp = $data[$i];

		if( $tmp == $value ){

			$match_flg = true;

		}

	}

	return $match_flg;
	exit();

}

function get_therapist_remuneration_data_for_sale_shop_2($data){

	$data_num = count($data);

	$remuneration_all = 0;
	$lowest_guarantee_all = 0;

	for($i=0;$i<$data_num;$i++){

		$attendance_id = $data[$i];

		$tmp = get_therapist_remuneration_by_attendance_id_common($attendance_id);

		$lowest_guarantee = $tmp["lowest_guarantee"];
		$remuneration = $tmp["remuneration"] - $lowest_guarantee;

		$remuneration_all = $remuneration_all + $remuneration;
		$lowest_guarantee_all = $lowest_guarantee_all + $lowest_guarantee;

	}

	$return_data["remuneration"] = $remuneration_all;
	$return_data["lowest_guarantee"] = $lowest_guarantee_all;

	return $return_data;
	exit();

}

function update_message_check_value($check_value,$data_id){

	$sql = sprintf("update staff_message_board set complete_flg='%s' where id='%s'",$check_value,$data_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(update_message_check_value)";
		exit();
	}

	return true;
	exit();
}

function get_chief_allowance_select_frm($chief_allowance_year,$chief_allowance_month,$chief_allowance_day){

	$year = intval(date('Y'));
	$year_start = $year - 3;
	$year_end = $year + 1;

	$html = '';
	$html .= '<select name="chief_allowance_year">';
	$html .= '<option value="-1">未選択</option>';

	for($i=$year_start;$i<=$year_end;$i++){

		if( $i == $chief_allowance_year ){

			$html .= '<option value="'.$i.'" selected>'.$i.'</option>';

		}else{

			$html .= '<option value="'.$i.'">'.$i.'</option>';

		}

	}

	$html .= '</select>';
	$html .= '年';
	$html .= '<select name="chief_allowance_month">';
	$html .= '<option value="-1">未選択</option>';

	for($i=1;$i<=12;$i++){

		if( $i == $chief_allowance_month ){

			$html .= '<option value="'.$i.'" selected>'.$i.'</option>';

		}else{

			$html .= '<option value="'.$i.'">'.$i.'</option>';

		}

	}

	$html .= '</select>';
	$html .= '月';
	$html .= '<select name="chief_allowance_day">';
	$html .= '<option value="-1">未選択</option>';

	for($i=1;$i<=31;$i++){

		if( $i == $chief_allowance_day ){

			$html .= '<option value="'.$i.'" selected>'.$i.'</option>';

		}else{

			$html .= '<option value="'.$i.'">'.$i.'</option>';

		}

	}

	$html .= '</select>';
	$html .= '日';

	return $html;
	exit();

}

function get_point_fix_select_frm($year,$month,$day){

	$year = intval(date('Y'));
	$year_start = $year - 3;
	$year_end = $year + 1;

	$html = '';
	$html .= '<select name="point_fix_year">';
	$html .= '<option value="-1">未選択</option>';

	for($i=$year_start;$i<=$year_end;$i++){

		if( $i == $year ){

			$html .= '<option value="'.$i.'" selected>'.$i.'</option>';

		}else{

			$html .= '<option value="'.$i.'">'.$i.'</option>';

		}

	}

	$html .= '</select>';
	$html .= '年';
	$html .= '<select name="point_fix_month">';
	$html .= '<option value="-1">未選択</option>';

	for($i=1;$i<=12;$i++){

		if( $i == $month ){

			$html .= '<option value="'.$i.'" selected>'.$i.'</option>';

		}else{

			$html .= '<option value="'.$i.'">'.$i.'</option>';

		}

	}

	$html .= '</select>';
	$html .= '月';
	$html .= '<select name="point_fix_day">';
	$html .= '<option value="-1">未選択</option>';

	for($i=1;$i<=31;$i++){

		if( $i == $day ){

			$html .= '<option value="'.$i.'" selected>'.$i.'</option>';

		}else{

			$html .= '<option value="'.$i.'">'.$i.'</option>';

		}

	}

	$html .= '</select>';
	$html .= '日';

	return $html;
	exit();

}

function get_point_fix_year_month_day($point_fix,$point_fix_start_time){

	if( $point_fix_start_time == "0" ){

		if( $point_fix == "0" ){

			$year = intval(date('Y'));
			$month = intval(date('m'));
			$day = intval(date('d'));

		}else{

			$year = 2015;
			$month = 1;
			$day = 1;
		}

	}else{

		$data = get_day_by_timestamp_common($point_fix_start_time);

		$year = $data["year"];
		$month = $data["month"];
		$day = $data["day"];

	}

	$data["year"] = $year;
	$data["month"] = $month;
	$data["day"] = $day;

	return $data;
	exit();

}

function get_csv_file_shop_report($page_month,$month_data,$sum_data,$sum_average_data,$hikaku_data_all,$hikaku_data_sale_average,$sum_data_pre,$sum_average_data_pre,$sale_data){

	$title_yoko = array(
		"0"=>"9月",
		"1"=>"合計",
		"2"=>"1日平均値",
		"3"=>"前月値",
		"4"=>"前月比",
		"5"=>"目標値",
		"6"=>"目標達成率"
	);

	$title_tate = array(
		"0"=>"売上",
		"1"=>"体制",
		"2"=>"機会ロス"
	);

	$title_yoko_num = count($title_yoko);
	$month_data_num = count($month_data);
	$sale_data_num = count($sale_data);

	$html = "";

	$tmp = "";
	$html .= "\"".$tmp."\"".",";

	for($i=0;$i<$title_yoko_num;$i++){

		$tmp = $title_yoko[$i];

		$html .= "\"".$tmp."\"".",";

	}

	for($i=0;$i<$month_data_num;$i++){

		$month = $month_data[$i]["month"];
		$day = $month_data[$i]["day"];
		$week = $month_data[$i]["week"];

		$tmp = sprintf("%s月%s日(%s)",$month,$day,$week);

		if( $i == ($month_data_num-1) ){

			$html .= "\"".$tmp."\""."\n";

		}else{

			$html .= "\"".$tmp."\"".",";

		}

	}

	$title = "売上";

	$shop_name = "tokyo_refle";
	$shop_data_tmp_hiki = 0;
	$shop_name_ja = "東京リフレ";
	$html .= get_uriage_for_csv($shop_name,$shop_name_ja,$title,$sum_average_data,$sum_average_data_pre,$hikaku_data_sale_average,$sale_data,$shop_data_tmp_hiki,$sale_data_num);

	$shop_name = "tokyo_aroma";
	$shop_data_tmp_hiki = 1;
	$shop_name_ja = "東京アロマ";
	$html .= get_uriage_for_csv($shop_name,$shop_name_ja,$title,$sum_average_data,$sum_average_data_pre,$hikaku_data_sale_average,$sale_data,$shop_data_tmp_hiki,$sale_data_num);

	$shop_name = "lymph_tokyo";
	$shop_data_tmp_hiki = 2;
	$shop_name_ja = "リンパ東京";
	$html .= get_uriage_for_csv($shop_name,$shop_name_ja,$title,$sum_average_data,$sum_average_data_pre,$hikaku_data_sale_average,$sale_data,$shop_data_tmp_hiki,$sale_data_num);

	$shop_name = "yokohama_refle";
	$shop_data_tmp_hiki = 4;
	$shop_name_ja = "横浜リフレ";
	$html .= get_uriage_for_csv($shop_name,$shop_name_ja,$title,$sum_average_data,$sum_average_data_pre,$hikaku_data_sale_average,$sale_data,$shop_data_tmp_hiki,$sale_data_num);

	$shop_name = "sapporo_refle";
	$shop_data_tmp_hiki = 3;
	$shop_name_ja = "札幌リフレ";
	$html .= get_uriage_for_csv($shop_name,$shop_name_ja,$title,$sum_average_data,$sum_average_data_pre,$hikaku_data_sale_average,$sale_data,$shop_data_tmp_hiki,$sale_data_num);

	$shop_name = "sendai_refle";
	$shop_data_tmp_hiki = 5;
	$shop_name_ja = "仙台リフレ";
	$html .= get_uriage_for_csv($shop_name,$shop_name_ja,$title,$sum_average_data,$sum_average_data_pre,$hikaku_data_sale_average,$sale_data,$shop_data_tmp_hiki,$sale_data_num);

	$shop_name = "osaka_refle";
	$shop_data_tmp_hiki = 6;
	$shop_name_ja = "大阪リフレ";
	$html .= get_uriage_for_csv($shop_name,$shop_name_ja,$title,$sum_average_data,$sum_average_data_pre,$hikaku_data_sale_average,$sale_data,$shop_data_tmp_hiki,$sale_data_num);

	$shop_name = "osaka_aroma";
	$shop_data_tmp_hiki = 7;
	$shop_name_ja = "大阪AS";
	$html .= get_uriage_for_csv($shop_name,$shop_name_ja,$title,$sum_average_data,$sum_average_data_pre,$hikaku_data_sale_average,$sale_data,$shop_data_tmp_hiki,$sale_data_num);

	$shop_name = "tokyo_reraku";
	$shop_data_tmp_hiki = 8;
	$shop_name_ja = "東京リラク";
	$html .= get_uriage_for_csv($shop_name,$shop_name_ja,$title,$sum_average_data,$sum_average_data_pre,$hikaku_data_sale_average,$sale_data,$shop_data_tmp_hiki,$sale_data_num);

	$shop_name = "tokyo_bigao";
	$shop_data_tmp_hiki = 9;
	$shop_name_ja = "BIGAO";
	$html .= get_uriage_for_csv($shop_name,$shop_name_ja,$title,$sum_average_data,$sum_average_data_pre,$hikaku_data_sale_average,$sale_data,$shop_data_tmp_hiki,$sale_data_num);

	$ja = "一日売上合計";
	$html .= "\"".$title."\"".",";
	$html .= "\"".$ja."\"".",";
	$html .= "\"".if_null_value($sum_data["price"])."\"".",";
	$html .= "\"".if_null_value($sum_data["average"])."\"".",";
	$html .= "\"".if_null_value($sum_data_pre["average"])."\"".",";
	$html .= "\"".if_null_value($hikaku_data_all["sale"]."％")."\"".",";
	$html .= "\"".if_null_value($sum_data["target"]["sale"]["value"])."\"".",";
	$html .= "\"".if_null_value($sum_data["target"]["sale"]["rate"]."％")."\"".",";
	for($i=0;$i<$sale_data_num;$i++){
		$price = if_null_value($sale_data[$i]["total_price"]);
		if( $i == ($sale_data_num-1) ){
			$html .= "\"".$price."\""."\n";
		}else{
			$html .= "\"".$price."\"".",";
		}
	}

	$title = "体制";

	$area = "tokyo";
	$area_ja = "東京";
	$html .= get_taisei_csv(
$area,$area_ja,$sum_average_data,$sum_average_data_pre,$hikaku_data_sale_average,$sale_data,$sale_data_num,$title);

	$area = "yokohama";
	$area_ja = "横浜";
	$html .= get_taisei_csv(
$area,$area_ja,$sum_average_data,$sum_average_data_pre,$hikaku_data_sale_average,$sale_data,$sale_data_num,$title);

	$area = "sapporo";
	$area_ja = "札幌";
	$html .= get_taisei_csv(
$area,$area_ja,$sum_average_data,$sum_average_data_pre,$hikaku_data_sale_average,$sale_data,$sale_data_num,$title);

	$area = "sendai";
	$area_ja = "仙台";
	$html .= get_taisei_csv(
$area,$area_ja,$sum_average_data,$sum_average_data_pre,$hikaku_data_sale_average,$sale_data,$sale_data_num,$title);

	$area = "osaka";
	$area_ja = "大阪";
	$html .= get_taisei_csv(
$area,$area_ja,$sum_average_data,$sum_average_data_pre,$hikaku_data_sale_average,$sale_data,$sale_data_num,$title);

	$ja = "合計セラピスト体制";
	$html .= "\"".$title."\"".",";
	$html .= "\"".$ja."\"".",";
	$html .= "\"".if_null_value($sum_data["attendance_num"]["value"])."\"".",";
	$html .= "\"".if_null_value($sum_data["attendance_num"]["average"])."\"".",";
	$html .= "\"".if_null_value($sum_data_pre["attendance_num"]["average"])."\"".",";
	$html .= "\"".if_null_value($hikaku_data_all["attendance_num"]."％")."\"".",";
	$html .= "\""."---"."\"".",";
	$html .= "\""."---"."\"".",";
	for($i=0;$i<$sale_data_num;$i++){
		$value = if_null_value($sale_data[$i]["attendance_num_all"]);
		if( $i == ($sale_data_num-1) ){
			$html .= "\"".$value."\""."\n";
		}else{
			$html .= "\"".$value."\"".",";
		}
	}

	$ja = "総成約数（全店舗）";
	$html .= "\"".$title."\"".",";
	$html .= "\"".$ja."\"".",";
	$html .= "\"".if_null_value($sum_data["operation_num"]["value"])."\"".",";
	$html .= "\"".if_null_value($sum_data["operation_num"]["average"])."\"".",";
	$html .= "\"".if_null_value($sum_data_pre["operation_num"]["average"])."\"".",";
	$html .= "\"".if_null_value($hikaku_data_all["operation_num"]."％")."\"".",";
	$html .= "\""."---"."\"".",";
	$html .= "\""."---"."\"".",";
	for($i=0;$i<$sale_data_num;$i++){
		$value = if_null_value($sale_data[$i]["operation_num_all"]);
		if( $i == ($sale_data_num-1) ){
			$html .= "\"".$value."\""."\n";
		}else{
			$html .= "\"".$value."\"".",";
		}
	}

	$title = "機会ロス";

	$site_name = "tokyo_refle";
	$site_name_ja = "東京リフレ";
	$shop_data_hiki = 0;
	$html .= get_kikai_loss_csv(
$site_name,$shop_data_hiki,$site_name_ja,$title,$sum_average_data,$sum_average_data_pre,$hikaku_data_sale_average,$sale_data,$sale_data_num);



	$ja = "セラピスト不足(東京リフレ)";
	$site_name = "tokyo_refle";
	$shop_data_hiki = 0;
	$loss_name="loss_fusoku";
	$html .= get_kikai_loss_csv_2(
$site_name,$shop_data_hiki,$title,$sum_average_data,$sum_average_data_pre,$hikaku_data_sale_average,$sale_data,
$sale_data_num,$ja,$loss_name);

	$ja = "指名セラピスト不在(東京リフレ)";
	$site_name = "tokyo_refle";
	$shop_data_hiki = 0;
	$loss_name="loss_fuzai";
	$html .= get_kikai_loss_csv_2(
$site_name,$shop_data_hiki,$title,$sum_average_data,$sum_average_data_pre,$hikaku_data_sale_average,$sale_data,
$sale_data_num,$ja,$loss_name);

	$ja = "営業時間前(東京リフレ)";
	$site_name = "tokyo_refle";
	$shop_data_hiki = 0;
	$loss_name="loss_mae";
	$html .= get_kikai_loss_csv_2(
$site_name,$shop_data_hiki,$title,$sum_average_data,$sum_average_data_pre,$hikaku_data_sale_average,$sale_data,
$sale_data_num,$ja,$loss_name);



	$site_name = "tokyo_aroma";
	$site_name_ja = "東京アロマ";
	$shop_data_hiki = 1;
	$html .= get_kikai_loss_csv(
$site_name,$shop_data_hiki,$site_name_ja,$title,$sum_average_data,$sum_average_data_pre,$hikaku_data_sale_average,$sale_data,$sale_data_num);

	$site_name = "lymph_tokyo";
	$site_name_ja = "リンパ東京";
	$shop_data_hiki = 2;
	$html .= get_kikai_loss_csv(
$site_name,$shop_data_hiki,$site_name_ja,$title,$sum_average_data,$sum_average_data_pre,$hikaku_data_sale_average,$sale_data,$sale_data_num);

	$site_name = "sapporo_refle";
	$site_name_ja = "札幌リフレ";
	$shop_data_hiki = 3;
	$html .= get_kikai_loss_csv(
$site_name,$shop_data_hiki,$site_name_ja,$title,$sum_average_data,$sum_average_data_pre,$hikaku_data_sale_average,$sale_data,$sale_data_num);

	$site_name = "yokohama_refle";
	$site_name_ja = "横浜リフレ";
	$shop_data_hiki = 4;
	$html .= get_kikai_loss_csv(
$site_name,$shop_data_hiki,$site_name_ja,$title,$sum_average_data,$sum_average_data_pre,$hikaku_data_sale_average,$sale_data,$sale_data_num);

	$site_name = "sendai_refle";
	$site_name_ja = "仙台リフレ";
	$shop_data_hiki = 5;
	$html .= get_kikai_loss_csv(
$site_name,$shop_data_hiki,$site_name_ja,$title,$sum_average_data,$sum_average_data_pre,$hikaku_data_sale_average,$sale_data,$sale_data_num);

	$site_name = "osaka_refle";
	$site_name_ja = "大阪リフレ";
	$shop_data_hiki = 6;
	$html .= get_kikai_loss_csv(
$site_name,$shop_data_hiki,$site_name_ja,$title,$sum_average_data,$sum_average_data_pre,$hikaku_data_sale_average,$sale_data,$sale_data_num);

	$site_name = "osaka_aroma";
	$site_name_ja = "大阪AS";
	$shop_data_hiki = 7;
	$html .= get_kikai_loss_csv(
$site_name,$shop_data_hiki,$site_name_ja,$title,$sum_average_data,$sum_average_data_pre,$hikaku_data_sale_average,$sale_data,$sale_data_num);

	$site_name = "tokyo_reraku";
	$site_name_ja = "東京リラク";
	$shop_data_hiki = 8;
	$html .= get_kikai_loss_csv(
$site_name,$shop_data_hiki,$site_name_ja,$title,$sum_average_data,$sum_average_data_pre,$hikaku_data_sale_average,$sale_data,$sale_data_num);

	$site_name = "tokyo_bigao";
	$site_name_ja = "BIGAO";
	$shop_data_hiki = 9;
	$html .= get_kikai_loss_csv(
$site_name,$shop_data_hiki,$site_name_ja,$title,$sum_average_data,$sum_average_data_pre,$hikaku_data_sale_average,$sale_data,$sale_data_num);


	$site_name = "tokyo_refle";
	$shop_data_hiki = 0;
	$title = "東京リフレ";
	$html .= get_shop_csv(
$site_name,$shop_data_hiki,$title,$sum_average_data,$sum_average_data_pre,$hikaku_data_sale_average,$sale_data,$sale_data_num);

	$site_name = "tokyo_aroma";
	$shop_data_hiki = 1;
	$title = "東京アロマ";
	$html .= get_shop_csv(
$site_name,$shop_data_hiki,$title,$sum_average_data,$sum_average_data_pre,$hikaku_data_sale_average,$sale_data,$sale_data_num);

	$site_name = "lymph_tokyo";
	$shop_data_hiki = 2;
	$title = "リンパ東京";
	$html .= get_shop_csv(
$site_name,$shop_data_hiki,$title,$sum_average_data,$sum_average_data_pre,$hikaku_data_sale_average,$sale_data,$sale_data_num);

	$site_name = "yokohama_refle";
	$shop_data_hiki = 4;
	$title = "横浜リフレ";
	$html .= get_shop_csv(
$site_name,$shop_data_hiki,$title,$sum_average_data,$sum_average_data_pre,$hikaku_data_sale_average,$sale_data,$sale_data_num);

	$site_name = "sapporo_refle";
	$shop_data_hiki = 3;
	$title = "札幌リフレ";
	$html .= get_shop_csv(
$site_name,$shop_data_hiki,$title,$sum_average_data,$sum_average_data_pre,$hikaku_data_sale_average,$sale_data,$sale_data_num);

	$site_name = "sendai_refle";
	$shop_data_hiki = 5;
	$title = "仙台リフレ";
	$html .= get_shop_csv(
$site_name,$shop_data_hiki,$title,$sum_average_data,$sum_average_data_pre,$hikaku_data_sale_average,$sale_data,$sale_data_num);

	$site_name = "osaka_refle";
	$shop_data_hiki = 6;
	$title = "大阪リフレ";
	$html .= get_shop_csv(
$site_name,$shop_data_hiki,$title,$sum_average_data,$sum_average_data_pre,$hikaku_data_sale_average,$sale_data,$sale_data_num);

	$site_name = "osaka_aroma";
	$shop_data_hiki = 7;
	$title = "大阪AS";
	$html .= get_shop_csv(
$site_name,$shop_data_hiki,$title,$sum_average_data,$sum_average_data_pre,$hikaku_data_sale_average,$sale_data,$sale_data_num);

	$site_name = "tokyo_reraku";
	$shop_data_hiki = 8;
	$title = "東京リラク";
	$html .= get_shop_csv(
$site_name,$shop_data_hiki,$title,$sum_average_data,$sum_average_data_pre,$hikaku_data_sale_average,$sale_data,$sale_data_num);

	$site_name = "tokyo_bigao";
	$shop_data_hiki = 9;
	$title = "BIGAO";
	$html .= get_shop_csv(
$site_name,$shop_data_hiki,$title,$sum_average_data,$sum_average_data_pre,$hikaku_data_sale_average,$sale_data,$sale_data_num);

	return $html;
	exit();

}

function get_uriage_for_csv(
$shop_name,$shop_name_ja,$title,$sum_average_data,$sum_average_data_pre,$hikaku_data_sale_average,$sale_data,$shop_data_tmp_hiki,$sale_data_num){

	$html = "";

	$html .= "\"".$title."\"".",";
	$html .= "\"".$shop_name_ja."\"".",";
	$html .= "\"".if_null_value($sum_average_data[$shop_name]["price"])."\"".",";
	$html .= "\"".if_null_value($sum_average_data[$shop_name]["average"])."\"".",";
	$html .= "\"".if_null_value($sum_average_data_pre[$shop_name]["average"])."\"".",";
	$html .= "\"".if_null_value($hikaku_data_sale_average["sale"][$shop_name]."％")."\"".",";
	$html .= "\"".if_null_value($sum_average_data[$shop_name]["target"]["sale_price"]["value"])."\"".",";
	$html .= "\"".if_null_value($sum_average_data[$shop_name]["target"]["sale_price"]["rate"]."％")."\"".",";
	for($i=0;$i<$sale_data_num;$i++){
		$shop_data_tmp = $sale_data[$i]["shop_data"];
		$price = if_null_value($shop_data_tmp[$shop_data_tmp_hiki]["price"]);
		if( $i == ($sale_data_num-1) ){
			$html .= "\"".$price."\""."\n";
		}else{
			$html .= "\"".$price."\"".",";
		}
	}

	return $html;
	exit();

}

function if_null_value($data){

	$tmp = str_replace("％", "", $data);

	if( $tmp == "" ){

		$data = "---";

	}

	return $data;
	exit();

}

function get_taisei_csv(
$area,$area_ja,$sum_average_data,$sum_average_data_pre,$hikaku_data_sale_average,$sale_data,$sale_data_num,$title){

	$ja = sprintf("セラピスト体制(%s）",$area_ja);
	$html .= "\"".$title."\"".",";
	$html .= "\"".$ja."\"".",";
	$html .= "\"".if_null_value($sum_average_data[$area]["attendance_num"]["value"])."\"".",";
	$html .= "\"".if_null_value($sum_average_data[$area]["attendance_num"]["average"])."\"".",";
	$html .= "\"".if_null_value($sum_average_data_pre[$area]["attendance_num"]["average"])."\"".",";
	$html .= "\"".if_null_value($hikaku_data_sale_average["attendance_num"][$area]."％")."\"".",";
	$html .= "\""."---"."\"".",";
	$html .= "\""."---"."\"".",";
	for($i=0;$i<$sale_data_num;$i++){
		$value = if_null_value($sale_data[$i]["attendance_num"][$area]);
		if( $i == ($sale_data_num-1) ){
			$html .= "\"".$value."\""."\n";
		}else{
			$html .= "\"".$value."\"".",";
		}
	}

	$ja = sprintf("施術数（%s）",$area_ja);
	$html .= "\"".$title."\"".",";
	$html .= "\"".$ja."\"".",";
	$html .= "\"".if_null_value($sum_average_data[$area]["operation_num"]["value"])."\"".",";
	$html .= "\"".if_null_value($sum_average_data[$area]["operation_num"]["average"])."\"".",";
	$html .= "\"".if_null_value($sum_average_data_pre[$area]["operation_num"]["average"])."\"".",";
	$html .= "\"".if_null_value($hikaku_data_sale_average["operation_num"][$area]."％")."\"".",";
	$html .= "\""."---"."\"".",";
	$html .= "\""."---"."\"".",";
	for($i=0;$i<$sale_data_num;$i++){
		$value = if_null_value($sale_data[$i]["operation_num"][$area]);
		if( $i == ($sale_data_num-1) ){
			$html .= "\"".$value."\""."\n";
		}else{
			$html .= "\"".$value."\"".",";
		}
	}

	return $html;
	exit();

}

function get_kikai_loss_csv(
$site_name,$shop_data_hiki,$site_name_ja,$title,$sum_average_data,$sum_average_data_pre,$hikaku_data_sale_average,$sale_data,$sale_data_num){

	$ja = sprintf("取りこぼし（%s）",$site_name_ja);
	$html .= "\"".$title."\"".",";
	$html .= "\"".$ja."\"".",";
	$html .= "\"".if_null_value($sum_average_data[$site_name]["loss_data"]["value"]["loss"])."\"".",";
	$html .= "\"".if_null_value($sum_average_data[$site_name]["loss_data"]["average"]["loss"])."\"".",";
	$html .= "\"".if_null_value($sum_average_data_pre[$site_name]["loss_data"]["average"]["loss"])."\"".",";
	$html .= "\"".if_null_value($hikaku_data_sale_average["loss_data"][$site_name]["loss"]."％")."\"".",";
	$html .= "\""."---"."\"".",";
	$html .= "\""."---"."\"".",";
	for($i=0;$i<$sale_data_num;$i++){
		$shop_data = $sale_data[$i]["shop_data"];
		$value = if_null_value($shop_data[$shop_data_hiki]["loss_data"]["loss"]);
		if( $i == ($sale_data_num-1) ){
			$html .= "\"".$value."\""."\n";
		}else{
			$html .= "\"".$value."\"".",";
		}
	}

	return $html;
	exit();

}

function get_kikai_loss_csv_2(
$site_name,$shop_data_hiki,$title,$sum_average_data,$sum_average_data_pre,$hikaku_data_sale_average,$sale_data,
$sale_data_num,$ja,$loss_name){

	$html .= "\"".$title."\"".",";
	$html .= "\"".$ja."\"".",";
	$html .= "\"".if_null_value($sum_average_data[$site_name]["loss_data"]["value"][$loss_name])."\"".",";
	$html .= "\"".if_null_value($sum_average_data[$site_name]["loss_data"]["average"][$loss_name])."\"".",";
	$html .= "\"".if_null_value($sum_average_data_pre[$site_name]["loss_data"]["average"][$loss_name])."\"".",";
	$html .= "\"".if_null_value($hikaku_data_sale_average["loss_data"][$site_name][$loss_name]."％")."\"".",";
	$html .= "\""."---"."\"".",";
	$html .= "\""."---"."\"".",";
	for($i=0;$i<$sale_data_num;$i++){
		$shop_data = $sale_data[$i]["shop_data"];
		$value = if_null_value($shop_data[$shop_data_hiki]["loss_data"][$loss_name]);
		if( $i == ($sale_data_num-1) ){
			$html .= "\"".$value."\""."\n";
		}else{
			$html .= "\"".$value."\"".",";
		}
	}

	return $html;
	exit();

}

function get_shop_csv(
$site_name,$shop_data_hiki,$title,$sum_average_data,$sum_average_data_pre,$hikaku_data_sale_average,$sale_data,$sale_data_num){

	$html = "";

	$ja = "受電数(メール含む）";
	$html .= "\"".$title."\"".",";
	$html .= "\"".$ja."\"".",";
	$html .= "\"".if_null_value($sum_average_data[$site_name]["call_num"]["value"])."\"".",";
	$html .= "\"".if_null_value($sum_average_data[$site_name]["call_num"]["average"])."\"".",";
	$html .= "\"".if_null_value($sum_average_data_pre[$site_name]["call_num"]["average"])."\"".",";
	$html .= "\"".if_null_value($hikaku_data_sale_average["call_num"][$site_name]["call_num"]."％")."\"".",";
	$html .= "\"".if_null_value($sum_average_data[$site_name]["target"]["call_num"]["value"])."\"".",";
	$html .= "\"".if_null_value($sum_average_data[$site_name]["target"]["call_num"]["rate"]."％")."\"".",";
	for($i=0;$i<$sale_data_num;$i++){
		$shop_data = $sale_data[$i]["shop_data"];
		$value = if_null_value($shop_data[$shop_data_hiki]["call_num"]);
		if( $i == ($sale_data_num-1) ){
			$html .= "\"".$value."\""."\n";
		}else{
			$html .= "\"".$value."\"".",";
		}
	}

	$ja = "成約数";
	$html .= "\"".$title."\"".",";
	$html .= "\"".$ja."\"".",";
	$html .= "\"".if_null_value($sum_average_data[$site_name]["operation_num"]["value"])."\"".",";
	$html .= "\"".if_null_value($sum_average_data[$site_name]["operation_num"]["average"])."\"".",";
	$html .= "\"".if_null_value($sum_average_data_pre[$site_name]["operation_num"]["average"])."\"".",";
	$html .= "\"".if_null_value($hikaku_data_sale_average["operation_num"][$site_name]."％")."\"".",";
	$html .= "\"".if_null_value($sum_average_data[$site_name]["target"]["agreement_num"]["value"])."\"".",";
	$html .= "\"".if_null_value($sum_average_data[$site_name]["target"]["agreement_num"]["rate"]."％")."\"".",";
	for($i=0;$i<$sale_data_num;$i++){
		$shop_data = $sale_data[$i]["shop_data"];
		$value = if_null_value($shop_data[$shop_data_hiki]["operation_num"]);
		if( $i == ($sale_data_num-1) ){
			$html .= "\"".$value."\""."\n";
		}else{
			$html .= "\"".$value."\"".",";
		}
	}

	$ja = "成約率";
	$html .= "\"".$title."\"".",";
	$html .= "\"".$ja."\"".",";
	$html .= "\""."---"."\"".",";
	$html .= "\"".if_null_value($sum_average_data[$site_name]["operation_num"]["rate"]."％")."\"".",";
	$html .= "\"".if_null_value($sum_average_data_pre[$site_name]["operation_num"]["rate"]."％")."\"".",";
	$html .= "\"".if_null_value($hikaku_data_sale_average["call_num"][$site_name]["agreement_num"]."％")."\"".",";
	$html .= "\""."---"."\"".",";
	$html .= "\""."---"."\"".",";
	for($i=0;$i<$sale_data_num;$i++){
		$shop_data = $sale_data[$i]["shop_data"];
		$value = if_null_value($shop_data[$shop_data_hiki]["agreement_num_rate"]."％");
		if( $i == ($sale_data_num-1) ){
			$html .= "\"".$value."\""."\n";
		}else{
			$html .= "\"".$value."\"".",";
		}
	}

	$ja = "新規客";
	$html .= "\"".$title."\"".",";
	$html .= "\"".$ja."\"".",";
	$html .= "\"".if_null_value($sum_average_data[$site_name]["operation_num_new"]["value"])."\"".",";
	$html .= "\"".if_null_value($sum_average_data[$site_name]["operation_num_new"]["average"])."\"".",";
	$html .= "\"".if_null_value($sum_average_data_pre[$site_name]["operation_num_new"]["average"])."\"".",";
	$html .= "\"".if_null_value($hikaku_data_sale_average["operation_num_new"]["average"][$site_name]."％")."\"".",";
	$html .= "\"".if_null_value($sum_average_data[$site_name]["target"]["customer_new"]["value"])."\"".",";
	$html .= "\"".if_null_value($sum_average_data[$site_name]["target"]["customer_new"]["rate"]."％")."\"".",";
	for($i=0;$i<$sale_data_num;$i++){
		$shop_data = $sale_data[$i]["shop_data"];
		$value = if_null_value($shop_data[$shop_data_hiki]["operation_num_new"]);
		if( $i == ($sale_data_num-1) ){
			$html .= "\"".$value."\""."\n";
		}else{
			$html .= "\"".$value."\"".",";
		}
	}

	$ja = "新規客率";
	$html .= "\"".$title."\"".",";
	$html .= "\"".$ja."\"".",";
	$html .= "\""."---"."\"".",";
	$html .= "\"".if_null_value($sum_average_data[$site_name]["operation_num_new"]["rate"]."％")."\"".",";
	$html .= "\"".if_null_value($sum_average_data_pre[$site_name]["operation_num_new"]["rate"]."％")."\"".",";
	$html .= "\"".if_null_value($hikaku_data_sale_average["operation_num_new"]["rate"][$site_name]."％")."\"".",";
	$html .= "\""."---"."\"".",";
	$html .= "\""."---"."\"".",";
	for($i=0;$i<$sale_data_num;$i++){
		$shop_data = $sale_data[$i]["shop_data"];
		$value = if_null_value($shop_data[$shop_data_hiki]["operation_rate_new"]."％");
		if( $i == ($sale_data_num-1) ){
			$html .= "\"".$value."\""."\n";
		}else{
			$html .= "\"".$value."\"".",";
		}
	}

	$ja = "リピーター客(2回以降）";
	$html .= "\"".$title."\"".",";
	$html .= "\"".$ja."\"".",";
	$html .= "\"".if_null_value($sum_average_data[$site_name]["operation_num_repeat"]["value"])."\"".",";
	$html .= "\"".if_null_value($sum_average_data[$site_name]["operation_num_repeat"]["average"])."\"".",";
	$html .= "\"".if_null_value($sum_average_data_pre[$site_name]["operation_num_repeat"]["average"])."\"".",";
	$html .= "\"".if_null_value($hikaku_data_sale_average["operation_num_repeat"]["average"][$site_name]."％")."\"".",";
	$html .= "\"".if_null_value($sum_average_data[$site_name]["target"]["repeater_num"]["value"])."\"".",";
	$html .= "\"".if_null_value($sum_average_data[$site_name]["target"]["repeater_num"]["rate"]."％")."\"".",";
	for($i=0;$i<$sale_data_num;$i++){
		$shop_data = $sale_data[$i]["shop_data"];
		$value = if_null_value($shop_data[$shop_data_hiki]["operation_num_repeat"]);
		if( $i == ($sale_data_num-1) ){
			$html .= "\"".$value."\""."\n";
		}else{
			$html .= "\"".$value."\"".",";
		}
	}

	$ja = "リピーター率";
	$html .= "\"".$title."\"".",";
	$html .= "\"".$ja."\"".",";
	$html .= "\""."---"."\"".",";
	$html .= "\"".if_null_value($sum_average_data[$site_name]["operation_num_repeat"]["rate"]."％")."\"".",";
	$html .= "\"".if_null_value($sum_average_data_pre[$site_name]["operation_num_repeat"]["rate"]."％")."\"".",";
	$html .= "\"".if_null_value($hikaku_data_sale_average["operation_num_repeat"]["rate"][$site_name]."％")."\"".",";
	$html .= "\""."---"."\"".",";
	$html .= "\""."---"."\"".",";
	for($i=0;$i<$sale_data_num;$i++){
		$shop_data = $sale_data[$i]["shop_data"];
		$value = if_null_value($shop_data[$shop_data_hiki]["operation_rate_repeat"]."％");
		if( $i == ($sale_data_num-1) ){
			$html .= "\"".$value."\""."\n";
		}else{
			$html .= "\"".$value."\"".",";
		}
	}

	return $html;
	exit();

}

function check_exist_fixtures_code($code){

	$sql = sprintf("select id from fixtures where delete_flg=0 and code='%s'",$code);
	$res = mysql_query($sql, DbCon);
	if( $res == false ){
		echo "error!(check_exist_fixtures_code)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	if( $row["id"] == "" ){

		return false;
		exit();

	}else{

		return true;
		exit();

	}
}

function insert_fixtures($fixtures_name,$code,$class_use,$class_manage,$class_procure){

	$sql = sprintf("
insert into fixtures(name,code,class_use,class_manage,class_procure) values('%s','%s','%s','%s','%s')",
$fixtures_name,$code,$class_use,$class_manage,$class_procure);

	$res = mysql_query($sql, DbCon);

	if($res === false){

		echo "error!(insert_fixtures)";
		exit();

	}

	return true;
	exit();

}

function get_fixtures_data(){

	$sql = "select * from fixtures where delete_flg=0";
	$res = mysql_query($sql, DbCon);
	if( $res == false ){
		echo "error!(get_fixtures_data)";
		exit();
	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$list_data[$i++] = $row;

	}

	return $list_data;
	exit();
}

function get_fixtures_data_by_id($id){

	$sql = sprintf("select * from fixtures where id='%s'",$id);
	$res = mysql_query($sql, DbCon);
	if( $res == false ){
		echo "error!(get_fixtures_data_by_id)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();
}

function get_fixtures_name_by_id($id){

	$sql = sprintf("select name from fixtures where id='%s'",$id);
	$res = mysql_query($sql, DbCon);
	if( $res == false ){
		echo "error!(get_fixtures_name_by_id)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row["name"];
	exit();
}

function update_fixtures($fixtures_name,$class_use,$class_manage,$class_procure,$fixtures_id){

	$sql = sprintf("update fixtures set name='%s',class_use='%s',class_manage='%s',class_procure='%s' where id='%s'",$fixtures_name,$class_use,$class_manage,$class_procure,$fixtures_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(update_fixtures)";
		exit();
	}

	return true;
	exit();
}

function check_exist_fixtures_class_code($code,$fixtures_id){

	$sql = sprintf("select id from fixtures_class where delete_flg=0 and code='%s' and fixtures_id='%s'", $code,$fixtures_id);
	$res = mysql_query($sql, DbCon);
	if( $res == false ){
		echo "error!(check_exist_fixtures_class_code)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	if( $row["id"] == "" ){

		return false;
		exit();

	}else{

		return true;
		exit();

	}
}

function insert_fixtures_class($fixtures_id,$code,$name_class,$name_product){

	$sql = sprintf("insert into fixtures_class(fixtures_id,code,name_class,name_product) values('%s','%s','%s','%s')",$fixtures_id,$code,$name_class,$name_product);
	$res = mysql_query($sql, DbCon);
	if($res === false){
		echo "error!(insert_fixtures_class)";
		exit();
	}

	return true;
	exit();
}

//----備品配列取得
function get_fixtures_class_data_by_fixtures_id($fixtures_id){
	return PHP_get_fixtures_class_data($fixtures_id);
}
//----備品配列取得
function PHP_get_fixtures_class_data($fixtures_id) {

	if($fixtures_id == -1) {
		$sql = "select * from fixtures_class where delete_flg=0 order by fixtures_id,code";
	} else {
		$sql = sprintf("select * from fixtures_class where delete_flg=0 and fixtures_id='%s'",$fixtures_id);
	}
	$res = mysql_query($sql, DbCon);
	//echo $res . "/" . $sql;
	if( $res == false ){
		echo "error!(get_fixtures_class_data_by_fixtures_id)";
		exit();
	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){
		$list_data[$i] = $row;
		$i++;
	}

	return $list_data;
}

function delete_fixtures($fixtures_id){

	$sql = sprintf("update fixtures set delete_flg='1' where id='%s'",$fixtures_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(delete_fixtures)";
		exit();
	}

	return true;
	exit();
}

function update_fixtures_class($fixtures_class_id,$name_class,$name_product){

	$sql = sprintf("update fixtures_class set name_class='%s',name_product='%s' where id='%s'",$name_class,$name_product,$fixtures_class_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(update_fixtures_class)";
		exit();
	}

	return true;
	exit();
}

function delete_fixtures_class($fixtures_class_id){

	$sql = sprintf("update fixtures_class set delete_flg='1' where id='%s'",$fixtures_class_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(delete_fixtures_class)";
		exit();
	}

	return true;
	exit();
}

function get_fixtures_select_frm($fixtures_id,$select_id){

	$fixtures_data = get_fixtures_data();

	$fixtures_data_num = count($fixtures_data);

	$html = '<select id="'.$select_id.'">';

	for($i=0;$i<$fixtures_data_num;$i++){

		$id = $fixtures_data[$i]["id"];
		$name = $fixtures_data[$i]["name"];

		if( $id == $fixtures_id ){

			$html .= sprintf('<option value="%s" selected>%s</option>',$id,$name);

		}else{

			$html .= sprintf('<option value="%s">%s</option>',$id,$name);

		}

	}

	$html .= '</select>';

	return $html;
	exit();

}

function get_day_select_frm_fixtures(){

	$today_ts = get_today_ts_common();

	$data = get_today_year_month_day_common();

	$year_now = $data["year"];
	$month_now = $data["month"];
	$day_now = $data["day"];

	$num = "5";
	$data = get_old_day_common($year_now,$month_now,$day_now,$num);

	$year_old = $data["year"];
	$month_old = $data["month"];
	$day_old = $data["day"];

	$html = "";

	$html .= '<select name="day_select">';

	for( $i=0; $i<15; $i++ ){

		$data = get_mirai_day_common($year_old,$month_old,$day_old,$i);

		$year_tmp = $data["year"];
		$month_tmp = $data["month"];
		$day_tmp = $data["day"];

		$option_value = get_timestamp_by_year_month_day_common($year_tmp,$month_tmp,$day_tmp);

		$option_text = sprintf('%s/%s/%s',$year_tmp,$month_tmp,$day_tmp);

		if( $option_value == $today_ts ){

			$html .= sprintf('<option value="%s" selected>%s</option>',$option_value,$option_text);

		}else{

			$html .= sprintf('<option value="%s">%s</option>',$option_value,$option_text);

		}

	}

	$html .= '</select>';

	return $html;
	exit();

}

function get_fixtures_class_data_by_id($id){

	$sql = sprintf("select * from fixtures_class where id='%s'",$id);
	$res = mysql_query($sql, DbCon);
	if( $res == false ){
		echo "error!(get_fixtures_class_data_by_id)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();
}

function get_fixtures_class_name_class_by_id($id){

	$sql = sprintf("select name_class from fixtures_class where id='%s'",$id);
	$res = mysql_query($sql, DbCon);
	if( $res == false ){
		echo "error!(get_fixtures_class_name_class_by_id)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row["name_class"];
	exit();
}

function get_number_serial_max_from_fixtures_stock(){

	$sql = "select number_serial from fixtures_stock where delete_flg=0 order by number_serial desc limit 0,1";
	$res = mysql_query($sql, DbCon);
	if( $res == false ){
		echo "error!(get_number_serial_max_from_fixtures_stock)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	$number_serial = $row["number_serial"];

	if($number_serial==""){

		$number_serial = 0;

	}

	return $number_serial;
	exit();
}

function get_number_serial_from_fixtures_stock(){

	$number_serial = get_number_serial_max_from_fixtures_stock();

	$number_serial++;

	return $number_serial;
	exit();

}

function insert_fixtures_stock_purchase($area,$fixtures_class_id,$quantity,$price_one,$price_all,$day_purchase){

	$number_serial = get_number_serial_from_fixtures_stock();

	$class_state = "1";

	$sql = sprintf("
insert into fixtures_stock(
fixtures_class_id,
area,
area_from,
number_serial,
quantity,
class_state,
price_one,
price_all,
day_purchase)
values('%s','%s','%s','%s','%s','%s','%s','%s','%s')",
$fixtures_class_id,
$area,
$area,
$number_serial,
$quantity,
$class_state,
$price_one,
$price_all,
$day_purchase);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res === false){

		echo "error!(insert_fixtures_stock_purchase)";
		exit();

	}

	return true;
	exit();

}

function get_fixtures_stock_data_2($fixtures_class_id,$class_state){

	$data = get_fixtures_class_data_by_id($fixtures_class_id);
	$fixtures_id = $data["fixtures_id"];
	$name_class = $data["name_class"];
	$name_product = $data["name_product"];

	$data = get_fixtures_data_by_id($fixtures_id);
	$fixtures_name = $data["name"];
	$class_use = $data["class_use"];
	$class_manage = $data["class_manage"];
	$class_procure = $data["class_procure"];

	$class_use_ja = get_class_use_ja($class_use);
	$class_manage_ja = get_class_manage_ja($class_manage);
	$class_procure_ja = get_class_procure_ja($class_procure);

	$sql = sprintf("select * from fixtures_stock where delete_flg=0 and fixtures_class_id='%s' and class_state='%s'",$fixtures_class_id,$class_state);
	$res = mysql_query($sql, DbCon);
	if( $res == false ){
		echo "error!(get_fixtures_stock_data_2)";
		exit();
	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$list_data[$i] = $row;

		$list_data[$i]["name_class"] = $name_class;
		$list_data[$i]["name_product"] = $name_product;
		$list_data[$i]["fixtures_name"] = $fixtures_name;
		$list_data[$i]["class_use_ja"] = $class_use_ja;
		$list_data[$i]["class_manage_ja"] = $class_manage_ja;
		$list_data[$i]["class_procure_ja"] = $class_procure_ja;

		$i++;

	}

	return $list_data;
	exit();
}

function get_class_use_ja($class_use){

	$data = "不明";

	if( $class_use == "1" ){

		$data = "貸与";

	}else if( $class_use == "2" ){

		$data = "消耗";

	}

	return $data;
	exit();

}

function get_class_manage_ja($class_manage){

	$data = "不明";

	if( $class_manage == "1" ){

		$data = "単品";

	}else if( $class_manage == "2" ){

		$data = "ロット";

	}

	return $data;
	exit();

}

function get_class_procure_ja($class_procure){

	$data = "不明";

	if( $class_procure == "1" ){

		$data = "本部";

	}else if( $class_procure == "2" ){

		$data = "現地";

	}

	return $data;
	exit();

}

function regist_fixtures_stock_accepted($fixtures_stock_id,$day_accept,$other,$tanpin_flg,$area){

	$class_state = "2";

	if( $tanpin_flg != true ){

		$sql = sprintf("update fixtures_stock set area='%s',class_state='%s',day_accept='%s',other='%s' where id='%s'",$area,$class_state,$day_accept,$other,$fixtures_stock_id);
		$res = mysql_query($sql, DbCon);
		if($res == false){
			echo "error!(update_fixtures_stock_accepted)";
			exit();
		}

	}else{

		regist_fixtures_stock_accepted_tanpin($fixtures_stock_id,$day_accept,$other,$area);

	}

	return true;
	exit();
}

function regist_fixtures_stock_accepted_tanpin($fixtures_stock_id,$day_accept,$other,$area){

	$data = get_fixtures_stock_data_by_id($fixtures_stock_id);

	$fixtures_class_id = $data["fixtures_class_id"];
	$area_from = $data["area_from"];
	$area_to = $data["area_to"];
	$number_serial = $data["number_serial"];
	$quantity = $data["quantity"];
	$price_one = $data["price_one"];
	$day_purchase = $data["day_purchase"];

	$number_manage = get_number_manage_from_fixtures_stock();

	$price_all = $price_one;

	$quantity_value = 1;

	$class_state = 2;

	//トランザクションをはじめる準備
	$sql = "set autocommit = 0";
	mysql_query( $sql, DbCon );

	//トランザクション開始
	$sql = "begin";
	mysql_query( $sql, DbCon );

	for($i=0;$i<$quantity;$i++){

		$number_branch = $i+1;

		$ws_SQL = "insert into fixtures_stock(fixtures_class_id,area,area_from,area_to,number_serial,number_branch,number_manage,quantity,class_state,price_one,price_all,day_purchase,day_accept,other)";
		$ws_SQL .= " values('%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s')";
		$sql = sprintf($ws_SQL, $fixtures_class_id,$area,$area_from,$area_to,$number_serial,$number_branch,$number_manage,$quantity_value,$class_state,$price_one,$price_all,$day_purchase,$day_accept,$other);
		$res = mysql_query($sql, DbCon);
		if($res == false){

			//ロールバック
			$sql = "rollback";
			mysql_query( $sql, DbCon );

			echo "error!(regist_fixtures_stock_accepted_tanpin)";
			exit();

		}

		$number_manage++;

	}

	//削除
	$sql = sprintf("update fixtures_stock set delete_flg='1' where id='%s'",$fixtures_stock_id);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		//ロールバック
		$sql = "rollback";
		mysql_query( $sql, DbCon );

		echo "error!(regist_fixtures_stock_accepted_tanpin)";
		exit();

	}

	//コミット
	$sql = "commit";
	mysql_query( $sql, DbCon );

	return true;
	exit();

}

function get_fixtures_stock_data_by_id($id){

	$sql = sprintf("select * from fixtures_stock where id='%s'",$id);
	$res = mysql_query($sql, DbCon);
	if( $res == false ){
		echo "error!(get_fixtures_stock_data_by_id)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();
}

function get_number_manage_max_from_fixtures_stock(){

	$sql = "select number_manage from fixtures_stock where delete_flg=0 order by number_manage desc limit 0,1";
	$res = mysql_query($sql, DbCon);
	if( $res == false ){
		echo "error!(get_number_manage_max_from_fixtures_stock)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	$number_manage = $row["number_manage"];

	if($number_manage==""){

		$number_manage = 0;

	}

	return $number_manage;
	exit();
}

function get_number_manage_from_fixtures_stock(){

	$number_manage = get_number_manage_max_from_fixtures_stock();

	$number_manage++;

	return $number_manage;
	exit();

}

function delete_fixtures_stock_by_id($fixtures_stock_id){

	$sql = sprintf("update fixtures_stock set delete_flg='1' where id='%s'",$fixtures_stock_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(delete_fixtures_stock_by_id)";
		exit();
	}

	return true;
	exit();
}

function get_select_frm_area_search($area){

	$html = '<select name="area">';
	$html .= PHP_get_select_frm_area($area, true);		//in shop_list.php
	$html .= '</select>';

	return $html;
}

function get_area_select_frm_fixtures(){

	$html = "";

	$html .= '<select name="area_select">';
	$html .= PHP_get_select_frm_area($area, false);		//in shop_list.php
	$html .= '</select>';

	return $html;
}

function move_fixtures_stock($fixtures_stock_id,$area_from,$area_to,$quantity,$quantity_move,$day_move_start){

	$all_flg = false;

	if( $quantity == $quantity_move ){

		$all_flg = true;

	}

	$number_serial = get_number_serial_from_fixtures_stock();

	$class_state = "1";

	$data = get_fixtures_stock_data_by_id($fixtures_stock_id);

	$fixtures_class_id = $data["fixtures_class_id"];
	$price_one = $data["price_one"];
	$day_purchase = $data["day_purchase"];

	$price_all = $price_one * $quantity_move;

	$area = $area_to;

	//トランザクションをはじめる準備
	$sql = "set autocommit = 0";
	mysql_query( $sql, DbCon );

	//トランザクション開始
	$sql = "begin";
	mysql_query( $sql, DbCon );

	if( $all_flg == true ){

		//エリアと、移動開始時間のアップデート
		$sql = sprintf("update fixtures_stock set area='%s',day_move_start='%s' where id='%s'",$area,$day_move_start,$fixtures_stock_id);
		$res = mysql_query($sql, DbCon);
		if($res == false){
			//ロールバック
			$sql = "rollback";
			mysql_query( $sql, DbCon );

			echo "error!(move_fixtures_stock)";
			exit();
		}

	}else{

		$quantity_sa = $quantity - $quantity_move;

		//数量の更新
		$sql = sprintf("update fixtures_stock set quantity='%s' where id='%s'",$quantity_sa,$fixtures_stock_id);
		$res = mysql_query($sql, DbCon);
		if($res == false){
			//ロールバック
			$sql = "rollback";
			mysql_query( $sql, DbCon );

			echo "error!(move_fixtures_stock)";
			exit();
		}

		//インサート
		$sql = sprintf("
insert into fixtures_stock(
fixtures_class_id,area,area_from,area_to,number_serial,
quantity,class_state,price_one,price_all,day_purchase,
day_move_start)
values(
'%s','%s','%s','%s','%s',
'%s','%s','%s','%s','%s',
'%s')",
$fixtures_class_id,$area,$area_from,$area_to,$number_serial,
$quantity_move,$class_state,$price_one,$price_all,$day_purchase,
$day_move_start);

		$res = mysql_query($sql, DbCon);
echo "line:" . __LINE__ . " " . $res . "/" . $sql . "<br />";

		if($res == false){
			//ロールバック
			$sql = "rollback";
			mysql_query( $sql, DbCon );

			echo "error!(move_fixtures_stock)";
			exit();
		}

	}

	//コミット
	$sql = "commit";
	mysql_query( $sql, DbCon );

	return true;
	exit();
}

function do_stock_fixtures_stock($fixtures_stock_id,$quantity_stock,$day_stock){

	$sql = sprintf("update fixtures_stock set quantity='%s',day_stock='%s' where id='%s'",$quantity_stock,$day_stock,$fixtures_stock_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(do_stock_fixtures_stock)";
		exit();
	}

	return true;
	exit();
}

function get_fixtures_data_2(){

	$data = get_fixtures_data();
	$data_num = count($data);

	for($i=0;$i<$data_num;$i++){

		$area_data["tokyo"]["quantity_1"] = 0;
		$area_data["tokyo"]["quantity_2"] = 0;
		$area_data["yokohama"]["quantity_1"] = 0;
		$area_data["yokohama"]["quantity_2"] = 0;
		$area_data["sapporo"]["quantity_1"] = 0;
		$area_data["sapporo"]["quantity_2"] = 0;
		$area_data["sendai"]["quantity_1"] = 0;
		$area_data["sendai"]["quantity_2"] = 0;
		$area_data["osaka"]["quantity_1"] = 0;
		$area_data["osaka"]["quantity_2"] = 0;

		$fixtures_id = $data[$i]["id"];

		$class = get_fixtures_class_data_by_fixtures_id($fixtures_id);
		$class_num = count($class);

		for($x=0;$x<$class_num;$x++){

			$fixtures_class_id = $class[$x]["id"];

			//get_fixtures_stock_data_2($fixtures_class_id, $class_state);

			$stock = get_fixtures_stock_data_by_fixtures_class_id($fixtures_class_id);
			$stock_num = count($stock);

			for($z=0;$z<$stock_num;$z++){

				$quantity = $stock[$z]["quantity"];
				$class_state = $stock[$z]["class_state"];
				$area = $stock[$z]["area"];

				if( $class_state == "1" ){

					$area_data[$area]["quantity_1"] = $area_data[$area]["quantity_1"] + $quantity;

				}else if( $class_state == "2" ){

					$area_data[$area]["quantity_2"] = $area_data[$area]["quantity_2"] + $quantity;

				}

			}

		}

		$data[$i]["quantity_1"] = $quantity_1;
		$data[$i]["quantity_2"] = $quantity_2;
		$data[$i]["area_data"] = $area_data;

	}

	return $data;
	exit();

}

//----備品在庫配列取得
function get_fixtures_stock_data_by_fixtures_class_id($fixtures_class_id){
	return PHP_get_fixtures_stock($fixtures_class_id, "");
}

//----備品在庫配列取得
function PHP_get_fixtures_stock($fixtures_class_id, $u_area) {

	if($fixtures_class_id == -1) {
		if($u_area) {
			$sql = sprintf("select * from fixtures_stock where delete_flg=0 and area='%s' order by fixtures_class_id", $u_area);
		} else {
			$sql = "select * from fixtures_stock where delete_flg=0 order by fixtures_class_id";
		}
	} else {
		if($u_area) {
			$sql = sprintf("select * from fixtures_stock where delete_flg=0 and fixtures_class_id='%s' and area='%s'", $fixtures_class_id, $u_area);
		} else {
			$sql = sprintf("select * from fixtures_stock where delete_flg=0 and fixtures_class_id='%s'", $fixtures_class_id);
		}
	}

	$res = mysql_query($sql, DbCon);
	if( $res == false ){
		echo "error!(PHP_get_fixtures_stock_data)";
		exit();
	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){
		$list_data[$i] = $row;
		$i++;
	}

	return $list_data;
}

function get_fixtures_class_data_2($fixtures_id){

	$class = get_fixtures_class_data_by_fixtures_id($fixtures_id);
	$class_num = count($class);

	for($x=0;$x<$class_num;$x++){

		$area_data["tokyo"]["quantity_1"] = 0;
		$area_data["tokyo"]["quantity_2"] = 0;
		$area_data["yokohama"]["quantity_1"] = 0;
		$area_data["yokohama"]["quantity_2"] = 0;
		$area_data["sapporo"]["quantity_1"] = 0;
		$area_data["sapporo"]["quantity_2"] = 0;
		$area_data["sendai"]["quantity_1"] = 0;
		$area_data["sendai"]["quantity_2"] = 0;
		$area_data["osaka"]["quantity_1"] = 0;
		$area_data["osaka"]["quantity_2"] = 0;

		$fixtures_class_id = $class[$x]["id"];

		$stock = get_fixtures_stock_data_by_fixtures_class_id($fixtures_class_id);
		$stock_num = count($stock);

		for($z=0;$z<$stock_num;$z++){

			$quantity = $stock[$z]["quantity"];
			$class_state = $stock[$z]["class_state"];
			$area = $stock[$z]["area"];

			if( $class_state == "1" ){

				$area_data[$area]["quantity_1"] = $area_data[$area]["quantity_1"] + $quantity;

			}else if( $class_state == "2" ){

				$area_data[$area]["quantity_2"] = $area_data[$area]["quantity_2"] + $quantity;

			}

		}

		$class[$x]["area_data"] = $area_data;

	}

	return $class;
	exit();

}

function get_fixtures_stock_data_3($fixtures_class_id,$class_state,$area){

	$data = get_fixtures_class_data_by_id($fixtures_class_id);
	$fixtures_id = $data["fixtures_id"];
	$name_class = $data["name_class"];
	$name_product = $data["name_product"];

	$data = get_fixtures_data_by_id($fixtures_id);
	$fixtures_name = $data["name"];
	$class_use = $data["class_use"];
	$class_manage = $data["class_manage"];
	$class_procure = $data["class_procure"];

	$class_use_ja = get_class_use_ja($class_use);
	$class_manage_ja = get_class_manage_ja($class_manage);
	$class_procure_ja = get_class_procure_ja($class_procure);

	if( $area == "all" ){

		$sql = sprintf("select * from fixtures_stock where delete_flg=0 and fixtures_class_id='%s' and class_state='%s'",$fixtures_class_id,$class_state);

	}else{

		$sql = sprintf("select * from fixtures_stock where delete_flg=0 and fixtures_class_id='%s' and class_state='%s' and area='%s'", $fixtures_class_id,$class_state,$area);

	}

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_fixtures_stock_data_3)";
		exit();

	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$staff_id = $row["staff_id"];
		$therapist_id = $row["therapist_id"];

		$user_name = get_fixtures_user_name($staff_id,$therapist_id);

		$list_data[$i] = $row;

		$list_data[$i]["name_class"] = $name_class;
		$list_data[$i]["name_product"] = $name_product;
		$list_data[$i]["fixtures_name"] = $fixtures_name;
		$list_data[$i]["class_use_ja"] = $class_use_ja;
		$list_data[$i]["class_manage_ja"] = $class_manage_ja;
		$list_data[$i]["class_procure_ja"] = $class_procure_ja;
		$list_data[$i]["user_name"] = $user_name;

		$i++;

	}

	return $list_data;
	exit();

}

function get_use_state_select_frm($use_state){

	$html = '<select name="use_state">';

	if( $use_state == "1" ){

		$html .= '<option value="0">未使用</option>';
		$html .= '<option value="1" selected>使用中</option>';
		$html .= '<option value="2">使用済み</option>';

	}else if( $use_state == "2" ){

		$html .= '<option value="0">未使用</option>';
		$html .= '<option value="1">使用中</option>';
		$html .= '<option value="2" selected>使用済み</option>';

	}else{

		$html .= '<option value="0">未使用</option>';
		$html .= '<option value="1">使用中</option>';
		$html .= '<option value="2">使用済み</option>';

	}

	$html .= '</select>';

	return $html;
	exit();

}

function get_therapist_staff_id_fixtures($staff_id,$therapist_id){

	$data = "-1";

	if( $staff_id != "-1" ){

		$data = "staff_".$staff_id;

	}else if( $therapist_id != "-1" ){

		$data = "therapist_".$therapist_id;

	}

	return $data;
	exit();

}

function get_therapist_staff_frm_fixtures($area,$therapist_staff_id){

	//echo $therapist_staff_id;exit();

	$html = '<select name="therapist_staff_id">';
	$html .= '<option value="-1">未選択</option>';

	$data = get_therapist_data_by_area_new($area);
	$data_num = count($data);

	for($i=0;$i<$data_num;$i++){
		$id = $data[$i]["id"];
		$name = $data[$i]["name"];
		$value = "therapist_".$id;
		if( $value == $therapist_staff_id ){
			$html .= sprintf('<option value="%s" selected>%s</option>',$value,$name);
		}else{
			$html .= sprintf('<option value="%s">%s</option>',$value,$name);
		}
	}

	$type = "driver";
	$data = get_staff_data_by_area_and_type($area,$type);
	$data_num = count($data);

	for($i=0;$i<$data_num;$i++){
		$id = $data[$i]["id"];
		$name = $data[$i]["name"];
		$value = "staff_".$id;
		if( $value == $therapist_staff_id ){
			$html .= sprintf('<option value="%s" selected>%s</option>',$value,$name);
		}else{
			$html .= sprintf('<option value="%s">%s</option>',$value,$name);
		}
	}

	$type = "honbu";
	$data = get_staff_data_by_area_and_type($area,$type);
	$data_num = count($data);

	for($i=0;$i<$data_num;$i++){
		$id = $data[$i]["id"];
		$name = $data[$i]["name"];
		$value = "staff_".$id;
		if( $value == $therapist_staff_id ){
			$html .= sprintf('<option value="%s" selected>%s</option>',$value,$name);
		}else{
			$html .= sprintf('<option value="%s">%s</option>',$value,$name);
		}
	}

	$html .= '</select>';

	return $html;
	exit();

}

function get_staff_data_by_area($area){

	$sql = sprintf("select * from staff_new_new where delete_flg=0 and leave_flg=0 and area='%s'",$area);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_staff_data_by_area)";
		exit();
	}

	$data = array();

	$i=0;
	while($row = mysql_fetch_assoc($res)){
		$data[$i++] = $row;
	}

	return $data;
	exit();
}

function get_staff_data_by_area_and_type($area,$type){

	$sql = sprintf("select * from staff_new_new where delete_flg=0 and leave_flg=0 and area='%s' and type='%s'",$area,$type);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_staff_data_by_area_and_type)";
		exit();
	}

	$data = array();

	$i=0;
	while($row = mysql_fetch_assoc($res)){
		$data[$i++] = $row;
	}

	return $data;
	exit();
}

function update_fixtures_stock_detail($fixtures_stock_id,$therapist_staff_id,$use_state,$day_use_start,$day_use_end){

	if( $use_state != "0" ){

		$year = intval(date('Y'));
		$month = intval(date('m'));
		$day = intval(date('d'));

		$ts = get_timestamp_by_year_month_day_common($year, $month, $day);

		if( $use_state == "1" ){

			if( $day_use_start == "0" ){

				$day_use_start = $ts;

			}

			$day_use_end = 0;

		}else if( $use_state == "2" ){

			if( $day_use_end == "0" ){

				$day_use_end = $ts;

			}

		}

	}else{

		$day_use_start = 0;
		$day_use_end = 0;

	}

	$staff_id = "-1";
	$therapist_id = "-1";

	if( $therapist_staff_id != "-1" ){

		$pieces = explode("_", $therapist_staff_id);

		if( $pieces[0] == "therapist" ){

			$therapist_id = $pieces[1];

		}else if( $pieces[0] == "staff" ){

			$staff_id = $pieces[1];

		}

	}

	$sql = sprintf("
update fixtures_stock set
day_use_start='%s',
day_use_end='%s',
use_state='%s',
staff_id='%s',
therapist_id='%s'
where id='%s'",
$day_use_start,$day_use_end,$use_state,$staff_id,$therapist_id,$fixtures_stock_id);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(update_fixtures_stock_detail)";
		exit();

	}

	return true;
	exit();

}

function get_fixtures_user_name($staff_id,$therapist_id){

	$name = "未選択";

	if( $staff_id != "-1" ){

		$name = get_staff_name_by_id_common($staff_id);

	}else if( $therapist_id != "-1" ){

		$name = get_therapist_name_by_therapist_id_honmyou_common($therapist_id);

	}

	return $name;
	exit();

}

function get_fixtures_stock_data_4($fixtures_id,$class_state,$area){

	$data = get_fixtures_data_by_id($fixtures_id);
	$fixtures_name = $data["name"];
	$class_use = $data["class_use"];
	$class_manage = $data["class_manage"];
	$class_procure = $data["class_procure"];

	$class_use_ja = get_class_use_ja($class_use);
	$class_manage_ja = get_class_manage_ja($class_manage);
	$class_procure_ja = get_class_procure_ja($class_procure);

	$fixtures_class_id_sql = get_fixtures_class_id_sql($fixtures_id);

	if( $area == "all" ){

		$sql = sprintf("select * from fixtures_stock where delete_flg=0 and (%s) and class_state='%s'",$fixtures_class_id_sql,$class_state);

	}else{

		$sql = sprintf("select * from fixtures_stock where delete_flg=0 and (%s) and class_state='%s' and area='%s'",$fixtures_class_id_sql,$class_state,$area);

	}
	$res = mysql_query($sql, DbCon);
	if( $res == false ){
		echo "error!(get_fixtures_stock_data_4)";
		exit();
	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$staff_id = $row["staff_id"];
		$therapist_id = $row["therapist_id"];
		$user_name = get_fixtures_user_name($staff_id,$therapist_id);

		$fixtures_class_id = $row["fixtures_class_id"];
		$data = get_fixtures_class_data_by_id($fixtures_class_id);
		$name_class = $data["name_class"];
		$name_product = $data["name_product"];

		$list_data[$i] = $row;

		$list_data[$i]["name_class"] = $name_class;
		$list_data[$i]["name_product"] = $name_product;
		$list_data[$i]["fixtures_name"] = $fixtures_name;
		$list_data[$i]["class_use_ja"] = $class_use_ja;
		$list_data[$i]["class_manage_ja"] = $class_manage_ja;
		$list_data[$i]["class_procure_ja"] = $class_procure_ja;
		$list_data[$i]["user_name"] = $user_name;

		$i++;

	}

	return $list_data;
	exit();

}

function get_fixtures_class_id_sql($fixtures_id){

	$sql = "";

	$data = get_fixtures_class_data_by_fixtures_id($fixtures_id);

	$data_num = count($data);

	$first_flg = false;

	for($i=0;$i<$data_num;$i++){

		$id = $data[$i]["id"];

		if( $first_flg == false ){

			$sql = sprintf("fixtures_class_id='%s'",$id);

			$first_flg = true;

		}else{

			$sql .= sprintf(" or fixtures_class_id='%s'",$id);

		}

	}

	if( $sql == "" ){

		$sql = "1";

	}

	return $sql;
	exit();

}

function get_name_class_by_id($fixtures_class_id){

	$sql = sprintf("select name_class from fixtures_class where id='%s'",$fixtures_class_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_name_class_by_id)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row["name_class"];
	exit();
}

function get_select_frm_fixtures_search($fixtures_id){

	$data = get_fixtures_data();
	$data_num = count($data);

	$html = '<select name="fixtures_id" id="fixtures_id_select">';
	$html .= '<option value="-1">未選択</option>';

	for($i=0;$i<$data_num;$i++){

		$id = $data[$i]["id"];
		$name = $data[$i]["name"];

		if( $id == $fixtures_id ){

			$html .= sprintf('<option value="%s" selected>%s</option>',$id,$name);

		}else{

			$html .= sprintf('<option value="%s">%s</option>',$id,$name);

		}

	}

	$html .= '</select>';

	return $html;
	exit();

}

function get_select_frm_fixtures_class_search($fixtures_id){

	$data = get_fixtures_class_data_by_fixtures_id($fixtures_id);
	$data_num = count($data);

	$html = '<select name="fixtures_class_id">';
	$html .= '<option value="-1">未選択</option>';

	for($i=0;$i<$data_num;$i++){

		$id = $data[$i]["id"];
		$name = $data[$i]["name_class"];

		$html .= sprintf('<option value="%s">%s</option>',$id,$name);

	}

	$html .= '</select>';

	return $html;
	exit();

}

function get_select_frm_use_state_search($use_state){

	$html = '<select name="use_state">';
	$html .= '<option value="-1">未選択</option>';

	if( $use_state == "0" ){
		$html .= '<option value="0" selected>未使用</option>';
	}else{
		$html .= '<option value="0">未使用</option>';
	}
	if( $use_state == "1" ){
		$html .= '<option value="1" selected>使用中</option>';
	}else{
		$html .= '<option value="1">使用中</option>';
	}
	if( $use_state == "2" ){
		$html .= '<option value="2" selected>使用済み</option>';
	}else{
		$html .= '<option value="2">使用済み</option>';
	}

	$html .= '</select>';

	return $html;
	exit();

}

function get_select_frm_fixtures_class_search_2($fixtures_id,$fixtures_class_id){

	$html = '<select name="fixtures_class_id">';
	$html .= '<option value="-1">未選択</option>';

	if( $fixtures_id != "" ){

		$data = get_fixtures_class_data_by_fixtures_id($fixtures_id);
		$data_num = count($data);

		for($i=0;$i<$data_num;$i++){

			$id = $data[$i]["id"];
			$name = $data[$i]["name_class"];

			if( $fixtures_class_id == $id ){

				$html .= sprintf('<option value="%s" selected>%s</option>',$id,$name);

			}else{

				$html .= sprintf('<option value="%s">%s</option>',$id,$name);

			}

		}

	}

	$html .= '</select>';

	return $html;
	exit();

}

function get_fixtures_stock_data_5($fixtures_id,$fixtures_class_id,$class_state,$area,$use_state,$use_end){

	$fixtures_id = if_null_is_mainasu($fixtures_id);
	$fixtures_class_id = if_null_is_mainasu($fixtures_class_id);
	$area = if_null_is_mainasu($area);
	$use_state = if_null_is_mainasu($use_state);
	$use_end = if_null_is_mainasu($use_end);

	$sql_arr = array();
	$x = 0;

	if( ( $fixtures_id == "-1" ) && ( $fixtures_class_id == "-1" ) && ( $area == "-1" ) && ( $use_state == "-1" ) ){

		return false;
		exit();

	}else{

		if( ( $fixtures_id == "-1" ) && ( $fixtures_class_id == "-1" ) ){

			//何もしない

		}else if( ( $fixtures_id != "-1" ) && ( $fixtures_class_id == "-1" ) ){

			$sql = get_fixtures_class_id_sql($fixtures_id);

			if( $sql != "1" ){

				$sql_arr[$x] = $sql;
				$x++;

			}

		}else if( $fixtures_class_id != "-1" ){

			$sql_arr[$x] = sprintf("fixtures_class_id='%s'",$fixtures_class_id);
			$x++;

		}

		if( $area != "-1" ){

			$sql_arr[$x] = sprintf("area='%s'",$area);
			$x++;

		}

		if( $use_state != "-1" ){

			$sql_arr[$x] = sprintf("use_state='%s'",$use_state);
			$x++;

		}

		if( $use_end == "-1" ){

			$sql_arr[$x] = "use_state<>'2'";
			$x++;

		}

	}

	$sql_arr_num = count($sql_arr);
	$sql_where = "";
	$first_flg = false;

	for( $i=0; $i<$sql_arr_num; $i++ ){

		$tmp = $sql_arr[$i];

		if( $first_flg == false ){

			$sql_where = sprintf("(%s)",$tmp);
			$first_flg = true;

		}else{

			$sql_where .= sprintf(" and (%s)",$tmp);

		}

	}

	$sql = sprintf("select * from fixtures_stock where delete_flg=0 and class_state='%s' and %s",$class_state,$sql_where);
	$res = mysql_query($sql, DbCon);
	if( $res == false ){
		echo "error!(get_fixtures_stock_data_5)";
		exit();
	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$staff_id = $row["staff_id"];
		$therapist_id = $row["therapist_id"];
		$user_name = get_fixtures_user_name($staff_id,$therapist_id);

		$fixtures_class_id = $row["fixtures_class_id"];
		$data = get_fixtures_class_data_by_id($fixtures_class_id);
		$name_class = $data["name_class"];
		$name_product = $data["name_product"];

		$fixtures_id = get_fixtures_id_by_fixtures_class_id($fixtures_class_id);
		$data = get_fixtures_data_by_id($fixtures_id);
		$fixtures_name = $data["name"];
		$class_use = $data["class_use"];
		$class_manage = $data["class_manage"];
		$class_procure = $data["class_procure"];
		$class_use_ja = get_class_use_ja($class_use);
		$class_manage_ja = get_class_manage_ja($class_manage);
		$class_procure_ja = get_class_procure_ja($class_procure);

		$list_data[$i] = $row;

		$list_data[$i]["name_class"] = $name_class;
		$list_data[$i]["name_product"] = $name_product;
		$list_data[$i]["fixtures_name"] = $fixtures_name;
		$list_data[$i]["class_use_ja"] = $class_use_ja;
		$list_data[$i]["class_manage_ja"] = $class_manage_ja;
		$list_data[$i]["class_procure_ja"] = $class_procure_ja;
		$list_data[$i]["user_name"] = $user_name;

		$i++;

	}

	return $list_data;
	exit();

}

function if_null_is_mainasu($data){

	if( $data == "" ){

		$data = "-1";

	}

	return $data;
	exit();

}

function get_fixtures_id_by_fixtures_class_id($fixtures_class_id){

	$sql = sprintf("select fixtures_id from fixtures_class where id='%s'",$fixtures_class_id);
	$res = mysql_query($sql, DbCon);
	if( $res == false ){
		echo "error!(get_fixtures_id_by_fixtures_class_id)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row["fixtures_id"];
	exit();
}

function get_fixtures_data_2_area($data,$area){

	$data_num = count($data);

	for($i=0;$i<$data_num;$i++){

		$area_data = $data[$i]["area_data"];
		$tmp = $area_data[$area];
		$data[$i]["area_data"] = $tmp;

	}

	return $data;
	exit();

}

function get_fixtures_class_data_2_area($data,$area){

	$data_num = count($data);

	for($i=0;$i<$data_num;$i++){

		$area_data = $data[$i]["area_data"];
		$tmp = $area_data[$area];
		$data[$i]["area_data"] = $tmp;

	}

	return $data;
	exit();

}

function add_info_therapist_page_data($data){

	$data_num = count($data);

	for($i=0;$i<$data_num;$i++){

		$therapist_id = $data[$i]["therapist_id"];
		$area = $data[$i]["area"];
		$skill = $data[$i]["skill"];

		$rinpa = 0;
		$tai = 0;
		$stretch = 0;
		$strong = 0;

		$skill_arr = explode(",", $skill);
		$skill_arr_num = count($skill_arr);

		for($x=0;$x<$skill_arr_num;$x++){

			$tmp = $skill_arr[$x];

			if( $tmp == "10" ){

				$rinpa = 1;

			}else if( $tmp == "15" ){

				$stretch = 1;

			}else if( $tmp == "17" ){

				$tai = 1;

			}else if( $tmp == "18" ){

				$strong = 1;

			}

		}

		$tmp = get_therapist_report_data_common($therapist_id,$area);

		$data[$i]["repeater_rate"] = $tmp["repeater_rate"];
		$data[$i]["shimei_rate"] = $tmp["shimei_rate"];
		$data[$i]["repeater_rate_ranking"] = $tmp["repeater_rate_ranking"];
		$data[$i]["shimei_rate_ranking"] = $tmp["shimei_rate_ranking"];
		$data[$i]["rinpa"] = $rinpa;
		$data[$i]["stretch"] = $stretch;
		$data[$i]["tai"] = $tai;
		$data[$i]["strong"] = $strong;

	}

	return $data;
	exit();

}

function therapist_page_order_value_set($data){

	$data_num = count($data);

	$num = 990;

	for($i=0;$i<$data_num;$i++){

		$data[$i]["order_value"] = $num;

		$num = $num - 10;

	}

	return $data;
	exit();

}

function get_order_value_string($data){

	$data_num = count($data);

	$str = "";

	$first_flg = true;

	for($i=0;$i<$data_num;$i++){

		$id = $data[$i]["id"];
		$order_value = $data[$i]["order_value"];

		if( $first_flg == true ){

			$first_flg = false;

			$str = $id."_".$order_value;

		}else{

			$str .= ",";
			$str .= $id."_".$order_value;

		}

	}

	return $str;
	exit();

}

function get_order_value_string_2($data){

	$data_num = count($data);

	$str = "";

	$first_flg = true;

	for($i=0;$i<$data_num;$i++){

		$id = $data[$i]["id"];
		$order_value = $data[$i]["order_num"];

		if( $first_flg == true ){

			$first_flg = false;

			$str = $id."_".$order_value;

		}else{

			$str .= ",";
			$str .= $id."_".$order_value;

		}

	}

	return $str;
	exit();

}

function update_therapist_page_order_value_all($order_value_string){

	$pieces = explode(",", $order_value_string);
	$pieces_num = count($pieces);

	//トランザクションをはじめる準備
	$sql = "set autocommit = 0";
	mysql_query( $sql, DbCon );

	//トランザクション開始
	$sql = "begin";
	mysql_query( $sql, DbCon );

	for($i=0;$i<$pieces_num;$i++){

		$tmp = $pieces[$i];
		$tmp2 = explode("_", $tmp);
		$id = $tmp2[0];
		$order_value = $tmp2[1];

		$sql = sprintf("update therapist_page set order_value='%s' where id='%s'",$order_value,$id);
		$res = mysql_query($sql, DbCon);
		if($res == false){
			//ロールバック
			$sql = "rollback";
			mysql_query( $sql, DbCon );

			echo "error!(update_therapist_page_order_value_all)";
			exit();
		}
	}

	//コミット
	$sql = "commit";
	mysql_query( $sql, DbCon );

	return true;
	exit();
}

function therapist_page_data_select_by_massage_type($therapist_page,$rinpa,$tai,$stretch,$strong,$exp,$lng){

	$rinpa = if_null_is_zero_common($rinpa);
	$tai = if_null_is_zero_common($tai);
	$stretch = if_null_is_zero_common($stretch);
	$strong = if_null_is_zero_common($strong);
	$exp = if_null_is_zero_common($exp);
	$lng = if_null_is_zero_common($lng);

	if( ($rinpa=="0") && ($tai=="0") && ($stretch=="0") && ($strong=="0") && ($exp=="0") && ($lng=="0") ){

		$all_flg = true;

	}

	/*
	$massa_data = array(
		"rinpa"=>$rinpa,
		"tai"=>$tai,
		"stretch"=>$stretch,
		"strong"=>$strong
	);
	*/

	$massa_data = array(
		"0"=>array(
			"name"=>"rinpa",
			"value"=>$rinpa
		),
		"1"=>array(
			"name"=>"tai",
			"value"=>$tai
		),
		"2"=>array(
			"name"=>"stretch",
			"value"=>$stretch
		),
		"3"=>array(
			"name"=>"strong",
			"value"=>$strong
		),
		"4"=>array(
			"name"=>"exp",
			"value"=>$exp
		),
		"5"=>array(
			"name"=>"lng",
			"value"=>$lng
		)
	);

	$type_data = array(
		0=>"rinpa",
		1=>"tai",
		2=>"stretch",
		3=>"strong",
		4=>"exp",
		5=>"lng"
	);

	$type_data_num = count($type_data);

	$therapist_page_num = count($therapist_page);

	$x = 0;
	$data = array();
	$match_flg = false;

	for($i=0;$i<$therapist_page_num;$i++){

		if( $all_flg == true ){

			$match_flg = true;

		}else{

			$rinpa_tmp = $therapist_page[$i]["rinpa"];
			$tai_tmp = $therapist_page[$i]["tai"];
			$stretch_tmp = $therapist_page[$i]["stretch"];
			$strong_tmp = $therapist_page[$i]["strong"];
			$exp_tmp = $therapist_page[$i]["exp"];
			$lng_tmp = $therapist_page[$i]["lng"];
			/*
			$massa_data_tmp = array(
				"rinpa"=>$rinpa_tmp,
				"tai"=>$tai_tmp,
				"stretch"=>$stretch_tmp,
				"strong"=>$strong_tmp
			);
			*/

			$massa_data_tmp = array(
				"0"=>array(
					"name"=>"rinpa",
					"value"=>$rinpa_tmp
				),
				"1"=>array(
					"name"=>"tai",
					"value"=>$tai_tmp
				),
				"2"=>array(
					"name"=>"stretch",
					"value"=>$stretch_tmp
				),
				"3"=>array(
					"name"=>"strong",
					"value"=>$strong_tmp
				),
				"4"=>array(
					"name"=>"exp",
					"value"=>$exp_tmp
				),
				"5"=>array(
					"name"=>"lng",
					"value"=>$lng_tmp
				)
			);

			if( ($rinpa=="1") && ($tai=="1") && ($stretch=="1") && ($strong=="1") && ($exp=="1") && ($lng=="1") ){
				if( ($rinpa_tmp=="1") && ($tai_tmp=="1") && ($stretch_tmp=="1") && ($strong_tmp=="1") && ($exp_tmp=="1") && ($lng_tmp=="1") ){
					$match_flg = true;
				}
			}else{

				for($z=0;$z<$type_data_num;$z++){

					$type = $type_data[$z];

					if( $match_flg != true ){
						$match_flg = get_match_flg_therapist_page_data_select_by_massage_type($massa_data,$massa_data_tmp,$type);
					}

				}

			}

		}

		if( $match_flg == true ){

			$data[$x] = $therapist_page[$i];
			$x++;

		}

		$match_flg = false;

	}

	return $data;
	exit();

}

function get_match_flg_therapist_page_data_select_by_massage_type($massa_data,$massa_data_tmp,$type){

	$match_flg = false;

	$select_value = get_select_value_for_get_match_flg($massa_data,$type);
	$select_value_tmp = get_select_value_for_get_match_flg($massa_data_tmp,$type);

	$other_data = get_other_data_for_get_match_flg($type,$massa_data);
	$other_data_tmp = get_other_data_for_get_match_flg($type,$massa_data_tmp);

	if( ($select_value=="1") && ($other_data[0]["value"]=="1") && ($other_data[1]["value"]=="1") ){
		if( ($select_value_tmp=="1") && ($other_data_tmp[0]["value"]=="1") && ($other_data_tmp[1]["value"]=="1") ){
			$match_flg = true;
		}
	}else if( ($select_value=="1") && ($other_data[0]["value"]=="1") && ($other_data[2]["value"]=="1") ){
		if( ($select_value_tmp=="1") && ($other_data_tmp[0]["value"]=="1") && ($other_data_tmp[2]["value"]=="1") ){
			$match_flg = true;
		}
	}else if( ($select_value=="1") && ($other_data[1]["value"]=="1") && ($other_data[2]["value"]=="1") ){
		if( ($select_value_tmp=="1") && ($other_data_tmp[1]["value"]=="1") && ($other_data_tmp[2]["value"]=="1") ){
			$match_flg = true;
		}
	}else{

		if( ($select_value=="1") && ($other_data[0]["value"]=="1") ){
			if( ($select_value_tmp=="1") && ($other_data_tmp[0]["value"]=="1") ){
				$match_flg = true;
			}
		}else if( ($select_value=="1") && ($other_data[1]["value"]=="1") ){
			if( ($select_value_tmp=="1") && ($other_data_tmp[1]["value"]=="1") ){
				$match_flg = true;
			}
		}else if( ($select_value=="1") && ($other_data[2]["value"]=="1") ){
			if( ($select_value_tmp=="1") && ($other_data_tmp[2]["value"]=="1") ){
				$match_flg = true;
			}
		}else{

			if( ($select_value=="1") ){
				if( ($select_value_tmp=="1") ){
					$match_flg = true;
				}
			}
		}

	}

	return $match_flg;
	exit();

}

function get_other_data_for_get_match_flg($type,$massa_data){

	$data = array();
	$x = 0;

	$massa_data_num = count($massa_data);

	for($i=0;$i<$massa_data_num;$i++){

		if( $massa_data[$i]["name"] != $type ){

			$data[$x] = $massa_data[$i];
			$x++;

		}

	}

	return $data;
	exit();

}

function get_select_value_for_get_match_flg($massa_data,$type){

	$massa_data_num = count($massa_data);

	for($i=0;$i<$massa_data_num;$i++){

		if( $massa_data[$i]["name"] == $type ){

			return $massa_data[$i]["value"];
			exit();

		}

	}

	echo "error!(get_select_value_for_get_match_flg)";exit();

}

function order_type_select_therapist_page($therapist_list,$order_type){

	$action_flg = false;

	if( $order_type == "2" ){

		//リピーター獲得率
		$ranking_name = "repeater_rate_ranking";

		$action_flg = true;

	}else if( $order_type == "3" ){

		//指名率
		$ranking_name = "shimei_rate_ranking";

		$action_flg = true;

	}

	if( $action_flg == true ){

		foreach($therapist_list as $key => $row){
			$key_data[$key] = $row[$ranking_name];
		}
		array_multisort($key_data,SORT_DESC,$therapist_list);

	}

	return $therapist_list;
	exit();

}

function get_office_address1_by_area($shop_area){

	$sql = sprintf("select address1 from office where delete_flg=0 and area='%s'",$shop_area);
	$res = mysql_query($sql, DbCon);
	if( $res == false ){
		echo "error!(get_office_address1_by_area)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row["address1"];
	exit();

}

function get_office_data_by_area($area){

	$sql = sprintf("select * from office where delete_flg=0 and area='%s'",$area);
	$res = mysql_query($sql, DbCon);
	if( $res == false ){
		echo "error!(get_office_data_by_area)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	return $row;
	exit();
}

function update_office_address($area,$address1,$address2){

	$sql = sprintf("update office set address1='%s',address2='%s' where delete_flg=0 and area='%s'",$address1,$address2,$area);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(update_office_address)";
		exit();
	}

	return true;
	exit();
}

function get_option_rank_for_therapist_list($rank){

	$html = "";

	if( $rank == "1" ){
		$html .= '<option value="1" selected>Ａ</option>';
	}else{
		$html .= '<option value="1">Ａ</option>';
	}

	if( $rank == "2" ){
		$html .= '<option value="2" selected>Ｂ</option>';
	}else{
		$html .= '<option value="2">Ｂ</option>';
	}

	if( $rank == "3" ){
		$html .= '<option value="3" selected>Ｃ</option>';
	}else{
		$html .= '<option value="3">Ｃ</option>';
	}

	if( $rank == "5" ){
		$html .= '<option value="5" selected>Ｄ</option>';
	}else{
		$html .= '<option value="5">Ｄ</option>';
	}

	if( $rank == "4" ){
		$html .= '<option value="4" selected>新人</option>';
	}else{
		$html .= '<option value="4">新人</option>';
	}

	if( $rank == "19" ){
		$html .= '<option value="19" selected>対象外</option>';
	}else{
		$html .= '<option value="19">対象外</option>';
	}

	return $html;
	exit();

}

function update_therapist_rank($therapist_id,$rank){

	$rank_order_num = get_rank_order_num($rank);

	$sql = sprintf("update therapist_new set rank='%s',rank_order_num='%s' where id='%s'",$rank,$rank_order_num,$therapist_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(update_therapist_rank)";
		exit();
	}

	return true;
	exit();
}

function update_driver_rank($staff_id,$rank){

	$rank_order_num = get_rank_order_num($rank);

	$sql = sprintf("update staff_new_new set rank='%s',rank_order_num='%s' where id='%s'",$rank,$rank_order_num,$staff_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(update_driver_rank)";
		exit();
	}

	return true;
	exit();
}

function get_rank_string($data){

	$data_num = count($data);

	$str = "";

	$first_flg = true;

	for($i=0;$i<$data_num;$i++){

		$id = $data[$i]["id"];
		$rank = $data[$i]["rank"];

		if( $first_flg == true ){

			$first_flg = false;

			$str = $id."_".$rank;

		}else{

			$str .= ",";
			$str .= $id."_".$rank;
		}
	}

	return $str;
	exit();
}

function get_therapist_for_therapist_list($area){

	$where_area = "area = '".$area."'";

	$sql = sprintf("select * from therapist_new where (%s) and leave_flg=0 and delete_flg=0 order by rank_order_num asc,order_num desc",$where_area);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_therapist_for_therapist_list)";
		exit();
	}

	$therapist_data = array();

	$i=0;
	while($row = mysql_fetch_assoc($res)){
		$therapist_data[$i] = $row;
		$i++;
	}

	return $therapist_data;
	exit();
}

function get_staff_for_staff_list($area){

	$where_area = "area = '".$area."'";

	$sql = sprintf("select * from staff_new_new where (%s) and leave_flg=0 and delete_flg=0 order by rank_order_num asc,order_num desc",$where_area);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_staff_for_staff_list)";
		exit();
	}

	$staff_data = array();

	$i=0;
	while($row = mysql_fetch_assoc($res)){
		$staff_data[$i] = $row;
		$i++;
	}

	return $staff_data;
	exit();
}

function update_rank_all_tmp($data,$rank){

	$data_num = count($data);

	for($i=0;$i<$data_num;$i++){

		$data[$i]["rank"] = $rank;

	}

	return $data;
	exit();

}

function update_therapist_rank_all($rank_string){

	$pieces = explode(",", $rank_string);
	$pieces_num = count($pieces);

	//トランザクションをはじめる準備
	$sql = "set autocommit = 0";
	mysql_query( $sql, DbCon );

	//トランザクション開始
	$sql = "begin";
	mysql_query( $sql, DbCon );


	for($i=0;$i<$pieces_num;$i++){

		$tmp = $pieces[$i];
		$tmp2 = explode("_", $tmp);
		$id = $tmp2[0];
		$rank = $tmp2[1];

		$rank_order_num = get_rank_order_num($rank);

		$sql = sprintf("update therapist_new set rank='%s',rank_order_num='%s' where id='%s'",$rank,$rank_order_num,$id);
		$res = mysql_query($sql, DbCon);
		if($res == false){
			//ロールバック
			$sql = "rollback";
			mysql_query( $sql, DbCon );

			echo "error!(update_therapist_rank_all)";
			exit();
		}
	}

	//コミット
	$sql = "commit";
	mysql_query( $sql, DbCon );

	return true;
	exit();
}

function update_staff_rank_all($rank_string){

	$pieces = explode(",", $rank_string);
	$pieces_num = count($pieces);

	//トランザクションをはじめる準備
	$sql = "set autocommit = 0";
	mysql_query( $sql, DbCon );

	//トランザクション開始
	$sql = "begin";
	mysql_query( $sql, DbCon );


	for($i=0;$i<$pieces_num;$i++){

		$tmp = $pieces[$i];
		$tmp2 = explode("_", $tmp);
		$id = $tmp2[0];
		$rank = $tmp2[1];

		$rank_order_num = get_rank_order_num($rank);

		$sql = sprintf("update staff_new_new set rank='%s',rank_order_num='%s' where id='%s'",$rank,$rank_order_num,$id);
		$res = mysql_query($sql, DbCon);
		if($res == false){
			//ロールバック
			$sql = "rollback";
			mysql_query( $sql, DbCon );

			echo "error!(update_staff_rank_all)";
			exit();
		}
	}

	//コミット
	$sql = "commit";
	mysql_query( $sql, DbCon );

	return true;
	exit();
}

function get_board_disp_flg_select($board_disp_flg){

	$html = '<select name="board_disp_flg">';

	if( $board_disp_flg == "0" ){
		$html .= '<option value="0" selected>表示しない</option>';
		$html .= '<option value="1">表示する</option>';
	}elseif( $board_disp_flg == "1" ){
		$html .= '<option value="0">表示しない</option>';
		$html .= '<option value="1" selected>表示する</option>';
	}else{
		$html .= '<option value="0">表示しない</option>';
		$html .= '<option value="1" selected>表示する</option>';
	}

	$html .= '</select>';

	return $html;
	exit();

}

function get_staff_data_for_board_disp(){

	$sql = "select id,name from staff_new_new where delete_flg=0 and board_disp_flg=1";
	$res = mysql_query($sql, DbCon);
	if( $res == false ){
		echo "error!(get_staff_data_for_board_disp)";
		exit();
	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$list_data[$i++] = $row;

	}

	return $list_data;
	exit();
}

function get_therapist_id_string($data){

	$data_num = count($data);

	$str = "";

	$first_flg = true;

	for($i=0;$i<$data_num;$i++){

		$id = $data[$i]["id"];

		if( $first_flg == true ){

			$first_flg = false;

			$str = $id;

		}else{

			$str .= ",";
			$str .= $id;

		}

	}

	return $str;
	exit();

}

function get_staff_id_string($data){

	$data_num = count($data);

	$str = "";

	$first_flg = true;

	for($i=0;$i<$data_num;$i++){

		$id = $data[$i]["id"];

		if( $first_flg == true ){

			$first_flg = false;

			$str = $id;

		}else{

			$str .= ",";
			$str .= $id;

		}

	}

	return $str;
	exit();

}

function update_therapist_order_num_rank($therapist_id,$order_num,$rank){

	$rank_order_num = get_rank_order_num($rank);

	$sql = sprintf("update therapist_new set rank='%s',order_num='%s',rank_order_num='%s' where id='%s'",$rank,$order_num,$rank_order_num,$therapist_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(update_therapist_order_num_rank)";
		exit();
	}

	return true;
	exit();
}

function update_staff_order_num_rank($staff_id,$order_num,$rank){

	$rank_order_num = get_rank_order_num($rank);

	$sql = sprintf("update staff_new_new set rank='%s',order_num='%s',rank_order_num='%s' where id='%s'",$rank,$order_num,$rank_order_num,$staff_id);
	echo $sql;
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(update_staff_order_num_rank)";
		exit();
	}

	return true;
	exit();
}

function get_driver_data_by_area_new($area){

	$sql = sprintf("select * from staff_new_new where type='driver' and leave_flg=0 and delete_flg='0' and area='%s'",$area);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリ実行に失敗しました(get_driver_data_by_area_new)";
		exit();
	}

	$i = 0;
	$list_data = array();
	while($row = mysql_fetch_assoc($res)){

		$list_data[$i++] = $row;

	}

	return $list_data;
	exit();
}

function insert_customer($customer_name,$customer_name_kana,$customer_id,$tel,$tel_2,$tel_3,$tel_4,$tel_5,$address_1,$address_2,$email_1,$email_2,$email_3,$email_4,$email_5,$shop_id,$kanri_id,$upd_time){

	$sql = sprintf('insert into customer(name,name_kana,customer_id,
	tel,tel_2,tel_3,tel_4,tel_5,address_1,address_2,mail,mail_2,mail_3,mail_4,mail_5,shop_id,kanri_id,upd_time) values("%s","%s","%s","%s","%s","%s","%s","%s","%s","%s","%s","%s","%s","%s","%s","%s","%s","%s")',$customer_name,$customer_name_kana,$customer_id,$tel,$tel_2,$tel_3,$tel_4,$tel_5,$address_1,$address_2,$email_1,$email_2,$email_3,$email_4,$email_5,$shop_id,$kanri_id,$upd_time);

	$res = mysql_query($sql, DbCon);
	if($res === false){
		echo "error!(insert_customer)";
		exit();
	}

	return true;
	exit();
}

function update_rsv_board($customer_id,$tel,$tel_2,$tel_3,$tel_4,$tel_5){

	$tel = format_phone_number("$tel");

	if($tel_2 == ""){
		$tel_2 = $tel;
	}else{
		$tel_2 = format_phone_number("$tel_2");
	}
	if($tel_3 == ""){
		$tel_3 = $tel;
	}else{
		$tel_3 = format_phone_number("$tel_3");
	}
	if($tel_4 == ""){
		$tel_4 = $tel;
	}else{
		$tel_4 = format_phone_number("$tel_4");
	}
	if($tel_5 == ""){
		$tel_5 = $tel;
	}else{
		$tel_5 = format_phone_number("$tel_5");
	}

	$sql = sprintf('update reservation_for_board set customer_id="%s" where customer_tel in ("%s","%s","%s","%s","%s") and customer_id!="%s";',$customer_id,$tel,$tel_2,$tel_3,$tel_4,$tel_5,$customer_id);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(update_rsv_board)";
		exit();

	}

	return true;
	exit();
}

function update_kanri_id_of_customer($tel,$kanri_id){

	$sql = sprintf("update customer set kanri_id='%s' where delete_flag=0 and tel='%s'",$kanri_id,$tel);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(update_kanri_id_of_customer)";
		exit();
	}

	return true;
	exit();
}

function customer_upd_check($customer_id, $upd_time){

	$sql = sprintf("select upd_time from customer where delete_flag=0 and customer_id='%s'",$customer_id);

	$res = mysql_query($sql, DbCon);
	if( $res == false ){
		echo "error!(customer_upd_check)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	if($row["upd_time"] == ""){return false; exit();}

	$select_upd_time = new DateTime($row["upd_time"]);
	$select_upd_time = $select_upd_time->format('Y/m/d H:i');

	if( $select_upd_time == $upd_time ){

		return true;
		exit();

	}else{

		return false;
		exit();

	}
}

function check_customer_by_id($customer_id){

	$sql = sprintf("select id from customer where delete_flag=0 and customer_id='%s'",$customer_id);
	$res = mysql_query($sql, DbCon);
	if( $res == false ){
		echo "error!(check_customer_by_id)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	if( $row["id"] == "" ){

		return false;
		exit();

	}else{

		return true;
		exit();

	}
}

function check_customer_id($customer_id){

	if( $customer_id == "" ){

		return false;
		exit();

	}

	$sql = sprintf("select id from customer where delete_flag=0 and customer_id='%s'",$customer_id);
	$res = mysql_query($sql, DbCon);
	if( $res == false ){
		echo "error!(check_customer_id)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	if( $row["id"] == "" ){

		return false;
		exit();

	}else{

		return true;
		exit();

	}
}

function check_exist_customer_kanri_id($kanri_id){

	$sql = sprintf("select id from customer where delete_flag=0 and kanri_id='%s'",$kanri_id);
	$res = mysql_query($sql, DbCon);
	if($res === false){
		echo "error!(check_exist_customer_kanri_id)";
		exit();
	}

	$row = mysql_fetch_assoc($res);

	if( $row["id"] == "" ){

		return false;
		exit();

	}else{

		return true;
		exit();

	}
}

function update_customer_by_tel($customer_name,$customer_name_kana,$customer_id,$tel,$tel_2,$tel_3,$tel_4,$tel_5,$address_1,$address_2,$email_1,$email_2,$email_3,$email_4,$email_5,$shop_id,$kanri_id,$upd_time){

	$sql = sprintf('
update customer set name="%s",name_kana="%s",customer_id="%s",
tel="%s",tel_2="%s",tel_3="%s",tel_4="%s",tel_5="%s",
address_1="%s",address_2="%s",mail="%s",mail_2="%s",mail_3="%s",mail_4="%s",mail_5="%s",
shop_id="%s",kanri_id="%s",upd_time="%s" where delete_flag=0 and tel="%s"',
$customer_name,$customer_name_kana,$customer_id,$tel,$tel_2,$tel_3,$tel_4,$tel_5,$address_1,$address_2,$email_1,$email_2,$email_3,$email_4,$email_5,$shop_id,$kanri_id,$upd_time,$tel);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(update_customer_by_tel)";
		exit();

	}

	return true;
	exit();

}

function update_customer($customer_name,$customer_name_kana,$customer_id,$tel,$tel_2,$tel_3,$tel_4,$tel_5,$address_1,$address_2,$email_1,$email_2,$email_3,$email_4,$email_5,$shop_id,$kanri_id,$upd_time){

	$sql = sprintf('
update customer set name="%s",name_kana="%s",customer_id="%s",
tel="%s",tel_2="%s",tel_3="%s",tel_4="%s",tel_5="%s",
address_1="%s",address_2="%s",mail="%s",mail_2="%s",mail_3="%s",mail_4="%s",mail_5="%s",
shop_id="%s",kanri_id="%s",upd_time="%s" where delete_flag=0 and customer_id="%s"',
$customer_name,$customer_name_kana,$customer_id,$tel,$tel_2,$tel_3,$tel_4,$tel_5,$address_1,$address_2,$email_1,$email_2,$email_3,$email_4,$email_5,$shop_id,$kanri_id,$upd_time,$customer_id);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(update_customer)";
		exit();

	}

	return true;
	exit();

}

function get_team_id_select_frm($team_id){
global $team_data;

	$team_data_num = count($team_data);

	$html = '';
	$html .= '<select name="team_id">';
	$html .= '<option value="-1">振分なし</option>';

	for( $i=0; $i<$team_data_num; $i++ ){

		$id = $team_data[$i]["id"];
		$name = $team_data[$i]["name"];

		$name = "チーム".$name;

		if( $id == $team_id ){

			$html .= '<option value="'.$id.'" selected>'.$name.'</option>';

		}else{

			$html .= '<option value="'.$id.'">'.$name.'</option>';

		}

	}

	$html .= '</select>';

	return $html;
	exit();

}

function get_team_name($team_id){
global $team_data;

	$data = "振分なし";

	$team_data_num = count($team_data);

	for( $i=0; $i<$team_data_num; $i++ ){

		$id = $team_data[$i]["id"];
		$name = $team_data[$i]["name"];

		$name = "チーム".$name;

		if( $id == $team_id ){

			$data = $name;

			return $data;
			exit();

		}

	}

	return $data;
	exit();

}

function get_select_frm_team_id_therapist_report($team_id){
global $team_data;

	$team_data_num = count($team_data);

	$html = '';
	$html .= '<select name="team_id" id="select_frm_team_id_therapist_report">';
	$html .= '<option value="-1">未選択</option>';

	for( $i=0; $i<$team_data_num; $i++ ){

		$id = $team_data[$i]["id"];
		$name = $team_data[$i]["name"];

		$name = "チーム".$name;

		if( $id == $team_id ){

			$html .= '<option value="'.$id.'" selected>'.$name.'</option>';

		}else{

			$html .= '<option value="'.$id.'">'.$name.'</option>';

		}

	}

	$html .= '</select>';

	return $html;
	exit();

}

function get_therapist_report_team_id($therapist_list,$team_id){

	$therapist_list_num = count($therapist_list);

	$x = 0;
	$data = array();

	for( $i=0; $i<$therapist_list_num; $i++ ){

		$team_id_tmp = $therapist_list[$i]["team_id"];

		if( $team_id == $team_id_tmp ){

			$data[$x] = $therapist_list[$i];
			$x++;

		}

	}

	return $data;
	exit();

}

function get_team_data_for_therapist_report_team(){

	include(COMMON_INC."team_data.php");

	$team_data_num = count($team_data);

	for( $i=0; $i<$team_data_num; $i++ ){

		$team_id = $team_data[$i]["id"];
		$name = $team_data[$i]["name"];

		$tmp = get_therapist_report_all_for_therapist_report_team($team_id);

		$team_data[$i]["report"] = $tmp;

	}

	return $team_data;
	exit();

}

function get_repeater_num_by_team_id($year_old,$month_old,$day_old,$year_now,$month_now,$day_now,$team_id){

	$year_name = "year";
	$month_name = "month";
	$day_name = "day";
	$where_kikan = get_where_kikan_common($year_old,$month_old,$day_old,$year_now,$month_now,$day_now,$year_name,$month_name,$day_name);

$sql = sprintf("
select
repeater.id
from repeater
left join attendance_new on attendance_new.id=repeater.attendance_id
left join therapist_new on therapist_new.id=repeater.therapist_id
where
repeater.delete_flg='0' and
therapist_new.delete_flg='0' and
therapist_new.team_id='%s' and
(%s)",
$team_id,$where_kikan);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(get_repeater_num_by_team_id)";
		exit();

	}

	$num = mysql_num_rows($res);

	return $num;
	exit();

}

function get_all_data_for_therapist_report_team($year_old,$month_old,$day_old,$year_now,$month_now,$day_now,$team_id){

	$year_name = "reservation_for_board.year";
	$month_name = "reservation_for_board.month";
	$day_name = "reservation_for_board.day";
	$where_kikan = get_where_kikan_common($year_old,$month_old,$day_old,$year_now,$month_now,$day_now,$year_name,$month_name,$day_name);

$sql = sprintf("
select
reservation_for_board.new_flg,
reservation_for_board.shimei_flg
from reservation_for_board
left join attendance_new on attendance_new.id=reservation_for_board.attendance_id
left join therapist_new on therapist_new.id=attendance_new.therapist_id
where
reservation_for_board.delete_flg='0' and
therapist_new.delete_flg='0' and
therapist_new.team_id='%s' and
(%s)",
$team_id,$where_kikan);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(get_all_data_for_therapist_report_team)";
		exit();

	}

	$all_num = 0;
	$shimei_num = 0;
	$new_num = 0;

	while($row = mysql_fetch_assoc($res)){

		$new_flg = $row["new_flg"];
		$shimei_flg = $row["shimei_flg"];

		if( $new_flg == "1" ){

			$new_num++;

		}

		if( $shimei_flg == "1" ){

			$shimei_num++;

		}

		$all_num++;

	}

	$data["all_num"] = $all_num;
	$data["new_num"] = $new_num;
	$data["shimei_num"] = $shimei_num;

	return $data;
	exit();

}

function get_therapist_report_all_for_therapist_report_team($team_id){

	$data = get_eigyou_day_common();
	$year_now = $data["year"];
	$month_now = $data["month"];
	$day_now = $data["day"];

	$num = 90;
	$data = get_old_day_common($year_now,$month_now,$day_now,$num);
	$year_old = $data["year"];
	$month_old = $data["month"];
	$day_old = $data["day"];

	$timestamp_old = get_timestamp_by_year_month_day_2_common($year_old,$month_old,$day_old);

	$timestamp_now = get_timestamp_by_year_month_day_3_common($year_now,$month_now,$day_now);

	//リピーター数の取得(すべて)
	$repeater_num = get_repeater_num_by_team_id(
$year_old,$month_old,$day_old,$year_now,$month_now,$day_now,$team_id);

	//施術数、新規数、指名数、取得(すべて)
	$data = get_all_data_for_therapist_report_team(
$year_old,$month_old,$day_old,$year_now,$month_now,$day_now,$team_id);

	$all_num = $data["all_num"];
	$new_num = $data["new_num"];
	$shimei_num = $data["shimei_num"];

	$data = get_rate_for_reportcard_common($repeater_num,$new_num,$shimei_num,$all_num);

	return $data;
	exit();

}

function get_therapist_report_area_for_therapist_report_team($area){

	$data = get_eigyou_day_common();
	$year_now = $data["year"];
	$month_now = $data["month"];
	$day_now = $data["day"];

	$num = 90;
	$data = get_old_day_common($year_now,$month_now,$day_now,$num);
	$year_old = $data["year"];
	$month_old = $data["month"];
	$day_old = $data["day"];

	$timestamp_old = get_timestamp_by_year_month_day_2_common($year_old,$month_old,$day_old);

	$timestamp_now = get_timestamp_by_year_month_day_3_common($year_now,$month_now,$day_now);

	//リピーター数の取得(すべて)
	$repeater_num = get_repeater_num_area_for_therapist_report_team(
$year_old,$month_old,$day_old,$year_now,$month_now,$day_now,$area);

	//施術数、新規数、指名数、取得(すべて)
	$data = get_all_data_area_for_therapist_report_team(
$year_old,$month_old,$day_old,$year_now,$month_now,$day_now,$area);

	$all_num = $data["all_num"];
	$new_num = $data["new_num"];
	$shimei_num = $data["shimei_num"];

	$data = get_rate_for_reportcard_common($repeater_num,$new_num,$shimei_num,$all_num);

	return $data;
	exit();

}

function get_repeater_num_area_for_therapist_report_team($year_old,$month_old,$day_old,$year_now,$month_now,$day_now,$area){

	$year_name = "year";
	$month_name = "month";
	$day_name = "day";
	$where_kikan = get_where_kikan_common($year_old,$month_old,$day_old,$year_now,$month_now,$day_now,$year_name,$month_name,$day_name);

	$sql = sprintf("
select
repeater.id
from repeater
left join attendance_new on attendance_new.id=repeater.attendance_id
left join therapist_new on therapist_new.id=repeater.therapist_id
where
repeater.delete_flg='0' and
therapist_new.delete_flg='0' and
therapist_new.area='%s' and
(%s)",
$area,$where_kikan);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(get_repeater_num_area_for_therapist_report_team)";
		exit();

	}

	$num = mysql_num_rows($res);

	return $num;
	exit();

}

function get_all_data_area_for_therapist_report_team($year_old,$month_old,$day_old,$year_now,$month_now,$day_now,$area){

	$year_name = "reservation_for_board.year";
	$month_name = "reservation_for_board.month";
	$day_name = "reservation_for_board.day";
	$where_kikan = get_where_kikan_common($year_old,$month_old,$day_old,$year_now,$month_now,$day_now,$year_name,$month_name,$day_name);

	$sql = sprintf("
select
reservation_for_board.new_flg,
reservation_for_board.shimei_flg
from reservation_for_board
left join attendance_new on attendance_new.id=reservation_for_board.attendance_id
left join therapist_new on therapist_new.id=attendance_new.therapist_id
where
reservation_for_board.delete_flg='0' and
therapist_new.delete_flg='0' and
therapist_new.area='%s' and
(%s)",
$area,$where_kikan);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(get_all_data_area_for_therapist_report_team)";
		exit();

	}

	$all_num = 0;
	$shimei_num = 0;
	$new_num = 0;

	while($row = mysql_fetch_assoc($res)){

		$new_flg = $row["new_flg"];
		$shimei_flg = $row["shimei_flg"];

		if( $new_flg == "1" ){

			$new_num++;

		}

		if( $shimei_flg == "1" ){

			$shimei_num++;

		}

		$all_num++;

	}

	$data["all_num"] = $all_num;
	$data["new_num"] = $new_num;
	$data["shimei_num"] = $shimei_num;

	return $data;
	exit();

}

function get_team_data_for_staff_calendar_team(){

	include(COMMON_INC."team_data.php");

	$team_data_num = count($team_data);

	for( $i=0; $i<$team_data_num; $i++ ){

		$team_id = $team_data[$i]["id"];

		$therapist_data = get_therapist_data_by_team_id_for_staff_calendar_team($team_id);

		$attendance_data = get_attendance_data_by_team_id_for_staff_calendar_team($team_id);

		$team_data[$i]["therapist_data"] = $therapist_data;
		$team_data[$i]["attendance_data"] = $attendance_data;

	}

	return $team_data;
	exit();

}

function get_therapist_data_by_team_id_for_staff_calendar_team($team_id){

	$area = "tokyo";

	$sql = sprintf("
select * from therapist_new where
delete_flg=0 and
leave_flg=0 and
area='%s' and
team_id='%s'",
$area,$team_id);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(get_therapist_data_by_team_id_for_staff_calendar_team)";
		exit();

	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$list_data[$i] = $row;
		$i++;

	}

	return $list_data;
	exit();

}

function get_attendance_data_by_team_id_for_staff_calendar_team($team_id){

	$now_month = intval(date('m'));

	$next_month = $now_month+1;

	if($next_month==13){
		$next_month = 1;
	}

	$two_month = $next_month+1;

	if($two_month == 13){
		$two_month = 1;
	}

	$sql = sprintf("
select attendance_new.* from attendance_new
left join therapist_new on therapist_new.id=attendance_new.therapist_id
where (attendance_new.month='%s' or attendance_new.month='%s' or attendance_new.month='%s') and
therapist_new.delete_flg=0 and
therapist_new.leave_flg=0 and
therapist_new.team_id='%s'",
$now_month,$next_month,$two_month,$team_id);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(get_attendance_data_by_team_id_for_staff_calendar_team)";
		exit();

	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$list_data[$i++] = $row;

	}

	return $list_data;
	exit();

}

function get_attendance_num_by_day_for_staff_calendar_team($year, $month, $day,$attendance_data){

	$attendance_data_num = count($attendance_data);

	$num = 0;

	for($i=0;$i<$attendance_data_num;$i++){

		$year_tmp = $attendance_data[$i]["year"];
		$month_tmp = $attendance_data[$i]["month"];
		$day_tmp = $attendance_data[$i]["day"];
		$syounin_state = $attendance_data[$i]["syounin_state"];
		$today_absence = $attendance_data[$i]["today_absence"];
		$kekkin_flg = $attendance_data[$i]["kekkin_flg"];

		if( ($year==$year_tmp) && ($month==$month_tmp) && ($day==$day_tmp) && ($syounin_state=="1") && ($today_absence=="0") && ($kekkin_flg=="0") ){

			$num++;

		}

	}

	return $num;
	exit();

}

function get_select_frm_wait_select($wait_select){

	include(COMMON_INC."wait_select_data.php");

	$data = $wait_select_data;

	$data_num = count($data);

	$html = '';
	$html .= '<select name="wait_select">';
	$html .= '<option value="-1">未選択</option>';

	for( $i=0; $i<$data_num; $i++ ){

		$id = $data[$i]["id"];
		$name = $data[$i]["name"];

		if( $id == $wait_select ){

			$html .= sprintf('<option value="%s" selected>%s</option>',$id,$name);

		}else{

			$html .= sprintf('<option value="%s">%s</option>',$id,$name);

		}

	}

	$html .= '</select>';

	return $html;
	exit();

}

function get_wait_select_name($wait_select){

	$return_data = "未選択";

	include(COMMON_INC."wait_select_data.php");

	$data = $wait_select_data;

	$data_num = count($data);

	for( $i=0; $i<$data_num; $i++ ){

		$id = $data[$i]["id"];
		$name = $data[$i]["name"];

		if( $id == $wait_select ){

			$return_data = $name;

			return $return_data;
			exit();

		}

	}

	return $return_data;
	exit();

}

function get_wait_select_data_for_staff_calendar_wait(){

	include(COMMON_INC."wait_select_data.php");

	$data = $wait_select_data_2;

	$data_num = count($data);

	for( $i=0; $i<$data_num; $i++ ){

		$id = $data[$i]["id"];

		$therapist_data = get_therapist_data_by_wait_select_for_staff_calendar_wait($id);

		$attendance_data = get_attendance_data_by_wait_select_for_staff_calendar_wait($id);

		$data[$i]["therapist_data"] = $therapist_data;
		$data[$i]["attendance_data"] = $attendance_data;

	}

	return $data;
	exit();

}

function get_therapist_data_by_wait_select_for_staff_calendar_wait($wait_select){

	$area = "tokyo";

	$sql = sprintf("
select * from therapist_new where
delete_flg=0 and
leave_flg=0 and
area='%s' and
wait_select='%s' order by rank_order_num asc",
$area,$wait_select);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(get_therapist_data_by_wait_select_for_staff_calendar_wait)";
		exit();

	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$list_data[$i] = $row;
		$i++;

	}

	return $list_data;
	exit();

}

function get_attendance_data_by_wait_select_for_staff_calendar_wait($wait_select){

	$now_month = intval(date('m'));

	$next_month = $now_month+1;

	if($next_month==13){
		$next_month = 1;
	}

	$two_month = $next_month+1;

	if($two_month == 13){
		$two_month = 1;
	}

	$sql = sprintf("
select attendance_new.* from attendance_new
left join therapist_new on therapist_new.id=attendance_new.therapist_id
where (attendance_new.month='%s' or attendance_new.month='%s' or attendance_new.month='%s') and
therapist_new.delete_flg=0 and
therapist_new.leave_flg=0 and
therapist_new.wait_select='%s'",
$now_month,$next_month,$two_month,$wait_select);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(get_attendance_data_by_wait_select_for_staff_calendar_wait)";
		exit();

	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$list_data[$i++] = $row;

	}

	return $list_data;
	exit();

}

function get_reservation_status_board_site_menu($year,$month,$day){

$site_menu =<<<EOT
<a href="reservation_status_board_wait.php?year={$year}&month={$month}&day={$day}">東京</a>
<a href="reservation_status_board_wait_yokohama.php?year={$year}&month={$month}&day={$day}&area=yokohama">横浜</a>
<a href="reservation_status_board.php?year={$year}&month={$month}&day={$day}&area=sapporo">札幌</a>
<a href="reservation_status_board_wait_sendai.php?year={$year}&month={$month}&day={$day}&area=sendai">仙台</a>
EOT;

	return $site_menu;
	exit();

}

function get_wait_select_data_for_reservation_status_board_wait($year,$month,$day){

	include(COMMON_INC."wait_select_data.php");

	$data = $wait_select_data_2;

	$data_num = count($data);

	for( $i=0; $i<$data_num; $i++ ){

		$wait_select = $data[$i]["id"];

		$therapist_data = get_therapist_data_for_reservation_status_board_wait_2($year,$month,$day,$wait_select);

		$data[$i]["therapist_data"] = $therapist_data;

	}

	/*
	$therapist_data = get_therapist_data_for_reservation_status_board_wait_aroma($year,$month,$day);
	$data[$i]["id"] = "-2";
	$data[$i]["name"] = "アロマ専属";
	$data[$i]["therapist_data"] = $therapist_data;
	*/

	return $data;
	exit();

}

function get_wait_select_data_for_reservation_status_board_wait_sendai($year,$month,$day){

	include(COMMON_INC."wait_select_data.php");

	$data = $wait_select_data_2;

	$data_num = count($data);

	for( $i=0; $i<$data_num; $i++ ){

		$wait_select = $data[$i]["id"];

		$therapist_data = get_therapist_data_for_reservation_status_board_wait_2_sendai($year,$month,$day,$wait_select);

		$data[$i]["therapist_data"] = $therapist_data;

	}

	/*
	$therapist_data = get_therapist_data_for_reservation_status_board_wait_aroma($year,$month,$day);
	$data[$i]["id"] = "-2";
	$data[$i]["name"] = "アロマ専属";
	$data[$i]["therapist_data"] = $therapist_data;
	*/

	return $data;
	exit();

}

function get_wait_select_data_for_reservation_status_board_wait_yokohama($year,$month,$day){

	include(COMMON_INC."wait_select_data.php");

	$data = $wait_select_data_2;

	$data_num = count($data);

	for( $i=0; $i<$data_num; $i++ ){

		$wait_select = $data[$i]["id"];

		$therapist_data = get_therapist_data_for_reservation_status_board_wait_2_yokohama($year,$month,$day,$wait_select);

		$data[$i]["therapist_data"] = $therapist_data;

	}

	/*
	$therapist_data = get_therapist_data_for_reservation_status_board_wait_aroma($year,$month,$day);
	$data[$i]["id"] = "-2";
	$data[$i]["name"] = "アロマ専属";
	$data[$i]["therapist_data"] = $therapist_data;
	*/

	return $data;
	exit();

}

function get_therapist_data_for_reservation_status_board_wait($year,$month,$day,$wait_select){

	$area = "tokyo";

	// 出勤しているセラピスト情報を取得するためのSQL文

	$sql = sprintf("
select *,attendance_new.id as attendance_id from attendance_new
left join therapist_new on attendance_new.therapist_id=therapist_new.id
where
therapist_new.delete_flg=0 and
therapist_new.leave_flg=0 and
therapist_new.test_flg=0 and
therapist_new.wait_select='%s' and
therapist_new.therapist_type='1' and
attendance_new.year='%s' and
attendance_new.month='%s' and
attendance_new.day='%s' and
attendance_new.today_absence='0' and
attendance_new.kekkin_flg='0' and
attendance_new.area='%s'
order by therapist_new.rank_order_num asc,therapist_new.order_num desc",
$wait_select,$year,$month,$day,$area);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_therapist_data_for_reservation_status_board_wait)";
		exit();
	}

	$data = array();

	$i=0;

	while($row = mysql_fetch_assoc($res)){

		$therapist_id = $row["therapist_id"];

		//therapist_id重複チェック
		$result = check_duplication_therapist_id_in_attendance_new($data,$therapist_id);

		if( $result == false ){

			$data[$i] = $row;

			$attendance_id = $data[$i]["attendance_id"];

			$data[$i]["area"] = $area;

			$sql = sprintf("select time from reservation_new where attendance_id='%s'",$attendance_id);

			$res2 = mysql_query($sql, DbCon);
			if($res == false){
				echo "error!(get_therapist_data_for_reservation_status_board_wait)";
				exit();
			}

			$j=0;
			while($row2 = mysql_fetch_assoc($res2)){
				$data[$i]["time"][$j] = $row2["time"];
				$time_num = count($data[$i]["time"]);
				$data[$i]["time_num"] = $time_num;
				$j++;
			}
			if($j==0){
				$data[$i]["time_num"]=0;
			}

			$i++;

		}

	}

	return $data;
	exit();

}

function get_therapist_data_for_reservation_status_board_wait_aroma($year,$month,$day){

	$area = "tokyo";

	// 出勤しているセラピスト情報を取得するためのSQL文

	$sql = sprintf("
select *,attendance_new.id as attendance_id from attendance_new
left join therapist_new on attendance_new.therapist_id=therapist_new.id
where
therapist_new.delete_flg=0 and
therapist_new.leave_flg=0 and
therapist_new.test_flg=0 and
therapist_new.therapist_type='2' and
attendance_new.year='%s' and
attendance_new.month='%s' and
attendance_new.day='%s' and
attendance_new.today_absence='0' and
attendance_new.kekkin_flg='0' and
attendance_new.area='%s'
order by therapist_new.rank_order_num asc,therapist_new.order_num desc",
$year,$month,$day,$area);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_therapist_data_for_reservation_status_board_wait_aroma)";
		exit();
	}

	$data = array();

	$i=0;
	while($row = mysql_fetch_assoc($res)){

		$therapist_id = $row["therapist_id"];

		//therapist_id重複チェック
		$result = check_duplication_therapist_id_in_attendance_new($data,$therapist_id);

		if( $result == false ){

			$data[$i] = $row;

			$attendance_id = $data[$i]["attendance_id"];

			$data[$i]["area"] = $area;

			$sql = sprintf("select time from reservation_new where attendance_id='%s'",$attendance_id);

			$res2 = mysql_query($sql, DbCon);
			if($res == false){
				echo "error!(get_therapist_data_for_reservation_status_board_wait)";
				exit();
			}

			$j=0;
			while($row2 = mysql_fetch_assoc($res2)){
				$data[$i]["time"][$j] = $row2["time"];
				$time_num = count($data[$i]["time"]);
				$data[$i]["time_num"] = $time_num;
				$j++;
			}
			if($j==0){
				$data[$i]["time_num"]=0;
			}

			$i++;

		}

	}

	return $data;
	exit();

}

function get_select_frm_shop_for_dashboard_support($shop_type){

	if( $shop_type == "" ){

		$shop_type = "東京エリア";

	}

	$data = get_shop_data_for_dashboard_support();
	$data_num = count($data);

	$html = '';
	$html .= '<select name="shop_type">';
	$html .= '<option value="-1">未選択</option>';

	for( $i=0; $i<$data_num; $i++ ){

		$tmp = $data[$i];

		if( $shop_type == $tmp ){

			$html .= sprintf('<option value="%s" selected>%s</option>',$tmp,$tmp);

		}else{

			$html .= sprintf('<option value="%s">%s</option>',$tmp,$tmp);

		}

	}

	$html .= '</select>';

	return $html;
	exit();

}

function get_disp_data_for_dashboard_support($data){

	$data_num = count($data);

	$orders_route["tel"]["new"] = 0;
	$orders_route["tel"]["repeater"] = 0;
	$orders_route["tel"]["regular"] = 0;

	$orders_route["web"]["new"] = 0;
	$orders_route["web"]["repeater"] = 0;
	$orders_route["web"]["repeater_shimei"] = 0;
	$orders_route["web"]["repeater_not_shimei"] = 0;
	$orders_route["web"]["regular"] = 0;
	$orders_route["web"]["regular_shimei"] = 0;
	$orders_route["web"]["regular_not_shimei"] = 0;

	$shimei_num = 0;

	for( $i=0; $i<$data_num; $i++ ){

		$orders_route_tmp = trim($data[$i]["orders_route"]);
		$new_flg = $data[$i]["new_flg"];
		$repeat_flg = $data[$i]["repeat_flg"];
		$shimei_flg = $data[$i]["shimei_flg"];

		if( $shimei_flg == "1" ){

			$shimei_num = $shimei_num + 1;

		}

		if( $orders_route_tmp == "TEL" ){

			if( $new_flg == "1" ){

				$orders_route["tel"]["new"] = $orders_route["tel"]["new"] + 1;

			}else if( $repeat_flg == "1" ){

				$orders_route["tel"]["repeater"] = $orders_route["tel"]["repeater"] + 1;

			}else{

				$orders_route["tel"]["regular"] = $orders_route["tel"]["regular"] + 1;

			}

		}

		if( $orders_route_tmp == "WEB" ){

			if( $new_flg == "1" ){

				$orders_route["web"]["new"] = $orders_route["web"]["new"] + 1;

			}else if( $repeat_flg == "1" ){

				$orders_route["web"]["repeater"] = $orders_route["web"]["repeater"] + 1;

				if( $shimei_flg == "1" ){

					$orders_route["web"]["repeater_shimei"] = $orders_route["web"]["repeater_shimei"] + 1;

				}else{

					$orders_route["web"]["repeater_not_shimei"] = $orders_route["web"]["repeater_not_shimei"] + 1;

				}

			}else{

				$orders_route["web"]["regular"] = $orders_route["web"]["regular"] + 1;

				if( $shimei_flg == "1" ){

					$orders_route["web"]["regular_shimei"] = $orders_route["web"]["regular_shimei"] + 1;

				}else{

					$orders_route["web"]["regular_not_shimei"] = $orders_route["web"]["regular_not_shimei"] + 1;

				}

			}

		}

	}

	$return_data["orders_route"] = $orders_route;
	$return_data["shimei_num"] = $shimei_num;

	return $return_data;
	exit();

}

function get_disp_data_2_for_dashboard_support($data){

	$data_num = count($data);

	$num_all = 0;
	$num_a = 0;
	$num_b = 0;
	$num_c = 0;
	$num_d = 0;
	$num_new = 0;
	$num_home = 0;

	for( $i=0; $i<$data_num; $i++ ){

		$therapist_id = $data[$i]["therapist_id"];

		$tmp = get_therapist_data_by_id_common($therapist_id);

		$rank = $tmp["rank"];
		$wait_select = $tmp["wait_select"];

		$num_all++;

		if( $wait_select == "3" ){

			$num_home++;

		}

		//1:A,2:B,3:C,4:新人,5:D,19:対象外

		if( $rank == "1" ){

			$num_a++;

		}else if( $rank == "2" ){

			$num_b++;

		}else if( $rank == "3" ){

			$num_c++;

		}else if( $rank == "5" ){

			$num_d++;

		}else if( $rank == "4" ){

			$num_new++;

		}

	}

	$return_data["num_all"] = $num_all;
	$return_data["num_a"] = $num_a;
	$return_data["num_b"] = $num_b;
	$return_data["num_c"] = $num_c;
	$return_data["num_d"] = $num_d;
	$return_data["num_new"] = $num_new;
	$return_data["num_home"] = $num_home;

	return $return_data;
	exit();

}

function select_frm_therapist_for_black_list($data,$therapist_id){

	$data_num = count($data);

	$html = "";

	$html .= '<select name="therapist_id">';
	$html .= '<option value="-1">未選択</option>';

	for($i=0;$i<$data_num;$i++){

		$therapist_id_tmp = $data[$i]["id"];
		$therapist_name = $data[$i]["name"];
		$therapist_area = $data[$i]["area"];

		$area_name = get_area_name_by_area_common($therapist_area);

		$therapist_name_disp = sprintf("%s(%s)",$therapist_name,$area_name);

		if( $therapist_id_tmp == $therapist_id ){

			$html .= sprintf('<option value="%s" selected>%s</option>',$therapist_id_tmp,$therapist_name_disp);

		}else{

			$html .= sprintf('<option value="%s">%s</option>',$therapist_id_tmp,$therapist_name_disp);

		}

	}

	$html .= '</select>';

	return $html;
	exit();

}

function add_black_list($customer_id,$therapist_id){

	$result = check_exist_black_list_common($therapist_id, $customer_id);

	if( $result == true ){

		return true;
		exit();

	}

	$sql = sprintf("insert into black_list(customer_id,therapist_id) values('%s','%s')",$customer_id,$therapist_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(add_black_list)";
		exit();
	}

	return true;
	exit();
}

function get_black_list_for_black_list($customer_id,$therapist_data){

	$data = get_black_list_by_customer_id($customer_id);

	$data_num = count($data);

	for( $i=0; $i<$data_num; $i++ ){

		$customer_id = $data[$i]["customer_id"];
		$therapist_id = $data[$i]["therapist_id"];

		$select_frm = select_frm_therapist_for_black_list($therapist_data,$therapist_id);

		$data[$i]["select_frm"] = $select_frm;

	}

	return $data;
	exit();

}

function get_black_list_by_customer_id($customer_id){

	$sql = sprintf("select * from black_list where delete_flg='0' and customer_id='%s'",$customer_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_black_list_by_customer_id)";
		exit();
	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$list_data[$i] = $row;
		$i++;

	}

	return $list_data;
	exit();
}

function update_black_list($black_list_id,$therapist_id){

	$sql = sprintf("update black_list set therapist_id='%s' where id='%s'",$therapist_id,$black_list_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(update_black_list)";
		exit();
	}

	return true;
	exit();
}

function delete_black_list($black_list_id){

	$sql = sprintf("update black_list set delete_flg='1' where id='%s'",$black_list_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(delete_black_list)";
		exit();
	}

	return true;
	exit();
}

function get_black_list_disp_for_customer_detail($data){

	$html = "";

	$data_num = count($data);

	for( $i=0; $i<$data_num; $i++ ){

		$therapist_id = $data[$i]["therapist_id"];

		$therapist_name = get_therapist_name_real_by_therapist_id_common($therapist_id);

		$html .= $therapist_name;
		$html .= "<br />";

	}

	return $html;
	exit();

}

function get_calendar_course_list_pc($year,$month){

	$html = "";

	$html .= sprintf('<input type="hidden" name="calendar_year" value="%s" id="calendar_year" />',$year);
	$html .= sprintf('<input type="hidden" name="calendar_month" value="%s" id="calendar_month" />',$month);

	$week_value = get_week_value($year, $month, 1);

	if( $week_value == "0" ){
		$pre_disp_num =  7;
	}else{
		$pre_disp_num =  $week_value;
	}

	$last_day_now = get_last_day($year,$month);
	$last_day_pre = get_pre_month_last_day($year,$month);

	$pre_disp_start_day = ($last_day_pre - $pre_disp_num) + 1;

	$type = "kako";

	$func=<<<EOT
onclick="calendar_move('{$year}','{$month}','{$type}');"
EOT;

	$html .= '<div id="calendar_disp_top">';

	$html .= '<div class="left1">';
	$html .= '<img src="'.WWW_URL.'img/calendar/calendar_left_pc.jpg" '.$func.' />';
	$html .= '</div>';

	$html .= '<div class="left2">';
	$html .= sprintf('%s年%s月',$year,$month);
	$html .= '</div>';

	$type = "mirai";

	$func=<<<EOT
onclick="calendar_move('{$year}','{$month}','{$type}');"
EOT;

	$html .= '<div class="left3">';
	$html .= '<img src="'.WWW_URL.'img/calendar/calendar_right_pc.jpg" '.$func.' />';
	$html .= '</div>';

	$html .= '<br class="clear" />';

	$html .= '</div>';

	$html .= '<div id="calendar_disp">';

	$html .= '<div class="title">日</div>';
	$html .= '<div class="title">月</div>';
	$html .= '<div class="title">火</div>';
	$html .= '<div class="title">水</div>';
	$html .= '<div class="title">木</div>';
	$html .= '<div class="title">金</div>';
	$html .= '<div class="title">土</div>';

	for( $i=$pre_disp_start_day; $i<=$last_day_pre; $i++ ){

		$html .= '<div class="out">'.$i.'</div>';

	}

	for( $i=1; $i<=$last_day_now; $i++ ){

		$day = $i;

		$html .= sprintf('<a href="course_list.php?year=%s&month=%s&day=%s" class="in">%s</a>',$year,$month,$day,$day);

	}

	$week_value = get_week_value($year, $month, $last_day_now);

	if( $week_value == "0" ){
		$next_disp_num =  6;
	}else if( $week_value == "1" ){
		$next_disp_num =  5;
	}else if( $week_value == "2" ){
		$next_disp_num =  4;
	}else if( $week_value == "3" ){
		$next_disp_num =  3;
	}else if( $week_value == "4" ){
		$next_disp_num =  2;
	}else if( $week_value == "5" ){
		$next_disp_num =  1;
	}else if( $week_value == "6" ){
		$next_disp_num =  7;
	}else{
		$next_disp_num =  0;
	}

	for( $i=1; $i<=$next_disp_num; $i++ ){

		$html .= '<div class="out">'.$i.'</div>';

	}

	$html .= '</div>';

	$html .= '<br class="clear" />';

	$func=<<<EOT
onclick="calendar_close();"
EOT;

	$html .= '<div id="calendar_bottom">';
	$html .= '<div id="calendar_disp_close" '.$func.'>×&nbsp;閉じる</div>';
	$html .= "</div>";

	return $html;
	exit();

}

function get_pre_month_last_day($year,$month){

	$day = "10";

	$data = get_pre_month($year,$month,$day);

	$year = $data["year"];
	$month = $data["month"];

	$last_day = get_last_day($year,$month);

	return $last_day;
	exit();

}

//前月データの取得
function get_pre_month($year,$month,$day){

	$data = array();

	$data["year"] = intval(date("Y", mktime(0, 0, 0, $month-1, $day, $year)));
	$data["month"] = intval(date("m", mktime(0, 0, 0, $month-1, $day, $year)));
	$data["day"] = intval(date("d", mktime(0, 0, 0, $month-1, $day, $year)));

	return $data;
	exit();

}

function get_driver_day_report($staff_id){

	$data = get_today_year_month_day_common();
	$year = $data["year"];
	$month = $data["month"];
	$day = $data["day"];
	$attendance_data = get_attendance_staff_new_day_and_staff_id_common($year,$month,$day,$staff_id);
	$attendance_staff_new_id = $attendance_data["id"];

	if( $attendance_staff_new_id == "" ){

		return false;
		exit();

	}

	$data = get_driver_day_report_for_man_by_attendance_staff_new_id_common($attendance_staff_new_id);

	$start_hour_d = $data["start_hour_d"];

	if( ( $start_hour_d == "" ) || ( $start_hour_d == "-1" ) ){

		return false;
		exit();

	}

	return $data;
	exit();

}

function delete_driver_day_report_man($attendance_staff_2_id){

	$sql = sprintf("update attendance_staff_2 set report_delete_flg='1' where id='%s'",$attendance_staff_2_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(delete_driver_day_report_man)";
		exit();
	}

	return true;
	exit();
}

function update_day_report_man($attendance_staff_2_id){

	$data = get_attendance_staff_2_by_id_common($attendance_staff_2_id);

	$start_hour = $data["start_hour_d"];
	$start_minute = $data["start_minute_d"];
	$end_hour = $data["end_hour_d"];
	$end_minute = $data["end_minute_d"];
	$car_distance = $data["car_distance_d"];
	$highway = $data["highway_d"];
	$parking = $data["parking_d"];
	$pay_finish = $data["pay_finish_d"];
	$attendance_staff_new_id = $data["attendance_staff_new_id"];

	$sql = sprintf("
update attendance_staff_new set
start_hour='%s',
start_minute='%s',
end_hour='%s',
end_minute='%s',
car_distance='%s',
highway='%s',
parking='%s',
pay_finish='%s'
where id='%s'",
$start_hour,$start_minute,$end_hour,$end_minute,$car_distance,$highway,$parking,$pay_finish,$attendance_staff_new_id);

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(update_day_report_man)";
		exit();

	}

	delete_driver_day_report_man($attendance_staff_2_id);

	return true;
	exit();

}

function send_mail_day_report_dismissal_man($staff_id,$attendance_staff_2_id){

	$data = get_staff_data_by_id_common($staff_id);

	$staff_mail = $data["mail"];
	$staff_name = $data["name"];

	$data = get_attendance_staff_2_by_id_common($attendance_staff_2_id);

	$start_hour = $data["start_hour_d"];
	$start_minute = add_zero_when_under_ten_common($data["start_minute_d"]);
	$end_hour = $data["end_hour_d"];
	$end_minute = add_zero_when_under_ten_common($data["end_minute_d"]);
	$car_distance = $data["car_distance_d"];
	$highway = number_format($data["highway_d"]);
	$parking = number_format($data["parking_d"]);
	$pay_finish = number_format($data["pay_finish_d"]);
	$attendance_staff_new_id = $data["attendance_staff_new_id"];

	$data = get_attendance_staff_new_data_by_attendance_id_common($attendance_staff_new_id);

	$year = $data["year"];
	$month = $data["month"];
	$day = $data["day"];

	$title = sprintf("[業務開始・締め処理の却下][%sさん]",$staff_name);

$content =<<<EOT

{$staff_name}さん

以下の業務開始・締め処理が却下されました。

{$year}年{$month}月{$day}日

開始：{$start_hour}時{$start_minute}分
終了：{$end_hour}時{$end_minute}分
距離： {$car_distance}km
高速代：{$highway} 円
駐車場代： {$parking}円
精算済み： {$pay_finish}円

EOT;

	//メール送信
	mb_language("ja");
	mb_internal_encoding("UTF-8");
	$mailto = $staff_mail;

	$header = "From: info@neo-gate.jp\n";
	//$header .= "Bcc: minamikawa@neo-gate.jp";

	mb_send_mail($mailto,$title,$content,$header,MAIL_PARAMETER);

	return true;
	exit();

}

function update_therapist_edit_man_4(
$therapist_id,$mail,$name_real,$name_site,$kenmu,$rank,$name_aroma,$name_tgr,$name_lymph,$jitaku_taiki_flg,
$for_kobetsu_url,$kensyuu_flg,$jisou_flg,$point_ref,$guarantee_rule,$point_fix,$address,$tel,
$bank_info,$total_point,$name_furi,$furikomi_type,$chief_allowance,$transport_cost,
$chief_allowance_start_time,$name_man,$password_man,$login_auth_type,$point_fix_start_time,
$team_id,$wait_select,$wait_txt,$aroma_flg){

	if( $aroma_flg == "1" ){

		$therapist_type = "2";

	}else{

		$therapist_type = "1";

	}

	if( $wait_select == "" ){

		$wait_select = "-1";

	}

	$rank_order_num = get_rank_order_num($rank);

	if( $jitaku_taiki_flg != "1" ){
		$jitaku_taiki_flg = 0;
	}

	if( $jisou_flg != "1" ){
		$jisou_flg = 0;
	}

	$kenmu_string = "";

	$kenmu_num = count($kenmu);

	if( $kenmu_num > 0 ){

		for($i=0;$i<$kenmu_num;$i++){

			$kenmu_string .= $kenmu[$i];

			if( $i != ($kenmu_num-1) ){

				$kenmu_string .= $kenmu_string.",";

			}

		}

	}

	$name_real = trim($name_real);
	$name_site = trim($name_site);
	$name_aroma = trim($name_aroma);

	$sql = sprintf("
update therapist_new set
name='%s',
mail='%s',
name_site='%s',
name_aroma='%s',
name_tgr='%s',
name_lymph='%s',
kenmu='%s',
rank='%s',
jitaku_taiki_flg='%s',
for_kobetsu_url='%s',
kensyuu_flg='%s',
jisou_flg='%s',
rank_order_num='%s',
point_ref='%s',
guarantee_rule='%s',
point_fix='%s',
point_fix_start_time='%s',
address='%s',
tel='%s',
bank_info='%s',
total_point='%s',
name_furi='%s',
furikomi_type='%s',
chief_allowance='%s',
transport_cost='%s',
chief_allowance_start_time='%s',
name_man='%s',
login_auth_type='%s',
password_man='%s',
team_id='%s',
wait_select='%s',
therapist_type='%s',
wait_txt='%s'
where id='%s'",
$name_real,$mail,$name_site,$name_aroma,$name_tgr,$name_lymph,$kenmu_string,$rank,$jitaku_taiki_flg,
$for_kobetsu_url,$kensyuu_flg,$jisou_flg,$rank_order_num,$point_ref,$guarantee_rule,
$point_fix,$point_fix_start_time,$address,$tel,$bank_info,$total_point,$name_furi,$furikomi_type,$chief_allowance,
$transport_cost,$chief_allowance_start_time,$name_man,$login_auth_type,$password_man,
$team_id,$wait_select,$therapist_type,$wait_txt,
$therapist_id);

	//echo $sql;
	//exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(update_therapist_edit_man_4)";
		exit();

	}

	return true;
	exit();

}

function update_therapist_edit_man_relax(
$therapist_id,$mail,$name_real,$name_site,$kenmu,$rank,$name_aroma,$name_tgr,$name_lymph,$jitaku_taiki_flg,
$for_kobetsu_url,$kensyuu_flg,$jisou_flg,$point_ref,$guarantee_rule,$point_fix,$address,$tel,
$bank_info,$total_point,$name_furi,$furikomi_type,$chief_allowance,$transport_cost,
$chief_allowance_start_time,$name_man,$password_man,$login_auth_type,$point_fix_start_time,
$team_id,$wait_select,$wait_txt,$aroma_flg,$share_rate,$furikomi_fee){

	if( $aroma_flg == "1" ){

		$therapist_type = "2";

	}else{

		$therapist_type = "1";

	}

	if( $wait_select == "" ){

		$wait_select = "-1";

	}

	$rank_order_num = get_rank_order_num($rank);

	if( $jitaku_taiki_flg != "1" ){
		$jitaku_taiki_flg = 0;
	}

	if( $jisou_flg != "1" ){
		$jisou_flg = 0;
	}

	$kenmu_string = "";

	$kenmu_num = count($kenmu);

	if( $kenmu_num > 0 ){

		for($i=0;$i<$kenmu_num;$i++){

			$kenmu_string .= $kenmu[$i];

			if( $i != ($kenmu_num-1) ){

				$kenmu_string .= $kenmu_string.",";

			}

		}

	}

	$name_real = trim($name_real);
	$name_site = trim($name_site);
	$name_aroma = trim($name_aroma);

	$sql = sprintf("
update therapist_new set
name='%s',
mail='%s',
name_site='%s',
name_aroma='%s',
name_tgr='%s',
name_lymph='%s',
kenmu='%s',
rank='%s',
jitaku_taiki_flg='%s',
for_kobetsu_url='%s',
kensyuu_flg='%s',
jisou_flg='%s',
rank_order_num='%s',
point_ref='%s',
guarantee_rule='%s',
point_fix='%s',
point_fix_start_time='%s',
address='%s',
tel='%s',
bank_info='%s',
total_point='%s',
name_furi='%s',
furikomi_type='%s',
chief_allowance='%s',
transport_cost='%s',
chief_allowance_start_time='%s',
name_man='%s',
login_auth_type='%s',
password_man='%s',
team_id='%s',
wait_select='%s',
therapist_type='%s',
wait_txt='%s',
share_rate='%s',
furikomi_fee='%s'
where id='%s'",
$name_real,$mail,$name_site,$name_aroma,$name_tgr,$name_lymph,$kenmu_string,$rank,$jitaku_taiki_flg,
$for_kobetsu_url,$kensyuu_flg,$jisou_flg,$rank_order_num,$point_ref,$guarantee_rule,
$point_fix,$point_fix_start_time,$address,$tel,$bank_info,$total_point,$name_furi,$furikomi_type,$chief_allowance,
$transport_cost,$chief_allowance_start_time,$name_man,$login_auth_type,$password_man,
$team_id,$wait_select,$therapist_type,$wait_txt,$share_rate,$furikomi_fee,
$therapist_id);

	//echo $sql;
	//exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(update_therapist_edit_man_relax)";
		exit();

	}

	return true;
	exit();

}

function send_mail_day_report_approval_man($staff_id,$attendance_staff_2_id){

	$data = get_staff_data_by_id_common($staff_id);

	$staff_mail = $data["mail"];
	$staff_name = $data["name"];

	$data = get_attendance_staff_2_by_id_common($attendance_staff_2_id);

	$start_hour = $data["start_hour_d"];
	$start_minute = add_zero_when_under_ten_common($data["start_minute_d"]);
	$end_hour = $data["end_hour_d"];
	$end_minute = add_zero_when_under_ten_common($data["end_minute_d"]);
	$car_distance = $data["car_distance_d"];
	$highway = number_format($data["highway_d"]);
	$parking = number_format($data["parking_d"]);
	$pay_finish = number_format($data["pay_finish_d"]);
	$attendance_staff_new_id = $data["attendance_staff_new_id"];

	$data = get_attendance_staff_new_data_by_attendance_id_common($attendance_staff_new_id);

	$year = $data["year"];
	$month = $data["month"];
	$day = $data["day"];

	$title = sprintf("[業務開始・締め処理の承認][%sさん]",$staff_name);

$content =<<<EOT

{$staff_name}さん

以下の業務開始・締め処理が承認されました。

{$year}年{$month}月{$day}日

開始：{$start_hour}時{$start_minute}分
終了：{$end_hour}時{$end_minute}分
距離： {$car_distance}km
高速代：{$highway} 円
駐車場代： {$parking}円
精算済み： {$pay_finish}円

EOT;

	//メール送信
	mb_language("ja");
	mb_internal_encoding("UTF-8");
	$mailto = $staff_mail;

	$header = "From: info@neo-gate.jp\n";
	//$header .= "Bcc: minamikawa@neo-gate.jp";

	mb_send_mail($mailto,$title,$content,$header,MAIL_PARAMETER);

	return true;
	exit();

}

function get_therapist_data_for_reservation_status_board_wait_2($year,$month,$day,$wait_select){

	$area = "tokyo";

	// 出勤しているセラピスト情報を取得するためのSQL文

	$sql = sprintf("
select *,attendance_new.id as attendance_id from attendance_new
left join therapist_new on attendance_new.therapist_id=therapist_new.id
where
therapist_new.delete_flg=0 and
therapist_new.leave_flg=0 and
therapist_new.test_flg=0 and
therapist_new.wait_select='%s' and
therapist_new.therapist_type='1' and
attendance_new.year='%s' and
attendance_new.month='%s' and
attendance_new.day='%s' and
attendance_new.today_absence='0' and
attendance_new.kekkin_flg='0' and
(attendance_new.area='%s' or attendance_new.area='%s' or attendance_new.area='%s')
order by therapist_new.rank_order_num asc,therapist_new.order_num desc",
$wait_select,$year,$month,$day,$area,$area."_reraku",$area."_bigao");

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_therapist_data_for_reservation_status_board_wait_2)";
		exit();
	}

	$data = array();

	$i=0;

	while($row = mysql_fetch_assoc($res)){

		$therapist_id = $row["therapist_id"];

		//therapist_id重複チェック
		$result = check_duplication_therapist_id_in_attendance_new($data,$therapist_id);

		if( $result == false ){

			$data[$i] = $row;

			$attendance_id = $data[$i]["attendance_id"];

			$data[$i]["area"] = $area;
			if($row["area"]==$area."_reraku"){
				$data[$i]["area"] .= "_reraku";
			}
			else if($row["area"]==$area."_bigao"){
				$data[$i]["area"] .= "_bigao";
			}

			$sql = sprintf("select time from reservation_new where attendance_id='%s'",$attendance_id);

			$res2 = mysql_query($sql, DbCon);
			if($res == false){
				echo "error!(get_therapist_data_for_reservation_status_board_wait_2)";
				exit();
			}

			$j=0;
			while($row2 = mysql_fetch_assoc($res2)){
				$data[$i]["time"][$j] = $row2["time"];
				$time_num = count($data[$i]["time"]);
				$data[$i]["time_num"] = $time_num;
				$j++;
			}
			if($j==0){
				$data[$i]["time_num"]=0;
			}

			$i++;

		}

	}

	//以下、アロマ専属

	$sql = sprintf("
select *,attendance_new.id as attendance_id from attendance_new
left join therapist_new on attendance_new.therapist_id=therapist_new.id
where
therapist_new.delete_flg=0 and
therapist_new.leave_flg=0 and
therapist_new.test_flg=0 and
therapist_new.wait_select='%s' and
therapist_new.therapist_type='2' and
attendance_new.syounin_state='1' and
attendance_new.year='%s' and
attendance_new.month='%s' and
attendance_new.day='%s' and
attendance_new.today_absence='0' and
attendance_new.kekkin_flg='0' and
attendance_new.area='%s'
order by therapist_new.rank_order_num asc,therapist_new.order_num desc",
$wait_select,$year,$month,$day,$area);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_therapist_data_for_reservation_status_board_wait_2)";
		exit();
	}

	while($row = mysql_fetch_assoc($res)){

		$therapist_id = $row["therapist_id"];

		//therapist_id重複チェック
		$result = check_duplication_therapist_id_in_attendance_new($data,$therapist_id);

		if( $result == false ){

			$data[$i] = $row;

			$attendance_id = $data[$i]["attendance_id"];

			$data[$i]["area"] = $area;

			$sql = sprintf("select time from reservation_new where attendance_id='%s'",$attendance_id);

			$res2 = mysql_query($sql, DbCon);
			if($res == false){
				echo "error!(get_therapist_data_for_reservation_status_board_wait_2)";
				exit();
			}

			$j=0;
			while($row2 = mysql_fetch_assoc($res2)){
				$data[$i]["time"][$j] = $row2["time"];
				$time_num = count($data[$i]["time"]);
				$data[$i]["time_num"] = $time_num;
				$j++;
			}
			if($j==0){
				$data[$i]["time_num"]=0;
			}

			$i++;

		}

	}

	return $data;
	exit();

}

function get_therapist_data_for_reservation_status_board_wait_2_yokohama($year,$month,$day,$wait_select){

	$area = "yokohama";

	// 出勤しているセラピスト情報を取得するためのSQL文

	$sql = sprintf("
select *,attendance_new.id as attendance_id from attendance_new
left join therapist_new on attendance_new.therapist_id=therapist_new.id
where
therapist_new.delete_flg=0 and
therapist_new.leave_flg=0 and
therapist_new.test_flg=0 and
therapist_new.wait_select='%s' and
therapist_new.therapist_type='1' and
attendance_new.year='%s' and
attendance_new.month='%s' and
attendance_new.day='%s' and
attendance_new.today_absence='0' and
attendance_new.kekkin_flg='0' and
(attendance_new.area='%s' or attendance_new.area='%s' or attendance_new.area='%s')
order by attendance_new.jitaku_taiki_flg_2 desc,therapist_new.rank_order_num asc,therapist_new.order_num desc",
$wait_select,$year,$month,$day,$area,$area."_reraku",$area."_bigao");

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_therapist_data_for_reservation_status_board_wait_2_yokohama)";
		exit();
	}

	$data = array();

	$i=0;

	while($row = mysql_fetch_assoc($res)){

		$therapist_id = $row["therapist_id"];

		//therapist_id重複チェック
		$result = check_duplication_therapist_id_in_attendance_new($data,$therapist_id);

		if( $result == false ){

			$data[$i] = $row;

			$attendance_id = $data[$i]["attendance_id"];

			$data[$i]["area"] = $area;
			if($row["area"]==$area."_reraku"){
				$data[$i]["area"] .= "_reraku";
			}
			else if($row["area"]==$area."_bigao"){
				$data[$i]["area"] .= "_bigao";
			}

			$sql = sprintf("select time from reservation_new where attendance_id='%s'",$attendance_id);

			$res2 = mysql_query($sql, DbCon);
			if($res == false){
				echo "error!(get_therapist_data_for_reservation_status_board_wait_2_yokohama)";
				exit();
			}

			$j=0;
			while($row2 = mysql_fetch_assoc($res2)){
				$data[$i]["time"][$j] = $row2["time"];
				$time_num = count($data[$i]["time"]);
				$data[$i]["time_num"] = $time_num;
				$j++;
			}
			if($j==0){
				$data[$i]["time_num"]=0;
			}

			$i++;

		}

	}

	//以下、アロマ専属

	$sql = sprintf("
select *,attendance_new.id as attendance_id from attendance_new
left join therapist_new on attendance_new.therapist_id=therapist_new.id
where
therapist_new.delete_flg=0 and
therapist_new.leave_flg=0 and
therapist_new.test_flg=0 and
therapist_new.wait_select='%s' and
therapist_new.therapist_type='2' and
attendance_new.syounin_state='1' and
attendance_new.year='%s' and
attendance_new.month='%s' and
attendance_new.day='%s' and
attendance_new.today_absence='0' and
attendance_new.kekkin_flg='0' and
attendance_new.area='%s'
order by therapist_new.rank_order_num asc,therapist_new.order_num desc",
$wait_select,$year,$month,$day,$area);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_therapist_data_for_reservation_status_board_wait_2_yokohama)";
		exit();
	}

	while($row = mysql_fetch_assoc($res)){

		$therapist_id = $row["therapist_id"];

		//therapist_id重複チェック
		$result = check_duplication_therapist_id_in_attendance_new($data,$therapist_id);

		if( $result == false ){

			$data[$i] = $row;

			$attendance_id = $data[$i]["attendance_id"];

			$data[$i]["area"] = $area;

			$sql = sprintf("select time from reservation_new where attendance_id='%s'",$attendance_id);

			$res2 = mysql_query($sql, DbCon);
			if($res == false){
				echo "error!(get_therapist_data_for_reservation_status_board_wait_2_yokohama)";
				exit();
			}

			$j=0;
			while($row2 = mysql_fetch_assoc($res2)){
				$data[$i]["time"][$j] = $row2["time"];
				$time_num = count($data[$i]["time"]);
				$data[$i]["time_num"] = $time_num;
				$j++;
			}
			if($j==0){
				$data[$i]["time_num"]=0;
			}

			$i++;

		}

	}

	return $data;
	exit();

}

function get_therapist_data_for_reservation_status_board_wait_2_sendai($year,$month,$day,$wait_select){

	$area = "sendai";

	// 出勤しているセラピスト情報を取得するためのSQL文

	$sql = sprintf("
select *,attendance_new.id as attendance_id from attendance_new
left join therapist_new on attendance_new.therapist_id=therapist_new.id
where
therapist_new.delete_flg=0 and
therapist_new.leave_flg=0 and
therapist_new.test_flg=0 and
therapist_new.wait_select='%s' and
therapist_new.therapist_type='1' and
attendance_new.year='%s' and
attendance_new.month='%s' and
attendance_new.day='%s' and
attendance_new.today_absence='0' and
attendance_new.kekkin_flg='0' and
(attendance_new.area='%s' or attendance_new.area='%s' or attendance_new.area='%s')
order by attendance_new.jitaku_taiki_flg_2 desc,therapist_new.rank_order_num asc,therapist_new.order_num desc",
$wait_select,$year,$month,$day,$area,$area."_reraku",$area."_bigao");

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_therapist_data_for_reservation_status_board_wait_2_yokohama)";
		exit();
	}

	$data = array();

	$i=0;

	while($row = mysql_fetch_assoc($res)){

		$therapist_id = $row["therapist_id"];

		//therapist_id重複チェック
		$result = check_duplication_therapist_id_in_attendance_new($data,$therapist_id);

		if( $result == false ){

			$data[$i] = $row;

			$attendance_id = $data[$i]["attendance_id"];

			$data[$i]["area"] = $area;
			if($row["area"]==$area."_reraku"){
				$data[$i]["area"] .= "_reraku";
			}
			else if($row["area"]==$area."_bigao"){
				$data[$i]["area"] .= "_bigao";
			}

			$sql = sprintf("select time from reservation_new where attendance_id='%s'",$attendance_id);

			$res2 = mysql_query($sql, DbCon);
			if($res == false){
				echo "error!(get_therapist_data_for_reservation_status_board_wait_2_sendai)";
				exit();
			}

			$j=0;
			while($row2 = mysql_fetch_assoc($res2)){
				$data[$i]["time"][$j] = $row2["time"];
				$time_num = count($data[$i]["time"]);
				$data[$i]["time_num"] = $time_num;
				$j++;
			}
			if($j==0){
				$data[$i]["time_num"]=0;
			}

			$i++;

		}

	}

	//以下、アロマ専属

	$sql = sprintf("
select *,attendance_new.id as attendance_id from attendance_new
left join therapist_new on attendance_new.therapist_id=therapist_new.id
where
therapist_new.delete_flg=0 and
therapist_new.leave_flg=0 and
therapist_new.test_flg=0 and
therapist_new.wait_select='%s' and
therapist_new.therapist_type='2' and
attendance_new.syounin_state='1' and
attendance_new.year='%s' and
attendance_new.month='%s' and
attendance_new.day='%s' and
attendance_new.today_absence='0' and
attendance_new.kekkin_flg='0' and
attendance_new.area='%s'
order by therapist_new.rank_order_num asc,therapist_new.order_num desc",
$wait_select,$year,$month,$day,$area);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_therapist_data_for_reservation_status_board_wait_2_sendai)";
		exit();
	}

	while($row = mysql_fetch_assoc($res)){

		$therapist_id = $row["therapist_id"];

		//therapist_id重複チェック
		$result = check_duplication_therapist_id_in_attendance_new($data,$therapist_id);

		if( $result == false ){

			$data[$i] = $row;

			$attendance_id = $data[$i]["attendance_id"];

			$data[$i]["area"] = $area;

			$sql = sprintf("select time from reservation_new where attendance_id='%s'",$attendance_id);

			$res2 = mysql_query($sql, DbCon);
			if($res == false){
				echo "error!(get_therapist_data_for_reservation_status_board_wait_2_sendai)";
				exit();
			}

			$j=0;
			while($row2 = mysql_fetch_assoc($res2)){
				$data[$i]["time"][$j] = $row2["time"];
				$time_num = count($data[$i]["time"]);
				$data[$i]["time_num"] = $time_num;
				$j++;
			}
			if($j==0){
				$data[$i]["time_num"]=0;
			}

			$i++;

		}

	}

	return $data;
	exit();

}

function get_unit_price_by_car_distance($car_distance){
	return get_unit_price_by_car_distance_common($car_distance);	//距離別単価取得
}

function sale_driver_send_pdf(
$attendance_id,$driver_id,$year,$month,$day,$area,$start_hour,$start_minute,$end_hour,$end_minute,$work_time,
$remuneration){

	$start_minute = add_zero_when_under_ten_common($start_minute);
	$end_minute = add_zero_when_under_ten_common($end_minute);

	$data = get_staff_data_by_id_common($driver_id);
	$staff_name = $data["name"];
	$pay_hour = $data["pay_hour"];

	$staff_name_output = $staff_name;

	$pay_hour = number_format($pay_hour);

	$area_name = get_area_name_by_area_common($area);

	$site_name = $area_name."リフレ";

	$doc_title = "支払い明細書";
	$doc_day = sprintf("　　%s年%s月%s日",$year,$month,$day);
	$top_message1 = sprintf("%s　送迎ドライバー手当ての日当を",$site_name);
	$top_message2 = "下記の通りお支払い申し上げます。";
	$top_koumoku1 = "氏名";
	$top_koumoku2 = "拘束時間";
	$top_koumoku3 = "業務時間";
	$top_koumoku4 = "時給";
	$top_koumoku1_content = sprintf("%s　様",$staff_name);
	$top_koumoku2_content = sprintf("%s:%s～%s:%s",$start_hour,$start_minute,$end_hour,$end_minute);
	$top_koumoku3_content = $work_time."h";
	$top_koumoku4_content = $pay_hour."円";
	$table_koumoku1 = "日付";
	$table_koumoku2 = "項目";
	$table_koumoku3 = "単位";
	$table_koumoku4 = "単価";
	$table_koumoku5 = "金額";
	$table_koumoku1_sample = sprintf("%s月%s日　",$month,$day);
	$table_koumoku2_sample = "　送迎ドライバー業務日当";
	$table_koumoku3_sample = $work_time;
	$table_koumoku4_sample = $pay_hour;
	$table_koumoku5_sample = $remuneration."　";
	$goukei = "合計";
	$goukei_sample = $remuneration;
	$bottom_message1 = "株式会社スキップボート様";
	$bottom_message2 = "上記のとおり、確認、領収いたしました。";
	$bottom_message2 .= "　　　　　　　　　　サイン";
	$bottom_message3 = "平成　　　　年　　　　月　　　　日";
	$bottom_message4 = "　　　　　　　　　　　　　　　　　　　　印";

	$doc_title = mb_convert_encoding($doc_title, "SJIS", "UTF-8");
	$doc_day = mb_convert_encoding($doc_day, "SJIS", "UTF-8");
	$top_message1 = mb_convert_encoding($top_message1, "SJIS", "UTF-8");
	$top_message2 = mb_convert_encoding($top_message2, "SJIS", "UTF-8");
	$top_koumoku1 = mb_convert_encoding($top_koumoku1, "SJIS", "UTF-8");
	$top_koumoku2 = mb_convert_encoding($top_koumoku2, "SJIS", "UTF-8");
	$top_koumoku3 = mb_convert_encoding($top_koumoku3, "SJIS", "UTF-8");
	$top_koumoku4 = mb_convert_encoding($top_koumoku4, "SJIS", "UTF-8");
	$top_koumoku1_content = mb_convert_encoding($top_koumoku1_content, "SJIS", "UTF-8");
	$top_koumoku2_content = mb_convert_encoding($top_koumoku2_content, "SJIS", "UTF-8");
	$top_koumoku3_content = mb_convert_encoding($top_koumoku3_content, "SJIS", "UTF-8");
	$top_koumoku4_content = mb_convert_encoding($top_koumoku4_content, "SJIS", "UTF-8");
	$table_koumoku1 = mb_convert_encoding($table_koumoku1, "SJIS", "UTF-8");
	$table_koumoku2 = mb_convert_encoding($table_koumoku2, "SJIS", "UTF-8");
	$table_koumoku3 = mb_convert_encoding($table_koumoku3, "SJIS", "UTF-8");
	$table_koumoku4 = mb_convert_encoding($table_koumoku4, "SJIS", "UTF-8");
	$table_koumoku5 = mb_convert_encoding($table_koumoku5, "SJIS", "UTF-8");
	$table_koumoku1_sample = mb_convert_encoding($table_koumoku1_sample, "SJIS", "UTF-8");
	$table_koumoku2_sample = mb_convert_encoding($table_koumoku2_sample, "SJIS", "UTF-8");
	$table_koumoku3_sample = mb_convert_encoding($table_koumoku3_sample, "SJIS", "UTF-8");
	$table_koumoku4_sample = mb_convert_encoding($table_koumoku4_sample, "SJIS", "UTF-8");
	$table_koumoku5_sample = mb_convert_encoding($table_koumoku5_sample, "SJIS", "UTF-8");
	$goukei = mb_convert_encoding($goukei, "SJIS", "UTF-8");
	$goukei_sample = mb_convert_encoding($goukei_sample, "SJIS", "UTF-8");
	$bottom_message1 = mb_convert_encoding($bottom_message1, "SJIS", "UTF-8");
	$bottom_message2 = mb_convert_encoding($bottom_message2, "SJIS", "UTF-8");
	$bottom_message3 = mb_convert_encoding($bottom_message3, "SJIS", "UTF-8");
	$bottom_message4 = mb_convert_encoding($bottom_message4, "SJIS", "UTF-8");

	$pdf = new MBFPDF();
	$pdf->AddMBFont(GOTHIC ,'SJIS');
	$pdf->AddPage();

	/*
	 $doc_title = "支払い明細書";
	$doc_day = sprintf("%s年%s月%s日",$year,$month,$day);
	$top_message1 = sprintf("%s　送迎ドライバー手当ての日当を",$site_name);
	$top_message2 = "下記の通りお支払い申し上げます。";
	*/

	$pdf->SetFont(GOTHIC,'',12);

	$pdf->SetTextColor(255, 255, 255);
	$pdf->SetFillColor(128, 128, 128);

	$pdf->Cell(70, 10, "", 0);
	$pdf->Cell(50, 10, $doc_title, 0, 0, 'C', 1);
	$pdf->Ln();

	$pdf->SetTextColor(0, 0, 0);

	$pdf->Cell(70, 10, "", 0);
	$pdf->Cell(50, 10, $doc_day, 'B');
	$pdf->Ln();

	$pdf->Cell(150, 20, "", 0);
	$pdf->Cell(20, 20, "", 'RLTB');
	$pdf->Cell(20, 20, "", 'RTB');
	$pdf->Ln();

	$pdf->SetFont(GOTHIC,'',9);

	$pdf->Cell(190, 5, $top_message1, 0);
	$pdf->Ln();

	$pdf->Cell(190, 5, $top_message2, 0);
	$pdf->Ln();

	/*
	 $top_koumoku1 = "氏名";
	$top_koumoku2 = "拘束時間";
	$top_koumoku3 = "業務時間";
	$top_koumoku4 = "時給";
	$top_koumoku1_content = sprintf("%s　様",$staff_name);
	$top_koumoku2_content = "20:00～5:00";
	$top_koumoku3_content = "9.0h";
	$top_koumoku4_content = "1000円";
	*/

	$pdf->SetFont(GOTHIC,'',10);

	$pdf->Cell(47, 10, $top_koumoku1, 'RLT',0,"C");
	$pdf->Cell(47, 10, $top_koumoku2, 'RT',0,"C");
	$pdf->Cell(47, 10, $top_koumoku3, 'RT',0,"C");
	$pdf->Cell(49, 10, $top_koumoku4, 'RT',0,"C");
	$pdf->Ln();

	$pdf->Cell(47, 10, $top_koumoku1_content, 'RLTB',0,"C");
	$pdf->Cell(47, 10, $top_koumoku2_content, 'RTB',0,"C");
	$pdf->Cell(47, 10, $top_koumoku3_content, 'RTB',0,"C");
	$pdf->Cell(49, 10, $top_koumoku4_content, 'RTB',0,"C");
	$pdf->Ln(16);

	/*
	 $table_koumoku1 = "日付";
	$table_koumoku2 = "項目";
	$table_koumoku3 = "単位";
	$table_koumoku4 = "単価";
	$table_koumoku5 = "金額";
	$table_koumoku1_sample = "3月8日";
	$table_koumoku2_sample = "送迎ドライバー業務日当";
	$table_koumoku3_sample = "9.0";
	$table_koumoku4_sample = "1,000";
	$table_koumoku5_sample = "9,000";
	$goukei = "合計";
	$goukei_sample = "9,000";
	*/

	$pdf->Cell(28, 10, $table_koumoku1, 'RLTB',0,"C");
	$pdf->Cell(58, 10, $table_koumoku2, 'RTB',0,"C");
	$pdf->Cell(28, 10, $table_koumoku3, 'RTB',0,"C");
	$pdf->Cell(38, 10, $table_koumoku4, 'RTB',0,"C");
	$pdf->Cell(38, 10, $table_koumoku5, 'RTB',0,"C");
	$pdf->Ln();

	for($i=0;$i<6;$i++){

		if( $i == 0 ){

			$pdf->Cell(28, 10, $table_koumoku1_sample, 'RLB',0,"R");
			$pdf->Cell(58, 10, $table_koumoku2_sample, 'RB');
			$pdf->Cell(28, 10, $table_koumoku3_sample, 'RB',0,"C");
			$pdf->Cell(38, 10, $table_koumoku4_sample, 'RB',0,"C");
			$pdf->Cell(38, 10, $table_koumoku5_sample, 'RB',0,"R");
			$pdf->Ln();

		}else{

			$pdf->Cell(28, 10, "", 'RLB',0,"R");
			$pdf->Cell(58, 10, "", 'RB');
			$pdf->Cell(28, 10, "", 'RB',0,"C");
			$pdf->Cell(38, 10, "", 'RB',0,"C");
			$pdf->Cell(38, 10, "", 'RB',0,"R");
			$pdf->Ln();

		}

	}

	$pdf->Cell(28, 10, "", 'RLB');
	$pdf->Cell(58, 10, "", 'RB');
	$pdf->Cell(28, 10, "", 'RB');
	$pdf->Cell(38, 10, $goukei, 'RB',0,"C");
	$pdf->Cell(38, 10, $goukei_sample, 'RB',0,"C");
	$pdf->Ln();

	$pdf->Ln(14);

	$pdf->SetFont(GOTHIC,'',9);

	$pdf->Cell(190, 10, $bottom_message1, 'LTR');
	$pdf->Ln();

	$pdf->Cell(190, 4, $bottom_message2, 'LR');
	$pdf->Ln();

	$pdf->Cell(190, 6, "", 'LR');
	$pdf->Ln();

	$pdf->SetFont(GOTHIC,'',12);

	$pdf->Cell(90, 10, $bottom_message3, 'L');
	$pdf->Cell(95, 10, $bottom_message4, 'B');
	$pdf->Cell(5, 10, "", 'R');
	$pdf->Ln();

	$pdf->Cell(190, 6, "", 'LBR');
	$pdf->Ln();

	$file_name = sprintf("meisai(%s)(%s月%s日).pdf",$staff_name_output,$month,$day);

	//$pdf->Output();
	$pdf->Output($file_name, 'D');

	return true;
	exit();

}

function sale_driver_send_pdf_2(
$attendance_id,$driver_id,$year,$month,$day,$area,$start_hour,$start_minute,$end_hour,$end_minute,$work_time,
$remuneration){

	$data = get_attendance_staff_new_data_by_attendance_id_common($attendance_id);

	$car_distance = $data["car_distance"];

	$unit_price = get_unit_price_by_car_distance_common($car_distance);

	$start_minute = add_zero_when_under_ten_common($start_minute);
	$end_minute = add_zero_when_under_ten_common($end_minute);

	$data = get_staff_data_by_id_common($driver_id);
	$staff_name = $data["name"];
	$pay_hour = $data["pay_hour"];

	$staff_name_output = $staff_name;

	$pay_hour = number_format($pay_hour);

	$area_name = get_area_name_by_area_common($area);

	$site_name = $area_name."リフレ";

	$doc_title = "支払い明細書";
	$doc_day = sprintf("　　%s年%s月%s日",$year,$month,$day);
	$top_message1 = sprintf("%s　送迎ドライバー手当ての日当を",$site_name);
	$top_message2 = "下記の通りお支払い申し上げます。";
	$top_koumoku1 = "氏名";
	$top_koumoku2 = "拘束時間";
	$top_koumoku3 = "稼働距離";
	$top_koumoku4 = "報酬単価";
	$top_koumoku1_content = sprintf("%s　様",$staff_name);
	//$top_koumoku2_content = sprintf("%s:%s～%s:%s",$start_hour,$start_minute,$end_hour,$end_minute);
	$top_koumoku2_content = "";
	$top_koumoku3_content = $car_distance."km";
	$top_koumoku4_content = $unit_price."円";
	$table_koumoku1 = "日付";
	$table_koumoku2 = "項目";
	$table_koumoku3 = "単位";
	$table_koumoku4 = "単価";
	$table_koumoku5 = "金額";
	$table_koumoku1_sample = sprintf("%s月%s日　",$month,$day);
	$table_koumoku2_sample = "　送迎ドライバー業務日当";
	$table_koumoku3_sample = $car_distance;
	$table_koumoku4_sample = $unit_price;
	$table_koumoku5_sample = $remuneration."　";
	$goukei = "合計";
	$goukei_sample = $remuneration;
	$bottom_message1 = "株式会社スキップボート様";
	$bottom_message2 = "上記のとおり、確認、領収いたしました。";
	$bottom_message2 .= "　　　　　　　　　　サイン";
	$bottom_message3 = "平成　　　　年　　　　月　　　　日";
	$bottom_message4 = "　　　　　　　　　　　　　　　　　　　　印";

	$doc_title = mb_convert_encoding($doc_title, "SJIS", "UTF-8");
	$doc_day = mb_convert_encoding($doc_day, "SJIS", "UTF-8");
	$top_message1 = mb_convert_encoding($top_message1, "SJIS", "UTF-8");
	$top_message2 = mb_convert_encoding($top_message2, "SJIS", "UTF-8");
	$top_koumoku1 = mb_convert_encoding($top_koumoku1, "SJIS", "UTF-8");
	$top_koumoku2 = mb_convert_encoding($top_koumoku2, "SJIS", "UTF-8");
	$top_koumoku3 = mb_convert_encoding($top_koumoku3, "SJIS", "UTF-8");
	$top_koumoku4 = mb_convert_encoding($top_koumoku4, "SJIS", "UTF-8");
	$top_koumoku1_content = mb_convert_encoding($top_koumoku1_content, "SJIS", "UTF-8");
	$top_koumoku2_content = mb_convert_encoding($top_koumoku2_content, "SJIS", "UTF-8");
	$top_koumoku3_content = mb_convert_encoding($top_koumoku3_content, "SJIS", "UTF-8");
	$top_koumoku4_content = mb_convert_encoding($top_koumoku4_content, "SJIS", "UTF-8");
	$table_koumoku1 = mb_convert_encoding($table_koumoku1, "SJIS", "UTF-8");
	$table_koumoku2 = mb_convert_encoding($table_koumoku2, "SJIS", "UTF-8");
	$table_koumoku3 = mb_convert_encoding($table_koumoku3, "SJIS", "UTF-8");
	$table_koumoku4 = mb_convert_encoding($table_koumoku4, "SJIS", "UTF-8");
	$table_koumoku5 = mb_convert_encoding($table_koumoku5, "SJIS", "UTF-8");
	$table_koumoku1_sample = mb_convert_encoding($table_koumoku1_sample, "SJIS", "UTF-8");
	$table_koumoku2_sample = mb_convert_encoding($table_koumoku2_sample, "SJIS", "UTF-8");
	$table_koumoku3_sample = mb_convert_encoding($table_koumoku3_sample, "SJIS", "UTF-8");
	$table_koumoku4_sample = mb_convert_encoding($table_koumoku4_sample, "SJIS", "UTF-8");
	$table_koumoku5_sample = mb_convert_encoding($table_koumoku5_sample, "SJIS", "UTF-8");
	$goukei = mb_convert_encoding($goukei, "SJIS", "UTF-8");
	$goukei_sample = mb_convert_encoding($goukei_sample, "SJIS", "UTF-8");
	$bottom_message1 = mb_convert_encoding($bottom_message1, "SJIS", "UTF-8");
	$bottom_message2 = mb_convert_encoding($bottom_message2, "SJIS", "UTF-8");
	$bottom_message3 = mb_convert_encoding($bottom_message3, "SJIS", "UTF-8");
	$bottom_message4 = mb_convert_encoding($bottom_message4, "SJIS", "UTF-8");

	$pdf = new MBFPDF();
	$pdf->AddMBFont(GOTHIC ,'SJIS');
	$pdf->AddPage();

	$pdf->SetFont(GOTHIC,'',12);

	$pdf->SetTextColor(255, 255, 255);
	$pdf->SetFillColor(128, 128, 128);

	$pdf->Cell(70, 10, "", 0);
	$pdf->Cell(50, 10, $doc_title, 0, 0, 'C', 1);
	$pdf->Ln();

	$pdf->SetTextColor(0, 0, 0);

	$pdf->Cell(70, 10, "", 0);
	$pdf->Cell(50, 10, $doc_day, 'B');
	$pdf->Ln();

	$pdf->Cell(150, 20, "", 0);
	$pdf->Cell(20, 20, "", 'RLTB');
	$pdf->Cell(20, 20, "", 'RTB');
	$pdf->Ln();

	$pdf->SetFont(GOTHIC,'',9);

	$pdf->Cell(190, 5, $top_message1, 0);
	$pdf->Ln();

	$pdf->Cell(190, 5, $top_message2, 0);
	$pdf->Ln();

	$pdf->SetFont(GOTHIC,'',10);

	$pdf->Cell(47, 10, $top_koumoku1, 'RLT',0,"C");
	$pdf->Cell(47, 10, $top_koumoku2, 'RT',0,"C");
	$pdf->Cell(47, 10, $top_koumoku3, 'RT',0,"C");
	$pdf->Cell(49, 10, $top_koumoku4, 'RT',0,"C");
	$pdf->Ln();

	$pdf->Cell(47, 10, $top_koumoku1_content, 'RLTB',0,"C");
	$pdf->Cell(47, 10, $top_koumoku2_content, 'RTB',0,"C");
	$pdf->Cell(47, 10, $top_koumoku3_content, 'RTB',0,"C");
	$pdf->Cell(49, 10, $top_koumoku4_content, 'RTB',0,"C");
	$pdf->Ln(16);

	$pdf->Cell(28, 10, $table_koumoku1, 'RLTB',0,"C");
	$pdf->Cell(58, 10, $table_koumoku2, 'RTB',0,"C");
	$pdf->Cell(28, 10, $table_koumoku3, 'RTB',0,"C");
	$pdf->Cell(38, 10, $table_koumoku4, 'RTB',0,"C");
	$pdf->Cell(38, 10, $table_koumoku5, 'RTB',0,"C");
	$pdf->Ln();

	for($i=0;$i<6;$i++){

		if( $i == 0 ){

			$pdf->Cell(28, 10, $table_koumoku1_sample, 'RLB',0,"R");
			$pdf->Cell(58, 10, $table_koumoku2_sample, 'RB');
			$pdf->Cell(28, 10, $table_koumoku3_sample, 'RB',0,"C");
			$pdf->Cell(38, 10, $table_koumoku4_sample, 'RB',0,"C");
			$pdf->Cell(38, 10, $table_koumoku5_sample, 'RB',0,"R");
			$pdf->Ln();

		}else{

			$pdf->Cell(28, 10, "", 'RLB',0,"R");
			$pdf->Cell(58, 10, "", 'RB');
			$pdf->Cell(28, 10, "", 'RB',0,"C");
			$pdf->Cell(38, 10, "", 'RB',0,"C");
			$pdf->Cell(38, 10, "", 'RB',0,"R");
			$pdf->Ln();

		}

	}

	$pdf->Cell(28, 10, "", 'RLB');
	$pdf->Cell(58, 10, "", 'RB');
	$pdf->Cell(28, 10, "", 'RB');
	$pdf->Cell(38, 10, $goukei, 'RB',0,"C");
	$pdf->Cell(38, 10, $goukei_sample, 'RB',0,"C");
	$pdf->Ln();

	$pdf->Ln(14);

	$pdf->SetFont(GOTHIC,'',9);

	$pdf->Cell(190, 10, $bottom_message1, 'LTR');
	$pdf->Ln();

	$pdf->Cell(190, 4, $bottom_message2, 'LR');
	$pdf->Ln();

	$pdf->Cell(190, 6, "", 'LR');
	$pdf->Ln();

	$pdf->SetFont(GOTHIC,'',12);

	$pdf->Cell(90, 10, $bottom_message3, 'L');
	$pdf->Cell(95, 10, $bottom_message4, 'B');
	$pdf->Cell(5, 10, "", 'R');
	$pdf->Ln();

	$pdf->Cell(190, 6, "", 'LBR');
	$pdf->Ln();

	$file_name = sprintf("meisai(%s)(%s月%s日).pdf",$staff_name_output,$month,$day);

	//$pdf->Output();
	$pdf->Output($file_name, 'D');

	return true;
	exit();

}

function download_calendar_csv($year,$month,$area){

	$html = "";

	$last_day = get_last_day_common($year, $month);

	$tmp = "";

	$html .= "\"".$tmp."\"".",";

	for( $i=1; $i<=$last_day; $i++ ){

		$day = $i;

		$week = get_week_name_by_time_common($year, $month, $day);

		$tmp = sprintf("%s月%s日(%s)",$month,$day,$week);

		if( $i == $last_day ){

			$html .= "\"".$tmp."\""."\n";

		}else{

			$html .= "\"".$tmp."\"".",";

		}

	}

	$attendance_staff_new_month = get_attendance_staff_new_month_common($year,$month);

	$attendance_new_month = get_attendance_new_month_common($year,$month);

	if( $area == "tokyo" ){

		$tmp = "本部";
		$html .= "\"".$tmp."\"".",";

		for( $i=1; $i<=$last_day; $i++ ){

			$tmp = "";

			if( $i == $last_day ){

				$html .= "\"".$tmp."\""."\n";

			}else{

				$html .= "\"".$tmp."\"".",";

			}

		}

		$type="honbu";
		$honbu_data = get_staff_data_for_staff_calendar($type,$area);
		$honbu_data_num = count($honbu_data);

		for($i=0;$i<$honbu_data_num;$i++){

			$staff_id = $honbu_data[$i]["id"];
			$name = $honbu_data[$i]["name"];

			$tmp = $name;
			$html .= "\"".$tmp."\"".",";

			for( $j=1; $j<=$last_day; $j++ ){

				$day = $j;

				//$attendance_data = get_attendance_staff_new_day_and_staff_id_2_common($year,$month,$day,$staff_id);
				$attendance_data = get_attendance_data_from_month_data_staff_common(
$year,$month,$day,$staff_id,$attendance_staff_new_month);

				$today_absence = $attendance_data["today_absence"];
				$kekkin_flg = $attendance_data["kekkin_flg"];
				$syounin_state = $attendance_data["syounin_state"];

				$start_time = $attendance_data["start_time"];
				$end_time = $attendance_data["end_time"];

				if( $today_absence == "1" ){

					$tmp = "当欠";

				}else if( $kekkin_flg == "1" ){

					$tmp = "欠勤";

				}else if( $syounin_state == "1" ){

					$tmp = get_attendance_disp_time_honbu($start_time,$end_time);

					$tmp = str_replace("-","ー",$tmp);

				}else{

					$tmp = "";

				}

				if( $j == $last_day ){

					$html .= "\"".$tmp."\""."\n";

				}else{

					$html .= "\"".$tmp."\"".",";

				}

			}

		}

		$tmp = "";
		$html .= "\"".$tmp."\"".",";

		for( $i=1; $i<=$last_day; $i++ ){

			$tmp = "";

			if( $i == $last_day ){

				$html .= "\"".$tmp."\""."\n";

			}else{

				$html .= "\"".$tmp."\"".",";

			}

		}

	}

	$tmp = "ドライバー";
	$html .= "\"".$tmp."\"".",";

	for( $i=1; $i<=$last_day; $i++ ){

		$tmp = "";

		if( $i == $last_day ){

			$html .= "\"".$tmp."\""."\n";

		}else{

			$html .= "\"".$tmp."\"".",";

		}

	}

	$type = "driver";
	$driver_data = get_staff_data_for_staff_calendar($type,$area);
	$driver_data_num = count($driver_data);

	for($i=0;$i<$driver_data_num;$i++){

		$staff_id = $driver_data[$i]["id"];
		$name = $driver_data[$i]["name"];

		$tmp = $name;
		$html .= "\"".$tmp."\"".",";

		for( $j=1; $j<=$last_day; $j++ ){

			$day = $j;

			//$attendance_data = get_attendance_staff_new_day_and_staff_id_2_common($year,$month,$day,$staff_id);
			$attendance_data = get_attendance_data_from_month_data_staff_common(
$year,$month,$day,$staff_id,$attendance_staff_new_month);

			$today_absence = $attendance_data["today_absence"];
			$kekkin_flg = $attendance_data["kekkin_flg"];
			$syounin_state = $attendance_data["syounin_state"];

			$start_time = $attendance_data["start_time"];
			$end_time = $attendance_data["end_time"];

			if( $today_absence == "1" ){

				$tmp = "当欠";

			}else if( $kekkin_flg == "1" ){

				$tmp = "欠勤";

			}else if( $syounin_state == "1" ){

				$tmp = get_attendance_disp_time_driver($start_time,$end_time);

				$tmp = str_replace("-","ー",$tmp);

			}else{

				$tmp = "";

			}

			if( $j == $last_day ){

				$html .= "\"".$tmp."\""."\n";

			}else{

				$html .= "\"".$tmp."\"".",";

			}

		}

	}

	$tmp = "";
	$html .= "\"".$tmp."\"".",";

	for( $i=1; $i<=$last_day; $i++ ){

		$tmp = "";

		if( $i == $last_day ){

			$html .= "\"".$tmp."\""."\n";

		}else{

			$html .= "\"".$tmp."\"".",";

		}

	}

	$tmp = "セラピスト";
	$html .= "\"".$tmp."\"".",";

	for( $i=1; $i<=$last_day; $i++ ){

		$tmp = "";

		if( $i == $last_day ){

			$html .= "\"".$tmp."\""."\n";

		}else{

			$html .= "\"".$tmp."\"".",";

		}

	}

	$past_flg = false;
	$therapist_data = get_therapist_data_for_therapist_calendar($area,$past_flg);
	$therapist_data_num = count($therapist_data);

	for($i=0;$i<$therapist_data_num;$i++){

		$therapist_id = $therapist_data[$i]["id"];
		$name = $therapist_data[$i]["name"];

		$tmp = $name;
		$html .= "\"".$tmp."\"".",";

		for( $j=1; $j<=$last_day; $j++ ){

			$day = $j;

			//$attendance_data = get_attendance_new_by_day_and_therapist_id_common($therapist_id, $year, $month, $day);
			$attendance_data = get_attendance_data_from_month_data_therapist_common(
$year,$month,$day,$therapist_id,$attendance_new_month);

			$today_absence = $attendance_data["today_absence"];
			$kekkin_flg = $attendance_data["kekkin_flg"];
			$syounin_state = $attendance_data["syounin_state"];

			$start_time = $attendance_data["start_time"];
			$end_time = $attendance_data["end_time"];

			if( $today_absence == "1" ){

				$tmp = "当欠";

			}else if( $kekkin_flg == "1" ){

				$tmp = "欠勤";

			}else if( $syounin_state == "1" ){

				$syounin_state = "0";
				$tmp = get_attendance_disp_time_therapist($start_time,$end_time,$syounin_state);

				$tmp = str_replace("-","ー",$tmp);

			}else{

				$tmp = "";

			}

			if( $j == $last_day ){

				$html .= "\"".$tmp."\""."\n";

			}else{

				$html .= "\"".$tmp."\"".",";

			}

		}

	}

	return $html;
	exit();

}

function get_therapist_checkbox_for_man_attendance_request($therapist_data,$therapist_id_array){

	$html = "";

	$therapist_data_num = count($therapist_data);

	for( $i=0; $i<$therapist_data_num; $i++ ){

		$id = $therapist_data[$i]["id"];
		$name = $therapist_data[$i]["name"];

		$result = check_exist_therapist_id_array($therapist_id_array,$id);

		$tmp = "";

		if( $result == true ){

			$tmp = "checked ";

		}

$html .= '<div style="padding:10px;">';
$html .= '<span><input type="checkbox" name="therapist_id[]" value="'.$id.'" class="attendance_request_checkbox" '.$tmp.'/></span>';
$html .= '<span style="padding-left:5px;">'.$name.'</span>';
$html .= '</div>';

	}

	return $html;
	exit();

}

function check_exist_therapist_id_array($therapist_id_array,$id){

	$therapist_id_array_num = count($therapist_id_array);

	for( $i=0; $i<$therapist_id_array_num; $i++ ){

		$id_tmp = $therapist_id_array[$i];

		if( $id == $id_tmp ){

			return true;
			exit();

		}

	}

	return false;
	exit();

}

function get_therapist_list_html_man_attendance_request($therapist_id_array){

	$html = "";

	$html .= '<div class="attendance_request_therapist_list_man_confirm">';

	$therapist_id_array_num = count($therapist_id_array);

	if( $therapist_id_array_num == 0 ){

		$html .= '<div class="one">なし</div>';

	}else{

		for( $i=0; $i<$therapist_id_array_num; $i++ ){

			$id = $therapist_id_array[$i];

			$therapist_name = get_therapist_name_by_therapist_id_honmyou_common($id);

			$html .= '<div class="one">';
			$html .= $therapist_name;
			$html .= '</div>';

		}

	}

	$html .= '</div>';

	return $html;
	exit();

}

function get_therapist_list_not_send_html_man_attendance_request(
$therapist_id_array,$year,$month,$day,$area){

	$therapist_data = get_attendance_request_therapist($year,$month,$day,$area);

	$therapist_data_num = count($therapist_data);

	$x = 0;
	$therapist_data_2 = array();

	for( $i=0; $i<$therapist_data_num; $i++ ){

		$id = $therapist_data[$i]["id"];

		$result = check_exist_therapist_id_array($therapist_id_array,$id);

		if( $result != true ){

			$therapist_data_2[$x] = $therapist_data[$i];
			$x++;

		}

	}

	$html = "";

	$html .= '<div class="attendance_request_therapist_list_man_confirm">';

	$therapist_data_2_num = count($therapist_data_2);

	if( $therapist_data_2_num == 0 ){

		$html .= '<div class="one">なし</div>';

	}else{

		for( $i=0; $i<$therapist_data_2_num; $i++ ){

			$name = $therapist_data_2[$i]["name"];

			$html .= '<div class="one">';
			$html .= $name;
			$html .= '</div>';

		}

	}

	$html .= '</div>';

	return $html;
	exit();

}

function get_mail_send_therapist_data_for_man_attendance_request($year,$month,$day,$area,$therapist_id_array){

	$therapist_data = get_attendance_request_therapist($year,$month,$day,$area);

	$therapist_data_num = count($therapist_data);

	$x = 0;
	$y = 0;
	$therapist_send = array();
	$therapist_send_not = array();

	for( $i=0; $i<$therapist_data_num; $i++ ){

		$id = $therapist_data[$i]["id"];

		$result = check_exist_therapist_id_array($therapist_id_array,$id);

		if( $result == true ){

			$therapist_send_not[$x] = $therapist_data[$i];
			$x++;

		}else{

			$therapist_send[$y] = $therapist_data[$i];
			$y++;

		}

	}

	$data["therapist_send_not"] = $therapist_send_not;
	$data["therapist_send"] = $therapist_send;

	return $data;
	exit();

}

function get_therapist_list_html_man_attendance_request_2($therapist_data){

	$html = "";

	$html .= '<div class="attendance_request_therapist_list_man_confirm">';

	$therapist_data_num = count($therapist_data);

	if( $therapist_data_num == 0 ){

		$html .= '<div class="one">なし</div>';

	}else{

		for( $i=0; $i<$therapist_data_num; $i++ ){

			$therapist_name = $therapist_data[$i]["name"];

			$html .= '<div class="one">';
			$html .= $therapist_name;
			$html .= '</div>';

		}

	}

	$html .= '</div>';

	return $html;
	exit();

}

function send_attendance_request_mail_2($year,$month,$day,$area,$therapist_data){

	$result = insert_attendance_request_data($year,$month,$day,$area);

	if( $result == false ){

		return false;
		exit();

	}

	$therapist_data_num = count($therapist_data);

	$week_value = get_week_value($year,$month,$day);
	$week_name = get_week_name($week_value);

	mb_language("ja");
	mb_internal_encoding("UTF-8");

	$header = "From: info@neo-gate.jp\n";
	$header .= "Bcc: info@neo-gate.jp";
	//$header .= "Bcc: minamikawa@neo-gate.jp";

	$title = sprintf("【シフト登録】%s月%s日（%s）出勤要請メール",$month,$day,$week_name);

	for( $i=0; $i<$therapist_data_num; $i++ ){

		$therapist_id = $therapist_data[$i]["id"];
		$area = $therapist_data[$i]["area"];
		$mail = $therapist_data[$i]["mail"];

		$therapist_name = $therapist_data[$i]["name"];

		$check_url = get_check_url_shift_front($area,$therapist_id);

		//$mailto = "minamikawa@neo-gate.jp";
		$mailto = $mail;

		$content =<<<EOT
{$therapist_name}さん

お疲れ様です。
いつも出勤ありがとうございます。
日程調整をしてのシフトを組んでいただいておりますが
{$month}月{$day}日({$week_name})は出勤セラピストが少ないので
出勤をお願いできませんか？

出勤できましたらよろしくお願いします。
〇シフトの追加・編集はこちらから
{$check_url}

EOT;

$result = mb_send_mail($mailto,$title,$content,$header,MAIL_PARAMETER);

if( $result == false ){

	return false;
	exit();

}

	}

	return true;
	exit();

}

function get_calendar_disp_flg_select($calendar_disp_flg){

	$html = '<select name="calendar_disp_flg">';

	if( $calendar_disp_flg == "0" ){
		$html .= '<option value="0" selected>表示しない</option>';
		$html .= '<option value="1">表示する</option>';
	}elseif( $calendar_disp_flg == "1" ){
		$html .= '<option value="0">表示しない</option>';
		$html .= '<option value="1" selected>表示する</option>';
	}else{
		$html .= '<option value="0">表示しない</option>';
		$html .= '<option value="1" selected>表示する</option>';
	}

	$html .= '</select>';

	return $html;
	exit();

}

function get_select_transfer_commission($select_value){

	$menu = array(
		0 => array("value"=>"1","word"=>"なし"),
		1 => array("value"=>"2","word"=>"270円")
	);

	$select_frm_name = "transfer_commission";

	$html = get_select_frm_common($select_value,$select_frm_name,$menu);

	return $html;
	exit();

}

function get_select_insurance($select_value){

	include(COMMON_INC."menu.php");

	$select_frm_name = "insurance";

	$html = get_select_frm_common($select_value,$select_frm_name,$menu_insurance);

	return $html;
	exit();

}

function get_select_insurance_2($select_value,$select_frm_name){

	include(COMMON_INC."menu.php");

	$html = get_select_frm_common($select_value,$select_frm_name,$menu_insurance);

	return $html;
	exit();

}

function get_transfer_commission_disp($transfer_commission){

	$data = "不明";

	if( $transfer_commission == "1" ){

		$data = "なし";

	}else if( $transfer_commission == "2" ){

		$data = "270円";

	}

	return $data;
	exit();

}

function get_insurance_disp($insurance){

	$data = "不明";

	if( $insurance == "1" ){

		$data = "未確認";

	}else if( $insurance == "2" ){

		$data = "50円保険";

	}else if( $insurance == "3" ){

		$data = "任意保険加入";

	}else if( $insurance == "4" ){

		$data = "保険未加入";

	}

	return $data;
	exit();

}

function insert_therapist_data_2(
$name_real,$mail,$name_site,$name_aroma,$name_tgr,$name_lymph,$area,$kenmu_string,$rank,$jitaku_taiki_flg,
$for_kobetsu_url,$kensyuu_flg,$jisou_flg,$point_ref,$guarantee_rule,$address,$tel,
$bank_info,$name_furi,$furikomi_type,$transfer_commission,$share_rate,$payment_span,$tax_flg){

	$rank_order_num = get_rank_order_num($rank);

	if( $jitaku_taiki_flg != "1" ){
		$jitaku_taiki_flg = 0;
	}

	if( $jisou_flg != "1" ){
		$jisou_flg = 0;
	}

	$name_real = trim($name_real);
	$name_site = trim($name_site);
	$name_aroma = trim($name_aroma);

// 会員情報を登録するSQL文
$sql = sprintf("
insert into therapist_new(
name,mail,name_site,name_aroma,name_tgr,name_lymph,area,kenmu,rank,jitaku_taiki_flg,for_kobetsu_url,
kensyuu_flg,jisou_flg,rank_order_num,point_ref,guarantee_rule,address,tel,
bank_info,name_furi,furikomi_type,transfer_commission,share_rate,payment_span,tax_flg)
values('%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s',
'%s','%s','%s','%s','%s','%s','%s','%s','%s')"
,$name_real,$mail,$name_site,$name_aroma,$name_tgr,$name_lymph,$area,$kenmu_string,$rank,$jitaku_taiki_flg,
$for_kobetsu_url,$kensyuu_flg,$jisou_flg,$rank_order_num,$point_ref,$guarantee_rule,
$address,$tel,$bank_info,$name_furi,$furikomi_type,$transfer_commission,$share_rate,$payment_span,$tax_flg);

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "クエリ実行に失敗しました(insert_therapist_data_2)";
		exit();

	}

	return true;
	exit();

}

//function update_therapist_edit_man_5(
//$therapist_id,$mail,$name_real,$name_site,$kenmu,$rank,$name_aroma,$name_tgr,$name_lymph,$jitaku_taiki_flg,
//$for_kobetsu_url,$kensyuu_flg,$jisou_flg,$point_ref,$guarantee_rule,$point_fix,$address,$tel,
//$bank_info,$total_point,$name_furi,$furikomi_type,$chief_allowance,$transport_cost,
//$chief_allowance_start_time,$name_man,$password_man,$login_auth_type,$point_fix_start_time,
//$team_id,$wait_select,$wait_txt,$aroma_flg,$transfer_commission,$share_rate,$payment_span,$tax_flg){
function update_therapist_edit_man_5(
$therapist_id,$mail,$name_real,$name_site,$furi_site,$kenmu,$rank,$name_aroma,$furi_aroma,$name_tgr,$name_lymph,$jitaku_taiki_flg,
$for_kobetsu_url,$kensyuu_flg,$jisou_flg,$point_ref,$guarantee_rule,$point_fix,$address,$tel,
$bank_info,$memo,$bihin,$total_point,$name_furi,$furikomi_type,$chief_allowance,$transport_cost,
$chief_allowance_start_time,$name_man,$password_man,$login_auth_type,$point_fix_start_time,
$team_id,$wait_select,$wait_txt,$therapist_type,$transfer_commission,$share_rate,$payment_span,$tax_flg){

	//if( $aroma_flg == "1" ){
	//	$therapist_type = "2";
	//}else{
	//	$therapist_type = "1";
	//}

	if( $wait_select == "" ){

		$wait_select = "-1";

	}

	$rank_order_num = get_rank_order_num($rank);

	if( $jitaku_taiki_flg != "1" ){
		$jitaku_taiki_flg = 0;
	}

	if( $jisou_flg != "1" ){
		$jisou_flg = 0;
	}

	$kenmu_string = "";

	$kenmu_num = count($kenmu);

	if( $kenmu_num > 0 ){

		for($i=0;$i<$kenmu_num;$i++){

			$kenmu_string .= $kenmu[$i];

			if( $i != ($kenmu_num-1) ){

				$kenmu_string .= $kenmu_string.",";

			}

		}

	}

	$name_real = trim($name_real);
	$name_site = trim($name_site);
	$name_aroma = trim($name_aroma);
	$furi_site = trim($furi_site);
	$furi_aroma = trim($furi_aroma);

	$sql = sprintf("
update therapist_new set
name='%s',
mail='%s',
name_site='%s',
name_aroma='%s',
furi_site='%s',
furi_aroma='%s',
name_tgr='%s',
name_lymph='%s',
kenmu='%s',
rank='%s',
jitaku_taiki_flg='%s',
for_kobetsu_url='%s',
kensyuu_flg='%s',
jisou_flg='%s',
rank_order_num='%s',
point_ref='%s',
guarantee_rule='%s',
point_fix='%s',
point_fix_start_time='%s',
address='%s',
tel='%s',
bank_info='%s',
memo='%s',
bihin='%s',
total_point='%s',
name_furi='%s',
furikomi_type='%s',
chief_allowance='%s',
transport_cost='%s',
chief_allowance_start_time='%s',
name_man='%s',
login_auth_type='%s',
password_man='%s',
team_id='%s',
wait_select='%s',
therapist_type='%s',
wait_txt='%s',
transfer_commission='%s',
share_rate='%s',
payment_span='%s',
tax_flg='%s'
where id='%s'",
$name_real,$mail,$name_site,$name_aroma,$furi_site,$furi_aroma,$name_tgr,$name_lymph,$kenmu_string,$rank,$jitaku_taiki_flg,
$for_kobetsu_url,$kensyuu_flg,$jisou_flg,$rank_order_num,$point_ref,$guarantee_rule,
$point_fix,$point_fix_start_time,$address,$tel,$bank_info,$memo,$bihin,$total_point,$name_furi,$furikomi_type,$chief_allowance,
$transport_cost,$chief_allowance_start_time,$name_man,$login_auth_type,$password_man,
$team_id,$wait_select,$therapist_type,$wait_txt,$transfer_commission,$share_rate,$payment_span,$tax_flg,$therapist_id);

	//echo $sql;
	//exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(update_therapist_edit_man_5)";
		exit();

	}

	return true;
	exit();

}

function get_insurance_price_day_area($year,$month,$day,$area){

	$price = 0;

	$reservation_for_board_data = get_reservation_for_board_data_by_day_common($year, $month, $day);

	$reservation_for_board_data_num = count($reservation_for_board_data);

	/*
	echo "<pre>";
	print_r($reservation_for_board_data);
	echo "</pre>";
	exit();
	*/

	$attendance_new_data = get_attendance_new_data_day_common($year,$month,$day);

	$attendance_new_data_num = count($attendance_new_data);

	/*
	echo "<pre>";
	print_r($attendance_new_data);
	echo "</pre>";
	exit();
	*/

	for( $i=0; $i<$reservation_for_board_data_num; $i++ ){

		$attendance_id = $reservation_for_board_data[$i]["attendance_id"];

		$finish_flg = false;

		for( $x=0; $x<$attendance_new_data_num; $x++ ){

			if( $finish_flg == false ){

				$attendance_id_tmp = $attendance_new_data[$x]["id"];
				$therapist_id = $attendance_new_data[$x]["therapist_id"];
				$area_tmp = $attendance_new_data[$x]["area"];

				if( $attendance_id == $attendance_id_tmp ){

					//$insurance = get_therapist_insurance_by_id_common($therapist_id);
					$insurance = get_insurance_common($therapist_id,$year,$month,$day);

					if( $insurance == "2" ){

						if( ( $area == "all" ) || ( $area == $area_tmp ) ){

							$price = $price + 50;

						}

					}

					$finish_flg = true;

				}

			}

		}

	}

	return $price;
	exit();

}

function get_insurance_price_for_sale_shop_2(
$disp_type,$year,$month,$year_start,$month_start,$day_start,$year_end,$month_end,$day_end,$area){

	$price = 0;
	$for_start_num = 0;
	$for_end_num = 0;

	if( $disp_type == "kikan" ){

		$timestamp_start = get_timestamp_by_year_month_day_common($year_start,$month_start,$day_start);
		$timestamp_end = get_timestamp_by_year_month_day_common($year_end,$month_end,$day_end);

		if( $timestamp_start <= $timestamp_end ){

			$day_num = get_day_num_from_two_timestamp($timestamp_start,$timestamp_end);

		}else{

			return "0";
			exit();

		}

		$for_start_num = "0";
		$for_end_num = $day_num;

	}else if( $disp_type == "month" ){

		$last_day = get_last_day_common($year,$month);

		$for_start_num = "1";
		$for_end_num = $last_day;

		$for_end_num++;

	}else{

		return "0";
		exit();

	}

	for( $i=$for_start_num; $i<$for_end_num; $i++ ){

		if( $disp_type == "kikan" ){

			$mirai_day = get_mirai_day_common($year_start,$month_start,$day_start,$i);

			$year = $mirai_day["year"];
			$month = $mirai_day["month"];
			$day = $mirai_day["day"];

		}else if( $disp_type == "month" ){

			$day = $i;

		}else{

			return "0";
			exit();

		}

		$price_tmp = get_insurance_price_day_area($year,$month,$day,$area);

		$price = $price + $price_tmp;

	}

	return $price;
	exit();

}

//期間が、かぶっていないか、チェック
function check_period_for_settings_insurance($year_start,$month_start,$day_start,$year_end,$month_end,$day_end,$therapist_id){

	$timestamp_start = get_timestamp_by_year_month_day_2_common($year_start,$month_start,$day_start);
	$timestamp_end = get_timestamp_by_year_month_day_3_common($year_end,$month_end,$day_end);

	$sql = sprintf("
select id from settings_insurance where
( ((period_start>='%s') and (period_start<='%s')) or ((period_end>='%s') and (period_end<='%s')) ) and
therapist_id='%s' and
delete_flg=0",
$timestamp_start,$timestamp_end,$timestamp_start,$timestamp_end,$therapist_id);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(check_period_for_settings_insurance)";
		exit();

	}

	$num = mysql_num_rows($res);

	if( $num > 0 ){

		return true;
		exit();

	}else{

		return false;
		exit();

	}

}

function insert_settings_insurance($value,$therapist_id,$year_start,$month_start,$day_start,$year_end,$month_end,$day_end){

	$timestamp_start = get_timestamp_by_year_month_day_2_common($year_start,$month_start,$day_start);
	$timestamp_end = get_timestamp_by_year_month_day_3_common($year_end,$month_end,$day_end);

	$sql = sprintf("
insert into settings_insurance(value,therapist_id,period_start,period_end) values('%s','%s','%s','%s')",
$value,$therapist_id,$timestamp_start,$timestamp_end);

	$res = mysql_query($sql, DbCon);

	if($res === false){

		echo "error!(insert_settings_insurance)";
		exit();

	}

	return true;
	exit();

}

function get_settings_insurance_data($therapist_id){

	$sql = sprintf("
select * from settings_insurance where delete_flg='0' and therapist_id='%s' order by period_start desc",
$therapist_id);

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_settings_insurance_data)";
		exit();

	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$period_start = $row["period_start"];
		$period_end = $row["period_end"];

		$time_data = get_year_month_day_from_timestamp_common($period_start);

		$year_start = $time_data["year"];
		$month_start = $time_data["month"];
		$day_start = $time_data["day"];

		$time_data = get_year_month_day_from_timestamp_common($period_end);

		$year_end = $time_data["year"];
		$month_end = $time_data["month"];
		$day_end = $time_data["day"];

		$list_data[$i] = $row;

		$list_data[$i]["year_start"] = $year_start;
		$list_data[$i]["month_start"] = $month_start;
		$list_data[$i]["day_start"] = $day_start;
		$list_data[$i]["year_end"] = $year_end;
		$list_data[$i]["month_end"] = $month_end;
		$list_data[$i]["day_end"] = $day_end;

		$i++;

	}

	return $list_data;
	exit();

}

function get_page_name_disp_for_head_add($page_name){

	$page_name_disp = "不明";

	if( $page_name == "head_index_page" ){

		$page_name_disp = "トップページ";

	}else if( $page_name == "head_therapist_page" ){

		$page_name_disp = "セラピストページ";

	}

	return $page_name_disp;
	exit();
}

function update_page_html_2_by_page_name($page_name,$naiyou){

	//売上金額の更新
	$sql = sprintf("update page_html_2 set content='%s' where delete_flg=0 and name='%s'",$naiyou,$page_name);
	$res = mysql_query($sql, DbCon);
	if( $res == false ){
		echo "error!(update_page_html_2_by_page_name)";
		exit();
	}

	return true;
	exit();
}

function delete_settings_insurance($id){

	$sql = sprintf("update settings_insurance set delete_flg='1' where id='%s'",$id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(delete_settings_insurance)";
		exit();
	}

	return true;
	exit();
}

//期間が、かぶっていないか、チェック
function check_period_for_settings_insurance_2($year_start,$month_start,$day_start,$year_end,$month_end,$day_end,$therapist_id,$id){

	$timestamp_start = get_timestamp_by_year_month_day_2_common($year_start,$month_start,$day_start);
	$timestamp_end = get_timestamp_by_year_month_day_3_common($year_end,$month_end,$day_end);

	$sql = sprintf("
select id from settings_insurance where
( ((period_start>='%s') and (period_start<='%s')) or ((period_end>='%s') and (period_end<='%s')) ) and
therapist_id='%s' and
id<>'%s' and
delete_flg=0",
$timestamp_start,$timestamp_end,$timestamp_start,$timestamp_end,$therapist_id,$id);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(check_period_for_settings_insurance_2)";
		exit();

	}

	$num = mysql_num_rows($res);

	if( $num > 0 ){

		return true;
		exit();

	}else{

		return false;
		exit();

	}

}

function update_settings_insurance($value,$year_start,$month_start,$day_start,$year_end,$month_end,$day_end,$id){

	$timestamp_start = get_timestamp_by_year_month_day_2_common($year_start,$month_start,$day_start);
	$timestamp_end = get_timestamp_by_year_month_day_3_common($year_end,$month_end,$day_end);

	$sql = sprintf("update settings_insurance set value='%s',period_start='%s',period_end='%s' where id='%s'",$value,$timestamp_start,$timestamp_end,$id);
	$res = mysql_query($sql, DbCon);
	if($res === false){
		echo "error!(update_settings_insurance)";
		exit();
	}

	return true;
	exit();
}

function get_time_array_board_2(){
global $time_array_board;

	return $time_array_board;
	exit();

}

function get_furikomi_data_for_furikomi_list_2($week_data,$area,$staff_type){

	//return true;exit();

	//$tmp = get_next_month_common($year,$month);

	if( $staff_type == "therapist" ){

		$type = "therapist";
		$attendance_data = get_attendance_data_for_furikomi_list($week_data,$type);

		//トータルポイント用の出勤データ取得
		$attendance_data_for_total_point = get_attendance_data_for_total_point();

	}else if( ($staff_type == "driver") || ($staff_type == "honbu") ){

		$type = "staff";
		$attendance_data = get_attendance_data_for_furikomi_list($week_data,$type);

	}else{

		echo "error!(get_furikomi_data_for_furikomi_list_2)";
		exit();

	}

	$staff_data = get_staff_data_by_week_date_for_furikomi_list_2($week_data,$area,$staff_type,$attendance_data);

	$staff_data_num = count($staff_data);

	/*
	echo "<pre>";
	print_r($staff_data);
	echo "</pre>";
	exit();
	*/

	$return_data = array();
	$x = 0;

	for( $i=0; $i<$staff_data_num; $i++ ){

		$staff_id = $staff_data[$i]["id"];
		$furikomi_type = $staff_data[$i]["furikomi_type"];
		$shayousha_flg = $staff_data[$i]["shayousha_flg"];

		if( $shayousha_flg == "1" ){

			$furikomi_price = 0;

		}else{

			if( $staff_type == "therapist" ){

				//$data = get_furikomi_price_by_week_data_2_common($week_data,$staff_id);
				$data = get_furikomi_price_by_week_data_3(
$week_data,$staff_id,$attendance_data,$attendance_data_for_total_point);

			}else if( ($staff_type == "driver") || ($staff_type == "honbu") ){

				$data = get_furikomi_price_driver_by_week_data_2_common($week_data,$staff_id);

			}else{

				echo "error!(get_furikomi_data_for_furikomi_list_2)";
				exit();

			}


			$furikomi_price = $data["furikomi_price"];
			$remuneration = $data["remuneration"];
			$other_price = $data["other_price"];

			$transfer_commission_price = $data["transfer_commission_price"];
			$transfer_commission_price_disp = $data["transfer_commission_price_disp"];

			$furikomi_commission = get_furikomi_commission_by_furikomi_type_common($furikomi_type,$furikomi_price);

			$staff_data[$i]["furikomi_price"] = $furikomi_price;
			$staff_data[$i]["furikomi_commission"] = $furikomi_commission;

			$staff_data[$i]["remuneration"] = $remuneration;
			$staff_data[$i]["other_price"] = $other_price;

			$staff_data[$i]["transfer_commission_price"] = $transfer_commission_price;
			$staff_data[$i]["transfer_commission_price_disp"] = $transfer_commission_price_disp;

		}

		if( $furikomi_price > 0 ){

			$return_data[$x] = $staff_data[$i];
			$x++;

		}

	}

	return $return_data;
	exit();

}

function get_attendance_data_for_furikomi_list($week_data,$type){

	/*
	echo "<pre>";
	print_r($week_data);
	echo "</pre>";
	exit();
	*/

	if( $type == "staff" ){

		$tbl_name = "attendance_staff_new";

	}else{

		$tbl_name = "attendance_new";

	}

	$year = $week_data[0]["year"];
	$month = $week_data[0]["month"];

	$tmp = get_next_month_common($year,$month);

	$year_2 = $tmp["year"];
	$month_2 = $tmp["month"];

	$sql = sprintf("select * from %s where (year='%s' and month='%s') or (year='%s' and month='%s')",$tbl_name,$year,$month,$year_2,$month_2);
	$res = mysql_query($sql, DbCon);
	if( $res == false ){
		echo "error!(get_attendance_data_for_furikomi_list)";
		exit();
	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$list_data[$i] = $row;
		$i++;

	}

	return $list_data;
	exit();
}

function get_staff_data_by_week_date_for_furikomi_list_2($week_data,$area,$staff_type,$attendance_data){

	if( $staff_type == "therapist" ){

		$staff_data = get_therapist_data_by_area_new($area);

	}else if( $staff_type == "driver" ){

		$staff_data = get_driver_data_by_area_common($area);

	}else if( $staff_type == "honbu" ){

		$staff_data = get_honbu_data_by_area_common($area);

	}else{

		echo "error!(get_staff_data_by_week_date_for_furikomi_list_2)";
		exit();

	}

	$staff_data_num = count($staff_data);

	$data = array();
	$x = 0;

	for( $i=0; $i<$staff_data_num; $i++ ){

		$staff_id = $staff_data[$i]["id"];

		$result = check_week_attendance_exist_by_staff_id_2($week_data,$staff_id,$staff_type,$attendance_data);

		if( $result == true ){

			$data[$x++] = $staff_data[$i];

		}

	}

	$data = order_value_sort_kana_common($data,"name_furi");

	return $data;
	exit();

}

function check_week_attendance_exist_by_staff_id_2($week_data,$staff_id,$staff_type,$attendance_data){

	$attendance_data_num = count($attendance_data);

	$week_data_num = count($week_data);

	$where_day = "";

	$first_flg = true;

	for( $i=0; $i<$week_data_num; $i++ ){

		$year = $week_data[$i]["year"];
		$month = $week_data[$i]["month"];
		$day = $week_data[$i]["day"];

		for( $x=0; $x<$attendance_data_num; $x++ ){

			$year_tmp = $attendance_data[$x]["year"];
			$month_tmp = $attendance_data[$x]["month"];
			$day_tmp = $attendance_data[$x]["day"];
			$therapist_id_tmp = $attendance_data[$x]["therapist_id"];
			$staff_id_tmp = $attendance_data[$x]["staff_id"];
			$today_absence = $attendance_data[$x]["today_absence"];
			$kekkin_flg = $attendance_data[$x]["kekkin_flg"];
			$syounin_state = $attendance_data[$x]["syounin_state"];
			$attendance_adjustment = $attendance_data[$x]["attendance_adjustment"];

			if( $staff_type == "therapist" ){

if(
($year==$year_tmp) and ($month==$month_tmp) and ($day==$day_tmp) and
($staff_id==$therapist_id_tmp) and
($today_absence=="0") and ($kekkin_flg=="0") and ($syounin_state=="1")
){
	return true;
	exit();
}

			}else if( ($staff_type == "driver") || ($staff_type == "honbu") ){

if(
($year==$year_tmp) and ($month==$month_tmp) and ($day==$day_tmp) and
($staff_id==$staff_id_tmp) and
($today_absence=="0") and ($kekkin_flg=="0") and ($syounin_state=="1") and ($attendance_adjustment=="0")
){
	return true;
	exit();
}

			}else{
				echo "error!(check_week_attendance_exist_by_staff_id_2)";
				exit();
			}

		}

	}

	return false;
	exit();

}

function get_attendance_data_work_from_attendance_data($staff_id,$year,$month,$day,$attendance_data){

	$attendance_data_num = count($attendance_data);

	for( $x=0; $x<$attendance_data_num; $x++ ){

		$year_tmp = $attendance_data[$x]["year"];
		$month_tmp = $attendance_data[$x]["month"];
		$day_tmp = $attendance_data[$x]["day"];
		$therapist_id_tmp = $attendance_data[$x]["therapist_id"];
		$staff_id_tmp = $attendance_data[$x]["staff_id"];
		$today_absence = $attendance_data[$x]["today_absence"];
		$kekkin_flg = $attendance_data[$x]["kekkin_flg"];
		$syounin_state = $attendance_data[$x]["syounin_state"];
		$attendance_adjustment = $attendance_data[$x]["attendance_adjustment"];

if(
	($year==$year_tmp) and ($month==$month_tmp) and ($day==$day_tmp) and
	($staff_id==$therapist_id_tmp) and
	($today_absence=="0") and ($kekkin_flg=="0") and ($syounin_state=="1")
){
	return $attendance_data[$x];
	exit();
}

	}

	return false;
	exit();

}

function get_furikomi_price_by_week_data_3(
$week_data,$therapist_id,$attendance_data_hiki,$attendance_data_for_total_point){

	$therapist_data = get_therapist_data_by_id_common($therapist_id);
	$jisou_flg = $therapist_data["jisou_flg"];
	$transport_cost = $therapist_data["transport_cost"];

	$transfer_commission = $therapist_data["transfer_commission"];
	$transfer_commission_price = 0;
	$transfer_commission_price_disp = 0;
	if( $transfer_commission == "2" ){
		$transfer_commission_price = 270;
		$transfer_commission_price_disp = $transfer_commission_price*(-1);
	}

	$week_data_num = count($week_data);

	$furikomi_price = 0;
	$remuneration_all = 0;
	$pay_another_all = 0;

	for( $i=0; $i<$week_data_num; $i++ ){

		$year = $week_data[$i]["year"];
		$month = $week_data[$i]["month"];
		$day = $week_data[$i]["day"];

		if( $year > 2013 ){

			$remuneration = 0;
			$allowance_jisou = 0;
			$allowance = 0;
			$pay_another = 0;
			$pay_finish = 0;
			$pay_day = 0;

			$result = check_last_day_common($year,$month,$day);

			if( $result == true ){

				$insurance_price = get_insurance_price_day_therapist_id_common($year,$month,$day,$therapist_id);

				//remuneration_therapistから取得
				$data_tmp = get_remuneration_therapist_by_day_common($therapist_id,$year,$month,$day);

				if( $data_tmp["id"] != "" ){

					$remuneration = $data_tmp["remuneration"];
					$allowance_jisou = $data_tmp["allowance_jisou"];
					$allowance = $data_tmp["allowance"];
					$pay_another = $data_tmp["pay_another"];
					$pay_finish = $data_tmp["pay_finish"];
					$pay_day = $data_tmp["pay_day"];

				}else{

					$attendance_data = get_attendance_data_work_from_attendance_data(
$therapist_id,$year,$month,$day,$attendance_data_hiki);
					$attendance_id = $attendance_data["id"];

					if( $attendance_id != "" ){

						$pay_day = $attendance_data["pay_day"];
						$pay_another = $attendance_data["pay_another"];
						$pay_finish = $attendance_data["pay_finish"];
						$allowance = $attendance_data["allowance"];

						if( $pay_another == "0" ){
							$pay_another = $transport_cost;
						}

						$allowance_jisou = 0;

						if( $jisou_flg == "1" ){
							$allowance_jisou = get_allowance_therapist_common($year,$month,$day,$attendance_id);
						}
						//$remuneration_data = get_therapist_remuneration_by_attendance_id_common($attendance_id);
						$remuneration_data = get_therapist_remuneration_by_attendance_data_common(
$attendance_data,$attendance_data_for_total_point);
						$remuneration = $remuneration_data["remuneration"];

					}

				}

				$remuneration = $remuneration - $insurance_price;

			}

			$allowance = $allowance + $allowance_jisou;
			$furikomi_price = $furikomi_price + $remuneration - $pay_day + $allowance + $pay_another - $pay_finish;
			$remuneration_all = $remuneration_all + $remuneration - $pay_day + $allowance - $pay_finish;
			$pay_another_all = $pay_another_all + $pay_another;

		}

	}

	$furikomi_price = $furikomi_price - $transfer_commission_price;

	$data["furikomi_price"] = $furikomi_price;
	$data["remuneration"] = $remuneration_all;

	//立替金(固定支給交通費、含む)
	$data["other_price"] = $pay_another_all;

	$data["transfer_commission_price"] = $transfer_commission_price;
	$data["transfer_commission_price_disp"] = $transfer_commission_price_disp;

	return $data;
	exit();

}

function get_attendance_data_one_by_attendance_id_from_attendance_data($attendance_id,$attendance_data){

	$attendance_data_num = count($attendance_data);

	for( $x=0; $x<$attendance_data_num; $x++ ){

		$attendance_id_tmp = $attendance_data[$x]["id"];

		if( $attendance_id == $attendance_id_tmp ){
			return $attendance_data[$x];
			exit();
		}

	}

	return false;
	exit();

}

//トータルポイント用の出勤データ取得
function get_attendance_data_for_total_point(){

	$past_num = 12;

	$year_to = intval(date('Y'));
	$month_to = intval(date('m'));
	$day_to = intval(date('d'));

	$data = get_kako_day_common($year_to,$month_to,$day_to,$past_num);
	$year_from = $data["year"];
	$month_from = $data["month"];
	$day_from = $data["day"];

	//施術と指名のポイント獲得のため
	$sql = sprintf("
select * from attendance_new
where
(
(year>%s) or
((year=%s) and (month>%s)) or
((year=%s) and (month=%s) and (day>=%s))
)
and
(
(year<%s) or
((year=%s) and (month<%s)) or
((year=%s) and (month=%s) and (day<%s))
)
and
today_absence='0' and
kekkin_flg='0' and
syounin_state='1'",
$year_from,$year_from,$month_from,$year_from,$month_from,$day_from,
$year_to,$year_to,$month_to,$year_to,$month_to,$day_to);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_attendance_data_for_total_point)";
		exit();

	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$list_data[$i] = $row;
		$i++;

	}

	return $list_data;
	exit();

}

function get_total_point_by_therapist_id_2(
$therapist_id,$year_to,$month_to,$day_to,$attendance_data_for_total_point){

	$past_num = "12";

	if( ($therapist_id == "-1") || ($therapist_id == "") ){

		return "0";
		exit();

	}

	$total_point = get_total_point_from_total_point_day_common($therapist_id,$year_to,$month_to,$day_to);

	if( $total_point != "" ){

		return $total_point;
		exit();

	}

	$data = get_total_point_from_total_point_common($therapist_id);

	$therapist_total_point = $data["value"];
	$year_from = $data["year"];
	$month_from = $data["month"];
	$day_from = $data["day"];

	if( $therapist_total_point == "" ){

		$therapist_total_point = get_therapist_total_point_common($therapist_id);

		$year_now = intval(date('Y'));
		$month_now = intval(date('m'));
		$day_now = intval(date('d'));

		$data = get_kako_day_common($year_now,$month_now,$day_now,$past_num);
		$year_from = $data["year"];
		$month_from = $data["month"];
		$day_from = $data["day"];

	}

	$result = check_from_time_for_total_point($year_to,$month_to,$day_to,$year_from,$month_from,$day_from);

	if( $result == false ){

		echo "error!(get_total_point_by_therapist_id_2)";
		exit();

	}

	$total_point = get_total_point_from_attendance_data_for_total_point(
$therapist_id,$year_to,$month_to,$day_to,$year_from,$month_from,$day_from,$attendance_data_for_total_point);

	$total_point = $total_point + $therapist_total_point;

	return $total_point;
	exit();

}

function check_from_time_for_total_point($year_to,$month_to,$day_to,$year_from,$month_from,$day_from){

	$year_now = intval(date('Y'));
	$month_now = intval(date('m'));
	$day_now = intval(date('d'));

	$past_num = 30;
	$data = get_kako_day_common($year_now,$month_now,$day_now,$past_num);
	$year_30 = $data["year"];
	$month_30 = $data["month"];
	$day_30 = $data["day"];

	$ts_now = get_timestamp_by_year_month_day_common($year_now, $month_now, $day_now);
	$ts_30 = get_timestamp_by_year_month_day_common($year_30, $month_30, $day_30);
	$ts_from = get_timestamp_by_year_month_day_common($year_from, $month_from, $day_from);
	$ts_to = get_timestamp_by_year_month_day_common($year_to, $month_to, $day_to);

	if( $ts_from > $ts_to ){

		return false;
		exit();

	}

	if( $ts_from < $ts_30 ){

		return false;
		exit();

	}

	if( $ts_to < $ts_30 ){

		return false;
		exit();

	}

	return true;
	exit();

}

function get_total_point_from_attendance_data_for_total_point(
$therapist_id,$year_to,$month_to,$day_to,$year_from,$month_from,$day_from,$attendance_data){

	$attendance_data_num = count($attendance_data);

	for( $i=0; $i<32; $i++ ){

		$tmp = get_mirai_day_common($year_from, $month_from, $day_from, $i);
		$year_tmp = $tmp["year"];
		$month_tmp = $tmp["month"];
		$day_tmp = $tmp["day"];

	}

	return true;
	exit();

}

function get_attendance_new_for_download_remuneration_csv($year,$month,$area,$remuneration_data){

$sql = sprintf("
select * from attendance_new where
today_absence='0' and
kekkin_flg='0' and
syounin_state='1' and
year='%s' and
month='%s' and
area='%s'",
$year,$month,$area);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if( $res == false ){

		echo "error!(get_attendance_new_for_download_remuneration_csv)";
		exit();

	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$attendance_id = $row["id"];
		$therapist_id = $row["therapist_id"];
		$area = $row["area"];
		$day = $row["day"];
		$allowance = $row["allowance"];

		$result = check_mirai_for_remuneration_csv($year,$month,$day);

		if( $result == false ){

			$area_name = get_area_name_by_area_common($area);

			$tmp = get_therapist_data_by_id_common($therapist_id);

			$therapist_name = $tmp["name"];
			$therapist_address = $tmp["address"];

			$remuneration = get_remuneration_therapist_for_remuneration_csv($attendance_id,$remuneration_data);

			if( $remuneration === false ){

				$tmp = get_therapist_remuneration_by_attendance_id_common($attendance_id);
				$remuneration = $tmp["remuneration"];

			}

			if( $remuneration > 0 ){

				$insurance_price = get_insurance_price_day_therapist_id_common($year,$month,$day,$therapist_id);

				$remuneration = $remuneration + $allowance - $insurance_price;

				$list_data[$i] = $row;
				$list_data[$i]["staff_name"] = $therapist_name;
				$list_data[$i]["staff_address"] = $therapist_address;
				$list_data[$i]["area_name"] = $area_name;
				$list_data[$i]["remuneration"] = $remuneration;

				$i++;

			}

		}

	}

	return $list_data;
	exit();

}

function get_attendance_staff_new_for_download_remuneration_csv($year,$month,$area,$staff_type,$remuneration_data){

	$area_name = get_area_name_by_area_common($area);

	$sql = sprintf("
select * from attendance_staff_new where
today_absence='0' and
kekkin_flg='0' and
syounin_state='1' and
year='%s' and
month='%s' and
area='%s' and
type='%s'",
$year,$month,$area,$staff_type);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(get_attendance_staff_new_for_download_remuneration_csv)";
		exit();

	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$attendance_id = $row["id"];
		$staff_id = $row["staff_id"];
		$day = $row["day"];
		$type = $row["type"];

		$result = check_mirai_for_remuneration_csv($year,$month,$day);

		if( $result == false ){

			$tmp = get_staff_data_by_id_common($staff_id);

			$staff_name = $tmp["name"];
			$staff_address = $tmp["address"];

			if( $type == "driver" ){

				$remuneration = get_remuneration_driver_for_remuneration_csv_2($attendance_id,$remuneration_data);

			}else{

				//セラピストのものと同じでオッケー
				$remuneration = get_remuneration_therapist_for_remuneration_csv($attendance_id,$remuneration_data);

			}

			if( $remuneration === false ){

				$remuneration = get_remuneration_staff_by_attendance_id_common($attendance_id,$distance_ave);

				if( $remuneration > 0 ){

					if( $type == "driver" ){

						$remuneration = get_remuneration_driver_for_remuneration_csv($remuneration,$attendance_id);

					}

				}

			}

			if( $remuneration > 0 ){

				$list_data[$i] = $row;
				$list_data[$i]["staff_name"] = $staff_name;
				$list_data[$i]["staff_address"] = $staff_address;
				$list_data[$i]["area_name"] = $area_name;
				$list_data[$i]["remuneration"] = $remuneration;

				$i++;

			}

		}

	}

	return $list_data;
	exit();

}

function get_attendance_from_attendance_therapist($attendance,$year,$month,$day,$area){

	$data = array();
	$x = 0;

	$attendance_num = count($attendance);

	for( $i=0; $i<$attendance_num; $i++ ){

		$year_tmp = $attendance[$i]["year"];
		$month_tmp = $attendance[$i]["month"];
		$day_tmp = $attendance[$i]["day"];
		$area_tmp = $attendance[$i]["area"];

		if( ($year_tmp==$year) && ($month_tmp==$month) && ($day_tmp==$day) && ($area_tmp==$area) ){

			$data[$x] = $attendance[$i];
			$x++;

		}

	}

	return $data;
	exit();

}

function check_mirai_for_remuneration_csv($year,$month,$day){

	$now_hour = intval(date('H'));

	if($now_hour <= 10){
		//昨日の日付
		$year_now = intval(date('Y', strtotime('-1 day')));
		$month_now = intval(date('m', strtotime('-1 day')));
		$day_now = intval(date('d', strtotime('-1 day')));
	}else{
		$year_now = intval(date('Y'));
		$month_now = intval(date('m'));
		$day_now = intval(date('d'));
	}

	/*
	$num = "4";
	$data = get_old_day_common($year_now,$month_now,$day_now,$num);
	$year_now = $data["year"];
	$month_now = $data["month"];
	$day_now = $data["day"];
	*/

	$ts_now = get_timestamp_by_year_month_day_common($year_now, $month_now, $day_now);

	$ts = get_timestamp_by_year_month_day_common($year, $month, $day);

	if( $ts_now < $ts ){

		return true;
		exit();

	}

	return false;
	exit();

}

function get_remuneration_therapist_for_remuneration_csv($attendance_id,$remuneration_data){

	$remuneration_data_num = count($remuneration_data);

	for( $i=0; $i<$remuneration_data_num; $i++ ){

		$attendance_id_tmp = $remuneration_data[$i]["attendance_id"];
		$remuneration = $remuneration_data[$i]["remuneration"];
		$delete_flg = $remuneration_data[$i]["delete_flg"];

		if( ($delete_flg=="0") && ($attendance_id_tmp==$attendance_id) ){

			return $remuneration;
			exit();

		}

	}

	return false;
	exit();

}

function get_remuneration_staff_for_download_remuneration_csv($year,$month){

	$sql = sprintf("select * from remuneration_staff where delete_flg='0' and year='%s' and month='%s'",$year,$month);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_remuneration_staff_for_download_remuneration_csv)";
		exit();
	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$list_data[$i++] = $row;

	}

	return $list_data;
	exit();
}

function download_remuneration_csv($year,$month,$area,$staff_type){

	if( $staff_type == "therapist" ){

		//remuneration_therapist、取得
		$remuneration_data = get_remuneration_therapist_for_download_remuneration_csv($year,$month);
		$attendance_data = get_attendance_new_for_download_remuneration_csv($year,$month,$area,$remuneration_data);

		//以下、年間の関数はコメントアウト
		//$remuneration_data = get_remuneration_therapist_for_download_remuneration_csv_year($year);
		//$attendance_data = get_attendance_new_for_download_remuneration_csv_year($year,$area,$remuneration_data);

	}else{

		//remuneration_staff、取得
		$remuneration_data = get_remuneration_staff_for_download_remuneration_csv($year,$month);
		$attendance_data = get_attendance_staff_new_for_download_remuneration_csv(
$year,$month,$area,$staff_type,$remuneration_data);

	}

	$html = "";

	$last_day = get_last_day_common($year, $month);

	for( $j=1; $j<=$last_day; $j++ ){

		$day = $j;

		$result = check_mirai_for_remuneration_csv($year,$month,$day);

		if( $result == false ){

			$week_name = get_week_name_by_time_common($year, $month, $day);

			$attendance = get_attendance_from_attendance_therapist(
$attendance_data,$year,$month,$day,$area);

			$attendance_num = count($attendance);

			for( $k=0; $k<$attendance_num; $k++ ){

				$staff_name = $attendance[$k]["staff_name"];
				$staff_address = $attendance[$k]["staff_address"];
				$area_name = $attendance[$k]["area_name"];
				$remuneration = $attendance[$k]["remuneration"];

				$tmp = sprintf("%s月%s日（%s）",$month,$day,$week_name);
				$html .= "\"".$tmp."\"".",";

				$tmp = $area_name;
				$html .= "\"".$tmp."\"".",";

				$tmp = $staff_name;
				$html .= "\"".$tmp."\"".",";

				$tmp = $staff_address;
				$html .= "\"".$tmp."\"".",";

				$tmp = $remuneration;
				$html .= "\"".$tmp."\""."\n";
			}
		}
	}

	return $html;
	exit();
}

function get_remuneration_therapist_for_download_remuneration_csv($year,$month){

	$sql = sprintf("select * from remuneration_therapist where delete_flg='0' and year='%s' and month='%s'",$year,$month);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_remuneration_therapist_for_download_remuneration_csv)";
		exit();
	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$list_data[$i++] = $row;

	}

	return $list_data;
	exit();

}

function get_attendance_new_for_download_remuneration_csv_year($year,$area,$remuneration_data){

	$sql = sprintf("select * from attendance_new where today_absence='0' and kekkin_flg='0' and syounin_state='1' and year='%s' and area='%s'",$year,$area);
	$res = mysql_query($sql, DbCon);
	if( $res == false ){
		echo "error!(get_attendance_new_for_download_remuneration_csv_year)";
		exit();
	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$attendance_id = $row["id"];
		$therapist_id = $row["therapist_id"];
		$area = $row["area"];

		$area_name = get_area_name_by_area_common($area);

		$tmp = get_therapist_data_by_id_common($therapist_id);

		$therapist_name = $tmp["name"];
		$therapist_address = $tmp["address"];

		//$remuneration_data = get_therapist_remuneration_by_attendance_id_common($attendance_id);
		//$remuneration = $remuneration_data["remuneration"];
		$remuneration = get_remuneration_therapist_for_remuneration_csv($attendance_id,$remuneration_data);

		if( ($remuneration !== false) && ($remuneration > 0) ){

			$list_data[$i] = $row;
			$list_data[$i]["therapist_name"] = $therapist_name;
			$list_data[$i]["therapist_address"] = $therapist_address;
			$list_data[$i]["area_name"] = $area_name;
			$list_data[$i]["remuneration"] = $remuneration;

			$i++;

		}

	}

	return $list_data;
	exit();

}

function get_remuneration_therapist_for_download_remuneration_csv_year($year){

	$sql = sprintf("select * from remuneration_therapist where delete_flg='0' and year='%s'",$year);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_remuneration_therapist_for_download_remuneration_csv_year)";
		exit();
	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$list_data[$i++] = $row;

	}

	return $list_data;
	exit();
}

function get_remuneration_driver_for_remuneration_csv($remuneration,$attendance_id){

	$staff_type = "driver";

	$tmp = get_attendance_staff_new_data_by_attendance_id_common($attendance_id);

	$staff_id = $tmp["staff_id"];
	$year = $tmp["year"];
	$month = $tmp["month"];
	$day = $tmp["day"];
	$allowance = $tmp["allowance"];
	$pay_finish = $tmp["pay_finish"];
	$parking = $tmp["parking"];
	$highway = $tmp["highway"];
	$pay_day = $tmp["pay_day"];
	$car_distance = $tmp["car_distance"];
	$start_hour = $tmp["start_hour"];
	$start_minute = $tmp["start_minute"];
	$end_hour = $tmp["end_hour"];
	$end_minute = $tmp["end_minute"];

	$tmp = get_staff_data_by_id_common($staff_id);

	$chief_allowance = $tmp["chief_allowance"];
	$chief_allowance_start_time = $tmp["chief_allowance_start_time"];
	$fuel = $tmp["fuel"];

	$gasoline_value = get_gasoline_value_by_id_and_time_common($attendance_id);

	if( ($fuel != "0") && ($fuel != "-1") ){
		$gasoline_value_disp = intval(($car_distance*$gasoline_value)/$fuel);
	}else{
		$gasoline_value_disp = 0;
	}

	$work_time = get_work_time_driver_common($start_hour,$start_minute,$end_hour,$end_minute);

	//超過手当
	$data = get_car_distance_allowance_data_common($car_distance,$work_time,$staff_type,$year,$month,$day);
	$car_distance_over_allowance = $data["car_distance_over_allowance"];

	$chief_allowance = get_chief_allowance_staff_common($year,$month,$day,$chief_allowance,$chief_allowance_start_time);

	$sum_price = 0;

	$switching_result = check_switching_driver_remuneration_common($year,$month,$day,$staff_id);

	if( $switching_result == true ){

		//報酬+高速代+駐車場代-清算済み
		$sum_price = ( $remuneration + $highway + $parking ) - $pay_finish - $pay_day;

	}else{

		//チーフ手当を足す
		$remuneration = $remuneration + $chief_allowance;

		//報酬+ガソリン代+高速代+駐車場代+手当-清算済み
		$sum_price = ( $remuneration + $gasoline_value_disp + $highway + $parking + $allowance ) - $pay_finish - $pay_day;

		$sum_price = $sum_price + $car_distance_over_allowance;

	}

	$price = $sum_price + $pay_finish + $pay_day;

	return $price;
	exit();

}

function get_remuneration_driver_for_remuneration_csv_2($attendance_id,$remuneration_data){

	$remuneration_data_num = count($remuneration_data);

	for( $i=0; $i<$remuneration_data_num; $i++ ){

		$attendance_id_tmp = $remuneration_data[$i]["attendance_id"];
		$sum_price = $remuneration_data[$i]["sum_price"];
		$pay_day = $remuneration_data[$i]["pay_day"];
		$pay_finish = $remuneration_data[$i]["pay_finish"];
		$delete_flg = $remuneration_data[$i]["delete_flg"];

		if( ($delete_flg=="0") && ($attendance_id_tmp==$attendance_id) ){

			$price = $sum_price + $pay_day + $pay_finish;

			return $price;
			exit();

		}

	}

	return false;
	exit();

}

function get_settings_gasoline_control_data(){

	$sql = "select * from settings_gasoline_control where delete_flg='0' order by period_start desc";
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(get_settings_gasoline_control_data)";
		exit();
	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$period_start = $row["period_start"];
		$period_end = $row["period_end"];

		$time_data = get_year_month_day_from_timestamp_common($period_start);

		$year_start = $time_data["year"];
		$month_start = $time_data["month"];
		$day_start = $time_data["day"];

		$time_data = get_year_month_day_from_timestamp_common($period_end);

		$year_end = $time_data["year"];
		$month_end = $time_data["month"];
		$day_end = $time_data["day"];

		$list_data[$i] = $row;

		$list_data[$i]["year_start"] = $year_start;
		$list_data[$i]["month_start"] = $month_start;
		$list_data[$i]["day_start"] = $day_start;
		$list_data[$i]["year_end"] = $year_end;
		$list_data[$i]["month_end"] = $month_end;
		$list_data[$i]["day_end"] = $day_end;

		$i++;

	}

	return $list_data;
	exit();

}

function unit_price_setting_list($area){
	if($area == ''){
		$sql = "select * from unit_price_setting where delete_flg='0' order by period_start desc";
	}else{
		$sql = sprintf("select * from unit_price_setting where delete_flg='0' and area='%s' order by period_start desc", $area);
	}
	//echo $sql;
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(unit_price_setting_list)";
		exit();
	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$period_start = $row["period_start"];
		$period_end = $row["period_end"];
		$ave_distance_le = $row["ave_distance_le"];
		$ave_distance_t = $row["ave_distance_t"];
		$unit_price = $row["unit_price"];

		$time_data = get_year_month_day_from_timestamp_common($period_start);

		$year_start = $time_data["year"];
		$month_start = $time_data["month"];
		$day_start = $time_data["day"];

		$time_data = get_year_month_day_from_timestamp_common($period_end);

		$year_end = $time_data["year"];
		$month_end = $time_data["month"];
		$day_end = $time_data["day"];

		$list_data[$i] = $row;

		$list_data[$i]["year_start"] = $year_start;
		$list_data[$i]["month_start"] = $month_start;
		$list_data[$i]["day_start"] = $day_start;
		$list_data[$i]["year_end"] = $year_end;
		$list_data[$i]["month_end"] = $month_end;
		$list_data[$i]["day_end"] = $day_end;
		$list_data[$i]["ave_distance_le"] = $ave_distance_le;
		$list_data[$i]["ave_distance_t"] = $ave_distance_t;
		$list_data[$i]["unit_price"] = $unit_price;

		$i++;

	}

	return $list_data;
	exit();

}

//期間が、かぶっていないか、チェック
function check_period_for_sale_gasoline_control($year_start,$month_start,$day_start,$year_end,$month_end,$day_end){

	$timestamp_start = get_timestamp_by_year_month_day_2_common($year_start,$month_start,$day_start);
	$timestamp_end = get_timestamp_by_year_month_day_3_common($year_end,$month_end,$day_end);

	$sql = sprintf("
select id from settings_gasoline_control where
( ((period_start>='%s') and (period_start<='%s')) or ((period_end>='%s') and (period_end<='%s')) ) and delete_flg=0",
$timestamp_start,$timestamp_end,$timestamp_start,$timestamp_end);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(check_period_for_sale_gasoline_control)";
		exit();

	}

	$num = mysql_num_rows($res);

	if( $num > 0 ){

		return true;
		exit();

	}else{

		return false;
		exit();

	}

}

function insert_settings_gasoline_control($gasoline_value,$year_start,$month_start,$day_start,$year_end,$month_end,$day_end){

	$timestamp_start = get_timestamp_by_year_month_day_2_common($year_start,$month_start,$day_start);
	$timestamp_end = get_timestamp_by_year_month_day_3_common($year_end,$month_end,$day_end);

	$sql = sprintf("
insert into settings_gasoline_control(value,period_start,period_end) values('%s','%s','%s')",
$gasoline_value,$timestamp_start,$timestamp_end);

	$res = mysql_query($sql, DbCon);

	if($res === false){

		echo "error!(insert_settings_gasoline_control)";
		exit();

	}

	return true;
	exit();
}

function unit_price_setting($area,$year_start,$month_start,$day_start,$year_end,$month_end,$day_end,$ave_distance_le,$ave_distance_t,$unit_price){

	$timestamp_start = get_timestamp_by_year_month_day_2_common($year_start,$month_start,$day_start);
	$timestamp_end = get_timestamp_by_year_month_day_3_common($year_end,$month_end,$day_end);

	$sql = sprintf("
insert into unit_price_setting(area,period_start,period_end,ave_distance_le,ave_distance_t,unit_price) values('%s','%s','%s','%s','%s','%s')",$area,$timestamp_start,$timestamp_end,$ave_distance_le,$ave_distance_t,$unit_price);
//echo $sql;
	$res = mysql_query($sql, DbCon);

	if($res === false){

		echo "error!(unit_price_setting)";
		exit();

	}

	return true;
	exit();
}

//期間が、かぶっていないか、チェック
function check_period_for_sale_gasoline_control_2(
$year_start,$month_start,$day_start,$year_end,$month_end,$day_end,$id){

	$timestamp_start = get_timestamp_by_year_month_day_2_common($year_start,$month_start,$day_start);
	$timestamp_end = get_timestamp_by_year_month_day_3_common($year_end,$month_end,$day_end);

	$sql = sprintf("
select id from settings_gasoline_control where
( ((period_start>='%s') and (period_start<='%s')) or ((period_end>='%s') and (period_end<='%s')) ) and
id<>'%s' and
delete_flg=0",
$timestamp_start,$timestamp_end,$timestamp_start,$timestamp_end,$id);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(check_period_for_sale_gasoline_control_2)";
		exit();

	}

	$num = mysql_num_rows($res);

	if( $num > 0 ){

		return true;
		exit();

	}else{

		return false;
		exit();

	}

}

function update_settings_gasoline_control(
$gasoline_value,$year_start,$month_start,$day_start,$year_end,$month_end,$day_end,$id){

	$timestamp_start = get_timestamp_by_year_month_day_2_common($year_start,$month_start,$day_start);
	$timestamp_end = get_timestamp_by_year_month_day_3_common($year_end,$month_end,$day_end);

	$sql = sprintf("update settings_gasoline_control set value='%s',period_start='%s',period_end='%s' where id='%s'",$gasoline_value,$timestamp_start,$timestamp_end,$id);
	$res = mysql_query($sql, DbCon);
	if($res === false){
		echo "error!(update_settings_gasoline_control)";
		exit();
	}

	return true;
	exit();
}

function update_unit_price_setting(
$id,$area,$year_start,$month_start,$day_start,$year_end,$month_end,$day_end,$ave_distance_le,$ave_distance_t,$unit_price){

	$timestamp_start = get_timestamp_by_year_month_day_2_common($year_start,$month_start,$day_start);
	$timestamp_end = get_timestamp_by_year_month_day_3_common($year_end,$month_end,$day_end);

	$sql = sprintf("update unit_price_setting set area='%s',period_start='%s',period_end='%s',ave_distance_le='%s',ave_distance_t='%s',unit_price='%s' where id='%s'",$area,$timestamp_start,$timestamp_end,$ave_distance_le,$ave_distance_t,$unit_price,$id);
	$res = mysql_query($sql, DbCon);
	if($res === false){
		echo "error!(update_unit_price_setting)";
		exit();
	}

	return true;
	exit();
}

function get_driver_remuneration_type_radio($remuneration_type){

	if( $remuneration_type == "1" ){

		$html .= '<input type="radio" name="remuneration_type" value="1" checked="checked">時給';
		$html .= '<input type="radio" name="remuneration_type" value="2">距離別';

	}else if( $remuneration_type == "2" ){

		$html .= '<input type="radio" name="remuneration_type" value="1">時給';
		$html .= '<input type="radio" name="remuneration_type" value="2" checked="checked">距離別';

	}else{

		$html .= '<input type="radio" name="remuneration_type" value="1">時給';
		$html .= '<input type="radio" name="remuneration_type" value="2">距離別';

	}

	return $html;
	exit();

}

//期間が、かぶっていないか、チェック
function check_period_for_settings_remuneration($year_start,$month_start,$day_start,$year_end,$month_end,$day_end,$staff_id){

	$timestamp_start = get_timestamp_by_year_month_day_2_common($year_start,$month_start,$day_start);
	$timestamp_end = get_timestamp_by_year_month_day_3_common($year_end,$month_end,$day_end);

	$sql = sprintf("
select id from settings_remuneration where
( ((period_start>='%s') and (period_start<='%s')) or ((period_end>='%s') and (period_end<='%s')) ) and
staff_id='%s' and
delete_flg=0",
$timestamp_start,$timestamp_end,$timestamp_start,$timestamp_end,$staff_id);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(check_period_for_settings_remuneration)";
		exit();

	}

	$num = mysql_num_rows($res);

	if( $num > 0 ){

		return true;
		exit();

	}else{

		return false;
		exit();

	}

}

function insert_settings_remuneration($value,$staff_id,$year_start,$month_start,$day_start,$year_end,$month_end,$day_end){

	$timestamp_start = get_timestamp_by_year_month_day_2_common($year_start,$month_start,$day_start);
	$timestamp_end = get_timestamp_by_year_month_day_3_common($year_end,$month_end,$day_end);

	$sql = sprintf("insert into settings_remuneration(value,staff_id,period_start,period_end) values('%s','%s','%s','%s')",$value,$staff_id,$timestamp_start,$timestamp_end);
	$res = mysql_query($sql, DbCon);
	if($res === false){
		echo "error!(insert_settings_remuneration)";
		exit();
	}

	return true;
	exit();
}

function delete_settings_remuneration($id){

	$sql = sprintf("update settings_remuneration set delete_flg='1' where id='%s'",$id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(delete_settings_remuneration)";
		exit();
	}

	return true;
	exit();
}

//期間が、かぶっていないか、チェック
function check_period_for_settings_remuneration_2($year_start,$month_start,$day_start,$year_end,$month_end,$day_end,$staff_id,$id){

	$timestamp_start = get_timestamp_by_year_month_day_2_common($year_start,$month_start,$day_start);
	$timestamp_end = get_timestamp_by_year_month_day_3_common($year_end,$month_end,$day_end);

	$sql = sprintf("
select id from settings_remuneration where
( ((period_start>='%s') and (period_start<='%s')) or ((period_end>='%s') and (period_end<='%s')) ) and
staff_id='%s' and
id<>'%s' and
delete_flg=0",
$timestamp_start,$timestamp_end,$timestamp_start,$timestamp_end,$staff_id,$id);

	//echo $sql;exit();

	$res = mysql_query($sql, DbCon);

	if($res == false){

		echo "error!(check_period_for_settings_remuneration_2)";
		exit();

	}

	$num = mysql_num_rows($res);

	if( $num > 0 ){

		return true;
		exit();

	}else{

		return false;
		exit();

	}

}

function update_settings_remuneration($value,$year_start,$month_start,$day_start,$year_end,$month_end,$day_end,$id){

	$timestamp_start = get_timestamp_by_year_month_day_2_common($year_start,$month_start,$day_start);
	$timestamp_end = get_timestamp_by_year_month_day_3_common($year_end,$month_end,$day_end);

	$sql = sprintf("update settings_remuneration set value='%s',period_start='%s',period_end='%s' where id='%s'",$value,$timestamp_start,$timestamp_end,$id);
	$res = mysql_query($sql, DbCon);
	if($res === false){
		echo "error!(update_settings_remuneration)";
		exit();
	}

	return true;
	exit();
}

function get_settings_remuneration_data($staff_id){

	$sql = sprintf("select * from settings_remuneration where delete_flg='0' and staff_id='%s' order by period_start desc",$staff_id);
	$res = mysql_query($sql, DbCon);
	if( $res == false ){
		echo "error!(get_settings_remuneration_data)";
		exit();
	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$period_start = $row["period_start"];
		$period_end = $row["period_end"];

		$time_data = get_year_month_day_from_timestamp_common($period_start);

		$year_start = $time_data["year"];
		$month_start = $time_data["month"];
		$day_start = $time_data["day"];

		$time_data = get_year_month_day_from_timestamp_common($period_end);

		$year_end = $time_data["year"];
		$month_end = $time_data["month"];
		$day_end = $time_data["day"];

		$list_data[$i] = $row;

		$list_data[$i]["year_start"] = $year_start;
		$list_data[$i]["month_start"] = $month_start;
		$list_data[$i]["day_start"] = $day_start;
		$list_data[$i]["year_end"] = $year_end;
		$list_data[$i]["month_end"] = $month_end;
		$list_data[$i]["day_end"] = $day_end;

		$i++;

	}

	return $list_data;
	exit();
}

function get_select_remuneration($select_value,$select_frm_name){

	include(COMMON_INC."menu.php");
	$html = get_select_frm_common($select_value,$select_frm_name,$menu_remuneration);

	return $html;
	exit();
}

function get_remuneration_type_disp($remuneration_type){

	if( $remuneration_type == "1" ){
		$data = "時給制";
	}else if( $remuneration_type == "2" ){
		$data = "距離制";
	}else if( $remuneration_type == "3" ){
		$data = "日給制";
	}else{
		$data = "未設定";
	}

	return $data;
	exit();

}

function get_csv_file_sale_therapist_one($year,$month,$therapist_id){

	$day_data = array();
	$x = 0;

	$last_day = get_month_last_day($year,$month);

	$therapist_data = get_therapist_data_by_id($therapist_id);

	$therapist_name = $therapist_data["name"];
	$jisou_flg = $therapist_data["jisou_flg"];
	$transport_cost = $therapist_data["transport_cost"];

	$kakutoku_point = 0;

	$title_data = array(
		"0"=>array("name"=>"day_disp","val"=>$therapist_name),
		"1"=>array("name"=>"sale_price","val"=>"売上"),
		"2"=>array("name"=>"sale_price_shijutsu","val"=>"施術売上"),
		"3"=>array("name"=>"remuneration","val"=>"報酬"),
		"4"=>array("name"=>"insurance_price_disp","val"=>"保険料"),
		"5"=>array("name"=>"remuneration_shiharai","val"=>"支払額"),
		"6"=>array("name"=>"allowance_jisou","val"=>"自走手当"),
		"7"=>array("name"=>"allowance","val"=>"手当"),
		"8"=>array("name"=>"pay_another","val"=>"立替金"),
		"9"=>array("name"=>"pay_finish","val"=>"清算済み"),
		"10"=>array("name"=>"pay_day","val"=>"日払い"),
		"11"=>array("name"=>"share_rate","val"=>"シェア率"),
		"12"=>array("name"=>"total_point","val"=>"累計pt"),
		"13"=>array("name"=>"kakutoku_point","val"=>"獲得pt"),
		"14"=>array("name"=>"pt_operation","val"=>"施術pt"),
		"15"=>array("name"=>"pt_shimei","val"=>"指名pt"),
		"16"=>array("name"=>"pt_repeat","val"=>"リピートpt"),
		"17"=>array("name"=>"repeater_num","val"=>"リピーター")
	);

	$title_data_num = count($title_data);

	/*
	echo "<pre>";
	print_r($title_data);
	echo "</pre>";
	exit();
	*/

	for($i=1;$i<=$last_day;$i++){

		$pre_day_flg = false;

		$day = $i;

		$sale_not_edit_flg = check_sale_not_edit_day_common($year,$month,$day);

		$timestamp = get_timestamp_by_year_month_day_common($year,$month,$day);

		$point_past_flg = get_point_past_flg($year,$month,$day);

		if( $timestamp < $timestamp_now ){

			$pre_day_flg = true;

		}

		$data = get_attendance_data_work_common($therapist_id,$year,$month,$day);
		$attendance_id = $data["id"];
		$pay_another = $data["pay_another"];
		$pay_finish = $data["pay_finish"];
		$pay_day = $data["pay_day"];
		$allowance = $data["allowance"];
		$allowance_jisou = 0;

		if( $attendance_id != "" ){

			$insurance = get_insurance_common($therapist_id,$year,$month,$day);

			$insurance_price = 0;
			$insurance_price_disp = 0;
			if( $insurance == "2" ){
				$board_num = get_reservation_for_board_num_by_attendance_id_common($attendance_id);
				$insurance_price = 50 * $board_num;
				$insurance_price_disp = $insurance_price * (-1);
			}

			//remuneration_therapistから取得
			$data_tmp = get_remuneration_therapist_by_day_common($therapist_id,$year,$month,$day);

			if( $data_tmp["id"] != "" ){

				$pay_another = $data_tmp["pay_another"];
				$total_point = $data_tmp["total_point"];
				$allowance_jisou = $data_tmp["allowance_jisou"];
				$sale_price = $data_tmp["sale_price"];
				$sale_price_shijutsu = $data_tmp["sale_price_shijutsu"];
				$pt_repeat = $data_tmp["pt_repeat"];
				$pt_operation = $data_tmp["pt_operation"];
				$pt_shimei = $data_tmp["pt_shimei"];
				$kakutoku_point = $data_tmp["kakutoku_point"];
				$share_rate = $data_tmp["share_rate"];
				$remuneration = $data_tmp["remuneration"];

			}else{

				if( ( $pay_another == "0" ) && ( $transport_cost != "0" ) ){
					$pay_another = $transport_cost;
					//pay_anotherの更新
					update_pay_another_by_attendance_id($pay_another,$attendance_id);
				}
				$total_point = get_total_point_by_therapist_id_common($therapist_id,$year,$month,$day);
				if( $jisou_flg == "1" ){
					$allowance_jisou = get_allowance_therapist_common($year,$month,$day,$attendance_id);
				}
				$sale_price = get_sokuhou_price_area_by_therapist_id($year,$month,$day,$area,$therapist_id);
//echo $sale_price . " = get_sokuhou_price_area_by_therapist_id(" . $year . "," . $month . "," . $day . "," . $area . "," . $therapist_id . ")<br />";

				$sale_price_shijutsu = get_sale_price_shijutsu($year,$month,$day,$area,$attendance_id,$sale_price);
				$data = get_therapist_point_by_attendance_id_common($attendance_id);
				$pt_repeat = $data["pt_repeat"];
				$pt_operation = $data["pt_operation"];
				$pt_shimei = $data["pt_shimei"];
				$kakutoku_point = $pt_repeat + $pt_operation + $pt_shimei;
				if($therapist_data["area"]=="tokyo_reraku"){
					$share_rate = $therapist_data["share_rate"] * 100;
				}
				else{
					$share_rate = get_share_rate_by_attendance_id_common($attendance_id);
				}

				$remuneration_data = get_therapist_remuneration_by_attendance_id_common($attendance_id);
				$remuneration = $remuneration_data["remuneration"];

			}

			$repeat_point_data = get_repeat_point_data_by_attendance_id($attendance_id);
			$repeater_num = $repeat_point_data["num"];

			if( $share_rate == "-1" ){

				$share_rate = "---";

			}

			$remuneration_shiharai = $remuneration - $insurance_price;

			if( $share_rate=="50" ){

				$share_rate = $share_rate;
				$total_point = "-";
				$kakutoku_point = "-";
				$pt_operation = "-";
				$pt_shimei = "-";
				$pt_repeat = "-";

			}

			$day_disp = $month.'月'.$i.'日';

			$day_data[$x]["year"] = $year;
			$day_data[$x]["month"] = $month;
			$day_data[$x]["day"] = $i;
			$day_data[$x]["day_disp"] = $day_disp;
			$day_data[$x]["sale_price"] = $sale_price;
			$day_data[$x]["sale_price_shijutsu"] = $sale_price_shijutsu;
			$day_data[$x]["remuneration"] = $remuneration;
			$day_data[$x]["insurance_price_disp"] = $insurance_price_disp;
			$day_data[$x]["remuneration_shiharai"] = $remuneration_shiharai;
			$day_data[$x]["allowance_jisou"] = $allowance_jisou;
			$day_data[$x]["allowance"] = $allowance;
			$day_data[$x]["pay_another"] = $pay_another;
			$day_data[$x]["pay_finish"] = $pay_finish;
			$day_data[$x]["pay_day"] = $pay_day;
			$day_data[$x]["share_rate"] = $share_rate;
			$day_data[$x]["total_point"] = $total_point;
			$day_data[$x]["kakutoku_point"] = $kakutoku_point;
			$day_data[$x]["pt_operation"] = $pt_operation;
			$day_data[$x]["pt_shimei"] = $pt_shimei;
			$day_data[$x]["pt_repeat"] = $pt_repeat;
			$day_data[$x]["repeater_num"] = $repeater_num;

			$x++;
		}

	}

	/*
	echo "<pre>";
	print_r($day_data);
	echo "</pre>";
	exit();
	*/

	$csv = "";

	for( $i=0; $i<$title_data_num; $i++ ){

		$title_data_tmp = $title_data[$i];

		$csv .= get_csv_file_sale_therapist_one_small($title_data_tmp,$day_data);

	}

	return $csv;
	exit();

}

function get_csv_file_sale_therapist_one_small($title_data,$day_data){

	$name = $title_data["name"];
	$val = $title_data["val"];

	$csv .= "\"".$val."\"".",";

	$day_data_num = count($day_data);

	for( $i=0; $i<$day_data_num; $i++ ){

		$tmp = $day_data[$i][$name];

		if( $i == ($day_data_num-1) ){
			$csv .= "\"".$tmp."\""."\n";
		}else{
			$csv .= "\"".$tmp."\"".",";
		}

	}

	return $csv;
	exit();

}

function check_exist_therapist_id_for_sale_therapist_month($therapist_id,$attendance_new_data){

	$attendance_new_data_num = count($attendance_new_data);

	for( $i=0; $i<$attendance_new_data_num; $i++ ){

		$therapist_id_tmp = $attendance_new_data[$i]["therapist_id"];

		if( $therapist_id == $therapist_id_tmp ){

			return true;
			exit();

		}

	}

	return false;
	exit();

}

function get_select_frm_year($year){

	$html = '<select name="year">';
	$html .= '<option value="-1">未選択</option>';

	for( $i=2015; $i<2035; $i++ ){

		if( $i == $year ){

			$html .= sprintf('<option value="%s" selected>%s年</option>',$i,$i);

		}else{

			$html .= sprintf('<option value="%s">%s年</option>',$i,$i);

		}

	}

	$html .= '</select>';

	return $html;
	exit();

}

function get_select_frm_month($month){

	$html = '<select name="month">';
	$html .= '<option value="-1">未選択</option>';

	for( $i=1; $i<13; $i++ ){

		if( $i == $month ){

			$html .= sprintf('<option value="%s" selected>%s月</option>',$i,$i);

		}else{

			$html .= sprintf('<option value="%s">%s月</option>',$i,$i);

		}

	}

	$html .= '</select>';

	return $html;
	exit();

}

function update_therapist_new_leave_flg_on_return($therapist_id){

	$sql = sprintf("update therapist_new set delete_flg='0',test_flg='0',leave_flg='1' where id='%s'",$therapist_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "error!(update_therapist_new_leave_flg_on_return)";
		exit();
	}

	return true;
	exit();
}

function get_data_for_data_output_instruction_by_area($year,$month,$day,$shop_area){

	$therapist_remuneration_all = 0;
	$price_all = 0;
	$card_commission_all = 0;
	$gross_profit_all = 0;
	$shop_boss_remuneration_all = 0;
	$driver_remuneration_all = 0;
	$movement_cost_all = 0;
	$driver_gasoline_all = 0;
	$driver_parking_all = 0;
	$lowest_guarantee_all = 0;
	$driver_allowance_all = 0;
	$driver_highway_all = 0;
	$driver_pay_finish_all = 0;
	$driver_sonota_all = 0;
	$genkin_price_all = 0;
	$card_price_all = 0;
	$pay_day_therapist_all = 0;
	$therapist_remuneration_mibarai_all = 0;
	$allowance_therapist_all = 0;
	$pay_day_driver_all = 0;
	$driver_remuneration_mibarai_all = 0;
	$therapist_remuneration_sum_all = 0;
	$driver_remuneration_sum_all = 0;
	$office_remuneration_mibarai_all = 0;
	$pay_day_office_all = 0;
	$office_allowance_all = 0;
	$office_remuneration_sum_all = 0;

	$shop_data = get_shop_data($shop_area);

	$shop_data_num = count($shop_data);

	for($i=0;$i<$shop_data_num;$i++){

		$shop_name = $shop_data[$i]["name"];

		$data = get_sale_shop_data_day_common($year,$month,$day,$shop_name,$shop_area);

		$genkin_price = $data["genkin_price"];
		$card_price = $data["card_price"];
		$card_commission = $data["card_commission"];
		$therapist_remuneration = $data["therapist_remuneration"];
		$pay_day_therapist = $data["pay_day_therapist"];
		$therapist_remuneration_mibarai = $data["therapist_remuneration_mibarai"];
		$allowance_jisou = $data["allowance_jisou"];
		$allowance_therapist = $data["allowance_therapist"];
		$driver_remuneration = $data["driver_remuneration"];
		$driver_gasoline = $data["driver_gasoline"];
		$driver_parking = $data["driver_parking"];
		$driver_allowance = $data["driver_allowance"];
		$driver_highway = $data["driver_highway"];
		$driver_pay_finish = $data["driver_pay_finish"];
		$lowest_guarantee = $data["lowest_guarantee"];
		$therapist_remuneration_sum = $data["therapist_remuneration_sum"];
		$pay_day_driver = $data["pay_day_driver"];
		$driver_remuneration_mibarai = $data["driver_remuneration_mibarai"];
		$driver_remuneration_sum = $data["driver_remuneration_sum"];
		$movement_cost = $data["movement_cost"];
		$shop_boss_remuneration = $data["shop_boss_remuneration"];
		$driver_sonota = $data["driver_sonota"];
		$gross_profit = $data["gross_profit"];
		$office_remuneration_mibarai = $data["office_remuneration_mibarai"];
		$pay_day_office = $data["pay_day_office"];
		$office_allowance = $data["office_allowance"];
		$office_remuneration_sum = $data["office_remuneration_sum"];

		$genkin_price_all = $genkin_price_all + $genkin_price;
		$card_price_all = $card_price_all + $card_price;
		$price_all = $price_all + $genkin_price + $card_price;
		$card_commission_all = $card_commission_all + $card_commission;
		$pay_day_therapist_all = $pay_day_therapist_all + $pay_day_therapist;
		$therapist_remuneration_mibarai_all = $therapist_remuneration_mibarai_all + $therapist_remuneration_mibarai;
		$allowance_therapist_all = $allowance_therapist_all + $allowance_therapist;
		$therapist_remuneration_sum_all = $therapist_remuneration_sum_all + $therapist_remuneration_sum;
		$driver_remuneration_sum_all = $driver_remuneration_sum_all + $driver_remuneration_sum;
		$lowest_guarantee_all = $lowest_guarantee_all + $lowest_guarantee;
		$pay_day_driver_all = $pay_day_driver_all + $pay_day_driver;
		$therapist_remuneration_all = $therapist_remuneration_all + $therapist_remuneration;
		$driver_remuneration_mibarai_all = $driver_remuneration_mibarai_all + $driver_remuneration_mibarai;
		$driver_remuneration_all = $driver_remuneration_all + $driver_remuneration;
		$movement_cost_all = $movement_cost_all + $movement_cost;
		$driver_gasoline_all = $driver_gasoline_all + $driver_gasoline;
		$driver_parking_all = $driver_parking_all + $driver_parking;
		$driver_allowance_all = $driver_allowance_all + $driver_allowance;
		$driver_highway_all = $driver_highway_all + $driver_highway;
		$driver_pay_finish_all = $driver_pay_finish_all + $driver_pay_finish;
		$office_remuneration_mibarai_all = $office_remuneration_mibarai_all + $office_remuneration_mibarai;
		$pay_day_office_all = $pay_day_office_all + $pay_day_office;
		$office_allowance_all = $office_allowance_all + $office_allowance;
		$office_remuneration_sum_all = $office_remuneration_sum_all + $office_remuneration_sum;
		$shop_boss_remuneration_all = $shop_boss_remuneration_all + $shop_boss_remuneration;
		$driver_sonota_all = $driver_sonota_all + $driver_sonota;
		$gross_profit_all = $gross_profit_all + $gross_profit;

	}

	$return_data["genkin_price"] = $genkin_price_all;
	$return_data["card_price"] = $card_price_all;
	$return_data["price"] = $price_all;
	$return_data["card_commission"] = $card_commission_all;
	$return_data["pay_day_therapist"] = $pay_day_therapist_all;
	$return_data["therapist_remuneration_mibarai"] = $therapist_remuneration_mibarai_all;
	$return_data["allowance_therapist"] = $allowance_therapist_all;
	$return_data["therapist_remuneration_sum"] = $therapist_remuneration_sum_all;
	$return_data["driver_remuneration_sum"] = $driver_remuneration_sum_all;
	$return_data["lowest_guarantee"] = $lowest_guarantee_all;
	$return_data["pay_day_driver"] = $pay_day_driver_all;
	$return_data["therapist_remuneration"] = $therapist_remuneration_all;
	$return_data["driver_remuneration_mibarai"] = $driver_remuneration_mibarai_all;
	$return_data["driver_remuneration"] = $driver_remuneration_all;
	$return_data["movement_cost"] = $movement_cost_all;
	$return_data["driver_gasoline"] = $driver_gasoline_all;
	$return_data["driver_parking"] = $driver_parking_all;
	$return_data["driver_allowance"] = $driver_allowance_all;
	$return_data["driver_highway"] = $driver_highway_all;
	$return_data["driver_pay_finish"] = $driver_pay_finish_all;
	$return_data["office_remuneration_mibarai"] = $office_remuneration_mibarai_all;
	$return_data["pay_day_office"] = $pay_day_office_all;
	$return_data["office_allowance"] = $office_allowance_all;
	$return_data["office_remuneration_sum"] = $office_remuneration_sum_all;
	$return_data["shop_boss_remuneration"] = $shop_boss_remuneration_all;
	$return_data["driver_sonota"] = $driver_sonota_all;
	$return_data["gross_profit"] = $gross_profit_all;

	return $return_data;
	exit();

}

function get_list_data_for_data_output_instruction($tokyo,$yokohama,$sapporo,$sendai,$tokyo_reraku,$tokyo_bigao){

	$price_all = $tokyo["price"]+$yokohama["price"]+$sapporo["price"]+$sendai["price"]+$tokyo_reraku["price"]+$tokyo_bigao["price"];

	$tokyo["therapist_remuneration"] = $tokyo["therapist_remuneration_sum"] - $tokyo["lowest_guarantee"];
	$yokohama["therapist_remuneration"] = $yokohama["therapist_remuneration_sum"] - $yokohama["lowest_guarantee"];
	$sapporo["therapist_remuneration"] = $sapporo["therapist_remuneration_sum"] - $sapporo["lowest_guarantee"];
	$sendai["therapist_remuneration"] = $sendai["therapist_remuneration_sum"] - $sendai["lowest_guarantee"];
	$tokyo_reraku["therapist_remuneration"] = $tokyo_reraku["therapist_remuneration_sum"] - $tokyo_reraku["lowest_guarantee"];
	$tokyo_bigao["therapist_remuneration"] = $tokyo_bigao["therapist_remuneration_sum"] - $tokyo_bigao["lowest_guarantee"];

	$list_data = array(
			0=>array('売上','東京',number_format($tokyo["price"])),
			1=>array('','横浜',number_format($yokohama["price"])),
			2=>array('','札幌',number_format($sapporo["price"])),
			3=>array('','仙台',number_format($sendai["price"])),
			4=>array('','東京リラク',number_format($tokyo_reraku["price"])),
			5=>array('','リフレッシュ東京',number_format($tokyo_bigao["price"])),
			6=>array('','売上合計',number_format($price_all)),
		7=>array('','全体粗利益',''),
		8=>array('','事業部コスト',''),
		9=>array('','事業部純利益',''),
		10=>array('東京','',''),
			11=>array('セラピスト報酬','セラピスト報酬',number_format($tokyo["therapist_remuneration"])),
			12=>array('','セラピスト保障',number_format($tokyo["lowest_guarantee"])),
			13=>array('ドライバー報酬','ドライバー報酬',number_format($tokyo["driver_remuneration"])),
			14=>array('移動費','ガソリン代',number_format($tokyo["driver_gasoline"])),
			15=>array('','高速代',number_format($tokyo["driver_highway"])),
			16=>array('','駐車場代',number_format($tokyo["driver_parking"])),
			17=>array('','タクシー代',number_format($tokyo["movement_cost"])),
		18=>array('地代家賃','市ヶ谷家賃',''),
		19=>array('','神楽坂家賃',''),
		20=>array('','渋谷家賃',''),
		21=>array('消耗品','消耗品購入',''),
		22=>array('水道光熱費','市ヶ谷・神楽坂・渋谷',''),
		23=>array('広告宣伝費','google',''),
		24=>array('','yahoo',''),
		25=>array('','その他メディア',''),
		26=>array('求人広告宣伝費','リジョブ',''),
		27=>array('','google',''),
		28=>array('','その他（紹介含む）',''),
			29=>array('カード決済手数料','',number_format($tokyo["card_commission"])),
		30=>array('外注費','中村幸江',''),
		31=>array('研修費','東京コスト合計',''),
		32=>array('','東京粗利益',''),
		33=>array('','東京粗利益率',''),
		34=>array('横浜','',''),
			35=>array('セラピスト報酬','セラピスト報酬',number_format($yokohama["therapist_remuneration"])),
			36=>array('','セラピスト保障',number_format($yokohama["lowest_guarantee"])),
			37=>array('ドライバー報酬','ドライバー報酬',number_format($yokohama["driver_remuneration"])),
			38=>array('移動費','ガソリン代',number_format($yokohama["driver_gasoline"])),
			39=>array('','高速代',number_format($yokohama["driver_highway"])),
			40=>array('','駐車場代',number_format($yokohama["driver_parking"])),
			41=>array('','タクシー代',number_format($yokohama["movement_cost"])),
		42=>array('地代家賃','横浜家賃',''),
		43=>array('消耗品','消耗品購入',''),
		44=>array('水道光熱費','横浜',''),
		45=>array('広告宣伝費','google',''),
		46=>array('','yahoo',''),
		47=>array('','その他メディア',''),
		48=>array('求人広告宣伝費','リジョブ',''),
		49=>array('','google',''),
		50=>array('','その他（紹介含む）',''),
			51=>array('カード決済手数料','',number_format($yokohama["card_commission"])),
		52=>array('外注費','',''),
			53=>array('店長報酬','',number_format($yokohama["shop_boss_remuneration"])),
		54=>array('','横浜コスト合計',''),
		55=>array('','横浜粗利益',''),
		56=>array('','横浜粗利益率',''),
		57=>array('札幌','',''),
			58=>array('セラピスト報酬','セラピスト報酬',number_format($sapporo["therapist_remuneration"])),
			59=>array('','セラピスト保障',number_format($sapporo["lowest_guarantee"])),
			60=>array('ドライバー報酬','ドライバー報酬',number_format($sapporo["driver_remuneration"])),
			61=>array('移動費','ガソリン代',number_format($sapporo["driver_gasoline"])),
			62=>array('','高速代',number_format($sapporo["driver_highway"])),
			63=>array('','駐車場代',number_format($sapporo["driver_parking"])),
			64=>array('','タクシー代',number_format($sapporo["movement_cost"])),
		65=>array('地代家賃','札幌家賃',''),
		66=>array('消耗品','消耗品購入',''),
		67=>array('水道光熱費','札幌',''),
		68=>array('広告宣伝費','google',''),
		69=>array('','yahoo',''),
		70=>array('','その他メディア',''),
		71=>array('求人広告宣伝費','リジョブ',''),
		72=>array('','google',''),
		73=>array('','その他（紹介含む）',''),
			74=>array('カード決済手数料','',number_format($sapporo["card_commission"])),
		75=>array('外注費','',''),
			76=>array('店長報酬','',number_format($sapporo["shop_boss_remuneration"])),
		77=>array('','札幌コスト合計',''),
		78=>array('','札幌粗利益',''),
		79=>array('','札幌粗利益率',''),
		80=>array('仙台','',''),
			81=>array('セラピスト報酬','セラピスト報酬',number_format($sendai["therapist_remuneration"])),
			82=>array('','セラピスト保障',number_format($sendai["lowest_guarantee"])),
			83=>array('ドライバー報酬','ドライバー報酬',number_format($sendai["driver_remuneration"])),
			84=>array('移動費','ガソリン代',number_format($sendai["driver_gasoline"])),
			85=>array('','高速代',number_format($sendai["driver_highway"])),
			86=>array('','駐車場代',number_format($sendai["driver_parking"])),
			87=>array('','タクシー代',number_format($sendai["movement_cost"])),
		88=>array('地代家賃','仙台家賃',''),
		89=>array('消耗品','消耗品購入',''),
		90=>array('水道光熱費','仙台',''),
		91=>array('広告宣伝費','google',''),
		92=>array('','yahoo',''),
		93=>array('','その他メディア',''),
		94=>array('求人広告宣伝費','リジョブ',''),
		95=>array('','google',''),
		96=>array('','その他（紹介含む）',''),
			97=>array('カード決済手数料','',number_format($sendai["card_commission"])),
		98=>array('外注費','',''),
			99=>array('店長報酬','',number_format($sendai["shop_boss_remuneration"])),
		100=>array('','仙台コスト合計',''),
		101=>array('','仙台粗利益',''),
		102=>array('','仙台粗利益率',''),
		103=>array('東京リラクヘッド','',''),
			104=>array('セラピスト報酬','セラピスト報酬',number_format($tokyo_reraku["therapist_remuneration"])),
			105=>array('','セラピスト保障',number_format($tokyo_reraku["lowest_guarantee"])),
			106=>array('ドライバー報酬','ドライバー報酬',number_format($tokyo_reraku["driver_remuneration"])),
			107=>array('移動費','ガソリン代',number_format($tokyo_reraku["driver_gasoline"])),
			108=>array('','高速代',number_format($tokyo_reraku["driver_highway"])),
			109=>array('','駐車場代',number_format($tokyo_reraku["driver_parking"])),
			110=>array('','タクシー代',number_format($tokyo_reraku["movement_cost"])),
		111=>array('地代家賃','',''),
		112=>array('消耗品','消耗品購入',''),
		113=>array('水道光熱費','',''),
		114=>array('広告宣伝費','google',''),
		115=>array('','yahoo',''),
		116=>array('','その他メディア',''),
		117=>array('求人広告宣伝費','リジョブ',''),
		118=>array('','google',''),
		119=>array('','その他（紹介含む）',''),
			120=>array('カード決済手数料','',number_format($tokyo_reraku["card_commission"])),
		121=>array('外注費','',''),
		122=>array('人件費','稲葉',''),
		123=>array('','東京RHコスト合計',''),
		124=>array('','RH粗利益',''),
		125=>array('','RH粗利益率',''),
		126=>array('','事業部コスト',''),
		127=>array('リフレッシュ東京','',''),
			128=>array('セラピスト報酬','セラピスト報酬',number_format($tokyo_bigao["therapist_remuneration"])),
			129=>array('','セラピスト保障',number_format($tokyo_bigao["lowest_guarantee"])),
			130=>array('ドライバー報酬','ドライバー報酬',number_format($tokyo_bigao["driver_remuneration"])),
			131=>array('移動費','ガソリン代',number_format($tokyo_bigao["driver_gasoline"])),
			132=>array('','高速代',number_format($tokyo_bigao["driver_highway"])),
			133=>array('','駐車場代',number_format($tokyo_bigao["driver_parking"])),
			134=>array('','タクシー代',number_format($tokyo_bigao["movement_cost"])),
		135=>array('地代家賃','',''),
		136=>array('消耗品','消耗品購入',''),
		137=>array('水道光熱費','',''),
		138=>array('広告宣伝費','google',''),
		139=>array('','yahoo',''),
		140=>array('','その他メディア',''),
		141=>array('求人広告宣伝費','リジョブ',''),
		142=>array('','google',''),
		143=>array('','その他（紹介含む）',''),
			144=>array('カード決済手数料','',number_format($tokyo_bigao["card_commission"])),
		145=>array('外注費','',''),
		146=>array('人件費','稲葉',''),
		147=>array('','リフレッシュ東京コスト合計',''),
		148=>array('','リフレッシュ東京粗利益',''),
		149=>array('','リフレッシュ東京粗利益率',''),
		150=>array('','事業部コスト',''),


		151=>array('人件費','給与',''),
			152=>array('','運営スタッフ',number_format($tokyo["office_remuneration_sum"])),
		153=>array('外注費','南川',''),
		154=>array('','押尾',''),
		155=>array('','NG広告手数料',''),
		156=>array('','NGコンサル',''),
		157=>array('','NG経理代行',''),
		158=>array('','その他',''),
		159=>array('法定福利費','',''),
		160=>array('地代家賃','社宅/駐車場',''),
		161=>array('広告宣伝費','宣伝費',''),
		162=>array('','求人費',''),
		163=>array('交通費','出勤交通費',''),
		164=>array('','出張交通費',''),
		165=>array('通信費','CTI利用料',''),
		166=>array('','通信費',''),
		167=>array('備品購入','',''),
		168=>array('振り込み手数料','',''),
		169=>array('接待交際費','',''),
		170=>array('車両運搬具','BMW',''),
		171=>array('事業部コスト合計','',''),
		172=>array('純利益','',''),

	);

	return $list_data;
	exit();

}

function get_csv_for_data_output_instruction($list_data){

	$list_data_num = count($list_data);

	$csv = "";

	for( $i=0; $i<$list_data_num; $i++ ){

		$data_1 = $list_data[$i][0];
		$data_2 = $list_data[$i][1];
		$data_3 = $list_data[$i][2];

		$csv .= "\"".$data_1."\"".",";
		$csv .= "\"".$data_2."\"".",";
		$csv .= "\"".$data_3."\""."\n";

	}

	return $csv;
	exit();

}

function get_therapist_meeting_place_html_for_therapist_edit_input_new($therapist_id){

	$html = "";

	$place_data = get_therapist_meeting_place_data($therapist_id);
	$place_data_num = count($place_data);

	for( $i=0; $i<$place_data_num; $i++ ){

		$id = $place_data[$i]["id"];
		$content = $place_data[$i]["content"];
$html.=<<<EOT
<div class="meeting_place_for_therapist_edit">
<div class="left_1">{$content}</div>
<div class="left_2">
<input type="button" value="削除" onclick="do_therapist_meeting_place_delete({$id});" />
</div>
<br class="clear" />
</div>
EOT;

	}

$html.=<<<EOT
<div class="meeting_place_for_therapist_edit">
<div class="left_1">
<input type="text" name="therapist_meeting_place" value="" />
</div>
<div class="left_2">
<input type="button" value="追加" onclick="do_therapist_meeting_place_add();" />
</div>
<br class="clear" />
</div>
EOT;

	return $html;
	exit();

}

function get_therapist_meeting_place_data($therapist_id){

	$sql = sprintf("select * from therapist_meeting_place where delete_flg='0' and therapist_id='%s'",$therapist_id);
	$res = mysql_query($sql, DbCon);
	if( $res == false ){
		echo "error!(get_therapist_meeting_place_data)";
		exit();
	}

	$i=0;
	$list_data = array();

	while($row = mysql_fetch_assoc($res)){

		$list_data[$i] = $row;
		$i++;

	}

	return $list_data;
	exit();
}

function delete_therapist_meeting_place($therapist_meeting_place_id){

	$sql = sprintf("update therapist_meeting_place set delete_flg='1' where id='%s'",$therapist_meeting_place_id);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリー実行で失敗しました(delete_therapist_meeting_place)";
		exit();
	}

	return true;
	exit();
}

function add_therapist_meeting_place($therapist_id,$therapist_meeting_place){

	$sql = sprintf("insert into therapist_meeting_place(therapist_id,content) values('%s','%s')",$therapist_id,$therapist_meeting_place);
	$res = mysql_query($sql, DbCon);
	if($res === false){
		echo "error!(add_therapist_meeting_place)";
		exit();
	}

	return true;
	exit();
}

//============================================================================

//時間行のデータを取得　/include/functions.phpとバッテング
function get_time_line_data($today_time_num){

	$time_line_data = array(
					    "1" => "18:00",
						"2" => "18:30",
						"3" => "19:00",
						"4" => "19:30",
						"5" => "20:00",
						"6" => "20:30",
						"7" => "21:00",
						"8" => "21:30",
						"9" => "22:00",
						"10" => "22:30",
						"11" => "23:00",
						"12" => "23:30",
						"13" => "0:00",
						"14" => "0:30",
						"15" => "1:00",
						"16" => "1:30",
						"17" => "2:00",
						"18" => "2:30",
						"19" => "3:00",
						"20" => "3:30",
						"21" => "4:00",
						"22" => "4:30",
						"23" => "5:00"
	);

	return $time_line_data;
	exit();
}
?>
