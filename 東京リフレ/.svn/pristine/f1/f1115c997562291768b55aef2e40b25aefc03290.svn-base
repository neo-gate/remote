<?php

include("include/common.php");



$error = "";
$driver_id= "-1";
$money_bag_type = "1";

$ch = $_GET["ch"];
$therapist_id = $_GET["id"];
$area = $_GET["area"];

$result = therapist_shift_page_access_check($therapist_id,$ch);
if( $result == false ){
	echo "error!";
	exit();
}

if( isset($_POST["send_back"]) == true ){

	$top_url = get_top_url($area,$therapist_id,$ch);

	header("Location: ".$top_url);
	exit();

}else if( isset($_POST["send_confirm"]) == true ){

	/*
	echo "<pre>";
	print_r($_POST);
	echo "</pre>";
	exit();
	*/
	$chkprice = $_POST["chkprice"];
	$chkspdprice = $_POST["chkspdprice"];
	$priceTotal = $_POST["priceTotal"];
	$check_confirm = $_POST["check_confirm"];
	$money_bag_type = $_POST["money_bag_type"];
	$driver_id = $_POST["driver_id"];
	$kanso = $_POST["kanso"];

	if( $check_confirm != "1" ){

		$error = '<span style="color:red;">移動実費のチェックが入っていません</span>';

	}else{

		if( $money_bag_type == "2" ){

			if( $driver_id == "-1" ){

				$error = '<span style="color:red;">ドライバーが選択されていません</span>';

			}

		}

	}

	if( $error == "" ){
		$_SESSION["chkprice"] = $chkprice;
		$_SESSION["chkspdprice"] = $chkspdprice;
		$_SESSION["priceTotal"] = $priceTotal;
		$_SESSION["work_end_check_confirm"] = $check_confirm;
		$_SESSION["work_end_money_bag_type"] = $money_bag_type;
		$_SESSION["work_end_driver_id"] = $driver_id;
		$_SESSION["work_end_kanso"] = $kanso;

		$url = sprintf("work_end_confirm.php?area=%s&id=%s&ch=%s",$area,$therapist_id,$ch);

		header('Location: '.$url);
		exit();

	}

}else if( isset($_GET["back"]) == true ){

	$chkprice = $_SESSION["chkprice"];
	$chkspdprice = $_SESSION["chkspdprice"];
	$priceTotal = $_POST["priceTotal"];
	$check_confirm = $_SESSION["work_end_check_confirm"];
	$money_bag_type = $_SESSION["work_end_money_bag_type"];
	$driver_id = $_SESSION["work_end_driver_id"];
	$kanso = $_SESSION["work_end_kanso"];

}

$therapist_name = get_therapist_name_by_therapist_id_honmyou($therapist_id, $area);

$top_url = get_top_url($area,$therapist_id,$ch);

$reservation_data = get_reservation_for_board_data_today($therapist_id);
$reservation_data_num = count($reservation_data);
$price_all = 0;

for($i=0;$i<$reservation_data_num;$i++){
	$price_name = '売上';
	$price_tmp = $reservation_data[$i]["price"];
	$price_all = $price_all + $price_tmp;
}

$movement_cost_data = get_movement_cost_data_today($therapist_id);
$movement_cost_data_num = count($movement_cost_data);
$cost_value_all = 0;
for($i=0;$i<$movement_cost_data_num;$i++){
	$cost_value_tmp = $movement_cost_data[$i]["cost_value"];
	$cost_value_all = $cost_value_all + $cost_value_tmp;
}

$driver_data = get_today_driver_data_2($area);

$driver_select_frm = get_select_frm_for_work_end($driver_id,$driver_data);



/*
echo "<pre>";
print_r($movement_cost_data);
echo "</pre>";
exit();
*/

$params['chkprice'] = $chkprice;
$params['chkspdprice'] = $chkspdprice;
$params['priceTotal'] = $priceTotal;
$params['reservation_data'] = $reservation_data;
$params['therapist_name'] = $therapist_name;
$params['area'] = $area;
$params['therapist_id'] = $therapist_id;
$params['year'] = $year;
$params['month'] = $month;
$params['ch'] = $ch;
$params['page_title'] = $therapist_name."さんのページ";
$params['top_url'] = $top_url;
$params['movement_cost_data'] = $movement_cost_data;
$params['price_all'] = number_format($price_all);
$params['cost_value_all'] = number_format($cost_value_all);
$params['driver_select_frm'] = $driver_select_frm;

$params['check_confirm'] = $check_confirm;
$params['money_bag_type'] = $money_bag_type;
$params['driver_id'] = $driver_id;
$params['kanso'] = $kanso;

$params['error'] = $error;



$smarty->assign( 'params', $params );

$smarty->assign( 'content_tpl', 'sp/work_end.tpl' );
$smarty->display( 'sp/template2.tpl' );

?>
