<?php

include("../../include/common.php");
include(ROOT_PATH."include/vip/auth.php");

$shop_id = $_SESSION["shop_id"];
$year = $_SESSION["year"];
$month = $_SESSION["month"];
$day = $_SESSION["day"];
$time = $_SESSION["time"];
$therapist_id = $_SESSION["therapist_id"];
$course = $_SESSION["course"];
$free = $_SESSION["free"];
$mail = $_SESSION["mail"];

$customer_id = $_SESSION["customer_id"];
$customer_name = $_SESSION["customer_name"];

$week = date("w", mktime(0, 0, 0, $month, $day, $year));

if($therapist_id == -1){
	
	$therapist_name = "指定なし";
	
}else{
	
	$therapist_name = get_therapist_name_by_therapist_id_common($therapist_id);
	
}

if(isset($_POST["send"])==true){

	$shop_id = $_SESSION["shop_id"];
	$year = $_SESSION["year"];
	$month = $_SESSION["month"];
	$day = $_SESSION["day"];
	$time = $_SESSION["time"];
	$therapist_id = $_SESSION["therapist_id"];
	$course = $_SESSION["course"];
	$free = $_SESSION["free"];
	$mail = $_SESSION["mail"];
	
	//顧客の電話番号を取得
	$customer_tel = get_customer_tel_for_vip_page($customer_id);
	
	$shop_area = "tokyo";
	
	$result = vip_page_confirm_action_common(
$mail,$customer_id,$time_array,$time,$access_type,$customer_name,$year,$month,$day,$week_array,
$week,$mail_hour,$minute,$course,$therapist_name,$customer_tel,$free,$shop_area);
	
	if( $result == true ){
		
		header("Location: ".$url_root."vip/reservation/complete.php");
		exit();
		
	}else{
		
		$error = "送信失敗しました。もうしわけありませんが再度送信をお願い致します。";
		
	}

}else if(isset($_POST["back"])==true){

	header("Location: ".$url_root."vip/reservation/input.php?back=true");
	exit();

}

$nichizi = "";
if($time_array[$time]["minute"]=='0'){
	$minute = "00";
}else{
	$minute = $time_array[$time]["minute"];
}

$hour = $time_array[$time]["hour"];

if( $hour < 10 ){
	
	$hour = $hour + 24;
	
}
	
$nichizi .= $month."/".$day."(".$week_array[$week].")&nbsp;&nbsp;".$hour.":".$minute."&nbsp;&nbsp;スタート";

$pankuzu = '　＞　<a href="'.$url_root.'vip/therapist_calendar.php">セラピスト出勤カレンダー</a>　＞　予約フォーム入力　＞　確認';

$params['pankuzu'] = $pankuzu;

$params['customer_name'] = $customer_name;
$params['nichizi'] = $nichizi;
$params['course'] = $course;
$params['therapist_name'] = $therapist_name;
$params['therapist_id'] = $therapist_id;
$params['free'] = $free;
$params['mail'] = $mail;
$params['error'] = $error;

$smarty->assign( 'params', $params );

if($access_type=="sp"){

	$content_tpl_path = sprintf("file:%ssp/vip/reservation/confirm.tpl",COMMON_TEMPLATES);
	$smarty->assign( 'content_tpl', $content_tpl_path );
	$smarty->display( 'sp/template.tpl' );

}else{

	$content_tpl_path = sprintf("file:%spc/vip/reservation/confirm.tpl",COMMON_TEMPLATES);
	$smarty->assign( 'content_tpl', $content_tpl_path );
	$smarty->display( 'pc/template_vip.tpl' );

}

?>