<?php
/* =================================================================================
		Script Name	sale_operation.php(売上ポイント・施術売上)
		Author		不明
		Create Date	----/--/--
		Update Date	2018/03/04	店舗変更 by aida
		IN/OUT		受信：GET	送信:無し
		Back Script	***********
		Prev Script	***********
		Description	売上ポイント・施術売上
					セラピストが未定のものがあり、出勤データベースのRemunerationData()が使用出来ない
================================================================================= */
if(isset($_REQUEST["year"]) && isset($_REQUEST["month"])) $_DecisionYm = $_REQUEST["year"] * 100 + $_REQUEST["month"]; else $_DecisionYm = 0;

include("include/common.php");
include("include/auth.php");
include("include/func_ex.inc");
include(COMMON_INC . "remuneration.inc");	//報酬関係
//==================================================================================

$error = "";

//----日付情報設定
$obj_Today = new refleToday();		//本日オブジェクト in ^common/include/const.php
$obj_Today->set( 0 );		//該当日付セット
$w_ThisYmd = $obj_Today->get("Ymd");

$w_ShopInfo = $obj_Shop->getDataByArea($area);
if($w_ShopInfo["shrtb1"]) {
	$ws_ArSharRt = explode(",", $w_ShopInfo["shrtb1"]);
	for($n=0; $n<count($ws_ArSharRt); $n++) {
		$ws_ArSharRt[$n] = intval($ws_ArSharRt[$n]);
	}
}

if( isset($_POST["send_staff_id_confirm"])==true ){
	$year = $_POST["year"];
	$month = $_POST["month"];
	$day = $_POST["day"];
	$area = $_POST["area"];
	$reservation_for_board_id = $_POST["reservation_for_board_id"];
	$staff_id = $_POST["staff_id"];

	//staff_id_confirmをセット
	$result = update_staff_id_confirm($staff_id,$reservation_for_board_id);
	if( $result == true ) $error = '<span style="color:blue;">設定しました</span>';
}else if( isset($_POST["send_staff_id_approve"])==true ){
	$year = $_POST["year"];
	$month = $_POST["month"];
	$day = $_POST["day"];
	$area = $_POST["area"];
	$reservation_for_board_id = $_POST["reservation_for_board_id"];
	$staff_id = $_POST["staff_id"];

	//staff_id_approveをセット
	$result = update_staff_id_approve($staff_id,$reservation_for_board_id);

	if( $result == true ) $error = '<span style="color:blue;">設定しました</span>';
}else if( isset($_GET["send_selected_time"])==true ){

	$area = $_GET["area"];
	$year = $_GET["year"];
	$month = $_GET["month"];
	$day = $_GET["day"];
	$selected_time = $_GET["selected_time"];

	$data = get_time_for_frikomi_list($selected_time);

	$year_selected = $data["year"];
	$month_selected = $data["month"];
	$day_selected = $data["day"];

	if( ($year_selected != "") && ($month_selected != "") && ($day_selected != "") ){
		$year = $year_selected;
		$month = $month_selected;
		$day = $day_selected;
	}
}else{
	if( isset($_GET["area"])==true ){
		$area = $_GET["area"];
	}else{
		$area = "all";
	}

	if( (isset($_GET["year"])==true) && (isset($_GET["month"])==true) && (isset($_GET["day"])==true) ){
		$year = $_GET["year"];
		$month = $_GET["month"];
		$day = $_GET["day"];
	}else{
		$data = get_today_year_month_day_common();

		$year = $data["year"];
		$month = $data["month"];
		$day = $data["day"];
	}
}

$w_ArStaff = PHP_getStaffs("all");		//スタッフ配列取得 in man/include/func_ex.inc

$sale_not_edit_flg = check_sale_not_edit_day_common($year,$month,$day);

$week_name = get_week_name_by_time_common($year, $month, $day);

if( ($month != "-1") && ($day != "-1") ){
	$day_disp = sprintf("%s月%s日（%s）",$month,$day,$week_name);
} else {
	$day_disp = "日付を選択してください";
}

$type = "all";
if( isset($_GET["type"])==true ) $type = $_GET["type"];

$w_week_data[0] = array("year" => $year, "month" => $month, "day" => $day, "Ymd" => ($year * 10000 + $month * 100 + $day));

$w_ArData = PHP_get_staff_data($w_week_data, $area, $w_ThisYmd, $type);
//echo "line:" . __LINE__ . "<pre>"; print_r($w_ArData); echo "</pre>"; exit;

$w_ArConFirm = array("all_num" => count($w_ArData), "not_confirm_num" => 0, "confirm_num" => 0);

for($i=0; $i<count($w_ArData); $i++){

	if( $w_ArData[$i]["staff_id_confirm"] == "-1" ){
		$w_ArConFirm["not_confirm_num"]++;
	}else{
		if( $w_ArData[$i]["staff_id_approve"] == "-1" ) $w_ArConFirm["confirm_num"]++;
	}

	$w_ArData[$i]["info_confirm"] = PHP_getInfoConfirmApprove($w_ArData[$i]["staff_id_confirm"], $_SESSION["login_staff_id"], $_SESSION["login_staff_type_2"], $w_ArStaff);	//確認承認情報取得 in man/include/func_ex.inc
	$w_ArData[$i]["info_approve"] = PHP_getInfoConfirmApprove($w_ArData[$i]["staff_id_approve"], $_SESSION["login_staff_id"], $_SESSION["login_staff_type_2"], $w_ArStaff);	//確認承認情報取得 in man/include/func_ex.inc

	$start_hour = add_zero_when_under_ten_common($w_ArData[$i]["start_hour"]);
	$start_minute = add_zero_when_under_ten_common($w_ArData[$i]["start_minute"]);

	$w_ArData[$i]["shop_area_name"] = get_area_name_by_area_common($w_ArData[$i]["shop_area"]);

	$w_ArData[$i]["start_time"] = $start_hour . ":" . $start_minute;

	if( $w_ArData[$i]["extension"] == "0" ) $w_ArData[$i]["course_disp"] = $w_ArData[$i]["course"] . "分"; else $w_ArData[$i]["course_disp"] = ($w_ArData[$i]["course"] + $w_ArData[$i]["extension"])."分";

	if($w_ArData[$i]["coupon90"] > 0 || $w_ArData[$i]["couponex"] > 0) {
		$w_couponKin = $w_ArData[$i]["coupon90"] * 15000 + $w_ArData[$i]["couponex"] * 5000;
		if($w_ArData[$i]["price"] == $w_couponKin) {
			$w_ArData[$i]["kubun_disp"] = "回数券";
		} else {
			if( $w_ArData[$i]["card_flg"] == "1" ) $w_ArData[$i]["kubun_disp"] = "回数券<br />&カード"; else $w_ArData[$i]["kubun_disp"] = "回数券<br />&現金";
		}
		if($w_ArData[$i]["coupon90"] > 0) $w_ArData[$i]["coupon90_disp"] = $w_ArData[$i]["coupon90"] . "枚";
		if($w_ArData[$i]["couponex"] > 0) $w_ArData[$i]["couponex_disp"] = $w_ArData[$i]["couponex"] . "枚";
	} else {
		if( $w_ArData[$i]["card_flg"] == "1" ) $w_ArData[$i]["kubun_disp"] = "カード"; else $w_ArData[$i]["kubun_disp"] = "現金";
	}
	if( $w_ArData[$i]["shimei_flg"] == "1" ) $w_ArData[$i]["shimei_disp"] = "有り"; else $w_ArData[$i]["shimei_disp"] = "";

	if($w_ArData[$i]["therapist_id"] > 0) {
		$w_ArData[$i]["therapist_name"] = get_therapist_name_by_attendance_id($w_ArData[$i]["attendance_id"], $w_ArData[$i]["shop_area"]);
		if( $all_page_flg == true ){
			$w_ArData[$i]["therapist_name_disp"] = sprintf('<a href="sale_operation_one.php?id=%s&year=%s&month=%s&day=%s&area=%s">%s</a>', $w_ArData[$i]["attendance_id"], $year, $month, $day, $area, $w_ArData[$i]["therapist_name"]);
		} else {
			$w_ArData[$i]["therapist_name_disp"] = $w_ArData[$i]["therapist_name"];
		}
	}
}


$url_para_add = sprintf("area=%s&year=%s&month=%s&day=%s",$area,$year,$month,$day);

if( $area == "all" ) $area_name = "全体"; else $area_name = get_area_name_by_area_common($area);

//echo "<pre>"; print_r($w_ArData); echo "</pre>"; exit();

if($all_page_flg == true) $w_staff_menue = get_menu($login_auth_type, $area);

//----Smarty
$pm['css_time'] = date("ymdHi");		//CSS等のキャッシュ回避用
$pm['all_page_flg'] = $all_page_flg;
$pm['sale_not_edit_flg'] = $sale_not_edit_flg;
$pm['staff_menu'] = $w_staff_menue;
$pm['type'] = $type;
$pm['url_para'] = sprintf("?year=%s&month=%s&day=%s",$year,$month,$day);
$pm['link_not_confirm'] = sprintf("%s?area=%s&year=%s&month=%s&day=%s&type=%s",$this_url,$area,$year,$month,$day,"not_confirm");
$pm['link_confirm'] = sprintf("%s?area=%s&year=%s&month=%s&day=%s&type=%s",$this_url,$area,$year,$month,$day,"confirm");
$pm['link_all'] = sprintf("%s?area=%s&year=%s&month=%s&day=%s&type=%s",$this_url,$area,$year,$month,$day,"all");
$pm['ShopMenue'] = PHP_getShopMenue($area, $_SERVER["SCRIPT_NAME"], $pm['url_para']);	//店舗メニューHTML取得
$pm['area'] = $area;
$pm['area_name'] = $area_name;
$pm['year'] = $year;
$pm['month'] = $month;
$pm['day'] = $day;
$pm['day_disp'] = $day_disp;
$pm['url_para_add'] = $url_para_add;
$pm['repeater_list_url'] = $repeater_list_url;
$pm['repeater_num'] = $repeater_num;
$pm['repeater_num_mishori'] = $repeater_num_mishori;
$pm['remuneration_all'] = $remuneration_all;
$pm['login_staff_id'] = $_SESSION["login_staff_id"];

$smarty->assign( 'pm', $pm );

$smarty->assign( 'ArData', $w_ArData );				//データ配列
$smarty->assign( 'ArConFirm', get_confirm_num_for_sale_operation($year, $month, $day, $area));
$smarty->display( 'man/sale_operation.tpl' );
exit;
//==================================================================================

//----データ取得
function PHP_get_staff_data($u_week_data, $u_area, $u_ThisYmd, $u_type) {

	//----シェア率判定区分及びシェア率取得
	$ws_retTmp = PHP_getShareClass($u_area);		//in ^common/include/remuneration.php
	$ws_shrcls = $ws_retTmp["shrcls"];
	$ws_ArPoints = $ws_retTmp["point"];
	$ws_ArSharRt = $ws_retTmp["rate"];

	$n = count($u_week_data) - 1;
	$ws_FromTo = array("from" => ($u_week_data[0]["year"] * 10000 + $u_week_data[0]["month"] * 100 + $u_week_data[0]["day"]), "to" => ($u_week_data[$n]["year"] * 10000 + $u_week_data[$n]["month"] * 100 + $u_week_data[$n]["day"]));

	//----出勤データを取得
	$obj_RemunerationData = new RemunerationData();		//in ^common/include/remuneration.inc
	if($u_area == "all" || !$u_area) {
		$obj_RemunerationData->set_all("therapist", $ws_FromTo, 0, 0);
	} else {
		$obj_RemunerationData->set($u_area, "therapist", $ws_FromTo, 0);
	}

	$ws_attend				= $obj_RemunerationData->getArAttend();			//出勤データ配列取得
	$ws_ArKeyAtd			= $obj_RemunerationData->getArAttendKey();		//出勤データID配列
	$ws_ArKeyStaffYmd		= $obj_RemunerationData->getArKeyStaffYmd();	//出勤データスタッフID＋年月日キー配列取得
	$ws_strWhereAtend		= $obj_RemunerationData->getStrWhereAtend();	//出勤データID文字列取得

	$ws_ArStaff				= $obj_RemunerationData->getArStaff();			//スタッフデータ配列取得
	$ws_ArKeyStaff			= $obj_RemunerationData->getArKeyStaff();		//スタッフ(セラピスト)データID配列
	$ws_strWhereStaff		= $obj_RemunerationData->getStrWhereStaff();	//スタッフデータID文字列取得

	$ws_ArFreshStaffId		= $obj_RemunerationData->getArFreshStaffId();	//スタッフデータ配列取得（フレッシュ用）
	$ws_strWhereFreshId		= $obj_RemunerationData->getStrWhereFreshId();	//スタッフデータID文字列取得（フレッシュ用）

	$ws_ArNonFixStaff		= $obj_RemunerationData->getArNonFixStaff();		//指定期間以前に固定ポイントになっていないスタッフID配列
	$ws_strWhereNonFixStaff	= $obj_RemunerationData->getStrWhereNonFixStaff();	//指定期間以前に固定ポイントになっていないスタッフID文字列取得

	//----予約状況データ読み込み
	$ws_ArReservData = PHP_getReservDataLocal($u_area, $ws_FromTo, $u_type);		//in local

	if($ws_strWhereFreshId) {
		//----リフレッシュ用の実稼働時間数の取得
		$ws_ArFreshWorkTimes = PHP_getArSumWorkTimes($u_area, $ws_strWhereFreshId, $u_week_data);		//in ^common/include/functions.inc
	}

	//----トータルポイント取得
	if($ws_strWhereNonFixStaff) {
		$ws_ArTotalPoint = PHP_getTotalPoint($ws_strWhereNonFixStaff, $ws_FromTo["from"], $ws_FromTo["to"]);		//in ^common/include/remuneration.inc
	} else {
		$ws_ArTotalPoint = array();
	}

	//----リピーターポイントの取得
	if($ws_strWhereAtend) {
		$ws_ArRepeat = PHP_getRepeatPoint($ws_strWhereAtend);		//in ^common/include/remuneration.inc
		for($i=0; $i<count($ws_ArRepeat); $i++) {
			$n = array_search($ws_ArRepeat[$i]["attendance_id"], $ws_ArKeyAtd);
			if($n === false) continue;
			$ws_attend[$n]["repeater_cnt"]++;
			$ws_attend[$n]["incentive_repeater"] += CONST_incentive_repeater;
		}
	}

	//----予約状況データ配列情報を出勤データに追加
	$ws_ArRet = PHP_addReserv2Attend($ws_ArReservData, $ws_ArKeyAtd, $ws_attend, $ws_ArTotalPoint);		//in ^common/include/remuneration.inc
	$ws_ArReservData = $ws_ArRet["reserv"];
	$ws_attend = $ws_ArRet["attend"];

	if($ws_strWhereNonFixStaff) {
		//----トータルポイント計算
		$ws_ArTpStaff = PHP_calTotalPoint($ws_strWhereNonFixStaff, $ws_FromTo["from"], $ws_FromTo["to"], $u_week_data);		//in ^common/include/remuneration.inc

		//----シェア率算定
		for($i=0; $i<count($ws_ArTpStaff); $i++) {
			$s = array_search($ws_ArTpStaff[$i]["therapist_id"], $ws_ArKeyStaff);
			if($s === false) continue;
			$total_point = $ws_ArTpStaff[$i]["base_point"];
			for($d=1; $d<=count($u_week_data); $d++) {
				$total_point += $ws_ArTpStaff[$i]["point"][($d-1)];
				$share_rate = get_share_rate_common($ws_ArStaff[$s]["point_ref"], $ws_ArStaff[$s]["point_fix"], $total_point, $ws_ArStaff[$s]["area"]);	//シェア率取得 in ^common/include/shop_area_list.php
				$ws_ArTpStaff[$i]["share_rate"][$d] = $share_rate;
			}
		}
	}

	//----保険料データ取得
	if($ws_strWhereStaff) $ws_ArInsurance = PHP_getInsurance($u_week_data[0], $ws_strWhereStaff);
	//echo "<pre>"; print_r($ws_ArInsurance); echo "</pre>"; exit();

	//----報酬計算
	for($r=0; $r<count($ws_ArReservData); $r++) {

		if($ws_ArReservData[$r]["attendance_id"] <= 0) continue;

		$n = array_search($ws_ArReservData[$r]["attendance_id"], $ws_ArKeyAtd);
		if($n === false) continue;

		$d = -1;
		for($i=0; $i<count($u_week_data); $i++) {
			if($ws_ArReservData[$r]["Ymd"] == $u_week_data[$i]["Ymd"]) {
				$d = $i;
				break;
			}
		}
		if($d < 0) continue;

		//----シェア率計算
		if($ws_shrcls) {
			$d = -1;
			for($i=0; $i<count($u_week_data); $i++) {
				if($u_week_data[$i]["Ymd"] == $ws_ArReservData[$r]["Ymd"]) {
					$d = $i;
					break;
				}
			}
			//----シェア率取得(フレッシュ用)
			$share_rate = PHP_getShareRate4Fresh($ws_ArReservData[$r]["therapist_id"], $d, $ws_ArSharRt, $ws_ArFreshWorkTimes);	//in ^common/include/remuneration.php
		} else {
			$share_rate = PHP_calShareRate($ws_ArReservData[$r]["therapist_id"], $ws_ArReservData[$r]["share_rate"], $ws_ArReservData[$r]["Ymd"], $u_week_data, $ws_ArTpStaff);		//in ^common/include/remuneration.inc
		}
		$ws_ArReservData[$r]["share_rate"] = $share_rate;
		$ws_temp = PHP_getRemunerationEx($u_area, $ws_ArReservData[$r]["price"],$ws_ArReservData[$r]["shimei_flg"],$ws_ArReservData[$r]["transportation"], $share_rate, $ws_ArReservData[$r]["new_flg"], $ws_ArReservData[$r]["repeat_flg"], false, $ws_strWhereFreshId);
		$ws_ArReservData[$r]["remuneration"] = $ws_temp["remuneration"];
		$ws_ArReservData[$r]["remuneration_shimei"] = $ws_temp["remuneration_shimei"];
		$ws_ArReservData[$r]["remuneration_insentive"] = $ws_temp["remuneration_insentive"];
		$ws_ArReservData[$r]["remuneration_base"] = $ws_temp["remuneration_base"];

		$ws_ArReservData[$r]["insurance"] = 0;
		for($n=0; $n<count($ws_ArInsurance); $n++) {
			if($ws_ArInsurance[$n]["therapist_id"] == $ws_ArReservData[$r]["therapist_id"]) {
				$ws_ArReservData[$r]["insurance"] = $ws_ArInsurance[$n]["value"];
				break;
			}
		}
		$ws_ArReservData[$r]["insurance_price"] = 0;
		$ws_ArReservData[$r]["insurance_price_disp"] = 0;
		if( $ws_ArReservData[$r]["insurance"] == "2" ) {
			$ws_ArReservData[$r]["insurance_price"] = CONST_insurance_price;
			$ws_ArReservData[$r]["insurance_price_disp"] = $ws_ArReservData[$r]["insurance_price"] * (-1);
		}
		$ws_ArReservData[$r]["remuneration_shiharai"] = $ws_ArReservData[$r]["remuneration"] - $ws_ArReservData[$r]["insurance_price"];
	}

	return $ws_ArReservData;
}

//----予約状況データ読み込み
function PHP_getReservDataLocal($u_area, $u_FromTo, $u_type, $u_flagUnComplete = false) {

	$ws_ArReservData = array();
	$ws_strWhereResvNo = "";
	$ws_ArResvNo = array();
	$r = 0;

	$where_add = "";
	if( $u_type == "confirm" ){
		$where_add = "and staff_id_approve='-1' and staff_id_confirm<>'-1'";
	} else if( $u_type == "not_confirm" ) {
		$where_add = "and staff_id_confirm='-1'";
	}

	if($u_area == "all" || !$u_area) {
		$sql = sprintf("select *,convert_tz(from_unixtime(start_real_time),'+00:00','+09:00') as real_start_tm,convert_tz(from_unixtime(end_real_time),'+00:00','+09:00') as real_end_tm from reservation_for_board where delete_flg='0' and (year*10000+month*100+day)=%s %s order by start_hour,start_minute,id", $u_FromTo["from"], $where_add);
	} else {
		$sql = sprintf("select *,convert_tz(from_unixtime(start_real_time),'+00:00','+09:00') as real_start_tm,convert_tz(from_unixtime(end_real_time),'+00:00','+09:00') as real_end_tm from reservation_for_board where delete_flg='0' and (year*10000+month*100+day)=%s and shop_area='%s' %s order by start_hour,start_minute,id", $u_FromTo["from"], $u_area, $where_add);
	}
	if(!$u_flagUnComplete) $sql .= " and complete_flg='1'";
	$res = mysql_query($sql, DbCon);
	//echo "line:" . __LINE__ . " " . $res . "/" . $sql . "<br />";
	if($res == false){
		echo "error!(PHP_getReservData)";
		exit();
	}
	while($row = mysql_fetch_assoc($res)) {
		$ws_ArReservData[$r] = $row;
		$ws_ArReservData[$r]["price"] = 0;
		$ws_ArReservData[$r]["Ymd"] = $row["year"] * 10000 + $row["month"] * 100 + $row["day"];
		if($ws_strWhereResvNo) $ws_strWhereResvNo .= ",";
		$ws_strWhereResvNo .= $row["reservation_no"];
		$ws_ArResvNo[$r] = $row["reservation_no"];
		$r++;
	}

	if($r > 0) {
		//----売上履歴データ取得し予約状況データ配列に売上追加
		$sql = sprintf("select * from sale_history where delete_flg=0 and reservation_no in(%s)",$ws_strWhereResvNo);
		$res = mysql_query($sql, DbCon);
		if($res == false){
			echo "error!(PHP_getReservData) " . $sql;
			exit();
		}
		while($row = mysql_fetch_assoc($res)) {
			$r = array_search($row["reservation_no"], $ws_ArResvNo);
			if($r === false) continue;
			$ws_ArReservData[$r]["price"] = $row["price"];
		}
	} else {
		return;
	}

	return $ws_ArReservData;
}
?>
