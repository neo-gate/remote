<?php
/* =================================================================================
		Script Name	sale_shop_2.php(売上ポイント・店舗別売上)
		Author		不明
		Create Date	----/--/--
		Update Date	2018/08/29
		IN/OUT		受信：GET	送信:無し
		Back Script	***********
		Prev Script	***********
		Description	売上ポイント・店舗別売上
================================================================================= */
if(isset($_REQUEST["year"]) && isset($_REQUEST["month"])) $_DecisionYm = $_REQUEST["year"] * 100 + $_REQUEST["month"]; else $_DecisionYm = 0;

set_time_limit(3000);

include("include/common.php");
include("include/auth.php");
include(COMMON_INC . "remuneration.inc");	//報酬関係
include(COMMON_INC . "coupon.inc");			//回数券関係
//==================================================================================

if($_REQUEST["mode"]) $w_Mode = $_REQUEST["mode"]; else $w_Mode = "";
$w_subMode = "";		//期間指定の時利用

$w_mode_rtn = "";

if($w_Mode == "month") {
	//----期間・月間
	$w_mode_rtn .= "mode=" . $w_Mode;
	if( isset($_GET["send_month"])==true ){

		$year = $_GET["year"];
		$month = $_GET["month"];
		$day = $_GET["day"];
		$area = $_GET["area"];

		$year_month = $_GET["year_month"];

		$pieces = explode("_",$year_month);
		$year = $pieces[0];
		$month = $pieces[1];

		$year_start = "";
		$month_start = "";
		$day_start = "";
		$year_end = "";
		$month_end = "";
		$day_end = "";
	} else if( isset($_GET["send_kikan"])==true ) {
		$w_subMode = "kikan";
		$year = $_GET["year"];
		$month = $_GET["month"];
		$day = $_GET["day"];
		$area = $_GET["area"];

		$year_month = "";

		$from_time = $_GET["from_time"];
		$to_time = $_GET["to_time"];

		$data = get_time_for_frikomi_list($from_time);

		$year_start = $data["year"];
		$month_start = $data["month"];
		$day_start = $data["day"];

		$data = get_time_for_frikomi_list($to_time);

		$year_end = $data["year"];
		$month_end = $data["month"];
		$day_end = $data["day"];

		$error = check_kikan_for_sale_shop_2($year_start,$month_start,$day_start,$year_end,$month_end,$day_end);

	} else if( (isset($_GET["year"])==true) && (isset($_GET["month"])==true) && (isset($_GET["day"])==true) && (isset($_GET["area"])==true) ) {
		$year = $_GET["year"];
		$month = $_GET["month"];
		$day = $_GET["day"];
		$area = $_GET["area"];

		$year_month = $_GET["year_month"];

		$year_start = $_GET["year_start"];
		$month_start = $_GET["month_start"];
		$day_start = $_GET["day_start"];
		$year_end = $_GET["year_end"];
		$month_end = $_GET["month_end"];
		$day_end = $_GET["day_end"];
	} else {
		if( isset($_GET["area"])==true ) $area = $_GET["area"]; else $area = "all";
		/*
		$year = intval(date("Y"));
		$month = intval(date("m"));
		$day = intval(date("d"));

		$year_month = "";

		$year_start = "";
		$month_start = "";
		$day_start = "";
		$year_end = "";
		$month_end = "";
		$day_end = "";
	*/
	}
} else {
	//----日別
	if( isset($_POST["send_recalculation"])==true ) {
		//echo "<pre>"; print_r($_POST); echo "</pre>"; exit();
		$area = $_POST["area"];
		$year = $_POST["year"];
		$month = $_POST["month"];
		$day = $_POST["day"];

		update_sale_shop_record_at_sale_shop_common($year,$month,$day);

	} else if( isset($_GET["send_selected_time"])==true ) {
		$area = $_GET["area"];
		$year = $_GET["year"];
		$month = $_GET["month"];
		$day = $_GET["day"];
		$selected_time = $_GET["selected_time"];

		$data = get_time_for_frikomi_list($selected_time);

		$year_selected = $data["year"];
		$month_selected = $data["month"];
		$day_selected = $data["day"];

		if( ($year_selected != "") && ($month_selected != "") && ($day_selected != "") ){
			$year = $year_selected;
			$month = $month_selected;
			$day = $day_selected;
		}
	} else {
		if( isset($_GET["area"])==true ) $area = $_GET["area"]; else $area = "all";

		$page_area = $area;

		if( (isset($_GET["year"])==true) && (isset($_GET["month"])==true) && (isset($_GET["day"])==true) ) {
			$year = $_GET["year"];
			$month = $_GET["month"];
			$day = $_GET["day"];
		} else {
			$data = get_today_year_month_day_common();

			$year = $data["year"];
			$month = $data["month"];
			$day = $data["day"];
		}
	}
}

$w_url_para = "";
if($_REQUEST["year"]) $w_url_para = sprintf("?year=%s&month=%s&day=%s", $year, $month, $day);

$week_name = get_week_name_by_time_common($year, $month, $day);

define("todayYmd", date("Ymd", strtotime("-1 day", PHP_getNowTime())));		//本日日付取得 in common/include/today.inc

if($w_Mode == "month") {		//期間
	$day_disp = "月または期間を選択してください";
	if( $error == "" ) {
		if( $w_subMode == "kikan" ){
			$day_disp = sprintf("%s年%s月%s日～%s年%s月%s日",$year_start,$month_start,$day_start,$year_end,$month_end,$day_end);
		}else if( $disp_type == "month" ){
			$day_disp = sprintf("%s年%s月",$year,$month);
		}
	}
	$w_Title = "店舗別売上(期間)";

	$month_select_frm = get_sale_month_select_frm_2_common($area,$year,$month);		//get_sale_month_select_frm_commonとはタグ名異なる（注意）

	$url_para_area = sprintf("&mode=month&year=%s&month=%s&day=%s&year_start=%s&month_start=%s&day_start=%s&year_end=%s&month_end=%s&day_end=%s&year_month=%s",
		$year,$month,$day,$year_start,$month_start,$day_start,$year_end,$month_end,$day_end,$year_month);

	if( $w_subMode ) {		//期間
		$wrk_frDate = new DateTime($from_time);
		$wrk_toDate = new DateTime($to_time);
		$w_interval = date_diff($wrk_frDate, $wrk_toDate);
		$w_maxNum = (int)$w_interval->format("%a") + 1;
		//echo $from_time . " " . $to_time . " " . $w_interval->format("%a") . "<br />";
		$Y = $year_start;
		$m = $month_start;
		$d = $day_start;
		for($n=0; $n<$w_maxNum; $n++) {
			if( ($Y * 10000 + $m * 100 + $d) > todayYmd) break;
			$w_ArTempDate[$n]["year"] = $Y;
			$w_ArTempDate[$n]["month"] = $m;
			$w_ArTempDate[$n]["day"] = $d;
			$w_wrkTime = mktime(0, 0, 0, $m, ($d + 1), $Y);
			$Y = date("Y", $w_wrkTime);
			$m = date("m", $w_wrkTime);
			$d = date("d", $w_wrkTime);
		}
	} else {	//月間
		if(isset($_REQUEST["year"])) {
			$w_nextYear = $year;
			$w_nextMonth = $month + 1;
			if($w_nextMonth > 12) {
				$w_nextYear++;
				$w_nextMonth = 1;
			}
			$w_endDay = date("d", mktime(0, 0, 0, $w_nextMonth, 0, $w_nextYear));
			for($d=0; $d<$w_endDay; $d++) {
				if( ($year * 10000 + $month * 100 + ($d + 1) ) > todayYmd) break;
				$w_ArTempDate[$d]["year"] = $year;
				$w_ArTempDate[$d]["month"] = $month;
				$w_ArTempDate[$d]["day"] = $d + 1;
			}
		} else {
			$year = intval(substr(todayYmd, 0, 4));
			$month = intval(substr(todayYmd, 4, 2));
			$day = intval(substr(todayYmd, 6, 2));
		}
	}
} else {	//日別
	if( ($month != "-1") && ($day != "-1") ){
		$day_disp = sprintf("%s月%s日（%s）",$month,$day,$week_name);
	} else {
		$day_disp = "日付を選択してください";
	}
	$w_Title = "店舗別売上";

	$url_para_add = sprintf("area=%s&year=%s&month=%s&day=%s",$area,$year,$month,$day);

	$w_ArTempDate = get_week_data_for_furikae_list($year, $month, $day, 1);	//in ^man/include/functions.php
}

for($d=0; $d<count($w_ArTempDate); $d++) {
	$w_tempYmd = $w_ArTempDate[$d]["year"] * 10000 + $w_ArTempDate[$d]["month"] * 100 + $w_ArTempDate[$d]["day"];
	$week_data[$d] = $w_ArTempDate[$d];
	$week_data[$d]["Ymd"] = $w_tempYmd;
}
//echo "<pre>"; print_r($week_data); echo "</pre>"; //exit;

//$shop_data = get_shop_data($area);

$sale_not_edit_flg = check_sale_not_edit_day_common($year, $month, $day);

if( $area == "all" ) {
	$area_name = "全体";
} else {
	$area_name = get_area_name_by_area_common($area);
	if($area == "tokyo_reraku"){
		$area_name .= "リラク";
	} else if($area == "tokyo_bigao") {
		$area_name = "BIGAO";
	}
}

//----回数券の交通費分金額取得
$w_Transportation = PHP_getTransportation4Coupon90();		//in ^common/include/coupon.inc

//----回数券(90分券)の金額配列取得
$w_ArShopFee = PHP_getPrice4Coupon90();		//in ^common/include/coupon.inc

$w_flgCard = PHP_checkChangeDate("card", $year, $month, $day);	//変更日チェック in common/include/const.php

$w_strWhere = "";
$i = 0;

for($n=0; $n<count($ARRAY_ArShop); $n++) {
	if( $area != "all" ) {
		//if(substr($ARRAY_ArShop[$n]["area"], 0, strlen($area)) != $area) continue;
		if($ARRAY_ArShop[$n]["area"] != $area) continue;
		//echo $ARRAY_ArShop[$n]["area"] . " " . substr($ARRAY_ArShop[$n]["area"], 0, strlen($area)) . "<br />";
	}
	$shop_data[$i] = $ARRAY_ArShop[$n];
	if($w_strWhere) $w_strWhere .= ",";
	$w_strWhere .= $shop_data[$i]["id"];
	$shop_data[$i]["coupon90tanka"] = 0;

	for($x=0; $x<count($w_ArShopFee); $x++) {
		if($w_ArShopFee[$x]["shop_id"] == $shop_data[$i]["id"]) {
			$shop_data[$i]["coupon90tanka"] = $w_ArShopFee[$x]["price"] - $w_ArShopFee[$x]["dscont"] + $w_Transportation;
			//echo $shop_data[$i]["coupon90tanka"] . " = " . $w_ArShopFee[$x]["price"] . " - " .  $w_ArShopFee[$x]["dscont"] . " + " . $w_Transportation . "<br />";
			break;
		}
	}
	if($shop_data[$i]["coupon90tanka"] == 0) {
		for($x=0; $x<count($shop_data); $x++) {
			
			if(floor($shop_data[$x]["gropno"]/10) == floor($shop_data[$i]["area"]/10)) $shop_data[$i]["coupon90tanka"] = $shop_data[$x]["coupon90tanka"];
		}
	}
	$i++;
}
//echo "<pre>"; print_r($shop_data); echo "</pre>"; exit;

$w_ArData = PHP_get_staff_data($week_data, $area, "therapist");
//echo "<pre>"; print_r($w_ArData); echo "</pre>"; exit;
$w_ArData_d = PHP_get_staff_data($week_data, $area, "driver");

$w_ArData_h = PHP_get_staff_data($week_data, $area, "honbu");

//----移動費用取得
PHP_get_movement_cost($area, $week_data);

for($s=0; $s<count($shop_data); $s++) {

	$shop_data[$s]["data"]["price_sum"] = $shop_data[$s]["data"]["genkin_price"] + $shop_data[$s]["data"]["card_price"] + $shop_data[$s]["data"]["coupon_price"];

	$shop_data[$s]["data"]["driver_gasoline"] += $shop_data[$s]["data"]["office_gasoline"];

	$shop_data[$s]["data"]["staff_remuneration_sum"] = 0;

	//----店長報酬取得
	$shop_data[$s]["data"]["shop_boss_remuneration"] = 0;
	for($d=0; $d<count($week_data); $d++) {

		$w_staff_remuneration_sum = $shop_data[$s]["data"]["arDayData"][$d]["driver_remuneration_sum"] + $shop_data[$s]["data"]["arDayData"][$d]["office_remuneration_sum"];
		$shop_data[$s]["data"]["staff_remuneration_sum"] += $w_staff_remuneration_sum;

		$w_shop_boss_remuneration = get_shop_boss_remuneration_for_sale_shop_2_common($shop_data[$s]["data"]["arDayData"][$d]["genkin_price"], $shop_data[$s]["data"]["arDayData"][$d]["card_price"], $shop_data[$s]["data"]["arDayData"][$d]["therapist_remuneration"]
			, $shop_data[$s]["data"]["arDayData"][$d]["driver_remuneration"], $shop_data[$s]["data"]["arDayData"][$d]["movement_cost"], $shop_data[$s]["data"]["arDayData"][$d]["driver_gasoline"], $shop_data[$s]["data"]["arDayData"][$d]["driver_parking"], $shop_data[$s]["data"]["arDayData"][$d]["card_commission"]
			, $shop_data[$s]["area"], $shop_data[$s]["data"]["arDayData"][$d]["lowest_guarantee"], $shop_data[$s]["data"]["arDayData"][$d]["driver_highway"], $week_data[$d]["year"], $week_data[$d]["month"], $week_data[$d]["day"], $shop_data[$s]["data"]["arDayData"][$d]["therapist_remuneration_sum"]
			, $w_staff_remuneration_sum, $shop_data[$s]["data"]["arDayData"][$d]["driver_sonota"], $shop_data[$s]["data"]["arDayData"][$d]["driver_pay_finish"]);

		$shop_data[$s]["data"]["shop_boss_remuneration"] += $w_shop_boss_remuneration;
		//echo $s . "-" . $d ." t:" . $shop_data[$s]["data"]["arDayData"][$d]["therapist_remuneration"] . " boss:" . $w_shop_boss_remuneration . " boss_all:" . $shop_data[$s]["data"]["shop_boss_remuneration"] . "<br />";
	}

	//----粗利計算 in common/include/functions.php
	$shop_data[$s]["data"]["gross_profit"] = get_gross_profit_for_sale_shop_common($shop_data[$s]["data"]["genkin_price"], $shop_data[$s]["data"]["card_price"], $shop_data[$s]["data"]["therapist_remuneration_sum"]
		, $shop_data[$s]["data"]["staff_remuneration_sum"], $shop_data[$s]["data"]["movement_cost"], $shop_data[$s]["data"]["driver_gasoline"], $shop_data[$s]["data"]["driver_parking"], $shop_data[$s]["data"]["driver_highway"], $shop_data[$s]["data"]["card_commission"]
		, $shop_data[$s]["data"]["shop_boss_remuneration"], $shop_data[$s]["data"]["driver_sonota"],$shop_data[$s]["data"]["driver_pay_finish"]);
	//echo $s . ":" . $shop_data[$s]["data"]["gross_profit"] . " = " . $shop_data[$s]["data"]["genkin_price"] . ", " . $shop_data[$s]["data"]["card_price"] . ", " . $shop_data[$s]["data"]["therapist_remuneration_sum"]
	//	 . ", " . $shop_data[$s]["data"]["staff_remuneration_sum"] . ", " . $shop_data[$s]["data"]["movement_cost"] . ", " . $shop_data[$s]["data"]["driver_gasoline"] . ", " . $shop_data[$s]["data"]["driver_parking"] . ", " . $shop_data[$s]["data"]["driver_highway"] . ", " . $shop_data[$s]["data"]["card_commission"]
	//	 . ", " . $shop_data[$s]["data"]["shop_boss_remuneration"] . ", " . $shop_data[$s]["data"]["driver_sonota"] . ", " . $shop_data[$s]["data"]["driver_pay_finish"] . "<br />";
}

$w_ArSum = PHP_sumData($shop_data);

$w_insurance_price = 0;
for($n=0; $n<count($w_ArData); $n++) {
	$w_insurance_price += $w_ArData[$n]["insurance_price"];
}

//echo "<pre>"; print_r($shop_data); echo "</pre>"; exit;
//----Smarty
$pm['mode'] = $w_Mode;
$pm['mode_rtn'] = "";
if($w_mode_rtn) $pm['mode_rtn'] = "?" . $w_mode_rtn;
$pm['css_time'] = date("ymdHi");		//CSS等のキャッシュ回避用
$pm['Title'] = $w_Title;
$pm['all_page_flg'] = $all_page_flg;
$pm['sale_not_edit_flg'] = $sale_not_edit_flg;
$pm['staff_menu'] = $w_staff_menue;
$pm['type'] = $type;
$pm['url_para'] = "";
if(!$w_mode_rtn) $pm['url_para'] = $w_url_para;
$pm['url_shop'] = $w_url_para;
if($w_mode_rtn && $pm['url_shop']) {
	$pm['url_shop'] .= "&" . $w_mode_rtn;
} elseif($w_mode_rtn && !$pm['url_shop']) {
	$pm['url_shop'] .= "?" . $w_mode_rtn;
}
//echo $pm['url_shop'] . "###<br />";
$pm['ShopMenue'] = PHP_getShopMenue($area, $_SERVER["SCRIPT_NAME"], $pm['url_shop']);	//店舗メニューHTML取得 in ^common/include/shop_area_list.php
$pm['area'] = $area;
$pm['area_name'] = $area_name;
$pm['year'] = $year;
$pm['month'] = $month;
$pm['day'] = $day;
$pm['day_disp'] = $day_disp;
$pm['url_para_add'] = $url_para_add;
$pm['insurance_price'] = $w_insurance_price;

$pm['month_select_frm'] = $month_select_frm;
$pm['from_time'] = $from_time;
$pm['to_time'] = $to_time;

$smarty->assign( 'pm', $pm );

$smarty->assign( 'ArData', $shop_data );				//データ配列
$smarty->assign( 'ArSum', $w_ArSum );
$smarty->assign( 'ArConFirm', get_confirm_num_for_sale_operation($year, $month, $day, $area));
$smarty->display( 'man/sale_shop.tpl' );
exit;
//==================================================================================

function PHP_getIdxLocal($u_Ymd, &$u_week_data) {
	$d = -1;
	for($x=0; $x<count($u_week_data); $x++) {
		//echo $u_week_data[$x]["Ymd"] . " == " . $$u_Ymd . ") {<br />";
		if($u_week_data[$x]["Ymd"] == $u_Ymd) {
			$d = $x;
			break;
		}
	}

	return $d;
}

//----集計部クリアー
function setClearData() {

	$ws_ArRet = array();

	$ws_ArRet["genkin_price"]			= 0;
	$ws_ArRet["card_price"]				= 0;
	$ws_ArRet["coupon90_price"]			= 0;
	$ws_ArRet["couponex_price"]			= 0;
	$ws_ArRet["coupon_price"]			= 0;
	$ws_ArRet["card_commission"]		= 0;
	$ws_ArRet["therapist_remuneration"] = 0;
	$ws_ArRet["pay_day_therapist"]		= 0;
	$ws_ArRet["therapist_remuneration_mibarai"] = 0;
	$ws_ArRet["allowance_jisou"]		= 0;
	$ws_ArRet["allowance_therapist"]	= 0;
	$ws_ArRet["driver_remuneration"]	= 0;
	$ws_ArRet["driver_gasoline"]		= 0;
	$ws_ArRet["driver_parking"]			= 0;
	$ws_ArRet["driver_allowance"]		= 0;
	$ws_ArRet["driver_highway"]			= 0;
	$ws_ArRet["driver_pay_finish"]		= 0;
	$ws_ArRet["lowest_guarantee"]		= 0;
	$ws_ArRet["therapist_remuneration_sum"] = 0;
	$ws_ArRet["pay_day_driver"]			= 0;
	$ws_ArRet["driver_remuneration_mibarai"] = 0;
	$ws_ArRet["driver_remuneration_sum"]	= 0;
	$ws_ArRet["movement_cost"]			= 0;
	$ws_ArRet["shop_boss_remuneration"]	= 0;
	$ws_ArRet["driver_sonota"]			= 0;
	$ws_ArRet["gross_profit"]			= 0;
	$ws_ArRet["office_remuneration_mibarai"] = 0;
	$ws_ArRet["pay_day_office"]			= 0;
	$ws_ArRet["office_allowance"]		= 0;
	$ws_ArRet["office_remuneration_sum"] = 0;
	$ws_ArRet["office_gasoline"]		= 0;
	$ws_ArRet["movement_cost"]			= 0;
	$ws_ArRet["arDayData"]				= array();
	for($d=0; $d<count($u_week_data); $d++) {
		$ws_ArRet["arDayData"][$d] = array();
	}

	return $ws_ArRet;
}

function PHP_sumData($u_shop_data) {

	setClearData();		//集計部クリアー

	for($s=0; $s<count($u_shop_data); $s++) {
		$ws_ArRet["genkin_price"]			+= $u_shop_data[$s]["data"]["genkin_price"];
		$ws_ArRet["card_price"]				+= $u_shop_data[$s]["data"]["card_price"];
		$ws_ArRet["coupon90_price"]			+= $u_shop_data[$s]["data"]["coupon90_price"];
		$ws_ArRet["couponex_price"]			+= $u_shop_data[$s]["data"]["couponex_price"];
		$ws_ArRet["coupon_price"]			+= ($u_shop_data[$s]["data"]["coupon90_price"] + $u_shop_data[$s]["data"]["couponex_price"]);
		$ws_ArRet["card_commission"]		+= $u_shop_data[$s]["data"]["card_commission"];
		$ws_ArRet["therapist_remuneration"] += $u_shop_data[$s]["data"]["therapist_remuneration"];
		$ws_ArRet["pay_day_therapist"]		+= $u_shop_data[$s]["data"]["pay_day_therapist"];
		$ws_ArRet["therapist_remuneration_mibarai"] += $u_shop_data[$s]["data"]["therapist_remuneration_mibarai"];
		$ws_ArRet["allowance_jisou"]		+= $u_shop_data[$s]["data"]["allowance_jisou"];
		$ws_ArRet["allowance_therapist"]	+= $u_shop_data[$s]["data"]["allowance_therapist"];
		$ws_ArRet["driver_remuneration"]	+= $u_shop_data[$s]["data"]["driver_remuneration"];
		$ws_ArRet["driver_gasoline"]		+= $u_shop_data[$s]["data"]["driver_gasoline"];
		$ws_ArRet["driver_parking"]			+= $u_shop_data[$s]["data"]["driver_parking"];
		$ws_ArRet["driver_allowance"]		+= $u_shop_data[$s]["data"]["driver_allowance"];
		$ws_ArRet["driver_highway"]			+= $u_shop_data[$s]["data"]["driver_highway"];
		$ws_ArRet["driver_pay_finish"]		+= $u_shop_data[$s]["data"]["driver_pay_finish"];
		$ws_ArRet["lowest_guarantee"]		+= $u_shop_data[$s]["data"]["lowest_guarantee"];
		$ws_ArRet["therapist_remuneration_sum"] += $u_shop_data[$s]["data"]["therapist_remuneration_sum"];
		$ws_ArRet["pay_day_driver"]			+= $u_shop_data[$s]["data"]["pay_day_driver"];
		$ws_ArRet["driver_remuneration_mibarai"] += $u_shop_data[$s]["data"]["driver_remuneration_mibarai"];
		$ws_ArRet["driver_remuneration_sum"]	+= $u_shop_data[$s]["data"]["driver_remuneration_sum"];
		$ws_ArRet["movement_cost"]			+= $u_shop_data[$s]["data"]["movement_cost"];
		$ws_ArRet["shop_boss_remuneration"]	+= $u_shop_data[$s]["data"]["shop_boss_remuneration"];
		$ws_ArRet["driver_sonota"]			+= $u_shop_data[$s]["data"]["driver_sonota"];
		$ws_ArRet["gross_profit"]			+= $u_shop_data[$s]["data"]["gross_profit"];
		$ws_ArRet["office_remuneration_mibarai"] += $u_shop_data[$s]["data"]["office_remuneration_mibarai"];
		$ws_ArRet["pay_day_office"]			+= $u_shop_data[$s]["data"]["pay_day_office"];
		$ws_ArRet["office_allowance"]		+= $u_shop_data[$s]["data"]["office_allowance"];
		$ws_ArRet["office_remuneration_sum"] += $u_shop_data[$s]["data"]["office_remuneration_sum"];
		$ws_ArRet["office_gasoline"]		+= $u_shop_data[$s]["data"]["office_gasoline"];
	}
	$ws_ArRet["price"] = $ws_ArRet["genkin_price"] + $ws_ArRet["card_price"] + $ws_ArRet["coupon_price"];

	return $ws_ArRet;
}

//----データ取得
function PHP_get_staff_data($u_week_data, $u_area, $u_staff_type) {

	//----シェア率判定区分及びシェア率取得
	$ws_retTmp = PHP_getShareClass($u_area);		//in ^common/include/remuneration.php
	$ws_shrcls = $ws_retTmp["shrcls"];
	$ws_ArPoints = $ws_retTmp["point"];
	$ws_ArSharRt = $ws_retTmp["rate"];

	$n = count($u_week_data) - 1;
	$ws_FromTo = array("from" => ($u_week_data[0]["year"] * 10000 + $u_week_data[0]["month"] * 100 + $u_week_data[0]["day"]), "to" => ($u_week_data[$n]["year"] * 10000 + $u_week_data[$n]["month"] * 100 + $u_week_data[$n]["day"]));
	if($ws_FromTo["to"] > todayYmd) $ws_FromTo["to"] = todayYmd;

	$ws_Url = "sale_one.php";

	if($u_staff_type != "therapist") {
		//----ガソリン代設定値の取得
		$ws_ArGasoline = PHP_getSettingGasoline($u_area, $ws_FromTo["from"], $ws_FromTo["to"]);		//in ^common/include/remuneration.inc

		//----ドライバー切替日取得
		$ws_ArDateSwitchDriver = get_driver_switching_year_month_day_common();	//ドライバー切替日取得 in ^common/include/functions.php
		$ws_ArDateSwitchDriver["Ymd"] = $ws_ArDateSwitchDriver["year"] * 10000 + $ws_ArDateSwitchDriver["month"] * 100 + $ws_ArDateSwitchDriver["day"];
	}

	//----出勤データを取得
	$obj_RemunerationData = new RemunerationData();		//in ^common/include/remuneration.inc
	if($u_area == "all" || !$u_area) {
		$obj_RemunerationData->set_all($u_staff_type, $ws_FromTo, 0, "");
	} else {
		$obj_RemunerationData->set($u_area, $u_staff_type, $ws_FromTo, 0);
	}

	$ws_attend				= $obj_RemunerationData->getArAttend();			//出勤データ配列取得
	$ws_ArKeyAtd			= $obj_RemunerationData->getArAttendKey();		//出勤データID配列
	$ws_ArKeyStaffYmd		= $obj_RemunerationData->getArKeyStaffYmd();	//出勤データスタッフID＋年月日キー配列取得
	$ws_strWhereAtend		= $obj_RemunerationData->getStrWhereAtend();	//出勤データID文字列取得

	$ws_ArStaff				= $obj_RemunerationData->getArStaff();			//スタッフデータ配列取得
	$ws_ArKeyStaff			= $obj_RemunerationData->getArKeyStaff();		//スタッフ(セラピスト)データID配列
	$ws_strWhereStaff		= $obj_RemunerationData->getStrWhereStaff();	//スタッフデータID文字列取得

	if($u_staff_type == "therapist") {
		$ws_ArFreshStaffId		= $obj_RemunerationData->getArFreshStaffId();	//スタッフデータ配列取得（フレッシュ用）
		$ws_strWhereFreshId		= $obj_RemunerationData->getStrWhereFreshId();	//スタッフデータID文字列取得（フレッシュ用）
	}

	$ws_ArNonFixStaff		= $obj_RemunerationData->getArNonFixStaff();		//指定期間以前に固定ポイントになっていないスタッフID配列
	$ws_strWhereNonFixStaff	= $obj_RemunerationData->getStrWhereNonFixStaff();	//指定期間以前に固定ポイントになっていないスタッフID文字列取得

	//echo $u_staff_type . " " . count($ws_attend) . "++++<br />";
	if(count($ws_attend) == 0) return;

	if( $u_staff_type == "therapist" ) {	//セラピストのみ

		//----予約状況データ読み込み
		$ws_ArReservData = PHP_getReservData($ws_strWhereAtend);		//in ^common/include/remuneration.inc

		if($ws_strWhereFreshId) {
			//----リフレッシュ用の実稼働時間数の取得
			$ws_ArFreshWorkTimes = PHP_getArSumWorkTimes($u_area, $ws_strWhereFreshId, $u_week_data);		//in ^common/include/functions.inc
		}

		//----トータルポイント取得
		if($ws_strWhereNonFixStaff) {
			$ws_ArTotalPoint = PHP_getTotalPoint($ws_strWhereNonFixStaff, $ws_FromTo["from"], $ws_FromTo["to"]);		//in ^common/include/remuneration.inc
		} else {
			$ws_ArTotalPoint = array();
		}

		//----リピーターポイントの取得
		if($ws_strWhereAtend) {
			$ws_ArRepeat = PHP_getRepeatPoint($ws_strWhereAtend);		//in ^common/include/remuneration.inc
			for($i=0; $i<count($ws_ArRepeat); $i++) {
				$n = array_search($ws_ArRepeat[$i]["attendance_id"], $ws_ArKeyAtd);
				if($n === false) continue;
				$ws_attend[$n]["repeater_cnt"]++;
				$ws_attend[$n]["incentive_repeater"] += CONST_incentive_repeater;
			}
		}

		//----予約状況データ配列情報を出勤データに追加
		$ws_ArRet = PHP_addReserv2Attend($ws_ArReservData, $ws_ArKeyAtd, $ws_attend, $ws_ArTotalPoint);		//in ^common/include/remuneration.inc
		$ws_ArReservData = $ws_ArRet["reserv"];
		$ws_attend = $ws_ArRet["attend"];


		if($ws_strWhereNonFixStaff) {
			//----トータルポイント計算
			$ws_ArTpStaff = PHP_calTotalPoint($ws_strWhereNonFixStaff, $ws_FromTo["from"], $ws_FromTo["to"], $u_week_data);		//in ^common/include/remuneration.inc

			//----シェア率算定
			for($i=0; $i<count($ws_ArTpStaff); $i++) {
				$s = array_search($ws_ArTpStaff[$i]["therapist_id"], $ws_ArKeyStaff);
				if($s === false) continue;
				$total_point = $ws_ArTpStaff[$i]["base_point"];
				for($d=1; $d<=count($u_week_data); $d++) {
					$total_point += $ws_ArTpStaff[$i]["point"][($d-1)];
					$share_rate = get_share_rate_common($ws_ArStaff[$s]["point_ref"], $ws_ArStaff[$s]["point_fix"], $total_point, $ws_ArStaff[$s]["area"]);	//シェア率取得 in ^common/include/shop_area_list.php
					$ws_ArTpStaff[$i]["share_rate"][$d] = $share_rate;
				}
			}
		}
//echo "<pre>"; print_r($ws_ArTpStaff); echo "</pre>"; exit;
//echo "<pre>"; print_r($ws_ArReservData); echo "</pre>"; exit;
		//----報酬計算
		for($r=0; $r<count($ws_ArReservData); $r++) {

			$n = array_search($ws_ArReservData[$r]["attendance_id"], $ws_ArKeyAtd);
			if($n === false) continue;
//echo $ws_ArReservData[$r]["staff_id"] . "<br />";
			$d = PHP_getIdxLocal($ws_ArReservData[$r]["Ymd"], $u_week_data);
			if($d < 0) continue;

			//----シェア率計算
			if($ws_shrcls) {
				$d = PHP_getIdxLocal($ws_ArReservData[$r]["Ymd"], $u_week_data);
				//----シェア率取得(フレッシュ用)
				if($d > -1) $share_rate = PHP_getShareRate4Fresh($ws_ArReservData[$r]["therapist_id"], $d, $ws_ArSharRt, $ws_ArFreshWorkTimes);	//in ^common/include/remuneration.php
			} else {
				$share_rate = PHP_calShareRate($ws_ArReservData[$r]["therapist_id"], $ws_ArReservData[$r]["share_rate"], $ws_ArReservData[$r]["Ymd"], $u_week_data, $ws_ArTpStaff);		//in ^common/include/remuneration.inc
			}
			//echo $ws_ArReservData[$r]["therapist_id"] . "/" . $share_rate . " / " . $ws_ArReservData[$r]["shimei_flg"] . "<br />";

			if($ws_ArReservData[$r]["shop_area"] == "tokyo_reraku"){
				$remuneration = get_remuneration_one_reraku_common($ws_ArReservData[$r]["price"],$ws_ArReservData[$r]["shimei_flg"],$ws_ArReservData[$r]["transportation"],$share_rate);	//報酬計算(東京リラク) in ^common/include/functions.php
			} else if($ws_ArReservData[$r]["shop_area"] == "tokyo_bigao"){
				$remuneration = get_remuneration_one_bigao_common($ws_ArReservData[$r]["price"],$ws_ArReservData[$r]["shimei_flg"],$ws_ArReservData[$r]["new_flg"],$ws_ArReservData[$r]["repeat_flg"],$ws_ArReservData[$r]["transportation"],$share_rate,$ws_ArReservData[$r]["attendance_id"]);	//報酬計算(BIGAO) in ^common/include/functions.php
			} else{
				//$remuneration = get_remuneration_one_common($ws_ArReservData[$r]["price"],$ws_ArReservData[$r]["shimei_flg"],$ws_ArReservData[$r]["transportation"],$share_rate);	//報酬計算(一般) in ^common/include/functions.php
				$remuneration = PHP_getRemuneration($ws_ArReservData[$r]["shop_area"], $ws_ArReservData[$r]["price"],$ws_ArReservData[$r]["shimei_flg"],$ws_ArReservData[$r]["transportation"], $share_rate, 0, 0, 0, $ws_strWhereFreshId);	//報酬計算 in common/include/shop_area_list.php
			}
			$ws_ArReservData[$r]["remuneration"] = $remuneration;

			$ws_attend[$n]["remuneration"] += $remuneration;
		}

		//----最低保証及びチーフ手当
		for($n=0; $n<count($ws_attend); $n++) {
			//----最低保証チェック
			$ws_attend[$n]["lowest_guarantee"] = 0;
			if( !$ws_attend[$n]["jitaku_taiki_flg"]) {
				$ws_lowest_guarantee = get_lowest_guarantee_common($ws_attend[$n]["area"], $ws_attend[$n]["start_time"],$ws_attend[$n]["end_time"]);	//最低保証取得 in shop_area_list.php
				if($ws_attend[$n]["remuneration"] < $ws_lowest_guarantee) {
					$ws_attend[$n]["remuneration"] = $ws_lowest_guarantee;
					$ws_attend[$n]["lowest_guarantee"] = $ws_lowest_guarantee;
				}
//echo "line:" . __LINE__ . " " . $ws_attend[$n]["lowest_guarantee"] . " " . $ws_attend[$n]["area"] . ", " .  $ws_attend[$n]["start_time"] . ", " . $ws_attend[$n]["end_time"] . "<br />";
			}
			//----チーフ手当
			if($ws_attend[$n]["chief_allowance"] > 0 && $ws_attend[$n]["chief_allowance_ymd"] <= $ws_attend[$n]["Ymd"]) {
				$ws_attend[$n]["chief_allowance_yuko"] += $ws_attend[$n]["chief_allowance"];
				$ws_attend[$n]["remuneration"] += $ws_attend[$n]["chief_allowance"];
			}
			$ws_attend[$n]["remuneration"] += - $ws_attend[$n]["pay_day"] + $ws_attend[$n]["allowance"] + $ws_attend[$n]["pay_another"] - $ws_attend[$n]["pay_finish"];
			//$ws_attend[$n]["furikomi_price"] = $ws_attend[$n]["remuneration"];
			//if($ws_attend[$n]["Ymd"] == 20180901) echo $ws_attend[$n]["chief_allowance"] . " | " . $ws_attend[$n]["remuneration"] . " += - " . $ws_attend[$n]["pay_day"] . " + " . $ws_attend[$n]["allowance"] . " + " . $ws_attend[$n]["pay_another"] . " - " . $ws_attend[$n]["pay_finish"] . "<br />";
		}

		//----保険料設定読み込み
		for($d=0; $d<count($u_week_data); $d++) {
			$ws_attend = PHP_addInsurance($u_week_data[$d], $ws_strWhereStaff, $ws_attend, $ws_ArKeyStaffYmd);	//保険料の追加 in ^common/include/remuneration.inc
		}

		PHP_calPrice($ws_ArReservData, $ws_attend, $u_week_data);
	} else {
		//----スタッフ
		//----スタッフ報酬データ取得
		if($ws_strWhereAtend) $ws_attend = PHP_getRenamurationData4Staff($u_staff_type, $ws_strWhereAtend, $ws_ArKeyAtd, $ws_attend, $ws_ArDateSwitchDriver["Ymd"], $ws_ArGasoline);	//in ^common/include/remuneration.inc
		PHP_calPriceStaff($u_staff_type, $ws_attend, $u_week_data);
		//echo "<pre>"; print_r($ws_attend); echo "</pre>"; exit;
	}

	return $ws_attend;
}

function PHP_calPrice($u_ArReservData, $u_attend, $u_week_data) {
global $shop_data;

	//----集計部クリアー
	for($s=0; $s<count($shop_data); $s++) {
		$shop_data[$s]["data"] = setClearData();
		$shop_data[$s]["data"]["arDayData"]	= array();
		for($d=0; $d<count($u_week_data); $d++) {
			$shop_data[$s]["data"]["arDayData"][$d] = array();
			$shop_data[$s]["data"]["arDayData"][$d]["genkin_price"]			= 0;
			$shop_data[$s]["data"]["arDayData"][$d]["card_price"]			= 0;
			$shop_data[$s]["data"]["arDayData"][$d]["coupon_price"]			= 0;
			$shop_data[$s]["data"]["arDayData"][$d]["coupon90_price"]		= 0;
			$shop_data[$s]["data"]["arDayData"][$d]["couponex_price"]		= 0;
			$shop_data[$s]["data"]["arDayData"][$d]["card_commission"]		= 0;
			$shop_data[$s]["data"]["arDayData"][$d]["allowance"]			= 0;
			$shop_data[$s]["data"]["arDayData"][$d]["therapist_remuneration"] = 0;
			$shop_data[$s]["data"]["arDayData"][$d]["driver_remuneration"]	= 0;
			$shop_data[$s]["data"]["arDayData"][$d]["driver_remuneration_mibarai"] = 0;
			$shop_data[$s]["data"]["arDayData"][$d]["pay_day_driver"]		= 0;
			$shop_data[$s]["data"]["arDayData"][$d]["driver_gasoline"]		= 0;
			$shop_data[$s]["data"]["arDayData"][$d]["driver_parking"]		= 0;
			$shop_data[$s]["data"]["arDayData"][$d]["driver_allowance"]		= 0;
			$shop_data[$s]["data"]["arDayData"][$d]["driver_highway"]		= 0;
			$shop_data[$s]["data"]["arDayData"][$d]["driver_pay_finish"]	= 0;
			$shop_data[$s]["data"]["arDayData"][$d]["driver_sonota"]		= 0;
			$shop_data[$s]["data"]["arDayData"][$d]["driver_remuneration_sum"]	= 0;
			$shop_data[$s]["data"]["arDayData"][$d]["office_remuneration_mibarai"]	= 0;
			$shop_data[$s]["data"]["arDayData"][$d]["pay_day_office"]		= 0;
			$shop_data[$s]["data"]["arDayData"][$d]["office_allowance"]		= 0;
			$shop_data[$s]["data"]["arDayData"][$d]["office_remuneration_sum"]	=0;
			$shop_data[$s]["data"]["arDayData"][$d]["office_gasoline"]		= 0;
			$shop_data[$s]["data"]["arDayData"][$d]["movement_cost"]		= 0;
		}
	}

	$ws_qShopName = "";

	for($n=0; $n<count($u_ArReservData); $n++) {
		if($u_ArReservData[$n]["shop_name"] != $ws_qShopName) {
			$ws_qShopName = $u_ArReservData[$n]["shop_name"];
			$ws_Idx = -1;
			for($x=0; $x<count($shop_data); $x++) {
				if($shop_data[$x]["name"] == $ws_qShopName) {
					$ws_Idx = $x;
					break;
				}
			}
			if($ws_Idx == -1) continue;
			$s = $ws_Idx;
		}
		$d = PHP_getIdxLocal($u_ArReservData[$n]["Ymd"], $u_week_data);		//in local
		if($d < 0) $d = 0;

		//----売上
		//if($u_ArReservData[$n]["card_flg"]) $ws_cellName = "card_price"; else $ws_cellName = "genkin_price";
		if($u_ArReservData[$n]["card_confirm_flg"]) $ws_cellName = "card_price"; else $ws_cellName = "genkin_price";

		$extension_price = 0;
		$ws_price = $u_ArReservData[$n]["price"];

		//----回数券
		$ws_coupon90_price = 0;
		$ws_couponex_price = 0;
		if($u_ArReservData[$n]["coupon90"] > 0) $ws_coupon90_price = $u_ArReservData[$n]["coupon90"] * $shop_data[$s]["coupon90tanka"];
		if($u_ArReservData[$n]["couponex"] > 0) $ws_couponex_price = $u_ArReservData[$n]["couponex"] * $shop_data[$s]["extnsn"];
		$shop_data[$s]["data"]["coupon90_price"] += $ws_coupon90_price;
		$shop_data[$s]["data"]["couponex_price"] += $ws_couponex_price;
		$ws_coupon_price = $ws_coupon90_price + $ws_couponex_price;
		$shop_data[$s]["data"]["coupon_price"] += $ws_coupon_price;

		if( $u_ArReservData[$n]["extension"] != "0" ){
			$extension_price = get_extension_price_common($u_ArReservData[$n]["extension"], $ws_qShopName);	//超過料金取得
			//if( $card_flg == "0" ) {
			if( $u_ArReservData[$n]["card_confirm_flg"] == "0" ) {
				//延長支払い、カードの場合
				if( $u_ArReservData[$n]["card_state_extension"] == "1" ) $ws_price -= $extension_price;
			//} else if( $card_flg == "1" ) {
			} else if( $u_ArReservData[$n]["card_confirm_flg"] == "1" ) {
				//延長支払い、現金の場合
				if( $u_ArReservData[$n]["card_state_extension"] == "0" ) $ws_price -= $extension_price;
			}
		}
		//if($u_ArReservData[$n]["card_flg"]) echo $u_ArReservData[$n]["card_price_free"] . " != " . $ws_price . "<br />";

		//if($u_ArReservData[$n]["card_flg"] && $u_ArReservData[$n]["card_price_free"] != $ws_price) {
		if($u_ArReservData[$n]["card_confirm_flg"] && $u_ArReservData[$n]["card_price_free"] != $ws_price) {
			$shop_data[$s]["data"][$ws_cellName] += $u_ArReservData[$n]["card_price_free"];
			$shop_data[$s]["data"]["arDayData"][$d][$ws_cellName] += $u_ArReservData[$n]["card_price_free"];
			if($u_ArReservData[$n]["card_price_free"] != $ws_price) {
				//----現金かつカード利用の場合
				$ws_genkin_price = $ws_price - $u_ArReservData[$n]["card_price_free"];
				if($ws_coupon_price > 0) $ws_genkin_price -= $ws_coupon_price;		//かつ回数券利用がある場合
				$shop_data[$s]["data"]["genkin_price"] += $ws_genkin_price;
				$shop_data[$s]["data"]["arDayData"][$d]["genkin_price"] += $ws_genkin_price;
				if($ws_genkin_price < 0) {
					echo "<font color='red'>" . $shop_data[$s]["name"] . "の予約ID＝" . $u_ArReservData[$n]["id"] . "が回数券利用金額により現金がマイナス値( " . $ws_genkin_price . "円 )になりました。</font><br />";
				}
			}
		} else {
			//if(!$u_ArReservData[$n]["card_flg"] && $ws_coupon_price > 0) {
			if(!$u_ArReservData[$n]["card_confirm_flg"] && $ws_coupon_price > 0) {
				$ws_genkin_price = $u_ArReservData[$n]["price"] - $ws_coupon_price;	//現金かつ回数券利用がある場合
				$shop_data[$s]["data"][$ws_cellName] += $ws_genkin_price;
				$shop_data[$s]["data"]["arDayData"][$d][$ws_cellName] += $ws_genkin_price;
				if($ws_genkin_price < 0) {
					echo "<font color='red'>" . $shop_data[$s]["name"] . "の予約ID＝" . $u_ArReservData[$n]["id"] . "が回数券利用金額により現金がマイナス値( " . $ws_genkin_price . "円 )になりました。</font><br />";
				}
			} else {
				$shop_data[$s]["data"][$ws_cellName] += $u_ArReservData[$n]["price"];
				$shop_data[$s]["data"]["arDayData"][$d][$ws_cellName] += $u_ArReservData[$n]["price"];
			}
		}

		//if($u_ArReservData[$n]["card_flg"]) {
		if($u_ArReservData[$n]["card_confirm_flg"]) {
			if( $u_ArReservData[$n]["card_price"] != "0" ){
				if( $u_ArReservData[$n]["card_commission_free"] == "0" ){
					$ws_card_commission = get_card_commission_free_common($u_ArReservData[$n]["card_commission_type"], $u_ArReservData[$n]["card_price_free"]);	//カード手数料取得
				}else{
					$ws_card_commission = $u_ArReservData[$n]["card_commission_free"];
				}
				$shop_data[$s]["data"]["card_commission"] += $ws_card_commission;
				$shop_data[$s]["data"]["arDayData"][$d]["card_commission"] += $ws_card_commission;
			}
		}

		//$shop_data[$s]["data"]["therapist_remuneration"] += $u_ArReservData[$n]["remuneration"];

		//----（注意）後で確認
		//if($row["card_flg"]) {
		//if($u_ArReservData[$n]["card_confirm_flg"]) {
		//	$card_commission_free = get_card_commission_free_for_sale_shop_2_common($card_commission_type, $price_card, $card_commission_free_tmp);
		//	$shop_data[$s]["data"]["card_commission"] += $card_commission_free;
		//	$shop_data[$s]["data"]["arDayData"][$d]["card_commission"] += $card_commission_free;
		//}

		if($u_ArReservData[$n]["jisou_flg"]) {
			//----自走手当
			if( $u_ArReservData[$n]["transportation"] == "0" ) {
				$ws_allowance = 500;
			} else {
				$ws_allowance = $u_ArReservData[$n]["transportation"];
			}
			$shop_data[$n]["data"]["allowance"] += $ws_allowance;
			$shop_data[$s]["data"]["arDayData"][$d]["allowance"] += $ws_allowance;
		}

		$shop_data[$s]["data"]["therapist_remuneration"] += $u_ArReservData[$n]["remuneration"];
		$shop_data[$s]["data"]["arDayData"][$d]["therapist_remuneration"] += $u_ArReservData[$n]["remuneration"];

	}

//echo "<pre>"; print_r($u_attend); echo "</pre>"; exit;
	for($n=0; $n<count($u_attend); $n++) {
		for($s=0; $s<count($shop_data); $s++) {
			if($shop_data[$s]["area"] == $u_attend[$n]["area"]) {
				$shop_data[$s]["data"]["pay_day_therapist"] += $u_attend[$n]["pay_day"];		//日払い報酬取得
				$shop_data[$s]["data"]["allowance_therapist"] += $u_attend[$n]["allowance"];	//セラピスト手当
				$shop_data[$s]["data"]["therapist_remuneration"] += $u_attend[$n]["chief_allowance_yuko"];
				$shop_data[$s]["data"]["lowest_guarantee"] += $u_attend[$n]["lowest_guarantee"];	//最低保証額
				$d = PHP_getIdxLocal($u_attend[$n]["Ymd"], $u_week_data);		//in local
				if($d < 0) $d = 0;
				$shop_data[$s]["data"]["arDayData"][$d]["pay_day_therapist"] += $u_attend[$n]["pay_day"];		//日払い報酬取得
				$shop_data[$s]["data"]["arDayData"][$d]["arDayData"][$d]["allowance_therapist"] += $u_attend[$n]["allowance"];	//セラピスト手当
				$shop_data[$s]["data"]["arDayData"][$d]["therapist_remuneration"] += $u_attend[$n]["chief_allowance_yuko"];
				$shop_data[$s]["data"]["arDayData"][$d]["lowest_guarantee"] += $u_attend[$n]["lowest_guarantee"];	//最低保証額
				break;
			}
		}
	}
//echo "<pre>"; print_r($shop_data); echo "</pre>"; exit;

	for($s=0; $s<count($shop_data); $s++) {
		//----未払い報酬
		$shop_data[$s]["data"]["therapist_remuneration_mibarai"] = $shop_data[$s]["data"]["therapist_remuneration"] - $shop_data[$s]["data"]["pay_day_therapist"];
		//セラピスト報酬合計
		$shop_data[$s]["data"]["therapist_remuneration_sum"] = $shop_data[$s]["data"]["therapist_remuneration"] + $shop_data[$s]["data"]["lowest_guarantee"] + $shop_data[$s]["data"]["allowance_therapist"];
	}

//echo "<pre>"; print_r($shop_data); echo "</pre>"; exit;
}

function PHP_calPriceStaff($u_staff_type, $u_attend, $u_week_data) {
global $shop_data;

//echo "<pre>"; print_r($u_attend); echo "</pre>";
	for($n=0; $n<count($u_attend); $n++) {
		$ws_Idx = -1;
		for($x=0; $x<count($shop_data); $x++) {
			if($shop_data[$x]["area"] == $u_attend[$n]["area"]) {
				$ws_Idx = $x;
				break;
			}
		}

		if($ws_Idx == -1) continue;

		$s = $ws_Idx;

		$d = PHP_getIdxLocal($u_attend[$n]["Ymd"], $u_week_data);		//in local
		if($d < 0) $d = 0;

		if($u_staff_type == "driver") {
//echo $u_attend[$n]["gasoline_value_disp"] . " + " . $u_attend[$n]["car_distance_over_allowance"] . "<br />";
			$ws_remuneration =  $u_attend[$n]["remuneration"] - ($u_attend[$n]["highway"] + $u_attend[$n]["parking"] + $u_attend[$n]["allowance"] - $u_attend[$n]["pay_finish"]);
			$shop_data[$s]["data"]["driver_remuneration"]			+= $ws_remuneration;
			$shop_data[$s]["data"]["driver_remuneration_mibarai"]	+= $ws_remuneration - $u_attend[$n]["pay_day"];
			$shop_data[$s]["data"]["pay_day_driver"]				+= $u_attend[$n]["pay_day"];
			$shop_data[$s]["data"]["driver_gasoline"]				+= $u_attend[$n]["gasoline_value_disp"] + $u_attend[$n]["car_distance_over_allowance"];
//if($s == 9) echo $shop_data[$s]["data"]["driver_gasoline"]  . " += " . $u_attend[$n]["gasoline_value_disp"] . " + " . $u_attend[$n]["car_distance_over_allowance"] . "<br />";
			$shop_data[$s]["data"]["driver_parking"]				+= $u_attend[$n]["parking"];
			$shop_data[$s]["data"]["driver_allowance"]				+= $u_attend[$n]["allowance"];
			$shop_data[$s]["data"]["driver_highway"]				+= $u_attend[$n]["highway"];
			$shop_data[$s]["data"]["driver_pay_finish"]				+= $u_attend[$n]["pay_finish"];
			$shop_data[$s]["data"]["driver_sonota"]					+= $u_attend[$n]["repair"] + $u_attend[$n]["insurance"] + $u_attend[$n]["sonota"];
			//echo $shop_data[$s]["data"]["driver_sonota"] . " += " . $u_attend[$n]["repair"] . " + " . $u_attend[$n]["insurance"] . " + " . $u_attend[$n]["sonota"] . "<br />";
			$shop_data[$s]["data"]["driver_remuneration_sum"]		+= $ws_remuneration + $u_attend[$n]["allowance"];
			$shop_data[$s]["data"]["arDayData"][$d]["driver_remuneration"]			+= $ws_remuneration;
			$shop_data[$s]["data"]["arDayData"][$d]["driver_remuneration_mibarai"]	+= $ws_remuneration - $u_attend[$n]["pay_day"];
			$shop_data[$s]["data"]["arDayData"][$d]["pay_day_driver"]				+= $u_attend[$n]["pay_day"];
			$shop_data[$s]["data"]["arDayData"][$d]["driver_gasoline"]				+= $u_attend[$n]["gasoline_value_disp"] + $u_attend[$n]["car_distance_over_allowance"];
			$shop_data[$s]["data"]["arDayData"][$d]["driver_parking"]				+= $u_attend[$n]["parking"];
			$shop_data[$s]["data"]["arDayData"][$d]["driver_allowance"]				+= $u_attend[$n]["allowance"];
			$shop_data[$s]["data"]["arDayData"][$d]["driver_highway"]				+= $u_attend[$n]["highway"];
			$shop_data[$s]["data"]["arDayData"][$d]["driver_pay_finish"]			+= $u_attend[$n]["pay_finish"];
			$shop_data[$s]["data"]["arDayData"][$d]["driver_sonota"]				+= $u_attend[$n]["repair"] + $u_attend[$n]["insurance"] + $u_attend[$n]["sonota"];
			$shop_data[$s]["data"]["arDayData"][$d]["driver_remuneration_sum"]		+= $ws_remuneration + $u_attend[$n]["allowance"];
		} else {
			$shop_data[$s]["data"]["office_remuneration_mibarai"]	+= $u_attend[$n]["remuneration"];
			$shop_data[$s]["data"]["pay_day_office"]				+= $u_attend[$n]["pay_finish"];
			$shop_data[$s]["data"]["office_allowance"]				+= $u_attend[$n]["allowance"];
			$shop_data[$s]["data"]["office_remuneration_sum"]		+= $u_attend[$n]["remuneration"] + $u_attend[$n]["allowance"];
			$shop_data[$s]["data"]["office_gasoline"]				+= $u_attend[$n]["gasoline_value_disp"];
			$shop_data[$s]["data"]["arDayData"][$d]["office_remuneration_mibarai"]	+= $u_attend[$n]["remuneration"];
			$shop_data[$s]["data"]["arDayData"][$d]["pay_day_office"]				+= $u_attend[$n]["pay_finish"];
			$shop_data[$s]["data"]["arDayData"][$d]["office_allowance"]				+= $u_attend[$n]["allowance"];
			$shop_data[$s]["data"]["arDayData"][$d]["office_remuneration_sum"]		+= $u_attend[$n]["remuneration"] + $u_attend[$n]["allowance"];
			$shop_data[$s]["data"]["arDayData"][$d]["office_gasoline"]				+= $u_attend[$n]["gasoline_value_disp"];
		}
	}
//echo "<pre>"; print_r($u_attend); echo "</pre>"; exit;
//echo "<pre>"; print_r($shop_data); echo "</pre>"; exit;
}

//----移動費用取得
function PHP_get_movement_cost($u_area, $u_week_data) {
global $shop_data;

	$n = count($u_week_data) - 1;
	$ws_FromTo = array("from" => ($u_week_data[0]["year"] * 10000 + $u_week_data[0]["month"] * 100 + $u_week_data[0]["day"]), "to" => ($u_week_data[$n]["year"] * 10000 + $u_week_data[$n]["month"] * 100 + $u_week_data[$n]["day"]));
	if($ws_FromTo["to"] > todayYmd) $ws_FromTo["to"] = todayYmd;

	if($ws_FromTo["from"] >= 20150409 ) {
		if($u_area == "all" || !$u_area) {
			$sql = sprintf("select area,(year*10000+month*100+day) as Ymd,sum(cost_value) as value_sum from movement_cost where delete_flg='0' and (year*10000+month*100+day)>=%s and (year*10000+month*100+day)<=%s group by area,Ymd", $ws_FromTo["from"], $ws_FromTo["to"]);
		} else {
			$sql = sprintf("select area,(year*10000+month*100+day) as Ymd,sum(cost_value) as value_sum from movement_cost where delete_flg='0' and area='%s' and (year*10000+month*100+day)>=%s and (year*10000+month*100+day)<=%s group by area,Ymd", $u_area, $ws_FromTo["from"], $ws_FromTo["to"]);
		}
	} else {
		if($u_area == "all" || !$u_area) {
			$sql = sprintf("select area,(year*10000+month*100+day) as Ymd,sum(value) as value_sum from sale_cost where delete_flg=0 and name='movement_cost' and (year*10000+month*100+day)>=%s and (year*10000+month*100+day)<=%s group by area,Ymd", $ws_FromTo["from"], $ws_FromTo["to"]);
		} else {
			$sql = sprintf("select area,(year*10000+month*100+day) as Ymd,sum(value) as value_sum from sale_cost where delete_flg=0 and name='movement_cost' and area='%s' and (year*10000+month*100+day)>=%s and (year*10000+month*100+day)<=%s group by area,Ymd", $u_area, $ws_FromTo["from"], $ws_FromTo["to"]);
		}
	}
	$res = mysql_query($sql, DbCon);
	//echo $res . "/" . $sql . "<br />";
	if($res == false){
		echo "error!(get_movement_cost_value_for_sale_shop_common) " . $sql;
		exit();
	}

	$cost_value_all = 0;

	while($row = mysql_fetch_assoc($res)){

		$ws_Idx = -1;
		for($x=0; $x<count($shop_data); $x++) {
			if($shop_data[$x]["area"] == $row["area"]) {
				$ws_Idx = $x;
				break;
			}
		}

		if($ws_Idx == -1) continue;

		$s = $ws_Idx;

		$d = PHP_getIdxLocal($row["Ymd"], $u_week_data);		//in local
		if($d < 0) $d = 0;

		$shop_data[$s]["data"]["movement_cost"] += $row["value_sum"];
		$shop_data[$s]["data"]["arDayData"][$d]["movement_cost"] += $row["value_sum"];
	}
}

//----店長報酬取得
function Xget_shop_boss_remuneration_for_sale_shop_2_common(
$genkin_price,$card_price,$therapist_remuneration,
$driver_remuneration,$movement_cost,$driver_gasoline,$driver_parking,$card_commission,
$shop_area,$lowest_guarantee,$driver_highway,$year,$month,$day,$therapist_remuneration_sum,
$staff_remuneration_sum,$driver_sonota,$driver_pay_finish){

global $ARRAY_ArShop;

	//セラピスト報酬に最低保証分も足す
	$therapist_remuneration = $therapist_remuneration + $lowest_guarantee;

	if( $shop_area == "tokyo" ){
		$shop_boss_remuneration = 0;		//東京には店長報酬は無い
		return $shop_boss_remuneration;
		exit();
	}

	//□各エリアの店長報酬の計算式
	//【札幌】【仙台】
	//売上-セラピスト報酬合計-ドライバー報酬合計-移動費(移動実費+ガソリン代+駐車場代+高速代）-カード手数料×20パーセント

	//【大阪】
	//売上-セラピスト報酬合計-ドライバー報酬合計-移動費(移動実費+ガソリン代+駐車場代+高速代）-カード手数料×10パーセント

	//【横浜】
	//(旧計算式)売上×1パーセント
	//(新計算式)大阪と同じ

	//超過手当もマイナス(超過手当はガソリン代に含まれている)

	$shop_boss_remuneration = 0;

	$sale_price = $genkin_price + $card_price;

	$movement_cost_all = $movement_cost + $driver_gasoline + $driver_parking + $driver_highway;

	/*
	if( ($shop_area=="sapporo") || ($shop_area=="sendai") ){

		$shop_boss_remuneration = intval(($sale_price-$therapist_remuneration-$driver_remuneration-$movement_cost_all-$card_commission)/5);

	}else if( $shop_area == "osaka" ){

		$shop_boss_remuneration = intval(($sale_price-$therapist_remuneration-$driver_remuneration-$movement_cost_all-$card_commission)/10);

	}else if( $shop_area == "yokohama" ){
		global $ARRAY_changeDate;
		$year_change = $ARRAY_changeDate["y"];
		$month_change = $ARRAY_changeDate["m"];
		$day_change = $ARRAY_changeDate["d"];

		$ts = get_timestamp_by_year_month_day_common($year,$month,$day);	//指定年月日をタイムスタンプ形式に変換
		$ts_change = get_timestamp_by_year_month_day_common($year_change,$month_change,$day_change);	//指定年月日をタイムスタンプ形式に変換

		if( $ts > $ts_change ){
			//大阪と同じ
			$shop_boss_remuneration = intval(($sale_price-$therapist_remuneration-$driver_remuneration-$movement_cost_all-$card_commission)/10);
		}else{
			$shop_boss_remuneration = intval($sale_price/100);
		}
	}
	*/

	$ws_Rate = 0;
	for($n=0; $n<count($ARRAY_ArShop); $n++) {
		if($ARRAY_ArShop[$n]["area"] == $shop_area) {
			$ws_Rate = 100 / $ARRAY_ArShop[$n]["bosrat"];
		}
	}
	if( $shop_area == "yokohama" && PHP_checkChangeDate("yokohama", $year, $month, $day) == false ) {	//変更日チェック in common/include/const.php
		$shop_boss_remuneration = intval($sale_price/100);	//横浜の店長報酬切替日以前の場合
	} else {
		$shop_boss_remuneration = intval(($sale_price-$therapist_remuneration-$driver_remuneration-$movement_cost_all-$card_commission) / $ws_Rate);
		//echo $shop_boss_remuneration . " = intval((" . $sale_price . " - " . $therapist_remuneration . " - " . $driver_remuneration . " - " . $movement_cost_all . " - " . $card_commission . ") / " . $ws_Rate . ")<br />";
	}

	return $shop_boss_remuneration;
	exit();
}
?>
