<?php

include("include/common.php");
include("include/auth.php");



if( isset($_GET["area"])==true ){

	$area = $_GET["area"];

}else{

	$area = "tokyo";

}

if( (isset($_GET["year"])==true) && (isset($_GET["month"])==true) && (isset($_GET["day"])==true) ){
	
	$year = $_GET["year"];
	$month = $_GET["month"];
	$day = $_GET["day"];
	
}else{
	
	$year = intval(date("Y"));
	$month = intval(date("m"));
	$day = intval(date("d"));
	
}

$day_select_frm = get_sale_honbu_day_select_frm($area,$year,$month,$day);

$week_name = get_week_name_by_time_common($year, $month, $day);

if( ($month != "-1") && ($day != "-1") ){
	$day_disp = sprintf("%s月%s日（%s）",$month,$day,$week_name);
}else{
	
	$day_disp = "日付を選択してください";
	
}

//出勤ドライバーのデータ取得
$driver_data = get_honbu_data_for_sale($year,$month,$day,$area);

$driver_data_num = count($driver_data);

$gasoline_value = get_gasoline_value_from_settings_2_common($area,$year,$month,$day);

$type = "honbu";
$month_select_frm = get_sale_month_select_frm_common($area,$year,$month,$type);

$url_para_add = sprintf("area=%s&year=%s&month=%s&day=%s",$area,$year,$month,$day);

/*
echo "<pre>";
print_r($driver_data);
echo "</pre>";
exit();
*/

?>

<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>内勤スタッフ | 管理</title>
<script type="text/javascript" src="../js/jquery-1.7.2.js"></script>
<script type="text/javascript" src="js/sale_office.js"></script>
<link href="style.css" rel="stylesheet" type="text/css" />

<style>

*{
	font-size:14px;
}

table tr th{
	background-color:#c9caca;
	padding:5px 5px 5px 5px;
	font-size:12px;
}

table tr td{
	padding:5px 5px 5px 5px;
}

body{



}

.form_txt{

	width:60px;
	
}

</style>

</head>

<body>

<div style="margin:0px 0px 0px 0px;">
	<div>
		<a href="index.php">管理トップ</a> &gt; <a href="sale.php">売上・ポイント</a> &gt; 内勤スタッフ
	</div>
	<div style="padding:0px 0px 100px 30px;">
	
	<?php include("include/sale_menu.php");?>
	
	<div>
		<input type="hidden" name="area" value="<?php echo $area;?>" id="sale_driver_area_val" />
	</div>

	<div style="padding:10px 0px 0px 0px;">
		<div id="sale_driver_day_select_area" style="float:left;">
			<?php echo $day_select_frm;?>
		</div>
		<div style="float:left;padding-left:30px;">
			<?php echo $month_select_frm;?>
		</div>
		<div style="float:left;padding-left:30px;">
			○<a href="sale_change_history.php?type=honbu&<?php echo $url_para_add;?>">修正履歴</a>
		</div>
		<div style="float:left;padding-left:30px;">
		</div>
		<br class="clear" />
	</div>
	
	<div style="padding:20px 0px 0px 0px;">
		<div style="float:left;">
			<?php echo $day_disp;?>
		</div>
		<div style="float:left;padding-left:30px;">
<?php

$url_para = sprintf("&year=%s&month=%s&day=%s",$year,$month,$day);

echo '<a href="sale_office.php?area=tokyo'.$url_para.'">東京</a>　';

?>
		</div>
		<br class="clear" />
	</div>
	
	<div style="padding:20px 0px 0px 0px;">
	
	<table border="1">
		<tr>
			<th align="left" width="100">スタッフ</th>
			<th align="center" width="70">時給</th>
			<th align="center" width="70">出勤</th>
			<th align="center" width="70">退勤</th>
			<th align="center" width="70">勤務時間</th>
			<th align="center" width="70">手当</th>
			<th align="center" width="70">報酬</th>
			<th align="center" width="70">走行距離</th>
			<th align="center" width="70">ガソリン代</th>
			<th align="center" width="70">高速代</th>
			<th align="center" width="70">駐車場代</th>
			<th align="center" width="70">清算済み</th>
			<th align="center" width="70">総支給額</th>
		</tr>
<?php

for($i=0;$i<$driver_data_num;$i++){
	
	$driver_id = $driver_data[$i]["id"];
	$name = $driver_data[$i]["name"];
	$pay_hour = $driver_data[$i]["pay_hour"];
	$pay_fix = $driver_data[$i]["pay_fix"];
	$fuel = $driver_data[$i]["fuel"];
	
	if( $pay_hour == "-1" ){
		$pay_hour = 0;
	}
	
	$pay_hour_disp = number_format($pay_hour)."円";
	
	$data = get_staff_attendance_data_by_time($driver_id,$year,$month,$day);
	$attendance_id = $data["id"];
	$start_time = $data["start_time"];
	$end_time = $data["end_time"];
	$allowance = $data["allowance"];
	$car_distance = $data["car_distance"];
	$highway = $data["highway"];
	$parking = $data["parking"];
	$pay_finish = $data["pay_finish"];
	$start_hour = $data["start_hour"];
	$start_minute = $data["start_minute"];
	$end_hour = $data["end_hour"];
	$end_minute = $data["end_minute"];
	
	if( ($fuel != "0") && ($fuel != "-1") ){
		
		$gasoline_value_disp = intval(($car_distance*$gasoline_value)/$fuel);
		
	}else{
		
		$gasoline_value_disp = 0;
		
	}
	
	//データのアップデート(最初のアクセス時だけ)と、データの取得
	$data = get_and_update_honbu_work_time_common($attendance_id,$start_hour,$start_minute,$end_hour,$end_minute,$start_time,$end_time);
	
	$start_hour = $data["start_hour"];
	$start_minute = $data["start_minute"];
	$end_hour = $data["end_hour"];
	$end_minute = $data["end_minute"];
	
	$work_time = get_work_time_driver_common($start_hour,$start_minute,$end_hour,$end_minute);
	
	$start_time_disp = get_time_disp_for_sale_driver_one($time_array,$start_time,$start_hour,$start_minute);
	$end_time_disp = get_time_disp_for_sale_driver_one($time_array,$end_time,$end_hour,$end_minute);
	
	$select_option_start = get_time_select_option_for_sale_office($start_hour,$start_minute);
	$select_option_end = get_time_select_option_for_sale_office($end_hour,$end_minute);
	
	$remuneration = get_remuneration_staff_by_attendance_id_common($attendance_id);
	
	$sum_price = 0;
	
	if( $remuneration != "0" ){
	
		//報酬+ガソリン代+高速代+駐車場代+手当-清算済み
		$sum_price = ( $remuneration + $gasoline_value_disp + $highway + $parking + $allowance ) - $pay_finish;
	
	}
	
	$driver_name = sprintf('<a href="sale_office_one.php?id=%s&year=%s&month=%s&day=%s&area=%s">%s</a>',
$driver_id,$year,$month,$day,$area,$name);
	
echo '<tr>';
echo '<td>'.$driver_name.'</td>';
echo '<td align="center">'.$pay_hour_disp.'</td>';

echo '<td align="center">';
//echo $start_time_disp;
$html =<<<EOT
<div id="start_time_{$attendance_id}">
<form id="start_time_frm_{$attendance_id}">
<input type="hidden" name="driver_id" value="{$driver_id}" />
<select name="frm_val" class="frm_val_select" id="select_start_time_{$attendance_id}">
{$select_option_start}
</select>
</form>
</div>
EOT;
echo $html;
echo '</td>';

echo '<td align="center">';
//echo $end_time_disp;
$html =<<<EOT
<div id="end_time_{$attendance_id}">
<form id="end_time_frm_{$attendance_id}">
<input type="hidden" name="driver_id" value="{$driver_id}" />
<select name="frm_val" class="frm_val_select" id="select_end_time_{$attendance_id}">
{$select_option_end}
</select>
</form>
</div>
EOT;
echo $html;
echo '</td>';

echo '<td align="center">';
$html =<<<EOT
<div id="work_time_{$attendance_id}">
{$work_time}
</div>
EOT;
echo $html;
echo '</td>';


echo '<td align="center">';
$html =<<<EOT
<div id="allowance_{$attendance_id}">
<form id="allowance_frm_{$attendance_id}">
<input type="hidden" name="driver_id" value="{$driver_id}" />
<input type="text" name="frm_val" value="{$allowance}" class="form_txt" id="allowance_txt_{$attendance_id}" />
</form>
</div>
EOT;
echo $html;
echo '</td>';


echo '<td align="center">';
$remuneration = number_format($remuneration);
$html =<<<EOT
<div id="remuneration_{$attendance_id}">
{$remuneration}
</div>
EOT;
echo $html;
echo '</td>';


echo '<td align="center">';
$html =<<<EOT
<div id="car_distance_{$attendance_id}">
<form id="car_distance_frm_{$attendance_id}">
<input type="hidden" name="driver_id" value="{$driver_id}" />
<input type="text" name="frm_val" value="{$car_distance}" class="form_txt" id="car_distance_txt_{$attendance_id}" />
</form>
</div>
EOT;
echo $html;
echo '</td>';


echo '<td align="center">';
$gasoline_value_disp = number_format($gasoline_value_disp);
$html =<<<EOT
<div id="gasoline_value_{$attendance_id}">
{$gasoline_value_disp}
</div>
EOT;
echo $html;
echo '</td>';


echo '<td align="center">';
$html =<<<EOT
<div id="highway_{$attendance_id}">
<form id="highway_frm_{$attendance_id}">
<input type="hidden" name="driver_id" value="{$driver_id}" />
<input type="text" name="frm_val" value="{$highway}" class="form_txt" id="highway_txt_{$attendance_id}" />
</form>
</div>
EOT;
echo $html;
echo '</td>';


echo '<td align="center">';
$html =<<<EOT
<div id="parking_{$attendance_id}">
<form id="parking_frm_{$attendance_id}">
<input type="hidden" name="driver_id" value="{$driver_id}" />
<input type="text" name="frm_val" value="{$parking}" class="form_txt" id="parking_txt_{$attendance_id}" />
</form>
</div>
EOT;
echo $html;
echo '</td>';


echo '<td align="center">';
$html =<<<EOT
<div id="pay_finish_{$attendance_id}">
<form id="pay_finish_frm_{$attendance_id}">
<input type="hidden" name="driver_id" value="{$driver_id}" />
<input type="text" name="frm_val" value="{$pay_finish}" class="form_txt" id="pay_finish_txt_{$attendance_id}" />
</form>
</div>
EOT;
echo $html;
echo '</td>';


echo '<td align="center">';
$sum_price = number_format($sum_price);
$html =<<<EOT
<div id="sum_price_{$attendance_id}">
{$sum_price}
</div>
EOT;
echo $html;
echo '</td>';


echo '</tr>';

}

?>
	</table>
	
	</div>


	</div>
</div>

</body>
</html>