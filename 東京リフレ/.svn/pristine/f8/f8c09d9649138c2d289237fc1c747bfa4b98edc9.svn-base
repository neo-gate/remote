<?php
/* =================================================================================
		Script Name	stf_calender.php(スタッフ出勤カレンダー)
		Author		copy by aida
		Create Date	2018/01/10	Created based on staff_calender_new.php staff_calender_kensyuu.php staff_calender_team.php staff_calender_wait.php
		Update Date	----/--/--
		IN/OUT		受信：GET	送信:無し
		Back Script	***********
		Prev Script	***********
		Description	スタッフ出勤カレンダー
================================================================================= */
//----初期処理
include("include/common_ex.php");
include("include/auth_ex.php");
//==================================================================================
$ARRAY_tokyoArea = array("area", "reraku", "bigao");

$obj_Time = new refleTime();		//時刻オブジェクト in ^common/include/const.php
$obj_Time->set();
$w_ArTime = $obj_Time->getAll();	//時刻配列取得

define("maxDays", 62);
//==================================================================================
//echo "line:" . __LINE__ . " " . date("H:i:s") . " login_staff_login_auth_type=" . $login_staff_login_auth_type . "<br />";

if(isset($_GET["Ymd"])) $w_getYmd = $_GET["Ymd"]; else $w_getYmd = 0;
$w_PrevTime = PHP_getNextMonthDay($w_getYmd, -1);		//n月加減日計算 in ^common/include/const.php
$w_NextTime = PHP_getNextMonthDay($w_getYmd, 1);		//n月加減日計算 in ^common/include/const.php

$area = "";
if(isset($_GET["area"]) == true){
	if($_GET["area"]) $area = $_GET["area"]; else $area = "tokyo";
	//$area_name = get_area_name_by_area_common($area);
} else {
	$smarty->display( 'man/stf_calender_top.tpl' );
	exit;
}

define("GL_Area", $area);

$_SESSION["Calender_Area"] = GL_Area;

$team_data_num = 0;
$ws_tmpArea = "tokyo";
$ws_tmpAreaName = "東京";
switch($area) {
	case "kensyuu":
		$area_name = "研修";
		break;
	case "team":
		$area_name = "チーム別";
		include(COMMON_INC . "team_data.php");
		$team_data_num = count($team_data);
		array_push($team_data, array("id" => ($team_data_num + 1), "name" => "その他"));
		break;
	case "wait":
		$area_name = "待機場所別";
		include(COMMON_INC . "wait_select_data.php");
		break;
	default:
		$area_name = $ARRAY_Area[$area];
		$ws_tmpArea = $area;
		$ws_tmpAreaName = $area_name;
}
//$all_page_flg = false;		//メニューテスト用
$menu = PHP_get_menu($login_staff_login_auth_type, $ws_tmpArea, $ws_tmpAreaName, $ARRAY_auth);		//メニュー in local

if($area == "tokyo") {
	define("areaNums", count($ARRAY_tokyoArea));
} else {
	define("areaNums", 1);
}

if($area == "kensyuu") {
	$w_ArKensyuuPlans = PHP_getArKensyuuPlan($day_array_2, maxDays);		//研修スケジュール取得
	for($n=0; $n<maxDays; $n++) {
		$day_id[$n] = $w_ArKensyuuPlans[$n]["day_id"];
	}
} else {
	$day_id = PHP_get_attendance_request_state($day_array_2, maxDays, $area);		//----エリア別営業日データ取得 in local
}

if($area != "kensyuu" && $area != "team" && $area != "wait") {
	//----スタッフ情報の取得
	$w_ArStaffData = PHP_getStaffData4staff_calendar($area);		//in local

	//----スタッフの出勤データを取得
	$w_ArStaffAttendance = PHP_get_staff_attendance($area, $day_array_2, $w_ArStaffData);

	if( $area == "tokyo" ){
		//----本部スタッフ
		$w_Type = "honbu";
		$honbu_data = $w_ArStaffData[$w_Type];
		$honbu_data_num = count($honbu_data);

		$honbu_data = PHP_setAttendance($w_Type, $w_ArTime["honbu_maxId"], $area, $honbu_data, $w_ArStaffAttendance[$w_Type], $day_array_2);		//出勤データ取得 in local

		$w_ArSumStaff[$w_Type] = PHP_set_staff_attendance_num($area, $honbu_data, $day_array_2);		//本部またはドライバーの出勤数取得 in local
	}

	//----ドライバー
	$w_Type = "driver";
	$driver_data = $w_ArStaffData[$w_Type];
	$driver_data_num = count($driver_data);

	$driver_data = PHP_setAttendance($w_Type, $w_ArTime["driver_maxId"], $area, $driver_data, $w_ArStaffAttendance[$w_Type], $day_array_2);		//出勤データ取得 in local

	$w_ArSumStaff[$w_Type] = PHP_set_staff_attendance_num($area, $driver_data, $day_array_2);		//本部またはドライバーの出勤数取得 in local
	//echo "line:" . __LINE__ . " " . date("H:i:s") . " driver_nums:" . count($w_ArSumStaff["driver"]) . "<br />";
}

//----セラピスト情報取得
switch($area) {
	case "team":
		$w_ArModeInfo = $team_data;
		break;
	case "wait":
		$w_ArModeInfo = $wait_select_data_2;
		break;
	default:
		$w_ArModeInfo = $ARRAY_tokyoArea;
}
for($a=0; $a<count($w_ArModeInfo); $a++) { $therapist_data_num[$a] = 0; }
$therapist_data = PHP_get_therapist_data_for_therapist_calendar($area, $team_data_num);		//----セラピスト情報取得　in local
for($a=0; $a<count($therapist_data); $a++) {
	$therapist_data_num[$a] = count($therapist_data[$a]);
	//echo "line:" . __LINE__ . " " . date("H:i:s") . " therapist_data_num[" . $a . "]:" . $therapist_data_num[$a] . "<br />";
}

//----セラピストの出勤データを取得
$w_ArAttendance = PHP_get_attendance_data_for_therapist_calendar($area, $day_array_2, $therapist_data);		//in local

//----セラピスト出勤数集計
$w_ArSumAttendance = PHP_get_therapist_attendance_num_new($day_array_2, $w_ArAttendance, count($therapist_data));		//in local

//----セラピスト表示セルの編集
switch($area) {
	case "team":
	case "wait":
		//----チーム別、待機場所別
		for($j=0; $j<$day_array_2_num; $j++) {
			$w_ArSumAttendanceTotal[$j] = 0;
		}
		for($g=0; $g<count($therapist_data); $g++) {
			$therapist_data[$g] = PHP_setTherapistOrgTeam($therapist_data[$g], $login_staff_login_auth_type);		//セラピスト画面表示用諸元の基本設定(チーム別、待機場所別) in local
			$therapist_data[$g] = PHP_setAttendance_team($area, $g, $therapist_data[$g], $w_ArAttendance[$g], $day_array_2, $w_ArTime["therapist_maxId"]);		//出勤データ取得(チーム別、待機場所別セラピスト用) in local
			$w_ArSumAttendance = $w_ArSumAttendance;
			for($j=0; $j<$day_array_2_num; $j++) {
				$w_ArSumAttendanceTotal[$j] += $w_ArSumAttendance[$g][$j]["nums"];
			}
			if($area == "wait" && $therapist_data[$g]["id"] == -1) {
				$therapist_data[$g]["id"] = count($therapist_data);
			}
		}
		break;
	default:
		//----エリア別セラピスト
		$w_Type = "therapist";
		for($a=0; $a<areaNums; $a++) {
			$therapist_data[$a] = PHP_setTherapistOrg($therapist_data[$a], $login_staff_login_auth_type);		//セラピスト画面表示用諸元の基本設定 in local
			$therapist_data[$a] = PHP_setAttendance($w_Type, $w_ArTime["therapist_maxId"], $area, $therapist_data[$a], $w_ArAttendance[$a], $day_array_2, $w_ArKensyuuPlans);		//出勤データ取得 in local
			$w_ArSumAttendance[$a] = $w_ArSumAttendance[$a];
		}
}

//----前月及び次月表示用リンク生成
$w_qStrPrev = "";
$w_qStrNext = "";
$w_qStr = "area=" . $area;
if($w_qStr) {
	$w_qStrPrev = "&";
	$w_qStrNext = "&";
}
$w_qStrPrev .= "Ymd=" . date("Ymd", $w_PrevTime);
$w_dspPrevDay = date("Y/m/d", $w_PrevTime);

$w_qStrNext .= "Ymd=" . date("Ymd", $w_NextTime);
$w_dspNextDay = date("Y/m/d", $w_NextTime);

if(date("Ymd", $w_NextTime) > date("Ymd", time())) {
	$w_nextDispStr = "";
} else {
	$w_nextDispStr = "１ヶ月後　--＞";		//１ヶ月後のリンク用文字列
}
if(date("Ymd", $w_NextTime) >= date("Ymd", time())) $w_qStrNext = "";

if($w_qStr || $w_qStrNext) {
	$w_qStrNext = "?" . $w_qStr . $w_qStrNext;
}

$w_addYmd = "";
$w_addYmd2 = "";
if(isset($_GET["Ymd"])) {
	$w_addYmd .= "&Ymd=" . $_GET["Ymd"];
	$w_addYmd2 = "?Ymd=" . $_GET["Ymd"];
}

//----Smarty
$pm['css_time'] = date("ymdHi");		//CSS等のキャッシュ回避用
$pm['menu'] = $menu;
$pm['addYmd'] = $w_addYmd;				//QueryString用日付パターン１　&Ymd=yyyymmdd
$pm['addYmd2'] = $w_addYmd2;			//QueryString用日付パターン２  ?Ymd=yyyymmdd
$pm['prevYmd'] = $w_qStr . $w_qStrPrev;		//１ヶ月前の日付
$pm['nextYmd'] = $w_qStrNext;				//１ヶ月後の日付
$pm['nextDispStr'] = $w_nextDispStr;		//１ヶ月後のリンク用文字列
$pm['dspPrevDay'] = $w_dspPrevDay;			//表示期間（From)
$pm['dspNextDay'] = $w_dspNextDay;			//表示期間（To)
$pm['area'] = $area;
$pm['area_name'] = $area_name;			//タイトル表示用エリア名または機能種別名
$pm['staff_area'] = $staff_area;
$pm['staff_id'] = $staff_id;
$pm['all_page_flg'] = $all_page_flg;	//認証タイプが１の場合のみtrue

$smarty->assign( 'pm', $pm );

//$smarty->assign( 'retAttendance', $w_retAttendance );
$smarty->assign( 'day_id', $day_id );
$smarty->assign( 'day_array_2', $day_array_2 );				//日付配列
$smarty->assign( 'day_array_2_num', $day_array_2_num );		//日付配列数

if($area != "kensyuu" && $area != "team" && $area != "wait") {
	$smarty->assign( 'ArSumStaff', $w_ArSumStaff );				//本部スタッフ及びドライバー出勤集計配列
	$smarty->assign( 'honbu_data', $honbu_data );				//本部スタッフデータ配列
	$smarty->assign( 'honbu_data_num', $honbu_data_num );		//本部スタッフデータ配列数

	$smarty->assign( 'driver_data', $driver_data );				//ドライバーデータ配列
	$smarty->assign( 'driver_data_num', $driver_data_num );		//ドライバーデータ配列数
}
$smarty->assign( 'therapist_data', $therapist_data );			//セラピストデータ配列
$smarty->assign( 'therapist_data_num', $therapist_data_num );	//セラピストデータ配列数
$smarty->assign( 'ArSumAttendance', $w_ArSumAttendance );		//セラピスト出勤数集計

switch($area) {
	case "kensyuu":
		$smarty->display( 'man/stf_calender_kensyuu.tpl' );
		break;
	case "team":
	case "wait":
		$smarty->assign( 'ArSumAttendanceTotal', $w_ArSumAttendanceTotal );		//セラピスト出勤数集計(全体)
		$smarty->display( 'man/stf_calender_team.tpl' );
		break;
	default:
		$smarty->display( 'man/stf_calender.tpl' );
}
exit;
//==================================================================================

//----該当日付列(Index)取得
function PHP_serachArDay($u_year, $u_month, $u_day, &$u_ardays) {
	for($n=0; $n<count($u_ardays); $n++) {
		//echo $u_ardays[$n]["year"] . " == " . $u_year. " && " .$u_ardays[$n]["month"] . " == " . $u_month. " && " .$u_ardays[$n]["day"] . " == " . $u_day . "<br />";
		if($u_ardays[$n]["year"] == $u_year && $u_ardays[$n]["month"] == $u_month && $u_ardays[$n]["day"] == $u_day) {
			return $n;
		}
	}
	return -1;
}

//----該当日付列(Index)取得
function PHP_serachArDay2($u_ymd, &$u_ardays) {
	for($n=0; $n<count($u_ardays); $n++) {
		if(($u_ardays[$n]["year"] * 10000 + $u_ardays[$n]["month"] * 100 + $u_ardays[$n]["day"]) == $u_ymd) {
			return $n;
		}
	}
	return -1;
}

//----セラピスト画面表示用諸元の基本設定
function PHP_setTherapistOrg(&$u_ArData, $login_staff_login_auth_type) {

	$ws_ArData = $u_ArData;

	for($i=0; $i<count($u_ArData); $i++) {
		if( $ws_ArData[$i]["rank"] == "1" ){
			$ws_ArData[$i]["rankClass"] = "name name_rank_a";
		}else if( $ws_ArData[$i]["rank"] == "2" ){
			$ws_ArData[$i]["rankClass"] = "name name_rank_b";
		}else if( $ws_ArData[$i]["rank"] == "3" ){
			$ws_ArData[$i]["rankClass"] = "name name_rank_c";
		}else if( $ws_ArData[$i]["rank"] == "5" ){
			$ws_ArData[$i]["rankClass"] = "name name_rank_d";
		}else if( $ws_ArData[$i]["rank"] == "4" ){
			$ws_ArData[$i]["rankClass"] = "name name_rank_n";
		}else{
			$ws_ArData[$i]["rankClass"] = "name";
		}
		$therapist_name_tmp = mb_substr($ws_ArData[$i]["name"],0,3,'UTF-8');
		if( ($login_staff_login_auth_type == "1") || ($login_staff_login_auth_type == "2") ){
			//$ws_ArData[$i]["html"] = sprintf("<a href='%sman/shift/index.php?area=%s&id=%s' target='_blank'>%s</a>",URL_ROOT, $ws_ArData[$i]["area"], $ws_ArData[$i]["id"], $therapist_name_tmp);
			$ws_ArData[$i]["html"] = sprintf("<a href='./shift/index.php?area=%s&id=%s' target='_blank'>%s</a>", $ws_ArData[$i]["area"], $ws_ArData[$i]["id"], $therapist_name_tmp);
		}else{
			$ws_ArData[$i]["html"] = $therapist_name_tmp;
		}
		if($ws_ArData[$i]["area"]=="tokyo"){
			$ws_ArData[$i]["name_site"] = mb_substr($ws_ArData[$i]["name_site"],0,2,'UTF-8');
			$ws_ArData[$i]["name_site"] .= "," . mb_substr($ws_ArData[$i]["name_aroma"],0,2,'UTF-8');
		}else{
			$ws_ArData[$i]["name_site"] = mb_substr($ws_ArData[$i]["name_site"],0,2,'UTF-8');
		}
	}
	return $ws_ArData;
}

//----セラピスト画面表示用諸元の基本設定(チーム別、待機場所別)
function PHP_setTherapistOrgTeam(&$u_ArData, $login_staff_login_auth_type) {

	$ws_ArData = $u_ArData;

	for($i=0; $i<count($ws_ArData["staff"]); $i++) {
		$therapist_name_tmp = mb_substr($ws_ArData["staff"][$i]["name"],0,3,'UTF-8');
		if( ($login_staff_login_auth_type == "1") || ($login_staff_login_auth_type == "2") ) {
			//$ws_ArData["staff"][$i]["html"] = sprintf("<a href='%sman/shift/index.php?area=%s&id=%s' target='_blank'>%s</a>",URL_ROOT, $ws_ArData["staff"][$i]["area"], $ws_ArData["staff"][$i]["id"], $therapist_name_tmp);
			$ws_ArData["staff"][$i]["html"] = sprintf("<a href='./shift/index.php?area=%s&id=%s' target='_blank'>%s</a>", $ws_ArData["staff"][$i]["area"], $ws_ArData["staff"][$i]["id"], $therapist_name_tmp);
		}else{
			$ws_ArData["staff"][$i]["html"] = $therapist_name_tmp;
		}
		$ws_ArData["staff"][$i]["name_site"] = mb_substr($ws_ArData["staff"][$i]["name_site"],0,2,'UTF-8');
		$ws_ArData["staff"][$i]["name_site"] .= "," . mb_substr($ws_ArData["staff"][$i]["name_aroma"],0,2,'UTF-8');
	}
	return $ws_ArData;
}

//----出勤データ取得
function PHP_setAttendance($u_modeId, $u_maxId, $u_area, &$u_ArData, &$u_attendance_data, &$u_day_array_2, $u_ArKensyuuPlan) {

	$ws_ArData = $u_ArData;

	if($u_modeId == "therapist") {
		$ws_id = "therapist_id";
	} else {
		$ws_id = "staff_id";
	}

	for($i=0; $i<count($ws_ArData); $i++) {
		$ws_ArData[$i]["dData"] = array();
		for($j=0; $j<maxDays; $j++) {
			$ws_ArData[$i]["dData"][$j]["match_flag"] = false;
		}
		if($u_modeId == "therapist") {
			//----セラピストのみ
			for($j=0;$j<maxDays;$j++) {
				if( $ws_ArData[$i]["rank"] == "1" ){
					$ws_ArData[$i]["dData"][$j]["class"] = "one_2 rank_a";
				}else if( $ws_ArData[$i]["rank"] == "2" ){
					$ws_ArData[$i]["dData"][$j]["class"] = "one_2 rank_b";
				}else if( $ws_ArData[$i]["rank"] == "3" ){
					$ws_ArData[$i]["dData"][$j]["class"] = "one_2 rank_c";
				}else if( $ws_ArData[$i]["rank"] == "5" ){
					$ws_ArData[$i]["dData"][$j]["class"] = "one_2 rank_d";
				}else if( $ws_ArData[$i]["rank"] == "4" ){
					$ws_ArData[$i]["dData"][$j]["class"] = "one_2 rank_n";
				}else{
					$ws_ArData[$i]["dData"][$j]["class"] = "one_2";
				}
			}
		} else {
			//----その他
			for($j=0;$j<maxDays;$j++) {
				if( $ws_ArData[$i]["kenmu"] ) {
					$ws_ArData[$i]["dData"][$j]["class"] = "one_2 gray";
				} else {
					$ws_ArData[$i]["dData"][$j]["class"] = "one_2";
				}
			}
		}
	}

	$ws_qId = -1;
	for($k=0; $k<count($u_attendance_data); $k++) {
		//if($u_attendance_data[$k]["id"] == 26040) echo "line:" . __LINE__ . " " . $u_attendance_data[$k]["id"] . "<br />";
		$i = $u_attendance_data[$k]["R"];
		if($i == -1) {
			//echo "line:" . __LINE__ . " Error: not id (" . $u_attendance_data[$k]["id"] . ")<br />";
			continue;
		}

		$j = -1;
		for($n=0; $n<count($u_day_array_2); $n++) {
			//if($u_modeId == "honbu") echo $u_day_array_2[$n]["year"] . " == " . $u_attendance_data[$k]["year"] . " && " . $u_day_array_2[$n]["month"] . " == " . $u_attendance_data[$k]["month"] . " && " . $u_day_array_2[$n]["day"] . " == " . $u_attendance_data[$k]["day"] . "<br />";

			if($u_day_array_2[$n]["year"] == $u_attendance_data[$k]["year"] && $u_day_array_2[$n]["month"] == $u_attendance_data[$k]["month"] && $u_day_array_2[$n]["day"] == $u_attendance_data[$k]["day"]) {
				$j = $n;
				break;
			}
		}
		if($j == -1) {
			echo "line:" . __LINE__ . " Error: not day (" . $u_modeId . " " . $u_attendance_data[$k][$ws_id] . " " . $u_attendance_data[$k]["year"] . "/" . $u_attendance_data[$k]["month"] . "/" . $u_attendance_data[$k]["day"] . ")<br />";
			continue;
		}

		//if($u_modeId == "honbu") echo "line:" . __LINE__ . " " . date("H:i:s") . " " .  $k . " " . $ws_ArData[$i]["id"] . "****<br />";
		$ws_ArData[$i]["dData"][$j]["match_flag"] = true;
		$ws_ArData[$i]["dData"][$j]["attendance_id"] = $u_attendance_data[$k]["id"];
		$ws_ArData[$i]["dData"][$j]["start_time"] = $u_attendance_data[$k]["start_time"];
		$ws_ArData[$i]["dData"][$j]["end_time"] = $u_attendance_data[$k]["end_time"];
		$ws_ArData[$i]["dData"][$j]["charge_area"] = $u_attendance_data[$k]["charge_area"];
		$ws_ArData[$i]["dData"][$j]["attendance_adjustment"] = $u_attendance_data[$k]["attendance_adjustment"];
		$ws_ArData[$i]["dData"][$j]["today_absence"] = $u_attendance_data[$k]["today_absence"];
		
		$ws_ArData[$i]["dData"][$j]["kekkin_flg"] = $u_attendance_data[$k]["kekkin_flg"];
		
		$ws_ArData[$i]["dData"][$j]["staff_area"] = str_replace("_bigao","",$u_attendance_data[$k]["area"]);
		
		$ws_ArData[$i]["dData"][$j]["syounin_state"] = $u_attendance_data[$k]["syounin_state"];
		
		$ws_ArData[$i]["dData"][$j]["jitaku_taiki_flg"] = $u_attendance_data[$k]["jitaku_taiki_flg"];

		//----勤怠セル表示内容の設定 in local
		$ws_ArData[$i]["dData"][$j]["html"] = PHP_dspAttendance($u_modeId, $u_maxId, $ws_ArData[$i]["dData"][$j]["match_flag"], $ws_ArData[$i]["dData"][$j]["today_absence"], $ws_ArData[$i]["dData"][$j]["kekkin_flg"], $ws_ArData[$i]["dData"][$j]["syounin_state"], $ws_ArData[$i]["dData"][$j]["start_time"], $ws_ArData[$i]["dData"][$j]["end_time"]);

		//if($u_modeId == "honbu") echo "line:" . __LINE__ . " " . $ws_ArData[$i]["dData"][$j]["html"] . " " . $ws_ArData[$i]["dData"][$j]["start_time"] . " " . $ws_ArData[$i]["dData"][$j]["end_time"] . "<br />";
		if($u_modeId == "therapist") {
			//----セラピストのみ
			if( $ws_ArData[$i]["dData"][$j]["attendance_adjustment"] == "1" ) {		//20150426の村上遥香1件のみ使用されていないかも？
				$ws_ArData[$i]["dData"][$j]["class"] = "one_4 gray";
			} else if( $ws_ArData[$i]["dData"][$j]["jitaku_taiki_flg"] == "1" ){
				$ws_ArData[$i]["dData"][$j]["class"] = "one_4 red";
			} else {
				if( $ws_ArData[$i]["rank"] == "1" ){
					$ws_ArData[$i]["dData"][$j]["class"] = "one_4 bk_rank_a";
				}else if( $ws_ArData[$i]["rank"] == "2" ){
					$ws_ArData[$i]["dData"][$j]["class"] = "one_4 bk_rank_b";
				}else if( $ws_ArData[$i]["rank"] == "3" ){
					$ws_ArData[$i]["dData"][$j]["class"] = "one_4 bk_rank_c";
				}else if( $ws_ArData[$i]["rank"] == "5" ){
					$ws_ArData[$i]["dData"][$j]["class"] = "one_4 bk_rank_d";
				}else if( $ws_ArData[$i]["rank"] == "4" ){
					$ws_ArData[$i]["dData"][$j]["class"] = "one_4 bk_rank_n";
				}else{
					$ws_ArData[$i]["dData"][$j]["class"] = "one_4";
				}
			}
			if($u_area == "kensyuu") {
				//echo $i . "-" . $j . "/" . $ws_ArData[$i]["dData"][$j]["start_time"] . " < " . $u_ArKensyuuPlan[$j]["start_time"] . "<br />";
				if($ws_ArData[$i]["dData"][$j]["start_time"] < $u_ArKensyuuPlan[$j]["start_time"] || $ws_ArData[$i]["dData"][$j]["end_time"] > $u_ArKensyuuPlan[$j]["end_time"]) {
					$ws_ArData[$i]["dData"][$j]["class"] = "one_4 pink";
				}
			}
		} else {
			//----その他
			//if($u_attendance_data[$k]["area"] == "yokohama" && $ws_ArData[$i]["kenmu"] == "yokohama") {		//横浜
			if($u_attendance_data[$k]["area"] != $ws_ArData[$i]["area"]) {		//横浜
				if($u_attendance_data[$k]["area"] == $u_area) {
					$ws_ArData[$i]["dData"][$j]["class"] = "one_4";
				} else {
					$ws_ArData[$i]["dData"][$j]["class"] = "one_4 blue";
				}
			} elseif( $ws_ArData[$i]["dData"][$j]["attendance_adjustment"] == "1" ) {		//20150426の村上遥香1件のみ使用されていないかも？
				$ws_ArData[$i]["dData"][$j]["class"] = "one_4 gray";
			} else {
				$ws_ArData[$i]["dData"][$j]["class"] = "one_4";
			}
		}
		//if($u_modeId == "driver") echo "line:" . __LINE__ . " " . date("H:i:s") . " " .  $k . "****<br />";
	}

	return $ws_ArData;
}

//----出勤データ取得(チーム別、待機場所別セラピスト用)
function PHP_setAttendance_team($u_area, $u_G, &$u_ArData, &$u_attendance_data, &$u_day_array_2, $u_maxId) {
global $team_data, $wait_select_data_2;

	$ws_ArData = $u_ArData;

	for($i=0; $i<count($ws_ArData["staff"]); $i++) {
		$ws_ArData["staff"][$i]["dData"] = array();
		for($j=0; $j<maxDays; $j++) {
			$ws_ArData["staff"][$i]["dData"][$j]["match_flag"] = false;
		}
	}
	$ws_qId = -1;
	for($k=0; $k<count($u_attendance_data); $k++) {
		$i = $u_attendance_data[$k]["R"];
		if($i == -1) {
			echo "line:" . __LINE__ . " Error: not id (" . $u_attendance_data[$k]["id"] . ")<br />";
			continue;
		}

		$j = -1;
		for($n=0; $n<count($u_day_array_2); $n++) {
			//if($u_modeId == "honbu") echo $u_day_array_2[$n]["year"] . " == " . $u_attendance_data[$k]["year"] . " && " . $u_day_array_2[$n]["month"] . " == " . $u_attendance_data[$k]["month"] . " && " . $u_day_array_2[$n]["day"] . " == " . $u_attendance_data[$k]["day"] . "<br />";

			if($u_day_array_2[$n]["year"] == $u_attendance_data[$k]["year"] && $u_day_array_2[$n]["month"] == $u_attendance_data[$k]["month"] && $u_day_array_2[$n]["day"] == $u_attendance_data[$k]["day"]) {
				$j = $n;
				break;
			}
		}
		if($j == -1) {
			echo "line:" . __LINE__ . " Error: not day (" . $u_modeId . " " . $u_attendance_data[$k][$ws_id] . " " . $u_attendance_data[$k]["year"] . "/" . $u_attendance_data[$k]["month"] . "/" . $u_attendance_data[$k]["day"] . ")<br />";
			continue;
		}

		$ws_ArData["staff"][$i]["dData"][$j]["match_flag"] = true;
		$ws_ArData["staff"][$i]["dData"][$j]["attendance_id"] = $u_attendance_data[$k]["id"];
		$ws_ArData["staff"][$i]["dData"][$j]["start_time"] = $u_attendance_data[$k]["start_time"];
		$ws_ArData["staff"][$i]["dData"][$j]["end_time"] = $u_attendance_data[$k]["end_time"];
		$ws_ArData["staff"][$i]["dData"][$j]["charge_area"] = $u_attendance_data[$k]["charge_area"];
		$ws_ArData["staff"][$i]["dData"][$j]["attendance_adjustment"] = $u_attendance_data[$k]["attendance_adjustment"];
		$ws_ArData["staff"][$i]["dData"][$j]["today_absence"] = $u_attendance_data[$k]["today_absence"];
		
		$ws_ArData["staff"][$i]["dData"][$j]["kekkin_flg"] = $u_attendance_data[$k]["kekkin_flg"];
		
		$ws_ArData["staff"][$i]["dData"][$j]["staff_area"] = str_replace("_bigao","",$u_attendance_data[$k]["area"]);
		
		$ws_ArData["staff"][$i]["dData"][$j]["syounin_state"] = $u_attendance_data[$k]["syounin_state"];
		
		$ws_ArData["staff"][$i]["dData"][$j]["jitaku_taiki_flg"] = $u_attendance_data[$k]["jitaku_taiki_flg"];

		//----勤怠セル表示内容の設定 in local
		//$ws_ArData["staff"][$i]["dData"][$j]["html"] = PHP_dspAttendance($u_attendance_data[$k]["area"], $ws_ArData["staff"][$i]["dData"][$j]["match_flag"], $ws_ArData["staff"][$i]["dData"][$j]["today_absence"], $ws_ArData["staff"][$i]["dData"][$j]["kekkin_flg"], $ws_ArData["staff"][$i]["dData"][$j]["syounin_state"], $ws_ArData["staff"][$i]["dData"][$j]["start_time"], $ws_ArData["staff"][$i]["dData"][$j]["end_time"]);
		$ws_ArData["staff"][$i]["dData"][$j]["html"] = PHP_dspAttendance("therapist", $u_maxId, $ws_ArData["staff"][$i]["dData"][$j]["match_flag"], $ws_ArData["staff"][$i]["dData"][$j]["today_absence"], $ws_ArData["staff"][$i]["dData"][$j]["kekkin_flg"], $ws_ArData["staff"][$i]["dData"][$j]["syounin_state"], $ws_ArData["staff"][$i]["dData"][$j]["start_time"], $ws_ArData["staff"][$i]["dData"][$j]["end_time"]);

		//if($u_modeId == "honbu") echo "line:" . __LINE__ . " " . $ws_ArData["staff"][$i]["dData"][$j]["html"] . " " . $ws_ArData["staff"][$i]["dData"][$j]["start_time"] . " " . $ws_ArData["staff"][$i]["dData"][$j]["end_time"] . "<br />";
		if( $ws_ArData["staff"][$i]["dData"][$j]["attendance_adjustment"] == "1" ) {	//20150426の村上遥香1件のみ使用されていないかも？
			$ws_ArData["staff"][$i]["dData"][$j]["class"] = "one_4 gray";
		} else if( $ws_ArData["staff"][$i]["dData"][$j]["jitaku_taiki_flg"] == "1" ){
			$ws_ArData["staff"][$i]["dData"][$j]["class"] = "one_4 red";
		} else {
			if($u_area == "wait") {
				$ws_Id = $wait_select_data_2[$u_G]["id"];
			} else {
				$ws_Id = $team_data[$u_G]["id"];
			}
			$ws_ArData["staff"][$i]["dData"][$j]["class"] = "one_4 " . $u_area . "_bg_" . $ws_Id;
		}
	}

	return $ws_ArData;
}

//----勤怠セル表示内容の設定
function PHP_dspAttendance($u_modeId, $u_maxId, $u_match_flag, $u_today_absence, $u_kekkin_flg, $u_syounin_state, $u_start_time, $u_end_time) {
	if($u_today_absence=="1"){
		$attendance_adjustment = 0;
		$charge_area = 0;
		$html = "当欠";
	} elseif( $u_kekkin_flg == "1" ) {
		$html = "欠勤";
		if( $syounin_state == "1" ) $html = "<b>" . $html . "</b>";
	}else if($u_syounin_state=="2"){
		$html = "不承認";
	}else{
		//echo "line:" . __LINE__ . " " . date("H:i:s") . " " . $u_start_time . " " . $u_end_time . " " . $u_syounin_state . "<br />";
		$html = PHP_get_attendance_disp_time($u_modeId, $u_maxId, $u_start_time, $u_end_time, $u_syounin_state);		//表示用勤務時間編集
		if( $syounin_state == "1" ) $html = "<b>" . $html . "</b>";
	}
	return $html;
}

//----研修スケジュール取得
function PHP_getArKensyuuPlan(&$u_Arday, $u_max) {
	$ws_retTimes = array();
	for($i=0; $i<count($u_Arday); $i++) {
		$ws_retTimes[$i] = array("Ymd" => $u_Arday[$i]["Ymd"], "start_time" => -999, "end_time" => -999, "day_id" => "");
	}
	
	$ws_SQL = "select * from attendance_kensyuu_all where delete_flg=0 and (year*10000+month*100+day)>='%s' and (year*10000+month*100+day)<='%s'";
	$sql = sprintf($ws_SQL, $u_Arday[0]["Ymd"], $u_Arday[($u_max - 1)]["Ymd"]);
	$res = mysql_query($sql, DbCon);
	//echo $res . "/" . $sql . "<br />";
	if($res == false){
		echo "error!(PHP_getArKensyuuPlan)";
		exit();
	}
	$ws_rows = mysql_num_rows($res);
	while($row = mysql_fetch_assoc($res)) {
		$i = PHP_serachArDay($row["year"], $row["month"], $row["day"], $u_Arday);
		if($i < 0) {
			echo "Error: not date (" . $row["year"] . "/" . $row["month"] . "/" . $row["day"] . ")";
			continue;
		}
		$ws_retTimes[$i]["start_time"] = $row["start_time"];
		$ws_retTimes[$i]["end_time"] = $row["end_time"];
		$ws_retTimes[$i]["day_id"] = sprintf("day_%s_%s_%s_%s", $row["year"], $row["month"], $row["day"], "kensyuu");
		//echo $i . "/" . $ws_retTimes[$i]["Ymd"] . " : " . $ws_retTimes[$i]["start_time"] . " --> " . $ws_retTimes[$i]["end_time"] . "<br />";
	}
	return $ws_retTimes;
}

//----エリア別営業日データ取得
function PHP_get_attendance_request_state(&$u_Arday, $u_max, $u_area){

	$ws_area = $u_area;
	if($u_area == "team" || $u_area == "wait") $ws_area = "tokyo";

	for($i=0; $i<count($u_Arday); $i++) {
		$ws_day_id[$i] = "";
	}

	$ws_SQL = "select year,month,day,id from attendance_request where delete_flg=0 and (year*10000+month*100+day)>='%s' and (year*10000+month*100+day)<='%s' and area='%s' order by year,month,day,id";
	$sql = sprintf($ws_SQL, $u_Arday[0]["Ymd"], $u_Arday[($u_max - 1)]["Ymd"], $ws_area);
	$res = mysql_query($sql, DbCon);
	//echo $res . "/" . $sql . "<br />";
	if($res == false){
		echo "error!(PHP_get_attendance_request_state)";
		exit();
	}
	$ws_rows = mysql_num_rows($res);
	while($row = mysql_fetch_assoc($res)) {
		$i = PHP_serachArDay($row["year"], $row["month"], $row["day"], $u_Arday);
		if($i < 0) {
			echo "Error: not date (" . $row["year"] . "/" . $row["month"] . "/" . $row["day"] . ")";
			continue;
		}
		$ws_day_id[$i] = sprintf("day_%s_%s_%s_%s", $row["year"], $row["month"], $row["day"], $ws_area);
	}
	return $ws_day_id;
}

//出席データの取得(研修日)
function PHP_get_attendance_data_by_attendance_kensyuu_all(&$u_day_array_2) {

	$ws_SQL = "select * from attendance_kensyuu_all where (year*10000+month*100+day)>='%s' and (year*10000+month*100+day)<='%s'";
	$sql = sprintf($ws_SQL, $u_day_array_2[0]["Ymd"], $u_day_array_2[(count($u_day_array_2) - 1)]["Ymd"]);
	$res = mysql_query($sql, DbCon);
	if($res == false){
		echo "クエリ実行に失敗しました(PHP_get_attendance_data_by_attendance_kensyuu_all) " . $sql;
		exit();
	}
	$row = mysql_fetch_assoc($res);

	return $row;
}

//----セラピスト出勤数集計
function PHP_get_therapist_attendance_num_new($u_days, &$u_Data, $u_maxGroup) {

	$ws_MaxDays = count($u_days);
	for($a=0; $a<$u_maxGroup; $a++) {
		for($j=0; $j<$ws_MaxDays; $j++) {
			$ws_ArRet[$a][$j] = array("nums" => 0, "id" => array());
		}
	}

	for($a=0; $a<count($u_Data); $a++) {
		for($n=0; $n<count($u_Data[$a]); $n++) {
			$j = PHP_serachArDay($u_Data[$a][$n]["year"], $u_Data[$a][$n]["month"], $u_Data[$a][$n]["day"], $u_days);
			if($j == -1) continue;
			if($u_Data[$a][$n]["kekkin_flg"] == 1 || $u_Data[$a][$n]["today_absence"] == 1) continue;
			$ws_ArRet[$a][$j]["nums"]++;
			//echo $j . " " . $ws_ArRet[$a][$j]["nums"] . "/" . $u_Data[$a][$n]["year"] . "-" . $u_Data[$a][$n]["month"] . "-" . $u_Data[$a][$n]["day"] . "<br />";
		}
	}

	return $ws_ArRet;
}

//----セラピスト情報取得
function PHP_get_therapist_data_for_therapist_calendar($u_area, $u_team_num) {
global $ARRAY_tokyoArea;
global $team_data, $wait_select_data_2;

	//$where_kenmu = "kenmu like '%".$u_area."%'";

	if( $u_area == "kensyuu" ) {
		$sql = "select id,area,name,name_site,name_aroma,rank,kenmu,order_num,rank_order_num from therapist_new where delete_flg=0 and leave_flg=0 and kensyuu_flg='1' order by order_num desc,id";
	} elseif( $u_area == "team" ) {
		$sql = "select id,area,team_id,name,name_site,name_aroma,rank,kenmu,order_num,rank_order_num from therapist_new where delete_flg=0 and leave_flg=0 and area='tokyo' order by team_id,id";
	} elseif( $u_area == "wait" ) {
		$sql = "select id,area,wait_select,name,name_site,name_aroma,rank,kenmu,order_num,rank_order_num from therapist_new where delete_flg=0 and leave_flg=0 and area='tokyo' and (wait_select>0 or wait_select=-1) order by wait_select desc,rank_order_num,order_num,id";
	} elseif( $u_area == "tokyo" ) {
		$where_add_tokyo = "area='yokohama' and kensyuu_flg=1";
		$sql = sprintf("select id,area,name,name_site,name_aroma,rank,kenmu,order_num,rank_order_num from therapist_new where delete_flg=0 and leave_flg=0 and (area in('tokyo','tokyo_reraku','tokyo_bigao') or kenmu='yokohama' or (%s)) order by ((1000-rank_order_num)*1000000+order_num) desc,id", $where_add_tokyo);
	} elseif( $u_area == "yokohama" ) {
		$where_kenmu = "kenmu like '%". $u_area ."%'";
		$ws_SQL = "select id,area,name,name_site,name_aroma,rank,kenmu,order_num,rank_order_num,'0' as kenmu_mark from therapist_new where delete_flg=0 and leave_flg=0 and area='%s'";
		$ws_SQL .= " union ";
		$ws_SQL .= "select id,area,name,name_site,name_aroma,rank,kenmu,order_num,rank_order_num,'1' as kenmu_mark from therapist_new where delete_flg=0 and leave_flg=0 and area='tokyo' and %s";
		//$ws_SQL .= " order by kenmu_mark,rank desc,order_num desc,id";
		$ws_SQL .= " order by kenmu_mark,((1000-rank_order_num)*1000000+order_num) desc,id";
		$sql = sprintf($ws_SQL, $u_area, $where_kenmu);
	} else {
		$sql = sprintf("select id,area,name,name_site,name_aroma,rank,kenmu,order_num,rank_order_num from therapist_new where delete_flg=0 and leave_flg=0 and area='%s' order by ((1000-rank_order_num)*1000000+order_num) desc,id", $u_area);
	}
	$res = mysql_query($sql, DbCon);
	//echo "line:" . __LINE__ . " " . $res . "/" . $sql . "<br />";
	if($res == false){
		echo "error!(get_therapist_data_for_therapist_calendar)";
		exit();
	}

	$therapist_data = array();

	// 一覧に表示される顧客データを変数に格納する処理
	switch($u_area) {
		case "team":
		case "wait":
			if($u_area == "wait") {
				$therapist_data = $wait_select_data_2;
				$ws_Id = "wait_select";
			} else {
				$therapist_data = $team_data;
				$ws_Id = "team_id";
			}
			for($g=0; $g<count($therapist_data); $g++) {
				$therapist_data[$g]["nums"] = 0;
				$therapist_data[$g]["staff"] = array();
				if($u_area == "team" && ($g + 1) < count($therapist_data)) $therapist_data[$g]["name"] = "チーム" . $therapist_data[$g]["name"];
				//if($u_area == "wait" && $therapist_data[$g]["id"] == -1) $therapist_data[$g]["id"] = 4;
			}
			$ws_qId = -9999;
			break;
		case "tokyo":
			for($a=0; $a<areaNums; $a++) {
				$ix[$a] = 0;
			}
			break;

	}

	$i = 0;

	while($row = mysql_fetch_assoc($res)) {
		switch($u_area) {
			case "team":
			case "wait":
				if($u_area == "team" && $row[$ws_Id] == -1) $row[$ws_Id] = $u_team_num + 1;
				if($row[$ws_Id] != $ws_qId) {
					if($ws_qId > -9999) $therapist_data[$g]["nums"] = $i;		//チーム別または待機場所別のセラピスト数
					$g = PHP_getGroupIdx($row[$ws_Id], $therapist_data);		//チームId若しくは待機場所Idの取得
					if($g == -1) continue;
					$ws_qId = $row[$ws_Id];
					$i = 0;
				}
				$therapist_data[$g]["staff"][$i] = $row;
				$therapist_data[$g]["staff"][$i]["dData"] = array();
				$i++;
				break;
			case "tokyo":
				$x = 0;
				for($a=1; $a<areaNums; $a++) {
					if($row["area"] == "tokyo_" . $ARRAY_tokyoArea[$a]) {
						$x = $a;
						break;
					}
				}
				$therapist_data[$x][$ix[$x]] = $row;
				$ix[$x]++;
				break;
			default:
				$therapist_data[0][$i] = $row;
				$i++;
		}
	}

	switch($u_area) {
		case "team":
		case "wait":
			if($ws_qId > -9999) $therapist_data[$g]["nums"] = $i;		//チーム別または待機場所別のセラピスト数
			break;
		default:
			for($a=0; $a<areaNums; $a++) {
				$therapist_data[$a] = PHP_order_value_sort_free($therapist_data[$a]);
			}
	}
	return $therapist_data;
}

//order_value並べ替えの処理(FREE)
function PHP_order_value_sort_free($data){

	foreach ($data as $key => $val){

		//$rank = $val["rank"];
		$rank_order_num = $val["rank_order_num"];

		$order_num = $val["order_num"];

		//$tmp = 100 - $rank;
		$tmp = 1000 - $rank_order_num;

		$order_value[$key] = ($tmp*1000000)+$order_num;

	}
	array_multisort($order_value, SORT_DESC, $data);

	return $data;
}

//----セラピストの出勤データを取得
function PHP_get_attendance_data_for_therapist_calendar($u_area, &$u_days, &$u_therapist_data) {
global $ARRAY_tokyoArea;

	$ws_max = count($u_days);
	$ws_FromDate = $u_days[0]["year"] * 10000 + $u_days[0]["month"] * 100 + $u_days[0]["day"];
	$ws_ToDate = $u_days[($ws_max-1)]["year"] * 10000 + $u_days[($ws_max-1)]["month"] * 100 + $u_days[($ws_max-1)]["day"];

	switch($u_area) {
	case "kensyuu":
		$ws_SQL = "select * from attendance_kensyuu where (year*10000+month*100+day)>='%s' and (year*10000+month*100+day)<='%s'";
		$sql = sprintf($ws_SQL, $ws_FromDate, $ws_ToDate);
		break;
	case "team":
		$ws_SQL = "select A.*,B.team_id from attendance_new A";
		$ws_SQL .= " left join therapist_new B on B.id=A.therapist_id";
		$ws_SQL .= " where B.delete_flg=0 and B.leave_flg=0";
		$ws_SQL .= " and (A.year*10000+A.month*100+A.day)>='%s' and (A.year*10000+A.month*100+A.day)<='%s' and A.area='tokyo'";
		$ws_SQL .= " order by team_id,therapist_id,year,month,day";
		$sql = sprintf($ws_SQL, $ws_FromDate, $ws_ToDate);
		break;
	case "wait":
		$ws_SQL = "select A.*,B.wait_select from attendance_new A";
		$ws_SQL .= " left join therapist_new B on B.id=A.therapist_id";
		$ws_SQL .= " where B.delete_flg=0 and B.leave_flg=0 and (B.wait_select>0 or B.wait_select=-1)";
		$ws_SQL .= " and (A.year*10000+A.month*100+A.day)>='%s' and (A.year*10000+A.month*100+A.day)<='%s' and A.area='tokyo'";
		$ws_SQL .= " order by wait_select desc,therapist_id,year,month,day";
		$sql = sprintf($ws_SQL, $ws_FromDate, $ws_ToDate);
		break;
	default:
		if($u_area == "tokyo") {
			$ws_AreaS = "(A.area='" . $u_area . "' or A.area='" . $u_area . "_reraku' or A.area='" . $u_area . "_bigao')";
		} else {
			$ws_AreaS = "A.area='" . $u_area . "'";
		}
		$ws_SQL = "select (year*10000+month*100+day) as ymd,'0' as FLAG_area,A.* from attendance_new A";
		$ws_SQL .= " left join therapist_new B on B.id=A.therapist_id";
		$ws_SQL .= " where B.delete_flg='0' and B.leave_flg='0' and B.test_flg='0' and B.rank<>'19'";
		$ws_SQL .= " and (A.year*10000+A.month*100+A.day)>='%s' and (A.year*10000+A.month*100+A.day)<='%s' and %s";
		$sql = sprintf($ws_SQL, $ws_FromDate, $ws_ToDate, $ws_AreaS);

		if( $u_area == "yokohama" ){
			$where_kenmu = "B.kenmu like '%".$u_area."%'";

			$ws_SQL = " union ";
			$ws_SQL .= "select (year*10000+month*100+day) as ymd,'1' as FLAG_area,A.* from attendance_new A";
			$ws_SQL .= " left join therapist_new B on B.id=A.therapist_id";
			$ws_SQL .= " where B.delete_flg='0' and B.leave_flg='0' and B.test_flg='0' and B.rank<>'19' and (%s)";
			$ws_SQL .= " and (A.year*10000+A.month*100+A.day)>='%s' and (A.year*10000+A.month*100+A.day)<='%s' and A.charge_area=2 and A.area='tokyo'";
			$sql .= sprintf($ws_SQL, $where_kenmu, $ws_FromDate, $ws_ToDate);
		}
		$sql .= " order by ymd,FLAG_area,area,therapist_id";
	}
	$res = mysql_query($sql, DbCon);
	//echo "line:" . __LINE__ . " " . date("H:i:s") . " " . $res . "/" . $sql . "<br />";
	if($res == false){
		echo "line:" . __LINE__ . " error!(get_attendance_data_for_staff_calendar) " . $sql . "<br />";
		exit();
	}

	$data = array();

	//---- 一覧に表示される顧客データを変数に格納する処理
	switch($u_area) {
		case "team":
		case "wait":
			$ws_qId = -9999;
			for($g=0; $g<count($u_therapist_data); $g++) { $data[$g] = array(); }
			if($u_area == "wait") $ws_Id = "wait_select"; else $ws_Id = "team_id";
			break;
		case "tokyo":
			$ir = 0;
			$ib = 0;
			break;
	}

	$i = 0;
	while($row = mysql_fetch_assoc($res)) {
		//$ws_Idx = PHP_serachArDay($row["year"], $row["month"], $row["day"], $u_day_array_2);
		//if($row["kekkin_flg"] == 0 && $row["today_absence"] == 0) $ws_num = 1; else $ws_num = 0;
		switch($u_area) {
			case "team":
			case "wait":
				if($u_area == "team" && $row[$ws_Id] == -1) $row[$ws_Id] = count($u_therapist_data);
				if($row[$ws_Id] != $ws_qId) {
					$ws_qId = $row[$ws_Id];
					$g = PHP_getGroupIdx($ws_qId, $u_therapist_data);		//チームId若しくは待機場所Idの取得
					$i = 0;
				}
				$data[$g][$i] = $row;
				$i++;
				break;
			case "tokyo":
				if($row["area"] == $u_area . "_" . $ARRAY_tokyoArea[1]) {
					$data[1][$ir] = $row;		//リラク
					$ir++;
				} elseif($row["area"] == $u_area . "_" . $ARRAY_tokyoArea[2]) {
					$data[2][$ib] = $row;		//BIGAO
					$ib++;
				} else {
					$data[0][$i] = $row;
					$i++;
				}
				break;
			default:
				$data[0][$i] = $row;
				$i++;
		}
	}

	//----セラピスト情報indexの追加
	switch($u_area) {
		case "team":
		case "wait":
			for($g=0; $g<count($data); $g++) {
				$ws_arStffIds = array();
				for($n=0; $n<count($u_therapist_data[$g]["staff"]); $n++) {
					$ws_arStffIds[$n] = $u_therapist_data[$g]["staff"][$n]["id"];
					//echo "line:" . __LINE__ . " " . $n . " " . $ws_arStffIds[$n] . " = " . $u_therapist_data[$g]["staff"][$n]["id"] . " / " . $u_therapist_data[$g]["staff"][$n]["team_id"]. "<br />";
				}
				$ws_qId = -1;
				for($d=0; $d<count($data[$g]); $d++) {
					if($data[$g][$d]["therapist_id"] != $ws_qId) {
						$ws_qId = $data[$g][$d]["therapist_id"];
						$ws_Idx = array_search($ws_qId, $ws_arStffIds);
						if($ws_Idx === false) {
							//echo "line:" . __LINE__ . " Error:un search staffid ( " . $ws_qId . " )<br />";
							$ws_Idx = -1;
						}
					}
					$data[$g][$d]["R"] = $ws_Idx;
				}
			}
			break;
		default:
			for($a=0; $a<areaNums; $a++) {
				$ws_arStffIds = array();
				for($n=0; $n<count($u_therapist_data[$a]); $n++) {
					$ws_arStffIds[$n] = $u_therapist_data[$a][$n]["id"];
					//echo $n . " " . $ws_arStffIds[$n] . " = " . $u_therapist_data[$a][$n]["id"] . "<br />";
				}
				$ws_qId = -1;
				for($d=0; $d<count($data[$a]); $d++) {
					if($data[$a][$d]["therapist_id"] != $ws_qId) {
						$ws_qId = $data[$a][$d]["therapist_id"];
						$ws_Idx = array_search($ws_qId, $ws_arStffIds);
						if($ws_Idx === false) $ws_Idx = -1;
					}
					$data[$a][$d]["R"] = $ws_Idx;
					//echo "line:" . __LINE__ . " a:" . $a . " d:" . $d . " R:" . $ws_Idx . " " . $ws_qId . " )<br />";
				}
			}
	}

	return $data;
}

//----チームId若しくは待機場所Idの取得
function PHP_getGroupIdx($u_Id, &$u_therapist_data) {
	$g = -1;
	for($n=0; $n<count($u_therapist_data); $n++) {
		if($u_therapist_data[$n]["id"] == $u_Id) {
			$g = $n;
			break;
		}
	}
	return $g;
}

//----本部またはドライバーの出勤数取得
function PHP_set_staff_attendance_num($u_area, &$u_ArData, &$u_ardays) {
	for($j=0; $j<count($u_ardays); $j++) {
		$ws_ArRet[$j] = 0;
	}

	for($i=0; $i<count($u_ArData); $i++) {
		for($j=0; $j<count($u_ardays); $j++) {
			if($u_ArData[$i]["dData"][$j]["match_flag"]) {
				//echo $u_ArData[$i]["id"] . " " . $u_ArData[$i]["name"] . " " . $u_ArData[$i]["dData"][$j]["staff_area"] . "<br />";
				if($u_ArData[$i]["dData"][$j]["staff_area"] != $u_area) continue;
				if($u_ArData[$i]["dData"][$j]["today_absence"] != "1" && $u_ArData[$i]["dData"][$j]["kekkin_flg"] != "1") $ws_ArRet[$j]++;
				//if($u_ArData[$i]["dData"][$j]["start_time"]) $ws_ArRet[$j]++;
			}
		}
	}
	return $ws_ArRet;
}

//----スタッフ情報の取得
function PHP_getStaffData4staff_calendar($u_area) {

	$sql = sprintf("select id,name,type,area,kenmu from staff_new_new where delete_flg='0' and leave_flg='0' and calendar_disp_flg='1' and area='%s' order by order_num desc,id", $u_area);
	$res = mysql_query($sql, DbCon);
	//echo "line:" . __LINE__ . " " . date("H:i:s") . " " . $res . "/" . $sql . "<br />";
	if($res == false){
		echo "error!(get_staff_data_for_staff_calendar)";
		exit();
	}

	$d = 0;
	$h = 0; 
	$list_data = array();
	while($row = mysql_fetch_assoc($res)) {
		if($row["type"] == "driver") {
			$list_data["driver"][$d] = $row;
			$d++;
		} elseif($row["type"] == "honbu") {
			$list_data["honbu"][$h] = $row;
			$h++;
		}
	}
	//if( ( $type == "driver" ) && ( $u_area != "tokyo" ) ){
	if($u_area == "yokohama") {

		$where_kenmu = "kenmu like '%" . $u_area. "%'";

		$area_tokyo = "tokyo";

		$sql = sprintf("select id,name,type,area,kenmu from staff_new_new where delete_flg='0' and leave_flg='0' and area='%s' and type='driver' and %s order by order_num,id desc", $area_tokyo, $where_kenmu);
		$res = mysql_query($sql, DbCon);
		if($res == false){
			echo "error!(get_staff_data_for_staff_calendar)";
			exit();
		}

		while($row = mysql_fetch_assoc($res)){
			$list_data["driver"][$d] = $row;
			$list_data["driver"][$d]["name"] .= "(兼務)";
			$d++;
		}
	} elseif($u_area == "tokyo") {
		for($d=0; $d<count($list_data["driver"]); $d++) {
			if($list_data["driver"][$d]["kenmu"] == "yokohama") $list_data["driver"][$d]["name"] .= "(兼務)";
		}
	}
	return $list_data;
}

//----スタッフの出勤データを取得
function PHP_get_staff_attendance($u_area, &$u_day_array_2, &$u_staff) {

	//----出勤データを取得するためのSQL文
	$ws_SQL = "select A.id,A.area,A.staff_id,A.year,A.month,A.day,A.week,A.start_time,A.end_time,A.today_absence,A.attendance_adjustment,A.syounin_state,A.type,'0' from attendance_staff_new A";
	$ws_SQL .= " left outer join staff_new_new B on A.staff_id=B.id";
	$ws_SQL .= " where (A.year*10000+A.month*100+A.day)>='%s' and (A.year*10000+A.month*100+A.day)<='%s' and B.area='%s'";
	$ws_SQL .= " order by type,staff_id,year,month,day";
	$sql = sprintf($ws_SQL, $u_day_array_2[0]["Ymd"], $u_day_array_2[(count($u_day_array_2) - 1)]["Ymd"], $u_area);
	$res = mysql_query($sql, DbCon);
	//echo "line:" . __LINE__ . " ". $res . "/" . $sql . "<br />";
	if($res == false){
		echo "line:" . __LINE__ . " error!(get_staff_attendance_data_new) " . $sql;
		exit();
	}

	$data = array();

	$d = 0;
	$h = 0;
	while($row = mysql_fetch_assoc($res)) {
		if($row["type"] == "driver") {
			$data["driver"][$d] = $row;
			$d++;
		} elseif($row["type"] == "honbu") {
			$data["honbu"][$h] = $row;
			$h++;
		}
	}

	//if( $type == "driver" && $u_area != "tokyo" ){
	if($u_area == "yokohama") {
		$where_kenmu = "B.kenmu like '%yokohama%'";

		// 出勤データを取得するためのSQL文(東京の兼務)
		$ws_SQL = "select A.id,A.area,A.staff_id,A.year,A.month,A.day,A.week,A.start_time,A.end_time,A.today_absence,A.attendance_adjustment,A.syounin_state,A.type,B.kenmu from attendance_staff_new A";
		$ws_SQL .= " left join staff_new_new B on B.id=A.staff_id";
		$ws_SQL .= " where A.area='yokohama' and (A.year*10000+A.month*100+A.day)>='%s' and (A.year*10000+A.month*100+A.day)<='%s' and %s";
		$ws_SQL .= " order by type,staff_id,year,month,day";
		$sql = sprintf($ws_SQL, $u_day_array_2[0]["Ymd"], $u_day_array_2[(count($u_day_array_2) - 1)]["Ymd"], $where_kenmu);
		$res = mysql_query($sql, DbCon);
		//echo $res . "/" . $sql;
		if($res == false){
			echo "line:" . __LINE__ . " error!(get_staff_attendance_data_new) " . $sql;
			exit();
		}
		while($row = mysql_fetch_assoc($res)){
			$data["driver"][$d] = $row;
			$d++;
		}
	}

	//----ドライバー情報indexの追加
	$ws_arStffIds = array();
	for($n=0; $n<count($u_staff["driver"]); $n++) {
		$ws_arStffIds[$n] = $u_staff["driver"][$n]["id"];
		//echo $n . " " . $ws_arStffIds[$n] . " = " . $u_staff["driver"][$n]["id"] . "<br />";
	}
	$ws_qId = -1;
	for($d=0; $d<count($data["driver"]); $d++) {
		if($data["driver"][$d]["staff_id"] != $ws_qId) {
			$ws_qId = $data["driver"][$d]["staff_id"];
			$ws_Idx = array_search($ws_qId, $ws_arStffIds);
			if($ws_Idx === false) {
				//echo "line:" . __LINE__ . " Error:un search staffid ( " . $ws_qId . " )<br />";
				$ws_Idx = -1;
			}
		}
		$data["driver"][$d]["R"] = $ws_Idx;
	}

	if($u_area == "tokyo") {
		//----本部スタッフ情報indexの追加
		$ws_arStffIds = array();
		for($n=0; $n<count($u_staff["honbu"]); $n++) {
			$ws_arStffIds[$n] = $u_staff["honbu"][$n]["id"];
		}
		$ws_qId = -1;
		for($d=0; $d<count($data["honbu"]); $d++) {
			if($data["honbu"][$d]["staff_id"] != $ws_qId) {
				$ws_qId = $data["honbu"][$d]["staff_id"];
				$ws_Idx = array_search($ws_qId, $ws_arStffIds);
				if($ws_Idx === false) {
					//echo "line:" . __LINE__ . " Error:un search staffid ( " . $ws_qId . " )<br />";
					$ws_Idx = -1;
				}
			}
			$data["honbu"][$d]["R"] = $ws_Idx;
		}
	}
	//echo "line:" . __LINE__ . " driver counts:". count($data["driver"]) . " honbu counts:" . count($data["honbu"]) . "<br />";
	return $data;
}

//----表示用勤務時間編集
function PHP_get_attendance_disp_time($u_modeId, $u_maxId, $start_time, $end_time, $syounin_state) {
global $time_array, $time_array_honbu, $time_array_driver;
global $w_ArTime;

	$data = "";

	if($u_modeId == "driver") {
		$hour_start = $w_ArTime["driver"][($start_time-1)]["hour"];
		$minute_start = $w_ArTime["driver"][($start_time-1)]["minute"];
		$hour_end = $w_ArTime["driver"][($end_time-1)]["hour"];
		$minute_end = $w_ArTime["driver"][($end_time-1)]["minute"];
		//$hour_start = $time_array_driver[$start_time]["hour"];
		//$minute_start = $time_array_driver[$start_time]["minute"];
		//$hour_end = $time_array_driver[$end_time]["hour"];
		//$minute_end = $time_array_driver[$end_time]["minute"];

		//if( $hour_start >= 24 ) $hour_start = $hour_start - 24;
		//if( $hour_end >= 24 ) $hour_end = $hour_end - 24;
	} elseif($u_modeId == "honbu") {
		$hour_start = $w_ArTime["honbu"][($start_time+9)]["hour"];
		$minute_start = $w_ArTime["honbu"][($start_time+9)]["minute"];
		$hour_end = $w_ArTime["honbu"][($end_time+9)]["hour"];
		$minute_end = $w_ArTime["honbu"][($end_time+9)]["minute"];
		//$hour_start = $time_array_honbu[$start_time]["hour"];
		//$minute_start = $time_array_honbu[$start_time]["minute"];
		//$hour_end = $time_array_honbu[$end_time]["hour"];
		//$minute_end = $time_array_honbu[$end_time]["minute"];
	} else {
		$hour_start = $w_ArTime["therapist"][($start_time-1)]["hour"];
		$minute_start = $w_ArTime["therapist"][($start_time-1)]["minute"];
		$hour_end = $w_ArTime["therapist"][($end_time-1)]["hour"];
		$minute_end = $w_ArTime["therapist"][($end_time-1)]["minute"];
		//$hour_start = $time_array[$start_time]["hour"];
		//$minute_start = $time_array[$start_time]["minute"];
		//$hour_end = $time_array[$end_time]["hour"];
		//$minute_end = $time_array[$end_time]["minute"];
	}
	//echo $u_modeId . ": " . $end_time . "==" . $u_maxId. "<br />";
	if($end_time == $u_maxId) {
		$data = $hour_start . "時";
		if($minute_start == "0") $data = $hour_start . "時"; else $data = $hour_start . '.5時';
	} else {
		if($minute_start != "0") $hour_start = $hour_start . ".5";
		if($minute_end != "0") $hour_end = $hour_end . ".5";
		$data = $hour_start . "-" . $hour_end;
	}

	//if( $syounin_state == "1" ) $data = '<span style="font-weight:bold;font-size:12px;">'.$data.'</span>';
	if( $syounin_state == "1" ) $data = '<b>'.$data.'</b>';

	return $data;
}
?>
