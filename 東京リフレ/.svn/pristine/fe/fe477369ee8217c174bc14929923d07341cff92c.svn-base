<?php

include("../../../../include/common.php");

include(ROOT_PATH."include/vip/auth_ssl.php");

include(COMMON_INC."auth_ssl.php");



//東京リフレ
$shop_id = 1;
$shop_area = "tokyo";

$course_array = array(
    "0" => "90",
    "1" => "120",
	"2" => "150",
	"3" => "180",
	"4" => "210",
	"5" => "240",
	"6" => "270",
	"7" => "300"
);

$w_nowTime = PHP_getNowTime();	//現在時時刻取得 in common/include/today.inc

$therapist_id = -1;
$year = intval(date('Y', $w_nowTime));
$month = intval(date('m', $w_nowTime));
$day = intval(date('d', $w_nowTime));
$time = -1;

$customer_id = $_SESSION["customer_id"];

if(isset($_POST["send"])==true){

	$year = $_POST["year"];
	$month_day = explode("_",$_POST["day"]);
	$month = $month_day[0];
	$day = $month_day[1];
	$time = $_POST["time"];
	$therapist_id = $_POST["therapist_id"];
	$course = $_POST["course"];
	$free = $_POST["free"];
	$mail = $_POST["mail"];
	$notherapist = $_POST["notherapist"];
	$error = "";
	
	if( $notherapist == true ){
		
		$error .= "<li>"."ご指名セラピストが未選択です"."</li>";
		
	}else if( $therapist_id == "" ){

		$error .= "<li>"."ご指名セラピストが未選択です"."</li>";

	}

	if($course=="-1"){

		$error .= "<li>"."ご利用予定コースが未選択です"."</li>";

	}

	if($mail==""){

		$error .= "<li>"."メールアドレスが未入力です"."</li>";

	}else{


		if(!preg_match("/^([a-zA-Z0-9])+([a-zA-Z0-9\._-])*@([a-zA-Z0-9_-])+([a-zA-Z0-9\._-]+)+$/", $mail)){
				
			$error .= "<li>メールアドレスの形式が正しくありません</li>";
				
		}else{

			//メールアドレス重複チェック
			$result = mail_check_for_vip_page_common($customer_id,$shop_id,$mail);
			
			if( $result == true ){
				
				//$error .= "<li>"."登録済みのメールアドレスです"."</li>";
				$error .= "";
				
			}
			
		}

	}

	if($error != ""){
		$error = "<ul class='error'>".$error."</ul>";
	}else{

		$_SESSION["shop_id"] = $shop_id;
		$_SESSION["year"] = $year;
		$_SESSION["month"] = $month;
		$_SESSION["day"] = $day;
		$_SESSION["time"] = $time;
		$_SESSION["therapist_id"] = $therapist_id;
		$_SESSION["course"] = $course;
		$_SESSION["free"] = $free;
		$_SESSION["mail"] = $mail;
		
		$url = sprintf("%sssl/%s/vip/reservation/confirm.php",WWW_URL_SSL,$shop_area);

		header("Location: ".$url);
		exit();

	}

}else if(isset($_POST["back"])==true){
	
	$year = $_POST["year"];
	$month_day = explode("_",$_POST["day"]);
	$month = $month_day[0];
	$day = $month_day[1];
	
	$url = sprintf("%sssl/%s/vip/therapist_calendar.php?year=%s&month=%s&day=%s",
WWW_URL_SSL,$shop_area,$year,$month,$day);

	header("Location: ".$url);
	exit();

}else if(isset($_GET["back"])==true){

	$shop_id = $_SESSION["shop_id"];
	$year = $_SESSION["year"];
	$month = $_SESSION["month"];
	$day = $_SESSION["day"];
	$time = $_SESSION["time"];
	$therapist_id = $_SESSION["therapist_id"];
	$course = $_SESSION["course"];
	$free = $_SESSION["free"];
	$mail = $_SESSION["mail"];

}else{

	if(isset($_GET["therapist_id"])==true){
		$therapist_id = $_GET["therapist_id"];
	}
	
	if(isset($_GET["year"])==true){
		$year = $_GET["year"];
	}
	
	if(isset($_GET["month"])==true){
		$month = $_GET["month"];
	}
	
	if(isset($_GET["day"])==true){
		$day = $_GET["day"];
	}
	
	if(isset($_GET["time"])==true){
		$time = $_GET["time"];
		//$time = $time - 12;
	}
	
	$mail = get_customer_mail_for_vip_page($customer_id);
	
}

$attendance_data = get_attendance_data_for_vip_page_3_common($shop_area,$year,$month,$day,$time,$_SESSION["customer_type"],$customer_id);

/*
echo "<pre>";
print_r($attendance_data);
echo "</pre>";
exit();
*/

$radio_frm_therapist = get_radio_frm_therapist_for_vip_reservation_input_common($attendance_data,$therapist_id,$access_type);

$attendance_data_num = count($attendance_data);

$time_select_option = get_time_array_select_option_vip_2_common($time);

$select_frm_course = get_select_frm_course_for_vip_reservation_input_common($course,$shop_area);

$pankuzu = sprintf('　＞　<a href="%sssl/%s/vip/therapist_calendar.php">セラピスト出勤カレンダー</a>　＞　予約フォーム入力',
WWW_URL_SSL,$shop_area);

$page_title = "予約フォーム入力";
$params['page_title'] = $page_title;

//----Smarty
$params['css_time'] = date("ymdHi");		//CSS等のキャッシュ回避用
$params['pankuzu'] = $pankuzu;
$params['day_array'] = $day_array;
$params['week_array'] = $week_array;
$params['time_array'] = $time_array;
$params['course_array'] = $course_array;
$params['course'] = $course;
$params['year'] = $year;
$params['month'] = $month;
$params['day'] = $day;
$params['time'] = $time;
$params['attendance_data_num'] = $attendance_data_num;
$params['attendance_data'] = $attendance_data;
$params['therapist_id'] = $therapist_id;
$params['free'] = $free;
$params['mail'] = $mail;
$params['select_frm_course'] = $select_frm_course;
$params['radio_frm_therapist'] = $radio_frm_therapist;
$params['customer_id'] = $customer_id;
$params['access_type'] = $access_type;
$params['error'] = $error;


$params['time_select_option'] = $time_select_option;

$smarty->assign( 'params', $params );

if( $access_type == "sp" ){

	$smarty->assign( 'content_tpl', 'sp/ssl/tokyo/vip/reservation/input.tpl' );
	$smarty->display( 'sp/ssl/tokyo/template_vip.tpl' );

}else{

	$smarty->assign( 'content_tpl', 'pc/ssl/tokyo/vip/reservation/input.tpl' );
	$smarty->display( 'pc/ssl/tokyo/template_vip_2.tpl' );

}

?>