<?php

include("include/common.php");
include("include/auth.php");



if( isset($_GET["area"])==true ){

	$area = $_GET["area"];

}else{

	$area = "all";

}

$page_area = $area;

if( (isset($_GET["year"])==true) && (isset($_GET["month"])==true) && (isset($_GET["day"])==true) ){
	
	$year = $_GET["year"];
	$month = $_GET["month"];
	$day = $_GET["day"];
	
}else{
	
	$year = intval(date("Y"));
	$month = intval(date("m"));
	$day = intval(date("d"));
	
}

$day_select_frm = get_sale_shop_day_select_frm($area,$year,$month,$day);

$week_name = get_week_name_by_time_common($year, $month, $day);

if( ($month != "-1") && ($day != "-1") ){
	$day_disp = sprintf("%s月%s日（%s）",$month,$day,$week_name);
}else{
	
	$day_disp = "日付を選択してください";
	
}

$shop_data = get_shop_data($area);

$shop_data_num = count($shop_data);

//$month_select_frm = get_sale_shop_month_select_frm($area,$year,$month);
$type = "shop";
$month_select_frm = get_sale_month_select_frm_common($area,$year,$month,$type);

$url_para_add = sprintf("area=%s&year=%s&month=%s&day=%s",$area,$year,$month,$day);

/*
echo "<pre>";
print_r($driver_data);
echo "</pre>";
exit();
*/

?>

<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>店舗別売上 | 管理</title>
<script type="text/javascript" src="../js/jquery-1.7.2.js"></script>
<script type="text/javascript" src="js/sale_shop.js"></script>
<link href="style.css" rel="stylesheet" type="text/css" />

<style>

*{
	font-size:14px;
}

table tr th{
	background-color:#c9caca;
	padding:5px 5px 5px 5px;
	font-size:12px;
}

table tr td{
	padding:5px 5px 5px 5px;
}

body{



}

.td_hidden{
	/*display:none;*/

}

.form_txt{

	width:60px;
	
}

.td_kara{
	
	background:#eee;

}

</style>

</head>

<body>

<div style="margin:0px 0px 0px 0px;" id="wrapper">
	<div>
		<a href="index.php">管理トップ</a> &gt; <a href="sale.php">売上・ポイント</a> &gt; 店舗別売上
	</div>
	<div style="padding:0px 0px 100px 30px;">
	
	<?php include("include/sale_menu.php");?>
	
	<div>
		<input type="hidden" name="area" value="<?php echo $area;?>" id="sale_driver_area_val" />
	</div>

	<div style="padding:10px 0px 0px 0px;">
		<div id="sale_driver_day_select_area" style="float:left;">
			<?php echo $day_select_frm;?>
		</div>
		<div style="float:left;padding-left:30px;">
			<?php echo $month_select_frm;?>
		</div>
		<div style="float:left;padding-left:30px;">
			○<a href="sale_change_history.php?type=shop&<?php echo $url_para_add;?>">修正履歴</a>
		</div>
		
		<br class="clear" />
	</div>
	
	<div style="padding:20px 0px 0px 0px;">
		<div style="float:left;">
			<?php echo $day_disp;?>
		</div>
		<div style="float:left;padding-left:30px;">
<?php

$url_para = sprintf("&year=%s&month=%s&day=%s",$year,$month,$day);

if( $area == "all" ){

	echo '<b>全体</b>　';
	echo '<a href="sale_shop.php?area=tokyo'.$url_para.'">東京</a>　';
	echo '<a href="sale_shop.php?area=yokohama'.$url_para.'">横浜</a>　';
	echo '<a href="sale_shop.php?area=sapporo'.$url_para.'">札幌</a>　';
	echo '<a href="sale_shop.php?area=sendai'.$url_para.'">仙台</a>　';
	echo '<a href="sale_shop.php?area=osaka'.$url_para.'">大阪</a>　';

}else if( $area == "tokyo" ){

	echo '<a href="sale_shop.php?area=all'.$url_para.'">全体</a>　';
	echo '<b>東京</b>　';
	echo '<a href="sale_shop.php?area=yokohama'.$url_para.'">横浜</a>　';
	echo '<a href="sale_shop.php?area=sapporo'.$url_para.'">札幌</a>　';
	echo '<a href="sale_shop.php?area=sendai'.$url_para.'">仙台</a>　';
	echo '<a href="sale_shop.php?area=osaka'.$url_para.'">大阪</a>　';

}else if( $area == "yokohama" ){

	echo '<a href="sale_shop.php?area=all'.$url_para.'">全体</a>　';
	echo '<a href="sale_shop.php?area=tokyo'.$url_para.'">東京</a>　';
	echo '<b>横浜</b>　';
	echo '<a href="sale_shop.php?area=sapporo'.$url_para.'">札幌</a>　';
	echo '<a href="sale_shop.php?area=sendai'.$url_para.'">仙台</a>　';
	echo '<a href="sale_shop.php?area=osaka'.$url_para.'">大阪</a>　';

}else if( $area == "sapporo" ){

	echo '<a href="sale_shop.php?area=all'.$url_para.'">全体</a>　';
	echo '<a href="sale_shop.php?area=tokyo'.$url_para.'">東京</a>　';
	echo '<a href="sale_shop.php?area=yokohama'.$url_para.'">横浜</a>　';
	echo '<b>札幌</b>　';
	echo '<a href="sale_shop.php?area=sendai'.$url_para.'">仙台</a>　';
	echo '<a href="sale_shop.php?area=osaka'.$url_para.'">大阪</a>　';

}else if( $area == "sendai" ){

	echo '<a href="sale_shop.php?area=all'.$url_para.'">全体</a>　';
	echo '<a href="sale_shop.php?area=tokyo'.$url_para.'">東京</a>　';
	echo '<a href="sale_shop.php?area=yokohama'.$url_para.'">横浜</a>　';
	echo '<a href="sale_shop.php?area=sapporo'.$url_para.'">札幌</a>　';
	echo '<b>仙台</b>　';
	echo '<a href="sale_shop.php?area=osaka'.$url_para.'">大阪</a>　';

}else if( $area == "osaka" ){

	echo '<a href="sale_shop.php?area=all'.$url_para.'">全体</a>　';
	echo '<a href="sale_shop.php?area=tokyo'.$url_para.'">東京</a>　';
	echo '<a href="sale_shop.php?area=yokohama'.$url_para.'">横浜</a>　';
	echo '<a href="sale_shop.php?area=sapporo'.$url_para.'">札幌</a>　';
	echo '<a href="sale_shop.php?area=sendai'.$url_para.'">仙台</a>　';
	echo '<b>大阪</b>　';

}

?>
		</div>
		<br class="clear" />
	</div>
	
	<div style="padding:20px 0px 0px 0px;width:1700px;">
	
	<table border="1">
		<tr>
			<th align="left" colspan="2">店舗</th>
			<th align="left" colspan="2">売上</th>
			<th align="left" colspan="2">未払い報酬<br />(セラピスト)</th>
			<th align="left" colspan="2">日払い<br />(セラピスト)</th>
			<th align="left" colspan="2">最低保証</th>
			<th align="left" colspan="2">手当合計<br />(セラピスト)</th>
			<th align="left" colspan="2">報酬合計<br />(セラピスト)</th>
			<th align="left" colspan="2">未払い報酬<br />(ドライバー)</th>
			<th align="left" colspan="2">日払い<br />(ドライバー)</th>
			<th align="left" colspan="2">手当<br />(ドライバー)</th>
			<th align="left" colspan="2">報酬合計<br />(ドライバー)</th>
			<th align="left" colspan="2">移動実費</th>
			<th align="left" colspan="2">ガソリン代</th>
			<th align="left" colspan="2">駐車場代</th>
			<th align="left" colspan="2">高速代</th>
			<th align="left" colspan="2">清算済み<br />(ドライバー)</th>
			<th align="left" colspan="2">カード手数料</th>
			<th align="left" colspan="2">店長報酬</th>
			<th align="left" colspan="2">その他<br />(ドライバー)</th>
			<th align="left" colspan="2">粗利益</th>
			
		</tr>
<?php

$therapist_remuneration_all = 0;
$price_all = 0;
$card_commission_all = 0;
$gross_profit_all = 0;
$shop_boss_remuneration_all = 0;
$driver_remuneration_all = 0;
$movement_cost_all = 0;
$driver_gasoline_all = 0;
$driver_parking_all = 0;
$lowest_guarantee_all = 0;
$driver_allowance_all = 0;
$driver_highway_all = 0;
$driver_pay_finish_all = 0;
$driver_sonota_all = 0;
$genkin_price_all = 0;
$card_price_all = 0;
$pay_day_therapist_all = 0;
$therapist_remuneration_mibarai_all = 0;
$allowance_therapist_all = 0;
$pay_day_driver_all = 0;
$driver_remuneration_mibarai_all = 0;
$therapist_remuneration_sum_all = 0;
$driver_remuneration_sum_all = 0;

for($i=0;$i<$shop_data_num;$i++){
	
	$movement_cost_disp_flg = false;
	
	$shop_id = $shop_data[$i]["id"];
	$shop_name = $shop_data[$i]["name"];
	$shop_area = $shop_data[$i]["area"];
	
	$card_flg=0;
	$genkin_price = get_sale_price_by_shop_name_2($year,$month,$day,$shop_name,$card_flg);
	$genkin_price_val = $genkin_price;
	$genkin_price = number_format($genkin_price);
	
	$genkin_price_all = $genkin_price_all + $genkin_price_val;
	
	$card_flg=1;
	$card_price = get_sale_price_by_shop_name_2($year,$month,$day,$shop_name,$card_flg);
	$card_price_val = $card_price;
	$card_price = number_format($card_price);
	
	$card_price_all = $card_price_all + $card_price_val;
	
	$price_all = $price_all + $genkin_price_val + $card_price_val;
	
	if( $card_price_val == "0" ){
		$card_commission = 0;
	}else{
		$card_commission = ( $card_price_val * 324 ) / 10000;
		
		//四捨五入
		$card_commission = round($card_commission);
	}
	
	$card_commission_all = $card_commission_all + $card_commission;
	
	$therapist_remuneration = get_remuneration_at_sale_shop_new($year,$month,$day,$shop_name);
	
	//日払い報酬取得
	$pay_day_therapist = get_pay_day_therapist($year,$month,$day,$shop_name,$shop_area);
	
	$pay_day_therapist_all = $pay_day_therapist_all + $pay_day_therapist;
	
	$therapist_remuneration_mibarai = $therapist_remuneration - $pay_day_therapist;
	
	$therapist_remuneration_mibarai_all = $therapist_remuneration_mibarai_all + $therapist_remuneration_mibarai;
	
	//セラピスト自走手当
	$allowance_jisou = get_allowance_jisou_therapist_day($year,$month,$day,$shop_name,$shop_area);
	
	//セラピスト手当
	$allowance_therapist = get_allowance_therapist_day($year,$month,$day,$shop_name,$shop_area);
	
	$allowance_therapist = $allowance_therapist + $allowance_jisou;
	
	$allowance_therapist_all = $allowance_therapist_all + $allowance_therapist;
	
	$data = get_driver_payment_for_sale_shop_2($year,$month,$day,$shop_area);
	
	$driver_remuneration = $data["remuneration"];
	
	$driver_gasoline = $data["gasoline"];
	$driver_parking = $data["parking"];
	$driver_allowance = $data["allowance"];
	$driver_highway = $data["highway"];
	$driver_pay_finish = $data["pay_finish"];
	
	$lowest_guarantee = get_lowest_guarantee($shop_area,$shop_name,$year,$month,$day);
	
	//セラピスト報酬合計
	$therapist_remuneration_sum = $therapist_remuneration + $lowest_guarantee + $allowance_therapist;
	
	$therapist_remuneration_sum_all = $therapist_remuneration_sum_all + $therapist_remuneration_sum;
	
	//ドライバー日払い
	$pay_day_driver = get_pay_day_driver($year,$month,$day,$shop_name,$shop_area);
	
	//未払い報酬(ドライバー)
	$driver_remuneration_mibarai = $driver_remuneration - $pay_day_driver;
	
	//報酬合計(ドライバー)
	$driver_remuneration_sum = $driver_remuneration + $driver_allowance;
	
	$movement_cost = get_movement_cost_for_sale_shop($shop_area,$year,$month,$day);
	
	if( $shop_area == "tokyo" ){
	
		if( $shop_name != "東京リフレ" ){
			
			$driver_remuneration_sum = 0;
			$driver_remuneration_mibarai = 0;
			$driver_remuneration = 0;
			$movement_cost = 0;
			$driver_gasoline = 0;
			$driver_parking = 0;
			$driver_allowance = 0;
			$driver_highway = 0;
			$driver_pay_finish = 0;
				
		}
	
	}
	
	$driver_remuneration_sum_all = $driver_remuneration_sum_all + $driver_remuneration_sum;
	$lowest_guarantee_all = $lowest_guarantee_all + $lowest_guarantee;
	$pay_day_driver_all = $pay_day_driver_all + $pay_day_driver;
	$therapist_remuneration_all = $therapist_remuneration_all + $therapist_remuneration;
	$driver_remuneration_mibarai_all = $driver_remuneration_mibarai_all + $driver_remuneration_mibarai;
	$driver_remuneration_all = $driver_remuneration_all + $driver_remuneration;
	$movement_cost_all = $movement_cost_all + $movement_cost;
	$driver_gasoline_all = $driver_gasoline_all + $driver_gasoline;
	$driver_parking_all = $driver_parking_all + $driver_parking;
	$driver_allowance_all = $driver_allowance_all + $driver_allowance;
	$driver_highway_all = $driver_highway_all + $driver_highway;
	$driver_pay_finish_all = $driver_pay_finish_all + $driver_pay_finish;
	
	$shop_boss_remuneration = get_shop_boss_remuneration_for_sale_shop(
$genkin_price_val,$card_price_val,$therapist_remuneration,
$driver_remuneration,$movement_cost,$driver_gasoline,$driver_parking,$card_commission,$shop_boss_remuneration,
$shop_area,$shop_name,$lowest_guarantee);
	
	$shop_boss_remuneration_all = $shop_boss_remuneration_all + $shop_boss_remuneration;
	
	$result = check_last_day_for_remuneration_common($year,$month,$day);
	
	//driver_sonotaの取得
	$driver_sonota = get_driver_sonota_day($year,$month,$day,$shop_area);
	
	$driver_sonota_all = $driver_sonota_all + $driver_sonota;
	
	$gross_profit = 0;
	
	if( $result != false ){
	
		$gross_profit = get_gross_profit_for_sale_shop($genkin_price_val,$card_price_val,$therapist_remuneration_sum,
$driver_remuneration_sum,$movement_cost,$driver_gasoline,$driver_parking,$driver_highway,$card_commission,
$shop_boss_remuneration,$driver_sonota,$driver_pay_finish);
	
	}
	

	
	$gross_profit_all = $gross_profit_all + $gross_profit;
	
	if( $shop_area == "tokyo" ){
	
		if( $shop_name != "東京リフレ" ){
				
			$driver_remuneration = "0";
			$driver_gasoline = "0";
			$driver_parking = "0";
			$movement_cost = "0";
			
			$movement_cost_disp_flg = true;
				
		}
	
		$shop_boss_remuneration = "0";
	
	}else if( $shop_area == "osaka" ){
		
		if( $shop_name != "大阪リフレ" ){
		
			$movement_cost_disp_flg = true;
		
		}
		
	}
	
	if( $lowest_guarantee == "0" ){
		
		//$lowest_guarantee = "---";
		
	}
	
	$therapist_remuneration = number_format($therapist_remuneration);
	$card_commission = number_format($card_commission);
	
	if( $lowest_guarantee != "---" ){
		$lowest_guarantee = number_format($lowest_guarantee);
	}
	if( $driver_remuneration != "---" ){
		$driver_remuneration = number_format($driver_remuneration);
	}
	if( $driver_gasoline != "---" ){
		$driver_gasoline = number_format($driver_gasoline);
	}
	if( $driver_parking != "---" ){
		$driver_parking = number_format($driver_parking);
	}
	if( $shop_boss_remuneration != "---" ){
		$shop_boss_remuneration = number_format($shop_boss_remuneration);
	}
	
	if( $driver_allowance != "---" ){
		$driver_allowance = number_format($driver_allowance);
	}
	if( $driver_highway != "---" ){
		$driver_highway = number_format($driver_highway);
	}
	if( $driver_pay_finish != "---" ){
		$driver_pay_finish = number_format($driver_pay_finish);
	}
	
?>
	
<tr>
<td colspan="2" rowspan="2"><?php echo $shop_name;?></td>

<td>
現金
</td>
<td>
<?php echo $genkin_price;?>
</td>

<td colspan="2" rowspan="2"><?php echo number_format($therapist_remuneration_mibarai);?></td>
<td colspan="2" rowspan="2"><?php echo number_format($pay_day_therapist);?></td>

<td colspan="2" rowspan="2"><?php echo $lowest_guarantee;?></td>

<td colspan="2" rowspan="2"><?php echo number_format($allowance_therapist);?></td>
<td colspan="2" rowspan="2"><?php echo number_format($therapist_remuneration_sum);?></td>

<td colspan="2" rowspan="2"><?php echo number_format($driver_remuneration_mibarai);?></td>

<td colspan="2" rowspan="2"><?php echo number_format($pay_day_driver);?></td>

<td colspan="2" rowspan="2"><?php echo $driver_allowance;?></td>

<td colspan="2" rowspan="2"><?php echo number_format($driver_remuneration_sum);?></td>

<td colspan="2" rowspan="2">
<form id="movement_cost_frm_<?php echo $shop_id;?>">
<input type="hidden" name="shop_area" value="<?php echo $shop_area;?>" />
<input type="hidden" name="page_area" value="<?php echo $page_area;?>" />
<input type="hidden" name="year" value="<?php echo $year;?>" />
<input type="hidden" name="month" value="<?php echo $month;?>" />
<input type="hidden" name="day" value="<?php echo $day;?>" />
<div class="td_movement_cost" id="movement_cost_<?php echo $shop_id;?>">

<?php if( $movement_cost_disp_flg == true ){ ?>
<div class="td_disp" id="movement_cost_disp_<?php echo $shop_id;?>">
<?php echo $movement_cost;?>
</div>
<?php }else{ ?>
<div class="td_hidden" id="movement_cost_hidden_<?php echo $shop_id;?>">
<input type="text" name="frm_val" value="<?php echo $movement_cost;?>" class="form_txt" id="movement_cost_txt_<?php echo $shop_id;?>" />
</div>
<?php } ?>

</div>
</form>
</td>

<td colspan="2" rowspan="2"><?php echo $driver_gasoline;?></td>
<td colspan="2" rowspan="2"><?php echo $driver_parking;?></td>

<td colspan="2" rowspan="2"><?php echo $driver_highway;?></td>
<td colspan="2" rowspan="2"><?php echo $driver_pay_finish;?></td>
<td colspan="2" rowspan="2"><?php echo $card_commission;?></td>
<td colspan="2" rowspan="2"><?php echo $shop_boss_remuneration;?></td>
<td colspan="2" rowspan="2"><?php echo number_format($driver_sonota);?></td>
	
<td colspan="2" rowspan="2">
<div id="gross_profit_<?php echo $shop_id;?>">
<?php echo number_format($gross_profit);?>
</div>
</td>


</tr>

<tr>
<td>
カード
</td>
<td>
<?php echo $card_price;?>
</td>
</tr>

<?php

}

?>


<?php if( ($area=="all") || ($area=="tokyo") ){ ?>

<tr>
<td colspan="2" rowspan="3">合計</td>

<td colspan="1" rowspan="1">現金</td>
<td colspan="1" rowspan="1"><?php echo number_format($genkin_price_all);?></td>

<td colspan="2" rowspan="2" class="td_kara">&nbsp;</td>
<td colspan="2" rowspan="2" class="td_kara">&nbsp;</td>
<td colspan="2" rowspan="2" class="td_kara">&nbsp;</td>
<td colspan="2" rowspan="2" class="td_kara">&nbsp;</td>
<td colspan="2" rowspan="2" class="td_kara">&nbsp;</td>
<td colspan="2" rowspan="2" class="td_kara">&nbsp;</td>
<td colspan="2" rowspan="2" class="td_kara">&nbsp;</td>
<td colspan="2" rowspan="2" class="td_kara">&nbsp;</td>
<td colspan="2" rowspan="2" class="td_kara">&nbsp;</td>
<td colspan="2" rowspan="2" class="td_kara">&nbsp;</td>
<td colspan="2" rowspan="2" class="td_kara">&nbsp;</td>
<td colspan="2" rowspan="2" class="td_kara">&nbsp;</td>
<td colspan="2" rowspan="2" class="td_kara">&nbsp;</td>
<td colspan="2" rowspan="2" class="td_kara">&nbsp;</td>
<td colspan="2" rowspan="2" class="td_kara">&nbsp;</td>
<td colspan="2" rowspan="2" class="td_kara">&nbsp;</td>
<td colspan="2" rowspan="2" class="td_kara">&nbsp;</td>
<td colspan="2" rowspan="2" class="td_kara">&nbsp;</td>

</tr>

<tr>
<td>
カード
</td>
<td>
<?php echo number_format($card_price_all);?>
</td>
</tr>

<tr>
<td>
合計
</td>
<td>
<?php echo number_format($price_all);?>
</td>
<td colspan="2"><?php echo number_format($therapist_remuneration_mibarai_all);?></td>
<td colspan="2"><?php echo number_format($pay_day_therapist_all);?></td>
<td colspan="2"><?php echo number_format($lowest_guarantee_all);?></td>
<td colspan="2"><?php echo number_format($allowance_therapist_all);?></td>
<td colspan="2"><?php echo number_format($therapist_remuneration_sum_all);?></td>
<td colspan="2"><?php echo number_format($driver_remuneration_mibarai_all);?></td>
<td colspan="2"><?php echo number_format($pay_day_driver_all);?></td>
<td colspan="2"><?php echo number_format($driver_allowance_all);?></td>
<td colspan="2"><?php echo number_format($driver_remuneration_sum_all);?></td>
<td colspan="2"><?php echo number_format($movement_cost_all);?></td>
<td colspan="2"><?php echo number_format($driver_gasoline_all);?></td>
<td colspan="2"><?php echo number_format($driver_parking_all);?></td>
<td colspan="2"><?php echo number_format($driver_highway_all);?></td>
<td colspan="2"><?php echo number_format($driver_pay_finish_all);?></td>
<td colspan="2"><?php echo number_format($card_commission_all);?></td>
<td colspan="2"><?php echo number_format($shop_boss_remuneration_all);?></td>
<td colspan="2"><?php echo number_format($driver_sonota_all);?></td>
<td colspan="2"><?php echo number_format($gross_profit_all);?></td>
</tr>

<?php } ?>

	</table>
	
<div><?php //echo $therapist_remuneration_all;?></div>
	
	</div>


	</div>
</div>

</body>
</html>