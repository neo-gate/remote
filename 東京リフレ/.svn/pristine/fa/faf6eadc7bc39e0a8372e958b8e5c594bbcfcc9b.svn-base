<?php

include("include/common.php");
include("include/auth.php");



$error = "";

if( isset($_POST["send_staff_id_confirm"])==true ){
	
	/*
	echo "<pre>";
	print_r($_POST);
	echo "</pre>";
	exit();
	*/

	$year = $_POST["year"];
	$month = $_POST["month"];
	$day = $_POST["day"];
	$area = $_POST["area"];
	$reservation_for_board_id = $_POST["reservation_for_board_id"];
	$staff_id = $_POST["staff_id"];
	$attendance_id = $_POST["attendance_id"];

	//staff_id_confirmをセット

	$result = update_staff_id_confirm($staff_id,$reservation_for_board_id);

	if( $result == true ){

		$error = '<span style="color:blue;">設定しました</span>';

	}

}else if( isset($_POST["send_staff_id_approve"])==true ){

	$year = $_POST["year"];
	$month = $_POST["month"];
	$day = $_POST["day"];
	$area = $_POST["area"];
	$reservation_for_board_id = $_POST["reservation_for_board_id"];
	$staff_id = $_POST["staff_id"];
	$attendance_id = $_POST["attendance_id"];

	//staff_id_approveをセット

	$result = update_staff_id_approve($staff_id,$reservation_for_board_id);

	if( $result == true ){

		$error = '<span style="color:blue;">設定しました</span>';

	}


}else{

	if( (isset($_GET["year"])==true) && (isset($_GET["month"])==true) && (isset($_GET["day"])==true) && (isset($_GET["id"])==true) && (isset($_GET["area"])==true) ){
		
		$year = $_GET["year"];
		$month = $_GET["month"];
		$day = $_GET["day"];
		$attendance_id = $_GET["id"];
		$area = $_GET["area"];
		
	}else{
		
		header("Location: error.php");
		exit();
		
	}

}

$sale_not_edit_flg = check_sale_not_edit_day_common($year,$month,$day);

$therapist_id = get_therapist_id_by_attendance_id_common($attendance_id);

$week_name = get_week_name_by_time_common($year, $month, $day);

if( ($month != "-1") && ($day != "-1") ){
	$day_disp = sprintf("%s月%s日（%s）",$month,$day,$week_name);
}else{
	
	$day_disp = "日付を選択してください";
	
}

$board_data = get_reservation_for_board_for_sale_operation_one($attendance_id);

$board_data_num = count($board_data);

if( $area == "all" ){
	$area_name = "全体";
}else{
	$area_name = get_area_name_by_area_common($area);
}

$name = get_therapist_name_by_therapist_id_honmyou_common($therapist_id);

$login_staff_id = $_SESSION["login_staff_id"];
$login_staff_type_2 = $_SESSION["login_staff_type_2"];

//$insurance = get_therapist_insurance_by_id_common($therapist_id);
$insurance = get_insurance_common($therapist_id,$year,$month,$day);
$insurance_price = 0;
$insurance_price_disp = 0;
if( $insurance == "2" ){
	$insurance_price = 50;
	$insurance_price_disp = $insurance_price*(-1);
}

/*
echo "<pre>";
print_r($board_data);
echo "</pre>";
exit();
*/

?>

<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>セラピスト別売上 | 管理</title>
<script type="text/javascript" src="../js/jquery-1.7.2.js"></script>
<script type="text/javascript" src="js/sale_operation.js"></script>
<link href="style.css" rel="stylesheet" type="text/css" />

<style>

*{
	font-size:14px;
}

table tr th{
	background-color:#c9caca;
	padding:5px 5px 5px 5px;
}

table tr td{
	padding:5px 5px 5px 5px;
}

body{



}

</style>

</head>

<body>

<div style="margin:0px 0px 0px 0px;">
	<div>
<a href="index.php">管理トップ</a> &gt; 
<a href="sale.php">売上・ポイント</a> &gt; 
<a href="sale_operation.php?year=<?php echo $year;?>&month=<?php echo $month;?>&day=<?php echo $day;?>&area=<?php echo $area;?>">
施術別売上(<?php echo $area_name;?>)
</a> &gt; 
<?php echo $name;?>
	</div>
	<div style="padding:0px 0px 100px 30px;">
	
	<div style="padding:20px 0px 0px 0px;">
		<div style="float:left;">
<div style="font-weight:bold;padding:0px 0px 10px 0px;"><?php echo $name;?></div>
<div><?php echo $day_disp;?></div>
		</div>
		<br class="clear" />
	</div>
	
	<div style="padding:10px 0px 0px 0px;">
	
	<div><?php echo $error;?></div>
	
	<table border="1">
		<tr>
			<th align="left">エリア</th>
			<th align="left">店舗</th>
			<th align="left">担当</th>
			<th align="left">売上</th>
			<th align="left">区分</th>
			<th align="left">指名</th>
			<th align="left">交通費</th>
			<th align="left">報酬</th>
			<th align="left">保険料</th>
			<th align="left">支払額</th>
			<th align="left">顧客名</th>
			<th align="left">コース</th>
			<th align="left">スタート</th>
			<th align="left">&nbsp;</th>
			<th align="left" width="170">確認者</th>
			<th align="left" width="170">承認者</th>
			
		</tr>
<?php
$price_sum = 0;
$transportation_sum = 0;
$remuneration_sum = 0;
$insurance_price_sum = 0;
$remuneration_shiharai_sum = 0;

for($i=0;$i<$board_data_num;$i++){
	$w_ArShop = $obj_Shop->getShopGroupValue($board_data[$i]["shop_area"]);	//店舗グループデータ取得
	
	$reservation_for_board_id = $board_data[$i]["id"];
	$shop_area = $board_data[$i]["shop_area"];
	$shop_name = $board_data[$i]["shop_name"];
	$attendance_id = $board_data[$i]["attendance_id"];
	$reservation_no = $board_data[$i]["reservation_no"];
	$card_flg = $board_data[$i]["card_flg"];
	$transportation = $board_data[$i]["transportation"];
	$customer_name = $board_data[$i]["customer_name"];
	$course = $board_data[$i]["course"];
	$extension = $board_data[$i]["extension"];
	$start_hour = add_zero_when_under_ten_common($board_data[$i]["start_hour"]);
	$start_minute = add_zero_when_under_ten_common($board_data[$i]["start_minute"]);
	$shimei_flg = $board_data[$i]["shimei_flg"];
	$staff_id_confirm = $board_data[$i]["staff_id_confirm"];
	$staff_id_approve = $board_data[$i]["staff_id_approve"];
	
	$type = "confirm";
	$select_frm_staff_id_confirm = get_staff_select_frm_for_sale_operation($staff_id_confirm,$login_staff_id,$login_staff_type_2,$type);
	
	$type = "approve";
	$select_frm_staff_id_approve = get_staff_select_frm_for_sale_operation($staff_id_approve,$login_staff_id,$login_staff_type_2,$type);
	
	$shop_area_name = get_area_name_by_area_common($shop_area);
	$therapist_name = get_therapist_name_by_attendance_id($attendance_id,$shop_area);
	
	$data = get_sale_history_by_reservation_no($reservation_no);
	
	$therapist_id = $data["therapist_id"];
	$price = $data["price"];
	
	$price_disp = number_format($price);
	
	$start_time = $start_hour.":".$start_minute;
	
	if( $extension == "0" ){
		
		$course_disp = $course."分";
		
	}else{
		
		$course_disp = ($course+$extension)."分";
		
	}
	
	if( $card_flg == "1" ){
	
		$kubun_disp = "カード";
	
	}else{
	
		$kubun_disp = "現金";
	
	}
	
	$transportation_disp = number_format($transportation);
	
	$share_rate = get_share_rate_by_attendance_id_common($attendance_id);
	
	if($shop_area!="tokyo_reraku"){
		//$remuneration = get_remuneration_one_common($price,$shimei_flg,$transportation,$share_rate);
		$remuneration = PHP_getRemuneration("", $price, $shimei_flg, $transportation, $share_rate, 0, 0, 0, $w_ArShop["shrcls"]);	//報酬計算 in common/include/shop_area_list.php
		//echo $remuneration . " = get_remuneration_one_common(" . $price . "," . $shimei_flg . "," . $transportation . "," . $share_rate . ")<br />";
	}
	else{
		$remuneration = get_remuneration_one_reraku_common($price,$shimei_flg,$transportation,$share_rate);
	}
	
	$remuneration_shiharai = $remuneration - $insurance_price;
	
	$remuneration_disp = number_format($remuneration);
	
	$remuneration_shiharai_disp = number_format($remuneration_shiharai);
	
	$file_name = "sale_operation_one.php";

	if($shimei_flg) $shimei_disp = "有り"; else $shimei_disp = "<br />";
?>
	
<tr>
<td><?php echo $shop_area_name;?></td>
<td><?php echo $shop_name;?></td>
<td><?php echo $therapist_name;?></td>
<td><?php echo $price_disp;?></td>
<td><?php echo $kubun_disp;?></td>
<td><?php echo $shimei_disp;?></td>
<td><?php echo $transportation_disp;?></td>
<td><?php echo $remuneration_disp;?></td>
<td><?php echo $insurance_price_disp;?></td>
<td><?php echo $remuneration_shiharai_disp;?></td>
<td><?php echo $customer_name;?></td>
<td><?php echo $course_disp;?></td>
<td><?php echo $start_time;?></td>

<td>
<?php
$price_sum += $price;
$transportation_sum += $transportation;
$remuneration_sum += $remuneration;
$insurance_sum += $insurance_price_disp;
$remuneration_shiharai_sum += $remuneration_shiharai;

if($sale_not_edit_flg==false){
	echo "<div>編集不可</div>";
}else{
?>
<form action="sale_operation_edit.php" method="post">
<input type="hidden" name="file_name" value="<?php echo $file_name;?>" />
<input type="hidden" name="reservation_for_board_id" value="<?php echo $reservation_for_board_id;?>" />
<input type="hidden" name="area" value="<?php echo $area;?>" />
<input type="submit" name="send_list" value="編集" style="padding:5px;" />
</form>
<?php
}
?>
</td>

<td>
<form action="" method="post">
<input type="hidden" name="year" value="<?php echo $year;?>" />
<input type="hidden" name="month" value="<?php echo $month;?>" />
<input type="hidden" name="day" value="<?php echo $day;?>" />
<input type="hidden" name="area" value="<?php echo $area;?>" />
<input type="hidden" name="reservation_for_board_id" value="<?php echo $reservation_for_board_id;?>" />
<input type="hidden" name="attendance_id" value="<?php echo $attendance_id;?>" />

<div>

<?php echo $select_frm_staff_id_confirm;?>

</div>

</form>
</td>

<td>
<form action="" method="post">
<input type="hidden" name="year" value="<?php echo $year;?>" />
<input type="hidden" name="month" value="<?php echo $month;?>" />
<input type="hidden" name="day" value="<?php echo $day;?>" />
<input type="hidden" name="area" value="<?php echo $area;?>" />
<input type="hidden" name="reservation_for_board_id" value="<?php echo $reservation_for_board_id;?>" />
<input type="hidden" name="attendance_id" value="<?php echo $attendance_id;?>" />

<div>

<?php echo $select_frm_staff_id_approve;?>

</div>

</form>
</td>

</tr>

<?php

}

?>
	<tr>
		<td colspan="3">合計</td>
		<td><?php echo number_format($price_sum);?></td>
		<td colspan="2"><br /></td>
		<td><?php echo number_format($transportation_sum);?></td>
		<td><?php echo number_format($remuneration_sum);?></td>
		<td><?php echo number_format($insurance_sum);?></td>
		<td><?php echo number_format($remuneration_shiharai_sum);?></td>
		<td colspan="6"><br /></td>
	</tr>
	</table>
	
	</div>


	</div>
</div>

</body>
</html>