<?php

include("include/common.php");
include("include/auth.php");

/*
print_r($_SESSION);
*/

$error = "";

$skill_data = array(
"1"=>"アロマ",
"2"=>"バリ式",
"3"=>"セルライト",
"4"=>"カイロ",
"5"=>"フェイシャル",
"6"=>"ヘッド",
"7"=>"小顔",
"8"=>"骨盤矯正",
"9"=>"ロミロミ",
"10"=>"リンパ",
"11"=>"マタニティー",
"12"=>"リフレ",
"13"=>"整体",
"14"=>"指圧(ボディケア)",
"15"=>"ストレッチ",
"16"=>"スウェディッシュ",
"17"=>"タイ古式"
);

$skill_data_num = count($skill_data);

if( $_SESSION["therapist_page_edit_img_url_tmp"] != "" ){
	$img_url_tmp = $_SESSION["therapist_page_edit_img_url_tmp"];
}
if( $_SESSION["therapist_page_edit_img_tmp_id"] != "" ){
	$img_tmp_id = $_SESSION["therapist_page_edit_img_tmp_id"];
}
if( $_SESSION["therapist_page_edit_area"] != "" ){
	$area = $_SESSION["therapist_page_edit_area"];
}
if( $_SESSION["therapist_page_edit_area_name"] != "" ){
	$area_name = $_SESSION["therapist_page_edit_area_name"];
}
if( $_SESSION["therapist_page_edit_therapist_id"] != "" ){
	$therapist_id = $_SESSION["therapist_page_edit_therapist_id"];
}
if( $_SESSION["therapist_page_edit_age"] != "" ){
	$age = $_SESSION["therapist_page_edit_age"];
}
if( $_SESSION["therapist_page_edit_skill"] != "" ){
	$skill = $_SESSION["therapist_page_edit_skill"];
}
if( $_SESSION["therapist_page_edit_from"] != "" ){
	$from = $_SESSION["therapist_page_edit_from"];
}
if( $_SESSION["therapist_page_edit_history"] != "" ){
	$history = $_SESSION["therapist_page_edit_history"];
}
if( $_SESSION["therapist_page_edit_shikaku"] != "" ){
	$shikaku = $_SESSION["therapist_page_edit_shikaku"];
}
if( $_SESSION["therapist_page_edit_pr_refle"] != "" ){
	$pr_refle = $_SESSION["therapist_page_edit_pr_refle"];
}
if( $_SESSION["therapist_page_edit_pr_yokohama"] != "" ){
	$pr_yokohama = $_SESSION["therapist_page_edit_pr_yokohama"];
}
if( $_SESSION["therapist_page_edit_pr_makuhari"] != "" ){
	$pr_makuhari = $_SESSION["therapist_page_edit_pr_makuhari"];
}
if( $_SESSION["therapist_page_edit_pr_sapporo"] != "" ){
	$pr_sapporo = $_SESSION["therapist_page_edit_pr_sapporo"];
}
if( $_SESSION["therapist_page_edit_pr_new"] != "" ){
	$pr_new = $_SESSION["therapist_page_edit_pr_new"];
}

if( isset($_POST["image_delete"])==true ){

	$area = $_POST["area"];
	$therapist_id = $_POST["therapist_id"];
	$age = $_POST["age"];
	$skill = $_POST["skill"];
	$from = $_POST["from"];
	$history = $_POST["history"];
	$shikaku = $_POST["shikaku"];
	$pr_refle = $_POST["pr_refle"];
	$pr_yokohama = $_POST["pr_yokohama"];
	$pr_makuhari = $_POST["pr_makuhari"];
	$pr_sapporo = $_POST["pr_sapporo"];
	$pr_new = $_POST["pr_new"];

	//セラピストページの仮画像を削除
	delete_therapist_page_tmp_img($img_tmp_id);

}else if(isset($_POST["send"])==true){

	/*
	echo "<pre>";
	print_r($_POST);
	print_r($_FILES);
	echo "</pre>";
	exit();
	*/

	$area = $_POST["area"];
	$therapist_id = $_POST["therapist_id"];
	$age = $_POST["age"];
	$skill = $_POST["skill"];
	$from = $_POST["from"];
	$history = $_POST["history"];
	$shikaku = $_POST["shikaku"];
	$pr_refle = $_POST["pr_refle"];
	$pr_yokohama = $_POST["pr_yokohama"];
	$pr_makuhari = $_POST["pr_makuhari"];
	$pr_sapporo = $_POST["pr_sapporo"];
	$pr_new = $_POST["pr_new"];

	$skill_num = count($skill);

	if($therapist_id=="-1"){

		$error .= "<li>セラピスト名が未選択です</li>";

	}

	if( ($pr_refle=="") && ($pr_yokohama=="") && ($pr_makuhari=="") && ($pr_sapporo=="") && ($pr_new=="") ){

		$error .= "<li>PRが未入力です</li>";

	}

	$tmp_pic_url = $_FILES["pic"]["tmp_name"];
	$file_name = $_FILES["pic"]["name"];

	if( $file_name != "" ){
		$result = check_upload_file_name_common($file_name);
		if( $result == false ){
			$error .= "<li>ファイル名は半角英数字のみです</li>";
		}
	}

	if( $error != "" ){

		$error = "<ul class='error'>".$error."</ul>";

	}else{

		if( $file_name != "" ){

			//セラピストページ画像の仮アップロード
			upload_therapist_img_tmp($tmp_pic_url,$file_name,$img_tmp_id,$img_tmp_id);

		}

		$_SESSION["therapist_page_edit_therapist_id"] = $therapist_id;
		$_SESSION["therapist_page_edit_age"] = $age;
		$_SESSION["therapist_page_edit_skill"] = $skill;
		$_SESSION["therapist_page_edit_from"] = $from;
		$_SESSION["therapist_page_edit_history"] = $history;
		$_SESSION["therapist_page_edit_shikaku"] = $shikaku;
		$_SESSION["therapist_page_edit_pr_refle"] = $pr_refle;
		$_SESSION["therapist_page_edit_pr_yokohama"] = $pr_yokohama;
		$_SESSION["therapist_page_edit_pr_makuhari"] = $pr_makuhari;
		$_SESSION["therapist_page_edit_pr_sapporo"] = $pr_sapporo;
		$_SESSION["therapist_page_edit_pr_new"] = $pr_new;

		header("Location: therapist_page_edit_confirm.php");
		exit();

	}

}else if(isset($_POST["back"])==true){

	header("Location: therapist_page.php?area=".$area);
	exit();

}else if(isset($_GET["id"])==true){

	$therapist_page_id = $_GET["id"];

	$_SESSION["therapist_page_edit_therapist_page_id"] = $therapist_page_id;

	$therapist_page = get_therapist_page_detail_data($therapist_page_id);

	$therapist_id = $therapist_page["therapist_id"];
	$area = $therapist_page["area"];
	$age = $therapist_page["age"];
	$img_url = $therapist_page["img_url"];
	$skill_string = $therapist_page["skill"];
	$from = $therapist_page["hometown"];
	$history = $therapist_page["history"];
	$pr_refle = $therapist_page["pr_refle"];
	$pr_yokohama = $therapist_page["pr_yokohama"];
	$pr_makuhari = $therapist_page["pr_makuhari"];
	$pr_sapporo = $therapist_page["pr_sapporo"];
	$pr_new = $therapist_page["pr_new"];
	$shikaku = $therapist_page["shikaku"];

	$therapist_name = get_therapist_name_by_therapist_id($therapist_id, $area);

	$skill = explode(",",$skill_string);

	$skill_num = count($skill);

	//$area_name = get_therapist_page_area_name($area);
	$area_name = get_area_name_by_area($area);

	$_SESSION["therapist_page_edit_area"] = $area;
	$_SESSION["therapist_page_edit_area_name"] = $area_name;

	if( $_SESSION["therapist_page_edit_img_tmp_id"] == "" ){

		$tmp_img_url = "";

		if( $img_url != "" ){

			$file_name = basename($img_url);
			$tmp_img_url = "img/therapist_page/tmp/".$file_name;

			$img_url_full = ROOT_PATH.$img_url;
			$tmp_img_url_full = ROOT_PATH.$tmp_img_url;

			$result = copy($img_url_full, $tmp_img_url_full);

			if($result == false){

				//echo "copy関数が失敗しました";echo "<br />";
				//echo "file_name:".$file_name;echo "<br />";
				//exit();

				//img_urlを消す
				erase_img_url_at_therapist_page($therapist_page_id);
				$tmp_img_url = "";

			}

		}

		// 仮画像データURLを仮セラピストページ画像テーブルにインサート
		$_SESSION["therapist_page_edit_img_tmp_id"] = insert_into_img_data_to_therapist_page_img_tmp($tmp_img_url);

	}

}

$therapist_name = get_therapist_name_by_therapist_id($therapist_id, $area);

if( $img_tmp_id != "" ){
	//仮画像のurlを取得
	$tmp_img_url = get_therapist_page_img_url_tmp($img_tmp_id);
}

?>

<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>セラピストページ編集入力(<?php echo $area_name;?>) | 管理サイト</title>
<script type="text/javascript" src="../js/jquery-1.7.2.js"></script>
<script type="text/javascript" src="main.js"></script>
<link href="style.css" rel="stylesheet" type="text/css" />

</head>

<body>

<div style="width:800px;margin:0px auto 0px auto;">
	<div>
		<a href="index.php">トップ</a> &gt; <a href="therapist_page.php?area=<?php echo $area;?>">セラピストページ一覧(<?php echo $area_name;?>)</a> &gt; <span style="font-size:12px;">セラピストページ編集入力</span>
	</div>
	<div style="padding:60px 0px 100px 0px;">
		<div><?php echo $error;?></div>
		<form action="" method="post" enctype="multipart/form-data">

			<input type="hidden" name="area" value="<?php echo $area;?>" />
			<input type="hidden" name="therapist_id" value="<?php echo $therapist_id;?>" />

			<table BORDER="1" CELLSPACING="0" CELLPADDING="0" bordercolor="#ccc">
				<tr>
					<td>
						<div style="padding:5px 10px 5px 10px;">
							セラピスト名
						</div>
					</td>
					<td>
						<div style="padding:5px 10px 5px 10px;">
							<?php echo $therapist_name;?>
						</div>
					</td>
				</tr>
				<tr>
					<td>
						<div style="padding:5px 10px 5px 10px;">
							年齢
						</div>
					</td>
					<td>
						<div style="padding:5px 10px 5px 10px;">
							<input type="text" name="age" value="<?php echo $age;?>" style="width:100px;"/>
						</div>
					</td>
				</tr>
				<tr>
					<td>
						<div style="padding:5px 10px 5px 10px;">
							イメージ画像
						</div>
					</td>
					<td>
						<div style="padding:5px 10px 5px 10px;">
							<div>
								<?php

									if( $tmp_img_url != "" ){

										echo '<div><img src="'.URL_ROOT.$tmp_img_url.'" width="60" /></div>';

										echo '<div style="padding:5px 0px 10px 0px;">';
											echo '<input type="submit" value="削除" name="image_delete" />';
										echo '</div>';

									}

								?>
							</div>
							<div><input type="file" name="pic" /></div>
						</div>
					</td>
				</tr>
				<tr>
					<td>
						<div style="padding:5px 10px 5px 10px;">
							施術可能メニュー
						</div>
					</td>
					<td>
						<div style="padding:5px 10px 5px 10px;width:500px;">

							<?php

								for($i=1;$i<=$skill_data_num;$i++){

									$result = check_skill_exist($i,$skill);

									if( $result == true ){

										echo '<input type="checkbox" name="skill[]" value="'.$i.'" checked>'.$skill_data[$i];

									}else{

										echo '<input type="checkbox" name="skill[]" value="'.$i.'">'.$skill_data[$i];

									}

								}

							?>

						</div>
					</td>
				</tr>
				<tr>
					<td>
						<div style="padding:5px 10px 5px 10px;">
							出身地
						</div>
					</td>
					<td>
						<div style="padding:5px 10px 5px 10px;">
							<input type="text" name="from" value="<?php echo $from;?>" style="width:300px;" />
						</div>
					</td>
				</tr>
				<tr>
					<td>
						<div style="padding:5px 10px 5px 10px;">
							セラピスト暦
						</div>
					</td>
					<td>
						<div style="padding:5px 10px 5px 10px;">
							<input type="text" name="history" value="<?php echo $history;?>" style="width:300px;" />
						</div>
					</td>
				</tr>

				<tr>
					<td>
						<div style="padding:5px 10px 5px 10px;">
							保有資格
						</div>
					</td>
					<td>
						<div style="padding:5px 10px 5px 10px;">
							<textarea name="shikaku" style="width:300px;height:50px;"><?php echo $shikaku;?></textarea>
						</div>
					</td>
				</tr>

				<?php if($area=="tokyo"){ ?>

					<tr>
						<td>
							<div style="padding:5px 10px 5px 10px;">
								PRコメント(東京リフレ)
							</div>
						</td>
						<td>
							<div style="padding:5px 10px 5px 10px;">
								<textarea name="pr_refle" style="width:500px;height:200px;"><?php echo $pr_refle;?></textarea>
							</div>
						</td>
					</tr>

					<tr>
						<td>
							<div style="padding:5px 10px 5px 10px;">
								PRコメント(横浜リフレ)
							</div>
						</td>
						<td>
							<div style="padding:5px 10px 5px 10px;">
								<textarea name="pr_yokohama" style="width:500px;height:200px;"><?php echo $pr_yokohama;?></textarea>
							</div>
						</td>
					</tr>

					<tr>
						<td>
							<div style="padding:5px 10px 5px 10px;">
								PRコメント(幕張リフレ)
							</div>
						</td>
						<td>
							<div style="padding:5px 10px 5px 10px;">
								<textarea name="pr_makuhari" style="width:500px;height:200px;"><?php echo $pr_makuhari;?></textarea>
							</div>
						</td>
					</tr>

				<?php }else if($area=="sapporo"){ ?>

					<tr>
						<td>
							<div style="padding:5px 10px 5px 10px;">
								PRコメント(札幌リフレ)
							</div>
						</td>
						<td>
							<div style="padding:5px 10px 5px 10px;">
								<textarea name="pr_sapporo" style="width:500px;height:200px;"><?php echo $pr_sapporo;?></textarea>
							</div>
						</td>
					</tr>

				<?php }else{ ?>

					<tr>
						<td>
							<div style="padding:5px 10px 5px 10px;">
								PRコメント(<?php echo $area_name;?>リフレ)
							</div>
						</td>
						<td>
							<div style="padding:5px 10px 5px 10px;">
								<textarea name="pr_new" style="width:500px;height:200px;"><?php echo $pr_new;?></textarea>
							</div>
						</td>
					</tr>

				<?php } ?>

			</table>

			<div style="padding:30px 0px 0px 0px;">

				<div style="float:left;padding:0px 0px 0px 280px;">
					<input type="submit" name="back" value="戻る" style="padding:5px 10px 5px 10px;" />　　
					<input type="submit" name="send" value="確認" style="padding:5px 10px 5px 10px;" />
				</div>

				<div style="float:left;padding:0px 0px 0px 220px;" id="therapist_page_delete_2">

<input type="button" name="back" value="削除" style="padding:5px 10px 5px 10px;" onclick="therapist_page_delete_2('<?php echo $_SESSION["therapist_page_edit_therapist_page_id"];?>','<?php echo $area;?>');" />

				</div>

				<br class="clear" />

			</div>

		</form>
	</div>
</div>

</body>
</html>