<?php
include("include/common.php");

$error = "";
$error_2 = "";
$error_3 = "";
$error_4 = "";

//$therapist_edit_url = sprintf("https://www.tokyo-refle.com/man/therapist_edit_input_new.php");
$therapist_edit_url = "/man/therapist_edit_input_new.php";

if( isset($_POST["send_regist"])==true ){

	$area = $_POST["area"];
	$therapist_id = $_POST["therapist_id"];
	$syounin = $_POST["syounin"];
	$fusyounin = $_POST["fusyounin"];
	$shimekiri = $_POST["shimekiri"];

	if( ( $syounin == null ) && ( $fusyounin == null ) && ( $shimekiri == null ) ){

		$error = '<div style="color:red;">未選択です</div>';

	}

	if( $error == "" ){

		$result = update_shift_syounin_check($area,$therapist_id,$syounin,$fusyounin,$shimekiri);

		if( $result == true ){

			$error = '<div style="color:blue;">更新成功しました</div>';

		}else{

			$error = '<div style="color:red;">更新失敗しました</div>';

		}

	}

}else if( isset($_POST["send_edit"])==true ){

	$area = $_POST["area"];
	$therapist_id = $_POST["therapist_id"];
	$syounin = $_POST["syounin"];

	$fusyounin = $_POST["fusyounin"];

	//$result = update_shift_syounin_check_edit($area,$therapist_id,$syounin);
	$result = update_shift_syounin_check_edit_2($area,$therapist_id,$syounin,$fusyounin);

	if( $result == true ){

		$error_2 = '<div style="color:blue;">更新成功しました</div>';

	}else{

		$error_2 = '<div style="color:red;">更新失敗しました</div>';

	}

}else if( isset($_POST["send_mail"])==true ){

	$area = $_POST["area"];
	$therapist_id = $_POST["therapist_id"];
	$mail_naiyou = $_POST["naiyou"];

	if( $mail_naiyou == "" ){

		$error_3 = '<div style="color:red;">未入力です</div>';

	}

	if( $error_3 == "" ){

		$mail_type = 1;

		$result = send_free_mail_about_shift($area,$therapist_id,$mail_naiyou,$mail_type);

		if( $result == true ){

			$error_3 = '<div style="color:blue;">送信成功しました</div>';

		}else{

			$error_3 = '<div style="color:red;">送信失敗しました</div>';

		}

	}

}else if( isset($_POST["send_mail_shijutsu"])==true ){

	$area = $_POST["area"];
	$therapist_id = $_POST["therapist_id"];
	$mail_naiyou = $_POST["naiyou"];

	if( $mail_naiyou == "" ){

		$error_3 = '<div style="color:red;">未入力です</div>';

	}

	if( $error_3 == "" ){

		$mail_type = 2;

		$result = send_free_mail_about_shift($area,$therapist_id,$mail_naiyou,$mail_type);

		if( $result == true ){

			$error_3 = '<div style="color:blue;">送信成功しました</div>';

		}else{

			$error_3 = '<div style="color:red;">送信失敗しました</div>';

		}

	}

}else if( isset($_POST["send_hp"])==true ){

	$area = $_POST["area"];
	$therapist_id = $_POST["therapist_id"];

	//HP承認処理
	approval_therapist_page_tmp_common($therapist_id,$area);

	$error_4 = '<div style="color:blue;">HP承認しました</div>';

}else if( ($_GET["id"] != "") && ($_GET["area"] != "") ){

	$area = $_GET["area"];
	$therapist_id = $_GET["id"];

}else{

	echo "error!";
	exit();

}

if( isset($_GET["num"])==true ){
	$shift_message_data_num = $_GET["num"];
}else{
	$shift_message_data_num = 3;
}
$next_num = $shift_message_data_num + 20;

$more_link_url = sprintf("%sindex.php?area=%s&id=%s&num=%s",$url_root,$area,$therapist_id,$next_num);

$year = intval(date('Y'));
$month = intval(date('m'));
$day = intval(date('d'));

$area = escape_for_db($area);
$therapist_id = escape_for_db($therapist_id);
$year = escape_for_db($year);
$month = escape_for_db($month);

$therapist_data = get_therapist_data_by_id_common($therapist_id);

$therapist_name = $therapist_data["name"];
$therapist_tel = $therapist_data["tel"];

$therapist_address = $therapist_data["address"];

$wait_select = $therapist_data["wait_select"];

$therapist_age = get_therapist_age_by_id_common($therapist_id);
if(!$therapist_age) $therapist_age = "不明";

//$therapist_name = get_therapist_name_by_therapist_id_honmyou($therapist_id, $area);

$attendance_data = get_therapist_month_attendance_data_3($therapist_id);

//$next_month_year = intval(date('Y', strtotime('+1 month')));
//$next_month_month = intval(date('m', strtotime('+1 month')));
//ok
$next_month_year = intval(date('Y', strtotime(date('Y-m-1').' +1 month')));
$next_month_month = intval(date('m', strtotime(date('Y-m-1').' +1 month')));

$max_day = get_max_day($year,$month);
$next_month_max_day = get_max_day($next_month_year,$next_month_month);

$day_data = get_day_data_two_month($year,$month,$max_day,$next_month_year,$next_month_month,$next_month_max_day);

$type = "regist";
//ok
$list_data = get_attendance_list_data_2($attendance_data,$day_data,$therapist_id,$area,$type);
//ng
$type = "edit";
$list_data_edit = get_attendance_list_data_2($attendance_data,$day_data,$therapist_id,$area,$type);

//shift_historyを取得
$history_data = get_shift_history($area,$therapist_id);

//シフトメッセージを取得
//$order_num = 100;
//$shift_message_data = get_shift_message_by_order_num($order_num,$therapist_id);
$shift_message_data_all = get_shift_message_all($therapist_id);
$shift_message_data = get_shift_message_data_man_shift($shift_message_data_all,$shift_message_data_num);

$therapist_page = get_therapist_page_data_by_therapist_id_common($therapist_id);

$therapist_page_id = $therapist_page["id"];

$therapist_page_url = WWW_URL_SITE."man/therapist_page/edit.php?id=".$therapist_page_id;

$for_kobetsu_url = get_therapist_for_kobetsu_url_by_therapist_id_common($therapist_id);

$therapist_reportcard_url = sprintf("%sshift/reportcard.php?area=%s&id=%s&ch=%s",
WWW_URL_SITE,$area,$therapist_id,$for_kobetsu_url);

$params['therapist_reportcard_url'] = $therapist_reportcard_url;

//仮セラピストページを取得
$data = get_therapist_page_tmp_2_common($therapist_id);
$therapist_page_tmp_flg = false;
if( $data["id"] != "" ){

	$skill_string = $data["skill"];
	$skill_2_string = $data["skill_2"];
	$shikaku = $data["shikaku"];
	$pr = $data["pr"];

	$disp_skill = disp_skill_string_common($skill_string);
	$disp_skill_2 = disp_skill_string_common($skill_2_string);

	$therapist_page_tmp_flg = true;

}

$meeting_place_disp_flg = true;
$meeting_place = get_therapist_meeting_place_data_common($therapist_id);
$meeting_place_num = count($meeting_place);
if( ($meeting_place_num == 0) || ($wait_select != "3") ){
	$meeting_place_disp_flg = false;

}



$params['therapist_page_tmp_flg'] = $therapist_page_tmp_flg;
$params['shikaku'] = $shikaku;
$params['pr'] = $pr;
$params['disp_skill'] = $disp_skill;
$params['disp_skill_2'] = $disp_skill_2;

/*
echo "<pre>";
print_r($attendance_data);
echo "</pre>";
exit();
*/

$params['top_flg'] = true;
$params['area'] = $area;
$params['therapist_id'] = $therapist_id;
$params['therapist_name'] = $therapist_name;
$params['therapist_tel'] = $therapist_tel;
$params['therapist_age'] = $therapist_age;
$params['day_data'] = $day_data;
$params['list_data'] = $list_data;
$params['list_data_edit'] = $list_data_edit;
$params['history_data'] = $history_data;
$params['period_select_option'] = $period_select_option;
$params['mail_naiyou'] = $mail_naiyou;
$params['error'] = $error;
$params['error_2'] = $error_2;
$params['error_3'] = $error_3;
$params['error_4'] = $error_4;
$params['page_title'] = $therapist_name."さんのページ";
$params['shift_message_data'] = $shift_message_data;
$params['therapist_page_id'] = $therapist_page_id;
$params['therapist_page_url'] = $therapist_page_url;

$params['more_link_url'] = $more_link_url;

$params['therapist_address'] = $therapist_address;

$params['meeting_place_disp_flg'] = $meeting_place_disp_flg;

$params['meeting_place'] = $meeting_place;

$params['therapist_edit_url'] = $therapist_edit_url;



$smarty->assign( 'params', $params );

$smarty->assign( 'content_tpl', 'pc/index.tpl' );
$smarty->display( 'pc/template.tpl' );

?>
